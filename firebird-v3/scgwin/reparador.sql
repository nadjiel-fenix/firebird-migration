SET TERM ^ ;

-- Erros com SUSPEND:
-- Substitui-se SUSPEND por EXIT

ALTER PROCEDURE CORRIGE_IDREGISTRO_MOVESTOQUE AS 
declare variable LIDREGISTROITEM integer;
declare variable LCODPEDVEND integer;
begin
  LIDREGISTROITEM = 0;
  LCODPEDVEND     = 0;

  for select
    M.IDREGISTROITEM
  from
    MOVESTOQUE M
  where
    M.TIPODOC    = 'PV' and
    M.IDREGISTRO = 0
  into
    LIDREGISTROITEM
  do
  begin
    select
      coalesce(PVI.CODPEDVEND, 0)
    from
      PEDVENDITEM PVI
    where
      PVI.CODPEDVENDITEM = :LIDREGISTROITEM
    into
      LCODPEDVEND;

    update
      MOVESTOQUE
    set
      MOVESTOQUE.IDREGISTRO = :LCODPEDVEND
    where
      MOVESTOQUE.IDREGISTRO     = 0 and
      MOVESTOQUE.IDREGISTROITEM = :LIDREGISTROITEM and
      MOVESTOQUE.TIPODOC        = 'PV';
  end

  LIDREGISTROITEM = 0;
  LCODPEDVEND     = 0;

  for select
    M.IDREGISTROITEM
  from
    MOVESTOQUE M
  where
    M.TIPODOC    = 'NV' and
    M.IDREGISTRO = 0
  into
    LIDREGISTROITEM
  do
  begin
    select
      coalesce(NVI.CODNFVENDA, 0)
    from
      NFVENDAITEM NVI
    where
      NVI.CODPEDVENDITEM = :LIDREGISTROITEM
    into
      LCODPEDVEND;

    update
      MOVESTOQUE
    set
      MOVESTOQUE.IDREGISTRO = :LCODPEDVEND
    where
      MOVESTOQUE.IDREGISTRO     = 0 and
      MOVESTOQUE.IDREGISTROITEM = :LIDREGISTROITEM and
      MOVESTOQUE.TIPODOC        = 'PV';
  end
  exit;
end ^

ALTER PROCEDURE DELETA_BORDERO (CODBORDERO INTEGER)
AS 
declare variable CODBORDEROPAGAMENTO integer;
begin
  for select
    CODBORDEROPAGAMENTO
  from
    BORDEROPAGAMENTO
  where
    BORDEROPAGAMENTO.CODBORDEROPAGAMENTO = :CODBORDERO
  into
    :CODBORDEROPAGAMENTO
  do
  begin
    delete from
      BORDEROPAGAMENTODEBITO
    where
      CODBORDEROPAGAMENTO = :CODBORDERO;
  
    delete from
      BORDEROPAGAMENTOTITULO
    where
      CODBORDEROPAGAMENTO = :CODBORDERO;
  
    delete from
      BORDEROPAGAMENTO
    where
      CODBORDEROPAGAMENTO = :CODBORDERO;
    exit;
  end
end ^

ALTER PROCEDURE DFL_ANP_UI (EEMAIL VARCHAR(60) CHARACTER SET ISO8859_1,
ECODANP INTEGER,
EDESCRICAO VARCHAR(200) CHARACTER SET ISO8859_1,
EREFERENCIA INTEGER,
EGLP DOUBLE PRECISION,
EGNN DOUBLE PRECISION,
EGNI DOUBLE PRECISION)
AS 
DECLARE VARIABLE LIDLOGIN VARCHAR(40);
DECLARE VARIABLE LMENSAGEMERRO VARCHAR(100);
BEGIN
  SELECT U.IDLOGIN FROM USERCAD U WHERE U.EMAIL = :EEMAIL INTO :LIDLOGIN;
  IF(COALESCE(:ECODANP, 0) = 0 ) THEN  
  BEGIN
    IF(NOT EXISTS( SELECT A.DESCRICAO FROM TBL_ANP A WHERE A.DESCRICAO = :EDESCRICAO AND A.COD_TBL_ANP <> COALESCE(:ECODANP,0))
     ) THEN 
    BEGIN           
      INSERT INTO TBL_ANP
        (
          COD_TBL_ANP,
          DESCRICAO,
          REFERENCIA,
          PGLP,
          PGNN,
          PGNI,
          US_CADAST,
          DT_CADAST 
        )
      VALUES 
        (
          NULL,
          :EDESCRICAO,
          :EREFERENCIA,
          :EGLP,
          :EGNN,
          :EGNI,
          :LIDLOGIN,
          CURRENT_DATE
        );    
    END
    ELSE
    BEGIN
      LMENSAGEMERRO = 'ANP JÁ¡ CADASTRADA. INSIRA OUTRA DESCRIÇÃO.';
      EXCEPTION EXCECAO(LMENSAGEMERRO);
    END    
  END
  ELSE
  BEGIN
    UPDATE TBL_ANP SET 
     DESCRICAO = :EDESCRICAO,
     REFERENCIA = :EREFERENCIA,
     PGLP = :EGLP,
     PGNN = :EGNN,
     PGNI = :EGNI,
     DT_MODIFI = CURRENT_DATE, 
     US_MODIFI = :LIDLOGIN  WHERE COD_TBL_ANP = :ECODANP;
    EXIT;
  END   
END ^

ALTER PROCEDURE DFL_AREA_UI (EEMAIL VARCHAR(60) CHARACTER SET ISO8859_1,
ECODAREA INTEGER,
EDESCRICAO VARCHAR(50) CHARACTER SET ISO8859_1,
ECODZONA INTEGER,
EFRETEVALOR DOUBLE PRECISION,
EFRETEALIQ DOUBLE PRECISION)
AS 
DECLARE VARIABLE LIDLOGIN VARCHAR(40);
DECLARE VARIABLE LMENSAGEMERRO VARCHAR(100);
BEGIN
  SELECT U.IDLOGIN FROM USERCAD U WHERE U.EMAIL = :EEMAIL INTO :LIDLOGIN;
  IF(COALESCE(:ECODAREA, 0) = 0 ) THEN  
  BEGIN
    IF(NOT EXISTS( SELECT A.ARE_DESCRICAO FROM  TBL_AREA A WHERE A.ARE_DESCRICAO  = :EDESCRICAO AND A.ARE_CODIGO <> COALESCE(:ECODAREA,0))
     ) THEN 
    BEGIN           
      INSERT INTO TBL_AREA
        (
          ARE_CODIGO,
          ARE_DESCRICAO,
          FRETE_ALIQ,
          FRETE_VALOR,
          ARE_CODZONA,
          US_CADAST,
          DT_CADAST 
        )
      VALUES 
        (
          NULL,
          :EDESCRICAO,
          :EFRETEALIQ,
          :EFRETEVALOR,
          :ECODZONA,
          :LIDLOGIN,
          CURRENT_DATE
        );    
    END
    ELSE
    BEGIN
      LMENSAGEMERRO = 'AREA CADASTRADA. INSIRA OUTRA DESCRIÇÃO.';
      EXCEPTION EXCECAO(LMENSAGEMERRO);
    END    
  END
  ELSE
  BEGIN
    UPDATE TBL_AREA SET 
     ARE_DESCRICAO = :EDESCRICAO,
     FRETE_ALIQ = :EFRETEALIQ,
     FRETE_VALOR = :EFRETEVALOR,
     ARE_CODZONA = :ECODZONA,
     DT_MODIFI = CURRENT_DATE, 
     US_MODIFI = :LIDLOGIN  WHERE ARE_CODIGO = :ECODAREA;
    EXIT;
  END   
END ^

ALTER PROCEDURE DFL_CONTABANCARIA_UI (EEMAIL VARCHAR(60) CHARACTER SET ISO8859_1,
ECODCONTABANCO INTEGER,
ECODBANCO INTEGER,
ETIPO VARCHAR(10) CHARACTER SET ISO8859_1,
EDESCRICAO VARCHAR(45) CHARACTER SET ISO8859_1,
ENOMEAGENCIA VARCHAR(45) CHARACTER SET ISO8859_1,
ENRAGENCIA VARCHAR(45) CHARACTER SET ISO8859_1,
ENRCONTA VARCHAR(45) CHARACTER SET ISO8859_1,
ECODEMPRESA INTEGER,
ESALDO DOUBLE PRECISION)
AS 
DECLARE VARIABLE LIDLOGIN VARCHAR(40);
DECLARE VARIABLE LMENSAGEMERRO VARCHAR(100);
BEGIN
  SELECT U.IDLOGIN FROM USERCAD U WHERE U.EMAIL = :EEMAIL INTO :LIDLOGIN;
  IF(COALESCE(:ECODCONTABANCO, 0) = 0 ) THEN  
  BEGIN
    IF(NOT EXISTS( SELECT A.DESCRICAO FROM CONTABANCO A WHERE A.DESCRICAO = :EDESCRICAO AND A.CODCONTABANCO  <> COALESCE(:ECODCONTABANCO, 0))
     ) THEN 
    BEGIN           
      INSERT INTO CONTABANCO
        (
          CODCONTABANCO,
          CODBANCO,
          TIPO,
          DESCRICAO,
          NOMEAGENCIA,
          NRAGENCIA,
          NRCONTA,
          CODEMPRESA,
          SALDO,
          US_CADAST,
          DT_CADAST 
        )
      VALUES 
        (
          NULL,
          :ECODBANCO,
          :ETIPO,
          :EDESCRICAO,
          :ENOMEAGENCIA,
          :ENRAGENCIA,
          :ENRCONTA,
          :ECODEMPRESA,
          :ESALDO,
          :LIDLOGIN,
          CURRENT_DATE
        );    
    END
    ELSE
    BEGIN
      LMENSAGEMERRO = 'CONTA BANCÁRIA JÁ CADASTRADA. INSIRA OUTROS DADOS.';
      EXCEPTION EXCECAO(LMENSAGEMERRO);
    END    
  END
  ELSE
  BEGIN
    UPDATE CONTABANCO SET 
     CODBANCO = :ECODBANCO,
     TIPO = :ETIPO,
     DESCRICAO = :EDESCRICAO,
     NOMEAGENCIA = :ENOMEAGENCIA,
     NRAGENCIA = :ENRAGENCIA,
     NRCONTA = :ENRCONTA,
     CODEMPRESA = :ECODEMPRESA,
     DT_MODIFI = CURRENT_DATE, 
     US_MODIFI = :LIDLOGIN  WHERE CODCONTABANCO = :ECODCONTABANCO;
    EXIT;
  END   
END ^

ALTER PROCEDURE DFL_FABRICANTE_UI (EEMAIL VARCHAR(100) CHARACTER SET ISO8859_1,
ATIVO INTEGER,
ECODPESSOA INTEGER,
ENOME VARCHAR(60) CHARACTER SET ISO8859_1,
NOMEFANTAZIA VARCHAR(60) CHARACTER SET ISO8859_1,
IE VARCHAR(30) CHARACTER SET ISO8859_1,
CPFCGC VARCHAR(18) CHARACTER SET ISO8859_1,
LOGRADOURO_1 VARCHAR(60) CHARACTER SET ISO8859_1,
NUMERO_1 VARCHAR(10) CHARACTER SET ISO8859_1,
COMPLEMENTO_1 VARCHAR(60) CHARACTER SET ISO8859_1,
BAIRRO_1 VARCHAR(45) CHARACTER SET ISO8859_1,
CIDADE_1 VARCHAR(45) CHARACTER SET ISO8859_1,
UF_1 VARCHAR(2) CHARACTER SET ISO8859_1,
CEP_1 VARCHAR(9) CHARACTER SET ISO8859_1,
FONES VARCHAR(15) CHARACTER SET ISO8859_1,
CODIBGE INTEGER,
EMAIL VARCHAR(100) CHARACTER SET ISO8859_1,
PESSOA_CONTATO VARCHAR(30) CHARACTER SET ISO8859_1)
AS 
DECLARE VARIABLE LCODEMPRESA INTEGER;
DECLARE VARIABLE LCPFCGC VARCHAR(18);
DECLARE VARIABLE LPESSOA INTEGER;
DECLARE VARIABLE LIDLOGIN VARCHAR(45);
DECLARE VARIABLE LCODESTADO INTEGER;
DECLARE VARIABLE LCODBAIRRO INTEGER;
DECLARE VARIABLE LCODCIDADE INTEGER;
DECLARE VARIABLE LCODSTATUS INTEGER;
DECLARE VARIABLE LCODSTATUSINICIAL INTEGER;
DECLARE VARIABLE LCODSTATUSPADRAO INTEGER;
DECLARE VARIABLE LMSGERRO VARCHAR(255);
DECLARE VARIABLE LCODATIVNAOCONTRIBUINTE INTEGER;
DECLARE VARIABLE LCODTIPOATV INTEGER;
DECLARE VARIABLE LCODATIVCONTRIBUINTE INTEGER;
DECLARE VARIABLE LSQL BLOB SUB_TYPE 1 SEGMENT SIZE 80;
BEGIN
  IF (EXISTS(SELECT 1 FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_FABRICANTE_UI')) THEN
  BEGIN
    SELECT SQL FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_FABRICANTE_UI' INTO LSQL;
    EXECUTE STATEMENT (LSQL)
    (
        EEMAIL := :EEMAIL,
        ATIVO := :ATIVO,
        ECODPESSOA := :ECODPESSOA,
        ENOME := :ENOME,
        NOMEFANTAZIA := :NOMEFANTAZIA,
        IE := :IE,
        CPFCGC := :CPFCGC,
        LOGRADOURO_1 := :LOGRADOURO_1,
        NUMERO_1 := :NUMERO_1,
        COMPLEMENTO_1 := :COMPLEMENTO_1,
        BAIRRO_1 := :BAIRRO_1,
        CIDADE_1 := :CIDADE_1,
        UF_1 := :UF_1,
        CEP_1 := :CEP_1,
        FONES := :FONES,
        CODIBGE := :CODIBGE,
        EMAIL := :EMAIL,
        PESSOA_CONTATO := :PESSOA_CONTATO);    
    EXIT;
  END

  SELECT VALOR FROM MLERPARAMETROINTEIRO('STATUS INICIAL PARA O CLIENTE',0) INTO LCODSTATUSINICIAL;
  SELECT VALOR FROM MLERPARAMETROINTEIRO('STATUS CLIENTE PADRÃO',0) INTO LCODSTATUSPADRAO;

  SELECT VALOR FROM MLERPARAMETROINTEIRO('TIPO ATIVIDADE CONTRIBUINTE',0) INTO LCODATIVCONTRIBUINTE;
  SELECT VALOR FROM MLERPARAMETROINTEIRO('TIPO ATIVIDADE NÃO CONTRIBUINTE',0) INTO LCODATIVNAOCONTRIBUINTE;

  
  LCODSTATUS = LCODSTATUSPADRAO;
  IF (LCODSTATUSINICIAL > 0) THEN
    LCODSTATUS = LCODSTATUSINICIAL;
  
  IF (CHAR_LENGTH(CPFCGC) = 13)   THEN
  BEGIN
    LCODTIPOATV = LCODATIVNAOCONTRIBUINTE;
    LPESSOA = 1;
    LCPFCGC =   SUBSTRING(CPFCGC FROM 1 FOR 3) || '.' ||      
        SUBSTRING(CPFCGC FROM 4 FOR 3) || '.' ||
        SUBSTRING(CPFCGC FROM 7 FOR 3) || '-' ||
        SUBSTRING(CPFCGC FROM 10 FOR 2);
  END
  ELSE IF(CHAR_LENGTH(CPFCGC) = 17) THEN
  BEGIN
    IF (UPPER(IE) = 'ISENTO') THEN
      LCODTIPOATV = LCODATIVNAOCONTRIBUINTE;      
    ELSE
      LCODTIPOATV = LCODATIVCONTRIBUINTE;
    LPESSOA = 2;    
    LCPFCGC = SUBSTRING(CPFCGC FROM 1 FOR 2) || '.' ||
        SUBSTRING(CPFCGC FROM 3 FOR 3) || '.' ||
        SUBSTRING(CPFCGC FROM 6 FOR 3) || '/' ||
        SUBSTRING(CPFCGC FROM 9 FOR 4)|| '-' ||
        SUBSTRING(CPFCGC FROM 13 FOR 2);
    END   
  ELSE 
    BEGIN
       IF (CHAR_LENGTH(:CPFCGC) = 14) THEN
      BEGIN
      LPESSOA = 1;
      END  
      ELSE IF(CHAR_LENGTH(:CPFCGC) = 18) THEN
      BEGIN 
      LPESSOA = 2;
      END     
      
      LCPFCGC = :CPFCGC;
    END
  
  
  SELECT CODEMPRESA, IDLOGIN FROM USERCAD WHERE NULLIF(EMAIL,'') = :EEMAIL INTO LCODEMPRESA, LIDLOGIN;

  IF(COALESCE(ECODPESSOA,0) = 0) THEN
    SELECT FIRST 1 PESSOA.CODPESSOA FROM PESSOA WHERE APENASNUMEROS(PESSOA.CPFCGC) = :CPFCGC INTO :ECODPESSOA;

  IF (NULLIF(TRIM(NOMEFANTAZIA),'') IS NULL) THEN
    NOMEFANTAZIA = :ENOME;

  IF(COALESCE(ECODPESSOA,0) = 0) THEN
    BEGIN
      IF(EXISTS (SELECT 
        P.CODPESSOA,
        P.NOME
        FROM PESSOA P 
        WHERE P.CPFCGC = :LCPFCGC AND P.TIPOPESSOA = 'FABRICANTE')) THEN 
        BEGIN
           LMSGERRO = 'FABRICANTE JÁ CADASTRADO! INSIRA OUTRO CPF/CNPJ.';
               EXCEPTION EXCECAO(LMSGERRO);
        END
    END    

  IN AUTONOMOUS TRANSACTION DO
  BEGIN
       SELECT
     FIRST 1
      TBL_ESTADO.CODESTADO
    FROM
      TBL_ESTADO
    WHERE
      TBL_ESTADO.SIGLA = :UF_1
    INTO
      LCODESTADO;

    SELECT
      FIRST 1
      TBL_CIDADES.CODCIDADE
    FROM
      TBL_CIDADES
    WHERE
      TBL_CIDADES.NOMECIDADE = :CIDADE_1
    INTO
      LCODCIDADE;

    IF (COALESCE(LCODCIDADE,0) = 0) THEN
    BEGIN
      INSERT INTO TBL_CIDADES (
        CODESTADO,
        NOMECIDADE,
        DT_CADAST,
        US_CADAST,
        CODIBGE )
      VALUES (
        :LCODESTADO,
        :CIDADE_1,
        'NOW',
        'WEB',
        :CODIBGE)
      RETURNING
        CODCIDADE
      INTO
        LCODCIDADE;
    END

    SELECT
      FIRST 1
      TBL_BAIRRO.CODBAIRRO
    FROM
      TBL_BAIRRO
    WHERE
      TBL_BAIRRO.DESCBAIRRO = :BAIRRO_1
      AND TBL_BAIRRO.CODCIDADE = :LCODCIDADE
    INTO
      LCODBAIRRO;

    IF (COALESCE(LCODBAIRRO,0) = 0) THEN
    BEGIN
      INSERT INTO TBL_BAIRRO (
        CODCIDADE,
        DESCBAIRRO,
        DT_CADAST,
        US_CADAST)
      VALUES (
        :LCODCIDADE,
        :BAIRRO_1,
        'NOW',
        'WEB')
      RETURNING
        CODBAIRRO
      INTO
        LCODBAIRRO;
    END

    IF (COALESCE(ECODPESSOA,0) > 0) THEN
    BEGIN
      UPDATE PESSOA SET
        NOME  = :ENOME,
        PESSOA = :LPESSOA,
        NOMEFANTAZIA = :NOMEFANTAZIA,
        PESSOA_CONTATO = :PESSOA_CONTATO,
        CPFCGC = :CPFCGC,
        IE = :IE,
        LOGRADOURO_1 = :LOGRADOURO_1,
        NUMERO_1  = :NUMERO_1,
        COMPLEMENTO_1 = :COMPLEMENTO_1,
        BAIRRO_1 = :BAIRRO_1,
        CIDADE_1 = :CIDADE_1,
        UF_1 = :UF_1,
        CEP_1 = :CEP_1,
        FONES = :FONES,
        CODIBGE = :CODIBGE,
        EMAIL = :EMAIL,
        US_MODIFI = :LIDLOGIN,
        DT_MODIFI = CURRENT_TIMESTAMP,
        CODBAIRRO1 = :LCODBAIRRO
      WHERE
        PESSOA.CODPESSOA = :ECODPESSOA;
    END
    ELSE
    BEGIN
       INSERT INTO PESSOA(
           TIPOPESSOA,
           PESSOA, 
           ATIVO,      
           NOME,   
           NOMEFANTAZIA,
           PESSOA_CONTATO,
           CPFCGC, 
           IE,
           LOGRADOURO_1, 
           NUMERO_1, 
           COMPLEMENTO_1,  
           BAIRRO_1, 
           CIDADE_1,   
           UF_1,  
           CEP_1, 
           FONES, 
           CODIBGE, 
           EMAIL,
           US_CADAST,
           DT_CADAST,
           US_MODIFI,
           DT_MODIFI,
           CODBAIRRO1,
           CODSTATUS,
           CODTIPOATV)
        VALUES(
          'FABRICANTE',
          :LPESSOA,    
          :ATIVO,
          :ENOME,
          :NOMEFANTAZIA,
          COALESCE(:PESSOA_CONTATO,''),
          :LCPFCGC,
          COALESCE(:IE,''),
          :LOGRADOURO_1,
          :NUMERO_1,
          :COMPLEMENTO_1,
          :BAIRRO_1,
          :CIDADE_1,
          :UF_1,
          :CEP_1,
          :FONES,
          :CODIBGE,
          :EMAIL,
          :LIDLOGIN || ' - DELPHUS',
          CURRENT_TIMESTAMP,
          :LIDLOGIN || ' - DELPHUS',
          CURRENT_TIMESTAMP,
          :LCODBAIRRO,
          :LCODSTATUS,
          :LCODTIPOATV);
          
    END
  END 
  EXIT;
END ^

ALTER PROCEDURE DFL_FORNECEDOR_UI (EEMAIL VARCHAR(100) CHARACTER SET ISO8859_1,
ATIVO INTEGER,
ECODPESSOA INTEGER,
ENOME VARCHAR(60) CHARACTER SET ISO8859_1,
NOMEFANTAZIA VARCHAR(60) CHARACTER SET ISO8859_1,
IE VARCHAR(30) CHARACTER SET ISO8859_1,
CPFCGC VARCHAR(18) CHARACTER SET ISO8859_1,
LOGRADOURO_1 VARCHAR(60) CHARACTER SET ISO8859_1,
NUMERO_1 VARCHAR(10) CHARACTER SET ISO8859_1,
COMPLEMENTO_1 VARCHAR(60) CHARACTER SET ISO8859_1,
BAIRRO_1 VARCHAR(45) CHARACTER SET ISO8859_1,
CIDADE_1 VARCHAR(45) CHARACTER SET ISO8859_1,
UF_1 VARCHAR(2) CHARACTER SET ISO8859_1,
CEP_1 VARCHAR(9) CHARACTER SET ISO8859_1,
FONES VARCHAR(15) CHARACTER SET ISO8859_1,
CODIBGE INTEGER,
EMAIL VARCHAR(100) CHARACTER SET ISO8859_1,
PESSOA_CONTATO VARCHAR(30) CHARACTER SET ISO8859_1)
AS 
DECLARE VARIABLE LCODEMPRESA INTEGER;
DECLARE VARIABLE LCPFCGC VARCHAR(18);
DECLARE VARIABLE LPESSOA INTEGER;
DECLARE VARIABLE LIDLOGIN VARCHAR(45);
DECLARE VARIABLE LCODESTADO INTEGER;
DECLARE VARIABLE LCODBAIRRO INTEGER;
DECLARE VARIABLE LCODCIDADE INTEGER;
DECLARE VARIABLE LCODSTATUS INTEGER;
DECLARE VARIABLE LCODSTATUSINICIAL INTEGER;
DECLARE VARIABLE LCODSTATUSPADRAO INTEGER;
DECLARE VARIABLE LMSGERRO VARCHAR(255);
DECLARE VARIABLE LCODATIVNAOCONTRIBUINTE INTEGER;
DECLARE VARIABLE LCODTIPOATV INTEGER;
DECLARE VARIABLE LCODATIVCONTRIBUINTE INTEGER;
DECLARE VARIABLE LSQL BLOB SUB_TYPE 1 SEGMENT SIZE 80;
BEGIN
  IF (EXISTS(SELECT 1 FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_FORNECEDOR_UI')) THEN
  BEGIN
    SELECT SQL FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_FORNECEDOR_UI' INTO LSQL;
    EXECUTE STATEMENT (LSQL)
    (
        EEMAIL := :EEMAIL,
        ATIVO := :ATIVO,
        ECODPESSOA := :ECODPESSOA,
        ENOME := :ENOME,
        NOMEFANTAZIA := :NOMEFANTAZIA,
        IE := :IE,
        CPFCGC := :CPFCGC,
        LOGRADOURO_1 := :LOGRADOURO_1,
        NUMERO_1 := :NUMERO_1,
        COMPLEMENTO_1 := :COMPLEMENTO_1,
        BAIRRO_1 := :BAIRRO_1,
        CIDADE_1 := :CIDADE_1,
        UF_1 := :UF_1,
        CEP_1 := :CEP_1,
        FONES := :FONES,
        CODIBGE := :CODIBGE,
        EMAIL := :EMAIL,
        PESSOA_CONTATO := :PESSOA_CONTATO);    
    EXIT;
  END
  
  SELECT VALOR FROM MLERPARAMETROINTEIRO('STATUS INICIAL PARA O CLIENTE',0) INTO LCODSTATUSINICIAL;
  SELECT VALOR FROM MLERPARAMETROINTEIRO('STATUS CLIENTE PADRÃƒO',0) INTO LCODSTATUSPADRAO;

  SELECT VALOR FROM MLERPARAMETROINTEIRO('TIPO ATIVIDADE CONTRIBUINTE',0) INTO LCODATIVCONTRIBUINTE;
  SELECT VALOR FROM MLERPARAMETROINTEIRO('TIPO ATIVIDADE NÃƒO CONTRIBUINTE',0) INTO LCODATIVNAOCONTRIBUINTE;
 
 LCODSTATUS = LCODSTATUSPADRAO;
  IF (LCODSTATUSINICIAL > 0) THEN
    LCODSTATUS = LCODSTATUSINICIAL;
  
  IF (CHAR_LENGTH(CPFCGC) = 13)   THEN
    BEGIN
      LCODTIPOATV = LCODATIVNAOCONTRIBUINTE;
      LPESSOA = 1;
      LCPFCGC =   SUBSTRING(CPFCGC FROM 1 FOR 3) || '.' ||      
          SUBSTRING(CPFCGC FROM 4 FOR 3) || '.' ||
          SUBSTRING(CPFCGC FROM 7 FOR 3) || '-' ||
          SUBSTRING(CPFCGC FROM 10 FOR 2);
    END
  ELSE IF(CHAR_LENGTH(CPFCGC) = 17) THEN
    BEGIN
      IF (UPPER(IE) = 'ISENTO') THEN
        LCODTIPOATV = LCODATIVNAOCONTRIBUINTE;      
      ELSE
        LCODTIPOATV = LCODATIVCONTRIBUINTE;
      LPESSOA = 2;    
      LCPFCGC = SUBSTRING(CPFCGC FROM 1 FOR 2) || '.' ||
          SUBSTRING(CPFCGC FROM 3 FOR 3) || '.' ||
          SUBSTRING(CPFCGC FROM 6 FOR 3) || '/' ||
          SUBSTRING(CPFCGC FROM 9 FOR 4)|| '-' ||
          SUBSTRING(CPFCGC FROM 13 FOR 2);
    END   
    
  ELSE 
    BEGIN
      IF (CHAR_LENGTH(:CPFCGC) = 14) THEN
      BEGIN
      LPESSOA = 1;
      END  
      ELSE IF(CHAR_LENGTH(:CPFCGC) = 18) THEN
      BEGIN 
      LPESSOA = 2;
      END     
      
      LCPFCGC = :CPFCGC;
    END
  
  
  SELECT CODEMPRESA, IDLOGIN FROM USERCAD WHERE NULLIF(EMAIL,'') = :EEMAIL INTO LCODEMPRESA, LIDLOGIN;

  IF(COALESCE(ECODPESSOA,0) = 0) THEN
    SELECT FIRST 1 PESSOA.CODPESSOA FROM PESSOA WHERE APENASNUMEROS(PESSOA.CPFCGC) = :CPFCGC INTO :ECODPESSOA;

  IF (NULLIF(TRIM(NOMEFANTAZIA),'') IS NULL) THEN
    NOMEFANTAZIA = :ENOME;

  IF(COALESCE(ECODPESSOA,0) = 0) THEN
    BEGIN
      IF(EXISTS (SELECT 
        P.CODPESSOA,
        P.NOME
        FROM PESSOA P 
        WHERE P.CPFCGC = :LCPFCGC AND P.TIPOPESSOA = 'FORNECEDOR')) THEN 
        BEGIN
           LMSGERRO = 'FORNECEDOR JÁ CADASTRADO! INSIRA OUTRO CPF/CNPJ.';
               EXCEPTION EXCECAO(LMSGERRO);
        END
    END  
    
    IN AUTONOMOUS TRANSACTION DO
  BEGIN
       SELECT
     FIRST 1
      TBL_ESTADO.CODESTADO
    FROM
      TBL_ESTADO
    WHERE
      TBL_ESTADO.SIGLA = :UF_1
    INTO
      LCODESTADO;

    SELECT
      FIRST 1
      TBL_CIDADES.CODCIDADE
    FROM
      TBL_CIDADES
    WHERE
      TBL_CIDADES.NOMECIDADE = :CIDADE_1
    INTO
      LCODCIDADE;

    IF (COALESCE(LCODCIDADE,0) = 0) THEN
    BEGIN
      INSERT INTO TBL_CIDADES (
        CODESTADO,
        NOMECIDADE,
        DT_CADAST,
        US_CADAST,
        CODIBGE )
      VALUES (
        :LCODESTADO,
        :CIDADE_1,
        'NOW',
        'WEB',
        :CODIBGE)
      RETURNING
        CODCIDADE
      INTO
        LCODCIDADE;
    END
    
    SELECT
      FIRST 1
      TBL_BAIRRO.CODBAIRRO
    FROM
      TBL_BAIRRO
    WHERE
      TBL_BAIRRO.DESCBAIRRO = :BAIRRO_1
      AND TBL_BAIRRO.CODCIDADE = :LCODCIDADE
    INTO
      LCODBAIRRO;

    IF (COALESCE(LCODBAIRRO,0) = 0) THEN
    BEGIN
      INSERT INTO TBL_BAIRRO (
        CODCIDADE,
        DESCBAIRRO,
        DT_CADAST,
        US_CADAST)
      VALUES (
        :LCODCIDADE,
        :BAIRRO_1,
        'NOW',
        'WEB')
      RETURNING
        CODBAIRRO
      INTO
        LCODBAIRRO;
    END
    
    IF (COALESCE(ECODPESSOA,0) > 0) THEN
    BEGIN
      UPDATE PESSOA SET
        NOME  = :ENOME,
        PESSOA = :LPESSOA,
        NOMEFANTAZIA = :NOMEFANTAZIA,
        PESSOA_CONTATO = :PESSOA_CONTATO,
        CPFCGC = :CPFCGC,
        IE = :IE,
        LOGRADOURO_1 = :LOGRADOURO_1,
        NUMERO_1  = :NUMERO_1,
        COMPLEMENTO_1 = :COMPLEMENTO_1,
        BAIRRO_1 = :BAIRRO_1,
        CIDADE_1 = :CIDADE_1,
        UF_1 = :UF_1,
        CEP_1 = :CEP_1,
        FONES = :FONES,
        CODIBGE = :CODIBGE,
        EMAIL = :EMAIL,
        US_MODIFI = :LIDLOGIN,
        DT_MODIFI = CURRENT_TIMESTAMP,
        CODBAIRRO1 = :LCODBAIRRO
      WHERE
        PESSOA.CODPESSOA = :ECODPESSOA;
    END
    ELSE
    BEGIN
       INSERT INTO PESSOA(
           TIPOPESSOA,
           PESSOA, 
           ATIVO,      
           NOME,   
           NOMEFANTAZIA,
           PESSOA_CONTATO,
           CPFCGC, 
           IE,
           LOGRADOURO_1, 
           NUMERO_1, 
           COMPLEMENTO_1,  
           BAIRRO_1, 
           CIDADE_1,   
           UF_1,  
           CEP_1, 
           FONES, 
           CODIBGE, 
           EMAIL,
           US_CADAST,
           DT_CADAST,
           US_MODIFI,
           DT_MODIFI,
           CODBAIRRO1,
           CODSTATUS,
           CODTIPOATV)
        VALUES(
          'FORNECEDOR',
          :LPESSOA,    
          :ATIVO,
          :ENOME,
          :NOMEFANTAZIA,
          COALESCE(:PESSOA_CONTATO,''),
          :LCPFCGC,
          COALESCE(:IE,''),
          :LOGRADOURO_1,
          :NUMERO_1,
          :COMPLEMENTO_1,
          :BAIRRO_1,
          :CIDADE_1,
          :UF_1,
          :CEP_1,
          :FONES,
          :CODIBGE,
          :EMAIL,
          :LIDLOGIN || ' - DELPHUS',
          CURRENT_TIMESTAMP,
          :LIDLOGIN || ' - DELPHUS',
          CURRENT_TIMESTAMP,
          :LCODBAIRRO,
          :LCODSTATUS,
          :LCODTIPOATV);
          
    END
  END 
  EXIT;
 
END ^

ALTER PROCEDURE DFL_INSERIR_PAINEIS (EMAIL VARCHAR(60) CHARACTER SET ISO8859_1,
CODPAINEL INTEGER,
DESCRICAO VARCHAR(300) CHARACTER SET ISO8859_1,
LINK VARCHAR(1000) CHARACTER SET ISO8859_1,
CODSMNPAINEL INTEGER,
TITULO VARCHAR(100) CHARACTER SET ISO8859_1,
THUMBNAIL BLOB)
AS 
DECLARE VARIABLE LCODUSERCAD INTEGER;
DECLARE VARIABLE LCODPAINEL INTEGER;
BEGIN    
    IF(EXISTS (SELECT * FROM PAINEIS WHERE CODPAINEL = :CODPAINEL)) THEN    
        BEGIN
          UPDATE PAINEIS SET
                DESCRICAO         = :DESCRICAO,  
                LINK              = :LINK,
                CODSMNPAINEL    = :CODSMNPAINEL,
                TITULO                = :TITULO,
                THUMBNAIL            = :THUMBNAIL  
        WHERE
            CODPAINEL = :CODPAINEL;
        END
    ELSE    
        BEGIN
            SELECT
                UC.CODUSERCAD 
            FROM
                USERCAD UC
            WHERE 
                UC.EMAIL = :EMAIL
            INTO 
                   :LCODUSERCAD;
            
          INSERT INTO PAINEIS (
              DESCRICAO,
              LINK,
              CODSMNPAINEL,
              TITULO,
              THUMBNAIL
              )
          VALUES (
              :DESCRICAO,
              :LINK,
              :CODSMNPAINEL,
              :TITULO,
              :THUMBNAIL
          )
       
           RETURNING 
               CODPAINEL
           INTO
              :LCODPAINEL;
          
          INSERT 
          INTO USERPAINEL (CODUSERCAD, CODPAINEL)
          VALUES (:LCODUSERCAD, :LCODPAINEL);                  
        END
  BEGIN
    EXIT;
  END    
END ^

ALTER PROCEDURE DFL_ZONA_UI (EEMAIL VARCHAR(60) CHARACTER SET ISO8859_1,
EDESCRICAO VARCHAR(50) CHARACTER SET ISO8859_1,
ECODZONA INTEGER)
AS 
DECLARE VARIABLE LIDLOGIN VARCHAR(40);
DECLARE VARIABLE LMENSAGEMERRO VARCHAR(100);
BEGIN
  IF(COALESCE(:ECODZONA, 0) = 0 ) THEN  
  BEGIN
    IF(NOT EXISTS( SELECT Z.DESCRICAO FROM  TBL_ZONA Z WHERE Z.DESCRICAO  = :EDESCRICAO AND Z.CODZONA <> COALESCE(:ECODZONA,0))
     ) THEN 
    BEGIN 
      SELECT U.IDLOGIN FROM USERCAD U WHERE U.EMAIL = :EEMAIL INTO :LIDLOGIN;           
      INSERT INTO TBL_ZONA
        (
          CODZONA,
          DESCRICAO, 
          US_CADAST,
          DT_CADAST 
        )
      VALUES 
        (
          NULL,
          :EDESCRICAO,
          :LIDLOGIN,
          CURRENT_DATE
        );    
    END
    ELSE
    BEGIN
      LMENSAGEMERRO = 'ZONA JÁ! CADASTRADO. INSIRA OUTRA DESCRIÇÃO.';
      EXCEPTION EXCECAO(LMENSAGEMERRO);
    END    
  END
  ELSE
  BEGIN
    SELECT U.IDLOGIN FROM USERCAD U WHERE U.EMAIL = :EEMAIL INTO :LIDLOGIN;
  
    UPDATE TBL_ZONA SET DESCRICAO = :EDESCRICAO, DT_MODIFI = CURRENT_DATE, US_MODIFI = :LIDLOGIN  WHERE CODZONA = :ECODZONA;
    EXIT;
  END   
END ^

ALTER PROCEDURE MAGRUPARPEDIDOS (INI TIMESTAMP,
FIM TIMESTAMP,
LOTE VARCHAR(20) CHARACTER SET ISO8859_1,
LOTEDESTINO VARCHAR(20) CHARACTER SET ISO8859_1,
CODPEDVEND INTEGER,
PESSOA INTEGER,
CODVENDEDOR INTEGER,
PRECOUSADO VARCHAR(20) CHARACTER SET ISO8859_1,
US_CADAST VARCHAR(30) CHARACTER SET ISO8859_1)
AS 
declare variable LCODPRODFILHO integer;
declare variable LCODPESQUISA varchar(30);
declare variable LCUSTOREPOSI double precision;
declare variable LDESCRICAO varchar(60);
declare variable LQTDE integer;
declare variable LVLTOTAL double precision;
declare variable LGEN integer;
declare variable LCODPEDVENDITEM integer;
declare variable LDATA_FAB date;
declare variable LDATA_VAL date;
declare variable LQTDLOTE integer;
begin
  for select
    MLISTAPRODUTO_LOTE.CODPRODFILHO,
    MLISTAPRODUTO_LOTE.SCODPESQUISA,
    MLISTAPRODUTO_LOTE.SCUSTOREPOSI,
    MLISTAPRODUTO_LOTE.SDESCRICAO,
    MLISTAPRODUTO_LOTE.SQTD,
    MLISTAPRODUTO_LOTE.SVLTOTAL
  from
    MLISTAPRODUTO_LOTE(:INI, :FIM, :LOTE)
  into
    LCODPRODFILHO,
    LCODPESQUISA,
    LCUSTOREPOSI,
    LDESCRICAO,
    LQTDE,
    LVLTOTAL
  do
  begin
    insert into
      PEDVENDITEM (
        CODPEDVEND,
        CODPRODFILHO,
        PRECOPROD,
        PRECOVEND,
        QTDE,
        CODPESQUISA,
        US_CADAST,
        DT_CADAST,
        CUSTOREPOSI,
        CODUNIDADE,
        QTDENTREGUE,
        PRECOUSADO)
    values (
      :CODPEDVEND,
      :LCODPRODFILHO,
      :LCUSTOREPOSI,
      :LVLTOTAL,
      :LQTDE,
      :LCODPESQUISA,
      :US_CADAST,
      'NOW',
      :LCUSTOREPOSI,
      1,
      :LQTDE,
      :PRECOUSADO)
    returning
      CODPEDVENDITEM
    into
      :LCODPEDVENDITEM;

    select
      P.DATAFAB,
      P.DATAVAL,
      P.QTD
    from
      PRODFILHOLOTES P
    where
      P.CODPRODFILHO = :LCODPRODFILHO and
      P.LOTE         = :LOTEDESTINO
    into
      LDATA_FAB,
      LDATA_VAL,
      LQTDLOTE;

    insert into
      PEDVENDITEMLOTE (
        CODPEDVENDITEM,
        LOTE,
        DATAFAB,
        DATAVAL,
        QTD,
        QTDESTOQUE,
        DT_CADAST,
        US_CADAST)
    values (
      :LCODPEDVENDITEM,
      :LOTEDESTINO,
      :LDATA_FAB,
      :LDATA_VAL,
      :LQTDE,
      :LQTDLOTE,
      'NOW',
      :US_CADAST);
  end
  exit;
end ^

ALTER PROCEDURE MGERAPEDVEND (ECODPEDVEND INTEGER,
ECODPESSOA INTEGER,
ECODVENDEDOR INTEGER,
EDT_SAIDA TIMESTAMP,
EDESCONTO DOUBLE PRECISION,
EACRESCIMO DOUBLE PRECISION,
EPRECOUSADO VARCHAR(10) CHARACTER SET ISO8859_1,
ETIPOPAG VARCHAR(20) CHARACTER SET ISO8859_1,
EDESC_VALOR DOUBLE PRECISION,
EVALOR_TOTAL DOUBLE PRECISION,
EDT_ENTREGAPREV TIMESTAMP,
EENTREGUE VARCHAR(1) CHARACTER SET ISO8859_1,
EVALOR_BRUTO DOUBLE PRECISION,
ENRITENS DOUBLE PRECISION,
EVALOR_ACRESCIMO DOUBLE PRECISION,
EDESCPERC_VALOR DOUBLE PRECISION,
EUS_CADAST VARCHAR(45) CHARACTER SET ISO8859_1,
EDT_CADAST TIMESTAMP,
ESTATUSPED VARCHAR(10) CHARACTER SET ISO8859_1,
ETIPOPED VARCHAR(10) CHARACTER SET ISO8859_1,
EPDV_TIPOFATURAMENTO SMALLINT,
EPDV_BONIFICACAO VARCHAR(1) CHARACTER SET ISO8859_1,
EPDV_CRITICA VARCHAR(1) CHARACTER SET ISO8859_1,
ETIPOFRETE VARCHAR(1) CHARACTER SET ISO8859_1,
ECODTIPOPAG INTEGER,
EDTFATURADO TIMESTAMP)
AS 
declare variable LCODFATURAMENTO integer;
begin

  LCODFATURAMENTO = gen_id(PEDVENDCADERNOFAT, 1);

  INSERT INTO PEDVEND
  (CODPEDVEND,
   CODPESSOA,
   CODVENDEDOR,
   DT_SAIDA,
   DESCONTO,
   ACRESCIMO,
   PRECOUSADO,
   TIPOPAG,
   DESC_VALOR,
   VALOR_TOTAL,
   DT_ENTREGAPREV,
   ENTREGUE,
   VALOR_BRUTO,
   NRITENS,
   VALOR_ACRESCIMO,
   DESCPERC_VALOR,
   US_CADAST,
   DT_CADAST,
   STATUSPED,
   TIPOPED,
   PDV_TIPOFATURAMENTO,
   PDV_BONIFICACAO,
   PDV_CRITICA,
   TIPOFRETE,
   CODTIPOPAG,
   CODFATURAMENTO,
   OUTPED,
   DTFATURADO)
  values
  ( :ECODPEDVEND,
    :ECODPESSOA,
    :ECODVENDEDOR,
    :EDT_SAIDA,
    :EDESCONTO,
    :EACRESCIMO,
    :EPRECOUSADO,
    :ETIPOPAG,
    :EDESC_VALOR,
    :EVALOR_TOTAL,
    :EDT_ENTREGAPREV,
    :EENTREGUE,
    :EVALOR_BRUTO,
    :ENRITENS,
    :EVALOR_ACRESCIMO,
    :EDESCPERC_VALOR,
    :EUS_CADAST,
    :EDT_CADAST,
    :ESTATUSPED,
    :ETIPOPED,
    :EPDV_TIPOFATURAMENTO,
    :EPDV_BONIFICACAO,
    :EPDV_CRITICA,
    :ETIPOFRETE,
    :ECODTIPOPAG,
    :LCODFATURAMENTO,
    'UNIFICADO',
    :EDTFATURADO);
  exit;
end ^

ALTER PROCEDURE MPROCESSATROCALOTE (LCODTROCA VARCHAR(40) CHARACTER SET ISO8859_1)
AS 
DECLARE VARIABLE LCODMOVESTOQUE     INTEGER;
declare variable LCODMOVESTOQUEPAI  integer;
declare variable LCODPRODFILHO      integer;
declare variable LIDREGISTRO        integer;
declare variable LIDREGISTROITEM    integer;
DECLARE VARIABLE LLOTE              VARCHAR(12);
DECLARE VARIABLE LDATAFAB           DATE;
DECLARE VARIABLE LDATAVAL           DATE;
DECLARE VARIABLE LQTD               DOUBLE PRECISION;
DECLARE VARIABLE LOBS               VARCHAR (80);
declare variable LUSUARIO           varchar(45);
BEGIN
  delete from MOVESTOQUE where movestoque.TIPODOC = 'CTR' and movestoque.DOCUMENTO = :LCODTROCA;
  FOR
    SELECT  
      movestoque.CODMOVESTOQUE,
      movestoque.CODPRODFILHO,
      movestoque.IDREGISTRO,
      MOVESTOQUE.IDREGISTROITEM,
      movestoque.USUARIO
    FROM
      MOVESTOQUE
      JOIN MOVESTOQUELOTE ON
        movestoquelote.CODMOVESTOQUE = movestoque.CODMOVESTOQUE
    WHERE
      movestoque.TIPODOC = 'DV' AND 
      MOVESTOQUE.TIPOMOV = 'E' AND
      movestoque.DOCUMENTO = :LCODTROCA
    INTO
      :LCODMOVESTOQUEPAI,
      :LCODPRODFILHO,
      :LIDREGISTRO,
      :LIDREGISTROITEM,
      :LUSUARIO
  DO
  BEGIN
  FOR
    SELECT
      MOVESTOQUELOTE.LOTE,
      MOVESTOQUELOTE.DATAFAB,
      MOVESTOQUELOTE.DATAVAL,
      MOVESTOQUELOTE.QTD,
      MOVESTOQUELOTE.OBS
    FROM  
      MOVESTOQUELOTE
    WHERE
      movestoquelote.CODMOVESTOQUE = :LCODMOVESTOQUEPAI
    INTO
      :LLOTE,
      :LDATAFAB,
      :LDATAVAL,
      :LQTD,
      :LOBS
    DO
    BEGIN
      execute procedure
        MOVESTOQUE_INS(
          :LCODPRODFILHO,
          :LIDREGISTRO,
          :LIDREGISTROITEM,
          :LCODTROCA,
          'CTR',
          'S',
          :LQTD,
          0,
          :LUSUARIO,
          'NOW',
          1,
          'N')
        returning_values
          :LCODMOVESTOQUE;

      EXECUTE PROCEDURE 
        MATUALIZAESTOQUELOTE(
          :LCODMOVESTOQUE,
          :LDATAFAB,
          :LDATAVAL,
          :LLOTE,
          :LOBS,
          :LQTD);
      EXIT;
    END
  END
END ^

ALTER PROCEDURE STP_AJUSTE_GRADE_LOTE_INS (ELOTE VARCHAR(60) CHARACTER SET ISO8859_1,
ECODAJUSTEITEM INTEGER,
EQTD DOUBLE PRECISION,
ECODPRODFILHO INTEGER,
EUSUARIO VARCHAR(45) CHARACTER SET ISO8859_1)
AS 
declare variable LDESCRICAO varchar(60);
declare variable LQTDESTOQUE double precision;
begin
  for
    select
      L.DESCRICAO
    from
      LOTE L
    where
      L.DESCRICAO = :ELOTE
    into
      LDESCRICAO
  do
  begin
    if (exists(select
                 PFL.CODIGO
               from
                 PRODFILHOLOTES PFL
               where
                 PFL.CODPRODFILHO = :ECODPRODFILHO and
                 PFL.LOTE = :ELOTE)) then
    begin
      select
        PFL.QTDMOV
      from
        PRODFILHOLOTES PFL
      where
        PFL.CODPRODFILHO = :ECODPRODFILHO and
        PFL.LOTE = :ELOTE
      into
        LQTDESTOQUE;
    end
    else
      LQTDESTOQUE = 0;

    insert into
      AJUSTESTOQITEMLOTE (CODAJUSTESTOQITEM, LOTE, DATAFAB, DATAVAL, QTD, QTDESTOQUE, OBS, DT_CADAST, US_CADAST)
        values (:ECODAJUSTEITEM, :ELOTE, 'now', 'now', :EQTD, :LQTDESTOQUE, 'LANCADO VIA TELA DE GRADE', 'now', :EUSUARIO);
    exit;
  end
end ^

ALTER PROCEDURE STP_ATUALIZA_LOTE_TRANSITO (ECODPRODFILHO INTEGER)
AS 
declare variable VALOR varchar(50);
declare variable LQTDPEDCPR double precision;
declare variable LQTDVENDIDA double precision;
declare variable LQTDTRANSITO double precision;
begin
  for select
    VALOR
  from
    MLERPARAMETROTEXTO('DESCRIÇÃO DO LOTE PADRÃO PARA TRÂNSITO', '')
  into
    VALOR
  do
  begin
    if (VALOR <> '') then
    begin
      if (exists (select
                    *
                  from
                    PRODFILHOLOTES PFL
                  where
                    PFL.CODPRODFILHO = :ECODPRODFILHO and
                    PFL.LOTE         = :VALOR)) then
      begin
        
        select
          sum(coalesce(PEDCPRITENS.QTDEPEDIDA,0)) - (sum(coalesce(PEDCPRITENS.QTDERECEBI,0))) TRANSITO
        from
          PEDCPR
          join PEDCPRITENS on
            PEDCPR.CODPEDCPR = PEDCPRITENS.CODPEDCPR
        where
          PEDCPR.STATUS not in ('CANCELADO', 'FATURADO') and
          coalesce(PEDCPRITENS.STATUS, 'ABERTO') <> 'FECHADO' and
          coalesce(PEDCPR.COMPRACASADA, 'N') = 'N' and
          PEDCPRITENS.CODPRODFILHO = :ECODPRODFILHO
        into
          LQTDPEDCPR;

        select
          coalesce(PRODFILHO.EXC2002, 0) EXC2002
        from
          PRODFILHO
        where
          PRODFILHO.CODPRODFILHO = :ECODPRODFILHO
        into
          LQTDVENDIDA;

        LQTDTRANSITO = LQTDPEDCPR - LQTDVENDIDA;
          
        in autonomous transaction do
        begin
          update
            PRODFILHOLOTES PFL
          set
            PFL.QTD    = :LQTDTRANSITO,
            PFL.QTDMOV = :LQTDTRANSITO
          where
            PFL.CODPRODFILHO = :ECODPRODFILHO and
            PFL.LOTE         = :VALOR;
        end
      end
    end
    exit;
  end
end ^

ALTER PROCEDURE STP_BAIXABONIFICACAO (ECODPESSOA INTEGER,
ECODVENDEDOR INTEGER,
ECODPRODFILHO INTEGER,
EQTDE DOUBLE PRECISION)
AS 
declare variable CODPRODFILHO INTEGER;
     declare variable BON_QTDEBAIXADA DOUBLE PRECISION;
     declare variable BON_QTDEPROD DOUBLE PRECISION;
     declare variable CODNFVENDA INTEGER;
     declare variable CODNFVENDAITEM INTEGER;
     declare variable BON_VLBONOFICACAO DOUBLE PRECISION;
     declare variable BON_CODIGO Integer;
begin
FOR
  SELECT
    TBL_BONIFICACAO.CODPRODFILHO,
    TBL_BONIFICACAO.BON_QTDEBAIXADA,
    TBL_BONIFICACAO.BON_QTDEPROD,
    NFVENDAITEM.CODNFVENDA,
    TBL_BONIFICACAO.CODNFVENDAITEM,
    TBL_BONIFICACAO.BON_VLBONOFICACAO,
    TBL_BONIFICACAO.BON_CODIGO
  FROM
    TBL_BONIFICACAO
    INNER JOIN NFVENDAITEM ON (TBL_BONIFICACAO.CODNFVENDAITEM = NFVENDAITEM.CODNFVENDAITEM)
    INNER JOIN NFVENDA ON (NFVENDAITEM.CODNFVENDA = NFVENDA.CODNFVENDA)
    INNER JOIN CONTA ON (NFVENDA.CODNFVENDA = CONTA.CON_CODIGONFXBONIFICACAO)
  WHERE
    (NFVENDA.CODPESSOA =:ECODPESSOA) AND
    (NFVENDA.CODVENDEDOR =:ECODVENDEDOR) AND
    (TBL_BONIFICACAO.CODPRODFILHO =:ECODPRODFILHO) AND
    (TBL_BONIFICACAO.BON_QTDEPROD > TBL_BONIFICACAO.BON_QTDEBAIXADA)
  ORDER BY
    CONTA.DT_EMISSAO
  INTO
    :CODPRODFILHO,
    :BON_QTDEBAIXADA,
    :BON_QTDEPROD,
    :CODNFVENDA,
    :CODNFVENDAITEM,
    :BON_VLBONOFICACAO,
    :BON_CODIGO
DO BEGIN
  if ((BON_QTDEPROD-BON_QTDEBAIXADA) >= EQTDE)  then
  begin
    /*baixa bonificação e contas*/
    UPDATE TBL_BONIFICACAO SET TBL_BONIFICACAO.BON_QTDEBAIXADA =:EQTDE WHERE  TBL_BONIFICACAO.BON_CODIGO =:BON_CODIGO;
    INSERT INTO CONTABX
      (CODCONTA,DESCONTO,JUROS,VLPAGO                       ,DT_PAGAMEN ,TIPOPAG   , OBS1, OBS2, CH_BANCO, CH_AGENCIA, CH_CONTA, CH_NRCHEQUE, CH_BOMPARA, CT_CARTAO, CT_NRCARTAO, US_CADAST, DT_CADAST, US_MODIFI, DT_MODIFI, MOVCAIXA, CODCAIXA, DT_BAIXA, CH_STATUS,CH_DTCOMPENSADO,CH_CODPESSOA,CH_OBS1,CH_OBS2,CODCONTABANCO,CODCARTAOCRED,CH_DATAFATC,CARTAOCRED,DEVOLSTATUS,DIASATRASO)
    VALUES
      (1       ,       0,    0, :BON_VLBONOFICACAO * :EQTDE ,'TODAY'    ,'DINHEIRO', NULL, NULL, NULL    , NULL      , NULL    , NULL       , NULL      , NULL     , NULL       , 'APS'    , 'TODAY'  , NULL     , NULL     , 'S'     , 1       , NULL    , 'ABERTO' ,NULL           ,NULL        ,NULL   ,NULL   ,NULL         ,NULL         ,NULL       ,NULL      ,NULL       ,         0);
    INSERT INTO CAIXA
      (MOVIMENTO,TIPOPAG   ,VALOR                   ,HISTORICO              ,US_CADAST,DT_CADAST,US_MODIFI,DT_MODIFI,DATA,CANCELADA,NRDOCUMENTO)
    VALUES
      ('DÉBITO' ,'DINHEIRO',:BON_VLBONOFICACAO * :EQTDE ,'BAIXA DA PARCELA Nº 1','APS','01/22/2004 15:51:49',NULL,NULL,'01/22/2004',NULL,'1');
    exit;
   end
  EXIT;
END
end ^

ALTER PROCEDURE STP_CALCJUSROSLOTECONTA (ECOD_LOTE_CONTA INTEGER)
AS 
declare variable qtdrep integer;
declare variable lcodanterior integer;
declare variable lcodconta integer;
declare variable lmutplicador double precision;
declare variable lacumuladortotal double precision;
declare variable lcontador double precision;
declare variable ltotjuros double precision;
declare variable cod_lote_conta integer;
declare variable data timestamp;
declare variable qtdtitulos integer;
declare variable tot_titulos double precision;
declare variable nrdocumento varchar(30);
declare variable status varchar(10);
declare variable parcela varchar(5);
declare variable codpessoa integer;
declare variable dt_vencim timestamp;
declare variable vltotal double precision;
declare variable vlpago double precision;
declare variable prev_tipopag varchar(20);
declare variable totjuros double precision;
declare variable juros_pend double precision;
declare variable vl_desconto double precision;
declare variable codvendedor integer;
declare variable dt_pagamen timestamp;
declare variable cod_lote_conta_itens integer;
declare variable vljurospag double precision;
begin
  LCODANTERIOR = 0;
  for select
    LOTE_CONTA.COD_LOTE_CONTA,
    LOTE_CONTA_ITENS.CODCONTA,
    LOTE_CONTA_ITENS.COD_LOTE_CONTA_ITENS,
    LOTE_CONTA.DATA,
    LOTE_CONTA.QTDTITULOS,
    LOTE_CONTA.TOT_TITULOS,
    CONTA.NRDOCUMENTO,
    LOTE_CONTA.STATUS,
    CONTA.PARCELA,
    CONTA.CODPESSOA,
    CONTA.DT_VENCIM,
    cast (VLTOTAL as numeric(10,2)) VLTOTAL,
    cast (CONTA.VLPARCELA as numeric(10,2)) VLPAGO,
    LOTE_CONTA_ITENS.TIPOPAG PREV_TIPOPAG,
    LOTE_CONTA_ITENS.VLJUROSPAG,
    cast (VL_JUROS as numeric(10,2)) TOTJUROS,
    cast (JUROS_PEND as numeric(10,2)) JUROS_PEND,
    cast (VL_DESCONTO as numeric(10,2)) VL_DESCONTO,
    CONTA.CODVENDEDOR,
    coalesce(LOTE_CONTA_ITENS.CH_BOMPARA, LOTE_CONTA_ITENS.DT_PAGAMEN) DT_PAGAMEN
  from
    LOTE_CONTA_ITENS
    join LOTE_CONTA on LOTE_CONTA.COD_LOTE_CONTA = LOTE_CONTA_ITENS.COD_LOTE_CONTA
    join CONTA on LOTE_CONTA_ITENS.CODCONTA = CONTA.CODCONTA
  where
    LOTE_CONTA_ITENS.COD_LOTE_CONTA = :ECOD_LOTE_CONTA
  order by
    2
  into
    COD_LOTE_CONTA,
    LCODCONTA,
    COD_LOTE_CONTA_ITENS,
    DATA,
    QTDTITULOS,
    TOT_TITULOS,
    NRDOCUMENTO,
    STATUS,
    PARCELA,
    CODPESSOA,
    DT_VENCIM,
    VLTOTAL,
    VLPAGO,
    PREV_TIPOPAG,
    VLJUROSPAG,
    LTOTJUROS,
    JUROS_PEND,
    VL_DESCONTO,
    CODVENDEDOR,
    DT_PAGAMEN
  do
  begin
    TOTJUROS = LTOTJUROS;
    select
      count(*)
    from
      LOTE_CONTA_ITENS
    where
      LOTE_CONTA_ITENS.COD_LOTE_CONTA = :COD_LOTE_CONTA and
      LOTE_CONTA_ITENS.CODCONTA = :LCODCONTA
    into
      QTDREP;
    
    if (LCODCONTA <> LCODANTERIOR) then
    begin
      LACUMULADORTOTAL = 0;
      LACUMULADORTOTAL = VLPAGO;
      LCONTADOR = 1;
      if (LTOTJUROS <> 0) then
      begin
        LMUTPLICADOR = LTOTJUROS / (VLTOTAL + LTOTJUROS);
        if (QTDREP = 1) then
          JUROS_PEND = LTOTJUROS - (VLPAGO * LMUTPLICADOR);
        else
          JUROS_PEND = 0;
        LTOTJUROS = (VLPAGO * LMUTPLICADOR);
      end
      else
      begin
        JUROS_PEND = 0;
      end
      LCODANTERIOR = LCODCONTA;
    end
    else
    begin
      LACUMULADORTOTAL = LACUMULADORTOTAL + VLPAGO;
      if (LTOTJUROS <> 0) then
      begin
        LMUTPLICADOR = LTOTJUROS / (VLTOTAL + LTOTJUROS);
        LCONTADOR = LCONTADOR + 1;
        if (LCONTADOR = QTDREP) then
          JUROS_PEND = LTOTJUROS - (LACUMULADORTOTAL * LMUTPLICADOR);
        LTOTJUROS = (VLPAGO * LMUTPLICADOR);
      end
      else
      begin
        JUROS_PEND = 0;
      end
    end
    
    update
      LOTE_CONTA_ITENS
    set
      LOTE_CONTA_ITENS.VLJUROSPAG = :LTOTJUROS,
      LOTE_CONTA_ITENS.JUROS_PEND = :JUROS_PEND
    where
      LOTE_CONTA_ITENS.COD_LOTE_CONTA_ITENS = :COD_LOTE_CONTA_ITENS;
    exit;
  end
end ^

ALTER PROCEDURE STP_CORRIGE_CODLIVRESEMMASK AS 
DECLARE VARIABLE CODLIVRE VARCHAR(60);
DECLARE VARIABLE USAR_GRAUCENTCUSTO CHAR(1);
DECLARE VARIABLE G1 INTEGER;
DECLARE VARIABLE G2 INTEGER;
DECLARE VARIABLE G3 INTEGER;
DECLARE VARIABLE G4 INTEGER;
DECLARE VARIABLE G5 INTEGER;
DECLARE VARIABLE G6 INTEGER;
DECLARE VARIABLE G7 INTEGER;
DECLARE VARIABLE G8 INTEGER;
DECLARE VARIABLE SQL VARCHAR(300);
DECLARE VARIABLE P1 INTEGER;
DECLARE VARIABLE P2 INTEGER;
DECLARE VARIABLE P3 INTEGER;
DECLARE VARIABLE P4 INTEGER;
DECLARE VARIABLE P5 INTEGER;
DECLARE VARIABLE P6 INTEGER;
DECLARE VARIABLE P7 INTEGER;
DECLARE VARIABLE P8 INTEGER;
begin
  SELECT USAR_GRAUCENTCUSTO, G1, G2, G3, G4, G5, G6, G7, G8
  FROM SYSPARAMS
  INTO USAR_GRAUCENTCUSTO, G1, G2, G3, G4, G5, G6, G7, G8;

  IF (:USAR_GRAUCENTCUSTO = 'S') THEN
  BEGIN
    FOR SELECT CODLIVRE FROM CENTCUSTO
    INTO CODLIVRE DO
    BEGIN
      P1 = G1;
      P2 = G2;
      P3 = G3;
      P4 = G4;
      P5 = G5;
      P6 = G6;
      P7 = G7;
      P8 = G8;

      /* MONTA A SQL QUE CORRIGE O CÓDIGO */
      SQL = 'UPDATE CENTCUSTO SET CODLIVRESEMMASK = ';

      IF (COALESCE(G1,  0) > 0) THEN
        SQL = SQL || 'SUBSTRING(CODLIVRE FROM 1 FOR ' || :P1 || ') ';

      P1 = P1 + 2;
      IF (COALESCE(G2,  0) > 0) THEN
        SQL = SQL || '|| SUBSTRING(CODLIVRE FROM ' || :P1 || ' FOR ' || :P2 || ') ';

      P2 = P1 + P2 + 1;
      IF (COALESCE(G3,  0) > 0) THEN
        SQL = SQL || '|| SUBSTRING(CODLIVRE FROM ' || :P2 || ' FOR ' || :P3 || ') ';

      P3 = P2 + P3 + 1;
      IF (COALESCE(G4,  0) > 0) THEN
        SQL = SQL || '|| SUBSTRING(CODLIVRE FROM ' || :P3 || ' FOR ' || :P4 || ') ';

      P4 = P3 + P4 + 1;
      IF (COALESCE(G5,  0) > 0) THEN
        SQL = SQL || '|| SUBSTRING(CODLIVRE FROM ' || :P4 || ' FOR ' || :P5 || ') ';

      P5 = P4 + P5 + 1;
      IF (COALESCE(G6,  0) > 0) THEN
        SQL = SQL || '|| SUBSTRING(CODLIVRE FROM ' || :P5 || ' FOR ' || :P6 || ') ';

      P6 = P5 + P6 + 1;
      IF (COALESCE(G7,  0) > 0) THEN
        SQL = SQL || '|| SUBSTRING(CODLIVRE FROM ' || :P6 || ' FOR ' || :P7 || ') ';

      P7 = P6 + P7 + 1;
      IF (COALESCE(G8,  0) > 0) THEN
        SQL = SQL || '|| SUBSTRING(CODLIVRE FROM ' || :P7 || ' FOR ' || :P8 || ') ';

    END
  END

  EXECUTE STATEMENT SQL;

  EXIT;
end ^

ALTER PROCEDURE STP_GERA_LOTE (COD INTEGER)
AS 
declare variable CODPRODFILHO integer;
declare variable LOTE varchar(200);
declare variable DATAFAB timestamp;
declare variable DATAVAL timestamp;
begin
  for select
    AEI.CODPRODFILHO,
    AEIL.LOTE,
    AEIL.DATAFAB,
    AEIL.DATAVAL
  from
    AJUSTESTOQITEM AEI
    join AJUSTESTOQITEMLOTE AEIL on
      AEI.CODAJUSTESTOQITEM = AEIL.CODAJUSTESTOQITEM
  where
    AEIL.CODAJUSTESTOQITEM = :COD
  into
    CODPRODFILHO,
    LOTE,
    DATAFAB,
    DATAVAL
  do
  begin
    if(not(exists(select
                   *
                  from
                    PRODFILHOLOTES PFL
                  where
                    PFL.CODPRODFILHO = :CODPRODFILHO and
                    PFL.LOTE = :LOTE ))) then
    begin
    insert into
      PRODFILHOLOTES (
        CODPRODFILHO,
        DATAFAB,
        LOTE,
        DATAVAL,
        DATAMOV,
        QTD,
        QTDMOV,
        DT_CADAST,
        US_CADAST)
    values (
      :CODPRODFILHO,
      :DATAFAB,
      :LOTE,
      :DATAVAL,
      'now',
      0,
      0,
      'now',
      'APS');
    end
    exit;
  end
end ^

ALTER PROCEDURE STP_INSERIRTAREFAITEM (ECODTAREFA INTEGER,
ECODPRODFILHO INTEGER,
EQTDSEPARADA DOUBLE PRECISION,
EDOCUMENTO VARCHAR(40) CHARACTER SET ISO8859_1,
ETIPODOC VARCHAR(5) CHARACTER SET ISO8859_1,
ETIPOMOV VARCHAR(1) CHARACTER SET ISO8859_1,
ELOTE VARCHAR(200) CHARACTER SET ISO8859_1,
EDATAFAB TIMESTAMP,
EDATAVAL TIMESTAMP,
EENDERECAMENTO VARCHAR(60) CHARACTER SET ISO8859_1,
ECONTROLALOTE VARCHAR(1) CHARACTER SET ISO8859_1,
ECODSERIECAIXA VARCHAR(30) CHARACTER SET ISO8859_1 = '')
AS 
declare variable LCUSTOREPOSI double precision;
declare variable LPRECOPRATICADO1 double precision;
begin
  for select
    PRODFILHO.CUSTOREPOSI, 
    PRODFILHO.PRECOPRATICADO1
  from
    PRODFILHO
  where
    PRODFILHO.CODPRODFILHO = :ECODPRODFILHO
  into
    LCUSTOREPOSI,
    LPRECOPRATICADO1
  do
  begin
    if (ECONTROLALOTE = 'S') then
    begin
      insert into TAREFA_EXPEDICAO_ITENS
        (CODPRODFILHO,
        CODTAREFA,
        QTD,
        DOCUMENTO,
        TIPODOC,
        TIPOMOV,
        LOTE,
        DATAFAB,
        DATAVAL,
        ENDERECAMENTODESC,
        CUSTOREPOSI,
        PRECOUSADO)
      values
        (:ECODPRODFILHO,
        :ECODTAREFA,
        :EQTDSEPARADA,
        :EDOCUMENTO,
        :ETIPODOC,
        :ETIPOMOV,
        :ELOTE,
        :EDATAFAB,
        :EDATAVAL,
        :EENDERECAMENTO,
        :LCUSTOREPOSI,
        :LPRECOPRATICADO1);
    end
    else
    begin
      insert into TAREFA_EXPEDICAO_ITENS
        (CODPRODFILHO,
        CODTAREFA,
        QTD,
        DOCUMENTO,
        TIPODOC,
        TIPOMOV,
        ENDERECAMENTODESC,
        CUSTOREPOSI,
        PRECOUSADO)
      values
        (:ECODPRODFILHO,
        :ECODTAREFA,
        :EQTDSEPARADA,
        :EDOCUMENTO,
        :ETIPODOC,
        :ETIPOMOV,
        :EENDERECAMENTO,
        :LCUSTOREPOSI,
        :LPRECOPRATICADO1);
    end
    exit;
  end
end ^

ALTER PROCEDURE STP_MOV_LOTE_PEND_ENTREGA (ECODEMBARQUE INTEGER)
AS 
declare variable LSTATUSEMBARQUE varchar(15);
declare variable LLOTEPENDENTREGA varchar(50);
declare variable LLOTEDEVEMBARQUE varchar(50);
declare variable LCODPEDVEND integer;
declare variable LCODPRODFILHO integer;
declare variable LCODPEDVENDITEM integer;
declare variable LCODMOVESTOQUE integer;
declare variable LDATAFAB date;
declare variable LDATAVAL date;
declare variable LQTDMOV double precision;
declare variable LQTDE double precision;
declare variable LDEVOLUCAOTOTAL varchar(1);
begin
  select
    VALOR
  from
    MLERPARAMETROTEXTO('DESCRIÇÃO DO LOTE PADRÃO PARA PEND.ENTREGA', '')
  into
    LLOTEPENDENTREGA;

  select
    VALOR
  from
    MLERPARAMETROTEXTO('DESCRIÇÃO DO LOTE DEVOLUÇÃO EMBARQUE', '')
  into
    LLOTEDEVEMBARQUE;

  select
    E.STATUS
  from
    EMBARQUE E
  where
    E.CODEMBARQUE = :ECODEMBARQUE
  into
    LSTATUSEMBARQUE;

    if (LSTATUSEMBARQUE = 'TRANSITO') then
    begin
      for select
        EI.CODPEDVEND_FK
      from
        EMBARQUEITEM EI
      into
        LCODPEDVEND
      do
      begin
        for select
          PVI.CODPRODFILHO,
          PVI.CODPEDVENDITEM
        from
          PEDVENDITEM PVI
        where
          PVI.CODPEDVEND = :LCODPEDVEND
        into
          LCODPRODFILHO,
          LCODPEDVENDITEM
        do
        begin
          execute procedure MATUALIZAESTOQUE(LCODPRODFILHO, LCODPEDVENDITEM, null, LCODPEDVEND, 'LE', 'S', 0, 0, 'LIBERACAO EMBARQUE', 1, 'N',
            LCODPEDVENDITEM)
            returning_values LCODMOVESTOQUE;

          select
            PL.DATAFAB,
            PL.QTDMOV,
            PL.DATAVAL,
            PVI.QTDE
          from
            PEDVENDITEM PVI
            join PRODFILHOLOTES PL on
            PL.CODPRODFILHO = PVI.CODPRODFILHO and
            PL.LOTE = :LLOTEPENDENTREGA
          where
            PVI.CODPEDVENDITEM = :LCODPEDVENDITEM
          order by
            2
          into
            LDATAFAB,
            LQTDMOV,
            LDATAVAL,
            LQTDE;
            execute procedure MATUALIZAESTOQUELOTE(LCODMOVESTOQUE, LDATAFAB, LDATAVAL, LLOTEPENDENTREGA, null, LQTDE);
        end
      end
    end
    else if (LSTATUSEMBARQUE = 'FECHADO PARCIAL') then
    begin
      /* Listando os pedidos do embarque */
      for select
        EI.CODPEDVEND_FK,
        coalesce( EI.RETORNO, 'N')
      from
        EMBARQUEITEM EI
      into
        LCODPEDVEND,
        LDEVOLUCAOTOTAL
      do
      begin
      /* Pedido tem itens devolvidos */
        if (LDEVOLUCAOTOTAL = 'N') then
        begin
          if (exists(select
                      *
                     from
                       embarqueitem
                       join embarqueitemdevolucao on
                         embarqueitemdevolucao.codembarqueitem = embarqueitem.codembarqueitem
                     where
                       embarqueitem.codpedvend_fk = :LCODPEDVEND)) then
          begin
            for select
              EID.CODPRODFILHO,
              EI.CODPEDVEND_FK,
              EID.CODPEDVENDITEM,
              EID.QTD
            from
              EMBARQUEITEM EI
              join EMBARQUEITEMDEVOLUCAO EID on
                EID.CODEMBARQUEITEM = EI.CODEMBARQUEITEM
            where
              EI.CODPEDVEND_FK = :LCODPEDVEND
            into
              LCODPRODFILHO,
              LCODPEDVEND,
              LCODPEDVENDITEM,
              LQTDE
            do
            begin
              execute procedure MATUALIZAESTOQUE(LCODPRODFILHO, LCODPEDVENDITEM, null, LCODPEDVEND, 'DE', 'E', 0, 0, 'DEVOLUÇÃO EMBARQUE', 1, 'N',
                LCODPEDVENDITEM)
                returning_values LCODMOVESTOQUE;

              select
                PL.DATAFAB,
                PL.QTDMOV,
                PL.DATAVAL
              from
                PEDVENDITEM PVI
                join PRODFILHOLOTES PL on
                PL.CODPRODFILHO = PVI.CODPRODFILHO and
                PL.LOTE = :LLOTEPENDENTREGA
              where
                PVI.CODPEDVENDITEM = :LCODPEDVENDITEM
              order by
                2
              into
                LDATAFAB,
                LQTDMOV,
                LDATAVAL;
                execute procedure MATUALIZAESTOQUELOTE(LCODMOVESTOQUE, LDATAFAB, LDATAVAL, LLOTEDEVEMBARQUE, null, LQTDE);
            end
          end
        end
        else
        begin
        /* devolucao de todos os itens do pedido */
          for select
            PVI.CODPRODFILHO,
            PVI.CODPEDVENDITEM
          from
            PEDVENDITEM PVI
          where
            PVI.CODPEDVEND = :LCODPEDVEND
          into
            LCODPRODFILHO,
            LCODPEDVENDITEM
          do
          begin
            execute procedure MATUALIZAESTOQUE(LCODPRODFILHO, LCODPEDVENDITEM, null, LCODPEDVEND, 'DE', 'E', 0, 0, 'DEVOLUÇÃO EMBARQUE', 1, 'N',
              LCODPEDVENDITEM)
              returning_values LCODMOVESTOQUE;
  
            select
              PL.DATAFAB,
              PL.QTDMOV,
              PL.DATAVAL,
              PVI.QTDE
            from
              PEDVENDITEM PVI
              join PRODFILHOLOTES PL on
              PL.CODPRODFILHO = PVI.CODPRODFILHO and
              PL.LOTE = :LLOTEPENDENTREGA
            where
              PVI.CODPEDVENDITEM = :LCODPEDVENDITEM
            order by
              2
            into
              LDATAFAB,
              LQTDMOV,
              LDATAVAL,
              LQTDE;
              execute procedure MATUALIZAESTOQUELOTE(LCODMOVESTOQUE, LDATAFAB, LDATAVAL, LLOTEDEVEMBARQUE, null, LQTDE);
          end
        end
      end
    end
  exit;
end ^

ALTER PROCEDURE STP_NFENTRADA AS 
declare variable CODNFENTRADA Integer;
     declare variable CFOP_CFOP Varchar(4);
     declare variable CODCFOP Integer;
begin
FOR
SELECT
  NFENTRADA.CODNFENTRADA,
  NFENTRADA.CFOP_CFOP,
  NFENTRADA.CODCFOP
FROM
  NFENTRADA INTO :CODNFENTRADA, :CFOP_CFOP, :CODCFOP
DO BEGIN
   UPDATE NFENTRADAITENS SET NFENTRADAITENS.CODCFOP=:CODCFOP, NFENTRADAITENS.CFOP_CFOP=:CFOP_CFOP WHERE NFENTRADAITENS.CODNFENTRADA=:CODNFENTRADA;
   EXIT;
END
end ^

ALTER PROCEDURE STP_NFSERECORRENTE (ECODEMPRESA INTEGER,
EUSUARIO VARCHAR(85) CHARACTER SET ISO8859_1)
AS 
declare variable LCODNFSECAB integer;
declare variable LCODPESSOA integer;
declare variable LDIA_RECORRENCIA smallint;
declare variable LVALOR_RECORRENCIA double precision;
declare variable LNFSEREGIMETRIBUTACAO smallint;
declare variable LCNAE varchar(20);
declare variable LCODIBGE integer;
declare variable LCODIGOITEMSERVICO varchar(10);
declare variable LCODSERVICO integer;
declare variable LALIQUOTA double precision;
declare variable LSERIE varchar(3);
declare variable LDESCDSERVICO varchar(60);
declare variable LCODTIPOPAG integer;
begin
  select NFSEREGIMETRIBUTACAO, CODIBGE, SERIE_CERTIF_DIGITAL_NFSE from EMPRESA where CODEMPRESA = :ECODEMPRESA into  LNFSEREGIMETRIBUTACAO, LCODIBGE, LSERIE;


  for select
    PESSOA.CODPESSOA,
    PESSOA.DIA_RECORRENCIA,
    PESSOA.VALOR_RECORRENCIA,
    PESSOA.CNAE,
    PESSOA.CODIGOITEMSERVICO,
    PESSOA.CODSERVICO,
    PESSOA.CODTIPOPAG1
  from
    PESSOA
  where
    PESSOA.FLAG_RECORRENCIA = 1
    and nullif(trim(PESSOA.CNAE),'') is not null
    and nullif(trim(PESSOA.CODIGOITEMSERVICO),'') is not null
    and PESSOA.DIA_RECORRENCIA > 0
    and PESSOA.DIA_RECORRENCIA <= 31
    and not exists(select
                     1
                   from
                     NFSECAB
                   where
                     NFSECAB.CODTOMBADOR = PESSOA.CODPESSOA
                     and NFSECAB.FLAG_RECORRENCIA = 1
                     and extract(month from NFSECAB.DTCOMPETENCIA) = extract(month from current_date))
  into
    :LCODPESSOA,
    :LDIA_RECORRENCIA,
    :LVALOR_RECORRENCIA,
    :LCNAE,
    :LCODIGOITEMSERVICO,
    :LCODSERVICO,
    :LCODTIPOPAG
  do
  begin
    select ALIQUOTA from EMPRESA_CNAE where CNAE = :LCNAE into :LALIQUOTA;

    insert into NFSECAB(
      NFSECAB.CODEMPRESA,
      NFSECAB.CODTOMBADOR,
      NFSECAB.DTCOMPETENCIA,
      NFSECAB.CNAE,
      NFSECAB.CODSERVICO,
      NFSECAB.FLAG_IMPOSTORETIDO,
      NFSECAB.NATOPERACAO,
      NFSECAB.VALOR_INSS,
      NFSECAB.VALOR_IRPJ,
      NFSECAB.VALOR_CSLL,
      NFSECAB.CODFINS,
      NFSECAB.PISPASEP,
      NFSECAB.OUTRASRETENCOES,
      NFSECAB.TOTAL_SERVICOS,
      NFSECAB.DEDUCOES,
      NFSECAB.BASEISS,
      NFSECAB.ALIQUOTA,
      NFSECAB.VALOR_ISS,
      NFSECAB.DESCONTOINCONDICIONAL,
      NFSECAB.DT_CADAST,
      NFSECAB.US_CADAST,
      NFSECAB.SERIE,
      NFSECAB.REGIMETRIBUTACAO,
      NFSECAB.CODIBGE,
      NFSECAB.FLAG_RECORRENCIA,
      NFSECAB.CODTIPOPAG)
    values (
      :ECODEMPRESA,
      :LCODPESSOA,
      cast(extract(year from current_date)||'-'||extract(month from current_date)||'-'||:LDIA_RECORRENCIA as date),
      :LCNAE,
      :LCODIGOITEMSERVICO,
      0,
      1,
      0.00,
      0.00,
      0.00,
      0.00,
      0.00,
      0.00,
      :LVALOR_RECORRENCIA,
      0.00,
      :LVALOR_RECORRENCIA,
      :LALIQUOTA,
      round(:LVALOR_RECORRENCIA * (:LALIQUOTA/100),2),
      0.00,
      current_timestamp,
      :EUSUARIO,
      :LSERIE,
      :LNFSEREGIMETRIBUTACAO,
      :LCODIBGE,
      1,
      :LCODTIPOPAG)
    returning CODNFSECAB
    into :LCODNFSECAB;


    select prodfilho.DESCRICAO from prodfilho where prodfilho.CODPRODFILHO = :LCODSERVICO into LDESCDSERVICO;

    insert into NFSEDET(
      NFSEDET.CODNFSE,
      NFSEDET.CODSERVICO,
      NFSEDET.DESCRIMINACAO,
      NFSEDET.VALOR_SERVICO)
    values(
      :LCODNFSECAB,
      :LCODSERVICO,
      :LDESCDSERVICO,
      :LVALOR_RECORRENCIA);
    exit;
  end
end ^

ALTER PROCEDURE STP_PROPORCIONALIZA_BORDERO (ECODBORDERO INTEGER,
EVALORBORDERO DOUBLE PRECISION,
EDESCONTOGERAL DOUBLE PRECISION,
EJUROSGERAL DOUBLE PRECISION)
AS 
declare variable CODBORDEROPAGAMENTOTITULO integer;
declare variable CODBORDEROPAGAMENTO integer;
declare variable CODCONTA integer;
declare variable VALORBRUTO double precision;
declare variable DESCONTO double precision;
declare variable JUROS double precision;
declare variable VALOLIQ double precision;
declare variable DT_CADAST timestamp;
declare variable US_CADAST varchar(45);
declare variable DT_MODIFI timestamp;
declare variable US_MODIFI varchar(45);
declare variable DATANET timestamp;
declare variable ATUALIZADATANET char(1);
declare variable NAOVERIFICARID char(1);
declare variable CODEMPRESA integer;
declare variable CODEMPRESANET integer;
declare variable ATUALIZACODEMPRESANET char(1);
declare variable FATORDESCONTO double precision;
declare variable FATORMULTA double precision;
declare variable LDESCONTO double precision;
declare variable LJUROS double precision;
begin
  for select
    CODBORDEROPAGAMENTOTITULO,
    CODBORDEROPAGAMENTO,
    CODCONTA,
    VALORBRUTO,
    DESCONTO,
    JUROS,
    VALOLIQ
  from
    BORDEROPAGAMENTOTITULO B
  where
    B.CODBORDEROPAGAMENTO = :ECODBORDERO
  into
    CODBORDEROPAGAMENTOTITULO,
    CODBORDEROPAGAMENTO,
    CODCONTA,
    VALORBRUTO,
    DESCONTO,
    JUROS,
    VALOLIQ
  do
  begin
    LJUROS = ((:VALOLIQ * ((:EJUROSGERAL * 100) / :EVALORBORDERO)) / 100) + :JUROS;
    LDESCONTO = ((:VALOLIQ * ((:EDESCONTOGERAL * 100) / :EVALORBORDERO)) / 100) + :DESCONTO;

    update BORDEROPAGAMENTOTITULO
    set
      BORDEROPAGAMENTOTITULO.DESCONTO = :LDESCONTO,
      BORDEROPAGAMENTOTITULO.JUROS = :LJUROS,
      BORDEROPAGAMENTOTITULO.VALOLIQ = :VALORBRUTO - :LDESCONTO + :LJUROS
    where
      BORDEROPAGAMENTOTITULO.CODBORDEROPAGAMENTOTITULO = :CODBORDEROPAGAMENTOTITULO;
  end
    exit;
end ^

ALTER PROCEDURE STP_RENEGOCIACAO (ECODCONTA INTEGER)
AS 
declare variable LCODCONTARENEGOCIADO integer;
declare variable CODCONTA integer;
declare variable STATUS varchar(10);
declare variable TIPO varchar(10);
declare variable DESCRICAO varchar(60);
declare variable NRDOCUMENTO varchar(30);
declare variable CODPESSOA integer;
declare variable DT_EMISSAO timestamp;
declare variable DT_VENCIM timestamp;
declare variable PARCELA varchar(5);
declare variable PREV_TIPOPAG varchar(20);
declare variable VLPARCELA double precision;
declare variable VLTOTAL double precision;
declare variable CODCENTCUSTO integer;
declare variable OBS1 varchar(100);
declare variable OBS2 varchar(100);
declare variable US_CADAST varchar(45);
declare variable DT_CADAST timestamp;
declare variable US_MODIFI varchar(45);
declare variable DT_MODIFI timestamp;
declare variable TOTDESCONTO double precision;
declare variable TOTJUROS double precision;
declare variable TOTPAGO double precision;
declare variable CODPENDVEND integer;
declare variable CODNFENTRADA integer;
declare variable CODNFVENDA integer;
declare variable CODCARTAO integer;
declare variable NRFORMULARIO varchar(10);
declare variable CODVENDEDOR integer;
declare variable COMISCARTAO double precision;
declare variable CODNFSERVICO integer;
declare variable VLRNEGOCIA double precision;
declare variable CODEMPRESA integer;
declare variable COMISTIPOPAG double precision;
declare variable CODPEDCOMPRA integer;
declare variable PERCJUROS double precision;
declare variable NRCARTAO varchar(20);
declare variable NUMERO varchar(10);
declare variable CART_PERC double precision;
declare variable CART_VALOR double precision;
declare variable CODTROCA integer;
declare variable CODBANCO integer;
declare variable CON_CODIGONFXBONIFICACAO integer;
declare variable REF_FRETE char(1);
declare variable BOLETOIMPRESSO char(1);
declare variable CONT_CUSTAS double precision;
declare variable SERIENF char(3);
declare variable CODCONTABANCO integer;
declare variable NRDOCUMENTO_DV varchar(2);
declare variable CODOBS integer;
declare variable CODRATEIO integer;
declare variable DESC_FINANCEIRO double precision;
declare variable CODSUPERVISOR integer;
declare variable NRDOCUMENTO_BOLETO varchar(30);
declare variable NRBANCO integer;
declare variable TAXABOLETO double precision;
declare variable CODTIPOLANCAMENTO integer;
declare variable DIAS integer;
declare variable COMIS_VEND_EXTERNO double precision;
declare variable COMIS_VEND_INTERNO double precision;
declare variable CODVENDEDOR_INTERNO integer;
declare variable MODIF_NOSSONUMERO varchar(100);
declare variable RESTA double precision;
declare variable COMISSAO_MODIFICADA char(1);
declare variable COD_CTRC integer;
declare variable CODTIPOPAG integer;
declare variable DATANET timestamp;
declare variable ATUALIZADATANET char(1);
declare variable NAOVERIFICARID char(1);
declare variable DTCANCELADA timestamp;
declare variable COD_CTRC_NFVENDA integer;
declare variable CODFECHAMENTOPDV integer;
declare variable CODEMPRESANET integer;
declare variable ATUALIZACODEMPRESANET char(1);
declare variable CODCAIXAOPRECEBIMENTO integer;
declare variable CONCILIADO char(1);
declare variable CODOSPEDIDO integer;
declare variable CONTABILIDADE_EXPORTA integer;
declare variable TAXAFINANCEIRA double precision;
declare variable OBSCAN1 varchar(100);
declare variable OBSCAN2 varchar(100);
declare variable CODCONTAMOTIVOCAN integer;
declare variable DT_VENCIM_PRORROGADO timestamp;
declare variable QTD_PRORROGACAO integer;
declare variable CODCONTRATO integer;
declare variable NSU_CARTAO varchar(20);
declare variable CODMODELO integer;
declare variable CODCST integer;
declare variable CODRECEITA varchar(2);
declare variable CODOPERACAO integer;
declare variable DT_CONTABIL timestamp;
declare variable CODCUPOM integer;
begin
  for select
    CRT.CODCONTA
  from
    CONTA_RENEGOCIACAO_TEMP CRT
  into
    LCODCONTARENEGOCIADO
  do
  begin
    select
      CODCONTA,
      STATUS,
      TIPO,
      DESCRICAO,
      NRDOCUMENTO,
      CODPESSOA,
      DT_EMISSAO,
      DT_VENCIM,
      PARCELA,
      PREV_TIPOPAG,
      VLPARCELA,
      VLTOTAL,
      CODCENTCUSTO,
      OBS1,
      OBS2,
      US_CADAST,
      DT_CADAST,
      US_MODIFI,
      DT_MODIFI,
      TOTDESCONTO,
      TOTJUROS,
      TOTPAGO,
      CODPENDVEND,
      CODNFENTRADA,
      CODNFVENDA,
      CODCARTAO,
      NRFORMULARIO,
      CODVENDEDOR,
      COMISCARTAO,
      CODNFSERVICO,
      VLRNEGOCIA,
      CODEMPRESA,
      COMISTIPOPAG,
      CODPEDCOMPRA,
      PERCJUROS,
      NRCARTAO,
      NUMERO,
      CART_PERC,
      CART_VALOR,
      CODTROCA,
      CODBANCO,
      CON_CODIGONFXBONIFICACAO,
      REF_FRETE,
      BOLETOIMPRESSO,
      CONT_CUSTAS,
      SERIENF,
      CODCONTABANCO,
      NRDOCUMENTO_DV,
      CODOBS,
      CODRATEIO,
      DESC_FINANCEIRO,
      CODSUPERVISOR,
      NRDOCUMENTO_BOLETO,
      NRBANCO,
      TAXABOLETO,
      CODTIPOLANCAMENTO,
      DIAS,
      COMIS_VEND_EXTERNO,
      COMIS_VEND_INTERNO,
      CODVENDEDOR_INTERNO,
      MODIF_NOSSONUMERO,
      RESTA,
      COMISSAO_MODIFICADA,
      COD_CTRC,
      CODTIPOPAG,
      DATANET,
      ATUALIZADATANET,
      NAOVERIFICARID,
      DTCANCELADA,
      COD_CTRC_NFVENDA,
      CODFECHAMENTOPDV,
      CODEMPRESANET,
      ATUALIZACODEMPRESANET,
      CODCAIXAOPRECEBIMENTO,
      CONCILIADO,
      CODOSPEDIDO,
      CONTABILIDADE_EXPORTA,
      TAXAFINANCEIRA,
      OBSCAN1,
      OBSCAN2,
      CODCONTAMOTIVOCAN,
      DT_VENCIM_PRORROGADO,
      QTD_PRORROGACAO,
      CODCONTRATO,
      NSU_CARTAO,
      CODMODELO,
      CODCST,
      CODRECEITA,
      CODOPERACAO,
      DT_CONTABIL,
      CODCUPOM
    from
      CONTA
    where
      CONTA.CODCONTA = :ECODCONTA
    into
      CODCONTA,
      STATUS,
      TIPO,
      DESCRICAO,
      NRDOCUMENTO,
      CODPESSOA,
      DT_EMISSAO,
      DT_VENCIM,
      PARCELA,
      PREV_TIPOPAG,
      VLPARCELA,
      VLTOTAL,
      CODCENTCUSTO,
      OBS1,
      OBS2,
      US_CADAST,
      DT_CADAST,
      US_MODIFI,
      DT_MODIFI,
      TOTDESCONTO,
      TOTJUROS,
      TOTPAGO,
      CODPENDVEND,
      CODNFENTRADA,
      CODNFVENDA,
      CODCARTAO,
      NRFORMULARIO,
      CODVENDEDOR,
      COMISCARTAO,
      CODNFSERVICO,
      VLRNEGOCIA,
      CODEMPRESA,
      COMISTIPOPAG,
      CODPEDCOMPRA,
      PERCJUROS,
      NRCARTAO,
      NUMERO,
      CART_PERC,
      CART_VALOR,
      CODTROCA,
      CODBANCO,
      CON_CODIGONFXBONIFICACAO,
      REF_FRETE,
      BOLETOIMPRESSO,
      CONT_CUSTAS,
      SERIENF,
      CODCONTABANCO,
      NRDOCUMENTO_DV,
      CODOBS,
      CODRATEIO,
      DESC_FINANCEIRO,
      CODSUPERVISOR,
      NRDOCUMENTO_BOLETO,
      NRBANCO,
      TAXABOLETO,
      CODTIPOLANCAMENTO,
      DIAS,
      COMIS_VEND_EXTERNO,
      COMIS_VEND_INTERNO,
      CODVENDEDOR_INTERNO,
      MODIF_NOSSONUMERO,
      RESTA,
      COMISSAO_MODIFICADA,
      COD_CTRC,
      CODTIPOPAG,
      DATANET,
      ATUALIZADATANET,
      NAOVERIFICARID,
      DTCANCELADA,
      COD_CTRC_NFVENDA,
      CODFECHAMENTOPDV,
      CODEMPRESANET,
      ATUALIZACODEMPRESANET,
      CODCAIXAOPRECEBIMENTO,
      CONCILIADO,
      CODOSPEDIDO,
      CONTABILIDADE_EXPORTA,
      TAXAFINANCEIRA,
      OBSCAN1,
      OBSCAN2,
      CODCONTAMOTIVOCAN,
      DT_VENCIM_PRORROGADO,
      QTD_PRORROGACAO,
      CODCONTRATO,
      NSU_CARTAO,
      CODMODELO,
      CODCST,
      CODRECEITA,
      CODOPERACAO,
      DT_CONTABIL,
      CODCUPOM;

      insert into
        CONTA_RENEGOCIADO (
          CODCONTAANTIGO,
          CODCONTANOVO,
          DATA)
      values (
        :CODCONTA,
        :LCODCONTARENEGOCIADO,
        current_timestamp);


  end
    insert into
      CONTA_RENEGOCIACAO (
        CODCONTA,
        STATUS,
        TIPO,
        DESCRICAO,
        NRDOCUMENTO,
        CODPESSOA,
        DT_EMISSAO,
        DT_VENCIM,
        PARCELA,
        PREV_TIPOPAG,
        VLPARCELA,
        VLTOTAL,
        CODCENTCUSTO,
        OBS1,
        OBS2,
        US_CADAST,
        DT_CADAST,
        US_MODIFI,
        DT_MODIFI,
        TOTDESCONTO,
        TOTJUROS,
        TOTPAGO,
        CODPENDVEND,
        CODNFENTRADA,
        CODNFVENDA,
        CODCARTAO,
        NRFORMULARIO,
        CODVENDEDOR,
        COMISCARTAO,
        CODNFSERVICO,
        VLRNEGOCIA,
        CODEMPRESA,
        COMISTIPOPAG,
        CODPEDCOMPRA,
        PERCJUROS,
        NRCARTAO,
        NUMERO,
        CART_PERC,
        CART_VALOR,
        CODTROCA,
        CODBANCO,
        CON_CODIGONFXBONIFICACAO,
        REF_FRETE,
        BOLETOIMPRESSO,
        CONT_CUSTAS,
        SERIENF,
        CODCONTABANCO,
        NRDOCUMENTO_DV,
        CODOBS,
        CODRATEIO,
        DESC_FINANCEIRO,
        CODSUPERVISOR,
        NRDOCUMENTO_BOLETO,
        NRBANCO,
        TAXABOLETO,
        CODTIPOLANCAMENTO,
        DIAS,
        COMIS_VEND_EXTERNO,
        COMIS_VEND_INTERNO,
        CODVENDEDOR_INTERNO,
        MODIF_NOSSONUMERO,
        RESTA,
        COMISSAO_MODIFICADA,
        COD_CTRC,
        CODTIPOPAG,
        DATANET,
        ATUALIZADATANET,
        NAOVERIFICARID,
        DTCANCELADA,
        COD_CTRC_NFVENDA,
        CODFECHAMENTOPDV,
        CODEMPRESANET,
        ATUALIZACODEMPRESANET,
        CODCAIXAOPRECEBIMENTO,
        CONCILIADO,
        CODOSPEDIDO,
        CONTABILIDADE_EXPORTA,
        TAXAFINANCEIRA,
        OBSCAN1,
        OBSCAN2,
        CODCONTAMOTIVOCAN,
        DT_VENCIM_PRORROGADO,
        QTD_PRORROGACAO,
        CODCONTRATO,
        NSU_CARTAO,
        CODMODELO,
        CODCST,
        CODRECEITA,
        CODOPERACAO,
        DT_CONTABIL,
        CODCUPOM)
    values (
      :CODCONTA,
      :STATUS,
      :TIPO,
      :DESCRICAO,
      :NRDOCUMENTO,
      :CODPESSOA,
      :DT_EMISSAO,
      :DT_VENCIM,
      :PARCELA,
      :PREV_TIPOPAG,
      :VLPARCELA,
      :VLTOTAL,
      :CODCENTCUSTO,
      :OBS1,
      :OBS2,
      :US_CADAST,
      :DT_CADAST,
      :US_MODIFI,
      :DT_MODIFI,
      :TOTDESCONTO,
      :TOTJUROS,
      :TOTPAGO,
      :CODPENDVEND,
      :CODNFENTRADA,
      :CODNFVENDA,
      :CODCARTAO,
      :NRFORMULARIO,
      :CODVENDEDOR,
      :COMISCARTAO,
      :CODNFSERVICO,
      :VLRNEGOCIA,
      :CODEMPRESA,
      :COMISTIPOPAG,
      :CODPEDCOMPRA,
      :PERCJUROS,
      :NRCARTAO,
      :NUMERO,
      :CART_PERC,
      :CART_VALOR,
      :CODTROCA,
      :CODBANCO,
      :CON_CODIGONFXBONIFICACAO,
      :REF_FRETE,
      :BOLETOIMPRESSO,
      :CONT_CUSTAS,
      :SERIENF,
      :CODCONTABANCO,
      :NRDOCUMENTO_DV,
      :CODOBS,
      :CODRATEIO,
      :DESC_FINANCEIRO,
      :CODSUPERVISOR,
      :NRDOCUMENTO_BOLETO,
      :NRBANCO,
      :TAXABOLETO,
      :CODTIPOLANCAMENTO,
      :DIAS,
      :COMIS_VEND_EXTERNO,
      :COMIS_VEND_INTERNO,
      :CODVENDEDOR_INTERNO,
      :MODIF_NOSSONUMERO,
      :RESTA,
      :COMISSAO_MODIFICADA,
      :COD_CTRC,
      :CODTIPOPAG,
      :DATANET,
      :ATUALIZADATANET,
      :NAOVERIFICARID,
      :DTCANCELADA,
      :COD_CTRC_NFVENDA,
      :CODFECHAMENTOPDV,
      :CODEMPRESANET,
      :ATUALIZACODEMPRESANET,
      :CODCAIXAOPRECEBIMENTO,
      :CONCILIADO,
      :CODOSPEDIDO,
      :CONTABILIDADE_EXPORTA,
      :TAXAFINANCEIRA,
      :OBSCAN1,
      :OBSCAN2,
      :CODCONTAMOTIVOCAN,
      :DT_VENCIM_PRORROGADO,
      :QTD_PRORROGACAO,
      :CODCONTRATO,
      :NSU_CARTAO,
      :CODMODELO,
      :CODCST,
      :CODRECEITA,
      :CODOPERACAO,
      :DT_CONTABIL,
      :CODCUPOM);
  exit;
end ^

-- Erros com FU_TRIM:

ALTER PROCEDURE FU_TRIM (WVAR VARCHAR(8192) CHARACTER SET ISO8859_1)
RETURNS (R_TRIM VARCHAR(8192) CHARACTER SET ISO8859_1)
AS 
begin
   /*
   RETIRA OS ESPAÇOS Ã€ DIREITA E A ESQUERDA  DE UM STRING
   */

  R_TRIM = TRIM(WVAR);
  suspend;
end ^

-- Erros de ambuguidade

ALTER PROCEDURE MANALISATITULOATRASADOFORMAGGIO (ECODPEDVEND INTEGER,
ECODANALISECRITERIO INTEGER)
RETURNS (APROVADO VARCHAR(1) CHARACTER SET ISO8859_1)
AS 
declare variable LMENSAGEM varchar(200);
declare variable LCODTIPOPAG integer;
declare variable LNRPRESTACAO integer;
declare variable LNRDIASPRIMEIRA integer;
declare variable LCODPESSOA integer;
declare variable LNRDOCUMENTO varchar(30);
declare variable LVLPARCELA double precision;
declare variable LDT_VENCIM date;
declare variable LVALORABERTO double precision;
begin
  /*ROTINA QUE VERIFICA SE EXISTE TÍTULOS EM ATRASO ESPECÍFICO FORMAGGIO*/
  APROVADO = 'S';
  select
    P.CODTIPOPAG
  from
    PEDVEND P
  where 
    P.CODPEDVEND = :ECODPEDVEND
  into
    LCODTIPOPAG;

  if (not exists(select CODIGO from PEDVEND_CRITICADOS where CODPEDVEND = :ECODPEDVEND and TIPO_CRITICA = :ECODANALISECRITERIO and USUARIO_LIBEROU is not null) and LCODTIPOPAG <> 3) then
  begin
    delete from
      PEDVEND_CRITICADOS
    where
      CODPEDVEND   = :ECODPEDVEND and
      TIPO_CRITICA = :ECODANALISECRITERIO;
    select
      T.NRPRESTACAO,
      T.NRDIASPRIMEIRA,
      P.CODPESSOA
    from
      PEDVEND P
      join TIPOPAG T on P.CODTIPOPAG = T.CODTIPOPAG
    where
      P.CODPEDVEND = :ECODPEDVEND
    into
      LNRPRESTACAO,
      LNRDIASPRIMEIRA,
      LCODPESSOA;

    for select
      NRDOCUMENTO,
      VLPARCELA,
      DT_VENCIM,
      C.VLPARCELA - coalesce(C.TOTPAGO, 0)
    from
      CONTA C
    where
      DT_VENCIM < 'TODAY' and
      STATUS    = 'ABERTO' and
      TIPO      = 'RECEBER' and
      CODPESSOA = :LCODPESSOA
    order by
      DT_VENCIM
    into
      LNRDOCUMENTO,
      LVLPARCELA,
      LDT_VENCIM,
      LVALORABERTO
    do
    begin
      APROVADO  = 'N';
      LMENSAGEM = 'TITULO VENCIDO EM ' || cast(cast('TODAY' as date) - LDT_VENCIM as integer) ||' DIAS, DOCUMENTO ' || :LNRDOCUMENTO || ', VALOR ' || cast(:LVLPARCELA as numeric(18, 2)) || ', ABERTO ' || cast(:LVALORABERTO as numeric(18, 2));

      execute procedure MINSERECRITICA(:ECODPEDVEND, :ECODANALISECRITERIO, :LMENSAGEM,0);
    end
  end
  suspend;
end ^

ALTER PROCEDURE MANALISA_FORMAGGIO_AVPRODUTO (ECODPEDVEND INTEGER,
ECODANALISECRITERIO INTEGER)
RETURNS (APROVADO VARCHAR(1) CHARACTER SET ISO8859_1)
AS 
declare variable LMENSAGEM varchar(200);
declare variable LVALOR_TOTAL double precision;
declare variable LVALOR_BRUTO double precision;
declare variable LFATORITEM double precision;
declare variable LCODPESQUISA varchar(30);
declare variable LPERCENTUAL double precision;
declare variable LCODPRODFILHO integer;
declare variable LLIMITEMINPEDIDO double precision;
declare variable LLIMITEMINNOTA double precision;
declare variable LTIPOPED varchar(10);
declare variable LLIMITE double precision;
begin
  /* ROTINA QUE VERIFICA O PERCENTUAL DE DESCONTO DEBUG CADA PRODUTO */
  APROVADO = 'S';
  if (not exists(select CODIGO from PEDVEND_CRITICADOS where CODPEDVEND = :ECODPEDVEND and TIPO_CRITICA = :ECODANALISECRITERIO and USUARIO_LIBEROU is not null)) then
  begin
    delete from
      PEDVEND_CRITICADOS
    where
      CODPEDVEND   = :ECODPEDVEND and
      TIPO_CRITICA = :ECODANALISECRITERIO;

    select
      P.TIPOPED,
      P.VALOR_BRUTO,
      P.VALOR_TOTAL,
      coalesce(T.LIMITEMINPEDIDO, 0),
      coalesce(T.LIMITEMINNOTA, 0)
    from
      PEDVEND P
      join TIPOPAG T on P.CODTIPOPAG = T.CODTIPOPAG
    where
      P.CODPEDVEND = :ECODPEDVEND
    into
      :LTIPOPED,
      :LVALOR_BRUTO,
      :LVALOR_TOTAL,
      :LLIMITEMINPEDIDO,
      :LLIMITEMINNOTA;

    if (LTIPOPED = 'VENDA') then
      LLIMITE = LLIMITEMINNOTA;
    else
      LLIMITE = LLIMITEMINPEDIDO;

    if (LVALOR_TOTAL < LLIMITE) then
    begin
      for select
        PEDVENDITEM.CODPRODFILHO,
        PEDVENDITEM.CODPESQUISA,
        PRECOVEND / coalesce(nullif(:LVALOR_BRUTO,0),1)
      from
        PEDVENDITEM
        join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
      where
        CODPEDVEND = :ECODPEDVEND and
        PEDVENDITEM.CODCOR is not null
      into
        LCODPRODFILHO,
        LCODPESQUISA,
        LFATORITEM
      do
      begin
        LPERCENTUAL =  cast(LFATORITEM * 100 as numeric(18,2));
        if (LPERCENTUAL >= 50.00) then
        begin
          APROVADO  = 'N';
          LMENSAGEM = 'O PRODUTO '||LCODPESQUISA||' ENCONTRA-SE COM O VALOR ACIMA DO PERMITIDO NA VENDA ( ' || cast(LPERCENTUAL as numeric(18,2)) || '%)';
          execute procedure MINSERECRITICA(:ECODPEDVEND, :ECODANALISECRITERIO, :LMENSAGEM, :LCODPRODFILHO);
        end
      end
    end
  end
  suspend;
end ^

ALTER PROCEDURE MSALDOPEDIDOREMESSAF_VENDEDOR (ECODVENDEDOR INTEGER)
RETURNS (CODPRODFILHO INTEGER,
CODPESQUISA VARCHAR(30) CHARACTER SET ISO8859_1,
DESCRICAO VARCHAR(60) CHARACTER SET ISO8859_1,
PRECOPROD DOUBLE PRECISION,
QTDREMESSA DOUBLE PRECISION,
QTDDEVOLUCAO DOUBLE PRECISION,
QTDVENDIDA DOUBLE PRECISION,
QTDSALDO DOUBLE PRECISION,
VALORREMESSA DOUBLE PRECISION,
VALORDEVOLUCAO DOUBLE PRECISION,
VALORVENDIDO DOUBLE PRECISION,
CODUNIDADE INTEGER,
IPIPERC DOUBLE PRECISION,
ICMSPERC DOUBLE PRECISION,
CUSTOMEDIO DOUBLE PRECISION,
CUSTOREPOSI DOUBLE PRECISION,
QTDEMBALAGEM DOUBLE PRECISION,
PRECOUSADO VARCHAR(10) CHARACTER SET ISO8859_1,
ALIQ_SUBS DOUBLE PRECISION,
PERC_VA DOUBLE PRECISION)
AS 
declare variable LNOTADEVONFVENDA smallint;
begin
  /* VERIFICO SE A NOTA FISCAL DE DEVOLUÇÃO FOI FEITA PELA TABELA NFVENDA */
  if (exists(select CODNFVENDA from NFVENDA where CODVENDEDOR = :ECODVENDEDOR and TIPONOTA = 'E')) then
    LNOTADEVONFVENDA = 1;
  else
    LNOTADEVONFVENDA = 0;

  for select
    PI.CODPRODFILHO,
    CODPESQUISA,
    DESCRICAO,
    PRECOPROD,
    QTDENTREGUE,
    PRECOVEND,
    PI.CODUNIDADE
  from
    PEDVENDITEM PI
    join PEDVEND P on PI.CODPEDVEND = P.CODPEDVEND
    join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  where
    P.CODVENDEDOR = :ECODVENDEDOR
  into
    :CODPRODFILHO,
    :CODPESQUISA,
    :DESCRICAO,
    :PRECOPROD,
    :QTDREMESSA,
    :VALORREMESSA,
    :CODUNIDADE
  do
  begin
    select
      IPIPERC,
      ICMSPERC,
      PI.CUSTOMEDIO,
      PI.CUSTOREPOSI,
      QTDEMBALAGEM,
      PI.PRECOUSADO,
      ALIQ_SUBS,
      PERC_VA
    from
      PEDVEND P
      join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
      join NFVENDAITEM NI on PI.CODPEDVENDITEM = NI.CODPEDVENDITEM
      join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
    where
      P.CODVENDEDOR   = :ECODVENDEDOR and
      NI.CODPRODFILHO = :CODPRODFILHO
    into
      :IPIPERC,
      :ICMSPERC,
      :CUSTOMEDIO,
      :CUSTOREPOSI,
      :QTDEMBALAGEM,
      :PRECOUSADO,
      :ALIQ_SUBS,
      :PERC_VA;

    /* LOCALIZO A QUANTIDADE DEVOLVIDA */
    if (LNOTADEVONFVENDA = 0) then
    begin
      select
        sum(QTD),
        sum(VALORTOTAL)
      from
        NFENTRADAITENS NEI
        join NFENTRADA NE on NEI.CODNFENTRADA = NE.CODNFENTRADA
        join NFVENDA NV on NE.CODNFVENDA = NV.CODNFVENDA and NE.NFV_TIPO = NV.NFV_TIPO and NE.SERIENFVENDA = NV.SERIE
      where
        NV.CODVENDEDOR   = :ECODVENDEDOR and
        NEI.CODPRODFILHO = :CODPRODFILHO
      into
        :QTDDEVOLUCAO,
        :VALORDEVOLUCAO;
    end
    else
    begin
      select
        sum(QTDE),
        sum(TOTALVLR)
      from
        NFVENDAITEM NI
        join NFVENDA N on NI.CODNFVENDA = N.CODNFVENDA and NI.NFV_TIPO = N.NFV_TIPO and NI.SERIE = N.SERIE
      where
        N.TIPONOTA    = 'E' and
        N.CODVENDEDOR = :ECODVENDEDOR and
        CODPRODFILHO  = :CODPRODFILHO
      into
        :QTDDEVOLUCAO,
        :VALORDEVOLUCAO;
    end

    /* LOCALIZO A QUANTIDADE VENDIDA FORA DO ESTABELECIMENTO */
    select
      sum(QTDENTREGUE),
      sum(PRECOVEND)
    from
      PEDVENDITEM PI
      join PEDVEND P on PI.CODPEDVEND = P.CODPEDVEND
    where
      P.CODVENDEDOR = :ECODVENDEDOR and
      PI.CODPRODFILHO     = :CODPRODFILHO and
      P.STATUSPED       <> 'CANCELADO'
    into
      :QTDVENDIDA,
      :VALORVENDIDO;
  
    VALORDEVOLUCAO = coalesce(VALORDEVOLUCAO, 0);
    VALORVENDIDO   = coalesce(VALORVENDIDO, 0);
    QTDVENDIDA     = coalesce(QTDVENDIDA, 0);
    QTDDEVOLUCAO   = coalesce(QTDDEVOLUCAO, 0);
    QTDSALDO       = QTDREMESSA - (QTDDEVOLUCAO + QTDVENDIDA);
    suspend;
  end
end ^

ALTER PROCEDURE R1106ACOMPANHAMENTOANUALVENDAS (ETODOSVENDEDORES INTEGER,
ECODVENDEDOR INTEGER,
EMES_INI INTEGER,
EANO_INI INTEGER,
TIPO_RETORNO INTEGER)
RETURNS (CODVENDEDOR INTEGER,
DT_CADAST TIMESTAMP,
VENDEDOR VARCHAR(60) CHARACTER SET ISO8859_1,
CODPESSOA INTEGER,
CLIENTE VARCHAR(60) CHARACTER SET ISO8859_1,
CODTIPOATV INTEGER,
TIPOATV VARCHAR(60) CHARACTER SET ISO8859_1,
BAIRRO VARCHAR(45) CHARACTER SET ISO8859_1,
MES1 DOUBLE PRECISION,
MES2 DOUBLE PRECISION,
MES3 DOUBLE PRECISION,
MES4 DOUBLE PRECISION,
MES5 DOUBLE PRECISION,
MES6 DOUBLE PRECISION,
MES7 DOUBLE PRECISION,
MES8 DOUBLE PRECISION,
MES9 DOUBLE PRECISION,
MES10 DOUBLE PRECISION,
MES11 DOUBLE PRECISION,
MES12 DOUBLE PRECISION,
CIDADE VARCHAR(45) CHARACTER SET ISO8859_1,
ATIVO SMALLINT,
LIMITECRED DOUBLE PRECISION,
CODTIPOPAG INTEGER,
TIP_TIPO VARCHAR(20) CHARACTER SET ISO8859_1,
DESCTIPOPAG VARCHAR(45) CHARACTER SET ISO8859_1,
OUTRAS_INF VARCHAR(255) CHARACTER SET ISO8859_1,
AREA VARCHAR(30) CHARACTER SET ISO8859_1,
CODAREA INTEGER)
AS 
declare variable CONT integer;
declare variable MES_ATU integer;
declare variable ANO_ATU integer;
declare variable VALOR integer;
begin
  select
    VALOR
  from
    MLERPARAMETROLOGICO('PROCURAR VENDEDOR PELO PEDIDO',0)
  into
    VALOR;

  if (VALOR = 0) then
  begin
    for select
      PESSOA.CODVENDEDOR,
      VENDEDOR.NOME as VENDEDOR,
      PESSOA.CODPESSOA,
      PESSOA.NOME,
      PESSOA.CODTIPOATV,
      coalesce(TBL_RAMOATVTIPO.DESCRICAO, 'NÃO DEFINIDO'),
      PESSOA.DT_CADAST,
      substring (PESSOA.BAIRRO_1 from 1 for 45) as BAIRRO_1,
      PESSOA.CIDADE_1,
      PESSOA.ATIVO,
      PESSOA.LIMITECRED,
      PESSOA.CODTIPOPAG1,
      PESSOA.TIP_TIPO,
      PESSOA.AREA,
      PESSOA.ARE_CODIGO
    from
      PESSOA
      join VENDEDOR on (VENDEDOR.CODVENDEDOR = PESSOA.CODVENDEDOR)
      left join TBL_RAMOATVTIPO on (PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO)
    where
      (PESSOA.CODVENDEDOR = :ECODVENDEDOR) or (:ETODOSVENDEDORES = 1)
    into
      CODVENDEDOR,
      VENDEDOR,
      CODPESSOA,
      CLIENTE,
      CODTIPOATV,
      TIPOATV,
      DT_CADAST,
      BAIRRO,
      CIDADE,
      ATIVO,
      LIMITECRED,
      CODTIPOPAG,
      TIP_TIPO,
      AREA,
      CODAREA
    do
    begin
      select
        DESCRICAO
      from
        TIPOPAG
      where
        CODTIPOPAG = :CODTIPOPAG
      into
        DESCTIPOPAG;

      CONT = 0;
      MES_ATU = EMES_INI;
      ANO_ATU = EANO_INI;
      
      if (TIPO_RETORNO = 0) then
      begin
      while (CONT < 12) do
          begin
            if (CONT = 0) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES1;
            end
            
            if (CONT = 1) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES2;
            end
            
            if (CONT = 2) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES3;
            end
            
            if (CONT = 3) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES4;
            end
            
            if (CONT = 4) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES5;
            end
            
            if (CONT = 5) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES6;
            end
            
            if (CONT = 6) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES7;
            end
            
            if (CONT = 7) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES8;
            end
            
            if (CONT = 8) then
            begin
              select
                sum(VALOR_TOTAL) from PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES9;
            end
            
            if (CONT = 9) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES10;
            end
            
            if (CONT = 10) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES11;
            end
            
            if (CONT = 11) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES12;
            end
          
            CONT = CONT + 1;
            MES_ATU = MES_ATU + 1;
          
            if (MES_ATU > 12) then
            begin
              MES_ATU = 1;
              ANO_ATU = ANO_ATU + 1;
            end
          end
      end
      else
      if (TIPO_RETORNO = 1) then
      begin
      while (CONT < 12) do
          begin
            if (CONT = 0) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES1;
            end
            
            if (CONT = 1) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES2;
            end
            
            if (CONT = 2) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES3;
            end
            
            if (CONT = 3) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES4;
            end
            
            if (CONT = 4) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES5;
            end
            
            if (CONT = 5) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES6;
            end
            
            if (CONT = 6) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES7;
            end
            
            if (CONT = 7) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES8;
            end
            
            if (CONT = 8) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES9;
            end
            
            if (CONT = 9) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES10;
            end
            
            if (CONT = 10) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES11;
            end
            
            if (CONT = 11) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES12;
            end
          
            CONT = CONT + 1;
            MES_ATU = MES_ATU + 1;
          
            if (MES_ATU > 12) then
            begin
              MES_ATU = 1;
              ANO_ATU = ANO_ATU + 1;
            end
          end
      end
      else
      begin
       while (CONT < 12) do
          begin
            if (CONT = 0) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES1;
            end
            
            if (CONT = 1) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES2;
            end
            
            if (CONT = 2) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES3;
            end
            
            if (CONT = 3) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES4;
            end
            
            if (CONT = 4) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES5;
            end
            
            if (CONT = 5) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES6;
            end
            
            if (CONT = 6) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES7;
            end
            
            if (CONT = 7) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES8;
            end
            
            if (CONT = 8) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES9;
            end
            
            if (CONT = 9) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES10;
            end
            
            if (CONT = 10) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES11;
            end
            
            if (CONT = 11) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES12;
            end
          
            CONT = CONT + 1;
            MES_ATU = MES_ATU + 1;
          
            if (MES_ATU > 12) then
            begin
              MES_ATU = 1;
              ANO_ATU = ANO_ATU + 1;
            end
          end
      end

      suspend;
    end
  end
  else
  begin
    for select
      distinct PESSOA.CODPESSOA,
      PEDVEND.CODVENDEDOR,
      VENDEDOR.NOME as VENDEDOR,
      PESSOA.NOME,
      PESSOA.CODTIPOATV,
      coalesce(TBL_RAMOATVTIPO.DESCRICAO, 'NÃO DEFINIDO'),
      PESSOA.DT_CADAST,
      substring (PESSOA.BAIRRO_1 from 1 for 45) as BAIRRO_1 ,
      PESSOA.CIDADE_1,
      PESSOA.ATIVO,
      PESSOA.LIMITECRED,
      PESSOA.CODTIPOPAG1,
      PESSOA.TIP_TIPO,
      PESSOA.AREA,
      PESSOA.ARE_CODIGO
    from
      PESSOA
      join PEDVEND on (PEDVEND.CODPESSOA  = PESSOA.CODPESSOA)
      join VENDEDOR on (VENDEDOR.CODVENDEDOR = PEDVEND.CODVENDEDOR)
      left join TBL_RAMOATVTIPO on (PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO)
    where
      (PEDVEND.CODVENDEDOR = :ECODVENDEDOR) or
      (:ETODOSVENDEDORES = 1)
    into
      CODPESSOA,
      CODVENDEDOR,
      VENDEDOR,
      CLIENTE,
      CODTIPOATV,
      TIPOATV,
      DT_CADAST,
      BAIRRO,
      CIDADE,
      ATIVO,
      LIMITECRED,
      CODTIPOPAG,
      TIP_TIPO,
      AREA,
      CODAREA
    do
    begin
      select
        DESCRICAO
      from
        TIPOPAG
      where
        CODTIPOPAG = :CODTIPOPAG
      into
        DESCTIPOPAG;

      OUTRAS_INF = CAST(COALESCE(LIMITECRED,0) AS NUMERIC(10,2)) || '-' || SUBSTRING(COALESCE(TIP_TIPO,'') FROM 1 FOR 3);


      OUTRAS_INF = OUTRAS_INF || '-' || SUBSTRING(COALESCE(DESCTIPOPAG,'') FROM 1 FOR 30);

      CONT = 0;
      MES_ATU = EMES_INI;
      ANO_ATU = EANO_INI;
      
      
      if (TIPO_RETORNO = 0) then
      begin
      while (CONT < 12) do
          begin
            if (CONT = 0) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES1;
            end
            
            if (CONT = 1) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES2;
            end
            
            if (CONT = 2) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES3;
            end
            
            if (CONT = 3) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES4;
            end
            
            if (CONT = 4) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES5;
            end
            
            if (CONT = 5) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES6;
            end
            
            if (CONT = 6) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES7;
            end
            
            if (CONT = 7) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES8;
            end
            
            if (CONT = 8) then
            begin
              select
                sum(VALOR_TOTAL) from PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES9;
            end
            
            if (CONT = 9) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES10;
            end
            
            if (CONT = 10) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES11;
            end
            
            if (CONT = 11) then
            begin
              select
                sum(VALOR_TOTAL)
              from
                PEDVEND
              where
                CODPESSOA = :CODPESSOA and
                CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES12;
            end
          
            CONT = CONT + 1;
            MES_ATU = MES_ATU + 1;
          
            if (MES_ATU > 12) then
            begin
              MES_ATU = 1;
              ANO_ATU = ANO_ATU + 1;
            end
          end
      end
      else
      if (TIPO_RETORNO = 1) then
      begin
      while (CONT < 12) do
          begin
            if (CONT = 0) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES1;
            end
            
            if (CONT = 1) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES2;
            end
            
            if (CONT = 2) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES3;
            end
            
            if (CONT = 3) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES4;
            end
            
            if (CONT = 4) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES5;
            end
            
            if (CONT = 5) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES6;
            end
            
            if (CONT = 6) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES7;
            end
            
            if (CONT = 7) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES8;
            end
            
            if (CONT = 8) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES9;
            end
            
            if (CONT = 9) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES10;
            end
            
            if (CONT = 10) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES11;
            end
            
            if (CONT = 11) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES12;
            end
          
            CONT = CONT + 1;
            MES_ATU = MES_ATU + 1;
          
            if (MES_ATU > 12) then
            begin
              MES_ATU = 1;
              ANO_ATU = ANO_ATU + 1;
            end
          end
      end
      else
      begin
       while (CONT < 12) do
          begin
            if (CONT = 0) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES1;
            end
            
            if (CONT = 1) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES2;
            end
            
            if (CONT = 2) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES3;
            end
            
            if (CONT = 3) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES4;
            end
            
            if (CONT = 4) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES5;
            end
            
            if (CONT = 5) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES6;
            end
            
            if (CONT = 6) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES7;
            end
            
            if (CONT = 7) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES8;
            end
            
            if (CONT = 8) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES9;
            end
            
            if (CONT = 9) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES10;
            end
            
            if (CONT = 10) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES11;
            end
            
            if (CONT = 11) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
              into
                MES12;
            end
          
            CONT = CONT + 1;
            MES_ATU = MES_ATU + 1;
          
            if (MES_ATU > 12) then
            begin
              MES_ATU = 1;
              ANO_ATU = ANO_ATU + 1;
            end
          end
      end

   end
  end
end ^

ALTER PROCEDURE R1106ACOMPANHAMENTOANUAL_GRUPO (ETODOSVENDEDORES INTEGER,
ECODVENDEDOR INTEGER,
EMES_INI INTEGER,
EANO_INI INTEGER,
TIPO_RETORNO INTEGER,
CODGRUPO INTEGER)
RETURNS (CODVENDEDOR INTEGER,
DT_CADAST TIMESTAMP,
VENDEDOR VARCHAR(60) CHARACTER SET ISO8859_1,
CODPESSOA INTEGER,
CLIENTE VARCHAR(60) CHARACTER SET ISO8859_1,
CODTIPOATV INTEGER,
TIPOATV VARCHAR(60) CHARACTER SET ISO8859_1,
BAIRRO VARCHAR(45) CHARACTER SET ISO8859_1,
MES1 DOUBLE PRECISION,
MES2 DOUBLE PRECISION,
MES3 DOUBLE PRECISION,
MES4 DOUBLE PRECISION,
MES5 DOUBLE PRECISION,
MES6 DOUBLE PRECISION,
MES7 DOUBLE PRECISION,
MES8 DOUBLE PRECISION,
MES9 DOUBLE PRECISION,
MES10 DOUBLE PRECISION,
MES11 DOUBLE PRECISION,
MES12 DOUBLE PRECISION,
CIDADE VARCHAR(45) CHARACTER SET ISO8859_1,
ATIVO SMALLINT,
LIMITECRED DOUBLE PRECISION,
CODTIPOPAG INTEGER,
TIP_TIPO VARCHAR(20) CHARACTER SET ISO8859_1,
DESCTIPOPAG VARCHAR(45) CHARACTER SET ISO8859_1,
OUTRAS_INF VARCHAR(255) CHARACTER SET ISO8859_1,
AREA VARCHAR(30) CHARACTER SET ISO8859_1,
CODAREA INTEGER)
AS 
declare variable CONT integer;
declare variable MES_ATU integer;
declare variable ANO_ATU integer;
declare variable VALOR integer;
begin

    for select
      PESSOA.CODVENDEDOR,
      VENDEDOR.NOME as VENDEDOR,
      PESSOA.CODPESSOA,
      PESSOA.NOME,
      PESSOA.CODTIPOATV,
      coalesce(TBL_RAMOATVTIPO.DESCRICAO, 'NÃO DEFINIDO'),
      PESSOA.DT_CADAST,
      substring (PESSOA.BAIRRO_1 from 1 for 45) as BAIRRO_1,
      PESSOA.CIDADE_1,
      PESSOA.ATIVO,
      PESSOA.LIMITECRED,
      PESSOA.CODTIPOPAG1,
      PESSOA.TIP_TIPO,
      PESSOA.AREA,
      PESSOA.ARE_CODIGO
    from
      PESSOA
      join VENDEDOR on (VENDEDOR.CODVENDEDOR = PESSOA.CODVENDEDOR)
      left join TBL_RAMOATVTIPO on (PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO)
    where
      (PESSOA.CODVENDEDOR = :ECODVENDEDOR) or (:ETODOSVENDEDORES = 1)
    into
      CODVENDEDOR,
      VENDEDOR,
      CODPESSOA,
      CLIENTE,
      CODTIPOATV,
      TIPOATV,
      DT_CADAST,
      BAIRRO,
      CIDADE,
      ATIVO,
      LIMITECRED,
      CODTIPOPAG,
      TIP_TIPO,
      AREA,
      CODAREA
    do
    begin
      select
        DESCRICAO
      from
        TIPOPAG
      where
        CODTIPOPAG = :CODTIPOPAG
      into
        DESCTIPOPAG;
      CONT = 0;
      MES_ATU = EMES_INI;
      ANO_ATU = EANO_INI;
      if (TIPO_RETORNO = 0) then
      begin
      while (CONT < 12) do
          begin
            if (CONT = 0) then
            begin
              select
                sum(PEDVENDITEM.PRECOVEND)
              from
                PEDVEND
              inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = PEDVEND.CODPEDVEND
              inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
              inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES1;
            end
            if (CONT = 1) then
            begin
               select
                sum(PEDVENDITEM.PRECOVEND)
              from
                PEDVEND
              inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = PEDVEND.CODPEDVEND
              inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
              inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES2;
            end
            if (CONT = 2) then
            begin
               select
                sum(PEDVENDITEM.PRECOVEND)
              from
                PEDVEND
              inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = PEDVEND.CODPEDVEND
              inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
              inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES3;
            end
            if (CONT = 3) then
            begin
               select
                sum(PEDVENDITEM.PRECOVEND)
              from
                PEDVEND
              inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = PEDVEND.CODPEDVEND
              inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
              inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES4;
            end
            if (CONT = 4) then
            begin
               select
                sum(PEDVENDITEM.PRECOVEND)
              from
                PEDVEND
              inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = PEDVEND.CODPEDVEND
              inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
              inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES5;
            end
            if (CONT = 5) then
            begin
               select
                sum(PEDVENDITEM.PRECOVEND)
              from
                PEDVEND
              inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = PEDVEND.CODPEDVEND
              inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
              inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES6;
            end
            if (CONT = 6) then
            begin
               select
                sum(PEDVENDITEM.PRECOVEND)
              from
                PEDVEND
              inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = PEDVEND.CODPEDVEND
              inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
              inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES7;
            end
            if (CONT = 7) then
            begin
               select
                sum(PEDVENDITEM.PRECOVEND)
              from
                PEDVEND
              inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = PEDVEND.CODPEDVEND
              inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
              inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES8;
            end
            if (CONT = 8) then
            begin
               select
                sum(PEDVENDITEM.PRECOVEND)
              from
                PEDVEND
              inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = PEDVEND.CODPEDVEND
              inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
              inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES9;
            end
            if (CONT = 9) then
            begin
               select
                sum(PEDVENDITEM.PRECOVEND)
              from
                PEDVEND
              inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = PEDVEND.CODPEDVEND
              inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
              inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES10;
            end
            if (CONT = 10) then
            begin
               select
                sum(PEDVENDITEM.PRECOVEND)
              from
                PEDVEND
              inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = PEDVEND.CODPEDVEND
              inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
              inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES11;
            end
            if (CONT = 11) then
            begin
              select
                sum(PEDVENDITEM.PRECOVEND)
              from
                PEDVEND
              inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = PEDVEND.CODPEDVEND
              inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
              inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES12;
            end
            CONT = CONT + 1;
            MES_ATU = MES_ATU + 1;
            if (MES_ATU > 12) then
            begin
              MES_ATU = 1;
              ANO_ATU = ANO_ATU + 1;
            end
          end
      end
      else
      if (TIPO_RETORNO = 1) then
      begin
      while (CONT < 12) do
          begin
            if (CONT = 0) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES1;
            end
            if (CONT = 1) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES2;
            end
            if (CONT = 2) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES3;
            end
            if (CONT = 3) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES4;
            end
            if (CONT = 4) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES5;
            end
            if (CONT = 5) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES6;
            end
            if (CONT = 6) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES7;
            end
            if (CONT = 7) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES8;
            end
            if (CONT = 8) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES9;
            end
            
            if (CONT = 9) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES10;
            end
            
            if (CONT = 10) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES11;
            end
            
            if (CONT = 11) then
            begin
              select
                sum(PEDVENDitem.QTDE)
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES12;
            end
          
            CONT = CONT + 1;
            MES_ATU = MES_ATU + 1;
          
            if (MES_ATU > 12) then
            begin
              MES_ATU = 1;
              ANO_ATU = ANO_ATU + 1;
            end
          end
      end
      else
      begin
       while (CONT < 12) do
          begin
            if (CONT = 0) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES1;
            end
            
            if (CONT = 1) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES2;
            end
            
            if (CONT = 2) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES3;
            end
            
            if (CONT = 3) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES4;
            end
            
            if (CONT = 4) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES5;
            end
            
            if (CONT = 5) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES6;
            end
            
            if (CONT = 6) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES7;
            end
            
            if (CONT = 7) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES8;
            end
            
            if (CONT = 8) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES9;
            end
            
            if (CONT = 9) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES10;
            end
            
            if (CONT = 10) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES11;
            end
            
            if (CONT = 11) then
            begin
              select
                sum(PEDVENDitem.QTDE * coalesce(PRODFILHO.FATORCONVERSAO,1))
              from
                PEDVEND
                inner join PEDVENDITEM on PEDVENDITEM.CODPEDVEND = pedvend.CODPEDVEND
                inner join PRODFILHO on PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
                inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
              where
                CODPESSOA = :CODPESSOA and
                PEDVEND.CODVENDEDOR = :CODVENDEDOR and
                extract (month from DT_SAIDA) = :MES_ATU and
                extract (year from DT_SAIDA) = :ANO_ATU and
                PEDVEND.STATUSPED <> 'CANCELADO' and PEDVEND.TIPOPED in ('VENDA','CADERNO')
                and PRODUTO.CODGRUPO = :CODGRUPO
              into
                MES12;
            end
          
            CONT = CONT + 1;
            MES_ATU = MES_ATU + 1;
          
            if (MES_ATU > 12) then
            begin
              MES_ATU = 1;
              ANO_ATU = ANO_ATU + 1;
            end
          end
      end

      suspend;
    end
end ^

ALTER PROCEDURE R178VENDASPORPRODUTO (EDTINI TIMESTAMP,
EDTFIM TIMESTAMP,
EFILTROVENDEDOR INTEGER,
STATUSPED VARCHAR(20) CHARACTER SET ISO8859_1,
ETIPOPED VARCHAR(20) CHARACTER SET ISO8859_1)
RETURNS (CODPRODFILHO INTEGER,
CODFABRICANTE INTEGER,
NOME_FABRICANTE VARCHAR(80) CHARACTER SET ISO8859_1,
CODVENDEDOR INTEGER,
QTD_TOTAL DOUBLE PRECISION,
VALOR_TOTAL DOUBLE PRECISION,
LITROS DOUBLE PRECISION,
CUSTOMEDIO DOUBLE PRECISION,
MARGEM DOUBLE PRECISION,
NOME_VENDEDOR VARCHAR(80) CHARACTER SET ISO8859_1,
CODGRUPO INTEGER,
NOME_GRUPO VARCHAR(80) CHARACTER SET ISO8859_1,
TIPOPED VARCHAR(20) CHARACTER SET ISO8859_1,
DESC_PRODUTO VARCHAR(80) CHARACTER SET ISO8859_1,
CODPESQ1 VARCHAR(30) CHARACTER SET ISO8859_1,
CODSUBGRUPO INTEGER,
NOME_SUBGRUPO VARCHAR(60) CHARACTER SET ISO8859_1,
TOTITEM_TIPOFAT DOUBLE PRECISION,
MARGEM_TIPOFAT DOUBLE PRECISION,
CUSTOREPOSI2 DOUBLE PRECISION)
AS 
BEGIN
IF (EFILTROVENDEDOR <> 0) THEN BEGIN
    IF (STATUSPED <> '') THEN BEGIN
        IF (ETIPOPED <> '') THEN BEGIN
            FOR
                SELECT SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)) AS TOTITEM, SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PED.PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)) AS TOTITEM_TIPOFAT, SUM(PI.QTDE) AS QTDE, SUM(PI.QTDE * PF.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)))) * 100 AS MARGEM,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)))) * 100 AS MARGEM_TIPOFAT,
                       PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME, PED.CODVENDEDOR,
                       SG.CODSUBGRUPO, SG.DESCRICAO, PED.TIPOPED, SUM(PI.QTDE* PI.CUSTOREPOSI2) AS CUSTOMEDIO
                FROM PEDVENDITEM PI
                INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
                INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
                INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
                INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
                INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
                INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
                WHERE PED.STATUSPED <> 'CANCELADO' AND PED.STATUSPED = :STATUSPED AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.TIPOPED = :ETIPOPED
                GROUP BY 8,9,10,11,12,13,14,15,16,17,18
                INTO
                 :VALOR_TOTAL,
                 :totitem_tipofat,
                 :QTD_TOTAL,
                 :LITROS,
                 :CUSTOMEDIO,
                 :MARGEM,
                 :MARGEM_TIPOFAT,
                 :CODPRODFILHO,
                 :CODPESQ1,
                 :DESC_PRODUTO,
                 :CODGRUPO,
                 :NOME_GRUPO,
                 :CODFABRICANTE,
                 :NOME_FABRICANTE,
                 :CODVENDEDOR,
                 :CODSUBGRUPO,
                 :NOME_SUBGRUPO,
                 :TIPOPED,
                 :CUSTOREPOSI2
            DO
            BEGIN
               SELECT NOME FROM VENDEDOR WHERE CODVENDEDOR = :CODVENDEDOR INTO :NOME_VENDEDOR;
               if (TIPOPED = 'BONIFICA') then
               begin
                  VALOR_TOTAL = 0.0000001;
                  SUSPEND;
               end
               else
               begin
                   if (VALOR_TOTAL > 0) then
                      SUSPEND;
               end
               SUSPEND;
            END
        END
        ELSE
        BEGIN
            FOR
                SELECT SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)) AS TOTITEM, SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PED.PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)) AS TOTITEM_TIPOFAT, SUM(PI.QTDE) AS QTDE, SUM(PI.QTDE * PF.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)))) * 100 AS MARGEM,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)))) * 100 AS MARGEM_TIPOFAT,
                       PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME, PED.CODVENDEDOR,
                       SG.CODSUBGRUPO, SG.DESCRICAO, PED.TIPOPED, SUM(PI.QTDE* PI.CUSTOREPOSI2) AS CUSTOMEDIO
                FROM PEDVENDITEM PI
                INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
                INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
                INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
                INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
                INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
                INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
                WHERE PED.STATUSPED <> 'CANCELADO' AND PED.STATUSPED = :STATUSPED AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM
                GROUP BY 8,9,10,11,12,13,14,15,16,17,18
                INTO
                 :VALOR_TOTAL,
                 :totitem_tipofat,
                 :QTD_TOTAL,
                 :LITROS,
                 :CUSTOMEDIO,
                 :MARGEM,
                 :margem_tipofat, 
                 :CODPRODFILHO,
                 :CODPESQ1,
                 :DESC_PRODUTO,
                 :CODGRUPO,
                 :NOME_GRUPO,
                 :CODFABRICANTE,
                 :NOME_FABRICANTE,
                 :CODVENDEDOR,
                 :CODSUBGRUPO,
                 :NOME_SUBGRUPO,
                 :TIPOPED,
                 :CUSTOREPOSI2
            DO
            BEGIN
               SELECT NOME FROM VENDEDOR WHERE CODVENDEDOR = :CODVENDEDOR INTO :NOME_VENDEDOR;
               SUSPEND;
            END
        END
     END
     ELSE
     BEGIN
        IF (ETIPOPED <> '') THEN BEGIN
             FOR
                SELECT SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)) AS TOTITEM, SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)  * (CAST(PED.PDV_TIPOFATURAMENTO AS FLOAT) / 100)) AS TOTITEM_TIPOFAT,  SUM(PI.QTDE) AS QTDE, SUM(PI.QTDE * PF.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)))) * 100 AS MARGEM,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)))) * 100 AS MARGEM_TIPOFAT,
                       PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME, PED.CODVENDEDOR,
                       SG.CODSUBGRUPO, SG.DESCRICAO, PED.TIPOPED, SUM(PI.QTDE* PI.CUSTOREPOSI2) AS CUSTOMEDIO
                FROM PEDVENDITEM PI
                INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
                INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
                INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
                INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
                INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
                INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
                WHERE PED.STATUSPED <> 'CANCELADO' AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.TIPOPED = :ETIPOPED
                GROUP BY 8,9,10,11,12,13,14,15,16,17,18
                INTO
                 :VALOR_TOTAL,
                 :totitem_tipofat,
                 :QTD_TOTAL,
                 :LITROS,
                 :CUSTOMEDIO,
                 :MARGEM,
                 :MARGEM_TIPOFAT,
                 :CODPRODFILHO,
                 :CODPESQ1,
                 :DESC_PRODUTO,
                 :CODGRUPO,
                 :NOME_GRUPO,
                 :CODFABRICANTE,
                 :NOME_FABRICANTE,
                 :CODVENDEDOR,
                 :CODSUBGRUPO,
                 :NOME_SUBGRUPO,
                 :TIPOPED,
                 :CUSTOREPOSI2
            DO
            BEGIN
               SELECT NOME FROM VENDEDOR WHERE CODVENDEDOR = :CODVENDEDOR INTO :NOME_VENDEDOR;
               SUSPEND;
            END
        END
        ELSE
        BEGIN
             FOR
                SELECT SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)) AS TOTITEM, SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PED.PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)) AS TOTITEM_TIPOFAT,  SUM(PI.QTDE) AS QTDE, SUM(PI.QTDE * PF.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)))) * 100 AS MARGEM,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)))) * 100 AS MARGEM_TIPOFAT,
                       PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME, PED.CODVENDEDOR,
                       SG.CODSUBGRUPO, SG.DESCRICAO, PED.TIPOPED, SUM(PI.QTDE* PI.CUSTOREPOSI2) AS CUSTOMEDIO
                FROM PEDVENDITEM PI
                INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
                INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
                INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
                INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
                INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
                INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
                WHERE PED.STATUSPED <> 'CANCELADO' AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM
                GROUP BY 8,9,10,11,12,13,14,15,16,17,18
                INTO
                 :VALOR_TOTAL,
                 :totitem_tipofat,
                 :QTD_TOTAL,
                 :LITROS,
                 :CUSTOMEDIO,
                 :MARGEM,
                 :MARGEM_TIPOFAT,
                 :CODPRODFILHO,
                 :CODPESQ1,
                 :DESC_PRODUTO,
                 :CODGRUPO,
                 :NOME_GRUPO,
                 :CODFABRICANTE,
                 :NOME_FABRICANTE,
                 :CODVENDEDOR,
                 :CODSUBGRUPO,
                 :NOME_SUBGRUPO,
                 :TIPOPED,
                 :CUSTOREPOSI2
            DO
            BEGIN
               SELECT NOME FROM VENDEDOR WHERE CODVENDEDOR = :CODVENDEDOR INTO :NOME_VENDEDOR;
               SUSPEND;
            END
        END
     END
END
ELSE
BEGIN
  IF (STATUSPED <> '') THEN BEGIN
      IF (ETIPOPED <> '') THEN BEGIN
          FOR
            SELECT SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)) AS TOTITEM, SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PED.PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)) AS TOTITEM_TIPOFAT,  SUM(PI.QTDE) AS QTDE, SUM(PI.QTDE * PF.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)))) * 100 AS MARGEM,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)))) * 100 AS MARGEM_TIPOFAT,
                   PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME,
                   SG.CODSUBGRUPO, SG.DESCRICAO, PED.TIPOPED, SUM(PI.QTDE* PI.CUSTOREPOSI2) AS CUSTOMEDIO
            FROM PEDVENDITEM PI
            INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
            INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
            INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
            INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
            INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
            INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
            WHERE PED.STATUSPED <> 'CANCELADO' AND PED.STATUSPED = :STATUSPED AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.TIPOPED = :ETIPOPED
            GROUP BY 8,9,10,11,12,13,14,15,16,17
            INTO
             :VALOR_TOTAL,
             :totitem_tipofat,
             :QTD_TOTAL,
             :LITROS,
             :CUSTOMEDIO,
             :MARGEM,
             :MARGEM_TIPOFAT,
             :CODPRODFILHO,
             :CODPESQ1,
             :DESC_PRODUTO,
             :CODGRUPO,
             :NOME_GRUPO,
             :CODFABRICANTE,
             :NOME_FABRICANTE,
             :CODSUBGRUPO,
             :NOME_SUBGRUPO,
             :TIPOPED,
             :CUSTOREPOSI2
        DO
        BEGIN
           CODVENDEDOR = 0;
           NOME_VENDEDOR = 'TODOS OS VENDEDORES';
           SUSPEND;
        END
      END
      ELSE
      BEGIN
          FOR
            SELECT SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)) AS TOTITEM, SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PED.PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)) AS TOTITEM_TIPOFAT,  SUM(PI.QTDE) AS QTDE, SUM(PI.QTDE * PF.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)))) * 100 AS MARGEM,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)))) * 100 AS MARGEM_TIPOFAT,
                   PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME,
                   SG.CODSUBGRUPO, SG.DESCRICAO, PED.TIPOPED, SUM(PI.QTDE* PI.CUSTOREPOSI2) AS CUSTOMEDIO
            FROM PEDVENDITEM PI
            INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
            INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
            INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
            INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
            INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
            INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
            WHERE PED.STATUSPED <> 'CANCELADO' AND PED.STATUSPED = :STATUSPED AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM
            GROUP BY 8,9,10,11,12,13,14,15,16,17
            INTO
             :VALOR_TOTAL,
             :totitem_tipofat,
             :QTD_TOTAL,
             :LITROS,
             :CUSTOMEDIO,
             :MARGEM,
             :MARGEM_TIPOFAT,
             :CODPRODFILHO,
             :CODPESQ1,
             :DESC_PRODUTO,
             :CODGRUPO,
             :NOME_GRUPO,
             :CODFABRICANTE,
             :NOME_FABRICANTE,
             :CODSUBGRUPO,
             :NOME_SUBGRUPO,
             :TIPOPED,
             :CUSTOREPOSI2
        DO
        BEGIN
           CODVENDEDOR = 0;
           NOME_VENDEDOR = 'TODOS OS VENDEDORES';
           SUSPEND;
        END
      END
  END
  ELSE BEGIN
      IF (ETIPOPED <> '') THEN BEGIN
          FOR
            SELECT SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)) AS TOTITEM, SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PED.PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)) AS TOTITEM_TIPOFAT,  SUM(PI.QTDE) AS QTDE, SUM(PI.QTDE * PF.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)))) * 100 AS MARGEM,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)))) * 100 AS MARGEM_TIPOFAT,
                   PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME,
                   SG.CODSUBGRUPO, SG.DESCRICAO, PED.TIPOPED, SUM(PI.QTDE* PI.CUSTOREPOSI2) AS CUSTOMEDIO
            FROM PEDVENDITEM PI
            INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
            INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
            INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
            INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
            INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
            INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
            WHERE PED.STATUSPED <> 'CANCELADO' AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.TIPOPED = :ETIPOPED
            GROUP BY 8,9,10,11,12,13,14,15,16,17
            INTO
             :VALOR_TOTAL,
             :totitem_tipofat,
             :QTD_TOTAL,
             :LITROS,
             :CUSTOMEDIO,
             :MARGEM,
             :MARGEM_TIPOFAT,
             :CODPRODFILHO,
             :CODPESQ1,
             :DESC_PRODUTO,
             :CODGRUPO,
             :NOME_GRUPO,
             :CODFABRICANTE,
             :NOME_FABRICANTE,
             :CODSUBGRUPO,
             :NOME_SUBGRUPO,
             :TIPOPED,
             :CUSTOREPOSI2
        DO
        BEGIN
           CODVENDEDOR = 0;
           NOME_VENDEDOR = 'TODOS OS VENDEDORES';
           SUSPEND;
        END
      END
      ELSE
      BEGIN
          FOR
            SELECT SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)) AS TOTITEM, SUM(COALESCE(NULLIF(PI.PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PED.PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)) AS TOTITEM_TIPOFAT,  SUM(PI.QTDE) AS QTDE, SUM(PI.QTDE * PF.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)))) * 100 AS MARGEM,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(COALESCE(NULLIF(PRECOVEND,0),1)  * (CAST(COALESCE(NULLIF(PDV_TIPOFATURAMENTO,0),1) AS FLOAT) / 100)))) * 100 AS MARGEM_TIPOFAT,
                   PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME,
                   SG.CODSUBGRUPO, SG.DESCRICAO, PED.TIPOPED, SUM(PI.QTDE* PI.CUSTOREPOSI2) AS CUSTOMEDIO
            FROM PEDVENDITEM PI
            INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
            INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
            INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
            INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
            INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
            INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
            WHERE PED.STATUSPED <> 'CANCELADO' AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM
            GROUP BY 8,9,10,11,12,13,14,15,16,17
            INTO
             :VALOR_TOTAL,
             :totitem_tipofat,
             :QTD_TOTAL,
             :LITROS,
             :CUSTOMEDIO,
             :MARGEM,
             :MARGEM_TIPOFAT,
             :CODPRODFILHO,
             :CODPESQ1,
             :DESC_PRODUTO,
             :CODGRUPO,
             :NOME_GRUPO,
             :CODFABRICANTE,
             :NOME_FABRICANTE,
             :CODSUBGRUPO,
             :NOME_SUBGRUPO,
             :TIPOPED,
             :CUSTOREPOSI2
        DO
        BEGIN
           CODVENDEDOR = 0;
           NOME_VENDEDOR = 'TODOS OS VENDEDORES';
           SUSPEND;
        END
      END
        
  END
END
END ^

ALTER PROCEDURE R179VENDASPORPRODUTO_COMISSAO (EDTINI TIMESTAMP,
EDTFIM TIMESTAMP,
EFILTROVENDEDOR INTEGER,
STATUSPED VARCHAR(20) CHARACTER SET ISO8859_1,
ETIPOPED VARCHAR(20) CHARACTER SET ISO8859_1)
RETURNS (CODPRODFILHO INTEGER,
CODFABRICANTE INTEGER,
NOME_FABRICANTE VARCHAR(80) CHARACTER SET ISO8859_1,
CODVENDEDOR INTEGER,
QTD_TOTAL DOUBLE PRECISION,
VALOR_TOTAL DOUBLE PRECISION,
LITROS DOUBLE PRECISION,
CUSTOMEDIO DOUBLE PRECISION,
MARGEM DOUBLE PRECISION,
NOME_VENDEDOR VARCHAR(80) CHARACTER SET ISO8859_1,
CODGRUPO INTEGER,
NOME_GRUPO VARCHAR(80) CHARACTER SET ISO8859_1,
TIPOPED VARCHAR(20) CHARACTER SET ISO8859_1,
DESC_PRODUTO VARCHAR(80) CHARACTER SET ISO8859_1,
CODPESQ1 VARCHAR(30) CHARACTER SET ISO8859_1,
CODSUBGRUPO INTEGER,
NOME_SUBGRUPO VARCHAR(60) CHARACTER SET ISO8859_1,
PERC_COMISSAO DOUBLE PRECISION,
VALOR_COMISSAO DOUBLE PRECISION,
TIPO_COMISSAO VARCHAR(200) CHARACTER SET ISO8859_1)
AS 
begin
TIPO_COMISSAO = 'COMISSÃO PADRÃO';
if (EFILTROVENDEDOR <> 0) then begin
    if (STATUSPED <> '') then begin
        if (ETIPOPED <> '') then begin
            FOR
                SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                       PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME, PED.CODVENDEDOR,
                       SG.CODSUBGRUPO, SG.DESCRICAO,
                       PI.ALIQCOMISSAO
                FROM PEDVENDITEM PI
                INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
                INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
                INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
                INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
                INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
                INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
                WHERE PED.STATUSPED <> 'CANCELADO' AND PED.STATUSPED = :STATUSPED AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.TIPOPED = :ETIPOPED AND PED.PERCOMISS = 0
                GROUP BY 6,7,8,9,10,11,12,13,14,15,16
                INTO
                 :VALOR_TOTAL,
                 :QTD_TOTAL,
                 :LITROS,
                 :CUSTOMEDIO,
                 :MARGEM,
                 :CODPRODFILHO,
                 :CODPESQ1,
                 :DESC_PRODUTO,
                 :CODGRUPO,
                 :NOME_GRUPO,
                 :CODFABRICANTE,
                 :NOME_FABRICANTE,
                 :CODVENDEDOR,
                 :CODSUBGRUPO,
                 :NOME_SUBGRUPO,
                 :PERC_COMISSAO
            DO
            BEGIN
               VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
               SELECT NOME FROM VENDEDOR WHERE CODVENDEDOR = :CODVENDEDOR INTO :NOME_VENDEDOR;
               SUSPEND;
            END
        END
        ELSE
        BEGIN
            FOR
                SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                       PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME, PED.CODVENDEDOR,
                       SG.CODSUBGRUPO, SG.DESCRICAO,
                       PI.ALIQCOMISSAO
                FROM PEDVENDITEM PI
                INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
                INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
                INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
                INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
                INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
                INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
                WHERE PED.STATUSPED <> 'CANCELADO' AND PED.STATUSPED = :STATUSPED AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.PERCOMISS = 0
                GROUP BY 6,7,8,9,10,11,12,13,14,15,16
                INTO
                 :VALOR_TOTAL,
                 :QTD_TOTAL,
                 :LITROS,
                 :CUSTOMEDIO,
                 :MARGEM,
                 :CODPRODFILHO,
                 :CODPESQ1,
                 :DESC_PRODUTO,
                 :CODGRUPO,
                 :NOME_GRUPO,
                 :CODFABRICANTE,
                 :NOME_FABRICANTE,
                 :CODVENDEDOR,
                 :CODSUBGRUPO,
                 :NOME_SUBGRUPO,
                 :PERC_COMISSAO
            DO
            BEGIN
               VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
               SELECT NOME FROM VENDEDOR WHERE CODVENDEDOR = :CODVENDEDOR INTO :NOME_VENDEDOR;
               SUSPEND;
            END
        END
     END
     ELSE
     BEGIN
        if (ETIPOPED <> '') then begin
             FOR
                SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                       PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME, PED.CODVENDEDOR,
                       SG.CODSUBGRUPO, SG.DESCRICAO,
                       PI.ALIQCOMISSAO
                FROM PEDVENDITEM PI
                INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
                INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
                INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
                INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
                INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
                INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
                WHERE PED.STATUSPED <> 'CANCELADO' AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.TIPOPED = :ETIPOPED AND PED.PERCOMISS = 0
                GROUP BY 6,7,8,9,10,11,12,13,14,15,16
                INTO
                 :VALOR_TOTAL,
                 :QTD_TOTAL,
                 :LITROS,
                 :CUSTOMEDIO,
                 :MARGEM,
                 :CODPRODFILHO,
                 :CODPESQ1,
                 :DESC_PRODUTO,
                 :CODGRUPO,
                 :NOME_GRUPO,
                 :CODFABRICANTE,
                 :NOME_FABRICANTE,
                 :CODVENDEDOR,
                 :CODSUBGRUPO,
                 :NOME_SUBGRUPO,
                 :PERC_COMISSAO
            DO
            BEGIN
               VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
               SELECT NOME FROM VENDEDOR WHERE CODVENDEDOR = :CODVENDEDOR INTO :NOME_VENDEDOR;
               SUSPEND;
            END
        END
        ELSE
        BEGIN
             FOR
                SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                       PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME, PED.CODVENDEDOR,
                       SG.CODSUBGRUPO, SG.DESCRICAO,
                       PI.ALIQCOMISSAO
                FROM PEDVENDITEM PI
                INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
                INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
                INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
                INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
                INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
                INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
                WHERE PED.STATUSPED <> 'CANCELADO' AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.PERCOMISS = 0
                GROUP BY 6,7,8,9,10,11,12,13,14,15,16
                INTO
                 :VALOR_TOTAL,
                 :QTD_TOTAL,
                 :LITROS,
                 :CUSTOMEDIO,
                 :MARGEM,
                 :CODPRODFILHO,
                 :CODPESQ1,
                 :DESC_PRODUTO,
                 :CODGRUPO,
                 :NOME_GRUPO,
                 :CODFABRICANTE,
                 :NOME_FABRICANTE,
                 :CODVENDEDOR,
                 :CODSUBGRUPO,
                 :NOME_SUBGRUPO,
                 :PERC_COMISSAO
            DO
            BEGIN
               VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
               SELECT NOME FROM VENDEDOR WHERE CODVENDEDOR = :CODVENDEDOR INTO :NOME_VENDEDOR;
               SUSPEND;
            END
        END
     END
END
ELSE
BEGIN
  if (STATUSPED <> '') then begin
      if (ETIPOPED <> '') then begin
          FOR
            SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
             (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                   PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME,
                   SG.CODSUBGRUPO, SG.DESCRICAO,
                   PI.ALIQCOMISSAO
            FROM PEDVENDITEM PI
            INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
            INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
            INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
            INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
            INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
            INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
            WHERE PED.STATUSPED <> 'CANCELADO' AND PED.STATUSPED = :STATUSPED AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.TIPOPED = :ETIPOPED AND PED.PERCOMISS = 0
            GROUP BY 6,7,8,9,10,11,12,13,14,15
            INTO
             :VALOR_TOTAL,
             :QTD_TOTAL,
             :LITROS,
             :CUSTOMEDIO,
             :MARGEM,
             :CODPRODFILHO,
             :CODPESQ1,
             :DESC_PRODUTO,
             :CODGRUPO,
             :NOME_GRUPO,
             :CODFABRICANTE,
             :NOME_FABRICANTE,
             :CODSUBGRUPO,
             :NOME_SUBGRUPO,
             :PERC_COMISSAO
        DO
        BEGIN
           VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
           CODVENDEDOR = 0;
           NOME_VENDEDOR = 'TODOS OS VENDEDORES';
           SUSPEND;
        END
      END
      ELSE
      BEGIN
          FOR
            SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
             (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                   PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME,
                   SG.CODSUBGRUPO, SG.DESCRICAO,
                   PI.ALIQCOMISSAO
            FROM PEDVENDITEM PI
            INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
            INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
            INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
            INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
            INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
            INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
            WHERE PED.STATUSPED <> 'CANCELADO' AND PED.STATUSPED = :STATUSPED AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.PERCOMISS = 0
            GROUP BY 6,7,8,9,10,11,12,13,14,15
            INTO
             :VALOR_TOTAL,
             :QTD_TOTAL,
             :LITROS,
             :CUSTOMEDIO,
             :MARGEM,
             :CODPRODFILHO,
             :CODPESQ1,
             :DESC_PRODUTO,
             :CODGRUPO,
             :NOME_GRUPO,
             :CODFABRICANTE,
             :NOME_FABRICANTE,
             :CODSUBGRUPO,
             :NOME_SUBGRUPO,
             :PERC_COMISSAO
        DO
        BEGIN
           VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
           CODVENDEDOR = 0;
           NOME_VENDEDOR = 'TODOS OS VENDEDORES';
           SUSPEND;
        END
      END
  END
  ELSE BEGIN
      if (ETIPOPED <> '') then begin
          FOR
            SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
             (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                   PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME,
                   SG.CODSUBGRUPO, SG.DESCRICAO,
                   PI.ALIQCOMISSAO
            FROM PEDVENDITEM PI
            INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
            INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
            INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
            INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
            INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
            INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
            WHERE PED.STATUSPED <> 'CANCELADO' AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.TIPOPED = :ETIPOPED AND PED.PERCOMISS = 0
            GROUP BY 6,7,8,9,10,11,12,13,14,15
            INTO
             :VALOR_TOTAL,
             :QTD_TOTAL,
             :LITROS,
             :CUSTOMEDIO,
             :MARGEM,
             :CODPRODFILHO,
             :CODPESQ1,
             :DESC_PRODUTO,
             :CODGRUPO,
             :NOME_GRUPO,
             :CODFABRICANTE,
             :NOME_FABRICANTE,
             :CODSUBGRUPO,
             :NOME_SUBGRUPO,
             :PERC_COMISSAO
        DO
        BEGIN
           VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
           CODVENDEDOR = 0;
           NOME_VENDEDOR = 'TODOS OS VENDEDORES';
           SUSPEND;
        END
      END
      ELSE
      BEGIN
          FOR
            SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
             (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                   PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PD.CODFABRICANTE, PE.NOME,
                   SG.CODSUBGRUPO, SG.DESCRICAO,
                   PI.ALIQCOMISSAO
            FROM PEDVENDITEM PI
            INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
            INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
            INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
            INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
            INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
            INNER JOIN PESSOA PE ON (PE.CODPESSOA = PD.CODFABRICANTE)
            WHERE PED.STATUSPED <> 'CANCELADO' AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.PERCOMISS = 0
            GROUP BY 6,7,8,9,10,11,12,13,14,15
            INTO
             :VALOR_TOTAL,
             :QTD_TOTAL,
             :LITROS,
             :CUSTOMEDIO,
             :MARGEM,
             :CODPRODFILHO,
             :CODPESQ1,
             :DESC_PRODUTO,
             :CODGRUPO,
             :NOME_GRUPO,
             :CODFABRICANTE,
             :NOME_FABRICANTE,
             :CODSUBGRUPO,
             :NOME_SUBGRUPO,
             :PERC_COMISSAO
        DO
        BEGIN
           VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
           CODVENDEDOR = 0;
           NOME_VENDEDOR = 'TODOS OS VENDEDORES';
           SUSPEND;
        END
      END

  END
END
begin

if (EFILTROVENDEDOR <> 0) then begin
    if (STATUSPED <> '') then begin
        if (ETIPOPED <> '') then begin
            FOR
                SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                       PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PED.CODPESSOA, PE.NOME, PED.CODVENDEDOR,
                       SG.CODSUBGRUPO, SG.DESCRICAO,
                       PI.ALIQCOMISSAO
                FROM PEDVENDITEM PI
                INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
                INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
                INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
                INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
                INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
                INNER JOIN PESSOA PE ON (PE.CODPESSOA = PED.CODPESSOA)
                WHERE PED.STATUSPED <> 'CANCELADO' AND PED.STATUSPED = :STATUSPED AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.TIPOPED = :ETIPOPED AND PED.PERCOMISS > 0
                GROUP BY 6,7,8,9,10,11,12,13,14,15,16
                INTO
                 :VALOR_TOTAL,
                 :QTD_TOTAL,
                 :LITROS,
                 :CUSTOMEDIO,
                 :MARGEM,
                 :CODPRODFILHO,
                 :CODPESQ1,
                 :DESC_PRODUTO,
                 :CODGRUPO,
                 :NOME_GRUPO,
                 :CODFABRICANTE,
                 :NOME_FABRICANTE,
                 :CODVENDEDOR,
                 :CODSUBGRUPO,
                 :NOME_SUBGRUPO,
                 :PERC_COMISSAO
            DO
            BEGIN
               VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
               SELECT NOME FROM VENDEDOR WHERE CODVENDEDOR = :CODVENDEDOR INTO :NOME_VENDEDOR;
               TIPO_COMISSAO = 'CLIENTE: ' ||CODFABRICANTE||' - '|| NOME_FABRICANTE;
               SUSPEND;
            END
        END
        ELSE
        BEGIN
            FOR
                SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                       PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PED.CODPESSOA, PE.NOME, PED.CODVENDEDOR,
                       SG.CODSUBGRUPO, SG.DESCRICAO,
                       PI.ALIQCOMISSAO
                FROM PEDVENDITEM PI
                INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
                INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
                INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
                INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
                INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
                INNER JOIN PESSOA PE ON (PE.CODPESSOA = PED.CODPESSOA)
                WHERE PED.STATUSPED <> 'CANCELADO' AND PED.STATUSPED = :STATUSPED AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.PERCOMISS > 0
                GROUP BY 6,7,8,9,10,11,12,13,14,15,16
                INTO
                 :VALOR_TOTAL,
                 :QTD_TOTAL,
                 :LITROS,
                 :CUSTOMEDIO,
                 :MARGEM,
                 :CODPRODFILHO,
                 :CODPESQ1,
                 :DESC_PRODUTO,
                 :CODGRUPO,
                 :NOME_GRUPO,
                 :CODFABRICANTE,
                 :NOME_FABRICANTE,
                 :CODVENDEDOR,
                 :CODSUBGRUPO,
                 :NOME_SUBGRUPO,
                 :PERC_COMISSAO
            DO
            BEGIN
               VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
               SELECT NOME FROM VENDEDOR WHERE CODVENDEDOR = :CODVENDEDOR INTO :NOME_VENDEDOR;
               TIPO_COMISSAO = 'CLIENTE: ' ||CODFABRICANTE||' - '|| NOME_FABRICANTE;
               SUSPEND;
            END
        END
     END
     ELSE
     BEGIN
        if (ETIPOPED <> '') then begin
             FOR
                SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                       PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PED.CODPESSOA, PE.NOME, PED.CODVENDEDOR,
                       SG.CODSUBGRUPO, SG.DESCRICAO,
                       PI.ALIQCOMISSAO
                FROM PEDVENDITEM PI
                INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
                INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
                INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
                INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
                INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
                INNER JOIN PESSOA PE ON (PE.CODPESSOA = PED.CODPESSOA)
                WHERE PED.STATUSPED <> 'CANCELADO' AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.TIPOPED = :ETIPOPED AND PED.PERCOMISS > 0
                GROUP BY 6,7,8,9,10,11,12,13,14,15,16
                INTO
                 :VALOR_TOTAL,
                 :QTD_TOTAL,
                 :LITROS,
                 :CUSTOMEDIO,
                 :MARGEM,
                 :CODPRODFILHO,
                 :CODPESQ1,
                 :DESC_PRODUTO,
                 :CODGRUPO,
                 :NOME_GRUPO,
                 :CODFABRICANTE,
                 :NOME_FABRICANTE,
                 :CODVENDEDOR,
                 :CODSUBGRUPO,
                 :NOME_SUBGRUPO,
                 :PERC_COMISSAO
            DO
            BEGIN
               VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
               SELECT NOME FROM VENDEDOR WHERE CODVENDEDOR = :CODVENDEDOR INTO :NOME_VENDEDOR;
               TIPO_COMISSAO = 'CLIENTE: ' ||CODFABRICANTE||' - '|| NOME_FABRICANTE;
               SUSPEND;
            END
        END
        ELSE
        BEGIN
             FOR
                SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
                 (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                       PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PED.CODPESSOA, PE.NOME, PED.CODVENDEDOR,
                       SG.CODSUBGRUPO, SG.DESCRICAO,
                       PI.ALIQCOMISSAO
                FROM PEDVENDITEM PI
                INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
                INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
                INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
                INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
                INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
                INNER JOIN PESSOA PE ON (PE.CODPESSOA = PED.CODPESSOA)
                WHERE PED.STATUSPED <> 'CANCELADO' AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.PERCOMISS > 0
                GROUP BY 6,7,8,9,10,11,12,13,14,15,16
                INTO
                 :VALOR_TOTAL,
                 :QTD_TOTAL,
                 :LITROS,
                 :CUSTOMEDIO,
                 :MARGEM,
                 :CODPRODFILHO,
                 :CODPESQ1,
                 :DESC_PRODUTO,
                 :CODGRUPO,
                 :NOME_GRUPO,
                 :CODFABRICANTE,
                 :NOME_FABRICANTE,
                 :CODVENDEDOR,
                 :CODSUBGRUPO,
                 :NOME_SUBGRUPO,
                 :PERC_COMISSAO
            DO
            BEGIN
               VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
               SELECT NOME FROM VENDEDOR WHERE CODVENDEDOR = :CODVENDEDOR INTO :NOME_VENDEDOR;
               TIPO_COMISSAO = 'CLIENTE: ' ||CODFABRICANTE||' - '|| NOME_FABRICANTE;
               SUSPEND;
            END
        END
     END
END
ELSE
BEGIN
  if (STATUSPED <> '') then begin
      if (ETIPOPED <> '') then begin
          FOR
            SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
             (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                   PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PED.CODPESSOA, PE.NOME,
                   SG.CODSUBGRUPO, SG.DESCRICAO,
                   PI.ALIQCOMISSAO
            FROM PEDVENDITEM PI
            INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
            INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
            INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
            INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
            INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
            INNER JOIN PESSOA PE ON (PE.CODPESSOA = PED.CODPESSOA)
            WHERE PED.STATUSPED <> 'CANCELADO' AND PED.STATUSPED = :STATUSPED AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.TIPOPED = :ETIPOPED AND PED.PERCOMISS > 0
            GROUP BY 6,7,8,9,10,11,12,13,14,15
            INTO
             :VALOR_TOTAL,
             :QTD_TOTAL,
             :LITROS,
             :CUSTOMEDIO,
             :MARGEM,
             :CODPRODFILHO,
             :CODPESQ1,
             :DESC_PRODUTO,
             :CODGRUPO,
             :NOME_GRUPO,
             :CODFABRICANTE,
             :NOME_FABRICANTE,
             :CODSUBGRUPO,
             :NOME_SUBGRUPO,
             :PERC_COMISSAO
        DO
        BEGIN
           VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
           CODVENDEDOR = 0;
           NOME_VENDEDOR = 'TODOS OS VENDEDORES';
           SUSPEND;
        END
      END
      ELSE
      BEGIN
          FOR
            SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
             (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                   PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PED.CODPESSOA, PE.NOME,
                   SG.CODSUBGRUPO, SG.DESCRICAO,
                   PI.ALIQCOMISSAO
            FROM PEDVENDITEM PI
            INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
            INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
            INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
            INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
            INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
            INNER JOIN PESSOA PE ON (PE.CODPESSOA = PED.CODPESSOA)
            WHERE PED.STATUSPED <> 'CANCELADO' AND PED.STATUSPED = :STATUSPED AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.PERCOMISS > 0
            GROUP BY 6,7,8,9,10,11,12,13,14,15
            INTO
             :VALOR_TOTAL,
             :QTD_TOTAL,
             :LITROS,
             :CUSTOMEDIO,
             :MARGEM,
             :CODPRODFILHO,
             :CODPESQ1,
             :DESC_PRODUTO,
             :CODGRUPO,
             :NOME_GRUPO,
             :CODFABRICANTE,
             :NOME_FABRICANTE,
             :CODSUBGRUPO,
             :NOME_SUBGRUPO,
             :PERC_COMISSAO
        DO
        BEGIN
           VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
           CODVENDEDOR = 0;
           NOME_VENDEDOR = 'TODOS OS VENDEDORES';
           SUSPEND;
        END
      END
  END
  ELSE BEGIN
      if (ETIPOPED <> '') then begin
          FOR
            SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
             (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                   PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PED.CODPESSOA, PE.NOME,
                   SG.CODSUBGRUPO, SG.DESCRICAO,
                   PI.ALIQCOMISSAO
            FROM PEDVENDITEM PI
            INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
            INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
            INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
            INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
            INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
            INNER JOIN PESSOA PE ON (PE.CODPESSOA = PED.CODPESSOA)
            WHERE PED.STATUSPED <> 'CANCELADO' AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.TIPOPED = :ETIPOPED AND PED.PERCOMISS > 0
            GROUP BY 6,7,8,9,10,11,12,13,14,15
            INTO
             :VALOR_TOTAL,
             :QTD_TOTAL,
             :LITROS,
             :CUSTOMEDIO,
             :MARGEM,
             :CODPRODFILHO,
             :CODPESQ1,
             :DESC_PRODUTO,
             :CODGRUPO,
             :NOME_GRUPO,
             :CODFABRICANTE,
             :NOME_FABRICANTE,
             :CODSUBGRUPO,
             :NOME_SUBGRUPO,
             :PERC_COMISSAO
        DO
        BEGIN
           VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
           CODVENDEDOR = 0;
           NOME_VENDEDOR = 'TODOS OS VENDEDORES';
           SUSPEND;
        END
      END
      ELSE
      BEGIN
          FOR
            SELECT SUM(PRECOVEND) AS TOTITEM, SUM(QTDE) AS QTDE, SUM(QTDE * PI.FATORCONVERSAO) AS LITROS, SUM(PI.QTDE* PI.CUSTOMEDIO) AS CUSTOMEDIO,
             (1 - ((SUM(PI.QTDE* PI.CUSTOMEDIO)) / SUM(PRECOVEND))) * 100 AS MARGEM,
                   PI.CODPRODFILHO, PF.CODPESQ1, PF.DESCRICAO, GR.CODGRUPO, GR.DESCRICAO, PED.CODPESSOA, PE.NOME,
                   SG.CODSUBGRUPO, SG.DESCRICAO,
                   PI.ALIQCOMISSAO
            FROM PEDVENDITEM PI
            INNER JOIN PEDVEND PED ON (PED.CODPEDVEND = PI.CODPEDVEND)
            INNER JOIN PRODFILHO PF ON (PF.CODPRODFILHO = PI.CODPRODFILHO)
            INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
            INNER JOIN GRUPO GR ON (GR.CODGRUPO = PD.CODGRUPO)
            INNER JOIN SUBGRUPO SG ON (SG.CODSUBGRUPO = PD.CODSUBGRUPO)
            INNER JOIN PESSOA PE ON (PE.CODPESSOA = PED.CODPESSOA)
            WHERE PED.STATUSPED <> 'CANCELADO' AND PED.DT_SAIDA BETWEEN :EDTINI AND :EDTFIM AND PED.PERCOMISS > 0
            GROUP BY 6,7,8,9,10,11,12,13,14,15
            INTO
             :VALOR_TOTAL,
             :QTD_TOTAL,
             :LITROS,
             :CUSTOMEDIO,
             :MARGEM,
             :CODPRODFILHO,
             :CODPESQ1,
             :DESC_PRODUTO,
             :CODGRUPO,
             :NOME_GRUPO,
             :CODFABRICANTE,
             :NOME_FABRICANTE,
             :CODSUBGRUPO,
             :NOME_SUBGRUPO,
             :PERC_COMISSAO
        DO
        BEGIN
           VALOR_COMISSAO = VALOR_TOTAL * (PERC_COMISSAO / 100);
           CODVENDEDOR = 0;
           NOME_VENDEDOR = 'TODOS OS VENDEDORES';
           SUSPEND;
        END
      END

  END
END
END
END ^

ALTER PROCEDURE R180VENDASPORCLIENTE (EDTINI TIMESTAMP,
EDTFIM TIMESTAMP,
EFILTROVENDEDOR INTEGER,
STATUSPED VARCHAR(20) CHARACTER SET ISO8859_1,
ETIPOPED VARCHAR(20) CHARACTER SET ISO8859_1)
RETURNS (CODPRODFILHO INTEGER,
CODFABRICANTE INTEGER,
NOME_FABRICANTE VARCHAR(80) CHARACTER SET ISO8859_1,
CODVENDEDOR INTEGER,
QTD_TOTAL DOUBLE PRECISION,
VALOR_TOTAL DOUBLE PRECISION,
LITROS DOUBLE PRECISION,
CUSTOMEDIO DOUBLE PRECISION,
MARGEM DOUBLE PRECISION,
NOME_VENDEDOR VARCHAR(80) CHARACTER SET ISO8859_1,
CODGRUPO INTEGER,
NOME_GRUPO VARCHAR(80) CHARACTER SET ISO8859_1,
TIPOPED VARCHAR(20) CHARACTER SET ISO8859_1,
DESC_PRODUTO VARCHAR(80) CHARACTER SET ISO8859_1,
CODPESQ1 VARCHAR(30) CHARACTER SET ISO8859_1,
CODSUBGRUPO INTEGER,
NOME_SUBGRUPO VARCHAR(60) CHARACTER SET ISO8859_1,
UF CHAR(2) CHARACTER SET ISO8859_1,
CIDADE VARCHAR(45) CHARACTER SET ISO8859_1,
CODPESSOA INTEGER,
ATIVIDADE VARCHAR(60) CHARACTER SET ISO8859_1,
TIPO_ATIVIDADE VARCHAR(60) CHARACTER SET ISO8859_1,
RAMO VARCHAR(60) CHARACTER SET ISO8859_1,
CUSTOREPOSI2 DOUBLE PRECISION,
MARGEM2 DOUBLE PRECISION,
CUSTOREPOSI DOUBLE PRECISION,
MARGEM1 DOUBLE PRECISION)
AS 
begin
  if (EFILTROVENDEDOR <> 0) then
  begin
    if (STATUSPED <> '') then
    begin
      if (ETIPOPED <> '') then
      begin
        for select
          sum(PRECOVEND) as TOTITEM,
          sum(QTDE) as QTDE,
          sum(QTDE * PI.FATORCONVERSAO) as LITROS,
          sum(pi.QTDE * pi.CUSTOMEDIO) as CUSTOMEDIO,
          (1 - ((sum(pi.QTDE * pi.CUSTOMEDIO)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM,
          sum(pi.QTDE * pi.CUSTOREPOSI2) as CUSTOREPOSI2,
          sum(pi.QTDE * pi.CUSTOREPOSI) as CUSTOREPOSI,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI2)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM2,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM1,
          pi.CODPRODFILHO,
          PF.CODPESQ1,
          PF.DESCRICAO,
          GR.CODGRUPO,
          GR.DESCRICAO,
          PD.CODFABRICANTE,
          PE.NOME,
          PED.CODVENDEDOR,
          CL.CODPESSOA,
          CL.NOME,
          CL.UF_1,
          CL.CIDADE_1,
          PED.CODPESSOA,
          PED.TIPOPED
        from
          PEDVENDITEM pi
          join PEDVEND PED on
            PED.CODPEDVEND = pi.CODPEDVEND
          join PRODFILHO PF on
            PF.CODPRODFILHO = pi.CODPRODFILHO
          join PRODUTO PD on
            PD.CODPRODUTO = PF.CODPRODUTO
          join GRUPO GR on
            GR.CODGRUPO = PD.CODGRUPO
          left join PESSOA PE on
            PE.CODPESSOA = PD.CODFABRICANTE
          join PESSOA CL on
            CL.CODPESSOA = PED.CODPESSOA
        where
          PED.STATUSPED <> 'CANCELADO' and
          PED.STATUSPED = :STATUSPED and
          PED.DT_SAIDA between :EDTINI and :EDTFIM and
          PED.TIPOPED = :ETIPOPED
        group by
          10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23
        into
          VALOR_TOTAL,
          QTD_TOTAL,
          LITROS,
          CUSTOMEDIO,
          MARGEM,
          CUSTOREPOSI2,
          CUSTOREPOSI,
          MARGEM2,
          MARGEM1,
          CODPRODFILHO,
          CODPESQ1,
          DESC_PRODUTO,
          CODGRUPO,
          NOME_GRUPO,
          CODFABRICANTE,
          NOME_FABRICANTE,
          CODVENDEDOR,
          CODSUBGRUPO,
          NOME_SUBGRUPO,
          UF,
          CIDADE,
          CODPESSOA,
          TIPOPED
        do
        begin
          NOME_VENDEDOR = null;

          select
            coalesce(NOME, 'VENDEDOR NÃO INFORMADO')
          from
            VENDEDOR
          where
            CODVENDEDOR = :CODVENDEDOR
          into
            NOME_VENDEDOR;

          ATIVIDADE = null;
          TIPO_ATIVIDADE = null;
          RAMO = null;

          select
            coalesce(TBL_RAMOATV.DESCRICAO, 'ATIVIDADE NÃO INFORMADA') ATIVIDADE,
            coalesce(TBL_RAMOATVTIPO.DESCRICAO, 'TIPO DE ATIVIDADE NÃO INFORMADO') TIPO_ATIVIDADE,
            coalesce(TBL_RAMO.DESCRICAO, 'RAMO NÃO INFORMADO') RAMO
          from
            PESSOA
            left join TBL_RAMOATVTIPO on
              PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO
            left join TBL_RAMOATV on
              TBL_RAMOATV.CODATIVIDADE = TBL_RAMOATVTIPO.CODATIVIDADE
            left join TBL_RAMO on
              TBL_RAMO.CODRAMO = TBL_RAMOATV.CODRAMO
          where
            PESSOA.CODPESSOA = :CODPESSOA
          into
            ATIVIDADE,
            TIPO_ATIVIDADE,
            RAMO;
          suspend;
        end
      end
      else
      begin
        for select
          sum(PRECOVEND) as TOTITEM,
          sum(QTDE) as QTDE,
          sum(QTDE * PI.FATORCONVERSAO) as LITROS,
          sum(pi.QTDE * pi.CUSTOMEDIO) as CUSTOMEDIO,
          (1 - ((sum(pi.QTDE * pi.CUSTOMEDIO)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM,
          sum(pi.QTDE * pi.CUSTOREPOSI2) as CUSTOREPOSI2,
          sum(pi.QTDE * pi.CUSTOREPOSI) as CUSTOREPOSI,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI2)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM2,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM1,
          pi.CODPRODFILHO,
          PF.CODPESQ1,
          PF.DESCRICAO,
          GR.CODGRUPO,
          GR.DESCRICAO,
          PD.CODFABRICANTE,
          PE.NOME,
          PED.CODVENDEDOR,
          CL.CODPESSOA,
          CL.NOME,
          CL.UF_1,
          CL.CIDADE_1,
          PED.CODPESSOA,
          PED.TIPOPED
        from
          PEDVENDITEM pi
          join PEDVEND PED on
            PED.CODPEDVEND = pi.CODPEDVEND
          join PRODFILHO PF on
            PF.CODPRODFILHO = pi.CODPRODFILHO
          join PRODUTO PD on
            PD.CODPRODUTO = PF.CODPRODUTO
          join GRUPO GR on
            GR.CODGRUPO = PD.CODGRUPO
          left join PESSOA PE on
            PE.CODPESSOA = PD.CODFABRICANTE
          join PESSOA CL on
            CL.CODPESSOA = PED.CODPESSOA
        where
          PED.STATUSPED <> 'CANCELADO' and
          PED.STATUSPED = :STATUSPED and
          PED.DT_SAIDA between :EDTINI and :EDTFIM
        group by
          10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23
        into
          VALOR_TOTAL,
          QTD_TOTAL,
          LITROS,
          CUSTOMEDIO,
          MARGEM,
          CUSTOREPOSI2,
          CUSTOREPOSI,
          MARGEM2,
          MARGEM1,
          CODPRODFILHO,
          CODPESQ1,
          DESC_PRODUTO,
          CODGRUPO,
          NOME_GRUPO,
          CODFABRICANTE,
          NOME_FABRICANTE,
          CODVENDEDOR,
          CODSUBGRUPO,
          NOME_SUBGRUPO,
          UF,
          CIDADE,
          CODPESSOA,
          TIPOPED
        do
        begin
          NOME_VENDEDOR = null;

          select
            coalesce(NOME, 'VENDEDOR NÃO INFORMADO')
          from
            VENDEDOR
          where
            CODVENDEDOR = :CODVENDEDOR
          into
            NOME_VENDEDOR;

          ATIVIDADE = null;
          TIPO_ATIVIDADE = null;
          RAMO = null;

          select
            coalesce(TBL_RAMOATV.DESCRICAO, 'ATIVIDADE NÃO INFORMADA') ATIVIDADE,
            coalesce(TBL_RAMOATVTIPO.DESCRICAO, 'TIPO DE ATIVIDADE NÃO INFORMADO') TIPO_ATIVIDADE,
            coalesce(TBL_RAMO.DESCRICAO, 'RAMO NÃO INFORMADO') RAMO
          from
            PESSOA
            left join TBL_RAMOATVTIPO on
              PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO
            left join TBL_RAMOATV on
              TBL_RAMOATV.CODATIVIDADE = TBL_RAMOATVTIPO.CODATIVIDADE
            left join TBL_RAMO on
              TBL_RAMO.CODRAMO = TBL_RAMOATV.CODRAMO
          where
            PESSOA.CODPESSOA = :CODPESSOA
          into
            ATIVIDADE,
            TIPO_ATIVIDADE,
            RAMO;
          suspend;
        end
      end
    end
    else
    begin
      if (ETIPOPED <> '') then
      begin
        for select
          sum(PRECOVEND) as TOTITEM,
          sum(QTDE) as QTDE,
          sum(QTDE * PI.FATORCONVERSAO) as LITROS,
          sum(pi.QTDE * pi.CUSTOMEDIO) as CUSTOMEDIO,
          (1 - ((sum(pi.QTDE * pi.CUSTOMEDIO)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM,
          sum(pi.QTDE * pi.CUSTOREPOSI2) as CUSTOREPOSI2,
          sum(pi.QTDE * pi.CUSTOREPOSI) as CUSTOREPOSI,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI2)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM2,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM1,
          pi.CODPRODFILHO,
          PF.CODPESQ1,
          PF.DESCRICAO,
          GR.CODGRUPO,
          GR.DESCRICAO,
          PD.CODFABRICANTE,
          PE.NOME,
          PED.CODVENDEDOR,
          CL.CODPESSOA,
          CL.NOME,
          CL.UF_1,
          CL.CIDADE_1,
          PED.CODPESSOA,
          PED.TIPOPED
        from
          PEDVENDITEM pi
          join PEDVEND PED on
            PED.CODPEDVEND = pi.CODPEDVEND
          join PRODFILHO PF on
            PF.CODPRODFILHO = pi.CODPRODFILHO
          join PRODUTO PD on
            PD.CODPRODUTO = PF.CODPRODUTO
          join GRUPO GR on
            GR.CODGRUPO = PD.CODGRUPO
          left join PESSOA PE on
            PE.CODPESSOA = PD.CODFABRICANTE
          left join PESSOA CL on
            CL.CODPESSOA = PED.CODPESSOA
        where
          PED.STATUSPED <> 'CANCELADO' and
          PED.DT_SAIDA between :EDTINI and :EDTFIM and
          PED.TIPOPED = :ETIPOPED
        group by
          10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23
        into
          VALOR_TOTAL,
          QTD_TOTAL,
          LITROS,
          CUSTOMEDIO,
          MARGEM,
          CUSTOREPOSI2,
          CUSTOREPOSI,
          MARGEM2,
          MARGEM1,
          CODPRODFILHO,
          CODPESQ1,
          DESC_PRODUTO,
          CODGRUPO,
          NOME_GRUPO,
          CODFABRICANTE,
          NOME_FABRICANTE,
          CODVENDEDOR,
          CODSUBGRUPO,
          NOME_SUBGRUPO,
          UF,
          CIDADE,
          CODPESSOA,
          TIPOPED
        do
        begin
          NOME_VENDEDOR = null;

          select
            coalesce(NOME, 'VENDEDOR NÃO INFORMADO')
          from
            VENDEDOR
          where
            CODVENDEDOR = :CODVENDEDOR
          into
            :NOME_VENDEDOR;

          ATIVIDADE = null;
          TIPO_ATIVIDADE = null;
          RAMO = null;

          select
            coalesce(TBL_RAMOATV.DESCRICAO, 'ATIVIDADE NÃO INFORMADA') ATIVIDADE,
            coalesce(TBL_RAMOATVTIPO.DESCRICAO, 'TIPO DE ATIVIDADE NÃO INFORMADO') TIPO_ATIVIDADE,
            coalesce(TBL_RAMO.DESCRICAO, 'RAMO NÃO INFORMADO') RAMO
          from
            PESSOA
            left join TBL_RAMOATVTIPO on
              PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO
            left join TBL_RAMOATV on
              TBL_RAMOATV.CODATIVIDADE = TBL_RAMOATVTIPO.CODATIVIDADE
            left join TBL_RAMO on
              TBL_RAMO.CODRAMO = TBL_RAMOATV.CODRAMO
          where
            PESSOA.CODPESSOA = :CODPESSOA
          into
            ATIVIDADE,
            TIPO_ATIVIDADE,
            RAMO;
          suspend;
        end
      end
      else
      begin
        for select
          sum(PRECOVEND) as TOTITEM,
          sum(QTDE) as QTDE,
          sum(QTDE * PI.FATORCONVERSAO) as LITROS,
          sum(pi.QTDE * pi.CUSTOMEDIO) as CUSTOMEDIO,
          (1 - ((sum(pi.QTDE * pi.CUSTOMEDIO)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM,
          sum(pi.QTDE * pi.CUSTOREPOSI2) as CUSTOREPOSI2,
          sum(pi.QTDE * pi.CUSTOREPOSI) as CUSTOREPOSI,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI2)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM2,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM1,
          pi.CODPRODFILHO,
          PF.CODPESQ1,
          PF.DESCRICAO,
          GR.CODGRUPO,
          GR.DESCRICAO,
          PD.CODFABRICANTE,
          PE.NOME,
          PED.CODVENDEDOR,
          CL.CODPESSOA,
          CL.NOME,
          CL.UF_1,
          CL.CIDADE_1,
          PED.CODPESSOA,
          PED.TIPOPED
        from
          PEDVENDITEM pi
          join PEDVEND PED on
            PED.CODPEDVEND = pi.CODPEDVEND
          join PRODFILHO PF on
            PF.CODPRODFILHO = pi.CODPRODFILHO
          join PRODUTO PD on
            PD.CODPRODUTO = PF.CODPRODUTO
          join GRUPO GR on
            GR.CODGRUPO = PD.CODGRUPO
          left join PESSOA PE on
            PE.CODPESSOA = PD.CODFABRICANTE
          join PESSOA CL on
            CL.CODPESSOA = PED.CODPESSOA
        where
          PED.STATUSPED <> 'CANCELADO' and
          PED.DT_SAIDA between :EDTINI and :EDTFIM
        group by
          10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23
        into
          VALOR_TOTAL,
          QTD_TOTAL,
          LITROS,
          CUSTOMEDIO,
          MARGEM,
          CUSTOREPOSI2,
          CUSTOREPOSI,
          MARGEM2,
          MARGEM1,
          CODPRODFILHO,
          CODPESQ1,
          DESC_PRODUTO,
          CODGRUPO,
          NOME_GRUPO,
          CODFABRICANTE,
          NOME_FABRICANTE,
          CODVENDEDOR,
          CODSUBGRUPO,
          NOME_SUBGRUPO,
          UF,
          CIDADE,
          CODPESSOA,
          TIPOPED
        do
        begin
          NOME_VENDEDOR = null;

          select
            coalesce(NOME, 'VENDEDOR NÃO INFORMADO')
          from
            VENDEDOR
          where
            CODVENDEDOR = :CODVENDEDOR
          into
            NOME_VENDEDOR;

          ATIVIDADE = null;
          TIPO_ATIVIDADE = null;
          RAMO = null;

          select
            coalesce(TBL_RAMOATV.DESCRICAO, 'ATIVIDADE NÃO INFORMADA') ATIVIDADE,
            coalesce(TBL_RAMOATVTIPO.DESCRICAO, 'TIPO DE ATIVIDADE NÃO INFORMADO') TIPO_ATIVIDADE,
            coalesce(TBL_RAMO.DESCRICAO, 'RAMO NÃO INFORMADO') RAMO
          from
            PESSOA
            left join TBL_RAMOATVTIPO on
              PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO
            left join TBL_RAMOATV on
              TBL_RAMOATV.CODATIVIDADE = TBL_RAMOATVTIPO.CODATIVIDADE
            left join TBL_RAMO on
              TBL_RAMO.CODRAMO = TBL_RAMOATV.CODRAMO
          where
            PESSOA.CODPESSOA = :CODPESSOA
          into
            ATIVIDADE,
            TIPO_ATIVIDADE,
            RAMO;
          suspend;
        end
      end
    end
  end
  else
  begin
    if (STATUSPED <> '') then
    begin
      if (ETIPOPED <> '') then
      begin
        for select
          sum(PRECOVEND) as TOTITEM,
          sum(QTDE) as QTDE,
          sum(QTDE * PI.FATORCONVERSAO) as LITROS,
          sum(pi.QTDE * pi.CUSTOMEDIO) as CUSTOMEDIO,
          (1 - ((sum(pi.QTDE * pi.CUSTOMEDIO)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM,
          sum(pi.QTDE * pi.CUSTOREPOSI2) as CUSTOREPOSI2,
          sum(pi.QTDE * pi.CUSTOREPOSI) as CUSTOREPOSI,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI2)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM2,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM1,
          pi.CODPRODFILHO,
          PF.CODPESQ1,
          PF.DESCRICAO,
          GR.CODGRUPO,
          GR.DESCRICAO,
          PD.CODFABRICANTE,
          PE.NOME,
          CL.CODPESSOA,
          CL.NOME,
          CL.UF_1,
          CL.CIDADE_1,
          PED.CODPESSOA,
          PED.TIPOPED
        from
          PEDVENDITEM pi
          join PEDVEND PED on
            PED.CODPEDVEND = pi.CODPEDVEND
          join PRODFILHO PF on
            PF.CODPRODFILHO = pi.CODPRODFILHO
          join PRODUTO PD on
            PD.CODPRODUTO = PF.CODPRODUTO
          join GRUPO GR on
            GR.CODGRUPO = PD.CODGRUPO
          left join PESSOA PE on
            PE.CODPESSOA = PD.CODFABRICANTE
          join PESSOA CL on
            CL.CODPESSOA = PED.CODPESSOA
        where
          PED.STATUSPED <> 'CANCELADO' and
          PED.STATUSPED = :STATUSPED and
          PED.DT_SAIDA between :EDTINI and :EDTFIM and
          PED.TIPOPED = :ETIPOPED
        group by
          10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22
        into
          VALOR_TOTAL,
          QTD_TOTAL,
          LITROS,
          CUSTOMEDIO,
          MARGEM,
          CUSTOREPOSI2,
          CUSTOREPOSI,
          MARGEM2,
          MARGEM1,
          CODPRODFILHO,
          CODPESQ1,
          DESC_PRODUTO,
          CODGRUPO,
          NOME_GRUPO,
          CODFABRICANTE,
          NOME_FABRICANTE,
          CODSUBGRUPO,
          NOME_SUBGRUPO,
          UF,
          CIDADE,
          CODPESSOA,
          TIPOPED
        do
        begin
          CODVENDEDOR = 0;
          NOME_VENDEDOR = 'TODOS OS VENDEDORES';

          ATIVIDADE = null;
          TIPO_ATIVIDADE = null;
          RAMO = null;

          select
            coalesce(TBL_RAMOATV.DESCRICAO, 'ATIVIDADE NÃO INFORMADA') ATIVIDADE,
            coalesce(TBL_RAMOATVTIPO.DESCRICAO, 'TIPO DE ATIVIDADE NÃO INFORMADO') TIPO_ATIVIDADE,
            coalesce(TBL_RAMO.DESCRICAO, 'RAMO NÃO INFORMADO') RAMO
          from
            PESSOA
            left join TBL_RAMOATVTIPO on
              PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO
            left join TBL_RAMOATV on
              TBL_RAMOATV.CODATIVIDADE = TBL_RAMOATVTIPO.CODATIVIDADE
            left join TBL_RAMO on
              TBL_RAMO.CODRAMO = TBL_RAMOATV.CODRAMO
          where
            PESSOA.CODPESSOA = :CODPESSOA
          into
            ATIVIDADE,
            TIPO_ATIVIDADE,
            RAMO;
          suspend;
        end
      end
      else
      begin
        for select
          sum(PRECOVEND) as TOTITEM,
          sum(QTDE) as QTDE,
          sum(QTDE * PI.FATORCONVERSAO) as LITROS,
          sum(pi.QTDE * pi.CUSTOMEDIO) as CUSTOMEDIO,
          (1 - ((sum(pi.QTDE * pi.CUSTOMEDIO)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM,
          sum(pi.QTDE * pi.CUSTOREPOSI2) as CUSTOREPOSI2,
          sum(pi.QTDE * pi.CUSTOREPOSI) as CUSTOREPOSI,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI2)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM2,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM1,
          pi.CODPRODFILHO,
          PF.CODPESQ1,
          PF.DESCRICAO,
          GR.CODGRUPO,
          GR.DESCRICAO,
          PD.CODFABRICANTE,
          PE.NOME,
          CL.CODPESSOA,
          CL.NOME,
          CL.UF_1,
          CL.CIDADE_1,
          PED.CODPESSOA,
          PED.TIPOPED
        from
          PEDVENDITEM pi
          join PEDVEND PED on
          PED.CODPEDVEND = pi.CODPEDVEND
          join PRODFILHO PF on
            PF.CODPRODFILHO = pi.CODPRODFILHO
          join PRODUTO PD on
            PD.CODPRODUTO = PF.CODPRODUTO
          join GRUPO GR on
            GR.CODGRUPO = PD.CODGRUPO
          left join PESSOA PE on
            PE.CODPESSOA = PD.CODFABRICANTE
          join PESSOA CL on
            CL.CODPESSOA = PED.CODPESSOA
        where
          PED.STATUSPED <> 'CANCELADO' and
          PED.STATUSPED = :STATUSPED and
          PED.DT_SAIDA between :EDTINI and :EDTFIM
        group by
          10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22
        into
          VALOR_TOTAL,
          QTD_TOTAL,
          LITROS,
          CUSTOMEDIO,
          MARGEM,
          CUSTOREPOSI2,
          CUSTOREPOSI,
          MARGEM2,
          MARGEM1,
          CODPRODFILHO,
          CODPESQ1,
          DESC_PRODUTO,
          CODGRUPO,
          NOME_GRUPO,
          CODFABRICANTE,
          NOME_FABRICANTE,
          CODSUBGRUPO,
          NOME_SUBGRUPO,
          UF,
          CIDADE,
          CODPESSOA,
          TIPOPED
        do
        begin
          CODVENDEDOR = 0;
          NOME_VENDEDOR = 'TODOS OS VENDEDORES';

          ATIVIDADE = null;
          TIPO_ATIVIDADE = null;
          RAMO = null;

          select
            coalesce(TBL_RAMOATV.DESCRICAO, 'ATIVIDADE NÃO INFORMADA') ATIVIDADE,
            coalesce(TBL_RAMOATVTIPO.DESCRICAO, 'TIPO DE ATIVIDADE NÃO INFORMADO') TIPO_ATIVIDADE,
            coalesce(TBL_RAMO.DESCRICAO, 'RAMO NÃO INFORMADO') RAMO
          from
            PESSOA
            left join TBL_RAMOATVTIPO on
              PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO
            left join TBL_RAMOATV on
              TBL_RAMOATV.CODATIVIDADE = TBL_RAMOATVTIPO.CODATIVIDADE
            left join TBL_RAMO on
              TBL_RAMO.CODRAMO = TBL_RAMOATV.CODRAMO
          where
            PESSOA.CODPESSOA = :CODPESSOA
          into
            ATIVIDADE,
            TIPO_ATIVIDADE,
            RAMO;
          suspend;
        end
      end
    end
    else
    begin
      if (ETIPOPED <> '') then
      begin
        for select
          sum(PRECOVEND) as TOTITEM,
          sum(QTDE) as QTDE,
          sum(QTDE * PI.FATORCONVERSAO) as LITROS,
          sum(pi.QTDE * pi.CUSTOMEDIO) as CUSTOMEDIO,
          (1 - ((sum(pi.QTDE * pi.CUSTOMEDIO)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM,
          sum(pi.QTDE * pi.CUSTOREPOSI2) as CUSTOREPOSI2,
          sum(pi.QTDE * pi.CUSTOREPOSI) as CUSTOREPOSI,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI2)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM2,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM1,
          pi.CODPRODFILHO,
          PF.CODPESQ1,
          PF.DESCRICAO,
          GR.CODGRUPO,
          GR.DESCRICAO,
          PD.CODFABRICANTE,
          PE.NOME,
          CL.CODPESSOA,
          CL.NOME,
          CL.UF_1,
          CL.CIDADE_1,
          PED.CODPESSOA,
          PED.TIPOPED
        from
          PEDVENDITEM pi
          join PEDVEND PED on
            PED.CODPEDVEND = pi.CODPEDVEND
          join PRODFILHO PF on
            PF.CODPRODFILHO = pi.CODPRODFILHO
          join PRODUTO PD on
            PD.CODPRODUTO = PF.CODPRODUTO
          join GRUPO GR on
            GR.CODGRUPO = PD.CODGRUPO
          left join PESSOA PE on
            PE.CODPESSOA = PD.CODFABRICANTE
          join PESSOA CL on
          CL.CODPESSOA = PED.CODPESSOA
        where
          PED.STATUSPED <> 'CANCELADO' and
          PED.DT_SAIDA between :EDTINI and :EDTFIM and
          PED.TIPOPED = :ETIPOPED
        group by
          10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22
        into
          VALOR_TOTAL,
          QTD_TOTAL,
          LITROS,
          CUSTOMEDIO,
          MARGEM,
          CUSTOREPOSI2,
          CUSTOREPOSI,
          MARGEM2,
          MARGEM1,
          CODPRODFILHO,
          CODPESQ1,
          DESC_PRODUTO,
          CODGRUPO,
          NOME_GRUPO,
          CODFABRICANTE,
          NOME_FABRICANTE,
          CODSUBGRUPO,
          NOME_SUBGRUPO,
          UF,
          CIDADE,
          CODPESSOA,
          TIPOPED
        do
        begin
          CODVENDEDOR = 0;
          NOME_VENDEDOR = 'TODOS OS VENDEDORES';

          ATIVIDADE = null;
          TIPO_ATIVIDADE = null;
          RAMO = null;

          select
            coalesce(TBL_RAMOATV.DESCRICAO, 'ATIVIDADE NÃO INFORMADA') ATIVIDADE,
            coalesce(TBL_RAMOATVTIPO.DESCRICAO, 'TIPO DE ATIVIDADE NÃO INFORMADO') TIPO_ATIVIDADE,
            coalesce(TBL_RAMO.DESCRICAO, 'RAMO NÃO INFORMADO') RAMO
          from
            PESSOA
            left join TBL_RAMOATVTIPO on
              PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO
            left join TBL_RAMOATV on
              TBL_RAMOATV.CODATIVIDADE = TBL_RAMOATVTIPO.CODATIVIDADE
            left join TBL_RAMO on
              TBL_RAMO.CODRAMO = TBL_RAMOATV.CODRAMO
          where
            PESSOA.CODPESSOA = :CODPESSOA
          into
            ATIVIDADE,
            TIPO_ATIVIDADE,
            RAMO;
          suspend;
        end
      end
      else
      begin
        for select
          sum(PRECOVEND) as TOTITEM,
          sum(QTDE) as QTDE,
          sum(QTDE * PI.FATORCONVERSAO) as LITROS,
          sum(pi.QTDE * pi.CUSTOMEDIO) as CUSTOMEDIO,
          (1 - ((sum(pi.QTDE * pi.CUSTOMEDIO)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM,
          sum(pi.QTDE * pi.CUSTOREPOSI2) as CUSTOREPOSI2,
          sum(pi.QTDE * pi.CUSTOREPOSI) as CUSTOREPOSI,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI2)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM2,
          (1 - ((sum(pi.QTDE * pi.CUSTOREPOSI)) / sum(coalesce(nullif(PRECOVEND, 0), 1)))) * 100 as MARGEM1,
          pi.CODPRODFILHO,
          PF.CODPESQ1,
          PF.DESCRICAO,
          GR.CODGRUPO,
          GR.DESCRICAO,
          PD.CODFABRICANTE,
          PE.NOME,
          CL.CODPESSOA,
          CL.NOME,
          CL.UF_1,
          CL.CIDADE_1,
          PED.CODPESSOA,
          PED.TIPOPED
        from
          PEDVENDITEM pi
          join PEDVEND PED on
            PED.CODPEDVEND = pi.CODPEDVEND
          join PRODFILHO PF on
            PF.CODPRODFILHO = pi.CODPRODFILHO
          join PRODUTO PD on
            PD.CODPRODUTO = PF.CODPRODUTO
          join GRUPO GR on
            GR.CODGRUPO = PD.CODGRUPO
          left join PESSOA PE on
            PE.CODPESSOA = PD.CODFABRICANTE
          join PESSOA CL on
            CL.CODPESSOA = PED.CODPESSOA
        where
          PED.STATUSPED <> 'CANCELADO' and
          PED.DT_SAIDA between :EDTINI and :EDTFIM
        group by
          10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22
        into
          VALOR_TOTAL,
          QTD_TOTAL,
          LITROS,
          CUSTOMEDIO,
          MARGEM,
          CUSTOREPOSI2,
          CUSTOREPOSI,
          MARGEM2,
          MARGEM1,
          CODPRODFILHO,
          CODPESQ1,
          DESC_PRODUTO,
          CODGRUPO,
          NOME_GRUPO,
          CODFABRICANTE,
          NOME_FABRICANTE,
          CODSUBGRUPO,
          NOME_SUBGRUPO,
          UF,
          CIDADE,
          CODPESSOA,
          TIPOPED
        do
        begin
          CODVENDEDOR = 0;
          NOME_VENDEDOR = 'TODOS OS VENDEDORES';

          ATIVIDADE = null;
          TIPO_ATIVIDADE = null;
          RAMO = null;

          select
            coalesce(TBL_RAMOATV.DESCRICAO, 'ATIVIDADE NÃO INFORMADA') ATIVIDADE,
            coalesce(TBL_RAMOATVTIPO.DESCRICAO, 'TIPO DE ATIVIDADE NÃO INFORMADO') TIPO_ATIVIDADE,
            coalesce(TBL_RAMO.DESCRICAO, 'RAMO NÃO INFORMADO') RAMO
          from
            PESSOA
            left join TBL_RAMOATVTIPO on
              PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO
            left join TBL_RAMOATV on
              TBL_RAMOATV.CODATIVIDADE = TBL_RAMOATVTIPO.CODATIVIDADE
            left join TBL_RAMO on
              TBL_RAMO.CODRAMO = TBL_RAMOATV.CODRAMO
          where
            PESSOA.CODPESSOA = :CODPESSOA
          into
            ATIVIDADE,
            TIPO_ATIVIDADE,
            RAMO;
          suspend;
        end
      end
    end
  end
end ^

ALTER PROCEDURE STP_METASPORVENDEDOR (INICIO DATE,
FIM DATE)
RETURNS (CODVENDEDOR INTEGER,
VENDEDOR VARCHAR(60) CHARACTER SET ISO8859_1,
AFATURAR DOUBLE PRECISION,
FATURADO DOUBLE PRECISION,
ALCANCADO DOUBLE PRECISION,
ALCANCADOPERC DOUBLE PRECISION,
META DOUBLE PRECISION,
ATIVO SMALLINT)
AS 
declare variable desconto double precision;
declare variable linicio timestamp;
declare variable lfim timestamp;
begin
  LINICIO = cast(INICIO as date)||' 00:00:00';
  LFIM = cast(FIM as date)||' 23:59:59';
  for select
      V.CODVENDEDOR,
      V.NOME,
      coalesce(V.ATIVO,2),
      coalesce(V.MARGEM, 0) as MARGEM
    from
      VENDEDOR V
    into
      :CODVENDEDOR,
      :VENDEDOR,
      :ATIVO,
      :META
  do
  begin
    select
      sum(VALOR_TOTAL)
    from
      PEDVEND
    where
      STATUSPED =  'NORMAL'
      and PDV_CRITICA in ('V','E','M','A')
      and DT_SAIDA  between :LINICIO and :LFIM
      and CODVENDEDOR = :CODVENDEDOR
    into
      AFATURAR;

    AFATURAR = coalesce(AFATURAR,0);

    select
      cast(sum(PEDVENDITEM.PRECOVEND) as numeric (18,2))
      - cast(sum( ((coalesce(PEDVEND.DESCPERC_VALOR,0) + coalesce(PEDVEND.DESC_VALOR,0))
                * (PEDVENDITEM.PRECOVEND/coalesce(nullif(PEDVEND.VALOR_BRUTO,0),1))) ) as numeric (18,2)) VALOR_LIQ
    from
      CAIXAOPPEDTIT
      join PEDVEND on (PEDVEND.CODPEDVEND = CAIXAOPPEDTIT.CODPEDVEND)
      join PEDVENDITEM on (PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND)
    where
      PEDVEND.TIPOPED in ('VENDA','CADERNO')
      and CAIXAOPPEDTIT.DT_CADAST between :LINICIO and :LFIM
      and PEDVEND.CODVENDEDOR = :CODVENDEDOR
    into
      FATURADO;

    FATURADO = coalesce(FATURADO,0);

    ALCANCADO = AFATURAR + FATURADO;

/*
    select
      coalesce(sum(coalesce(PEDVEND.DESC_VALOR,0)),0)
    from
      PEDVEND
      inner join CONTA on (PEDVEND.CODPEDVEND = CONTA.CODPENDVEND)
    where
     -- PEDVEND.STATUSPED = 'FATURADO' AND
      PEDVEND.TIPOPED in ('VENDA','CADERNO') and
      PEDVEND.DT_SAIDA between :LINICIO and :LFIM and
      PEDVEND.CODVENDEDOR = :CODVENDEDOR
    into
      DESCONTO;

    FATURADO = FATURADO - DESCONTO;
*/


    if (META = 0) then
      ALCANCADOPERC = 0;
    else
      ALCANCADOPERC = (ALCANCADO / coalesce(nullif(META,0),1)) * 100;
    suspend;
  end
end ^
