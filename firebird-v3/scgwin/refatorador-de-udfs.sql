SET TERM ^ ;

-- RTRIM

ALTER PROCEDURE SPNFENTRADAITENS(
    ECODNFENTRADA INTEGER,
    EGEN_CODNFENTRADA_TEMP VARCHAR(40),
    ETIPOCONSULTA VARCHAR(1))
RETURNS (
    CODNFENTRADAITENS INTEGER,
    CODNFENTRADA INTEGER,
    DESPFRONTVLRITEM DOUBLE PRECISION,
    CODPRODFILHO INTEGER,
    CODPESQUISA VARCHAR(30),
    IPIPERC DOUBLE PRECISION,
    QTD DOUBLE PRECISION,
    PRODVLR DOUBLE PRECISION,
    DIFICMS DOUBLE PRECISION,
    DESPESASRATEADAS DOUBLE PRECISION,
    FRETERATEADO DOUBLE PRECISION,
    SEGURORATEADO DOUBLE PRECISION,
    DESCONTORATEADO DOUBLE PRECISION,
    PRECOSUGERIDO DOUBLE PRECISION,
    ATUALIZAPRECO VARCHAR(1),
    PRECOCOMPRAANTERIOR DOUBLE PRECISION,
    CODUNIDADE INTEGER,
    CODPEDCPR INTEGER,
    CODPEDCPRITENS INTEGER,
    US_CADAST VARCHAR(45),
    DT_CADAST TIMESTAMP,
    US_MODIFI VARCHAR(45),
    DT_MODIFI TIMESTAMP,
    MARKUP1 DOUBLE PRECISION,
    MARKUP2 DOUBLE PRECISION,
    MARKUP3 DOUBLE PRECISION,
    MARKUP4 DOUBLE PRECISION,
    MARKUP5 DOUBLE PRECISION,
    MARKUP6 DOUBLE PRECISION,
    VALORTOTAL DOUBLE PRECISION,
    ATZMARK CHAR(1),
    ATZPREC CHAR(1),
    VL_IPIPERC DOUBLE PRECISION,
    VL_DIFICMS DOUBLE PRECISION,
    FRETEPERCLTDA DOUBLE PRECISION,
    FRETEVLRLTDA DOUBLE PRECISION,
    IPISOBREFRETE CHAR(1),
    ICMSSOBREFRETE CHAR(1),
    FRETEAVULSO DOUBLE PRECISION,
    CUSTOREPOSI DOUBLE PRECISION,
    CODCFOP INTEGER,
    CFOP_CFOP VARCHAR(4),
    QTDEM3 DOUBLE PRECISION,
    ALIQ_SUBS DOUBLE PRECISION,
    PERC_VA DOUBLE PRECISION,
    VA_VALOR DOUBLE PRECISION,
    BASE_SUBS DOUBLE PRECISION,
    VALOR_SUBS DOUBLE PRECISION,
    PESO DOUBLE PRECISION,
    GNRE_TOTAL DOUBLE PRECISION,
    TOTAL_NOTA DOUBLE PRECISION,
    CUSTO_UNIT_IPI_GNRE DOUBLE PRECISION,
    TOTAL_FRETE_PESO DOUBLE PRECISION,
    TOTAL_FRETE_VALOR DOUBLE PRECISION,
    CUSTO_TOTAL DOUBLE PRECISION,
    CUSTO_UNITARIO DOUBLE PRECISION,
    TOTALCOMIPI DOUBLE PRECISION,
    CUSTOUNITCOMIPI DOUBLE PRECISION,
    QTD_CAIXA DOUBLE PRECISION,
    VALOR_CAIXA DOUBLE PRECISION,
    QTDPECAS DOUBLE PRECISION,
    COD_PROD_MARGEM INTEGER,
    DESCTO_ITEM DOUBLE PRECISION,
    DESCTO_ABC CHAR(1),
    NFEI_DESCAUX VARCHAR(254),
    QTD_VIACEGA DOUBLE PRECISION,
    QTD_PEDIDO DOUBLE PRECISION,
    DT_FABRICACAO TIMESTAMP,
    DT_VALIDADE TIMESTAMP,
    SITUACAO_VALIDADE VARCHAR(20),
    FATORCONVERSAO DOUBLE PRECISION,
    DESCTO_ITEM_PERC DOUBLE PRECISION,
    PERC_REDUCAO DOUBLE PRECISION,
    REDUCAO_VALOR DOUBLE PRECISION,
    AUX_PESOEMB DOUBLE PRECISION,
    DESC_PRODFILHO_AUX VARCHAR(60),
    PRECOSUGERIDO1 DOUBLE PRECISION,
    PRECOSUGERIDO2 DOUBLE PRECISION,
    PRECOSUGERIDO3 DOUBLE PRECISION,
    PRECOSUGERIDO4 DOUBLE PRECISION,
    PRECOSUGERIDO5 DOUBLE PRECISION,
    PRECOSUGERIDO6 DOUBLE PRECISION,
    CODPRODUTO INTEGER,
    DESC_PRECOPRATICADO1 DOUBLE PRECISION,
    AUX_FATORPROD DOUBLE PRECISION,
    QTDPRODEMB DOUBLE PRECISION,
    AUX_COD3 VARCHAR(7),
    UNIDADE VARCHAR(15),
    CODPESQ1 VARCHAR(30),
    CODPESQ2 VARCHAR(30),
    PISPERC DOUBLE PRECISION,
    PISVALOR DOUBLE PRECISION,
    COFINSPERC DOUBLE PRECISION,
    COFINSVALOR DOUBLE PRECISION,
    FRETESOBREIPI VARCHAR(1),
    BASE_IPI DOUBLE PRECISION,
    STATUS VARCHAR(10),
    DESC_UNIDADE VARCHAR(15),
    DESC_CFOP_CFOP VARCHAR(4),
    NCM_CODIGO VARCHAR(8),
    DESCTO_ITEM_INCIDE_ICMS VARCHAR(1),
    DESP_PERC DOUBLE PRECISION,
    DESP_VALOR DOUBLE PRECISION,
    DESP_INCIDE_ICMS VARCHAR(1),
    SEG_PERC DOUBLE PRECISION,
    SEG_VALOR DOUBLE PRECISION,
    SEG_INCIDE_ICMS VARCHAR(1),
    TOTALPROD DOUBLE PRECISION,
    BASE_ICMS DOUBLE PRECISION,
    PREDUCAOST DOUBLE PRECISION,
    VREDUCAOST DOUBLE PRECISION,
    PISCST VARCHAR(3),
    COFINSCST VARCHAR(3),
    PRDF_CST_ORIGEM_MERCADORIA VARCHAR(1),
    PRDF_CST_TRIBICMS VARCHAR(3),
    PRDF_CST_IPIENTRADA VARCHAR(2),
    BASE_PIS DOUBLE PRECISION,
    BASE_COFINS DOUBLE PRECISION,
    DESCTO_ITEM_INCIDE_IPI VARCHAR(1),
    IPI_INCIDE_BC_ICMSST VARCHAR(1),
    ST_INFORMADOMANUAL VARCHAR(1),
    IPI_INCIDE_BC_ICMS VARCHAR(1),
    SERIE BLOB SUB_TYPE TEXT SEGMENT SIZE 4096,
    IPI_INCIDE_MVA VARCHAR(1),
    CODCENTCUSTO INTEGER,
    CODMAQUINA INTEGER,
    DESCRICAOCCUSTO VARCHAR(60),
    DESCRICAOCCUSTOSMASCARA VARCHAR(60),
    DESCRICAOMAQUINA VARCHAR(60),
    DIVIDIR_PELA_ENTRADA VARCHAR(1),
    GEN_CODNFENTRADA_TEMP VARCHAR(40),
    CEAN VARCHAR(60),
    DESPFRONTPERCITEM DOUBLE PRECISION,
    VALOR_UNITARIO_DOLAR DOUBLE PRECISION,
    VALOR_DOLAR_DIA DOUBLE PRECISION,
    CODNFENTRADAITENSCOMPRA INTEGER,
    VFCPST DOUBLE PRECISION,
    VBCFCPST DOUBLE PRECISION,
    PFCPST DOUBLE PRECISION,
    VICMSDESON DOUBLE PRECISION,
    MOTDESICMS INTEGER,
    XPEDIDO VARCHAR(15),
    NITEMPED VARCHAR(6),
    IDNFENTRADAITEM VARCHAR(40),
    PESOPECA DOUBLE PRECISION)
AS
declare variable LQTDPRODEMB_CAD_PROD double precision;
begin
  for select
    NI.CODNFENTRADAITENS,
    NI.CODNFENTRADA,
    NI.CODPRODFILHO,
    NI.CODPESQUISA,
    NI.IPIPERC,
    NI.QTD,
    NI.PRODVLR,
    NI.DIFICMS,
    NI.DESPESASRATEADAS,
    NI.FRETERATEADO,
    NI.SEGURORATEADO,
    NI.DESCONTORATEADO,
    NI.PRECOSUGERIDO,
    NI.ATUALIZAPRECO,
    NI.PRECOCOMPRAANTERIOR,
    NI.CODUNIDADE,
    NI.CODPEDCPR,
    NI.CODPEDCPRITENS,
    NI.US_CADAST,
    NI.DT_CADAST,
    NI.US_MODIFI,
    NI.DT_MODIFI,
    NI.MARKUP1,
    NI.MARKUP2,
    NI.MARKUP3,
    NI.MARKUP4,
    NI.MARKUP5,
    NI.MARKUP6,
    NI.VALORTOTAL,
    NI.ATZMARK,
    NI.ATZPREC,
    NI.VL_IPIPERC,
    NI.VL_DIFICMS,
    NI.FRETEPERCLTDA,
    NI.FRETEVLRLTDA,
    NI.IPISOBREFRETE,
    NI.ICMSSOBREFRETE,
    NI.FRETEAVULSO,
    NI.CUSTOREPOSI,
    NI.CODCFOP,
    NI.CFOP_CFOP,
    NI.QTDEM3,
    NI.ALIQ_SUBS,
    NI.PERC_VA,
    NI.VA_VALOR,
    NI.BASE_SUBS,
    NI.VALOR_SUBS,
    NI.PESO,
    NI.GNRE_TOTAL,
    NI.TOTAL_NOTA,
    NI.CUSTO_UNIT_IPI_GNRE,
    NI.TOTAL_FRETE_PESO,
    NI.TOTAL_FRETE_VALOR,
    NI.CUSTO_TOTAL,
    NI.CUSTO_UNITARIO,
    NI.TOTALCOMIPI,
    NI.CUSTOUNITCOMIPI,
    NI.QTD_CAIXA,
    NI.VALOR_CAIXA,
    NI.QTDPECAS,
    NI.COD_PROD_MARGEM,
    NI.DESCTO_ITEM,
    NI.DESCTO_ABC,
    NI.NFEI_DESCAUX,
    NI.QTD_VIACEGA,
    NI.QTD_PEDIDO,
    NI.DT_FABRICACAO,
    NI.DT_VALIDADE,
    NI.SITUACAO_VALIDADE,
    NI.FATORCONVERSAO,
    NI.DESCTO_ITEM_PERC,
    coalesce(NI.PERC_REDUCAO, 0) PERC_REDUCAO,
    NI.QTDPRODEMB,
    NI.PISPERC,
    NI.PISVALOR,
    NI.COFINSPERC,
    NI.COFINSVALOR,
    NI.FRETESOBREIPI,
    NI.BASE_IPI,
    NI.STATUS,
    NI.NCM_CODIGO,
    NI.DESCTO_ITEM_INCIDE_ICMS,
    NI.DESP_PERC,
    NI.DESP_VALOR,
    NI.DESP_INCIDE_ICMS,
    NI.SEG_PERC,
    NI.SEG_VALOR,
    NI.SEG_INCIDE_ICMS,
    NI.TOTALPROD,
    NI.BASE_ICMS,
    NI.REDUCAO_VALOR,
    NI.PREDUCAOST,
    NI.VREDUCAOST,
    NI.PISCST,
    NI.COFINSCST,
    coalesce(NI.PRDF_CST_ORIGEM_MERCADORIA,'0'),
    TRIM(coalesce(NI.PRDF_CST_TRIBICMS,'')),
    NI.PRDF_CST_IPIENTRADA,
    NI.DESPFRONTVLRITEM,
    NI.BASE_PIS,
    NI.BASE_COFINS,
    NI.DESCTO_ITEM_INCIDE_IPI,
    NI.IPI_INCIDE_BC_ICMSST,
    NI.ST_INFORMADOMANUAL,
    NI.IPI_INCIDE_BC_ICMS,
    NI.SERIE,
    NI.IPI_INCIDE_MVA,
    NI.CODCENTCUSTO,
    NI.CODMAQUINA,
    CC.DESCRICAO,
    CC.CODLIVRESEMMASK,
    M.MAQUINA,
    NI.GEN_CODNFENTRADA_TEMP,
    NI.CEAN,
    NI.DESPFRONTPERCITEM,
    NI.CODNFENTRADAITENSCOMPRA,
    NI.VFCPST,
    NI.VBCFCPST,
    NI.PFCPST,
    NI.VALOR_UNITARIO_DOLAR,
    NI.VALOR_DOLAR_DIA,
    NI.VICMSDESON,
    NI.MOTDESICMS,
    NI.XPEDIDO,
    NI.NITEMPED,
    NI.IDNFENTRADAITEM,
    NI.PESOPECA
  from
    NFENTRADAITENS NI
    left join CENTCUSTO CC on
      CC.CODCENTCUSTO = NI.CODCENTCUSTO
    left join MAQUINAS M on
      M.CODMAQUINA = NI.CODMAQUINA
  where
    NI.CODNFENTRADA = :ECODNFENTRADA or
    NI.GEN_CODNFENTRADA_TEMP = :EGEN_CODNFENTRADA_TEMP
  into
    CODNFENTRADAITENS,
    CODNFENTRADA,
    CODPRODFILHO,
    CODPESQUISA,
    IPIPERC,
    QTD,
    PRODVLR,
    DIFICMS,
    DESPESASRATEADAS,
    FRETERATEADO,
    SEGURORATEADO,
    DESCONTORATEADO,
    PRECOSUGERIDO,
    ATUALIZAPRECO,
    PRECOCOMPRAANTERIOR,
    CODUNIDADE,
    CODPEDCPR,
    CODPEDCPRITENS,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    MARKUP1,
    MARKUP2,
    MARKUP3,
    MARKUP4,
    MARKUP5,
    MARKUP6,
    VALORTOTAL,
    ATZMARK,
    ATZPREC,
    VL_IPIPERC,
    VL_DIFICMS,
    FRETEPERCLTDA,
    FRETEVLRLTDA,
    IPISOBREFRETE,
    ICMSSOBREFRETE,
    FRETEAVULSO,
    CUSTOREPOSI,
    CODCFOP,
    CFOP_CFOP,
    QTDEM3,
    ALIQ_SUBS,
    PERC_VA,
    VA_VALOR,
    BASE_SUBS,
    VALOR_SUBS,
    PESO,
    GNRE_TOTAL,
    TOTAL_NOTA,
    CUSTO_UNIT_IPI_GNRE,
    TOTAL_FRETE_PESO,
    TOTAL_FRETE_VALOR,
    CUSTO_TOTAL,
    CUSTO_UNITARIO,
    TOTALCOMIPI,
    CUSTOUNITCOMIPI,
    QTD_CAIXA,
    VALOR_CAIXA,
    QTDPECAS,
    COD_PROD_MARGEM,
    DESCTO_ITEM,
    DESCTO_ABC,
    NFEI_DESCAUX,
    QTD_VIACEGA,
    QTD_PEDIDO,
    DT_FABRICACAO,
    DT_VALIDADE,
    SITUACAO_VALIDADE,
    FATORCONVERSAO,
    DESCTO_ITEM_PERC,
    PERC_REDUCAO,
    QTDPRODEMB,
    PISPERC,
    PISVALOR,
    COFINSPERC,
    COFINSVALOR,
    FRETESOBREIPI,
    BASE_IPI,
    STATUS,
    NCM_CODIGO,
    DESCTO_ITEM_INCIDE_ICMS,
    DESP_PERC,
    DESP_VALOR,
    DESP_INCIDE_ICMS,
    SEG_PERC,
    SEG_VALOR,
    SEG_INCIDE_ICMS,
    TOTALPROD,
    BASE_ICMS,
    REDUCAO_VALOR,
    PREDUCAOST,
    VREDUCAOST,
    PISCST,
    COFINSCST,
    PRDF_CST_ORIGEM_MERCADORIA,
    PRDF_CST_TRIBICMS,
    PRDF_CST_IPIENTRADA,
    DESPFRONTVLRITEM,
    BASE_PIS,
    BASE_COFINS,
    DESCTO_ITEM_INCIDE_IPI,
    IPI_INCIDE_BC_ICMSST,
    ST_INFORMADOMANUAL,
    IPI_INCIDE_BC_ICMS,
    SERIE,
    IPI_INCIDE_MVA,
    CODCENTCUSTO,
    CODMAQUINA,
    DESCRICAOCCUSTO,
    DESCRICAOCCUSTOSMASCARA,
    DESCRICAOMAQUINA,
    GEN_CODNFENTRADA_TEMP,
    CEAN,
    DESPFRONTPERCITEM,
    CODNFENTRADAITENSCOMPRA,
    VFCPST,
    VBCFCPST,
    PFCPST,
    VALOR_UNITARIO_DOLAR,
    VALOR_DOLAR_DIA,
    VICMSDESON,
    MOTDESICMS,
    XPEDIDO,
    NITEMPED,
    IDNFENTRADAITEM,
    PESOPECA
  do
  begin
    TOTAL_FRETE_PESO = coalesce(TOTAL_FRETE_PESO,0);
    TOTAL_FRETE_VALOR = coalesce(TOTAL_FRETE_VALOR,0);
    CUSTO_UNIT_IPI_GNRE = coalesce(CUSTO_UNIT_IPI_GNRE,0);

    select
      coalesce(PF.PRDF_PESOEMBALAGEM,1)  AUX_PESOEMB,
      PF.DESCRICAO  DESC_PRODFILHO_AUX,
      coalesce(PF.PRECOSUGERIDO1,0) PRECOSUGERIDO1,
      coalesce(PF.PRECOSUGERIDO2,0) PRECOSUGERIDO2,
      coalesce(PF.PRECOSUGERIDO3,0) PRECOSUGERIDO3,
      coalesce(PF.PRECOSUGERIDO4,0) PRECOSUGERIDO4,
      coalesce(PF.PRECOSUGERIDO5,0) PRECOSUGERIDO5,
      coalesce(PF.PRECOSUGERIDO6,0) PRECOSUGERIDO6,
      PF.CODPRODUTO CODPRODUTO,
      coalesce(PF.PRECOPRATICADO1,0) DESC_PRECOPRATICADO1,
      coalesce(PF.FATORCONVERSAO,0) AUX_FATORPROD,
      coalesce(PF.CODPESQ3,'') AUX_COD3,
      PF.UNIDADE,
      PF.CODPESQ1,
      PF.CODPESQ2,
      PF.QTDEMBALAGEM
    from
      PRODFILHO PF
    where
      PF.CODPRODFILHO = :CODPRODFILHO
    into
      AUX_PESOEMB,
      DESC_PRODFILHO_AUX,
      PRECOSUGERIDO1,
      PRECOSUGERIDO2,
      PRECOSUGERIDO3,
      PRECOSUGERIDO4,
      PRECOSUGERIDO5,
      PRECOSUGERIDO6,
      CODPRODUTO,
      DESC_PRECOPRATICADO1,
      AUX_FATORPROD,
      AUX_COD3,
      UNIDADE,
      CODPESQ1,
      CODPESQ2,
      LQTDPRODEMB_CAD_PROD;

    select
      U.SIGLA,
      coalesce(U.DIVIDIR_PELA_ENTRADA, 'N')
    from
      UNIDADE U
    where
      U.CODUNIDADE = :CODUNIDADE
    into
      DESC_UNIDADE,
      DIVIDIR_PELA_ENTRADA;

    select
      C.CFOP
    from
      CFOP C
    where
      C.CODCFOP = :CODCFOP
    into
      DESC_CFOP_CFOP;
    suspend;
  end
end^

SET TERM ; ^

-- SRIGHT

SET TERM ^ ;

ALTER TRIGGER TRG_ORC_MARMORE_BU
AS
begin
  if ((old.STATUS = 0) and (new.STATUS = 1)) then
  begin
    NEW.NRCONTRATO = RIGHT('0000'||extract(year from current_date),4)||RIGHT('00'||extract(month from current_date),2)||RIGHT('00000'||gen_id(GEN_ORC_MARMORE_FAT, 1),4);
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE BLT_AT_REMESSA_RECEBIMENTO(
    ECODCONTA INTEGER,
    ECODRECEBIMENTO INTEGER,
    ESEQREMESSA INTEGER,
    ELOCAL_ARQUIVO VARCHAR(100))
AS
declare variable LNOSSONUMERO varchar(100);
begin
  in autonomous transaction do
  begin
    select
      NRDOCUMENTO_BOLETO
    from
      CONTA
    where
      CODCONTA = :ECODRECEBIMENTO
    into
      LNOSSONUMERO;

    insert into CONTA_REMESSA (
      CODCONTA,
      DT_ENVIO,
      NRREMESSA,
      LOCAL_ARQUIVO,
      NOSSO_NUMERO,
      CODBANCO)
    values(
      :ECODRECEBIMENTO,
      current_timestamp,
      RIGHT('0000000000'||:ESEQREMESSA, 10),
      :ELOCAL_ARQUIVO,
      :LNOSSONUMERO,
      :ECODCONTA);

      update conta set boletoimpresso = 'E'
      where conta.codconta =:ECODRECEBIMENTO;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_LISTAR_SUPERVISOR(
    EFILTRO VARCHAR(100))
RETURNS (
    ATIVO INTEGER,
    CODSUPERVISOR INTEGER,
    CPFCGC VARCHAR(18),
    DT_ADMISSAO VARCHAR(10),
    CODSTATUS INTEGER,
    NOME VARCHAR(60),
    PERCCOMISS DOUBLE PRECISION,
    PERCCOMISS2 DOUBLE PRECISION,
    DT_NASC VARCHAR(10),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    COMPLEMENTO_1 VARCHAR(60),
    UF_1 VARCHAR(2),
    FONES VARCHAR(42),
    CELULAR VARCHAR(14),
    EMAIL VARCHAR(45),
    CODSUPERVISORGERAL INTEGER)
AS
BEGIN
    FOR SELECT 
      S.ATIVO,
      S.CODSUPERVISOR,
      S.CPFCGC,
      EXTRACT(YEAR FROM S.DT_ADMISSAO) || '-' || RIGHT('00'||EXTRACT(MONTH FROM S.DT_ADMISSAO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM S.DT_ADMISSAO),2),
    S.CODSTATUS,
      S.NOME,
      S.PERCCOMISS,
    S.PERCCOMISS2,
    EXTRACT(YEAR FROM S.DT_NASC) || '-' || RIGHT('00'||EXTRACT(MONTH FROM S.DT_NASC),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM S.DT_NASC),2),
    S.CEP_1,
    S.LOGRADOURO_1,
    S.BAIRRO_1,
    S.CIDADE_1,
    S.COMPLEMENTO_1,
    S.UF_1,
    S.FONES,
    S.CELULAR,
    S.EMAIL,
    S.CODSUPERVISORGERAL 
    FROM 
      SUPERVISOR S 
      WHERE UPPER(S.NOME) CONTAINING(UPPER(:EFILTRO))
    INTO
      :ATIVO,
      :CODSUPERVISOR,
      :CPFCGC,
      :DT_ADMISSAO,
      :CODSTATUS,
      :NOME,
      :PERCCOMISS,
    :PERCCOMISS2,
    :DT_NASC,
    :CEP_1,
    :LOGRADOURO_1,
    :BAIRRO_1,
    :CIDADE_1,
    :COMPLEMENTO_1,
    :UF_1,
    :FONES,
    :CELULAR,
    :EMAIL,
    :CODSUPERVISORGERAL
     
    DO
    BEGIN       
      SUSPEND;
    END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_LISTAR_SUPERVISOR_ATIVO
RETURNS (
    ATIVO INTEGER,
    CODSUPERVISOR INTEGER,
    CPFCGC VARCHAR(18),
    DT_ADMISSAO VARCHAR(10),
    CODSTATUS INTEGER,
    NOME VARCHAR(60),
    PERCCOMISS DOUBLE PRECISION,
    PERCCOMISS2 DOUBLE PRECISION,
    DT_NASC VARCHAR(10),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    COMPLEMENTO_1 VARCHAR(60),
    UF_1 VARCHAR(2),
    FONES VARCHAR(42),
    CELULAR VARCHAR(14),
    EMAIL VARCHAR(45),
    CODSUPERVISORGERAL INTEGER)
AS
BEGIN
    FOR SELECT 
      S.ATIVO,
      S.CODSUPERVISOR,
      S.CPFCGC,
      EXTRACT(YEAR FROM S.DT_ADMISSAO) || '-' || RIGHT('00'||EXTRACT(MONTH FROM S.DT_ADMISSAO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM S.DT_ADMISSAO),2),
    S.CODSTATUS,
      S.NOME,
      S.PERCCOMISS,
    S.PERCCOMISS2,
    EXTRACT(YEAR FROM S.DT_NASC) || '-' || RIGHT('00'||EXTRACT(MONTH FROM S.DT_NASC),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM S.DT_NASC),2),
    S.CEP_1,
    S.LOGRADOURO_1,
    S.BAIRRO_1,
    S.CIDADE_1,
    S.COMPLEMENTO_1,
    S.UF_1,
    S.FONES,
    S.CELULAR,
    S.EMAIL,
    S.CODSUPERVISORGERAL 
    FROM 
      SUPERVISOR S 
      WHERE S.ATIVO = 2
    INTO
      :ATIVO,
      :CODSUPERVISOR,
      :CPFCGC,
      :DT_ADMISSAO,
      :CODSTATUS,
      :NOME,
      :PERCCOMISS,
    :PERCCOMISS2,
    :DT_NASC,
    :CEP_1,
    :LOGRADOURO_1,
    :BAIRRO_1,
    :CIDADE_1,
    :COMPLEMENTO_1,
    :UF_1,
    :FONES,
    :CELULAR,
    :EMAIL,
    :CODSUPERVISORGERAL
     
    DO
    BEGIN       
      SUSPEND;
    END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_LISTAR_VENDEDOR(
    EATIVO SMALLINT,
    ECODSUPERVISOR INTEGER)
RETURNS (
    CODVENDEDOR INTEGER,
    NOME VARCHAR(60),
    CPFCGC VARCHAR(18),
    DT_NASC VARCHAR(10),
    ATIVO SMALLINT,
    LOGRADOURO_1 VARCHAR(60),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    TIPOVENDEDOR CHAR(1),
    DT_ADMISSAO VARCHAR(10),
    DT_DEMISSAO VARCHAR(10),
    CODSTATUS INTEGER,
    DESCRICAO_STATUS VARCHAR(60),
    CODEMPRESA INTEGER,
    DESCRICAO_EMPRESA VARCHAR(60),
    URL_FOTO VARCHAR(500),
    PRECO1 CHAR(1),
    PRECO2 CHAR(1),
    PRECO3 CHAR(1),
    PRECO4 CHAR(1),
    PRECO5 CHAR(1),
    PRECO6 CHAR(1),
    CODSUPERVISOR INTEGER,
    NOMESUPERVISOR VARCHAR(60),
    CODDIVISAOVENDAS INTEGER,
    DESCDIVISAOVENDAS VARCHAR(100),
    CAPACIDADE SMALLINT,
    CODVEND_APOIO INTEGER,
    NOMEVEND_APOIO VARCHAR(60))
AS
BEGIN
    FOR SELECT 
    V.CODVENDEDOR,
    V.NOME,
    V.CPFCGC,
    EXTRACT(YEAR FROM V.DT_NASC)||'-'||RIGHT('00'||EXTRACT(MONTH FROM V.DT_NASC),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM V.DT_NASC),2) DT_NASC,
    V.ATIVO,
    V.LOGRADOURO_1,
    V.COMPLEMENTO_1,
    V.BAIRRO_1,
    V.CIDADE_1,
    V.UF_1,
    V.CEP_1,
    V.TIPOVENDEDOR,
    EXTRACT(YEAR FROM V.DT_ADMISSAO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM V.DT_ADMISSAO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM V.DT_ADMISSAO),2) DT_ADMISSAO ,
    EXTRACT(YEAR FROM V.DT_DEMISSAO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM V.DT_DEMISSAO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM V.DT_ADMISSAO),2) DT_DEMISSAO,
    COALESCE(V.CODSTATUS, 1),
    COALESCE (S.DESCRICAO,''),
    COALESCE(V.CODEMPRESA, 0),
    COALESCE(E.EMPRESA, ''),
    V.FOTO,
    V.PRECO1,
    V.PRECO2,
    V.PRECO3,
    V.PRECO4,
    V.PRECO5,
    V.PRECO6,
    D.CODSUPERVISOR,
    D.NOME,
    V.CODDIVISAOVENDAS,
    DV.DESCRICAO,
    V.CAPACIDADE,
    V.CODVEND_APOIO,
    VA.NOME
    FROM 
      VENDEDOR V 
     LEFT JOIN STATUS S ON
       V.CODSTATUS = S.CODSTATUS
     LEFT JOIN EMPRESA E ON
       V.CODEMPRESA = E.CODEMPRESA
     LEFT JOIN DIVISAOVENDAS DV ON
       V.CODDIVISAOVENDAS = DV.CODDIVISAOVENDAS
     LEFT JOIN VENDEDOR VA ON
       V.CODVEND_APOIO = VA.CODVENDEDOR
     LEFT JOIN SUPERVISOR D ON
       D.CODSUPERVISOR = V.CODSUPERVISOR
     WHERE
      (
        :EATIVO IS NULL OR
        (:EATIVO IS not NULL and V.ATIVO = 2)
      )
      and (
        :ECODSUPERVISOR is null or
        V.CODSUPERVISOR = :ECODSUPERVISOR
      )
    INTO
      :CODVENDEDOR ,
      :NOME,
      :CPFCGC,
      :DT_NASC,
      :ATIVO,
      :LOGRADOURO_1,
      :COMPLEMENTO_1,
      :BAIRRO_1,
      :CIDADE_1,
      :UF_1,
      :CEP_1,
      :TIPOVENDEDOR,
      :DT_ADMISSAO,
      :DT_DEMISSAO,
      :CODSTATUS,
      :DESCRICAO_STATUS,
      :CODEMPRESA,
      :DESCRICAO_EMPRESA,
      :URL_FOTO,
      :PRECO1,
      :PRECO2,
      :PRECO3,
      :PRECO4,
      :PRECO5,
      :PRECO6,
      :CODSUPERVISOR,
      :NOMESUPERVISOR,
      :CODDIVISAOVENDAS,
      :DESCDIVISAOVENDAS,
      :CAPACIDADE,
      :CODVEND_APOIO,
      :NOMEVEND_APOIO
    DO
    BEGIN         
      SUSPEND;
    END    
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_MVPEDIDO(
    EIDPEDIDO VARCHAR(40))
RETURNS (
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    STATUSPED VARCHAR(10),
    TIPOPED VARCHAR(10),
    DTFATURADO VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    OBS3 VARCHAR(100),
    CODNFVENDA INTEGER,
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1),
    IDVENDA VARCHAR(40),
    OUTRASINF BLOB SUB_TYPE TEXT SEGMENT SIZE 80)
AS
DECLARE VARIABLE LCODEMPRESA INTEGER;
DECLARE VARIABLE LSQL BLOB SUB_TYPE 1 SEGMENT SIZE 80;
BEGIN
  IF (EXISTS(SELECT 1 FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_MVPEDIDO')) THEN
  BEGIN
    SELECT SQL FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_MVPEDIDO' INTO LSQL;
    FOR EXECUTE STATEMENT 
      (LSQL)
      (EIDPEDIDO := :EIDPEDIDO)
    INTO
      CODPEDVEND, 
      CODTIPOPAG, 
      STATUSPED, 
      TIPOPED, 
      DTFATURADO, 
      DT_SAIDA, 
      DT_ENTREGA, 
      DT_ENTREGAPREV, 
      H_ENTREGAPREV, 
      TIPOPAG, 
      FORMA_PAGAMENTO, 
      CODPESSOA, 
      CPFCNPJ_CLIENTE, 
      NOME_CLIENTE, 
      NOMEFANTAZIA, 
      CEP_1, 
      LOGRADOURO_1, 
      NUMERO_1, 
      BAIRRO_1, 
      CIDADE_1, 
      UF_1, 
      FONES, 
      EMAIL_CLIENTE, 
      IE, 
      PESSOA_CONTATO, 
      CODVENDEDOR, 
      NOME_VENDEDOR, 
      OBS1, 
      OBS2, 
      OBS3, 
      CODNFVENDA, 
      VALOR_BRUTO, 
      DESCONTO, 
      DESCPERC_VALOR, 
      DESC_VALOR, 
      ACRESVALOR, 
      FRETE, 
      VALOR_TOTAL, 
      EMPRESA_CNPJ, 
      EMPRESA_RAZAO, 
      EMPRESA_FANTAZIA, 
      EMPRESA_CEP, 
      EMPRESA_LOGRADOURO, 
      EMPRESA_NUMERO, 
      EMPRESA_BAIRRO, 
      EMPRESA_CIDADE, 
      EMPRESA_UF, 
      EMPRESA_FONES, 
      EMPRESA_EMAIL, 
      ENTREGUE, 
      IDVENDA, 
      OUTRASINF
    DO
    BEGIN
      SUSPEND;
    END
    EXIT;
  END

  FOR SELECT 
    PEDVEND.CODPEDVEND,
    PEDVEND.CODPESSOA,
    PEDVEND.STATUSPED, 
    PEDVEND.TIPOPED,
    EXTRACT(YEAR FROM PEDVEND.DT_ENTREGAPREV)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGAPREV),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGAPREV),2),
    RIGHT('00'||EXTRACT(HOUR FROM PEDVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM PEDVEND.DT_ENTREGAPREV),2),
    EXTRACT(YEAR FROM PEDVEND.DTFATURADO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DTFATURADO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DTFATURADO),2),
    EXTRACT(YEAR FROM PEDVEND.DT_SAIDA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_SAIDA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_SAIDA),2),
  EXTRACT(YEAR FROM PEDVEND.DT_ENTREGA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGA),2),
    PESSOA.CPFCGC,
    COALESCE(NULLIF(PEDVEND.NOME,''), PESSOA.NOME),
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    PEDVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    COALESCE(PEDVEND.OBSPED1,''),
    COALESCE(PEDVEND.OBSPED2,''),
    COALESCE(PEDVEND.OBSPED3,''),
    COALESCE(PEDVEND.CODNFVENDA, 0) CODNFVENDA,
    PEDVEND.VALOR_BRUTO,
    COALESCE(PEDVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(PEDVEND.ACRESVALOR, 0) ACRESVALOR,
    COALESCE(PEDVEND.FRETE, 0) FRETE,
    PEDVEND.VALOR_TOTAL,
    PEDVEND.CODTIPOPAG,
    PEDVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(PEDVEND.DESCONTO,0),
    COALESCE(PEDVEND.DESCPERC_VALOR, 0),
    COALESCE(PEDVEND.ENTREGUE,'N'),
    PEDVEND.GEN_TEMPESTOQTEMP,
    PEDVEND.CODEMPRESA
  FROM
    PEDVEND
    JOIN PESSOA ON
      PEDVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    LEFT JOIN TIPOPAG ON 
      PEDVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
  WHERE
    (PEDVEND.GEN_TEMPESTOQTEMP = :EIDPEDIDO
    OR CAST(PEDVEND.CODPEDVEND AS VARCHAR(40)) = :EIDPEDIDO) 
 ORDER BY
    PEDVEND.DT_ENTREGAPREV DESC
  INTO
    CODPEDVEND,
    CODPESSOA,
    STATUSPED, 
    TIPOPED,
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DTFATURADO,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    OBS3,
    CODNFVENDA,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    IDVENDA,
    LCODEMPRESA
  DO
  BEGIN
    SELECT
      EMPRESA.CGC ,
      EMPRESA.RAZAOSOCIAL ,
      EMPRESA.EMPRESA ,
      EMPRESA.CEP ,    
      EMPRESA.LOGRADOURO ,
      EMPRESA.NUMERO ,
      EMPRESA.BAIRRO ,
      EMPRESA.CIDADE,
      EMPRESA.UF    ,
      EMPRESA.FONES,
      EMPRESA.EMAIL    
    FROM 
      EMPRESA
    WHERE 
      CODEMPRESA = :LCODEMPRESA
    INTO 
      EMPRESA_CNPJ,
      EMPRESA_RAZAO,
      EMPRESA_FANTAZIA,
      EMPRESA_CEP,
      EMPRESA_LOGRADOURO,
      EMPRESA_NUMERO,
      EMPRESA_BAIRRO,
      EMPRESA_CIDADE,
      EMPRESA_UF,
      EMPRESA_FONES,
      EMPRESA_EMAIL;    
    OUTRASINF = '';
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_ORCAMENTO(
    EIDORCVEND VARCHAR(40))
RETURNS (
    IDORCVEND VARCHAR(40),
    CODORCVEND INTEGER,
    IDVENDA VARCHAR(40),
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    STATUSORC VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    OBS3 VARCHAR(100),
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    ACRESCIMO DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    EMPRESA_CODEMPRESA VARCHAR(60),
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1))
AS
DECLARE VARIABLE LCODVENDEDOR INTEGER;
BEGIN
  FOR SELECT 
    TBL_ORCVEND.CODORCVEND,
    TBL_ORCVEND.CODPEDVEND,
    TBL_ORCVEND.CODPESSOA,
    TBL_ORCVEND.STATUSORC, 
    EXTRACT(YEAR FROM TBL_ORCVEND.DT_ENTREGAPREV)||'-'||RIGHT('00'||EXTRACT(MONTH FROM TBL_ORCVEND.DT_ENTREGAPREV),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM TBL_ORCVEND.DT_ENTREGAPREV),2),
    RIGHT('00'||EXTRACT(HOUR FROM TBL_ORCVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM TBL_ORCVEND.DT_ENTREGAPREV),2),
    EXTRACT(YEAR FROM TBL_ORCVEND.DT_SAIDA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM TBL_ORCVEND.DT_SAIDA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM TBL_ORCVEND.DT_SAIDA),2),
    EXTRACT(YEAR FROM TBL_ORCVEND.DT_ENTREGA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM TBL_ORCVEND.DT_ENTREGA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM TBL_ORCVEND.DT_ENTREGA),2),
    PESSOA.CPFCGC,
    PESSOA.NOME,
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    TBL_ORCVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    COALESCE(TBL_ORCVEND.OBSORC1,''),
    COALESCE(TBL_ORCVEND.OBSORC2,''),
    COALESCE(TBL_ORCVEND.OBSORC3,''),
    TBL_ORCVEND.VALOR_BRUTO,
    COALESCE(TBL_ORCVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(TBL_ORCVEND.ACRESVALOR, 0) ACRESVALOR,
    COALESCE(TBL_ORCVEND.ACRESCIMO, 0) ACRESCIMO,    
    COALESCE(TBL_ORCVEND.FRETE,0 ) FRETE,
    TBL_ORCVEND.VALOR_TOTAL,
    TBL_ORCVEND.CODTIPOPAG,
    TBL_ORCVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(TBL_ORCVEND.DESCONTO,0),
    COALESCE(TBL_ORCVEND.DESCPERC_VALOR, 0),
    COALESCE(TBL_ORCVEND.ENTREGUE,'N'),
    TBL_ORCVEND.IDORCVEND,
    TBL_ORCVEND.CODEMPRESA
  FROM
    TBL_ORCVEND
    JOIN PESSOA ON
      TBL_ORCVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      TBL_ORCVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    LEFT JOIN TIPOPAG ON 
      TBL_ORCVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
  WHERE
    (TBL_ORCVEND.IDORCVEND = :EIDORCVEND
    OR CAST(TBL_ORCVEND.CODORCVEND AS VARCHAR(40)) = :EIDORCVEND) 
 ORDER BY
    TBL_ORCVEND.DT_ENTREGAPREV DESC
 INTO
    CODORCVEND,
    CODPEDVEND,
    CODPESSOA,
    STATUSORC, 
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    OBS3,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    ACRESCIMO,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    IDORCVEND,
    EMPRESA_CODEMPRESA
  DO
  BEGIN
    SELECT GEN_TEMPESTOQTEMP  FROM PEDVEND WHERE CODPEDVEND  = :CODPEDVEND INTO IDVENDA;   
    SELECT
      EMPRESA.CGC ,
      EMPRESA.RAZAOSOCIAL ,
      EMPRESA.EMPRESA ,
      EMPRESA.CEP ,    
      EMPRESA.LOGRADOURO ,
      EMPRESA.NUMERO ,
      EMPRESA.BAIRRO ,
      EMPRESA.CIDADE,
      EMPRESA.UF    ,
      EMPRESA.FONES,
      EMPRESA.EMAIL    
    FROM 
      EMPRESA
    WHERE 
      CODEMPRESA = :EMPRESA_CODEMPRESA
    INTO 
      EMPRESA_CNPJ,
      EMPRESA_RAZAO,
      EMPRESA_FANTAZIA,
      EMPRESA_CEP,
      EMPRESA_LOGRADOURO,
      EMPRESA_NUMERO,
      EMPRESA_BAIRRO,
      EMPRESA_CIDADE,
      EMPRESA_UF,
      EMPRESA_FONES,
      EMPRESA_EMAIL;    
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_ORCAMENTOS(
    EEMAIL VARCHAR(100),
    EFILTROCLIENTE VARCHAR(100),
    EFILTROPEDIDO VARCHAR(100),
    EDATAINICIO DATE,
    EDATAFIM DATE,
    EFILTROSTATUS VARCHAR(1),
    ECOVENDEDOR INTEGER = 0)
RETURNS (
    CODORCVEND INTEGER,
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    IDORCVEND VARCHAR(40),
    STATUSORC VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    OBS3 VARCHAR(100),
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1),
    IDVENDA VARCHAR(40))
AS
DECLARE VARIABLE LCODEMPRESA INTEGER;
BEGIN
  SELECT CODEMPRESA FROM USERCAD WHERE EMAIL = :EEMAIL INTO LCODEMPRESA;
 
  SELECT
    EMPRESA.CGC ,
    EMPRESA.RAZAOSOCIAL ,
    EMPRESA.EMPRESA ,
    EMPRESA.CEP ,    
    EMPRESA.LOGRADOURO ,
    EMPRESA.NUMERO ,
    EMPRESA.BAIRRO ,
    EMPRESA.CIDADE,
    EMPRESA.UF    ,
    EMPRESA.FONES,
    EMPRESA.EMAIL    
  FROM 
    EMPRESA
  WHERE 
    CODEMPRESA = :LCODEMPRESA
  INTO 
    EMPRESA_CNPJ,
    EMPRESA_RAZAO,
    EMPRESA_FANTAZIA,
    EMPRESA_CEP,
    EMPRESA_LOGRADOURO,
    EMPRESA_NUMERO,
    EMPRESA_BAIRRO,
    EMPRESA_CIDADE,
    EMPRESA_UF,
    EMPRESA_FONES,
    EMPRESA_EMAIL;

  FOR SELECT 
    TBL_ORCVEND.CODORCVEND,
    TBL_ORCVEND.CODPEDVEND,
    TBL_ORCVEND.CODPESSOA,
    TBL_ORCVEND.IDORCVEND,
    TBL_ORCVEND.STATUSORC, 
    DATETOSTRING(TBL_ORCVEND.DT_ENTREGAPREV),
    RIGHT('00'||EXTRACT(HOUR FROM TBL_ORCVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM TBL_ORCVEND.DT_ENTREGAPREV),2),
    DATETOSTRING(TBL_ORCVEND.DT_SAIDA),
    DATETOSTRING(TBL_ORCVEND.DT_ENTREGA),
    PESSOA.CPFCGC,
    PESSOA.NOME,
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    TBL_ORCVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    COALESCE(TBL_ORCVEND.OBSORC1,''),
    COALESCE(TBL_ORCVEND.OBSORC2,''),
    COALESCE(TBL_ORCVEND.OBSORC3,''),
    TBL_ORCVEND.VALOR_BRUTO,
    COALESCE(TBL_ORCVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(TBL_ORCVEND.ACRESVALOR, 0) ACRESVALOR,
    COALESCE(TBL_ORCVEND.FRETE,0 ) FRETE,
    TBL_ORCVEND.VALOR_TOTAL,
    TBL_ORCVEND.CODTIPOPAG,
    TBL_ORCVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(TBL_ORCVEND.DESCONTO,0),
    COALESCE(TBL_ORCVEND.DESCPERC_VALOR, 0),
    COALESCE(TBL_ORCVEND.ENTREGUE,'N'),
    TBL_ORCVEND.IDORCVEND,
    TBL_ORCVEND.CODEMPRESA
  FROM
    TBL_ORCVEND
    JOIN PESSOA ON
      TBL_ORCVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      TBL_ORCVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    LEFT JOIN TIPOPAG ON 
      TBL_ORCVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
  WHERE
    (
      (CAST(TBL_ORCVEND.CODORCVEND AS VARCHAR(100)) = :EFILTROPEDIDO) OR
      (
        (:EFILTROPEDIDO = '') AND
        (
          (:EFILTROSTATUS = 'T') OR
          ((:EFILTROSTATUS = 'C') AND (TBL_ORCVEND.STATUSORC = 'CANCELADO')) OR
          ((:EFILTROSTATUS = 'F') AND (TBL_ORCVEND.STATUSORC = 'FATURADO')) OR
          ((:EFILTROSTATUS = 'N') AND (TBL_ORCVEND.STATUSORC = 'NORMAL'))
        )
        AND (
          (:EFILTROCLIENTE = '') OR
          (PESSOA.NOME CONTAINING :EFILTROCLIENTE) OR
          (REPLACE(REPLACE(REPLACE(PESSOA.CPFCGC,'.',''),'/',''),'-','') CONTAINING :EFILTROCLIENTE) OR
          (CAST(PESSOA.CODPESSOA AS VARCHAR(60)) CONTAINING :EFILTROCLIENTE) OR
          (TBL_ORCVEND.CODORCVEND CONTAINING :EFILTROCLIENTE)
        )
        AND (
          CAST(TBL_ORCVEND.DT_SAIDA AS DATE) BETWEEN :EDATAINICIO AND :EDATAFIM
        )
      )
    )
    AND ((:ECOVENDEDOR = 0) OR (TBL_ORCVEND.CODVENDEDOR = :ECOVENDEDOR))
 ORDER BY
    TBL_ORCVEND.DT_ENTREGAPREV DESC
 INTO
    CODORCVEND,
    CODPEDVEND,
    CODPESSOA,
    IDORCVEND,
    STATUSORC, 
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    OBS3,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    IDVENDA,
    LCODEMPRESA
  DO
  BEGIN
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_PEDIDO(
    EIDPEDIDO VARCHAR(40))
RETURNS (
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    STATUSPED VARCHAR(10),
    TIPOPED VARCHAR(10),
    DTFATURADO VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    OBS3 VARCHAR(100),
    CODNFVENDA INTEGER,
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    ACRESCIMO DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    ENTREGA_CEP VARCHAR(9),
    ENTREGA_LOGRADOURO VARCHAR(60),
    ENTREGA_NUMERO VARCHAR(30),
    ENTREGA_BAIRRO VARCHAR(45),
    ENTREGA_CIDADE VARCHAR(45),
    ENTREGA_UF VARCHAR(2),
    EMPRESA_CODEMPRESA INTEGER,
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1),
    TIPOFRETE VARCHAR(1),
    IDVENDA VARCHAR(40),
    OUTRASINF BLOB SUB_TYPE BINARY SEGMENT SIZE 80,
    CODTIPOPED INTEGER,
    DT_CADAST VARCHAR(10),
    VALOR_PESOVAR DOUBLE PRECISION,
    PRECOPRATICADO VARCHAR(10),
    STATUSEXPEDICAO VARCHAR(11),
    DTCANCELA VARCHAR(10),
    US_CANCELOU VARCHAR(45),
    OBS_CACELAMENTO VARCHAR(200))
AS
declare variable LSQL blob sub_type 1 segment size 80;
BEGIN
  
   IF (EXISTS(SELECT 1 FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_PEDIDO')) THEN
  BEGIN
    SELECT SQL FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_PEDIDO' INTO LSQL;
    FOR EXECUTE STATEMENT 
      (LSQL)
      (EIDPEDIDO := :EIDPEDIDO)
    INTO
      CODPEDVEND, 
      CODTIPOPAG, 
      STATUSPED, 
      TIPOPED, 
      DTFATURADO, 
      DT_SAIDA, 
      DT_ENTREGA, 
      DT_ENTREGAPREV, 
      H_ENTREGAPREV, 
      TIPOPAG, 
      FORMA_PAGAMENTO, 
      CODPESSOA, 
      CPFCNPJ_CLIENTE, 
      NOME_CLIENTE, 
      NOMEFANTAZIA, 
      CEP_1, 
      LOGRADOURO_1, 
      NUMERO_1, 
      BAIRRO_1, 
      CIDADE_1, 
      UF_1, 
      FONES, 
      EMAIL_CLIENTE, 
      IE, 
      PESSOA_CONTATO, 
      CODVENDEDOR, 
      NOME_VENDEDOR, 
      OBS1, 
      OBS2, 
      OBS3, 
      CODNFVENDA, 
      VALOR_BRUTO, 
      DESCONTO, 
      DESCPERC_VALOR, 
      DESC_VALOR, 
      ACRESVALOR, 
      FRETE, 
      VALOR_TOTAL, 
      EMPRESA_CODEMPRESA,
      EMPRESA_CNPJ, 
      EMPRESA_RAZAO, 
      EMPRESA_FANTAZIA, 
      EMPRESA_CEP, 
      EMPRESA_LOGRADOURO, 
      EMPRESA_NUMERO, 
      EMPRESA_BAIRRO, 
      EMPRESA_CIDADE, 
      EMPRESA_UF, 
      EMPRESA_FONES, 
      EMPRESA_EMAIL, 
      ENTREGUE, 
      IDVENDA,
      OUTRASINF,
      CODTIPOPED,
      DT_CADAST,
      VALOR_PESOVAR,
      PRECOPRATICADO,
      STATUSEXPEDICAO,
      DTCANCELA,
      US_CANCELOU,
      OBS_CACELAMENTO
    DO
    BEGIN
      SUSPEND;
    END
    EXIT;
  END
  
  
  FOR SELECT 
    PEDVEND.CODPEDVEND,
    PEDVEND.CODPESSOA,
    PEDVEND.STATUSPED, 
    PEDVEND.TIPOPED,
    EXTRACT(YEAR FROM PEDVEND.DT_ENTREGAPREV)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGAPREV),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGAPREV),2),
    RIGHT('00'||EXTRACT(HOUR FROM PEDVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM PEDVEND.DT_ENTREGAPREV),2),
    EXTRACT(YEAR FROM PEDVEND.DTFATURADO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DTFATURADO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DTFATURADO),2),
    EXTRACT(YEAR FROM PEDVEND.DT_SAIDA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_SAIDA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_SAIDA),2),
    EXTRACT(YEAR FROM PEDVEND.DT_ENTREGA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGA),2),
    PESSOA.CPFCGC,
    COALESCE(NULLIF(PEDVEND.NOME,''), PESSOA.NOME),
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    PEDVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    COALESCE(PEDVEND.OBSPED1,''),
    COALESCE(PEDVEND.OBSPED2,''),
    COALESCE(PEDVEND.OBSPED3,''),
    COALESCE(PEDVEND.CODNFVENDA, 0) CODNFVENDA,
    PEDVEND.VALOR_BRUTO,
    COALESCE(PEDVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(PEDVEND.ACRESVALOR , 0) ACRESVALOR,
    COALESCE(PEDVEND.ACRESCIMO , 0) ACRESCIMO,
    COALESCE(PEDVEND.FRETE, 0) FRETE,
    PEDVEND.VALOR_TOTAL,
    PEDVEND.CODTIPOPAG,
    PEDVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(PEDVEND.DESCONTO,0),
    COALESCE(PEDVEND.DESCPERC_VALOR, 0),
    COALESCE(PEDVEND.ENTREGUE,'N'),
    PEDVEND.TIPOFRETE,
    PEDVEND.GEN_TEMPESTOQTEMP,
    PEDVEND.CODEMPRESA,  
    COALESCE(PEDVEND_ENDERECO.CEP, PESSOA.CEP_1),
    COALESCE(PEDVEND_ENDERECO.LOGRADOURO, PESSOA.LOGRADOURO_1),
    COALESCE(PEDVEND_ENDERECO.NUMERO, PESSOA.NUMERO_1),
    COALESCE(PEDVEND_ENDERECO.BAIRRO, PESSOA.BAIRRO_1),
    COALESCE(PEDVEND_ENDERECO.MUNICIPIO, PESSOA.CIDADE_1), 
    COALESCE(PEDVEND_ENDERECO.UF, PESSOA.UF_1),
    TIPOVENDA.CODTIPOPED,
    EXTRACT(YEAR FROM PEDVEND.DT_CADAST)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_CADAST),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_CADAST),2),
    PEDVEND.PRECOUSADO,
    PEDVEND.STATUSEXPEDICAO,
    EXTRACT(YEAR FROM PEDVEND.DTCANCELA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DTCANCELA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DTCANCELA),2),
    PEDVEND.US_CANCELOU,
    COALESCE(PEDVEND.OBS1,'') || COALESCE(PEDVEND.OBS2,'')
  FROM
    PEDVEND
    JOIN PESSOA ON
      PEDVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    JOIN TIPOVENDA ON
      PEDVEND.TIPOPED = TIPOVENDA.TIPOPED
    LEFT JOIN TIPOPAG ON 
      PEDVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
    LEFT JOIN PEDVEND_ENDERECO ON
      PEDVEND_ENDERECO.CODPEDVEND = PEDVEND.CODPEDVEND      
  WHERE
    PEDVEND.GEN_TEMPESTOQTEMP = :EIDPEDIDO
 ORDER BY
    PEDVEND.DT_ENTREGAPREV DESC
  INTO
    CODPEDVEND,
    CODPESSOA,
    STATUSPED, 
    TIPOPED,
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DTFATURADO,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    OBS3,
    CODNFVENDA,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    ACRESCIMO,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    TIPOFRETE,
    IDVENDA,
    EMPRESA_CODEMPRESA,
    ENTREGA_CEP,
    ENTREGA_LOGRADOURO,
    ENTREGA_NUMERO,
    ENTREGA_BAIRRO,
    ENTREGA_CIDADE,
    ENTREGA_UF,
    CODTIPOPED,
    DT_CADAST,
    PRECOPRATICADO,
    STATUSEXPEDICAO,
    DTCANCELA,
    US_CANCELOU,
    OBS_CACELAMENTO
  DO
  begin
    
    SELECT 
      sum(SIMPLEROUNDTO( ( (PEDVENDITEM.QTDE * PEDVENDITEM.PRECOPROD) * (PRODFILHO.TOLERANCIA_PECA / 100) ), -2))
    FROM 
      PEDVENDITEM 
      JOIN PRODFILHO ON
        PEDVENDITEM.CODPRODFILHO  = PRODFILHO.CODPRODFILHO 
        AND PRODFILHO.FLAG_PESOVARIAVEL = 'S'
    WHERE 
      PEDVENDITEM.CODPEDVEND = :CODPEDVEND 
    into 
      VALOR_PESOVAR;
        
    SELECT
      EMPRESA.CGC ,
      EMPRESA.RAZAOSOCIAL ,
      EMPRESA.EMPRESA ,
      EMPRESA.CEP ,    
      EMPRESA.LOGRADOURO ,
      EMPRESA.NUMERO ,
      EMPRESA.BAIRRO ,
      EMPRESA.CIDADE,
      EMPRESA.UF    ,
      EMPRESA.FONES,
      EMPRESA.EMAIL    
    FROM 
      EMPRESA
    WHERE 
      CODEMPRESA = :EMPRESA_CODEMPRESA
    INTO 
      EMPRESA_CNPJ,
      EMPRESA_RAZAO,
      EMPRESA_FANTAZIA,
      EMPRESA_CEP,
      EMPRESA_LOGRADOURO,
      EMPRESA_NUMERO,
      EMPRESA_BAIRRO,
      EMPRESA_CIDADE,
      EMPRESA_UF,
      EMPRESA_FONES,
      EMPRESA_EMAIL;  
    OUTRASINF = '';
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_PEDIDOS_FILTRADOS(
    EEMAIL VARCHAR(100),
    EENTREGUE VARCHAR(1),
    EFILTROCLIENTE VARCHAR(100),
    EFILTROPEDIDO VARCHAR(100),
    EDATAINICIO DATE,
    EDATAFIM DATE,
    ECODVENDEDOR INTEGER = 0)
RETURNS (
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    STATUSPED VARCHAR(10),
    TIPOPED VARCHAR(10),
    DTFATURADO VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    CODNFVENDA INTEGER,
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1),
    IDVENDA VARCHAR(40))
AS
DECLARE VARIABLE LCODEMPRESA INTEGER;
BEGIN
  SELECT CODEMPRESA FROM USERCAD WHERE EMAIL = :EEMAIL INTO LCODEMPRESA;
 
  SELECT
    EMPRESA.CGC ,
    EMPRESA.RAZAOSOCIAL ,
    EMPRESA.EMPRESA ,
    EMPRESA.CEP ,    
    EMPRESA.LOGRADOURO ,
    EMPRESA.NUMERO ,
    EMPRESA.BAIRRO ,
    EMPRESA.CIDADE,
    EMPRESA.UF    ,
    EMPRESA.FONES,
    EMPRESA.EMAIL    
  FROM 
    EMPRESA
  WHERE 
    CODEMPRESA = :LCODEMPRESA
  INTO 
    EMPRESA_CNPJ,
  EMPRESA_RAZAO,
  EMPRESA_FANTAZIA,
  EMPRESA_CEP,
  EMPRESA_LOGRADOURO,
  EMPRESA_NUMERO,
  EMPRESA_BAIRRO,
  EMPRESA_CIDADE,
  EMPRESA_UF,
  EMPRESA_FONES,
  EMPRESA_EMAIL;


FOR SELECT 
    PEDVEND.CODPEDVEND,
    PEDVEND.CODPESSOA,
    PEDVEND.STATUSPED, 
    PEDVEND.TIPOPED,
    EXTRACT(YEAR FROM PEDVEND.DT_ENTREGAPREV)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGAPREV),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGAPREV),2),
    RIGHT('00'||EXTRACT(HOUR FROM PEDVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM PEDVEND.DT_ENTREGAPREV),2),
    EXTRACT(YEAR FROM PEDVEND.DTFATURADO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DTFATURADO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DTFATURADO),2),
    EXTRACT(YEAR FROM PEDVEND.DT_SAIDA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_SAIDA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_SAIDA),2),
  EXTRACT(YEAR FROM PEDVEND.DT_ENTREGA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGA),2),
    PESSOA.CPFCGC,
    COALESCE(NULLIF(PEDVEND.NOME,''), PESSOA.NOME),
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    PEDVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    PEDVEND.OBS1,
    PEDVEND.OBS2,
    COALESCE(PEDVEND.CODNFVENDA, 0) CODNFVENDA,
    PEDVEND.VALOR_BRUTO,
    COALESCE(PEDVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(PEDVEND.ACRESVALOR, 0) ACRESVALOR,
    COALESCE(PEDVEND.FRETE, 0) FRETE,    
    PEDVEND.VALOR_TOTAL,
    PEDVEND.CODTIPOPAG,
    PEDVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(PEDVEND.DESCONTO,0),
    COALESCE(PEDVEND.DESCPERC_VALOR, 0),
    COALESCE(PEDVEND.ENTREGUE,'N'),
    PEDVEND.GEN_TEMPESTOQTEMP,
    PEDVEND.CODEMPRESA
  FROM
    PEDVEND
    JOIN PESSOA ON
      PEDVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    LEFT JOIN TIPOPAG ON 
      PEDVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
  WHERE
    (
      (CAST(PEDVEND.CODPEDVEND AS VARCHAR(100)) = :EFILTROPEDIDO) OR
      (
        (:EFILTROPEDIDO = '')
        AND (PEDVEND.STATUSPED <> 'CANCELADO')
        AND (:EENTREGUE = 'T' OR PEDVEND.ENTREGUE = :EENTREGUE)
        AND (
          (:EFILTROCLIENTE = '') OR
          (COALESCE(NULLIF(PEDVEND.NOME,''), PESSOA.NOME) CONTAINING :EFILTROCLIENTE) OR
          (REPLACE(REPLACE(REPLACE(PESSOA.CPFCGC,'.',''),'/',''),'-','') CONTAINING :EFILTROCLIENTE) OR
          (PESSOA.CODPESSOA CONTAINING :EFILTROCLIENTE)
        ) 
        AND PEDVEND.TIPOPED IN ('VENDA', 'CADERNO', 'DELIVERY')
        AND PEDVEND.STATUSPED IN ('FATURADO', 'NORMAL')
        AND CAST(PEDVEND.DT_ENTREGAPREV AS DATE) BETWEEN :EDATAINICIO AND :EDATAFIM
      )
    )
    AND ((:ECODVENDEDOR = 0) OR (PEDVEND.CODVENDEDOR = :ECODVENDEDOR))
 ORDER BY
    PEDVEND.DT_ENTREGAPREV DESC
 INTO
    CODPEDVEND,
    CODPESSOA,
    STATUSPED, 
    TIPOPED,
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DTFATURADO,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    CODNFVENDA,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    IDVENDA,
    LCODEMPRESA
  DO
  BEGIN
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DIACCERA_ENTRADAS(
    EDATAINI DATE,
    EDATAFIM DATE,
    ECOD INTEGER)
RETURNS (
    CPFCGC VARCHAR(18),
    CNPJDISTRIBUIDOR VARCHAR(18),
    DOCUMENTO VARCHAR(15),
    STATUS CHAR(1),
    TOTNOTVLR INTEGER,
    QTD VARCHAR(30),
    DTEMISSAO VARCHAR(8),
    DTENTRADA VARCHAR(8))
AS
DECLARE VARIABLE LFABRICANTES VARCHAR(100);
DECLARE VARIABLE LGRUPOS VARCHAR(500);
BEGIN
  SELECT COALESCE(CODFABRICANTE,''), COALESCE(CODGRUPOS,'') FROM INTEGRACAOARQ WHERE IDINTEGRACAOARQ = :ECOD INTO LFABRICANTES, LGRUPOS;
  LFABRICANTES = TRIM(REPLACE(LFABRICANTES,' ',''));
  LGRUPOS = TRIM(REPLACE(LGRUPOS,' ',''));

  SELECT
    TIRARMASCARA(EMPRESA.CGC)
  FROM
    EMPRESA
    JOIN INTEGRACAOARQ ON
      EMPRESA.CODEMPRESA = INTEGRACAOARQ.CODEMPRESA
  WHERE
    IDINTEGRACAOARQ = :ECOD
  INTO
    CNPJDISTRIBUIDOR;

  FOR SELECT
    TIRARMASCARA(P.CPFCGC),
    N.DOCUMENTO,
    CASE
      WHEN N.NFE_TIPO = 'ENTRADA' THEN 'E'
    ELSE
      'R'
    END STATUS,
    CAST(N.TOTNOTVLR AS INTEGER) TOTNOTVLR,
    CAST(SUM(NI.QTD) AS INTEGER) QTD,
    (EXTRACT( YEAR FROM N.DTEMISSAO) || RIGHT('00' || EXTRACT(MONTH FROM N.DTEMISSAO), 2) || RIGHT('00' || EXTRACT(DAY FROM N.DTEMISSAO), 2)) AS DTEMISSAO,
    (EXTRACT( YEAR FROM N.DTENTRADA) || RIGHT('00' || EXTRACT(MONTH FROM N.DTENTRADA), 2) || RIGHT('00' || EXTRACT(DAY FROM N.DTENTRADA), 2)) AS DTENTRADA
  FROM
    NFENTRADA N
    JOIN PESSOA P ON
      N.CODPESSOA = P.CODPESSOA
    JOIN NFENTRADAITENS NI ON
      N.CODNFENTRADA = NI.CODNFENTRADA
    join prodfilho pf on
      ni.CODPRODFILHO = pf.CODPRODFILHO
    join produto pr on
      pf.CODPRODUTO = pr.CODPRODUTO
  WHERE
    CAST(N.DT_CADAST AS DATE) BETWEEN :EDATAINI AND :EDATAFIM
    AND (
      :LFABRICANTES = '' OR
      ','||:LFABRICANTES||',' CONTAINING ','||PR.CODFABRICANTE||','
    )
    AND (
      :LGRUPOS = '' OR
      ','||:LGRUPOS||',' CONTAINING ','||PR.CODGRUPO||','
    )
  GROUP BY
    1,2,3,4,6,7
  INTO
    :CPFCGC,
    :DOCUMENTO,
    :STATUS,
    :TOTNOTVLR,
    :QTD,
    :DTEMISSAO,
    :DTENTRADA
  DO
  BEGIN
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DIACCERA_ESTOQUE(
    EDATAINI DATE,
    EDATAFIM DATE,
    ECOD INTEGER)
RETURNS (
    CNPJDISTRIBUIDOR VARCHAR(18),
    CNPJEMPRESA VARCHAR(18),
    DUN VARCHAR(30),
    QTDESTOQUE VARCHAR(30),
    DATA VARCHAR(8),
    LOTE VARCHAR(200),
    DTVAL VARCHAR(8),
    CODGRUPO INTEGER,
    CODPRODFIHO INTEGER)
AS
declare variable LQTDEMBALAGEM double precision;
declare variable LQTDESTOQUE double precision;
declare variable LFABRICANTES varchar(100);
declare variable LGRUPOS varchar(500);
BEGIN
  SELECT COALESCE(CODFABRICANTE,''), COALESCE(CODGRUPOS,'') FROM INTEGRACAOARQ WHERE IDINTEGRACAOARQ = :ECOD INTO LFABRICANTES, LGRUPOS;
  LFABRICANTES = TRIM(REPLACE(LFABRICANTES,' ',''));
  LGRUPOS = TRIM(REPLACE(LGRUPOS,' ',''));

  SELECT
    TIRARMASCARA(EMPRESA.CGC)
  FROM
    EMPRESA
    JOIN INTEGRACAOARQ ON
      EMPRESA.CODEMPRESA = INTEGRACAOARQ.CODEMPRESA
  WHERE
    IDINTEGRACAOARQ = :ECOD
  INTO
    CNPJDISTRIBUIDOR;

  FOR SELECT
    PRODFILHO.CODPRODFILHO,
    TIRARMASCARA(PESSOA.CPFCGC),
    COALESCE(PRODFILHO.CODPESQ2,PRODFILHO.CODPRODFILHO) DUN,
    PRODFILHO.QTDEMBALAGEM,
    (EXTRACT(YEAR FROM CURRENT_DATE) || RIGHT('00' || EXTRACT(MONTH FROM CURRENT_DATE), 2) || RIGHT('00' || EXTRACT(DAY FROM CURRENT_DATE), 2)) AS DATA,
    PRODFILHO.ESTQATUAL,
    PRODUTO.CODGRUPO
  FROM
     PRODFILHO
     JOIN PRODUTO ON
       (PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO)
     JOIN PESSOA ON
      (PESSOA.CODPESSOA = PRODUTO.CODFABRICANTE)
  where
    (
      :LFABRICANTES = '' OR
      ','||:LFABRICANTES||',' CONTAINING ','||PRODUTO.CODFABRICANTE||','
    )
    AND (
      :LGRUPOS = '' OR
      ','||:LGRUPOS||',' CONTAINING ','||PRODUTO.CODGRUPO||','
    )
  INTO
    :CODPRODFIHO,
    :CNPJEMPRESA,
    :DUN,
    :LQTDEMBALAGEM,
    :DATA,
    :LQTDESTOQUE,
    :CODGRUPO
  DO
  BEGIN
    IF (COALESCE(LQTDEMBALAGEM,0) > 1) THEN
    BEGIN
      LQTDESTOQUE = LQTDESTOQUE / LQTDEMBALAGEM;
    END

    QTDESTOQUE = cast(trunc(LQTDESTOQUE * 1000) as integer);

    IF (LQTDESTOQUE > 0) THEN
      SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DIACCERA_VENDAS(
    EDATAINI DATE,
    EDATAFIM DATE,
    ECOD INTEGER)
RETURNS (
    DUN VARCHAR(30),
    CNPJCLIENTE VARCHAR(18),
    CLIENTE VARCHAR(60),
    CODSEGMENTO INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA VARCHAR(20),
    TIPOPED VARCHAR(10),
    TIPOPESSOA VARCHAR(1),
    PDV_EMPRESA VARCHAR(60),
    PDV_CEP VARCHAR(9),
    NOME_VENDEDOR VARCHAR(60),
    CODNFVENDA VARCHAR(14),
    VLRVENDIDO VARCHAR(30),
    QTDVENDIDA VARCHAR(30),
    QTDEMBALAGEM INTEGER,
    TIPOCODIGO VARCHAR(10),
    CODGRUPO INTEGER,
    CODPESSOA INTEGER,
    CODSTATUS_CHECKOUT INTEGER,
    ATIVIDADE VARCHAR(60),
    CODPRODFILHO INTEGER,
    PRODUTO VARCHAR(60),
    QTD NUMERIC(15,2),
    QTDUNIDADE NUMERIC(15,2),
    VALOR NUMERIC(15,2),
    CODSUPERVISOR INTEGER,
    CNPJFABRICANTE VARCHAR(20))
AS
declare variable DTINI date;
declare variable LFABRICANTES varchar(100);
declare variable LGRUPOS varchar(500);
BEGIN
  SELECT COALESCE(CODFABRICANTE,''), COALESCE(CODGRUPOS,'') FROM INTEGRACAOARQ WHERE IDINTEGRACAOARQ = :ECOD INTO LFABRICANTES, LGRUPOS;
  LFABRICANTES = TRIM(REPLACE(LFABRICANTES,' ',''));
  LGRUPOS = TRIM(REPLACE(LGRUPOS,' ',''));

  SELECT
    TIRARMASCARA(EMPRESA.CGC),
    TIRARMASCARA(EMPRESA.CEP)
  FROM
    EMPRESA
    JOIN INTEGRACAOARQ ON
      EMPRESA.CODEMPRESA = INTEGRACAOARQ.CODEMPRESA
  WHERE
    IDINTEGRACAOARQ = :ECOD
  INTO
    CNPJDISTRIBUIDOR,
    PDV_CEP;

  FOR SELECT
   CASE COALESCE(PRODFILHO.CODPESQ2 ,'')
      WHEN '' THEN
        PRODFILHO.CODPRODFILHO
      ELSE
        PRODFILHO.CODPESQ2
    END DUN,
    TIRARMASCARA(PESSOA.CPFCGC) CNPJCLIENTE,
    PESSOA.NOME CLIENTE,
    PESSOA.NOME,
    TIRARMASCARA(PESSOA.CEP_1),
    CASE COALESCE(TBL_RAMOATVTIPO.REFERENCIA,'')
      WHEN '' THEN 0
      ELSE TBL_RAMOATVTIPO.REFERENCIA
      END CODSEGMENTOPEPSICO,
    PEDVEND.CODVENDEDOR,
    (EXTRACT(YEAR FROM COALESCE(PEDVEND.DTFATURADO, PEDVEND.DT_SAIDA)) || RIGHT('00'||EXTRACT(MONTH FROM COALESCE(PEDVEND.DTFATURADO, PEDVEND.DT_SAIDA)),2) || RIGHT('00'||EXTRACT(DAY FROM COALESCE(PEDVEND.DTFATURADO, PEDVEND.DT_SAIDA)),2)) AS DATAVENDA,
    CASE
      WHEN PEDVEND.STATUSPED = 'CANCELADO' THEN 'C'
      WHEN PEDVEND.STATUSPED = 'DEVOLVIDO' THEN 'DV'
      WHEN ((PEDVEND.STATUSPED = 'FATURADO') AND (PEDVEND.TIPOPED IN ('VENDA','CADERNO'))) THEN 'V'
      WHEN ((PEDVEND.STATUSPED = 'FATURADO') AND (PEDVEND.TIPOPED = 'BONIFICA')) THEN 'B'
      WHEN ((PEDVEND.STATUSPED = 'FATURADO') AND (PEDVEND.TIPOPED IN ('TRANSFERENCIA','REMESSA F.')))  THEN 'T'
    END AS TIPOPED,
    COALESCE(PEDVEND.CODNFVENDA,PEDVEND.CODPEDVEND),
    PESSOA.PESSOA,
    COALESCE(NULLIF(PRODFILHO.QTDEMBALAGEM,1),1),
    CAST(CAST(SUM(((COALESCE(PEDVENDITEM.PRECOPROD,0) * COALESCE(PEDVENDITEM.QTDENTREGUE,1))
    + (((COALESCE(PEDVEND.ACRESVALOR,0) + (COALESCE(PEDVEND.VALOR_BRUTO,0) * (COALESCE(PEDVEND.ACRESCIMO,0)/100))) * (COALESCE(PEDVENDITEM.PRECOVEND,0) / COALESCE(NULLIF(PEDVEND.VALOR_BRUTO,1),1))))
    ) - (((COALESCE(PEDVEND.DESC_VALOR,0) + COALESCE(PEDVEND.DESCPERC_VALOR,0)) * (COALESCE(PEDVENDITEM.PRECOVEND,0) / COALESCE(NULLIF(PEDVEND.VALOR_BRUTO,1),1))) + COALESCE(PEDVENDITEM.DESCONTO_VALOR,0))) AS NUMERIC(18,2)) AS VARCHAR(30)) AS VLRVENDIDO,
    CAST(SUM(COALESCE(PEDVENDITEM.QTDE,0)) AS NUMERIC(18,5)) AS QTDVENDIDA,
    PRODUTO.CODGRUPO,
    PEDVEND.CODPESSOA,
    PESSOA.CODSTATUS_CHECKOUT,
    PRODFILHO.CODPRODFILHO,
    PRODFILHO.DESCRICAO
  FROM
    PEDVEND
    JOIN PESSOA ON (PESSOA.CODPESSOA = PEDVEND.CODPESSOA)
    LEFT JOIN TBL_RAMOATVTIPO ON (PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO)
    JOIN PEDVENDITEM ON PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
    JOIN PRODFILHO ON PEDVENDITEM.CODPRODFILHO =  PRODFILHO.CODPRODFILHO
    JOIN PRODUTO ON PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
  WHERE
    PEDVEND.STATUSPED in ('FATURADO','CANCELADO', 'DEVOLVIDO') AND
    PEDVEND.TIPOPED IN ('VENDA','CADERNO','BONIFICA','DEVOLUO') AND
    COALESCE(PEDVEND.DTFATURADO, PEDVEND.DT_SAIDA) BETWEEN :EDATAINI AND :EDATAFIM
    AND (
      :LFABRICANTES = '' OR
      ','||:LFABRICANTES||',' CONTAINING ','||PRODUTO.CODFABRICANTE||','
    )
    AND (
      :LGRUPOS = '' OR
      ','||:LGRUPOS||',' CONTAINING ','||PRODUTO.CODGRUPO||','
    )
  GROUP BY
    1,2,3,4,5,6,7,8,9,10,11,12,15,16,17,18,19
  INTO
    :DUN,
    :CNPJCLIENTE,
    :CLIENTE,
    :PDV_EMPRESA,
    :PDV_CEP,
    :CODSEGMENTO,
    :CODVENDEDOR,
    :DATAVENDA,
    :TIPOPED,
    :CODNFVENDA,
    :TIPOPESSOA,
    :QTDEMBALAGEM,
    :VALOR,
    :QTD,
    :CODGRUPO,
    :CODPESSOA,
    :CODSTATUS_CHECKOUT,
    :CODPRODFILHO,
    PRODUTO
  DO
  BEGIN
    IF (STRLEN(DUN) > 13) THEN
    BEGIN
       QTDUNIDADE = QTD * QTDEMBALAGEM;
       QTDVENDIDA = CAST(((QTD * QTDEMBALAGEM) * 1000) AS INTEGER);
       TIPOCODIGO = 'DUN';
    END
    ELSE
    BEGIN
       QTDUNIDADE = QTD;
       QTDVENDIDA = CAST((QTD * 1000) AS INTEGER);
       TIPOCODIGO = 'EAN';
    END

    VLRVENDIDO = CAST((VALOR * 100) AS INTEGER);

    CODSUPERVISOR = 0;

    SELECT
      VENDEDOR.CODVENDEDOR || ' - ' || VENDEDOR.NOME,
      VENDEDOR.CODSUPERVISOR
    FROM
      VENDEDOR
    WHERE
      VENDEDOR.CODVENDEDOR = :CODVENDEDOR
    INTO
      :NOME_VENDEDOR,
      :CODSUPERVISOR;

    ATIVIDADE = '';

    SELECT STATUS.DESCRICAO FROM STATUS WHERE STATUS.CODSTATUS = :CODSTATUS_CHECKOUT INTO :ATIVIDADE;

    IF (ATIVIDADE = 'S.M. 05 A 09') THEN
    BEGIN
      ATIVIDADE = '5 A 9 CKS';
    END
    ELSE
    BEGIN
      ATIVIDADE = 'TRADICIONAL';
    END
    
    IF (COALESCE(CNPJCLIENTE,'') = '') THEN
    BEGIN
      CNPJCLIENTE = '11111111111111';
    END

    CNPJFABRICANTE = '50955707000472';

    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_CLIENTES
RETURNS (
    CNPJPDV VARCHAR(100),
    RAZAO_PDV VARCHAR(60),
    NOME_FANTASIA_PDV VARCHAR(60),
    PAIS_PDV VARCHAR(3),
    ESTADO_PDV VARCHAR(2),
    CIDADE_PDV VARCHAR(60),
    BAIRRO_PDV VARCHAR(60),
    ENDERECO_PDV VARCHAR(120),
    NOME_VENDEDOR VARCHAR(60),
    DT_CADASTRO VARCHAR(8),
    CEP_PDV VARCHAR(18),
    STATUS_PDV VARCHAR(1),
    CNPJDISTRIBUIDOR VARCHAR(100),
    EMAIL VARCHAR(45))
AS
BEGIN
  FOR select
    PESSOA.CPFCGC,
    PESSOA.NOME,
    PESSOA.NOMEFANTAZIA,
    'BRA',
    PESSOA.UF_1,
    PESSOA.CIDADE_1,
    PESSOA.BAIRRO_1,
    PESSOA.LOGRADOURO_1,
  vendedor.codvendedor  || ' - ' || VENDEDOR.NOME,
    extract(year from PESSOA.DT_CADAST)|| RIGHT('00' || extract(month from PESSOA.DT_CADAST), 2) || RIGHT('00' || extract(day from PESSOA.DT_CADAST), 2),
    (SELECT F.STRRESULT FROM FU_GETTIRAMASCARA(PESSOA.CEP_1) F) CEP_1,
    case
      when PESSOA.ATIVO = '2' then 'A' else 'I'
    end as ATIVO,
    PESSOA.EMAIL
  from
    PESSOA
      join VENDEDOR on VENDEDOR.CODVENDEDOR = PESSOA.CODVENDEDOR
  where
    PESSOA.TIPOPESSOA = 'Cliente'
  into
    :CNPJPDV,
    :RAZAO_PDV,
    :NOME_FANTASIA_PDV,
    :PAIS_PDV,
    :ESTADO_PDV,
    :CIDADE_PDV,
    :BAIRRO_PDV,
    :ENDERECO_PDV,
    :NOME_VENDEDOR,
    :DT_CADASTRO,
    :CEP_PDV,
    :STATUS_PDV,
    :EMAIL
  DO
  BEGIN
    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:CNPJPDV)
    into
      CNPJPDV;

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;

    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_ENTRADAS(
    INI DATE,
    FIM DATE)
RETURNS (
    CPFCGC VARCHAR(18),
    DOCUMENTO VARCHAR(15),
    STATUS CHAR(1),
    TOTNOTVLR INTEGER,
    QTD VARCHAR(30),
    DTEMISSAO VARCHAR(8),
    DTENTRADA VARCHAR(8))
AS
declare variable LCPFCGC varchar(18);
BEGIN
  FOR
    select
    P.CPFCGC,
    n.documento,
    CASE n.nfe_tipo
    WHEN 'ENTRADA' THEN 'E'
    ELSE
    'R'
    END STATUS,
    cast(n.totnotvlr as integer) totnotvlr,
    cast(sum(ni.qtd) as integer) QTD,
    (extract( year from n.dtemissao) || RIGHT('00' || extract(month from n.dtemissao), 2) || RIGHT('00' || extract(day from n.dtemissao), 2)) as dtemissao,
    (extract( year from n.dtentrada) || RIGHT('00' || extract(month from n.dtentrada), 2) || RIGHT('00' || extract(day from n.dtentrada), 2)) as dtentrada
    
    
    from
    nfentrada n join pessoa p on
    n.codpessoa = p.codpessoa
    join nfentradaitens ni on
    n.codnfentrada = ni.codnfentrada
    where
    cast(n.dt_cadast as date) between :ini and :fim
    group by
    1,2,3,4,6,7
    INTO :LCPFCGC,
         :DOCUMENTO,
         :STATUS,
         :TOTNOTVLR,
         :QTD,
         :DTEMISSAO,
         :DTENTRADA

  DO
  BEGIN
   SELECT F.STRRESULT FROM FU_GETTIRAMASCARA(:LCPFCGC) F
         INTO cpfcgc;
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_ESTOQUE(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    CNPJDISTRIBUIDOR VARCHAR(18),
    CNPJEMPRESA VARCHAR(18),
    DUN VARCHAR(30),
    QTDESTOQUE VARCHAR(30),
    DATA VARCHAR(8),
    LOTE VARCHAR(200),
    DTVAL VARCHAR(8))
AS
declare variable DTINI date;
declare variable DTFIM timestamp;
declare variable LCODPRODFILHO integer;
declare variable LQTDEMBALAGEM double precision;
declare variable LQTDESTOQUE double precision;
declare variable LESTOQUELOTE varchar(1);
begin
  DTINI = '01.'||extract(month from current_date)||'.'||extract(year from current_date);
  EDATAINI = cast(coalesce(EDATAINI,DTINI) as date);
  DTFIM = cast(coalesce(cast(EDATAFIM as timestamp),current_timestamp) as timestamp);

  for select
    PRODFILHO.CODPRODFILHO,
    PESSOA.CPFCGC,
    coalesce(PRODFILHO.CODPESQ2,PRODFILHO.CODPRODFILHO) DUN,
    PRODFILHO.QTDEMBALAGEM,
    (extract(year from current_date) || RIGHT('00' || extract(month from current_date), 2) || RIGHT('00' || extract(day from current_date), 2)) as DATA,
    PRODFILHOLOTES.LOTE,
    (extract( year from PRODFILHOLOTES.DATAVAL) || RIGHT('00' || extract(month from PRODFILHOLOTES.DATAVAL), 2) || RIGHT('00' || extract(day from PRODFILHOLOTES.DATAVAL), 2)) as DATAVAL,
    PRODFILHO.ESTOQUELOTE
  from
    PRODUTO
      join PRODFILHO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
      join PRODPESSOA on PRODPESSOA.CODPRODUTO = PRODUTO.CODPRODUTO
      join PESSOA on ((PESSOA.CODPESSOA = PRODPESSOA.CODPESSOA) and (PESSOA.TIPOPESSOA = 'Fornecedor'))
      Join prodfilholotes on prodfilho.codprodfilho = prodfilholotes.codprodfilho
  into
    LCODPRODFILHO,
    :CNPJEMPRESA,
    :DUN,
    :LQTDEMBALAGEM,
    :DATA,
    :lote,
    :dtval,
    :lestoquelote
  do
  begin
    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:CNPJEMPRESA)
    into
      :CNPJEMPRESA;
     if (lestoquelote = 'S') then
     begin
    select
      cast(SALDOFINAL as integer)
    from
      STP_MOVESTOQUE_RESUMO_LOTE(:LCODPRODFILHO,:DTFIM,:lote)
    into
      LQTDESTOQUE;
      end
      else
      begin
        select
      cast(SALDOFINAL as integer)
    from
      STP_MOVESTOQUE_RESUMO(:LCODPRODFILHO,:EDATAINI,:DTFIM)
    into
      LQTDESTOQUE;
      end


    if (coalesce(LQTDESTOQUE,0) > 0) then
      QTDESTOQUE = coalesce(cast(LQTDESTOQUE / coalesce(nullif(LQTDEMBALAGEM,1),1) as integer),0);

    QTDESTOQUE = coalesce(QTDESTOQUE,0);
   /* QTDESTOQUE = cast((cast(QTDESTOQUE as double precision) * 1000) as integer); */

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_PRODUTOS
RETURNS (
    CNPJ_FABRICANTE VARCHAR(100),
    DESC_FABRICANTE VARCHAR(100),
    COD_PRODUTO INTEGER,
    DESC_PRODUTO VARCHAR(100),
    COD_GRUPO INTEGER,
    DESC_GRUPO VARCHAR(100),
    COD_FAMILIA VARCHAR(18),
    DESC_FAMILIA VARCHAR(60),
    COD_SUBFAMILIA VARCHAR(18),
    DESC_SUBFAMILIA VARCHAR(60),
    TIPO_CODBARRAS VARCHAR(1),
    CODBARRAS VARCHAR(30),
    TIPO_EMBALAGEM VARCHAR(20),
    UNIDADE_PRODUTO VARCHAR(8),
    VOLUME_EMBALAGEM VARCHAR(15),
    STATUS_PRODUTO VARCHAR(1),
    DT_CADASTRO VARCHAR(8),
    CNPJDISTRIBUIDOR VARCHAR(100))
AS
BEGIN
  FOR select
    PESSOA.CPFCGC,
    PESSOA.NOME,
    PRODFILHO.CODPRODFILHO,
    PRODFILHO.DESCRICAO,
    PRODUTO.CODGRUPO,
    GRUPO.DESCRICAO,
    '' COD_FAMILIA,
    '' DESC_FAMILIA,
    '' COD_SUBFAMILIA,
    '' DESC_SUBFAMILIA,
    'E' TIPO_CODBARRAS,
    PRODFILHO.CODPESQ2,
    substring(PRODFILHO.UNIDADE from 1 for 8),
/*    UNIDADE.DESCRICAO, */
    'UN' SIGLA,
    PRODFILHO.QTDEMBALAGEM,
    case
      when PRODUTO.ATIVO = '2' then 'A' else 'I'
    end as STATUS_PRODUTO,
    (extract(year from PRODFILHO.DT_CADAST) || RIGHT('00' || extract(month from PRODFILHO.DT_CADAST), 2) || RIGHT('00' || extract(day from PRODFILHO.DT_CADAST), 2)) as DATA
  from
    PRODUTO
     join PRODFILHO on PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
     join PESSOA on ((PESSOA.CODPESSOA = PRODUTO.CODFABRICANTE) and (PESSOA.TIPOPESSOA = 'Fornecedor'))
     join GRUPO on GRUPO.CODGRUPO = PRODUTO.CODGRUPO
     join UNIDADE on UNIDADE.CODUNIDADE = PRODFILHO.CODUNIDADE
  INTO
    :CNPJ_FABRICANTE,
    :DESC_FABRICANTE,
    :COD_PRODUTO,
    :DESC_PRODUTO,
    :COD_GRUPO,
    :DESC_GRUPO,
    :COD_FAMILIA,
    :DESC_FAMILIA,
    :COD_SUBFAMILIA,
    :DESC_SUBFAMILIA,
    :TIPO_CODBARRAS,
    :CODBARRAS,
    :TIPO_EMBALAGEM,
    :UNIDADE_PRODUTO,
    :VOLUME_EMBALAGEM,
    :STATUS_PRODUTO,
    :DT_CADASTRO
  DO
  BEGIN
    VOLUME_EMBALAGEM = cast((cast(VOLUME_EMBALAGEM as double precision) * 1000) as integer);
    select
      STRRESULT
    from
       FU_GETTIRAMASCARA(:CNPJ_FABRICANTE)
    into
      CNPJ_FABRICANTE;

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;

    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_VENDAS(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    DUN VARCHAR(30),
    CNPJCLIENTE VARCHAR(18),
    CLIENTE VARCHAR(60),
    CODSEGMENTO INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA VARCHAR(8),
    TIPOPED VARCHAR(10),
    TIPOPESSOA VARCHAR(1),
    PDV_EMPRESA VARCHAR(60),
    PDV_CEP VARCHAR(9),
    NOME_VENDEDOR VARCHAR(60),
    CODNFVENDA VARCHAR(14),
    VLRVENDIDO VARCHAR(30),
    QTDVENDIDA VARCHAR(30),
    LOTE VARCHAR(200),
    DATAVAL VARCHAR(8),
    QTD INTEGER,
    CFOP VARCHAR(4))
AS
declare variable DTINI date;
begin
  DTINI = '01.'||extract(month from current_date)||'.'||extract(year from current_date);
  EDATAINI = cast(coalesce(EDATAINI,DTINI) as date);
  EDATAFIM = cast(coalesce(EDATAFIM,current_date) as date);
  for select
   case coalesce(PRODFILHO.CODPESQ2 ,'')
      when '' then
        PRODFILHO.CODPRODFILHO
      else
        PRODFILHO.CODPESQ2
    end DUN,
    PESSOA.CPFCGC CNPJCLIENTE,
    PESSOA.NOME CLIENTE,
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    case coalesce(TBL_RAMOATVTIPO.referencia,'')
      when '' THEN 0
      else TBL_RAMOATVTIPO.referencia
      end CODSEGMENTOPEPSICO,
    PEDVEND.CODVENDEDOR,
    (extract(year from PEDVEND.DTFATURADO) || RIGHT('00'||extract(month from PEDVEND.DTFATURADO),2) || RIGHT('00'||extract(day from PEDVEND.DTFATURADO),2)) as DATAVENDA,
    case
      when ((PEDVEND.TIPOPED = 'VENDA') or (PEDVEND.TIPOPED = 'CADERNO'))  then 'V'
      when PEDVEND.TIPOPED = 'BONIFICA' then 'B'
      when ((PEDVEND.TIPOPED = 'DEVOLUO') or (PEDVEND.TIPOPED = 'DEVOLUCAO'))  then 'DV'
      when PEDVEND.TIPOPED = 'CANCELAMENTO' then 'C'
      when ((PEDVEND.TIPOPED = 'TRANSFERENCIA') or (PEDVEND.TIPOPED = 'REMESSA F.'))  then 'T'
    end as TIPOPED,
    nfvenda.CODNFVENDA,
    PESSOA.PESSOA,
    cast(cast(sum(((coalesce(PEDVENDITEM.PRECOPROD,0) * coalesce(PEDVENDITEM.QTDENTREGUE,1))
    + (((coalesce(PEDVEND.ACRESVALOR,0) + (coalesce(PEDVEND.VALOR_BRUTO,0) * (coalesce(PEDVEND.ACRESCIMO,0)/100))) * (coalesce(PEDVENDITEM.PRECOVEND,0) / coalesce(nullif(PEDVEND.VALOR_BRUTO,1),1))))
    ) - (((coalesce(PEDVEND.DESC_VALOR,0) + coalesce(PEDVEND.DESCPERC_VALOR,0)) * (coalesce(PEDVENDITEM.PRECOVEND,0) / coalesce(nullif(PEDVEND.VALOR_BRUTO,1),1))) + coalesce(PEDVENDITEM.DESCONTO_VALOR,0))) as numeric(18,2)) as varchar(30)) as VLRVENDIDO,
    cast(cast(sum(coalesce(PEDVENDITEM.QTDE,0) / coalesce(nullif(PRODFILHO.QTDEMBALAGEM,1),1)) as numeric(18,5)) as varchar(30)) as QTDVENDIDA,
    nfvendaitem.cfop_cfop,
    nfvendaitemlote.lote,
     (extract( year from nfvendaitemlote.DATAVAL) || RIGHT('00' || extract(month from nfvendaitemlote.DATAVAL), 2) || RIGHT('00' || extract(day from nfvendaitemlote.DATAVAL), 2)) as DATAVAL,
    CAST(nfvendaitemlote.qtd AS integer)qtd

  from
    PEDVEND
    join PESSOA on (PESSOA.CODPESSOA = PEDVEND.CODPESSOA)
    join TBL_RAMOATVTIPO on (PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO)
    join PEDVENDITEM on PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
    join PRODFILHO on PEDVENDITEM.CODPRODFILHO =  PRODFILHO.CODPRODFILHO
    join PRODUTO on PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
    join nfvenda on pedvend.codnfvenda = nfvenda.codnfvenda
    join nfvendaitem on nfvenda.codnfvenda = nfvendaitem.codnfvenda
    join nfvendaitemlote on nfvendaitem.codnfvendaitem = nfvendaitemlote.codnfvendaitem
  where
    PEDVEND.STATUSPED = 'FATURADO' and
    PEDVEND.TIPOPED in ('VENDA','CADERNO') and
    cast(PEDVEND.DTFATURADO as date) between :EDATAINI and :EDATAFIM
  group by 
     1,2,3,4,5,6,7,8,9,10,11,14,15,16,17
  into
    :DUN,
    :CNPJCLIENTE,
    :CLIENTE,
    :PDV_EMPRESA,
    :PDV_CEP,
    :CODSEGMENTO,
    :CODVENDEDOR,
    :DATAVENDA,
    :TIPOPED,
    :CODNFVENDA,
    :TIPOPESSOA,
    :VLRVENDIDO,
    :QTDVENDIDA,
    :cfop, 
    :LOTE,
    :DATAVAL,
    :QTD
  do
  begin
    QTDVENDIDA = cast((cast(QTDVENDIDA as double precision) * 1000) as integer);
    select
      VENDEDOR.NOME
    from
      VENDEDOR
    where
      VENDEDOR.CODVENDEDOR = :CODVENDEDOR
    into
      :NOME_VENDEDOR;

    select
     STRRESULT
   from
     FU_GETTIRAMASCARA(:CNPJCLIENTE)
   into
     CNPJCLIENTE;

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC)),
      SYSPARAMS.EMPRESA,
      SYSPARAMS.CEP
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR,
      :PDV_EMPRESA,
      :PDV_CEP;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMTHUNDER_DATA(
    DT_ENTRADA TIMESTAMP)
RETURNS (
    NOTA VARCHAR(10),
    NOMECLIENTE VARCHAR(61),
    PESOBRUTO DOUBLE PRECISION,
    DATA VARCHAR(10),
    PLACA VARCHAR(8),
    CODEMBARQUE INTEGER)
AS
declare variable PEDIDO integer;
declare variable LPLACA1 varchar(3);
declare variable LPLACA2 varchar(5);
declare variable QTDPEDIDOS integer;
declare variable LQTDATUAL integer;
begin
  select
    count(coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND))
  from
    EMBARQUEITEM E
    join PEDVEND P on
      E.CODPEDVEND_FK = P.CODPEDVEND
    join PESSOA PE on
      P.CODPESSOA = PE.CODPESSOA
    join EMBARQUE EM on
      EM.CODEMBARQUE = E.CODEMBARQUE_FK
  where
    EM.DATALIBERADO = :DT_ENTRADA and
    PDV_CRITICA    in ('V', 'M', 'A')
  into
    QTDPEDIDOS;

  LQTDATUAL = 1;

  for select
    coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND),
    RIGHT('00' || extract(day from P.DTFATURADO), 2) || '-' || RIGHT('00' || extract(month from P.DTFATURADO), 2) || '-' || extract(year from P.DTFATURADO),
    PE.NOME,
    P.CODPEDVEND,
    E.CODEMBARQUE_FK
  from
    EMBARQUEITEM E
    join PEDVEND P on
      E.CODPEDVEND_FK = P.CODPEDVEND
    join PESSOA PE on
      P.CODPESSOA = PE.CODPESSOA
    join EMBARQUE EM on
      EM.CODEMBARQUE = E.CODEMBARQUE_FK
  where
    EM.DATALIBERADO = :DT_ENTRADA and
    PDV_CRITICA    in ('V', 'M', 'A')
  group by
    coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND),
    P.DTFATURADO,
    PE.NOME,
    P.CODPEDVEND,
    E.CODEMBARQUE_FK
  order by
    E.CODEMBARQUE_FK,
    coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND)
  into
    NOTA,
    DATA,
    NOMECLIENTE,
    PEDIDO,
    CODEMBARQUE
  do
  begin
    select
      sum(pi.QTDENTREGUE * PF.PESOBRUTO)
    from
      PEDVENDITEM pi
      join PRODFILHO PF on
        pi.CODPRODFILHO = PF.CODPRODFILHO
    where
      pi.CODPEDVEND = :PEDIDO
    into
      PESOBRUTO;

    select
      V.PLACA
    from
      EMBARQUE E
      left join VEICULOS V on
        E.CODVEICULO_FK = V.CODVEICULO
    where
      E.CODEMBARQUE = :CODEMBARQUE
    into
      PLACA;

    LPLACA1 = substring(PLACA from 1 for 3);

    select
      R_TRIM
    from
      FU_TRIM(:LPLACA1)
    into
      LPLACA1;

    LPLACA2 = substring(PLACA from 4 for 8);

    select
      R_TRIM
    from
      FU_TRIM(:LPLACA2)
    into
      LPLACA2;

    PLACA = LPLACA1 || LPLACA2;
    PLACA = substring(PLACA from 1 for 7);

    if (LQTDATUAL < QTDPEDIDOS) then
      NOMECLIENTE = NOMECLIENTE || ';';

    LQTDATUAL = LQTDATUAL + 1;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMTHUNDERTRACK(
    CODEMBARQUE INTEGER)
RETURNS (
    NOTA VARCHAR(10),
    NOMECLIENTE VARCHAR(65),
    PESOBRUTO DOUBLE PRECISION,
    DATA VARCHAR(10),
    PLACA VARCHAR(8),
    INFO1 VARCHAR(500),
    INFO2 VARCHAR(200),
    INFO3 VARCHAR(200),
    INFO4 VARCHAR(200))
AS
declare variable PEDIDO integer;
declare variable LPLACA1 varchar(3);
declare variable LPLACA2 varchar(5);
declare variable QTDPEDIDOS integer;
declare variable LQTDATUAL integer;
declare variable LCODPESSOA integer;
declare variable LINFO3 varchar(255);
declare variable LTIPOPED varchar(10);
begin
  select
    count(coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND))
  from
    EMBARQUEITEM E
    join PEDVEND P on
      E.CODPEDVEND_FK = P.CODPEDVEND
  where
    E.CODEMBARQUE_FK = :CODEMBARQUE and
    P.PDV_CRITICA   in ('V', 'M', 'A')
  into
    QTDPEDIDOS;

  LQTDATUAL = 1;

  for select
    coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND),
    RIGHT('00' || extract(day from P.DTFATURADO), 2) || '-' || RIGHT('00' || extract(month from P.DTFATURADO), 2) || '-' || extract(year from P.DTFATURADO),
    P.CODPESSOA,
    P.CODPEDVEND,
    P.TIPOPED
  from
    EMBARQUEITEM E
    join PEDVEND P on
      E.CODPEDVEND_FK = P.CODPEDVEND
    join PESSOA PE on
      P.CODPESSOA = PE.CODPESSOA
  where
    E.CODEMBARQUE_FK = :CODEMBARQUE and
    P.PDV_CRITICA   in ('V', 'M', 'A')
  group by
    coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND),
    P.DTFATURADO,
    P.CODPESSOA,
    P.CODPEDVEND,
    P.TIPOPED
  into
    NOTA,
    DATA,
    LCODPESSOA,
    PEDIDO,
    LTIPOPED
  do
  begin
    INFO1 = coalesce(INFO1, '');
    INFO2 = coalesce(INFO2, '');
    INFO3 = coalesce(INFO3, '');
    INFO4 = coalesce(INFO4, '');

    INFO4 = '';

    select
      sum(pi.QTDENTREGUE * PF.PESOBRUTO)
    from
      PEDVENDITEM pi
      join PRODFILHO PF on
        pi.CODPRODFILHO = PF.CODPRODFILHO
    where
      pi.CODPEDVEND = :PEDIDO
    into
      PESOBRUTO;

    select
      V.PLACA
    from
      EMBARQUE E
      left join VEICULOS V on
        E.CODVEICULO_FK = V.CODVEICULO
    where
      E.CODEMBARQUE = :CODEMBARQUE
    into
      PLACA;

    select
      CLI.NOME,
      coalesce(CLI.LOGRADOURO_1, '') || ' ' || coalesce(CLI.NUMERO_1, '') || ' ' || coalesce(CLI.COMPLEMENTO_1, '') || ' ' || coalesce(CLI.CIDADE_1, '') || ' ' || coalesce(CLI.UF_1, '') || ' ' || coalesce(CLI.CEP_1, ''),
      coalesce(CLI.PESSOA_CONTATO, '') || ' Fone: ' || coalesce(CLI.FONES, ''),
      coalesce(cast(CLI.ROTEIROENTREGA as varchar(255)), '')
    from
      PESSOA CLI
    where
      CLI.CODPESSOA = :LCODPESSOA
    into
      NOMECLIENTE,
      INFO1,
      INFO2,
      LINFO3;

    INFO1 = substring(INFO1 || '. P. REF.: ' || coalesce(LINFO3, '') from 1 for 500);

    LINFO3 = '';

    INFO3 = DATA;

    if (LTIPOPED = 'CADERNO') then
    begin
      select first 1
        RIGHT('00' || extract(day from C.DT_EMISSAO), 2) || '-' || RIGHT('00' || extract(month from C.DT_EMISSAO), 2) || '-' || extract(year from C.DT_EMISSAO)
      from
        CONTA C
      where
        C.CODPENDVEND = :PEDIDO
      into
        DATA;
    end
    else
    begin
      select first 1
        RIGHT('00' || extract(day from C.DT_EMISSAO), 2) || '-' || RIGHT('00' || extract(month from C.DT_EMISSAO), 2) || '-' || extract(year from C.DT_EMISSAO) DATA
      from
        NFVENDA N
        join CONTA C on
          C.CODNFVENDA = N.CODNFVENDA and
          C.SERIENF    = N.SERIE
      where
        N.CODPEDVEND = :PEDIDO
      into
        DATA;
    end

    LPLACA1 = substring(PLACA from 1 for 3);

    select
      R_TRIM
    from
      FU_TRIM(:LPLACA1)
    into
      LPLACA1;

    LPLACA2 = substring(PLACA from 5 for 8);

    select
      R_TRIM
    from
      FU_TRIM(:LPLACA2)
    into
      LPLACA2;

    PLACA = LPLACA1 || LPLACA2;
    PLACA = substring(PLACA from 1 for 7);

    if (LQTDATUAL < QTDPEDIDOS) then
    begin
      INFO4 = INFO4 || ';';
    end

    LQTDATUAL = LQTDATUAL + 1;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MGERANFVENDACOPIAFINANCEIRO(
    ECODNFVENDA INTEGER,
    ESERIENF VARCHAR(3),
    EDATAFINANCEIRO DATE,
    EPREV_TIPOPAG VARCHAR(20),
    EQTDPARCELA INTEGER,
    EDIASPRIMEIRA INTEGER,
    EDIASOUTROS INTEGER,
    ECODBANCO INTEGER)
AS
declare variable LVLTOTAL double precision;
declare variable LVLPARCELAPRIMEIRA numeric(15,2);
declare variable LVLPARCELAOUTRAS numeric(15,2);
declare variable LCODPESSOA integer;
declare variable LDT_VENCIM date;
declare variable LQTDPARCELA integer;
declare variable LVLPARCELA double precision;
declare variable LPARCELA varchar(5);
declare variable LUS_CADAST varchar(45);
declare variable LDIAS integer;
declare variable LCODCENTCUSTO integer;
declare variable LVALOR smallint;
declare variable LCODCONTA integer;
declare variable LCODPEDVEND integer;
declare variable SVALOR integer;
begin
  if ((nullif(EPREV_TIPOPAG, '') is not null) and (EQTDPARCELA > 0)) then
  begin
    select
      N.TOTALNOTA,
      N.CODPESSOA,
      N.US_CADAST,
      N.CODPEDVEND
    from
      NFVENDA N
    where
      N.CODNFVENDA = :ECODNFVENDA and
      N.SERIE      = :ESERIENF
    into
      LVLTOTAL,
      LCODPESSOA,
      LUS_CADAST,
      LCODPEDVEND;
      
    select
      VALOR
    from
      MLERPARAMETROINTEIRO('CENTRO DE CUSTO PADRO PARA NFVENDA', 0)
    into
      LCODCENTCUSTO;
      
    LVLPARCELAOUTRAS   = LVLTOTAL / EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLTOTAL - LVLPARCELAOUTRAS * EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLPARCELAPRIMEIRA + LVLPARCELAOUTRAS;
  
    while (coalesce(LQTDPARCELA, 1) <= EQTDPARCELA) do
    begin
      if (coalesce(LQTDPARCELA, 1) = 1) then
      begin
        LVLPARCELA = LVLPARCELAPRIMEIRA;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA;
      end
      else
      begin
        LVLPARCELA = LVLPARCELAOUTRAS;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA + (EDIASOUTROS * (LQTDPARCELA - 1));
      end
      LPARCELA = RIGHT('0' || coalesce(LQTDPARCELA, 1), 2) || '/' || RIGHT('0' || EQTDPARCELA, 2);
      
      LDIAS = LDT_VENCIM - cast('TODAY' as date);
  
      LCODCONTA = gen_id(GEN_CONTA, 1);

      insert into
        CONTA (
          CODCONTA,
          STATUS, 
          TIPO,
          DESCRICAO, 
          NRDOCUMENTO, 
          CODPESSOA, 
          DT_EMISSAO, 
          DT_VENCIM, 
          PARCELA, 
          PREV_TIPOPAG, 
          VLPARCELA,
          VLTOTAL, 
          US_CADAST, 
          DT_CADAST, 
          CODNFVENDA, 
          SERIENF, 
          DIAS,
          CODBANCO)
      values (
        :LCODCONTA,
        'ABERTO',
        'RECEBER',
        'COPIA DE NFVENDA',
        :ECODNFVENDA,
        :LCODPESSOA,
        'TODAY',
        :LDT_VENCIM,
        :LPARCELA,
        :EPREV_TIPOPAG,
        :LVLPARCELA,
        :LVLTOTAL,
        :LUS_CADAST,
        'NOW',
        :ECODNFVENDA,
        :ESERIENF,
        :LDIAS,
        :ECODBANCO);
  
      if (nullif(LCODCENTCUSTO, 0) is not null) then
      begin
        insert into
          CONTA_CENTCUSTO (
            CODCENTCUSTO,
            CODCONTA,
            VALOR)
        values (
          :LCODCENTCUSTO,
          :LCODCONTA,
          :LVLPARCELA);
      end
      LQTDPARCELA = coalesce(LQTDPARCELA, 1) + 1;
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE SPMAPAVENDAS2(
    EDTINI DATE,
    EDTFIM DATE)
RETURNS (
    CODVENDEDOR INTEGER,
    VENDEDOR VARCHAR(60),
    CODSTATUS INTEGER,
    STATUS VARCHAR(60),
    CODPESSOA INTEGER,
    PESSOA VARCHAR(60),
    CODPEDVEND INTEGER,
    DTFATURADO DATE,
    CODGRUPO INTEGER,
    GRUPO VARCHAR(60),
    CODSUBGRUPO INTEGER,
    SUBGRUPO VARCHAR(60),
    CODPRODFILHO INTEGER,
    PRODFILHO VARCHAR(60),
    UNIDADE VARCHAR(15),
    QTDENTREGUE DOUBLE PRECISION,
    CAIXA DOUBLE PRECISION,
    PRECOPROD DOUBLE PRECISION,
    DESCONTO_VALOR DOUBLE PRECISION,
    PESOBRUTO DOUBLE PRECISION,
    PESOLIQUIDO DOUBLE PRECISION,
    PERDA DOUBLE PRECISION,
    USUARIO VARCHAR(45),
    ACRESCIMOVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    CODEMPRESA INTEGER,
    CIDADE VARCHAR(45),
    ARE_CODIGO INTEGER,
    AREA VARCHAR(30),
    CURVA VARCHAR(1),
    VALORIPI DOUBLE PRECISION,
    CODFABRICANTE INTEGER,
    CODSUPERVISOR INTEGER,
    CUBAGEM DOUBLE PRECISION,
    CMV DOUBLE PRECISION,
    CODTIPOATV INTEGER,
    TIPOATIVIDADE VARCHAR(60),
    TOTAL DOUBLE PRECISION,
    BAIRRO VARCHAR(45),
    MES VARCHAR(20),
    ANO INTEGER,
    CODCOR INTEGER,
    COR VARCHAR(60),
    FABRICANTE VARCHAR(60),
    QTDEMBALAGEM DOUBLE PRECISION,
    SEMANA VARCHAR(60),
    NUMSEMANA INTEGER,
    SUPERVISOR VARCHAR(60),
    SIGLA CHAR(2),
    CODSTATUS_CHECKOUT INTEGER,
    STATUS_CHECKOUT VARCHAR(60),
    EMPRESA VARCHAR(60),
    CARACTER VARCHAR(60))
AS
declare variable LTOTDESCPEDVEND double precision;
declare variable LTOTACRESPEDVEND double precision;
declare variable LVALOR_BRUTO double precision;
declare variable LCODPEDVEND integer;
declare variable LFRETE double precision;
declare variable LCODPRODUTO integer;
declare variable LCODUNIDADE integer;
declare variable LDTFATURADO date;
declare variable LDTSAIDA date;
declare variable LPERCACRESCIMO double precision;
declare variable LVALORACRESCIMO double precision;
declare variable LVALORDESCONTO double precision;
declare variable LPERCVALORDESCONTO double precision;
declare variable LEXIBIRAPENASONUMERODOPEDIDO smallint;
declare variable LCODFATURAMENTO integer;
declare variable LCODNFVENDA integer;
declare variable LSOMAFRETE varchar(1);
declare variable LNAOSOMARFRETENORELATORIO smallint;
declare variable LSOMARIPIAOTOTAL smallint;
declare variable LDTINI timestamp;
declare variable LDTFIM timestamp;
declare variable LDIASEMANA integer;
declare variable LSEMANA integer;
begin
  LDTINI = cast(EDTINI||' 00:00:00' as timestamp);
  LDTFIM = cast(EDTFIM||' 23:59:59' as timestamp);

  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0)
  into
    LEXIBIRAPENASONUMERODOPEDIDO;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('SOMAR IPI AO TOTAL',0)
  into
    LSOMARIPIAOTOTAL;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('NO SOMAR FRETE NO RELATORIO',0)
  into
    LNAOSOMARFRETENORELATORIO;

  select 
    SOMAFRETE
  from
    SYSPARAMS
  into
    LSOMAFRETE;

  for select
    P.CODVENDEDOR,
    P.CODPESSOA,
    P.CODPEDVEND,
    P.CODFATURAMENTO,
    P.CODNFVENDA,
    cast(P.DTFATURADO as date),
    cast(P.DT_SAIDA as date),
    P.US_CADAST USUARIO,
    P.CODEMPRESA,
    P.DESC_VALOR,
    P.DESCPERC_VALOR,
    P.ACRESVALOR,
    P.ACRESCIMO,
    P.VALOR_BRUTO,
    P.FRETE
  from
    PEDVEND P
  where
    P.STATUSPED = 'FATURADO' and
    P.TIPOPED in ('VENDA', 'CADERNO') and
    P.DT_SAIDA between :LDTINI and :LDTFIM
  into
    :CODVENDEDOR,
    :CODPESSOA,
    :LCODPEDVEND,
    :LCODFATURAMENTO,
    :LCODNFVENDA,
    :LDTFATURADO,
    :LDTSAIDA,
    :USUARIO,
    :CODEMPRESA,
    :LVALORDESCONTO,
    :LPERCVALORDESCONTO,
    :LVALORACRESCIMO,
    :LPERCACRESCIMO,
    :LVALOR_BRUTO,
    :LFRETE
  do
  begin

    if (LEXIBIRAPENASONUMERODOPEDIDO = 0) then
      CODPEDVEND = coalesce(LCODFATURAMENTO, LCODNFVENDA, LCODPEDVEND);
    else
      CODPEDVEND = LCODPEDVEND;

    LFRETE = coalesce(LFRETE,0);
    DTFATURADO = coalesce(LDTFATURADO,LDTSAIDA);
    LVALOR_BRUTO = coalesce(nullif(LVALOR_BRUTO,0),1);
    LTOTACRESPEDVEND = coalesce(LVALORACRESCIMO,0) + (coalesce(LVALOR_BRUTO,0) * (coalesce(LPERCACRESCIMO,0)/100));
    LTOTDESCPEDVEND = coalesce(LVALORDESCONTO,0) + coalesce(LPERCVALORDESCONTO,0);

    select FU_RETORNOMEMES_INT.NOME from FU_RETORNOMEMES_INT(extract(month from :DTFATURADO)) into :MES;

    MES = upper(MES);

    ANO = extract(year from DTFATURADO);

    MES = '''' || MES || '''';

    select
       V.NOME VENDEDOR
    from
      VENDEDOR V
    where
      V.CODVENDEDOR = :CODVENDEDOR
    into 
      VENDEDOR;

    select
       u.SIGLA VENDEDOR
    from
      PESSOA p
      inner join TBL_ESTADO u
      on p.UF_1 = u.SIGLA
    where
      p.CODPESSOA = :CODPESSOA
    into 
      SIGLA;

    select 
      PE.CODSTATUS,
      PE.NOME,
      coalesce(PE.ARE_CODIGO,0),
      PE.CIDADE_1,
      coalesce(PE.CODTIPOATV,0),
      PE.BAIRRO_1
    from
      PESSOA PE
    where
      PE.CODPESSOA = :CODPESSOA
    into
      CODSTATUS,
      PESSOA,
      ARE_CODIGO,
      CIDADE,
      CODTIPOATV,
      BAIRRO;

    TIPOATIVIDADE = null;
    select 
      coalesce(DESCRICAO,'NO DEFINIDO')
    from
      TBL_RAMOATVTIPO
    where
      CODTIPO = :CODTIPOATV
    into
      TIPOATIVIDADE;

    TIPOATIVIDADE = coalesce(TIPOATIVIDADE,'NO DEFINIDO');

    select 
      DESCRICAO
    from
      STATUS ST
    where
       ST.CODSTATUS = :CODSTATUS
    into
      STATUS;

    select 
      CODSTATUS,
      DESCRICAO
    from
      STATUS ST
    where
       ST.CODSTATUS = :CODSTATUS
    into
      CODSTATUS_CHECKOUT,
      STATUS_CHECKOUT;

    AREA = null;
    select 
      coalesce(ARE_DESCRICAO,'NO DEFINIDO')
    from
      TBL_AREA TA
    where
      TA.ARE_CODIGO = :ARE_CODIGO
    into
      AREA;

    AREA = coalesce(AREA,'NO DEFINIDO');

    select
      E.EMPRESA
    from
      EMPRESA E
    where
      E.CODEMPRESA = :CODEMPRESA
    into
      EMPRESA;

    for select
      pi.CODPRODFILHO,
      PF.DESCRICAO PRODFILHO,
      pi.QTDENTREGUE,
      pi.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1) CAIXA,
      pi.PRECOPROD,
      ((:LTOTDESCPEDVEND * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO)) + coalesce(pi.DESCONTO_VALOR,0)) as DESCONTO_VALOR,
      PF.PESOBRUTO * pi.QTDENTREGUE PESOBRUTO,
      PF.PESOLIQUIDO * pi.QTDENTREGUE PESOLIQUIDO,
      pi.PERDA,
      ((:LTOTACRESPEDVEND * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO))) as ACRESCIMOVALOR,
      (:LFRETE * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO)) as FRETE,
      PF.CURVA,
      (coalesce(pi.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)) VALORIPI,
      (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(pi.QTDENTREGUE,0)) CUBAGEM,
      (coalesce(PF.CUSTOMEDIO,0) * coalesce(pi.QTDENTREGUE,0)) CMV,
      PF.CODPRODUTO,
      PF.CODUNIDADE,
      coalesce(PF.CODCOR,0),
      coalesce(PF.QTDEMBALAGEM,1)
    from
      PEDVENDITEM pi
      join PRODFILHO PF on pi.CODPRODFILHO = PF.CODPRODFILHO
    where
       pi.CODPEDVEND = :LCODPEDVEND
    into
      :CODPRODFILHO,
      :PRODFILHO,
      :QTDENTREGUE,
      :CAIXA,
      :PRECOPROD,
      :DESCONTO_VALOR,
      :PESOBRUTO,
      :PESOLIQUIDO,
      :PERDA,
      :ACRESCIMOVALOR,
      :FRETE,
      :CURVA,
      :VALORIPI,
      :CUBAGEM,
      :CMV,
      :LCODPRODUTO,
      :LCODUNIDADE,
      :CODCOR,
      :QTDEMBALAGEM
    do
    begin
      select 
        CODGRUPO, 
        CODSUBGRUPO,
        CODFABRICANTE
      from
        PRODUTO PR
      where
        PR.CODPRODUTO = :LCODPRODUTO
      into
        :CODGRUPO,
        :CODSUBGRUPO,
        :CODFABRICANTE;

      select 
        CODSUPERVISOR
      from
        PESSOA
      where
        CODPESSOA = :CODPESSOA
      into
        :CODSUPERVISOR;

      COR = null;

      select
        DESCRICAO
      from
        TBL_COR
      where
        CODCOR = :CODCOR
      into
        :COR;

      COR = coalesce(COR,'SEM COR');

      select 
        DESCRICAO
      from
        GRUPO
      where
        CODGRUPO = :CODGRUPO
      into
        GRUPO;


      select 
        DESCRICAO
      from
        SUBGRUPO
      where
        CODSUBGRUPO = :CODSUBGRUPO
      into
        SUBGRUPO;

      select 
        coalesce(:UNIDADE, U.SIGLA)
      from
        UNIDADE U
      where
        CODUNIDADE = :LCODUNIDADE
      into
        UNIDADE;
         CARACTER = null;
        SELECT
          CARACTER.DESCRICAO DESC_CARACTER
        from
         PRODCARACTER JOIN CARACTER ON
        PRODCARACTER.CODCARACTER = CARACTER.CODCARACTER
        where
          CODPRODUTO = :LCODPRODUTO
         into
         :CARACTER;

      if ((LSOMARIPIAOTOTAL <> 0) and (LNAOSOMARFRETENORELATORIO = 0) and (LSOMAFRETE = 'S')) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + FRETE + VALORIPI) - DESCONTO_VALOR));
      else if ((LNAOSOMARFRETENORELATORIO = 0) and (LSOMAFRETE = 'S')) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + FRETE)- DESCONTO_VALOR));
      else if (LSOMARIPIAOTOTAL <> 0) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + VALORIPI) - DESCONTO_VALOR));
      else
        TOTAL = (((PRECOPROD * QTDENTREGUE) + ACRESCIMOVALOR) - DESCONTO_VALOR);

    FABRICANTE = '';

    select
      PE.NOME
    from
      PESSOA PE
    where
      PE.CODPESSOA = :CODFABRICANTE
    into
      FABRICANTE;

    SUPERVISOR = '';

    select
      SU.NOME
    from
      SUPERVISOR SU
    where
      SU.CODSUPERVISOR = :CODSUPERVISOR
    into
      SUPERVISOR;

    /* { ALTERAES - BRUNO - 11/07/2012 } -- */
    /* CARREGA A SEMANA -- */
    select
    (extract(yearday from cast(:DTFATURADO as date)) - extract(weekday from cast(:DTFATURADO as date) -1)+7)/7 SEMANA
    from rdb$database into LSEMANA;
    /* CARREGA O PERODO DA SEMANA -- */
    select extract(weekday from :DTFATURADO) from rdb$database into LDIASEMANA;
    if (LDIASEMANA = 0) then
        LDIASEMANA = 7;

    SEMANA = 'De ' ||
             RIGHT('00' || cast((extract(day from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
             '/' ||
             RIGHT('00' || cast((extract(month from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
             '/' ||
             extract(year from (:DTFATURADO - (LDIASEMANA - 1))) ||
             '  ' ||
             RIGHT('00' || cast((extract(day from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
             '/' ||
             RIGHT('00' || cast((extract(month from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
             '/' ||
             extract(year from (:DTFATURADO + (7 - LDIASEMANA)));

    NUMSEMANA = LSEMANA;
    /* { FIM ALTERAES - BRUNO - 11/07/2012 } -- */
    suspend;

    codcor = null;

    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE STP_GERAFIANCEIRO_CHEQUE(
    ECODCHEQUE INTEGER)
AS
declare variable LVLTOTAL double precision;
declare variable LVLPARCELAPRIMEIRA numeric(15,2);
declare variable LVLPARCELAOUTRAS numeric(15,2);
declare variable LCODPESSOA integer;
declare variable LDT_VENCIM date;
declare variable LQTDPARCELA integer;
declare variable LVLPARCELA double precision;
declare variable LPARCELA varchar(5);
declare variable LUS_CADAST varchar(45);
declare variable LDIAS integer;
declare variable LCODCENTCUSTO integer;
declare variable LVALOR smallint;
declare variable LCODCONTA integer;
declare variable LCODCONDPAGCPR integer;
declare variable SVALOR integer;
declare variable LPREV_TIPOPAG varchar(45);
declare variable EQTDPARCELA integer;
declare variable EDIASPRIMEIRA integer;
declare variable EDIASOUTROS integer;
declare variable EDATAFINANCEIRO date;
declare variable LNRDOCUMENTO varchar(30);
begin

  delete FROM
  CONTA C
  WHERE
  C.CODCHAVULSO =:ECODCHEQUE;

  SELECT CODCCUSTCOMPRA FROM SYSPARAMS INTO LCODCENTCUSTO;


    select
      C.VALOR,
      C.CODPESSOA,
      current_timestamp,
      C.NRCHEQUE
    from
      CHEQUE_AVULSO C
    where
      C.CODCHEQUE =:ECODCHEQUE
    into
      LVLTOTAL,
      LCODPESSOA,
      EDATAFINANCEIRO,
      LNRDOCUMENTO;


      SELECT first 1
      C.NRPRESTACAO,
      C.NRDIASPRIMEIRA,
      C.NRDIAS,
      C.DESCRICAO
      FROM
      CONDPAGCPR C
      WHERE
     C.CODCONDPAGCPR = 13
      INTO
      EQTDPARCELA,
      EDIASPRIMEIRA,
      EDIASOUTROS,
      LPREV_TIPOPAG;

      
    LVLPARCELAOUTRAS   = LVLTOTAL / EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLTOTAL - LVLPARCELAOUTRAS * EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLPARCELAPRIMEIRA + LVLPARCELAOUTRAS;
  
    while (coalesce(LQTDPARCELA, 1) <= EQTDPARCELA) do
    begin
      if (coalesce(LQTDPARCELA, 1) = 1) then
      begin
        LVLPARCELA = LVLPARCELAPRIMEIRA;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA;
      end
      else
      begin
        LVLPARCELA = LVLPARCELAOUTRAS;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA + (EDIASOUTROS * (LQTDPARCELA - 1));
      end
      LPARCELA = RIGHT('0' || coalesce(LQTDPARCELA, 1), 2) || '/' || RIGHT('0' || EQTDPARCELA, 2);
      
      LDIAS = LDT_VENCIM - cast('TODAY' as date);
  
      LCODCONTA = gen_id(GEN_CONTA, 1);

      insert into
        CONTA (
          CODCONTA,
          STATUS, 
          TIPO,
          DESCRICAO, 
          NRDOCUMENTO, 
          CODPESSOA, 
          DT_EMISSAO, 
          DT_VENCIM, 
          PARCELA, 
          PREV_TIPOPAG, 
          VLPARCELA,
          VLTOTAL, 
          DT_CADAST, 
          CODCHAVULSO,
          DIAS,
          CODCENTCUSTO)
      values (
        :LCODCONTA,
        'ABERTO',
        'PAGAR',
        'CHEQUE AVULSO',
        :LNRDOCUMENTO,
        :LCODPESSOA,
        'TODAY',
        :LDT_VENCIM,
        :LPARCELA,
        :LPREV_TIPOPAG,
        :LVLPARCELA,
        :LVLTOTAL,
        'NOW',
        :ECODCHEQUE,
        :LDIAS,
        :LCODCENTCUSTO);
  
      if (nullif(LCODCENTCUSTO, 0) is not null) then
      begin
        insert into
          CONTA_CENTCUSTO (
            CODCENTCUSTO,
            CODCONTA,
            VALOR)
        values (
          :LCODCENTCUSTO,
          :LCODCONTA,
          :LVLPARCELA);
      end
      LQTDPARCELA = coalesce(LQTDPARCELA, 1) + 1;
    end

end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE WS003_LISTAGEMPRODUTO(
    ECODVENDEDOR INTEGER)
RETURNS (
    CODPRODFILHO INTEGER,
    DESCRICAO VARCHAR(60),
    REFERENCIA VARCHAR(30),
    GTIN VARCHAR(30),
    APRESENTACAO VARCHAR(15),
    CONTROLALOTE VARCHAR(1),
    CONTROLAVALIDADE CHAR(1),
    CODUNIDADE INTEGER,
    UNIDADE VARCHAR(5),
    TRAVA_FRACIONADO VARCHAR(1),
    PRECOVENDA NUMERIC(15,2),
    PRECOVENDA1 NUMERIC(15,2),
    PRECOVENDA2 NUMERIC(15,2),
    PRECOVENDA3 NUMERIC(15,2),
    PRECOVENDA4 NUMERIC(15,2),
    PRECOVENDA5 NUMERIC(15,2),
    PRECOVENDA6 NUMERIC(15,2),
    ESTQATUAL NUMERIC(15,3),
    CODFABRICANTE INTEGER,
    FABRICANTE VARCHAR(60),
    CODGRUPO INTEGER,
    DESCGRUPO VARCHAR(60),
    CODSUBGRUPO INTEGER,
    DESCSUBGRUPO VARCHAR(60),
    DESCONTFLAG SMALLINT,
    DESCONTDESEJ NUMERIC(15,4),
    FLAG_SOLICITARVALORDOLAR SMALLINT,
    VALIDADES VARCHAR(500),
    APLICACAO VARCHAR(500),
    DESC_AUXILIAR_1 VARCHAR(60),
    DESC_AUXILIAR_2 VARCHAR(60),
    FLAG_PROMOCAO VARCHAR(1),
    DESCONTOPRAZO1 NUMERIC(15,2),
    DESCONTOPRAZO2 NUMERIC(15,2),
    DESCONTOPRAZO3 NUMERIC(15,2),
    DESCONTOPRAZO4 NUMERIC(15,2),
    DESCONTOPRAZO5 NUMERIC(15,2),
    DESCONTOPRAZO6 NUMERIC(15,2),
    DESCONTOPRAZO7 NUMERIC(15,2),
    DESCONTOPRAZO8 NUMERIC(15,2),
    DESCONTOPRAZO9 NUMERIC(15,2),
    DESCONTOPRAZO10 NUMERIC(15,2),
    CUSTO NUMERIC(15,2),
    ATIVO SMALLINT,
    PRECOMINIMO NUMERIC(15,2),
    QTDMULTIPLA DOUBLE PRECISION,
    QTDEMBALAGEM DOUBLE PRECISION,
    CODCOR INTEGER,
    COR VARCHAR(60),
    METACOR DOUBLE PRECISION,
    TRATESP SMALLINT,
    FATORCONVERSAO DOUBLE PRECISION,
    FLAG_CAIXAFECHADA VARCHAR(1),
    FLAG_PESOVARIAVEL VARCHAR(1),
    PESO_PECA DOUBLE PRECISION)
AS
declare variable B_EXISTE smallint;
declare variable B_EXIBIR smallint;
declare variable LEXIBIR_APENAS_WEB smallint;
declare variable LVISUALIZARNAWEB varchar(1);
declare variable PAR_REQ_VLDLR_FAB varchar(100);
declare variable LVALIDADE varchar(10);
declare variable LULTIMASINC timestamp;
declare variable PARTABELA_DE_PRECO_MINIMO integer;
declare variable LCALCOESTQPRODCOMBINADO integer;
declare variable LPRODCOMBINADO integer;
declare variable LESTQATUAL double precision;
declare variable LRESERVAMINIMA double precision;
declare variable LSQL blob sub_type 1 segment size 80;
begin
  if (exists(select 1 from CONSULTA_CUSTOMIZADA where CONSULTA_CUSTOMIZADA.CONSULTA = 'WS003_LISTAGEMPRODUTO')) then
  begin
    select SQL from CONSULTA_CUSTOMIZADA where CONSULTA_CUSTOMIZADA.CONSULTA = 'WS003_LISTAGEMPRODUTO' into LSQL;
    for execute statement (LSQL)
    (
      ECODVENDEDOR     := :ECODVENDEDOR
    )
    into
      CODPRODFILHO, 
      DESCRICAO, 
      REFERENCIA, 
      GTIN, 
      APRESENTACAO, 
      CONTROLALOTE, 
      CONTROLAVALIDADE, 
      CODUNIDADE, 
      UNIDADE, 
      TRAVA_FRACIONADO, 
      PRECOVENDA, 
      PRECOVENDA1, 
      PRECOVENDA2, 
      PRECOVENDA3, 
      PRECOVENDA4, 
      PRECOVENDA5, 
      PRECOVENDA6, 
      ESTQATUAL, 
      CODFABRICANTE, 
      FABRICANTE, 
      CODGRUPO, 
      DESCGRUPO, 
      CODSUBGRUPO, 
      DESCSUBGRUPO, 
      DESCONTFLAG, 
      DESCONTDESEJ, 
      FLAG_SOLICITARVALORDOLAR, 
      VALIDADES, 
      APLICACAO, 
      DESC_AUXILIAR_1, 
      DESC_AUXILIAR_2, 
      FLAG_PROMOCAO, 
      DESCONTOPRAZO1, 
      DESCONTOPRAZO2, 
      DESCONTOPRAZO3, 
      DESCONTOPRAZO4, 
      DESCONTOPRAZO5, 
      DESCONTOPRAZO6, 
      DESCONTOPRAZO7, 
      DESCONTOPRAZO8, 
      DESCONTOPRAZO9, 
      DESCONTOPRAZO10, 
      CUSTO, 
      ATIVO, 
      PRECOMINIMO, 
      QTDMULTIPLA,
      QTDEMBALAGEM, 
      CODCOR, 
      COR, 
      METACOR,
      TRATESP,
      FATORCONVERSAO,
      FLAG_CAIXAFECHADA,
      FLAG_PESOVARIAVEL,
      PESO_PECA
    do
    begin
      suspend;
    end
    exit;
  end

  B_EXISTE = 0;
  if (exists(select 1 from VENDEDOR_COMISSAO_GRUPO
             where VENDEDOR_COMISSAO_GRUPO.CODVENDEDOR = :ECODVENDEDOR)) then
  begin
    B_EXISTE = 1;
  end

  select ULTIMASINC from MOBILE_SINC where CODSMNTIPOSINC = 2 and CODVENDEDOR = :ECODVENDEDOR into LULTIMASINC;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR PRODUTOS MARCADOS COMO VISUALIZAR NA WEB',0)
  into
    LEXIBIR_APENAS_WEB;

  select
    VALOR
  from
    MLERPARAMETROINTEIRO('TABELA DE PRECO MINIMO',6)
  into
    PARTABELA_DE_PRECO_MINIMO;

  select
    VALOR
  from
    MLERPARAMETROTEXTO('REQUISITAR VALOR DOLAR (FABRICANTES)','')
  into
    PAR_REQ_VLDLR_FAB;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('CALCULAR O ESTOQUE DO PRODUTO COMBINADO', 0)
  into
    LCALCOESTQPRODCOMBINADO;

  for select
    PRODFILHO.CODPRODFILHO,
    PRODFILHO.DESCRICAO,
    coalesce(PRODFILHO.CODPESQ1,'') REFERENCIA,
    coalesce(PRODFILHO.CODPESQ2,'') GTIN,
    coalesce(PRODFILHO.UNIDADE, UNIDADE.SIGLA) APRESENTACAO,
    coalesce(PRODFILHO.ESTOQUELOTE,'N') CONTROLALOTE,
    (case when coalesce(PRODFILHO.VALIDADE,0) > 0 then 'S' else 'N' end) CONTROLAVALIDADE,
    PRODFILHO.CODUNIDADE,
    UNIDADE.SIGLA UNIDADE,
    coalesce(UNIDADE.TRAVA_FRACIONADO,'N'),
    cast(coalesce(PRODFILHO.PRECOPRATICADO1,0) as numeric(15,2)) PRECOVENDA1,
    cast(coalesce(PRODFILHO.PRECOPRATICADO2,0) as numeric(15,2)) PRECOVENDA2,
    cast(coalesce(PRODFILHO.PRECOPRATICADO3,0) as numeric(15,2)) PRECOVENDA3,
    cast(coalesce(PRODFILHO.PRECOPRATICADO4,0) as numeric(15,2)) PRECOVENDA4,
    cast(coalesce(PRODFILHO.PRECOPRATICADO5,0) as numeric(15,2)) PRECOVENDA5,
    cast(coalesce(PRODFILHO.PRECOPRATICADO6,0) as numeric(15,2)) PRECOVENDA6,
    cast(coalesce(PRODFILHO.ESTQATUAL,0) as numeric(15,3)),
    coalesce(PRODUTO.CODFABRICANTE,0),
    coalesce((select coalesce(NOME,'') from PESSOA where PESSOA.CODPESSOA = PRODUTO.CODFABRICANTE),'') FABRICANTE,
    PRODUTO.CODGRUPO,
    GRUPO.DESCRICAO DESCGRUPO,
    PRODUTO.CODSUBGRUPO,
    SUBGRUPO.DESCRICAO DESCSUBGRUPO,
    coalesce(PRODFILHO.DESCONTFLAG,1) DESCONTFLAG,
    coalesce(PRODFILHO.DESCONTDESEJ,0) DESCONTDESEJ,
    coalesce(PRODUTO.VISUALIZARNAWEB,'N'),
    substring(coalesce(PRODUTO.OBS,'') from 1 for 500),
    coalesce(PRODFILHO.DESC_AUXILIAR_1,''),
    coalesce(PRODFILHO.DESC_AUXILIAR_2,''),
    coalesce(PRODFILHO.PROMOCAO,'N'),
    PRODUTO.ATIVO,
    coalesce(PRODFILHO.QTDMULTPLA,0),
    coalesce(PRODFILHO.CODCOR,0),
    coalesce(TBL_COR.DESCRICAO,''),
    coalesce(PRODFILHO.PRODCOMBINADO,1),
    coalesce(PRODFILHO.QTDEMBALAGEM,1),
    coalesce(PRODUTO.TRATESP,1),
    coalesce(nullif(PRODFILHO.FATORCONVERSAO,0),1),
    coalesce(PRODFILHO.QTD_MULTIPLA,'N'),
    coalesce(PRODFILHO.FLAG_PESOVARIAVEL,'N'),
    coalesce(PRODFILHO.PESO_PECA,0)
  from
    PRODUTO
    join PRODFILHO on
      PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
    join UNIDADE on
      PRODFILHO.CODUNIDADE = UNIDADE.CODUNIDADE
    join GRUPO on
      PRODUTO.CODGRUPO = GRUPO.CODGRUPO
    join SUBGRUPO on
      PRODUTO.CODSUBGRUPO = SUBGRUPO.CODSUBGRUPO
    left join TBL_COR on
      PRODFILHO.CODCOR = TBL_COR.CODCOR
  where
     ((:LULTIMASINC is null) or (coalesce(PRODFILHO.DT_MODIFI, PRODFILHO.DT_CADAST) >= :LULTIMASINC))
  order by
    PRODFILHO.DESCRICAO
  into
    CODPRODFILHO,
    DESCRICAO,
    REFERENCIA,
    GTIN,
    APRESENTACAO,
    CONTROLALOTE,
    CONTROLAVALIDADE,
    CODUNIDADE,
    UNIDADE,
    TRAVA_FRACIONADO,
    PRECOVENDA1,
    PRECOVENDA2,
    PRECOVENDA3,
    PRECOVENDA4,
    PRECOVENDA5,
    PRECOVENDA6,
    ESTQATUAL,
    CODFABRICANTE,
    FABRICANTE,
    CODGRUPO,
    DESCGRUPO,
    CODSUBGRUPO,
    DESCSUBGRUPO,
    DESCONTFLAG,
    DESCONTDESEJ,
    LVISUALIZARNAWEB,
    APLICACAO,
    DESC_AUXILIAR_1,
    DESC_AUXILIAR_2,
    FLAG_PROMOCAO,
    ATIVO,
    QTDMULTIPLA,
    CODCOR,
    COR,
    LPRODCOMBINADO,
    QTDEMBALAGEM,
    TRATESP,
    FATORCONVERSAO,
    FLAG_CAIXAFECHADA,
    FLAG_PESOVARIAVEL,
    PESO_PECA
  do
  begin
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 1' into DESCONTOPRAZO1;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 2' into DESCONTOPRAZO2;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 3' into DESCONTOPRAZO3;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 4' into DESCONTOPRAZO4;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 5' into DESCONTOPRAZO5;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 6' into DESCONTOPRAZO6;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 7' into DESCONTOPRAZO7;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 8' into DESCONTOPRAZO8;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 9' into DESCONTOPRAZO9;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 10' into DESCONTOPRAZO10;

    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'FORA DE VENDAS - RESERVA MINIMA' into LRESERVAMINIMA;

    select CUSTO from WS003_CALCULACUSTO(:CODPRODFILHO) into CUSTO;
    CUSTO = coalesce(CUSTO,0);

    DESCONTOPRAZO1  = coalesce(DESCONTOPRAZO1, 0);
    DESCONTOPRAZO2  = coalesce(DESCONTOPRAZO2, 0);
    DESCONTOPRAZO3  = coalesce(DESCONTOPRAZO3, 0);
    DESCONTOPRAZO4  = coalesce(DESCONTOPRAZO4, 0);
    DESCONTOPRAZO5  = coalesce(DESCONTOPRAZO5, 0);
    DESCONTOPRAZO6  = coalesce(DESCONTOPRAZO6, 0);
    DESCONTOPRAZO7  = coalesce(DESCONTOPRAZO7, 0);
    DESCONTOPRAZO8  = coalesce(DESCONTOPRAZO8, 0);
    DESCONTOPRAZO9  = coalesce(DESCONTOPRAZO9, 0);
    DESCONTOPRAZO10 = coalesce(DESCONTOPRAZO10, 0);
    LRESERVAMINIMA  = coalesce(LRESERVAMINIMA,0);


    if ((LPRODCOMBINADO = 2) and (LCALCOESTQPRODCOMBINADO <> 0)) then
    begin
      ESTQATUAL = null;
      for select
        cast(coalesce(PF.ESTQATUAL, 0) / coalesce(nullif(PC.QTD, 0), 1) - 0.5 as integer)
      from
        PRODCOMBINADOS PC
        join PRODFILHO PF on
          PC.CODPRO = PF.CODPRODFILHO
      where
        PC.CODNV = :CODPRODFILHO
      into
        LESTQATUAL
      do
      begin
        if (LESTQATUAL < 0) then
          LESTQATUAL = 0;

        if ((ESTQATUAL is null) or (LESTQATUAL < ESTQATUAL)) then
          ESTQATUAL = LESTQATUAL;
      end
    end

    ESTQATUAL = ESTQATUAL - LRESERVAMINIMA;
    if (coalesce(ESTQATUAL,0) <= 0) then
        ESTQATUAL = 0;

    select QTD from VENDEDORMETAS where CODVENDEDOR = :ECODVENDEDOR and CODCOR = :CODCOR into METACOR;
    METACOR = coalesce(METACOR,0);

    select
      case :PARTABELA_DE_PRECO_MINIMO
        when 1 then
          :PRECOVENDA1
        when 2 then
          :PRECOVENDA2
        when 3 then
          :PRECOVENDA3
        when 4 then
          :PRECOVENDA4
        when 5 then
          :PRECOVENDA5
        when 6 then
          :PRECOVENDA6
      end
    from
      RDB$DATABASE
    into
      PRECOMINIMO;

    PRECOMINIMO = coalesce(PRECOMINIMO,0);

    PRECOVENDA = PRECOVENDA1;
    VALIDADES = '';

    if ((CONTROLALOTE = 'S') and (CONTROLAVALIDADE = 'S')) then
    begin
      for select
        first 3
        RIGHT('00'||extract(day from PRODFILHOLOTES.DATAVAL),2)
        ||'/'||RIGHT('00'||extract(month from PRODFILHOLOTES.DATAVAL),2)
        ||'/'||extract(year from PRODFILHOLOTES.DATAVAL)
      from
        PRODFILHOLOTES
      where
        PRODFILHOLOTES.QTDMOV > 0
        and PRODFILHOLOTES.CODPRODFILHO = :CODPRODFILHO
      order by
        PRODFILHOLOTES.DATAVAL asc
      into
        LVALIDADE
      do
      begin
        if (VALIDADES = '') then
          VALIDADES = VALIDADES || LVALIDADE;
        else
          VALIDADES = VALIDADES ||' | '||LVALIDADE;
      end
    end

    VALIDADES = coalesce(VALIDADES,'');
    APLICACAO = coalesce(APLICACAO,'');

    FLAG_SOLICITARVALORDOLAR = 0;
    if ((CODFABRICANTE > 0) and (PAR_REQ_VLDLR_FAB containing CODFABRICANTE)) then
    begin
      FLAG_SOLICITARVALORDOLAR = 1;
    end

    B_EXIBIR = 1;
    if (B_EXISTE = 1) then
    begin
      B_EXIBIR = 0;
      if (exists(select 1 from VENDEDOR_COMISSAO_GRUPO
               where VENDEDOR_COMISSAO_GRUPO.CODVENDEDOR = :ECODVENDEDOR
               and VENDEDOR_COMISSAO_GRUPO.CODGRUPO = :CODGRUPO)) then
      begin
        B_EXIBIR = 1;
      end
    end

    if ((LEXIBIR_APENAS_WEB = 1) and (LVISUALIZARNAWEB = 'N')) then
      ATIVO = 0;

    if (B_EXIBIR = 1) then
      suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE BLT_AT_REMESSA_RECEBIMENTO(
    ECODCONTA INTEGER,
    ECODRECEBIMENTO INTEGER,
    ESEQREMESSA INTEGER,
    ELOCAL_ARQUIVO VARCHAR(100))
AS
declare variable LNOSSONUMERO varchar(100);
begin
  in autonomous transaction do
  begin
    select
      NRDOCUMENTO_BOLETO
    from
      CONTA
    where
      CODCONTA = :ECODRECEBIMENTO
    into
      LNOSSONUMERO;

    insert into CONTA_REMESSA (
      CODCONTA,
      DT_ENVIO,
      NRREMESSA,
      LOCAL_ARQUIVO,
      NOSSO_NUMERO,
      CODBANCO)
    values(
      :ECODRECEBIMENTO,
      current_timestamp,
      RIGHT('0000000000'||:ESEQREMESSA, 10),
      :ELOCAL_ARQUIVO,
      :LNOSSONUMERO,
      :ECODCONTA);

      update conta set boletoimpresso = 'E'
      where conta.codconta =:ECODRECEBIMENTO;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_LISTAR_SUPERVISOR(
    EFILTRO VARCHAR(100))
RETURNS (
    ATIVO INTEGER,
    CODSUPERVISOR INTEGER,
    CPFCGC VARCHAR(18),
    DT_ADMISSAO VARCHAR(10),
    CODSTATUS INTEGER,
    NOME VARCHAR(60),
    PERCCOMISS DOUBLE PRECISION,
    PERCCOMISS2 DOUBLE PRECISION,
    DT_NASC VARCHAR(10),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    COMPLEMENTO_1 VARCHAR(60),
    UF_1 VARCHAR(2),
    FONES VARCHAR(42),
    CELULAR VARCHAR(14),
    EMAIL VARCHAR(45),
    CODSUPERVISORGERAL INTEGER)
AS
BEGIN
    FOR SELECT 
      S.ATIVO,
      S.CODSUPERVISOR,
      S.CPFCGC,
      EXTRACT(YEAR FROM S.DT_ADMISSAO) || '-' || RIGHT('00'||EXTRACT(MONTH FROM S.DT_ADMISSAO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM S.DT_ADMISSAO),2),
    S.CODSTATUS,
      S.NOME,
      S.PERCCOMISS,
    S.PERCCOMISS2,
    EXTRACT(YEAR FROM S.DT_NASC) || '-' || RIGHT('00'||EXTRACT(MONTH FROM S.DT_NASC),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM S.DT_NASC),2),
    S.CEP_1,
    S.LOGRADOURO_1,
    S.BAIRRO_1,
    S.CIDADE_1,
    S.COMPLEMENTO_1,
    S.UF_1,
    S.FONES,
    S.CELULAR,
    S.EMAIL,
    S.CODSUPERVISORGERAL 
    FROM 
      SUPERVISOR S 
      WHERE UPPER(S.NOME) CONTAINING(UPPER(:EFILTRO))
    INTO
      :ATIVO,
      :CODSUPERVISOR,
      :CPFCGC,
      :DT_ADMISSAO,
      :CODSTATUS,
      :NOME,
      :PERCCOMISS,
    :PERCCOMISS2,
    :DT_NASC,
    :CEP_1,
    :LOGRADOURO_1,
    :BAIRRO_1,
    :CIDADE_1,
    :COMPLEMENTO_1,
    :UF_1,
    :FONES,
    :CELULAR,
    :EMAIL,
    :CODSUPERVISORGERAL
     
    DO
    BEGIN       
      SUSPEND;
    END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_LISTAR_SUPERVISOR_ATIVO
RETURNS (
    ATIVO INTEGER,
    CODSUPERVISOR INTEGER,
    CPFCGC VARCHAR(18),
    DT_ADMISSAO VARCHAR(10),
    CODSTATUS INTEGER,
    NOME VARCHAR(60),
    PERCCOMISS DOUBLE PRECISION,
    PERCCOMISS2 DOUBLE PRECISION,
    DT_NASC VARCHAR(10),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    COMPLEMENTO_1 VARCHAR(60),
    UF_1 VARCHAR(2),
    FONES VARCHAR(42),
    CELULAR VARCHAR(14),
    EMAIL VARCHAR(45),
    CODSUPERVISORGERAL INTEGER)
AS
BEGIN
    FOR SELECT 
      S.ATIVO,
      S.CODSUPERVISOR,
      S.CPFCGC,
      EXTRACT(YEAR FROM S.DT_ADMISSAO) || '-' || RIGHT('00'||EXTRACT(MONTH FROM S.DT_ADMISSAO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM S.DT_ADMISSAO),2),
    S.CODSTATUS,
      S.NOME,
      S.PERCCOMISS,
    S.PERCCOMISS2,
    EXTRACT(YEAR FROM S.DT_NASC) || '-' || RIGHT('00'||EXTRACT(MONTH FROM S.DT_NASC),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM S.DT_NASC),2),
    S.CEP_1,
    S.LOGRADOURO_1,
    S.BAIRRO_1,
    S.CIDADE_1,
    S.COMPLEMENTO_1,
    S.UF_1,
    S.FONES,
    S.CELULAR,
    S.EMAIL,
    S.CODSUPERVISORGERAL 
    FROM 
      SUPERVISOR S 
      WHERE S.ATIVO = 2
    INTO
      :ATIVO,
      :CODSUPERVISOR,
      :CPFCGC,
      :DT_ADMISSAO,
      :CODSTATUS,
      :NOME,
      :PERCCOMISS,
    :PERCCOMISS2,
    :DT_NASC,
    :CEP_1,
    :LOGRADOURO_1,
    :BAIRRO_1,
    :CIDADE_1,
    :COMPLEMENTO_1,
    :UF_1,
    :FONES,
    :CELULAR,
    :EMAIL,
    :CODSUPERVISORGERAL
     
    DO
    BEGIN       
      SUSPEND;
    END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_LISTAR_VENDEDOR(
    EATIVO SMALLINT,
    ECODSUPERVISOR INTEGER)
RETURNS (
    CODVENDEDOR INTEGER,
    NOME VARCHAR(60),
    CPFCGC VARCHAR(18),
    DT_NASC VARCHAR(10),
    ATIVO SMALLINT,
    LOGRADOURO_1 VARCHAR(60),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    TIPOVENDEDOR CHAR(1),
    DT_ADMISSAO VARCHAR(10),
    DT_DEMISSAO VARCHAR(10),
    CODSTATUS INTEGER,
    DESCRICAO_STATUS VARCHAR(60),
    CODEMPRESA INTEGER,
    DESCRICAO_EMPRESA VARCHAR(60),
    URL_FOTO VARCHAR(500),
    PRECO1 CHAR(1),
    PRECO2 CHAR(1),
    PRECO3 CHAR(1),
    PRECO4 CHAR(1),
    PRECO5 CHAR(1),
    PRECO6 CHAR(1),
    CODSUPERVISOR INTEGER,
    NOMESUPERVISOR VARCHAR(60),
    CODDIVISAOVENDAS INTEGER,
    DESCDIVISAOVENDAS VARCHAR(100),
    CAPACIDADE SMALLINT,
    CODVEND_APOIO INTEGER,
    NOMEVEND_APOIO VARCHAR(60))
AS
BEGIN
    FOR SELECT 
    V.CODVENDEDOR,
    V.NOME,
    V.CPFCGC,
    EXTRACT(YEAR FROM V.DT_NASC)||'-'||RIGHT('00'||EXTRACT(MONTH FROM V.DT_NASC),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM V.DT_NASC),2) DT_NASC,
    V.ATIVO,
    V.LOGRADOURO_1,
    V.COMPLEMENTO_1,
    V.BAIRRO_1,
    V.CIDADE_1,
    V.UF_1,
    V.CEP_1,
    V.TIPOVENDEDOR,
    EXTRACT(YEAR FROM V.DT_ADMISSAO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM V.DT_ADMISSAO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM V.DT_ADMISSAO),2) DT_ADMISSAO ,
    EXTRACT(YEAR FROM V.DT_DEMISSAO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM V.DT_DEMISSAO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM V.DT_ADMISSAO),2) DT_DEMISSAO,
    COALESCE(V.CODSTATUS, 1),
    COALESCE (S.DESCRICAO,''),
    COALESCE(V.CODEMPRESA, 0),
    COALESCE(E.EMPRESA, ''),
    V.FOTO,
    V.PRECO1,
    V.PRECO2,
    V.PRECO3,
    V.PRECO4,
    V.PRECO5,
    V.PRECO6,
    D.CODSUPERVISOR,
    D.NOME,
    V.CODDIVISAOVENDAS,
    DV.DESCRICAO,
    V.CAPACIDADE,
    V.CODVEND_APOIO,
    VA.NOME
    FROM 
      VENDEDOR V 
     LEFT JOIN STATUS S ON
       V.CODSTATUS = S.CODSTATUS
     LEFT JOIN EMPRESA E ON
       V.CODEMPRESA = E.CODEMPRESA
     LEFT JOIN DIVISAOVENDAS DV ON
       V.CODDIVISAOVENDAS = DV.CODDIVISAOVENDAS
     LEFT JOIN VENDEDOR VA ON
       V.CODVEND_APOIO = VA.CODVENDEDOR
     LEFT JOIN SUPERVISOR D ON
       D.CODSUPERVISOR = V.CODSUPERVISOR
     WHERE
      (
        :EATIVO IS NULL OR
        (:EATIVO IS not NULL and V.ATIVO = 2)
      )
      and (
        :ECODSUPERVISOR is null or
        V.CODSUPERVISOR = :ECODSUPERVISOR
      )
    INTO
      :CODVENDEDOR ,
      :NOME,
      :CPFCGC,
      :DT_NASC,
      :ATIVO,
      :LOGRADOURO_1,
      :COMPLEMENTO_1,
      :BAIRRO_1,
      :CIDADE_1,
      :UF_1,
      :CEP_1,
      :TIPOVENDEDOR,
      :DT_ADMISSAO,
      :DT_DEMISSAO,
      :CODSTATUS,
      :DESCRICAO_STATUS,
      :CODEMPRESA,
      :DESCRICAO_EMPRESA,
      :URL_FOTO,
      :PRECO1,
      :PRECO2,
      :PRECO3,
      :PRECO4,
      :PRECO5,
      :PRECO6,
      :CODSUPERVISOR,
      :NOMESUPERVISOR,
      :CODDIVISAOVENDAS,
      :DESCDIVISAOVENDAS,
      :CAPACIDADE,
      :CODVEND_APOIO,
      :NOMEVEND_APOIO
    DO
    BEGIN         
      SUSPEND;
    END    
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_MVPEDIDO(
    EIDPEDIDO VARCHAR(40))
RETURNS (
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    STATUSPED VARCHAR(10),
    TIPOPED VARCHAR(10),
    DTFATURADO VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    OBS3 VARCHAR(100),
    CODNFVENDA INTEGER,
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1),
    IDVENDA VARCHAR(40),
    OUTRASINF BLOB SUB_TYPE TEXT SEGMENT SIZE 80)
AS
DECLARE VARIABLE LCODEMPRESA INTEGER;
DECLARE VARIABLE LSQL BLOB SUB_TYPE 1 SEGMENT SIZE 80;
BEGIN
  IF (EXISTS(SELECT 1 FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_MVPEDIDO')) THEN
  BEGIN
    SELECT SQL FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_MVPEDIDO' INTO LSQL;
    FOR EXECUTE STATEMENT 
      (LSQL)
      (EIDPEDIDO := :EIDPEDIDO)
    INTO
      CODPEDVEND, 
      CODTIPOPAG, 
      STATUSPED, 
      TIPOPED, 
      DTFATURADO, 
      DT_SAIDA, 
      DT_ENTREGA, 
      DT_ENTREGAPREV, 
      H_ENTREGAPREV, 
      TIPOPAG, 
      FORMA_PAGAMENTO, 
      CODPESSOA, 
      CPFCNPJ_CLIENTE, 
      NOME_CLIENTE, 
      NOMEFANTAZIA, 
      CEP_1, 
      LOGRADOURO_1, 
      NUMERO_1, 
      BAIRRO_1, 
      CIDADE_1, 
      UF_1, 
      FONES, 
      EMAIL_CLIENTE, 
      IE, 
      PESSOA_CONTATO, 
      CODVENDEDOR, 
      NOME_VENDEDOR, 
      OBS1, 
      OBS2, 
      OBS3, 
      CODNFVENDA, 
      VALOR_BRUTO, 
      DESCONTO, 
      DESCPERC_VALOR, 
      DESC_VALOR, 
      ACRESVALOR, 
      FRETE, 
      VALOR_TOTAL, 
      EMPRESA_CNPJ, 
      EMPRESA_RAZAO, 
      EMPRESA_FANTAZIA, 
      EMPRESA_CEP, 
      EMPRESA_LOGRADOURO, 
      EMPRESA_NUMERO, 
      EMPRESA_BAIRRO, 
      EMPRESA_CIDADE, 
      EMPRESA_UF, 
      EMPRESA_FONES, 
      EMPRESA_EMAIL, 
      ENTREGUE, 
      IDVENDA, 
      OUTRASINF
    DO
    BEGIN
      SUSPEND;
    END
    EXIT;
  END

  FOR SELECT 
    PEDVEND.CODPEDVEND,
    PEDVEND.CODPESSOA,
    PEDVEND.STATUSPED, 
    PEDVEND.TIPOPED,
    EXTRACT(YEAR FROM PEDVEND.DT_ENTREGAPREV)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGAPREV),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGAPREV),2),
    RIGHT('00'||EXTRACT(HOUR FROM PEDVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM PEDVEND.DT_ENTREGAPREV),2),
    EXTRACT(YEAR FROM PEDVEND.DTFATURADO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DTFATURADO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DTFATURADO),2),
    EXTRACT(YEAR FROM PEDVEND.DT_SAIDA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_SAIDA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_SAIDA),2),
  EXTRACT(YEAR FROM PEDVEND.DT_ENTREGA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGA),2),
    PESSOA.CPFCGC,
    COALESCE(NULLIF(PEDVEND.NOME,''), PESSOA.NOME),
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    PEDVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    COALESCE(PEDVEND.OBSPED1,''),
    COALESCE(PEDVEND.OBSPED2,''),
    COALESCE(PEDVEND.OBSPED3,''),
    COALESCE(PEDVEND.CODNFVENDA, 0) CODNFVENDA,
    PEDVEND.VALOR_BRUTO,
    COALESCE(PEDVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(PEDVEND.ACRESVALOR, 0) ACRESVALOR,
    COALESCE(PEDVEND.FRETE, 0) FRETE,
    PEDVEND.VALOR_TOTAL,
    PEDVEND.CODTIPOPAG,
    PEDVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(PEDVEND.DESCONTO,0),
    COALESCE(PEDVEND.DESCPERC_VALOR, 0),
    COALESCE(PEDVEND.ENTREGUE,'N'),
    PEDVEND.GEN_TEMPESTOQTEMP,
    PEDVEND.CODEMPRESA
  FROM
    PEDVEND
    JOIN PESSOA ON
      PEDVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    LEFT JOIN TIPOPAG ON 
      PEDVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
  WHERE
    (PEDVEND.GEN_TEMPESTOQTEMP = :EIDPEDIDO
    OR CAST(PEDVEND.CODPEDVEND AS VARCHAR(40)) = :EIDPEDIDO) 
 ORDER BY
    PEDVEND.DT_ENTREGAPREV DESC
  INTO
    CODPEDVEND,
    CODPESSOA,
    STATUSPED, 
    TIPOPED,
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DTFATURADO,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    OBS3,
    CODNFVENDA,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    IDVENDA,
    LCODEMPRESA
  DO
  BEGIN
    SELECT
      EMPRESA.CGC ,
      EMPRESA.RAZAOSOCIAL ,
      EMPRESA.EMPRESA ,
      EMPRESA.CEP ,    
      EMPRESA.LOGRADOURO ,
      EMPRESA.NUMERO ,
      EMPRESA.BAIRRO ,
      EMPRESA.CIDADE,
      EMPRESA.UF    ,
      EMPRESA.FONES,
      EMPRESA.EMAIL    
    FROM 
      EMPRESA
    WHERE 
      CODEMPRESA = :LCODEMPRESA
    INTO 
      EMPRESA_CNPJ,
      EMPRESA_RAZAO,
      EMPRESA_FANTAZIA,
      EMPRESA_CEP,
      EMPRESA_LOGRADOURO,
      EMPRESA_NUMERO,
      EMPRESA_BAIRRO,
      EMPRESA_CIDADE,
      EMPRESA_UF,
      EMPRESA_FONES,
      EMPRESA_EMAIL;    
    OUTRASINF = '';
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_ORCAMENTO(
    EIDORCVEND VARCHAR(40))
RETURNS (
    IDORCVEND VARCHAR(40),
    CODORCVEND INTEGER,
    IDVENDA VARCHAR(40),
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    STATUSORC VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    OBS3 VARCHAR(100),
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    ACRESCIMO DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    EMPRESA_CODEMPRESA VARCHAR(60),
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1))
AS
DECLARE VARIABLE LCODVENDEDOR INTEGER;
BEGIN
  FOR SELECT 
    TBL_ORCVEND.CODORCVEND,
    TBL_ORCVEND.CODPEDVEND,
    TBL_ORCVEND.CODPESSOA,
    TBL_ORCVEND.STATUSORC, 
    EXTRACT(YEAR FROM TBL_ORCVEND.DT_ENTREGAPREV)||'-'||RIGHT('00'||EXTRACT(MONTH FROM TBL_ORCVEND.DT_ENTREGAPREV),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM TBL_ORCVEND.DT_ENTREGAPREV),2),
    RIGHT('00'||EXTRACT(HOUR FROM TBL_ORCVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM TBL_ORCVEND.DT_ENTREGAPREV),2),
    EXTRACT(YEAR FROM TBL_ORCVEND.DT_SAIDA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM TBL_ORCVEND.DT_SAIDA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM TBL_ORCVEND.DT_SAIDA),2),
    EXTRACT(YEAR FROM TBL_ORCVEND.DT_ENTREGA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM TBL_ORCVEND.DT_ENTREGA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM TBL_ORCVEND.DT_ENTREGA),2),
    PESSOA.CPFCGC,
    PESSOA.NOME,
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    TBL_ORCVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    COALESCE(TBL_ORCVEND.OBSORC1,''),
    COALESCE(TBL_ORCVEND.OBSORC2,''),
    COALESCE(TBL_ORCVEND.OBSORC3,''),
    TBL_ORCVEND.VALOR_BRUTO,
    COALESCE(TBL_ORCVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(TBL_ORCVEND.ACRESVALOR, 0) ACRESVALOR,
    COALESCE(TBL_ORCVEND.ACRESCIMO, 0) ACRESCIMO,    
    COALESCE(TBL_ORCVEND.FRETE,0 ) FRETE,
    TBL_ORCVEND.VALOR_TOTAL,
    TBL_ORCVEND.CODTIPOPAG,
    TBL_ORCVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(TBL_ORCVEND.DESCONTO,0),
    COALESCE(TBL_ORCVEND.DESCPERC_VALOR, 0),
    COALESCE(TBL_ORCVEND.ENTREGUE,'N'),
    TBL_ORCVEND.IDORCVEND,
    TBL_ORCVEND.CODEMPRESA
  FROM
    TBL_ORCVEND
    JOIN PESSOA ON
      TBL_ORCVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      TBL_ORCVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    LEFT JOIN TIPOPAG ON 
      TBL_ORCVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
  WHERE
    (TBL_ORCVEND.IDORCVEND = :EIDORCVEND
    OR CAST(TBL_ORCVEND.CODORCVEND AS VARCHAR(40)) = :EIDORCVEND) 
 ORDER BY
    TBL_ORCVEND.DT_ENTREGAPREV DESC
 INTO
    CODORCVEND,
    CODPEDVEND,
    CODPESSOA,
    STATUSORC, 
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    OBS3,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    ACRESCIMO,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    IDORCVEND,
    EMPRESA_CODEMPRESA
  DO
  BEGIN
    SELECT GEN_TEMPESTOQTEMP  FROM PEDVEND WHERE CODPEDVEND  = :CODPEDVEND INTO IDVENDA;   
    SELECT
      EMPRESA.CGC ,
      EMPRESA.RAZAOSOCIAL ,
      EMPRESA.EMPRESA ,
      EMPRESA.CEP ,    
      EMPRESA.LOGRADOURO ,
      EMPRESA.NUMERO ,
      EMPRESA.BAIRRO ,
      EMPRESA.CIDADE,
      EMPRESA.UF    ,
      EMPRESA.FONES,
      EMPRESA.EMAIL    
    FROM 
      EMPRESA
    WHERE 
      CODEMPRESA = :EMPRESA_CODEMPRESA
    INTO 
      EMPRESA_CNPJ,
      EMPRESA_RAZAO,
      EMPRESA_FANTAZIA,
      EMPRESA_CEP,
      EMPRESA_LOGRADOURO,
      EMPRESA_NUMERO,
      EMPRESA_BAIRRO,
      EMPRESA_CIDADE,
      EMPRESA_UF,
      EMPRESA_FONES,
      EMPRESA_EMAIL;    
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_ORCAMENTOS(
    EEMAIL VARCHAR(100),
    EFILTROCLIENTE VARCHAR(100),
    EFILTROPEDIDO VARCHAR(100),
    EDATAINICIO DATE,
    EDATAFIM DATE,
    EFILTROSTATUS VARCHAR(1),
    ECOVENDEDOR INTEGER = 0)
RETURNS (
    CODORCVEND INTEGER,
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    IDORCVEND VARCHAR(40),
    STATUSORC VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    OBS3 VARCHAR(100),
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1),
    IDVENDA VARCHAR(40))
AS
DECLARE VARIABLE LCODEMPRESA INTEGER;
BEGIN
  SELECT CODEMPRESA FROM USERCAD WHERE EMAIL = :EEMAIL INTO LCODEMPRESA;
 
  SELECT
    EMPRESA.CGC ,
    EMPRESA.RAZAOSOCIAL ,
    EMPRESA.EMPRESA ,
    EMPRESA.CEP ,    
    EMPRESA.LOGRADOURO ,
    EMPRESA.NUMERO ,
    EMPRESA.BAIRRO ,
    EMPRESA.CIDADE,
    EMPRESA.UF    ,
    EMPRESA.FONES,
    EMPRESA.EMAIL    
  FROM 
    EMPRESA
  WHERE 
    CODEMPRESA = :LCODEMPRESA
  INTO 
    EMPRESA_CNPJ,
    EMPRESA_RAZAO,
    EMPRESA_FANTAZIA,
    EMPRESA_CEP,
    EMPRESA_LOGRADOURO,
    EMPRESA_NUMERO,
    EMPRESA_BAIRRO,
    EMPRESA_CIDADE,
    EMPRESA_UF,
    EMPRESA_FONES,
    EMPRESA_EMAIL;

  FOR SELECT 
    TBL_ORCVEND.CODORCVEND,
    TBL_ORCVEND.CODPEDVEND,
    TBL_ORCVEND.CODPESSOA,
    TBL_ORCVEND.IDORCVEND,
    TBL_ORCVEND.STATUSORC, 
    DATETOSTRING(TBL_ORCVEND.DT_ENTREGAPREV),
    RIGHT('00'||EXTRACT(HOUR FROM TBL_ORCVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM TBL_ORCVEND.DT_ENTREGAPREV),2),
    DATETOSTRING(TBL_ORCVEND.DT_SAIDA),
    DATETOSTRING(TBL_ORCVEND.DT_ENTREGA),
    PESSOA.CPFCGC,
    PESSOA.NOME,
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    TBL_ORCVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    COALESCE(TBL_ORCVEND.OBSORC1,''),
    COALESCE(TBL_ORCVEND.OBSORC2,''),
    COALESCE(TBL_ORCVEND.OBSORC3,''),
    TBL_ORCVEND.VALOR_BRUTO,
    COALESCE(TBL_ORCVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(TBL_ORCVEND.ACRESVALOR, 0) ACRESVALOR,
    COALESCE(TBL_ORCVEND.FRETE,0 ) FRETE,
    TBL_ORCVEND.VALOR_TOTAL,
    TBL_ORCVEND.CODTIPOPAG,
    TBL_ORCVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(TBL_ORCVEND.DESCONTO,0),
    COALESCE(TBL_ORCVEND.DESCPERC_VALOR, 0),
    COALESCE(TBL_ORCVEND.ENTREGUE,'N'),
    TBL_ORCVEND.IDORCVEND,
    TBL_ORCVEND.CODEMPRESA
  FROM
    TBL_ORCVEND
    JOIN PESSOA ON
      TBL_ORCVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      TBL_ORCVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    LEFT JOIN TIPOPAG ON 
      TBL_ORCVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
  WHERE
    (
      (CAST(TBL_ORCVEND.CODORCVEND AS VARCHAR(100)) = :EFILTROPEDIDO) OR
      (
        (:EFILTROPEDIDO = '') AND
        (
          (:EFILTROSTATUS = 'T') OR
          ((:EFILTROSTATUS = 'C') AND (TBL_ORCVEND.STATUSORC = 'CANCELADO')) OR
          ((:EFILTROSTATUS = 'F') AND (TBL_ORCVEND.STATUSORC = 'FATURADO')) OR
          ((:EFILTROSTATUS = 'N') AND (TBL_ORCVEND.STATUSORC = 'NORMAL'))
        )
        AND (
          (:EFILTROCLIENTE = '') OR
          (PESSOA.NOME CONTAINING :EFILTROCLIENTE) OR
          (REPLACE(REPLACE(REPLACE(PESSOA.CPFCGC,'.',''),'/',''),'-','') CONTAINING :EFILTROCLIENTE) OR
          (CAST(PESSOA.CODPESSOA AS VARCHAR(60)) CONTAINING :EFILTROCLIENTE) OR
          (TBL_ORCVEND.CODORCVEND CONTAINING :EFILTROCLIENTE)
        )
        AND (
          CAST(TBL_ORCVEND.DT_SAIDA AS DATE) BETWEEN :EDATAINICIO AND :EDATAFIM
        )
      )
    )
    AND ((:ECOVENDEDOR = 0) OR (TBL_ORCVEND.CODVENDEDOR = :ECOVENDEDOR))
 ORDER BY
    TBL_ORCVEND.DT_ENTREGAPREV DESC
 INTO
    CODORCVEND,
    CODPEDVEND,
    CODPESSOA,
    IDORCVEND,
    STATUSORC, 
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    OBS3,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    IDVENDA,
    LCODEMPRESA
  DO
  BEGIN
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_PEDIDO(
    EIDPEDIDO VARCHAR(40))
RETURNS (
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    STATUSPED VARCHAR(10),
    TIPOPED VARCHAR(10),
    DTFATURADO VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    OBS3 VARCHAR(100),
    CODNFVENDA INTEGER,
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    ACRESCIMO DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    ENTREGA_CEP VARCHAR(9),
    ENTREGA_LOGRADOURO VARCHAR(60),
    ENTREGA_NUMERO VARCHAR(30),
    ENTREGA_BAIRRO VARCHAR(45),
    ENTREGA_CIDADE VARCHAR(45),
    ENTREGA_UF VARCHAR(2),
    EMPRESA_CODEMPRESA INTEGER,
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1),
    TIPOFRETE VARCHAR(1),
    IDVENDA VARCHAR(40),
    OUTRASINF BLOB SUB_TYPE BINARY SEGMENT SIZE 80,
    CODTIPOPED INTEGER,
    DT_CADAST VARCHAR(10),
    VALOR_PESOVAR DOUBLE PRECISION,
    PRECOPRATICADO VARCHAR(10),
    STATUSEXPEDICAO VARCHAR(11),
    DTCANCELA VARCHAR(10),
    US_CANCELOU VARCHAR(45),
    OBS_CACELAMENTO VARCHAR(200))
AS
declare variable LSQL blob sub_type 1 segment size 80;
BEGIN
  
   IF (EXISTS(SELECT 1 FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_PEDIDO')) THEN
  BEGIN
    SELECT SQL FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_PEDIDO' INTO LSQL;
    FOR EXECUTE STATEMENT 
      (LSQL)
      (EIDPEDIDO := :EIDPEDIDO)
    INTO
      CODPEDVEND, 
      CODTIPOPAG, 
      STATUSPED, 
      TIPOPED, 
      DTFATURADO, 
      DT_SAIDA, 
      DT_ENTREGA, 
      DT_ENTREGAPREV, 
      H_ENTREGAPREV, 
      TIPOPAG, 
      FORMA_PAGAMENTO, 
      CODPESSOA, 
      CPFCNPJ_CLIENTE, 
      NOME_CLIENTE, 
      NOMEFANTAZIA, 
      CEP_1, 
      LOGRADOURO_1, 
      NUMERO_1, 
      BAIRRO_1, 
      CIDADE_1, 
      UF_1, 
      FONES, 
      EMAIL_CLIENTE, 
      IE, 
      PESSOA_CONTATO, 
      CODVENDEDOR, 
      NOME_VENDEDOR, 
      OBS1, 
      OBS2, 
      OBS3, 
      CODNFVENDA, 
      VALOR_BRUTO, 
      DESCONTO, 
      DESCPERC_VALOR, 
      DESC_VALOR, 
      ACRESVALOR, 
      FRETE, 
      VALOR_TOTAL, 
      EMPRESA_CODEMPRESA,
      EMPRESA_CNPJ, 
      EMPRESA_RAZAO, 
      EMPRESA_FANTAZIA, 
      EMPRESA_CEP, 
      EMPRESA_LOGRADOURO, 
      EMPRESA_NUMERO, 
      EMPRESA_BAIRRO, 
      EMPRESA_CIDADE, 
      EMPRESA_UF, 
      EMPRESA_FONES, 
      EMPRESA_EMAIL, 
      ENTREGUE, 
      IDVENDA,
      OUTRASINF,
      CODTIPOPED,
      DT_CADAST,
      VALOR_PESOVAR,
      PRECOPRATICADO,
      STATUSEXPEDICAO,
      DTCANCELA,
      US_CANCELOU,
      OBS_CACELAMENTO
    DO
    BEGIN
      SUSPEND;
    END
    EXIT;
  END
  
  
  FOR SELECT 
    PEDVEND.CODPEDVEND,
    PEDVEND.CODPESSOA,
    PEDVEND.STATUSPED, 
    PEDVEND.TIPOPED,
    EXTRACT(YEAR FROM PEDVEND.DT_ENTREGAPREV)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGAPREV),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGAPREV),2),
    RIGHT('00'||EXTRACT(HOUR FROM PEDVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM PEDVEND.DT_ENTREGAPREV),2),
    EXTRACT(YEAR FROM PEDVEND.DTFATURADO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DTFATURADO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DTFATURADO),2),
    EXTRACT(YEAR FROM PEDVEND.DT_SAIDA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_SAIDA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_SAIDA),2),
    EXTRACT(YEAR FROM PEDVEND.DT_ENTREGA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGA),2),
    PESSOA.CPFCGC,
    COALESCE(NULLIF(PEDVEND.NOME,''), PESSOA.NOME),
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    PEDVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    COALESCE(PEDVEND.OBSPED1,''),
    COALESCE(PEDVEND.OBSPED2,''),
    COALESCE(PEDVEND.OBSPED3,''),
    COALESCE(PEDVEND.CODNFVENDA, 0) CODNFVENDA,
    PEDVEND.VALOR_BRUTO,
    COALESCE(PEDVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(PEDVEND.ACRESVALOR , 0) ACRESVALOR,
    COALESCE(PEDVEND.ACRESCIMO , 0) ACRESCIMO,
    COALESCE(PEDVEND.FRETE, 0) FRETE,
    PEDVEND.VALOR_TOTAL,
    PEDVEND.CODTIPOPAG,
    PEDVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(PEDVEND.DESCONTO,0),
    COALESCE(PEDVEND.DESCPERC_VALOR, 0),
    COALESCE(PEDVEND.ENTREGUE,'N'),
    PEDVEND.TIPOFRETE,
    PEDVEND.GEN_TEMPESTOQTEMP,
    PEDVEND.CODEMPRESA,  
    COALESCE(PEDVEND_ENDERECO.CEP, PESSOA.CEP_1),
    COALESCE(PEDVEND_ENDERECO.LOGRADOURO, PESSOA.LOGRADOURO_1),
    COALESCE(PEDVEND_ENDERECO.NUMERO, PESSOA.NUMERO_1),
    COALESCE(PEDVEND_ENDERECO.BAIRRO, PESSOA.BAIRRO_1),
    COALESCE(PEDVEND_ENDERECO.MUNICIPIO, PESSOA.CIDADE_1), 
    COALESCE(PEDVEND_ENDERECO.UF, PESSOA.UF_1),
    TIPOVENDA.CODTIPOPED,
    EXTRACT(YEAR FROM PEDVEND.DT_CADAST)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_CADAST),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_CADAST),2),
    PEDVEND.PRECOUSADO,
    PEDVEND.STATUSEXPEDICAO,
    EXTRACT(YEAR FROM PEDVEND.DTCANCELA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DTCANCELA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DTCANCELA),2),
    PEDVEND.US_CANCELOU,
    COALESCE(PEDVEND.OBS1,'') || COALESCE(PEDVEND.OBS2,'')
  FROM
    PEDVEND
    JOIN PESSOA ON
      PEDVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    JOIN TIPOVENDA ON
      PEDVEND.TIPOPED = TIPOVENDA.TIPOPED
    LEFT JOIN TIPOPAG ON 
      PEDVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
    LEFT JOIN PEDVEND_ENDERECO ON
      PEDVEND_ENDERECO.CODPEDVEND = PEDVEND.CODPEDVEND      
  WHERE
    PEDVEND.GEN_TEMPESTOQTEMP = :EIDPEDIDO
 ORDER BY
    PEDVEND.DT_ENTREGAPREV DESC
  INTO
    CODPEDVEND,
    CODPESSOA,
    STATUSPED, 
    TIPOPED,
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DTFATURADO,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    OBS3,
    CODNFVENDA,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    ACRESCIMO,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    TIPOFRETE,
    IDVENDA,
    EMPRESA_CODEMPRESA,
    ENTREGA_CEP,
    ENTREGA_LOGRADOURO,
    ENTREGA_NUMERO,
    ENTREGA_BAIRRO,
    ENTREGA_CIDADE,
    ENTREGA_UF,
    CODTIPOPED,
    DT_CADAST,
    PRECOPRATICADO,
    STATUSEXPEDICAO,
    DTCANCELA,
    US_CANCELOU,
    OBS_CACELAMENTO
  DO
  begin
    
    SELECT 
      sum(SIMPLEROUNDTO( ( (PEDVENDITEM.QTDE * PEDVENDITEM.PRECOPROD) * (PRODFILHO.TOLERANCIA_PECA / 100) ), -2))
    FROM 
      PEDVENDITEM 
      JOIN PRODFILHO ON
        PEDVENDITEM.CODPRODFILHO  = PRODFILHO.CODPRODFILHO 
        AND PRODFILHO.FLAG_PESOVARIAVEL = 'S'
    WHERE 
      PEDVENDITEM.CODPEDVEND = :CODPEDVEND 
    into 
      VALOR_PESOVAR;
        
    SELECT
      EMPRESA.CGC ,
      EMPRESA.RAZAOSOCIAL ,
      EMPRESA.EMPRESA ,
      EMPRESA.CEP ,    
      EMPRESA.LOGRADOURO ,
      EMPRESA.NUMERO ,
      EMPRESA.BAIRRO ,
      EMPRESA.CIDADE,
      EMPRESA.UF    ,
      EMPRESA.FONES,
      EMPRESA.EMAIL    
    FROM 
      EMPRESA
    WHERE 
      CODEMPRESA = :EMPRESA_CODEMPRESA
    INTO 
      EMPRESA_CNPJ,
      EMPRESA_RAZAO,
      EMPRESA_FANTAZIA,
      EMPRESA_CEP,
      EMPRESA_LOGRADOURO,
      EMPRESA_NUMERO,
      EMPRESA_BAIRRO,
      EMPRESA_CIDADE,
      EMPRESA_UF,
      EMPRESA_FONES,
      EMPRESA_EMAIL;  
    OUTRASINF = '';
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_PEDIDOS_FILTRADOS(
    EEMAIL VARCHAR(100),
    EENTREGUE VARCHAR(1),
    EFILTROCLIENTE VARCHAR(100),
    EFILTROPEDIDO VARCHAR(100),
    EDATAINICIO DATE,
    EDATAFIM DATE,
    ECODVENDEDOR INTEGER = 0)
RETURNS (
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    STATUSPED VARCHAR(10),
    TIPOPED VARCHAR(10),
    DTFATURADO VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    CODNFVENDA INTEGER,
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1),
    IDVENDA VARCHAR(40))
AS
DECLARE VARIABLE LCODEMPRESA INTEGER;
BEGIN
  SELECT CODEMPRESA FROM USERCAD WHERE EMAIL = :EEMAIL INTO LCODEMPRESA;
 
  SELECT
    EMPRESA.CGC ,
    EMPRESA.RAZAOSOCIAL ,
    EMPRESA.EMPRESA ,
    EMPRESA.CEP ,    
    EMPRESA.LOGRADOURO ,
    EMPRESA.NUMERO ,
    EMPRESA.BAIRRO ,
    EMPRESA.CIDADE,
    EMPRESA.UF    ,
    EMPRESA.FONES,
    EMPRESA.EMAIL    
  FROM 
    EMPRESA
  WHERE 
    CODEMPRESA = :LCODEMPRESA
  INTO 
    EMPRESA_CNPJ,
  EMPRESA_RAZAO,
  EMPRESA_FANTAZIA,
  EMPRESA_CEP,
  EMPRESA_LOGRADOURO,
  EMPRESA_NUMERO,
  EMPRESA_BAIRRO,
  EMPRESA_CIDADE,
  EMPRESA_UF,
  EMPRESA_FONES,
  EMPRESA_EMAIL;


FOR SELECT 
    PEDVEND.CODPEDVEND,
    PEDVEND.CODPESSOA,
    PEDVEND.STATUSPED, 
    PEDVEND.TIPOPED,
    EXTRACT(YEAR FROM PEDVEND.DT_ENTREGAPREV)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGAPREV),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGAPREV),2),
    RIGHT('00'||EXTRACT(HOUR FROM PEDVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM PEDVEND.DT_ENTREGAPREV),2),
    EXTRACT(YEAR FROM PEDVEND.DTFATURADO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DTFATURADO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DTFATURADO),2),
    EXTRACT(YEAR FROM PEDVEND.DT_SAIDA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_SAIDA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_SAIDA),2),
  EXTRACT(YEAR FROM PEDVEND.DT_ENTREGA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGA),2),
    PESSOA.CPFCGC,
    COALESCE(NULLIF(PEDVEND.NOME,''), PESSOA.NOME),
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    PEDVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    PEDVEND.OBS1,
    PEDVEND.OBS2,
    COALESCE(PEDVEND.CODNFVENDA, 0) CODNFVENDA,
    PEDVEND.VALOR_BRUTO,
    COALESCE(PEDVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(PEDVEND.ACRESVALOR, 0) ACRESVALOR,
    COALESCE(PEDVEND.FRETE, 0) FRETE,    
    PEDVEND.VALOR_TOTAL,
    PEDVEND.CODTIPOPAG,
    PEDVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(PEDVEND.DESCONTO,0),
    COALESCE(PEDVEND.DESCPERC_VALOR, 0),
    COALESCE(PEDVEND.ENTREGUE,'N'),
    PEDVEND.GEN_TEMPESTOQTEMP,
    PEDVEND.CODEMPRESA
  FROM
    PEDVEND
    JOIN PESSOA ON
      PEDVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    LEFT JOIN TIPOPAG ON 
      PEDVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
  WHERE
    (
      (CAST(PEDVEND.CODPEDVEND AS VARCHAR(100)) = :EFILTROPEDIDO) OR
      (
        (:EFILTROPEDIDO = '')
        AND (PEDVEND.STATUSPED <> 'CANCELADO')
        AND (:EENTREGUE = 'T' OR PEDVEND.ENTREGUE = :EENTREGUE)
        AND (
          (:EFILTROCLIENTE = '') OR
          (COALESCE(NULLIF(PEDVEND.NOME,''), PESSOA.NOME) CONTAINING :EFILTROCLIENTE) OR
          (REPLACE(REPLACE(REPLACE(PESSOA.CPFCGC,'.',''),'/',''),'-','') CONTAINING :EFILTROCLIENTE) OR
          (PESSOA.CODPESSOA CONTAINING :EFILTROCLIENTE)
        ) 
        AND PEDVEND.TIPOPED IN ('VENDA', 'CADERNO', 'DELIVERY')
        AND PEDVEND.STATUSPED IN ('FATURADO', 'NORMAL')
        AND CAST(PEDVEND.DT_ENTREGAPREV AS DATE) BETWEEN :EDATAINICIO AND :EDATAFIM
      )
    )
    AND ((:ECODVENDEDOR = 0) OR (PEDVEND.CODVENDEDOR = :ECODVENDEDOR))
 ORDER BY
    PEDVEND.DT_ENTREGAPREV DESC
 INTO
    CODPEDVEND,
    CODPESSOA,
    STATUSPED, 
    TIPOPED,
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DTFATURADO,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    CODNFVENDA,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    IDVENDA,
    LCODEMPRESA
  DO
  BEGIN
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DIACCERA_ENTRADAS(
    EDATAINI DATE,
    EDATAFIM DATE,
    ECOD INTEGER)
RETURNS (
    CPFCGC VARCHAR(18),
    CNPJDISTRIBUIDOR VARCHAR(18),
    DOCUMENTO VARCHAR(15),
    STATUS CHAR(1),
    TOTNOTVLR INTEGER,
    QTD VARCHAR(30),
    DTEMISSAO VARCHAR(8),
    DTENTRADA VARCHAR(8))
AS
DECLARE VARIABLE LFABRICANTES VARCHAR(100);
DECLARE VARIABLE LGRUPOS VARCHAR(500);
BEGIN
  SELECT COALESCE(CODFABRICANTE,''), COALESCE(CODGRUPOS,'') FROM INTEGRACAOARQ WHERE IDINTEGRACAOARQ = :ECOD INTO LFABRICANTES, LGRUPOS;
  LFABRICANTES = TRIM(REPLACE(LFABRICANTES,' ',''));
  LGRUPOS = TRIM(REPLACE(LGRUPOS,' ',''));

  SELECT
    TIRARMASCARA(EMPRESA.CGC)
  FROM
    EMPRESA
    JOIN INTEGRACAOARQ ON
      EMPRESA.CODEMPRESA = INTEGRACAOARQ.CODEMPRESA
  WHERE
    IDINTEGRACAOARQ = :ECOD
  INTO
    CNPJDISTRIBUIDOR;

  FOR SELECT
    TIRARMASCARA(P.CPFCGC),
    N.DOCUMENTO,
    CASE
      WHEN N.NFE_TIPO = 'ENTRADA' THEN 'E'
    ELSE
      'R'
    END STATUS,
    CAST(N.TOTNOTVLR AS INTEGER) TOTNOTVLR,
    CAST(SUM(NI.QTD) AS INTEGER) QTD,
    (EXTRACT( YEAR FROM N.DTEMISSAO) || RIGHT('00' || EXTRACT(MONTH FROM N.DTEMISSAO), 2) || RIGHT('00' || EXTRACT(DAY FROM N.DTEMISSAO), 2)) AS DTEMISSAO,
    (EXTRACT( YEAR FROM N.DTENTRADA) || RIGHT('00' || EXTRACT(MONTH FROM N.DTENTRADA), 2) || RIGHT('00' || EXTRACT(DAY FROM N.DTENTRADA), 2)) AS DTENTRADA
  FROM
    NFENTRADA N
    JOIN PESSOA P ON
      N.CODPESSOA = P.CODPESSOA
    JOIN NFENTRADAITENS NI ON
      N.CODNFENTRADA = NI.CODNFENTRADA
    join prodfilho pf on
      ni.CODPRODFILHO = pf.CODPRODFILHO
    join produto pr on
      pf.CODPRODUTO = pr.CODPRODUTO
  WHERE
    CAST(N.DT_CADAST AS DATE) BETWEEN :EDATAINI AND :EDATAFIM
    AND (
      :LFABRICANTES = '' OR
      ','||:LFABRICANTES||',' CONTAINING ','||PR.CODFABRICANTE||','
    )
    AND (
      :LGRUPOS = '' OR
      ','||:LGRUPOS||',' CONTAINING ','||PR.CODGRUPO||','
    )
  GROUP BY
    1,2,3,4,6,7
  INTO
    :CPFCGC,
    :DOCUMENTO,
    :STATUS,
    :TOTNOTVLR,
    :QTD,
    :DTEMISSAO,
    :DTENTRADA
  DO
  BEGIN
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DIACCERA_ESTOQUE(
    EDATAINI DATE,
    EDATAFIM DATE,
    ECOD INTEGER)
RETURNS (
    CNPJDISTRIBUIDOR VARCHAR(18),
    CNPJEMPRESA VARCHAR(18),
    DUN VARCHAR(30),
    QTDESTOQUE VARCHAR(30),
    DATA VARCHAR(8),
    LOTE VARCHAR(200),
    DTVAL VARCHAR(8),
    CODGRUPO INTEGER,
    CODPRODFIHO INTEGER)
AS
declare variable LQTDEMBALAGEM double precision;
declare variable LQTDESTOQUE double precision;
declare variable LFABRICANTES varchar(100);
declare variable LGRUPOS varchar(500);
BEGIN
  SELECT COALESCE(CODFABRICANTE,''), COALESCE(CODGRUPOS,'') FROM INTEGRACAOARQ WHERE IDINTEGRACAOARQ = :ECOD INTO LFABRICANTES, LGRUPOS;
  LFABRICANTES = TRIM(REPLACE(LFABRICANTES,' ',''));
  LGRUPOS = TRIM(REPLACE(LGRUPOS,' ',''));

  SELECT
    TIRARMASCARA(EMPRESA.CGC)
  FROM
    EMPRESA
    JOIN INTEGRACAOARQ ON
      EMPRESA.CODEMPRESA = INTEGRACAOARQ.CODEMPRESA
  WHERE
    IDINTEGRACAOARQ = :ECOD
  INTO
    CNPJDISTRIBUIDOR;

  FOR SELECT
    PRODFILHO.CODPRODFILHO,
    TIRARMASCARA(PESSOA.CPFCGC),
    COALESCE(PRODFILHO.CODPESQ2,PRODFILHO.CODPRODFILHO) DUN,
    PRODFILHO.QTDEMBALAGEM,
    (EXTRACT(YEAR FROM CURRENT_DATE) || RIGHT('00' || EXTRACT(MONTH FROM CURRENT_DATE), 2) || RIGHT('00' || EXTRACT(DAY FROM CURRENT_DATE), 2)) AS DATA,
    PRODFILHO.ESTQATUAL,
    PRODUTO.CODGRUPO
  FROM
     PRODFILHO
     JOIN PRODUTO ON
       (PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO)
     JOIN PESSOA ON
      (PESSOA.CODPESSOA = PRODUTO.CODFABRICANTE)
  where
    (
      :LFABRICANTES = '' OR
      ','||:LFABRICANTES||',' CONTAINING ','||PRODUTO.CODFABRICANTE||','
    )
    AND (
      :LGRUPOS = '' OR
      ','||:LGRUPOS||',' CONTAINING ','||PRODUTO.CODGRUPO||','
    )
  INTO
    :CODPRODFIHO,
    :CNPJEMPRESA,
    :DUN,
    :LQTDEMBALAGEM,
    :DATA,
    :LQTDESTOQUE,
    :CODGRUPO
  DO
  BEGIN
    IF (COALESCE(LQTDEMBALAGEM,0) > 1) THEN
    BEGIN
      LQTDESTOQUE = LQTDESTOQUE / LQTDEMBALAGEM;
    END

    QTDESTOQUE = cast(trunc(LQTDESTOQUE * 1000) as integer);

    IF (LQTDESTOQUE > 0) THEN
      SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DIACCERA_VENDAS(
    EDATAINI DATE,
    EDATAFIM DATE,
    ECOD INTEGER)
RETURNS (
    DUN VARCHAR(30),
    CNPJCLIENTE VARCHAR(18),
    CLIENTE VARCHAR(60),
    CODSEGMENTO INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA VARCHAR(20),
    TIPOPED VARCHAR(10),
    TIPOPESSOA VARCHAR(1),
    PDV_EMPRESA VARCHAR(60),
    PDV_CEP VARCHAR(9),
    NOME_VENDEDOR VARCHAR(60),
    CODNFVENDA VARCHAR(14),
    VLRVENDIDO VARCHAR(30),
    QTDVENDIDA VARCHAR(30),
    QTDEMBALAGEM INTEGER,
    TIPOCODIGO VARCHAR(10),
    CODGRUPO INTEGER,
    CODPESSOA INTEGER,
    CODSTATUS_CHECKOUT INTEGER,
    ATIVIDADE VARCHAR(60),
    CODPRODFILHO INTEGER,
    PRODUTO VARCHAR(60),
    QTD NUMERIC(15,2),
    QTDUNIDADE NUMERIC(15,2),
    VALOR NUMERIC(15,2),
    CODSUPERVISOR INTEGER,
    CNPJFABRICANTE VARCHAR(20))
AS
declare variable DTINI date;
declare variable LFABRICANTES varchar(100);
declare variable LGRUPOS varchar(500);
BEGIN
  SELECT COALESCE(CODFABRICANTE,''), COALESCE(CODGRUPOS,'') FROM INTEGRACAOARQ WHERE IDINTEGRACAOARQ = :ECOD INTO LFABRICANTES, LGRUPOS;
  LFABRICANTES = TRIM(REPLACE(LFABRICANTES,' ',''));
  LGRUPOS = TRIM(REPLACE(LGRUPOS,' ',''));

  SELECT
    TIRARMASCARA(EMPRESA.CGC),
    TIRARMASCARA(EMPRESA.CEP)
  FROM
    EMPRESA
    JOIN INTEGRACAOARQ ON
      EMPRESA.CODEMPRESA = INTEGRACAOARQ.CODEMPRESA
  WHERE
    IDINTEGRACAOARQ = :ECOD
  INTO
    CNPJDISTRIBUIDOR,
    PDV_CEP;

  FOR SELECT
   CASE COALESCE(PRODFILHO.CODPESQ2 ,'')
      WHEN '' THEN
        PRODFILHO.CODPRODFILHO
      ELSE
        PRODFILHO.CODPESQ2
    END DUN,
    TIRARMASCARA(PESSOA.CPFCGC) CNPJCLIENTE,
    PESSOA.NOME CLIENTE,
    PESSOA.NOME,
    TIRARMASCARA(PESSOA.CEP_1),
    CASE COALESCE(TBL_RAMOATVTIPO.REFERENCIA,'')
      WHEN '' THEN 0
      ELSE TBL_RAMOATVTIPO.REFERENCIA
      END CODSEGMENTOPEPSICO,
    PEDVEND.CODVENDEDOR,
    (EXTRACT(YEAR FROM COALESCE(PEDVEND.DTFATURADO, PEDVEND.DT_SAIDA)) || RIGHT('00'||EXTRACT(MONTH FROM COALESCE(PEDVEND.DTFATURADO, PEDVEND.DT_SAIDA)),2) || RIGHT('00'||EXTRACT(DAY FROM COALESCE(PEDVEND.DTFATURADO, PEDVEND.DT_SAIDA)),2)) AS DATAVENDA,
    CASE
      WHEN PEDVEND.STATUSPED = 'CANCELADO' THEN 'C'
      WHEN PEDVEND.STATUSPED = 'DEVOLVIDO' THEN 'DV'
      WHEN ((PEDVEND.STATUSPED = 'FATURADO') AND (PEDVEND.TIPOPED IN ('VENDA','CADERNO'))) THEN 'V'
      WHEN ((PEDVEND.STATUSPED = 'FATURADO') AND (PEDVEND.TIPOPED = 'BONIFICA')) THEN 'B'
      WHEN ((PEDVEND.STATUSPED = 'FATURADO') AND (PEDVEND.TIPOPED IN ('TRANSFERENCIA','REMESSA F.')))  THEN 'T'
    END AS TIPOPED,
    COALESCE(PEDVEND.CODNFVENDA,PEDVEND.CODPEDVEND),
    PESSOA.PESSOA,
    COALESCE(NULLIF(PRODFILHO.QTDEMBALAGEM,1),1),
    CAST(CAST(SUM(((COALESCE(PEDVENDITEM.PRECOPROD,0) * COALESCE(PEDVENDITEM.QTDENTREGUE,1))
    + (((COALESCE(PEDVEND.ACRESVALOR,0) + (COALESCE(PEDVEND.VALOR_BRUTO,0) * (COALESCE(PEDVEND.ACRESCIMO,0)/100))) * (COALESCE(PEDVENDITEM.PRECOVEND,0) / COALESCE(NULLIF(PEDVEND.VALOR_BRUTO,1),1))))
    ) - (((COALESCE(PEDVEND.DESC_VALOR,0) + COALESCE(PEDVEND.DESCPERC_VALOR,0)) * (COALESCE(PEDVENDITEM.PRECOVEND,0) / COALESCE(NULLIF(PEDVEND.VALOR_BRUTO,1),1))) + COALESCE(PEDVENDITEM.DESCONTO_VALOR,0))) AS NUMERIC(18,2)) AS VARCHAR(30)) AS VLRVENDIDO,
    CAST(SUM(COALESCE(PEDVENDITEM.QTDE,0)) AS NUMERIC(18,5)) AS QTDVENDIDA,
    PRODUTO.CODGRUPO,
    PEDVEND.CODPESSOA,
    PESSOA.CODSTATUS_CHECKOUT,
    PRODFILHO.CODPRODFILHO,
    PRODFILHO.DESCRICAO
  FROM
    PEDVEND
    JOIN PESSOA ON (PESSOA.CODPESSOA = PEDVEND.CODPESSOA)
    LEFT JOIN TBL_RAMOATVTIPO ON (PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO)
    JOIN PEDVENDITEM ON PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
    JOIN PRODFILHO ON PEDVENDITEM.CODPRODFILHO =  PRODFILHO.CODPRODFILHO
    JOIN PRODUTO ON PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
  WHERE
    PEDVEND.STATUSPED in ('FATURADO','CANCELADO', 'DEVOLVIDO') AND
    PEDVEND.TIPOPED IN ('VENDA','CADERNO','BONIFICA','DEVOLU????O') AND
    COALESCE(PEDVEND.DTFATURADO, PEDVEND.DT_SAIDA) BETWEEN :EDATAINI AND :EDATAFIM
    AND (
      :LFABRICANTES = '' OR
      ','||:LFABRICANTES||',' CONTAINING ','||PRODUTO.CODFABRICANTE||','
    )
    AND (
      :LGRUPOS = '' OR
      ','||:LGRUPOS||',' CONTAINING ','||PRODUTO.CODGRUPO||','
    )
  GROUP BY
    1,2,3,4,5,6,7,8,9,10,11,12,15,16,17,18,19
  INTO
    :DUN,
    :CNPJCLIENTE,
    :CLIENTE,
    :PDV_EMPRESA,
    :PDV_CEP,
    :CODSEGMENTO,
    :CODVENDEDOR,
    :DATAVENDA,
    :TIPOPED,
    :CODNFVENDA,
    :TIPOPESSOA,
    :QTDEMBALAGEM,
    :VALOR,
    :QTD,
    :CODGRUPO,
    :CODPESSOA,
    :CODSTATUS_CHECKOUT,
    :CODPRODFILHO,
    PRODUTO
  DO
  BEGIN
    IF (STRLEN(DUN) > 13) THEN
    BEGIN
       QTDUNIDADE = QTD * QTDEMBALAGEM;
       QTDVENDIDA = CAST(((QTD * QTDEMBALAGEM) * 1000) AS INTEGER);
       TIPOCODIGO = 'DUN';
    END
    ELSE
    BEGIN
       QTDUNIDADE = QTD;
       QTDVENDIDA = CAST((QTD * 1000) AS INTEGER);
       TIPOCODIGO = 'EAN';
    END

    VLRVENDIDO = CAST((VALOR * 100) AS INTEGER);

    CODSUPERVISOR = 0;

    SELECT
      VENDEDOR.CODVENDEDOR || ' - ' || VENDEDOR.NOME,
      VENDEDOR.CODSUPERVISOR
    FROM
      VENDEDOR
    WHERE
      VENDEDOR.CODVENDEDOR = :CODVENDEDOR
    INTO
      :NOME_VENDEDOR,
      :CODSUPERVISOR;

    ATIVIDADE = '';

    SELECT STATUS.DESCRICAO FROM STATUS WHERE STATUS.CODSTATUS = :CODSTATUS_CHECKOUT INTO :ATIVIDADE;

    IF (ATIVIDADE = 'S.M. 05 A 09') THEN
    BEGIN
      ATIVIDADE = '5 A 9 CKS';
    END
    ELSE
    BEGIN
      ATIVIDADE = 'TRADICIONAL';
    END
    
    IF (COALESCE(CNPJCLIENTE,'') = '') THEN
    BEGIN
      CNPJCLIENTE = '11111111111111';
    END

    CNPJFABRICANTE = '50955707000472';

    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_CLIENTES
RETURNS (
    CNPJPDV VARCHAR(100),
    RAZAO_PDV VARCHAR(60),
    NOME_FANTASIA_PDV VARCHAR(60),
    PAIS_PDV VARCHAR(3),
    ESTADO_PDV VARCHAR(2),
    CIDADE_PDV VARCHAR(60),
    BAIRRO_PDV VARCHAR(60),
    ENDERECO_PDV VARCHAR(120),
    NOME_VENDEDOR VARCHAR(60),
    DT_CADASTRO VARCHAR(8),
    CEP_PDV VARCHAR(18),
    STATUS_PDV VARCHAR(1),
    CNPJDISTRIBUIDOR VARCHAR(100),
    EMAIL VARCHAR(45))
AS
BEGIN
  FOR select
    PESSOA.CPFCGC,
    PESSOA.NOME,
    PESSOA.NOMEFANTAZIA,
    'BRA',
    PESSOA.UF_1,
    PESSOA.CIDADE_1,
    PESSOA.BAIRRO_1,
    PESSOA.LOGRADOURO_1,
  vendedor.codvendedor  || ' - ' || VENDEDOR.NOME,
    extract(year from PESSOA.DT_CADAST)|| RIGHT('00' || extract(month from PESSOA.DT_CADAST), 2) || RIGHT('00' || extract(day from PESSOA.DT_CADAST), 2),
    (SELECT F.STRRESULT FROM FU_GETTIRAMASCARA(PESSOA.CEP_1) F) CEP_1,
    case
      when PESSOA.ATIVO = '2' then 'A' else 'I'
    end as ATIVO,
    PESSOA.EMAIL
  from
    PESSOA
      join VENDEDOR on VENDEDOR.CODVENDEDOR = PESSOA.CODVENDEDOR
  where
    PESSOA.TIPOPESSOA = 'Cliente'
  into
    :CNPJPDV,
    :RAZAO_PDV,
    :NOME_FANTASIA_PDV,
    :PAIS_PDV,
    :ESTADO_PDV,
    :CIDADE_PDV,
    :BAIRRO_PDV,
    :ENDERECO_PDV,
    :NOME_VENDEDOR,
    :DT_CADASTRO,
    :CEP_PDV,
    :STATUS_PDV,
    :EMAIL
  DO
  BEGIN
    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:CNPJPDV)
    into
      CNPJPDV;

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;

    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_ENTRADAS(
    INI DATE,
    FIM DATE)
RETURNS (
    CPFCGC VARCHAR(18),
    DOCUMENTO VARCHAR(15),
    STATUS CHAR(1),
    TOTNOTVLR INTEGER,
    QTD VARCHAR(30),
    DTEMISSAO VARCHAR(8),
    DTENTRADA VARCHAR(8))
AS
declare variable LCPFCGC varchar(18);
BEGIN
  FOR
    select
    P.CPFCGC,
    n.documento,
    CASE n.nfe_tipo
    WHEN 'ENTRADA' THEN 'E'
    ELSE
    'R'
    END STATUS,
    cast(n.totnotvlr as integer) totnotvlr,
    cast(sum(ni.qtd) as integer) QTD,
    (extract( year from n.dtemissao) || RIGHT('00' || extract(month from n.dtemissao), 2) || RIGHT('00' || extract(day from n.dtemissao), 2)) as dtemissao,
    (extract( year from n.dtentrada) || RIGHT('00' || extract(month from n.dtentrada), 2) || RIGHT('00' || extract(day from n.dtentrada), 2)) as dtentrada
    
    
    from
    nfentrada n join pessoa p on
    n.codpessoa = p.codpessoa
    join nfentradaitens ni on
    n.codnfentrada = ni.codnfentrada
    where
    cast(n.dt_cadast as date) between :ini and :fim
    group by
    1,2,3,4,6,7
    INTO :LCPFCGC,
         :DOCUMENTO,
         :STATUS,
         :TOTNOTVLR,
         :QTD,
         :DTEMISSAO,
         :DTENTRADA

  DO
  BEGIN
   SELECT F.STRRESULT FROM FU_GETTIRAMASCARA(:LCPFCGC) F
         INTO cpfcgc;
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_ESTOQUE(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    CNPJDISTRIBUIDOR VARCHAR(18),
    CNPJEMPRESA VARCHAR(18),
    DUN VARCHAR(30),
    QTDESTOQUE VARCHAR(30),
    DATA VARCHAR(8),
    LOTE VARCHAR(200),
    DTVAL VARCHAR(8))
AS
declare variable DTINI date;
declare variable DTFIM timestamp;
declare variable LCODPRODFILHO integer;
declare variable LQTDEMBALAGEM double precision;
declare variable LQTDESTOQUE double precision;
declare variable LESTOQUELOTE varchar(1);
begin
  DTINI = '01.'||extract(month from current_date)||'.'||extract(year from current_date);
  EDATAINI = cast(coalesce(EDATAINI,DTINI) as date);
  DTFIM = cast(coalesce(cast(EDATAFIM as timestamp),current_timestamp) as timestamp);

  for select
    PRODFILHO.CODPRODFILHO,
    PESSOA.CPFCGC,
    coalesce(PRODFILHO.CODPESQ2,PRODFILHO.CODPRODFILHO) DUN,
    PRODFILHO.QTDEMBALAGEM,
    (extract(year from current_date) || RIGHT('00' || extract(month from current_date), 2) || RIGHT('00' || extract(day from current_date), 2)) as DATA,
    PRODFILHOLOTES.LOTE,
    (extract( year from PRODFILHOLOTES.DATAVAL) || RIGHT('00' || extract(month from PRODFILHOLOTES.DATAVAL), 2) || RIGHT('00' || extract(day from PRODFILHOLOTES.DATAVAL), 2)) as DATAVAL,
    PRODFILHO.ESTOQUELOTE
  from
    PRODUTO
      join PRODFILHO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
      join PRODPESSOA on PRODPESSOA.CODPRODUTO = PRODUTO.CODPRODUTO
      join PESSOA on ((PESSOA.CODPESSOA = PRODPESSOA.CODPESSOA) and (PESSOA.TIPOPESSOA = 'Fornecedor'))
      Join prodfilholotes on prodfilho.codprodfilho = prodfilholotes.codprodfilho
  into
    LCODPRODFILHO,
    :CNPJEMPRESA,
    :DUN,
    :LQTDEMBALAGEM,
    :DATA,
    :lote,
    :dtval,
    :lestoquelote
  do
  begin
    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:CNPJEMPRESA)
    into
      :CNPJEMPRESA;
     if (lestoquelote = 'S') then
     begin
    select
      cast(SALDOFINAL as integer)
    from
      STP_MOVESTOQUE_RESUMO_LOTE(:LCODPRODFILHO,:DTFIM,:lote)
    into
      LQTDESTOQUE;
      end
      else
      begin
        select
      cast(SALDOFINAL as integer)
    from
      STP_MOVESTOQUE_RESUMO(:LCODPRODFILHO,:EDATAINI,:DTFIM)
    into
      LQTDESTOQUE;
      end


    if (coalesce(LQTDESTOQUE,0) > 0) then
      QTDESTOQUE = coalesce(cast(LQTDESTOQUE / coalesce(nullif(LQTDEMBALAGEM,1),1) as integer),0);

    QTDESTOQUE = coalesce(QTDESTOQUE,0);
   /* QTDESTOQUE = cast((cast(QTDESTOQUE as double precision) * 1000) as integer); */

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_PRODUTOS
RETURNS (
    CNPJ_FABRICANTE VARCHAR(100),
    DESC_FABRICANTE VARCHAR(100),
    COD_PRODUTO INTEGER,
    DESC_PRODUTO VARCHAR(100),
    COD_GRUPO INTEGER,
    DESC_GRUPO VARCHAR(100),
    COD_FAMILIA VARCHAR(18),
    DESC_FAMILIA VARCHAR(60),
    COD_SUBFAMILIA VARCHAR(18),
    DESC_SUBFAMILIA VARCHAR(60),
    TIPO_CODBARRAS VARCHAR(1),
    CODBARRAS VARCHAR(30),
    TIPO_EMBALAGEM VARCHAR(20),
    UNIDADE_PRODUTO VARCHAR(8),
    VOLUME_EMBALAGEM VARCHAR(15),
    STATUS_PRODUTO VARCHAR(1),
    DT_CADASTRO VARCHAR(8),
    CNPJDISTRIBUIDOR VARCHAR(100))
AS
BEGIN
  FOR select
    PESSOA.CPFCGC,
    PESSOA.NOME,
    PRODFILHO.CODPRODFILHO,
    PRODFILHO.DESCRICAO,
    PRODUTO.CODGRUPO,
    GRUPO.DESCRICAO,
    '' COD_FAMILIA,
    '' DESC_FAMILIA,
    '' COD_SUBFAMILIA,
    '' DESC_SUBFAMILIA,
    'E' TIPO_CODBARRAS,
    PRODFILHO.CODPESQ2,
    substring(PRODFILHO.UNIDADE from 1 for 8),
/*    UNIDADE.DESCRICAO, */
    'UN' SIGLA,
    PRODFILHO.QTDEMBALAGEM,
    case
      when PRODUTO.ATIVO = '2' then 'A' else 'I'
    end as STATUS_PRODUTO,
    (extract(year from PRODFILHO.DT_CADAST) || RIGHT('00' || extract(month from PRODFILHO.DT_CADAST), 2) || RIGHT('00' || extract(day from PRODFILHO.DT_CADAST), 2)) as DATA
  from
    PRODUTO
     join PRODFILHO on PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
     join PESSOA on ((PESSOA.CODPESSOA = PRODUTO.CODFABRICANTE) and (PESSOA.TIPOPESSOA = 'Fornecedor'))
     join GRUPO on GRUPO.CODGRUPO = PRODUTO.CODGRUPO
     join UNIDADE on UNIDADE.CODUNIDADE = PRODFILHO.CODUNIDADE
  INTO
    :CNPJ_FABRICANTE,
    :DESC_FABRICANTE,
    :COD_PRODUTO,
    :DESC_PRODUTO,
    :COD_GRUPO,
    :DESC_GRUPO,
    :COD_FAMILIA,
    :DESC_FAMILIA,
    :COD_SUBFAMILIA,
    :DESC_SUBFAMILIA,
    :TIPO_CODBARRAS,
    :CODBARRAS,
    :TIPO_EMBALAGEM,
    :UNIDADE_PRODUTO,
    :VOLUME_EMBALAGEM,
    :STATUS_PRODUTO,
    :DT_CADASTRO
  DO
  BEGIN
    VOLUME_EMBALAGEM = cast((cast(VOLUME_EMBALAGEM as double precision) * 1000) as integer);
    select
      STRRESULT
    from
       FU_GETTIRAMASCARA(:CNPJ_FABRICANTE)
    into
      CNPJ_FABRICANTE;

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;

    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_VENDAS(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    DUN VARCHAR(30),
    CNPJCLIENTE VARCHAR(18),
    CLIENTE VARCHAR(60),
    CODSEGMENTO INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA VARCHAR(8),
    TIPOPED VARCHAR(10),
    TIPOPESSOA VARCHAR(1),
    PDV_EMPRESA VARCHAR(60),
    PDV_CEP VARCHAR(9),
    NOME_VENDEDOR VARCHAR(60),
    CODNFVENDA VARCHAR(14),
    VLRVENDIDO VARCHAR(30),
    QTDVENDIDA VARCHAR(30),
    LOTE VARCHAR(200),
    DATAVAL VARCHAR(8),
    QTD INTEGER,
    CFOP VARCHAR(4))
AS
declare variable DTINI date;
begin
  DTINI = '01.'||extract(month from current_date)||'.'||extract(year from current_date);
  EDATAINI = cast(coalesce(EDATAINI,DTINI) as date);
  EDATAFIM = cast(coalesce(EDATAFIM,current_date) as date);
  for select
   case coalesce(PRODFILHO.CODPESQ2 ,'')
      when '' then
        PRODFILHO.CODPRODFILHO
      else
        PRODFILHO.CODPESQ2
    end DUN,
    PESSOA.CPFCGC CNPJCLIENTE,
    PESSOA.NOME CLIENTE,
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    case coalesce(TBL_RAMOATVTIPO.referencia,'')
      when '' THEN 0
      else TBL_RAMOATVTIPO.referencia
      end CODSEGMENTOPEPSICO,
    PEDVEND.CODVENDEDOR,
    (extract(year from PEDVEND.DTFATURADO) || RIGHT('00'||extract(month from PEDVEND.DTFATURADO),2) || RIGHT('00'||extract(day from PEDVEND.DTFATURADO),2)) as DATAVENDA,
    case
      when ((PEDVEND.TIPOPED = 'VENDA') or (PEDVEND.TIPOPED = 'CADERNO'))  then 'V'
      when PEDVEND.TIPOPED = 'BONIFICA' then 'B'
      when ((PEDVEND.TIPOPED = 'DEVOLU????????O') or (PEDVEND.TIPOPED = 'DEVOLUCAO'))  then 'DV'
      when PEDVEND.TIPOPED = 'CANCELAMENTO' then 'C'
      when ((PEDVEND.TIPOPED = 'TRANSFERENCIA') or (PEDVEND.TIPOPED = 'REMESSA F.'))  then 'T'
    end as TIPOPED,
    nfvenda.CODNFVENDA,
    PESSOA.PESSOA,
    cast(cast(sum(((coalesce(PEDVENDITEM.PRECOPROD,0) * coalesce(PEDVENDITEM.QTDENTREGUE,1))
    + (((coalesce(PEDVEND.ACRESVALOR,0) + (coalesce(PEDVEND.VALOR_BRUTO,0) * (coalesce(PEDVEND.ACRESCIMO,0)/100))) * (coalesce(PEDVENDITEM.PRECOVEND,0) / coalesce(nullif(PEDVEND.VALOR_BRUTO,1),1))))
    ) - (((coalesce(PEDVEND.DESC_VALOR,0) + coalesce(PEDVEND.DESCPERC_VALOR,0)) * (coalesce(PEDVENDITEM.PRECOVEND,0) / coalesce(nullif(PEDVEND.VALOR_BRUTO,1),1))) + coalesce(PEDVENDITEM.DESCONTO_VALOR,0))) as numeric(18,2)) as varchar(30)) as VLRVENDIDO,
    cast(cast(sum(coalesce(PEDVENDITEM.QTDE,0) / coalesce(nullif(PRODFILHO.QTDEMBALAGEM,1),1)) as numeric(18,5)) as varchar(30)) as QTDVENDIDA,
    nfvendaitem.cfop_cfop,
    nfvendaitemlote.lote,
     (extract( year from nfvendaitemlote.DATAVAL) || RIGHT('00' || extract(month from nfvendaitemlote.DATAVAL), 2) || RIGHT('00' || extract(day from nfvendaitemlote.DATAVAL), 2)) as DATAVAL,
    CAST(nfvendaitemlote.qtd AS integer)qtd

  from
    PEDVEND
    join PESSOA on (PESSOA.CODPESSOA = PEDVEND.CODPESSOA)
    join TBL_RAMOATVTIPO on (PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO)
    join PEDVENDITEM on PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
    join PRODFILHO on PEDVENDITEM.CODPRODFILHO =  PRODFILHO.CODPRODFILHO
    join PRODUTO on PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
    join nfvenda on pedvend.codnfvenda = nfvenda.codnfvenda
    join nfvendaitem on nfvenda.codnfvenda = nfvendaitem.codnfvenda
    join nfvendaitemlote on nfvendaitem.codnfvendaitem = nfvendaitemlote.codnfvendaitem
  where
    PEDVEND.STATUSPED = 'FATURADO' and
    PEDVEND.TIPOPED in ('VENDA','CADERNO') and
    cast(PEDVEND.DTFATURADO as date) between :EDATAINI and :EDATAFIM
  group by 
     1,2,3,4,5,6,7,8,9,10,11,14,15,16,17
  into
    :DUN,
    :CNPJCLIENTE,
    :CLIENTE,
    :PDV_EMPRESA,
    :PDV_CEP,
    :CODSEGMENTO,
    :CODVENDEDOR,
    :DATAVENDA,
    :TIPOPED,
    :CODNFVENDA,
    :TIPOPESSOA,
    :VLRVENDIDO,
    :QTDVENDIDA,
    :cfop, 
    :LOTE,
    :DATAVAL,
    :QTD
  do
  begin
    QTDVENDIDA = cast((cast(QTDVENDIDA as double precision) * 1000) as integer);
    select
      VENDEDOR.NOME
    from
      VENDEDOR
    where
      VENDEDOR.CODVENDEDOR = :CODVENDEDOR
    into
      :NOME_VENDEDOR;

    select
     STRRESULT
   from
     FU_GETTIRAMASCARA(:CNPJCLIENTE)
   into
     CNPJCLIENTE;

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC)),
      SYSPARAMS.EMPRESA,
      SYSPARAMS.CEP
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR,
      :PDV_EMPRESA,
      :PDV_CEP;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MGERANFVENDACOPIAFINANCEIRO(
    ECODNFVENDA INTEGER,
    ESERIENF VARCHAR(3),
    EDATAFINANCEIRO DATE,
    EPREV_TIPOPAG VARCHAR(20),
    EQTDPARCELA INTEGER,
    EDIASPRIMEIRA INTEGER,
    EDIASOUTROS INTEGER,
    ECODBANCO INTEGER)
AS
declare variable LVLTOTAL double precision;
declare variable LVLPARCELAPRIMEIRA numeric(15,2);
declare variable LVLPARCELAOUTRAS numeric(15,2);
declare variable LCODPESSOA integer;
declare variable LDT_VENCIM date;
declare variable LQTDPARCELA integer;
declare variable LVLPARCELA double precision;
declare variable LPARCELA varchar(5);
declare variable LUS_CADAST varchar(45);
declare variable LDIAS integer;
declare variable LCODCENTCUSTO integer;
declare variable LVALOR smallint;
declare variable LCODCONTA integer;
declare variable LCODPEDVEND integer;
declare variable SVALOR integer;
begin
  if ((nullif(EPREV_TIPOPAG, '') is not null) and (EQTDPARCELA > 0)) then
  begin
    select
      N.TOTALNOTA,
      N.CODPESSOA,
      N.US_CADAST,
      N.CODPEDVEND
    from
      NFVENDA N
    where
      N.CODNFVENDA = :ECODNFVENDA and
      N.SERIE      = :ESERIENF
    into
      LVLTOTAL,
      LCODPESSOA,
      LUS_CADAST,
      LCODPEDVEND;
      
    select
      VALOR
    from
      MLERPARAMETROINTEIRO('CENTRO DE CUSTO PADR??O PARA NFVENDA', 0)
    into
      LCODCENTCUSTO;
      
    LVLPARCELAOUTRAS   = LVLTOTAL / EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLTOTAL - LVLPARCELAOUTRAS * EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLPARCELAPRIMEIRA + LVLPARCELAOUTRAS;
  
    while (coalesce(LQTDPARCELA, 1) <= EQTDPARCELA) do
    begin
      if (coalesce(LQTDPARCELA, 1) = 1) then
      begin
        LVLPARCELA = LVLPARCELAPRIMEIRA;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA;
      end
      else
      begin
        LVLPARCELA = LVLPARCELAOUTRAS;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA + (EDIASOUTROS * (LQTDPARCELA - 1));
      end
      LPARCELA = RIGHT('0' || coalesce(LQTDPARCELA, 1), 2) || '/' || RIGHT('0' || EQTDPARCELA, 2);
      
      LDIAS = LDT_VENCIM - cast('TODAY' as date);
  
      LCODCONTA = gen_id(GEN_CONTA, 1);

      insert into
        CONTA (
          CODCONTA,
          STATUS, 
          TIPO,
          DESCRICAO, 
          NRDOCUMENTO, 
          CODPESSOA, 
          DT_EMISSAO, 
          DT_VENCIM, 
          PARCELA, 
          PREV_TIPOPAG, 
          VLPARCELA,
          VLTOTAL, 
          US_CADAST, 
          DT_CADAST, 
          CODNFVENDA, 
          SERIENF, 
          DIAS,
          CODBANCO)
      values (
        :LCODCONTA,
        'ABERTO',
        'RECEBER',
        'COPIA DE NFVENDA',
        :ECODNFVENDA,
        :LCODPESSOA,
        'TODAY',
        :LDT_VENCIM,
        :LPARCELA,
        :EPREV_TIPOPAG,
        :LVLPARCELA,
        :LVLTOTAL,
        :LUS_CADAST,
        'NOW',
        :ECODNFVENDA,
        :ESERIENF,
        :LDIAS,
        :ECODBANCO);
  
      if (nullif(LCODCENTCUSTO, 0) is not null) then
      begin
        insert into
          CONTA_CENTCUSTO (
            CODCENTCUSTO,
            CODCONTA,
            VALOR)
        values (
          :LCODCENTCUSTO,
          :LCODCONTA,
          :LVLPARCELA);
      end
      LQTDPARCELA = coalesce(LQTDPARCELA, 1) + 1;
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE SPMAPAVENDAS2(
    EDTINI DATE,
    EDTFIM DATE)
RETURNS (
    CODVENDEDOR INTEGER,
    VENDEDOR VARCHAR(60),
    CODSTATUS INTEGER,
    STATUS VARCHAR(60),
    CODPESSOA INTEGER,
    PESSOA VARCHAR(60),
    CODPEDVEND INTEGER,
    DTFATURADO DATE,
    CODGRUPO INTEGER,
    GRUPO VARCHAR(60),
    CODSUBGRUPO INTEGER,
    SUBGRUPO VARCHAR(60),
    CODPRODFILHO INTEGER,
    PRODFILHO VARCHAR(60),
    UNIDADE VARCHAR(15),
    QTDENTREGUE DOUBLE PRECISION,
    CAIXA DOUBLE PRECISION,
    PRECOPROD DOUBLE PRECISION,
    DESCONTO_VALOR DOUBLE PRECISION,
    PESOBRUTO DOUBLE PRECISION,
    PESOLIQUIDO DOUBLE PRECISION,
    PERDA DOUBLE PRECISION,
    USUARIO VARCHAR(45),
    ACRESCIMOVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    CODEMPRESA INTEGER,
    CIDADE VARCHAR(45),
    ARE_CODIGO INTEGER,
    AREA VARCHAR(30),
    CURVA VARCHAR(1),
    VALORIPI DOUBLE PRECISION,
    CODFABRICANTE INTEGER,
    CODSUPERVISOR INTEGER,
    CUBAGEM DOUBLE PRECISION,
    CMV DOUBLE PRECISION,
    CODTIPOATV INTEGER,
    TIPOATIVIDADE VARCHAR(60),
    TOTAL DOUBLE PRECISION,
    BAIRRO VARCHAR(45),
    MES VARCHAR(20),
    ANO INTEGER,
    CODCOR INTEGER,
    COR VARCHAR(60),
    FABRICANTE VARCHAR(60),
    QTDEMBALAGEM DOUBLE PRECISION,
    SEMANA VARCHAR(60),
    NUMSEMANA INTEGER,
    SUPERVISOR VARCHAR(60),
    SIGLA CHAR(2),
    CODSTATUS_CHECKOUT INTEGER,
    STATUS_CHECKOUT VARCHAR(60),
    EMPRESA VARCHAR(60),
    CARACTER VARCHAR(60))
AS
declare variable LTOTDESCPEDVEND double precision;
declare variable LTOTACRESPEDVEND double precision;
declare variable LVALOR_BRUTO double precision;
declare variable LCODPEDVEND integer;
declare variable LFRETE double precision;
declare variable LCODPRODUTO integer;
declare variable LCODUNIDADE integer;
declare variable LDTFATURADO date;
declare variable LDTSAIDA date;
declare variable LPERCACRESCIMO double precision;
declare variable LVALORACRESCIMO double precision;
declare variable LVALORDESCONTO double precision;
declare variable LPERCVALORDESCONTO double precision;
declare variable LEXIBIRAPENASONUMERODOPEDIDO smallint;
declare variable LCODFATURAMENTO integer;
declare variable LCODNFVENDA integer;
declare variable LSOMAFRETE varchar(1);
declare variable LNAOSOMARFRETENORELATORIO smallint;
declare variable LSOMARIPIAOTOTAL smallint;
declare variable LDTINI timestamp;
declare variable LDTFIM timestamp;
declare variable LDIASEMANA integer;
declare variable LSEMANA integer;
begin
  LDTINI = cast(EDTINI||' 00:00:00' as timestamp);
  LDTFIM = cast(EDTFIM||' 23:59:59' as timestamp);

  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0)
  into
    LEXIBIRAPENASONUMERODOPEDIDO;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('SOMAR IPI AO TOTAL',0)
  into
    LSOMARIPIAOTOTAL;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('N????O SOMAR FRETE NO RELATORIO',0)
  into
    LNAOSOMARFRETENORELATORIO;

  select 
    SOMAFRETE
  from
    SYSPARAMS
  into
    LSOMAFRETE;

  for select
    P.CODVENDEDOR,
    P.CODPESSOA,
    P.CODPEDVEND,
    P.CODFATURAMENTO,
    P.CODNFVENDA,
    cast(P.DTFATURADO as date),
    cast(P.DT_SAIDA as date),
    P.US_CADAST USUARIO,
    P.CODEMPRESA,
    P.DESC_VALOR,
    P.DESCPERC_VALOR,
    P.ACRESVALOR,
    P.ACRESCIMO,
    P.VALOR_BRUTO,
    P.FRETE
  from
    PEDVEND P
  where
    P.STATUSPED = 'FATURADO' and
    P.TIPOPED in ('VENDA', 'CADERNO') and
    P.DT_SAIDA between :LDTINI and :LDTFIM
  into
    :CODVENDEDOR,
    :CODPESSOA,
    :LCODPEDVEND,
    :LCODFATURAMENTO,
    :LCODNFVENDA,
    :LDTFATURADO,
    :LDTSAIDA,
    :USUARIO,
    :CODEMPRESA,
    :LVALORDESCONTO,
    :LPERCVALORDESCONTO,
    :LVALORACRESCIMO,
    :LPERCACRESCIMO,
    :LVALOR_BRUTO,
    :LFRETE
  do
  begin

    if (LEXIBIRAPENASONUMERODOPEDIDO = 0) then
      CODPEDVEND = coalesce(LCODFATURAMENTO, LCODNFVENDA, LCODPEDVEND);
    else
      CODPEDVEND = LCODPEDVEND;

    LFRETE = coalesce(LFRETE,0);
    DTFATURADO = coalesce(LDTFATURADO,LDTSAIDA);
    LVALOR_BRUTO = coalesce(nullif(LVALOR_BRUTO,0),1);
    LTOTACRESPEDVEND = coalesce(LVALORACRESCIMO,0) + (coalesce(LVALOR_BRUTO,0) * (coalesce(LPERCACRESCIMO,0)/100));
    LTOTDESCPEDVEND = coalesce(LVALORDESCONTO,0) + coalesce(LPERCVALORDESCONTO,0);

    select FU_RETORNOMEMES_INT.NOME from FU_RETORNOMEMES_INT(extract(month from :DTFATURADO)) into :MES;

    MES = upper(MES);

    ANO = extract(year from DTFATURADO);

    MES = '''' || MES || '''';

    select
       V.NOME VENDEDOR
    from
      VENDEDOR V
    where
      V.CODVENDEDOR = :CODVENDEDOR
    into 
      VENDEDOR;

    select
       u.SIGLA VENDEDOR
    from
      PESSOA p
      inner join TBL_ESTADO u
      on p.UF_1 = u.SIGLA
    where
      p.CODPESSOA = :CODPESSOA
    into 
      SIGLA;

    select 
      PE.CODSTATUS,
      PE.NOME,
      coalesce(PE.ARE_CODIGO,0),
      PE.CIDADE_1,
      coalesce(PE.CODTIPOATV,0),
      PE.BAIRRO_1
    from
      PESSOA PE
    where
      PE.CODPESSOA = :CODPESSOA
    into
      CODSTATUS,
      PESSOA,
      ARE_CODIGO,
      CIDADE,
      CODTIPOATV,
      BAIRRO;

    TIPOATIVIDADE = null;
    select 
      coalesce(DESCRICAO,'N????O DEFINIDO')
    from
      TBL_RAMOATVTIPO
    where
      CODTIPO = :CODTIPOATV
    into
      TIPOATIVIDADE;

    TIPOATIVIDADE = coalesce(TIPOATIVIDADE,'N????O DEFINIDO');

    select 
      DESCRICAO
    from
      STATUS ST
    where
       ST.CODSTATUS = :CODSTATUS
    into
      STATUS;

    select 
      CODSTATUS,
      DESCRICAO
    from
      STATUS ST
    where
       ST.CODSTATUS = :CODSTATUS
    into
      CODSTATUS_CHECKOUT,
      STATUS_CHECKOUT;

    AREA = null;
    select 
      coalesce(ARE_DESCRICAO,'N????O DEFINIDO')
    from
      TBL_AREA TA
    where
      TA.ARE_CODIGO = :ARE_CODIGO
    into
      AREA;

    AREA = coalesce(AREA,'N????O DEFINIDO');

    select
      E.EMPRESA
    from
      EMPRESA E
    where
      E.CODEMPRESA = :CODEMPRESA
    into
      EMPRESA;

    for select
      pi.CODPRODFILHO,
      PF.DESCRICAO PRODFILHO,
      pi.QTDENTREGUE,
      pi.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1) CAIXA,
      pi.PRECOPROD,
      ((:LTOTDESCPEDVEND * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO)) + coalesce(pi.DESCONTO_VALOR,0)) as DESCONTO_VALOR,
      PF.PESOBRUTO * pi.QTDENTREGUE PESOBRUTO,
      PF.PESOLIQUIDO * pi.QTDENTREGUE PESOLIQUIDO,
      pi.PERDA,
      ((:LTOTACRESPEDVEND * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO))) as ACRESCIMOVALOR,
      (:LFRETE * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO)) as FRETE,
      PF.CURVA,
      (coalesce(pi.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)) VALORIPI,
      (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(pi.QTDENTREGUE,0)) CUBAGEM,
      (coalesce(PF.CUSTOMEDIO,0) * coalesce(pi.QTDENTREGUE,0)) CMV,
      PF.CODPRODUTO,
      PF.CODUNIDADE,
      coalesce(PF.CODCOR,0),
      coalesce(PF.QTDEMBALAGEM,1)
    from
      PEDVENDITEM pi
      join PRODFILHO PF on pi.CODPRODFILHO = PF.CODPRODFILHO
    where
       pi.CODPEDVEND = :LCODPEDVEND
    into
      :CODPRODFILHO,
      :PRODFILHO,
      :QTDENTREGUE,
      :CAIXA,
      :PRECOPROD,
      :DESCONTO_VALOR,
      :PESOBRUTO,
      :PESOLIQUIDO,
      :PERDA,
      :ACRESCIMOVALOR,
      :FRETE,
      :CURVA,
      :VALORIPI,
      :CUBAGEM,
      :CMV,
      :LCODPRODUTO,
      :LCODUNIDADE,
      :CODCOR,
      :QTDEMBALAGEM
    do
    begin
      select 
        CODGRUPO, 
        CODSUBGRUPO,
        CODFABRICANTE
      from
        PRODUTO PR
      where
        PR.CODPRODUTO = :LCODPRODUTO
      into
        :CODGRUPO,
        :CODSUBGRUPO,
        :CODFABRICANTE;

      select 
        CODSUPERVISOR
      from
        PESSOA
      where
        CODPESSOA = :CODPESSOA
      into
        :CODSUPERVISOR;

      COR = null;

      select
        DESCRICAO
      from
        TBL_COR
      where
        CODCOR = :CODCOR
      into
        :COR;

      COR = coalesce(COR,'SEM COR');

      select 
        DESCRICAO
      from
        GRUPO
      where
        CODGRUPO = :CODGRUPO
      into
        GRUPO;


      select 
        DESCRICAO
      from
        SUBGRUPO
      where
        CODSUBGRUPO = :CODSUBGRUPO
      into
        SUBGRUPO;

      select 
        coalesce(:UNIDADE, U.SIGLA)
      from
        UNIDADE U
      where
        CODUNIDADE = :LCODUNIDADE
      into
        UNIDADE;
         CARACTER = null;
        SELECT
          CARACTER.DESCRICAO DESC_CARACTER
        from
         PRODCARACTER JOIN CARACTER ON
        PRODCARACTER.CODCARACTER = CARACTER.CODCARACTER
        where
          CODPRODUTO = :LCODPRODUTO
         into
         :CARACTER;

      if ((LSOMARIPIAOTOTAL <> 0) and (LNAOSOMARFRETENORELATORIO = 0) and (LSOMAFRETE = 'S')) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + FRETE + VALORIPI) - DESCONTO_VALOR));
      else if ((LNAOSOMARFRETENORELATORIO = 0) and (LSOMAFRETE = 'S')) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + FRETE)- DESCONTO_VALOR));
      else if (LSOMARIPIAOTOTAL <> 0) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + VALORIPI) - DESCONTO_VALOR));
      else
        TOTAL = (((PRECOPROD * QTDENTREGUE) + ACRESCIMOVALOR) - DESCONTO_VALOR);

    FABRICANTE = '';

    select
      PE.NOME
    from
      PESSOA PE
    where
      PE.CODPESSOA = :CODFABRICANTE
    into
      FABRICANTE;

    SUPERVISOR = '';

    select
      SU.NOME
    from
      SUPERVISOR SU
    where
      SU.CODSUPERVISOR = :CODSUPERVISOR
    into
      SUPERVISOR;

    /* { ALTERA????????????????????ES - BRUNO - 11/07/2012 } -- */
    /* CARREGA A SEMANA -- */
    select
    (extract(yearday from cast(:DTFATURADO as date)) - extract(weekday from cast(:DTFATURADO as date) -1)+7)/7 SEMANA
    from rdb$database into LSEMANA;
    /* CARREGA O PER????????ODO DA SEMANA -- */
    select extract(weekday from :DTFATURADO) from rdb$database into LDIASEMANA;
    if (LDIASEMANA = 0) then
        LDIASEMANA = 7;

    SEMANA = 'De ' ||
             RIGHT('00' || cast((extract(day from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
             '/' ||
             RIGHT('00' || cast((extract(month from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
             '/' ||
             extract(year from (:DTFATURADO - (LDIASEMANA - 1))) ||
             ' ???????? ' ||
             RIGHT('00' || cast((extract(day from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
             '/' ||
             RIGHT('00' || cast((extract(month from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
             '/' ||
             extract(year from (:DTFATURADO + (7 - LDIASEMANA)));

    NUMSEMANA = LSEMANA;
    /* { FIM ALTERA????????????????????ES - BRUNO - 11/07/2012 } -- */
    suspend;

    codcor = null;

    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE STP_GERAFIANCEIRO_CHEQUE(
    ECODCHEQUE INTEGER)
AS
declare variable LVLTOTAL double precision;
declare variable LVLPARCELAPRIMEIRA numeric(15,2);
declare variable LVLPARCELAOUTRAS numeric(15,2);
declare variable LCODPESSOA integer;
declare variable LDT_VENCIM date;
declare variable LQTDPARCELA integer;
declare variable LVLPARCELA double precision;
declare variable LPARCELA varchar(5);
declare variable LUS_CADAST varchar(45);
declare variable LDIAS integer;
declare variable LCODCENTCUSTO integer;
declare variable LVALOR smallint;
declare variable LCODCONTA integer;
declare variable LCODCONDPAGCPR integer;
declare variable SVALOR integer;
declare variable LPREV_TIPOPAG varchar(45);
declare variable EQTDPARCELA integer;
declare variable EDIASPRIMEIRA integer;
declare variable EDIASOUTROS integer;
declare variable EDATAFINANCEIRO date;
declare variable LNRDOCUMENTO varchar(30);
begin

  delete FROM
  CONTA C
  WHERE
  C.CODCHAVULSO =:ECODCHEQUE;

  SELECT CODCCUSTCOMPRA FROM SYSPARAMS INTO LCODCENTCUSTO;


    select
      C.VALOR,
      C.CODPESSOA,
      current_timestamp,
      C.NRCHEQUE
    from
      CHEQUE_AVULSO C
    where
      C.CODCHEQUE =:ECODCHEQUE
    into
      LVLTOTAL,
      LCODPESSOA,
      EDATAFINANCEIRO,
      LNRDOCUMENTO;


      SELECT first 1
      C.NRPRESTACAO,
      C.NRDIASPRIMEIRA,
      C.NRDIAS,
      C.DESCRICAO
      FROM
      CONDPAGCPR C
      WHERE
     C.CODCONDPAGCPR = 13
      INTO
      EQTDPARCELA,
      EDIASPRIMEIRA,
      EDIASOUTROS,
      LPREV_TIPOPAG;

      
    LVLPARCELAOUTRAS   = LVLTOTAL / EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLTOTAL - LVLPARCELAOUTRAS * EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLPARCELAPRIMEIRA + LVLPARCELAOUTRAS;
  
    while (coalesce(LQTDPARCELA, 1) <= EQTDPARCELA) do
    begin
      if (coalesce(LQTDPARCELA, 1) = 1) then
      begin
        LVLPARCELA = LVLPARCELAPRIMEIRA;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA;
      end
      else
      begin
        LVLPARCELA = LVLPARCELAOUTRAS;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA + (EDIASOUTROS * (LQTDPARCELA - 1));
      end
      LPARCELA = RIGHT('0' || coalesce(LQTDPARCELA, 1), 2) || '/' || RIGHT('0' || EQTDPARCELA, 2);
      
      LDIAS = LDT_VENCIM - cast('TODAY' as date);
  
      LCODCONTA = gen_id(GEN_CONTA, 1);

      insert into
        CONTA (
          CODCONTA,
          STATUS, 
          TIPO,
          DESCRICAO, 
          NRDOCUMENTO, 
          CODPESSOA, 
          DT_EMISSAO, 
          DT_VENCIM, 
          PARCELA, 
          PREV_TIPOPAG, 
          VLPARCELA,
          VLTOTAL, 
          DT_CADAST, 
          CODCHAVULSO,
          DIAS,
          CODCENTCUSTO)
      values (
        :LCODCONTA,
        'ABERTO',
        'PAGAR',
        'CHEQUE AVULSO',
        :LNRDOCUMENTO,
        :LCODPESSOA,
        'TODAY',
        :LDT_VENCIM,
        :LPARCELA,
        :LPREV_TIPOPAG,
        :LVLPARCELA,
        :LVLTOTAL,
        'NOW',
        :ECODCHEQUE,
        :LDIAS,
        :LCODCENTCUSTO);
  
      if (nullif(LCODCENTCUSTO, 0) is not null) then
      begin
        insert into
          CONTA_CENTCUSTO (
            CODCENTCUSTO,
            CODCONTA,
            VALOR)
        values (
          :LCODCENTCUSTO,
          :LCODCONTA,
          :LVLPARCELA);
      end
      LQTDPARCELA = coalesce(LQTDPARCELA, 1) + 1;
    end

end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE WS003_LISTAGEMPRODUTO(
    ECODVENDEDOR INTEGER)
RETURNS (
    CODPRODFILHO INTEGER,
    DESCRICAO VARCHAR(60),
    REFERENCIA VARCHAR(30),
    GTIN VARCHAR(30),
    APRESENTACAO VARCHAR(15),
    CONTROLALOTE VARCHAR(1),
    CONTROLAVALIDADE CHAR(1),
    CODUNIDADE INTEGER,
    UNIDADE VARCHAR(5),
    TRAVA_FRACIONADO VARCHAR(1),
    PRECOVENDA NUMERIC(15,2),
    PRECOVENDA1 NUMERIC(15,2),
    PRECOVENDA2 NUMERIC(15,2),
    PRECOVENDA3 NUMERIC(15,2),
    PRECOVENDA4 NUMERIC(15,2),
    PRECOVENDA5 NUMERIC(15,2),
    PRECOVENDA6 NUMERIC(15,2),
    ESTQATUAL NUMERIC(15,3),
    CODFABRICANTE INTEGER,
    FABRICANTE VARCHAR(60),
    CODGRUPO INTEGER,
    DESCGRUPO VARCHAR(60),
    CODSUBGRUPO INTEGER,
    DESCSUBGRUPO VARCHAR(60),
    DESCONTFLAG SMALLINT,
    DESCONTDESEJ NUMERIC(15,4),
    FLAG_SOLICITARVALORDOLAR SMALLINT,
    VALIDADES VARCHAR(500),
    APLICACAO VARCHAR(500),
    DESC_AUXILIAR_1 VARCHAR(60),
    DESC_AUXILIAR_2 VARCHAR(60),
    FLAG_PROMOCAO VARCHAR(1),
    DESCONTOPRAZO1 NUMERIC(15,2),
    DESCONTOPRAZO2 NUMERIC(15,2),
    DESCONTOPRAZO3 NUMERIC(15,2),
    DESCONTOPRAZO4 NUMERIC(15,2),
    DESCONTOPRAZO5 NUMERIC(15,2),
    DESCONTOPRAZO6 NUMERIC(15,2),
    DESCONTOPRAZO7 NUMERIC(15,2),
    DESCONTOPRAZO8 NUMERIC(15,2),
    DESCONTOPRAZO9 NUMERIC(15,2),
    DESCONTOPRAZO10 NUMERIC(15,2),
    CUSTO NUMERIC(15,2),
    ATIVO SMALLINT,
    PRECOMINIMO NUMERIC(15,2),
    QTDMULTIPLA DOUBLE PRECISION,
    QTDEMBALAGEM DOUBLE PRECISION,
    CODCOR INTEGER,
    COR VARCHAR(60),
    METACOR DOUBLE PRECISION,
    TRATESP SMALLINT,
    FATORCONVERSAO DOUBLE PRECISION,
    FLAG_CAIXAFECHADA VARCHAR(1),
    FLAG_PESOVARIAVEL VARCHAR(1),
    PESO_PECA DOUBLE PRECISION)
AS
declare variable B_EXISTE smallint;
declare variable B_EXIBIR smallint;
declare variable LEXIBIR_APENAS_WEB smallint;
declare variable LVISUALIZARNAWEB varchar(1);
declare variable PAR_REQ_VLDLR_FAB varchar(100);
declare variable LVALIDADE varchar(10);
declare variable LULTIMASINC timestamp;
declare variable PARTABELA_DE_PRECO_MINIMO integer;
declare variable LCALCOESTQPRODCOMBINADO integer;
declare variable LPRODCOMBINADO integer;
declare variable LESTQATUAL double precision;
declare variable LRESERVAMINIMA double precision;
declare variable LSQL blob sub_type 1 segment size 80;
begin
  if (exists(select 1 from CONSULTA_CUSTOMIZADA where CONSULTA_CUSTOMIZADA.CONSULTA = 'WS003_LISTAGEMPRODUTO')) then
  begin
    select SQL from CONSULTA_CUSTOMIZADA where CONSULTA_CUSTOMIZADA.CONSULTA = 'WS003_LISTAGEMPRODUTO' into LSQL;
    for execute statement (LSQL)
    (
      ECODVENDEDOR     := :ECODVENDEDOR
    )
    into
      CODPRODFILHO, 
      DESCRICAO, 
      REFERENCIA, 
      GTIN, 
      APRESENTACAO, 
      CONTROLALOTE, 
      CONTROLAVALIDADE, 
      CODUNIDADE, 
      UNIDADE, 
      TRAVA_FRACIONADO, 
      PRECOVENDA, 
      PRECOVENDA1, 
      PRECOVENDA2, 
      PRECOVENDA3, 
      PRECOVENDA4, 
      PRECOVENDA5, 
      PRECOVENDA6, 
      ESTQATUAL, 
      CODFABRICANTE, 
      FABRICANTE, 
      CODGRUPO, 
      DESCGRUPO, 
      CODSUBGRUPO, 
      DESCSUBGRUPO, 
      DESCONTFLAG, 
      DESCONTDESEJ, 
      FLAG_SOLICITARVALORDOLAR, 
      VALIDADES, 
      APLICACAO, 
      DESC_AUXILIAR_1, 
      DESC_AUXILIAR_2, 
      FLAG_PROMOCAO, 
      DESCONTOPRAZO1, 
      DESCONTOPRAZO2, 
      DESCONTOPRAZO3, 
      DESCONTOPRAZO4, 
      DESCONTOPRAZO5, 
      DESCONTOPRAZO6, 
      DESCONTOPRAZO7, 
      DESCONTOPRAZO8, 
      DESCONTOPRAZO9, 
      DESCONTOPRAZO10, 
      CUSTO, 
      ATIVO, 
      PRECOMINIMO, 
      QTDMULTIPLA,
      QTDEMBALAGEM, 
      CODCOR, 
      COR, 
      METACOR,
      TRATESP,
      FATORCONVERSAO,
      FLAG_CAIXAFECHADA,
      FLAG_PESOVARIAVEL,
      PESO_PECA
    do
    begin
      suspend;
    end
    exit;
  end

  B_EXISTE = 0;
  if (exists(select 1 from VENDEDOR_COMISSAO_GRUPO
             where VENDEDOR_COMISSAO_GRUPO.CODVENDEDOR = :ECODVENDEDOR)) then
  begin
    B_EXISTE = 1;
  end

  select ULTIMASINC from MOBILE_SINC where CODSMNTIPOSINC = 2 and CODVENDEDOR = :ECODVENDEDOR into LULTIMASINC;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR PRODUTOS MARCADOS COMO VISUALIZAR NA WEB',0)
  into
    LEXIBIR_APENAS_WEB;

  select
    VALOR
  from
    MLERPARAMETROINTEIRO('TABELA DE PRECO MINIMO',6)
  into
    PARTABELA_DE_PRECO_MINIMO;

  select
    VALOR
  from
    MLERPARAMETROTEXTO('REQUISITAR VALOR DOLAR (FABRICANTES)','')
  into
    PAR_REQ_VLDLR_FAB;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('CALCULAR O ESTOQUE DO PRODUTO COMBINADO', 0)
  into
    LCALCOESTQPRODCOMBINADO;

  for select
    PRODFILHO.CODPRODFILHO,
    PRODFILHO.DESCRICAO,
    coalesce(PRODFILHO.CODPESQ1,'') REFERENCIA,
    coalesce(PRODFILHO.CODPESQ2,'') GTIN,
    coalesce(PRODFILHO.UNIDADE, UNIDADE.SIGLA) APRESENTACAO,
    coalesce(PRODFILHO.ESTOQUELOTE,'N') CONTROLALOTE,
    (case when coalesce(PRODFILHO.VALIDADE,0) > 0 then 'S' else 'N' end) CONTROLAVALIDADE,
    PRODFILHO.CODUNIDADE,
    UNIDADE.SIGLA UNIDADE,
    coalesce(UNIDADE.TRAVA_FRACIONADO,'N'),
    cast(coalesce(PRODFILHO.PRECOPRATICADO1,0) as numeric(15,2)) PRECOVENDA1,
    cast(coalesce(PRODFILHO.PRECOPRATICADO2,0) as numeric(15,2)) PRECOVENDA2,
    cast(coalesce(PRODFILHO.PRECOPRATICADO3,0) as numeric(15,2)) PRECOVENDA3,
    cast(coalesce(PRODFILHO.PRECOPRATICADO4,0) as numeric(15,2)) PRECOVENDA4,
    cast(coalesce(PRODFILHO.PRECOPRATICADO5,0) as numeric(15,2)) PRECOVENDA5,
    cast(coalesce(PRODFILHO.PRECOPRATICADO6,0) as numeric(15,2)) PRECOVENDA6,
    cast(coalesce(PRODFILHO.ESTQATUAL,0) as numeric(15,3)),
    coalesce(PRODUTO.CODFABRICANTE,0),
    coalesce((select coalesce(NOME,'') from PESSOA where PESSOA.CODPESSOA = PRODUTO.CODFABRICANTE),'') FABRICANTE,
    PRODUTO.CODGRUPO,
    GRUPO.DESCRICAO DESCGRUPO,
    PRODUTO.CODSUBGRUPO,
    SUBGRUPO.DESCRICAO DESCSUBGRUPO,
    coalesce(PRODFILHO.DESCONTFLAG,1) DESCONTFLAG,
    coalesce(PRODFILHO.DESCONTDESEJ,0) DESCONTDESEJ,
    coalesce(PRODUTO.VISUALIZARNAWEB,'N'),
    substring(coalesce(PRODUTO.OBS,'') from 1 for 500),
    coalesce(PRODFILHO.DESC_AUXILIAR_1,''),
    coalesce(PRODFILHO.DESC_AUXILIAR_2,''),
    coalesce(PRODFILHO.PROMOCAO,'N'),
    PRODUTO.ATIVO,
    coalesce(PRODFILHO.QTDMULTPLA,0),
    coalesce(PRODFILHO.CODCOR,0),
    coalesce(TBL_COR.DESCRICAO,''),
    coalesce(PRODFILHO.PRODCOMBINADO,1),
    coalesce(PRODFILHO.QTDEMBALAGEM,1),
    coalesce(PRODUTO.TRATESP,1),
    coalesce(nullif(PRODFILHO.FATORCONVERSAO,0),1),
    coalesce(PRODFILHO.QTD_MULTIPLA,'N'),
    coalesce(PRODFILHO.FLAG_PESOVARIAVEL,'N'),
    coalesce(PRODFILHO.PESO_PECA,0)
  from
    PRODUTO
    join PRODFILHO on
      PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
    join UNIDADE on
      PRODFILHO.CODUNIDADE = UNIDADE.CODUNIDADE
    join GRUPO on
      PRODUTO.CODGRUPO = GRUPO.CODGRUPO
    join SUBGRUPO on
      PRODUTO.CODSUBGRUPO = SUBGRUPO.CODSUBGRUPO
    left join TBL_COR on
      PRODFILHO.CODCOR = TBL_COR.CODCOR
  where
     ((:LULTIMASINC is null) or (coalesce(PRODFILHO.DT_MODIFI, PRODFILHO.DT_CADAST) >= :LULTIMASINC))
  order by
    PRODFILHO.DESCRICAO
  into
    CODPRODFILHO,
    DESCRICAO,
    REFERENCIA,
    GTIN,
    APRESENTACAO,
    CONTROLALOTE,
    CONTROLAVALIDADE,
    CODUNIDADE,
    UNIDADE,
    TRAVA_FRACIONADO,
    PRECOVENDA1,
    PRECOVENDA2,
    PRECOVENDA3,
    PRECOVENDA4,
    PRECOVENDA5,
    PRECOVENDA6,
    ESTQATUAL,
    CODFABRICANTE,
    FABRICANTE,
    CODGRUPO,
    DESCGRUPO,
    CODSUBGRUPO,
    DESCSUBGRUPO,
    DESCONTFLAG,
    DESCONTDESEJ,
    LVISUALIZARNAWEB,
    APLICACAO,
    DESC_AUXILIAR_1,
    DESC_AUXILIAR_2,
    FLAG_PROMOCAO,
    ATIVO,
    QTDMULTIPLA,
    CODCOR,
    COR,
    LPRODCOMBINADO,
    QTDEMBALAGEM,
    TRATESP,
    FATORCONVERSAO,
    FLAG_CAIXAFECHADA,
    FLAG_PESOVARIAVEL,
    PESO_PECA
  do
  begin
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 1' into DESCONTOPRAZO1;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 2' into DESCONTOPRAZO2;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 3' into DESCONTOPRAZO3;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 4' into DESCONTOPRAZO4;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 5' into DESCONTOPRAZO5;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 6' into DESCONTOPRAZO6;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 7' into DESCONTOPRAZO7;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 8' into DESCONTOPRAZO8;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 9' into DESCONTOPRAZO9;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 10' into DESCONTOPRAZO10;

    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'FOR????A DE VENDAS - RESERVA MINIMA' into LRESERVAMINIMA;

    select CUSTO from WS003_CALCULACUSTO(:CODPRODFILHO) into CUSTO;
    CUSTO = coalesce(CUSTO,0);

    DESCONTOPRAZO1  = coalesce(DESCONTOPRAZO1, 0);
    DESCONTOPRAZO2  = coalesce(DESCONTOPRAZO2, 0);
    DESCONTOPRAZO3  = coalesce(DESCONTOPRAZO3, 0);
    DESCONTOPRAZO4  = coalesce(DESCONTOPRAZO4, 0);
    DESCONTOPRAZO5  = coalesce(DESCONTOPRAZO5, 0);
    DESCONTOPRAZO6  = coalesce(DESCONTOPRAZO6, 0);
    DESCONTOPRAZO7  = coalesce(DESCONTOPRAZO7, 0);
    DESCONTOPRAZO8  = coalesce(DESCONTOPRAZO8, 0);
    DESCONTOPRAZO9  = coalesce(DESCONTOPRAZO9, 0);
    DESCONTOPRAZO10 = coalesce(DESCONTOPRAZO10, 0);
    LRESERVAMINIMA  = coalesce(LRESERVAMINIMA,0);


    if ((LPRODCOMBINADO = 2) and (LCALCOESTQPRODCOMBINADO <> 0)) then
    begin
      ESTQATUAL = null;
      for select
        cast(coalesce(PF.ESTQATUAL, 0) / coalesce(nullif(PC.QTD, 0), 1) - 0.5 as integer)
      from
        PRODCOMBINADOS PC
        join PRODFILHO PF on
          PC.CODPRO = PF.CODPRODFILHO
      where
        PC.CODNV = :CODPRODFILHO
      into
        LESTQATUAL
      do
      begin
        if (LESTQATUAL < 0) then
          LESTQATUAL = 0;

        if ((ESTQATUAL is null) or (LESTQATUAL < ESTQATUAL)) then
          ESTQATUAL = LESTQATUAL;
      end
    end

    ESTQATUAL = ESTQATUAL - LRESERVAMINIMA;
    if (coalesce(ESTQATUAL,0) <= 0) then
        ESTQATUAL = 0;

    select QTD from VENDEDORMETAS where CODVENDEDOR = :ECODVENDEDOR and CODCOR = :CODCOR into METACOR;
    METACOR = coalesce(METACOR,0);

    select
      case :PARTABELA_DE_PRECO_MINIMO
        when 1 then
          :PRECOVENDA1
        when 2 then
          :PRECOVENDA2
        when 3 then
          :PRECOVENDA3
        when 4 then
          :PRECOVENDA4
        when 5 then
          :PRECOVENDA5
        when 6 then
          :PRECOVENDA6
      end
    from
      RDB$DATABASE
    into
      PRECOMINIMO;

    PRECOMINIMO = coalesce(PRECOMINIMO,0);

    PRECOVENDA = PRECOVENDA1;
    VALIDADES = '';

    if ((CONTROLALOTE = 'S') and (CONTROLAVALIDADE = 'S')) then
    begin
      for select
        first 3
        RIGHT('00'||extract(day from PRODFILHOLOTES.DATAVAL),2)
        ||'/'||RIGHT('00'||extract(month from PRODFILHOLOTES.DATAVAL),2)
        ||'/'||extract(year from PRODFILHOLOTES.DATAVAL)
      from
        PRODFILHOLOTES
      where
        PRODFILHOLOTES.QTDMOV > 0
        and PRODFILHOLOTES.CODPRODFILHO = :CODPRODFILHO
      order by
        PRODFILHOLOTES.DATAVAL asc
      into
        LVALIDADE
      do
      begin
        if (VALIDADES = '') then
          VALIDADES = VALIDADES || LVALIDADE;
        else
          VALIDADES = VALIDADES ||' | '||LVALIDADE;
      end
    end

    VALIDADES = coalesce(VALIDADES,'');
    APLICACAO = coalesce(APLICACAO,'');

    FLAG_SOLICITARVALORDOLAR = 0;
    if ((CODFABRICANTE > 0) and (PAR_REQ_VLDLR_FAB containing CODFABRICANTE)) then
    begin
      FLAG_SOLICITARVALORDOLAR = 1;
    end

    B_EXIBIR = 1;
    if (B_EXISTE = 1) then
    begin
      B_EXIBIR = 0;
      if (exists(select 1 from VENDEDOR_COMISSAO_GRUPO
               where VENDEDOR_COMISSAO_GRUPO.CODVENDEDOR = :ECODVENDEDOR
               and VENDEDOR_COMISSAO_GRUPO.CODGRUPO = :CODGRUPO)) then
      begin
        B_EXIBIR = 1;
      end
    end

    if ((LEXIBIR_APENAS_WEB = 1) and (LVISUALIZARNAWEB = 'N')) then
      ATIVO = 0;

    if (B_EXIBIR = 1) then
      suspend;
  end
end^

SET TERM ; ^


/* View: APARGERAL */
CREATE OR ALTER VIEW APARGERAL(
    NRDOCUMENTO,
    VALOR_PARC,
    DT_VENCIMENTO,
    PARCELA,
    CODCONTA,
    NOME,
    DESCRICAO,
    CODSTATUS,
    TOTPAGO)
AS
select conta.nrdocumento,conta.VLPARCELA,conta.DT_VENCIM,conta.PARCELA,conta.codconta,pessoa.nome, conta.descricao,pessoa.codstatus, conta.TOTPAGO from conta,pessoa
where conta.status = 'ABERTO' and conta.tipo = 'PAGAR'  and conta.codpessoa = pessoa.codpessoa
;



/* View: BAIRROS */
CREATE OR ALTER VIEW BAIRROS(
    BAIRRO,
    CIDADE,
    UF)
AS
select distinct '''' || BAIRRO_1 || '''', CIDADE_1, UF_1 from PESSOA where TIPOPESSOA = 'Cliente'
;



/* View: CENTCUSTOCONTA */
CREATE OR ALTER VIEW CENTCUSTOCONTA(
    CODCENTCUSTO,
    DESCRICAO,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    TIPO,
    CODLIVRE,
    CODCENTCUSTOPRI,
    CODLIVRESEMMASK)
AS
select
   CODCENTCUSTO,
   DESCRICAO,
   US_CADAST,
   DT_CADAST,
   US_MODIFI,
   DT_MODIFI,
   TIPO,
   CODLIVRE,
   CODCENTCUSTOPRI,
   CODLIVRESEMMASK
from CENTCUSTO
;



/* View: CIDADES */
CREATE OR ALTER VIEW CIDADES(
    CIDADE)
AS
select '''' || CIDADE_1 || '''' from PESSOA where TIPOPESSOA = 'Cliente' group by CIDADE_1
;



/* View: CIVN_CLIENTE */
CREATE OR ALTER VIEW CIVN_CLIENTE(
    CODIGO,
    NOME,
    COD_TIPO_CLIENTE,
    COD_TIPO_PRECO,
    COD_FUNCIONARIO,
    FANTASIA,
    CGC_CPF,
    INSC,
    ENDERECO,
    NUMERO,
    COMPLEMENTO,
    BAIRRO,
    CIDADE,
    ESTADO,
    CEP,
    FONE_1,
    FONE_2,
    CELULAR,
    FAX,
    EMAIL,
    ICMS,
    PESSOA,
    CREDITO,
    DEBITO,
    COD_FRM_PAGAMENTO,
    OBS,
    DATACADASTRO)
AS
SELECT
    CODPESSOA       ,
    NOME            ,
    CODSTATUS       ,
    CASE PRECOUSADO
        WHEN 'Preo1' THEN 1
        WHEN 'Preo2' THEN 2
        WHEN 'Preo3' THEN 3
        WHEN 'Preo4' THEN 4
        WHEN 'Preo5' THEN 5
        WHEN 'Preo6' THEN 6
        ELSE 0
    END             ,
    CODVENDEDOR     ,
    CASE
      WHEN NOMEFANTAZIA IS NULL THEN NOME
      WHEN NOMEFANTAZIA = '' THEN NOME
      ELSE NOMEFANTAZIA
    END             ,
    CPFCGC          ,
    IE              ,
    LOGRADOURO_1    ,
    ''              ,
    COMPLEMENTO_1   ,
    BAIRRO_1        ,
    CIDADE_1        ,
    UF_1            ,
    CEP_1           ,
    FONES           ,
    ''              ,
    CELULAR         ,
    FAX             ,
    EMAIL           ,
    ICMS            ,
    (PESSOA - 1)    ,
    LIMITECRED      ,
    (SELECT SUM(VLPARCELA) FROM CONTA WHERE CONTA.CODPESSOA = PESSOA.CODPESSOA AND TIPO = 'RECEBER' AND STATUS <> 'QUITADO') AS DEBITO,
    CODTIPOPAG1     ,
    OBS             ,
    DT_CADAST
FROM PESSOA
WHERE TIPOPESSOA = 'Cliente'
;



/* View: CIVN_CONDICAO_PAGAMENTO */
CREATE OR ALTER VIEW CIVN_CONDICAO_PAGAMENTO(
    CODIGO,
    NOME,
    DESCRICAO,
    COD_FRM_PAGAMENTO)
AS
SELECT
    CODTIPOPAG  ,
    DESCRICAO   ,
    DESCRICAO   ,
    CASE TIP_TIPO
        WHEN 'DINHEIRO'         THEN 1
        WHEN 'CHEQUE'           THEN 2
        WHEN 'BOLETO BANCRIO'  THEN 3
        ELSE 0
    END
FROM TIPOPAG
;



/* View: CIVN_DEBITO */
CREATE OR ALTER VIEW CIVN_DEBITO(
    CODIGO,
    COD_CLIENTE,
    DATAEMISSAO,
    DATAVENCIMENTO,
    DATAPAGAMENTO,
    NUMPEDIDO,
    NUMNOTA,
    VALOR,
    PAGO,
    PARCELA,
    INFO)
AS
SELECT
    CODCONTA        ,
    CODPESSOA       ,
    DT_EMISSAO      ,
    DT_VENCIM       ,
    (SELECT MAX(DT_PAGAMEN)FROM CONTABX CB WHERE CB.CODCONTA = C.CODCONTA) AS DT_PAGAMEN,
    CODPENDVEND     ,
    CODNFVENDA      ,
    VLPARCELA       ,
    CASE STATUS
        WHEN 'ABERTO' THEN 'F'
        ELSE 'T'
    END AS PAGO,
    PARCELA,
    OBS1
FROM CONTA C
WHERE TIPO = 'RECEBER'
  AND STATUS <> 'QUITADO'
;



/* View: CIVN_ESTOQUE */
CREATE OR ALTER VIEW CIVN_ESTOQUE(
    COD_PRODUTO,
    QTATUAL,
    COD_TIPO_ESTOQUE)
AS
SELECT
    FLH.CODPRODFILHO    ,
    FLH.ESTQATUAL       ,
    1
FROM PRODFILHO FLH
INNER JOIN PRODUTO PRD
    ON PRD.CODPRODUTO = FLH.CODPRODUTO
WHERE PRD.ATIVO = 2
;



/* View: CIVN_FORMA_PAGAMENTO */
CREATE OR ALTER VIEW CIVN_FORMA_PAGAMENTO(
    CODIGO,
    NOME)
AS
SELECT 1, CAST('DINHEIRO' AS VARCHAR(50))           FROM RDB$DATABASE
UNION
     SELECT 2, CAST('CHEQUE' AS VARCHAR(50))             FROM RDB$DATABASE
UNION
     SELECT 3, CAST('BOLETO BANCRIO' AS VARCHAR(50))    FROM RDB$DATABASE
;



/* View: CIVN_FORNECEDOR */
CREATE OR ALTER VIEW CIVN_FORNECEDOR(
    CODIGO,
    NOME,
    DESCRICAO)
AS
SELECT
    CODPESSOA       ,
    NOMEFANTAZIA    ,
    NOMEFANTAZIA
FROM PESSOA
WHERE TIPOPESSOA = 'Fornecedor'
;



/* View: CIVN_FUNCIONARIO */
CREATE OR ALTER VIEW CIVN_FUNCIONARIO(
    CODIGO,
    COD_ORIGINAL,
    NOME,
    LOGIN,
    OBSERVACAO,
    SENHA,
    SUPERVISOR,
    TELEFONE)
AS
SELECT
    CODVENDEDOR          ,
    CODVENDEDOR          ,
    NOME NOMEVENDEDOR    ,
    CODVENDEDOR          ,
    CAST('' AS VARCHAR(200)),
    CODVENDEDOR          ,
    CAST(1000 + CODSUPERVISOR AS INTEGER),
    CAST((FONES || ' / ' || CELULAR) AS VARCHAR(60))
FROM VENDEDOR
UNION SELECT
    CAST(1000 + CODSUPERVISOR AS INTEGER),
    CODSUPERVISOR           ,
    NOME                    ,
    CAST(1000 + CODSUPERVISOR AS INTEGER),
    CAST('' AS VARCHAR(200)),
    CAST(1000 + CODSUPERVISOR AS INTEGER),
    0                       ,
    CAST((FONES || ' / ' || CELULAR) AS VARCHAR(60))
FROM SUPERVISOR
;



/* View: CIVN_PRECO */
CREATE OR ALTER VIEW CIVN_PRECO(
    COD_TIPO_PRECO,
    COD_PRODUTO,
    VALOR)
AS
SELECT
        1,
        FLH.CODPRODFILHO,
        FLH.PRECOPRATICADO1
    FROM PRODFILHO FLH
    INNER JOIN PRODUTO PRD
        ON PRD.CODPRODUTO = FLH.CODPRODUTO
    WHERE PRD.ATIVO = 2
        AND FLH.PRECOPRATICADO1 IS NOT NULL
        AND FLH.PRECOPRATICADO1 > 0
UNION
SELECT
        2,
        FLH.CODPRODFILHO,
        FLH.PRECOPRATICADO2
    FROM PRODFILHO FLH
    INNER JOIN PRODUTO PRD
        ON PRD.CODPRODUTO = FLH.CODPRODUTO
    WHERE PRD.ATIVO = 2
        AND FLH.PRECOPRATICADO2 IS NOT NULL
        AND FLH.PRECOPRATICADO2 > 0
UNION
SELECT
        3,
        FLH.CODPRODFILHO,
        FLH.PRECOPRATICADO3
    FROM PRODFILHO FLH
    INNER JOIN PRODUTO PRD
        ON PRD.CODPRODUTO = FLH.CODPRODUTO
    WHERE PRD.ATIVO = 2
        AND FLH.PRECOPRATICADO3 IS NOT NULL
        AND FLH.PRECOPRATICADO3 > 0
UNION
SELECT
        4,
        FLH.CODPRODFILHO,
        FLH.PRECOPRATICADO4
    FROM PRODFILHO FLH
    INNER JOIN PRODUTO PRD
        ON PRD.CODPRODUTO = FLH.CODPRODUTO
    WHERE PRD.ATIVO = 2
        AND FLH.PRECOPRATICADO4 IS NOT NULL
        AND FLH.PRECOPRATICADO4 > 0
UNION
SELECT
        5,
        FLH.CODPRODFILHO,
        FLH.PRECOPRATICADO5
    FROM PRODFILHO FLH
    INNER JOIN PRODUTO PRD
        ON PRD.CODPRODUTO = FLH.CODPRODUTO
    WHERE PRD.ATIVO = 2
        AND FLH.PRECOPRATICADO5 IS NOT NULL
        AND FLH.PRECOPRATICADO5 > 0
UNION
SELECT
        6,
        FLH.CODPRODFILHO,
        FLH.PRECOPRATICADO6
    FROM PRODFILHO FLH
    INNER JOIN PRODUTO PRD
        ON PRD.CODPRODUTO = FLH.CODPRODUTO
    WHERE PRD.ATIVO = 2
        AND FLH.PRECOPRATICADO6 IS NOT NULL
        AND FLH.PRECOPRATICADO6 > 0
;



/* View: CIVN_PRODUTO */
CREATE OR ALTER VIEW CIVN_PRODUTO(
    CODIGO,
    COD_TIPO_PRODUTO,
    COD_FORNECEDOR,
    COD_UNIDADE,
    NOME,
    NOTA,
    COD_EMBALAGEM,
    QTDE_EMBALAGEM,
    FORMATO,
    ORDEM,
    ACEITA_DEVOLUCAO,
    DESCRICAO,
    PESO_EMBALAGEM)
AS
SELECT
    FLH.CODPRODFILHO    ,
    PRD.CODGRUPO        ,
    (SELECT FIRST 1 CODPESSOA
        FROM PRODPESSOA
        WHERE CODPRODUTO = FLH.CODPRODFILHO
    )       AS CODFORNEC,
    FLH.CODUNIDADE      ,
    FLH.DESCRICAO       ,
    ''                  ,
    0                   ,
    -- FLH.QTDEMBALAGEM    ,
    1                   ,
    0                   ,
    0                   ,
    coalesce(FLH.ACEITARPERDA, 'N') AS ACEITARPERDA,
    PRD.OBS             ,
    FLH.PESO_PECA
FROM PRODFILHO FLH
INNER JOIN PRODUTO PRD
    ON PRD.CODPRODUTO = FLH.CODPRODUTO
WHERE PRD.ATIVO = 2
;



/* View: CIVN_TIPO_CLIENTE */
CREATE OR ALTER VIEW CIVN_TIPO_CLIENTE(
    CODIGO,
    NOME,
    DESCRICAO)
AS
SELECT
    CODSTATUS   ,
    DESCRICAO   ,
    DESCRICAO
FROM STATUS
;



/* View: CIVN_TIPO_ESTOQUE */
CREATE OR ALTER VIEW CIVN_TIPO_ESTOQUE(
    CODIGO,
    NOME,
    DESCRICAO,
    QTMINIMA,
    ESTOQUESEGURO,
    VENDEDOR)
AS
SELECT
    1           ,
    EMPRESA     ,
    RAZAOSOCIAL ,
    0           ,
    'F'         ,
    NULL
FROM SYSPARAMS
;



/* View: CIVN_TIPO_PRECO */
CREATE OR ALTER VIEW CIVN_TIPO_PRECO(
    CODIGO,
    NOME)
AS
SELECT 1, CAST('Preo 1' AS VARCHAR(50)) FROM RDB$DATABASE
UNION
     SELECT 2, CAST('Preo 2' AS VARCHAR(50)) FROM RDB$DATABASE
UNION
     SELECT 3, CAST('Preo 3' AS VARCHAR(50)) FROM RDB$DATABASE
UNION
     SELECT 4, CAST('Preo 4' AS VARCHAR(50)) FROM RDB$DATABASE
UNION
     SELECT 5, CAST('Preo 5' AS VARCHAR(50)) FROM RDB$DATABASE
UNION
     SELECT 6, CAST('Preo 6' AS VARCHAR(50)) FROM RDB$DATABASE
;



/* View: CIVN_TIPO_PRODUTO */
CREATE OR ALTER VIEW CIVN_TIPO_PRODUTO(
    CODIGO,
    NOME,
    DESCRICAO)
AS
SELECT
    CODGRUPO    ,
    DESCRICAO   ,
    DESCRICAO
FROM GRUPO
;



/* View: CIVN_UNIDADE */
CREATE OR ALTER VIEW CIVN_UNIDADE(
    CODIGO,
    NOME,
    DESCRICAO,
    NUM_DECIM)
AS
SELECT
    CODUNIDADE  ,
    SIGLA       ,
    DESCRICAO   ,
    CASE
        WHEN TRAVA_FRACIONADO IS NULL THEN 3
        WHEN TRAVA_FRACIONADO = 'F' THEN 3
        ELSE 0
    END
FROM UNIDADE
;



/* View: CLIENTE */
CREATE OR ALTER VIEW CLIENTE(
    CODPESSOA,
    NOME,
    CODSTATUS,
    PRECOUSADO,
    CODVENDEDOR,
    NOMEFANTAZIA,
    CPFCGC,
    IE,
    LOGRADOURO_1,
    COMPLEMENTO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    CELULAR,
    FAX,
    EMAIL,
    ICMS,
    DT_CADAST,
    TIP_TIPO,
    CODTIPOPAG,
    OBS)
AS
select
      PESSOA.CODPESSOA, NOME, CODSTATUS, PRECOUSADO, CODVENDEDOR, NOMEFANTAZIA, CPFCGC, IE,
      LOGRADOURO_1, COMPLEMENTO_1, BAIRRO_1, CIDADE_1, UF_1, CEP_1, FONES, CELULAR,
      FAX, EMAIL, ICMS, PESSOA.DT_CADAST, TIPOPAG.TIP_TIPO TIP_TIPO, TIPOPAG.CODTIPOPAG CODTIPOPAG, OBS
      from PESSOA
      left join tipopag on (PESSOA.CODTIPOPAG1 = TIPOPAG.CODTIPOPAG)
      where TIPOPESSOA = 'Cliente'
;



/* View: CNNT_SALDOVENDEDOR */
CREATE OR ALTER VIEW CNNT_SALDOVENDEDOR(
    CODIGO,
    NOME,
    SALDO)
AS
SELECT
 VENDEDOR.CODVENDEDOR,
 VENDEDOR.NOME,
 (select
        coalesce((sum(coalesce(CV.VALORDIN,0)) + sum(coalesce(CV.VALORCHE,0))),0)
    from
       CAIXAVEND CV
    where
       ((CV.TIPO = 'SD.INICIAL') or (CV.TIPO = 'ENTRADA'))and
       (CV.CODVENDEDOR = VENDEDOR.CODVENDEDOR) and
       (extract(month from CV.DATA) = extract(month from current_timestamp) )and
       (extract(year from CV.DATA)  = extract(year from current_timestamp))) -
       (select
       coalesce((sum(coalesce(CV.VALORDIN,0)) + sum(coalesce(CV.VALORCHE,0))),0)
    from
       CAIXAVEND CV
    where
       (CV.TIPO = 'SADA') and
       (CV.CODVENDEDOR = VENDEDOR.CODVENDEDOR) and
       (extract(month from CV.DATA) = extract(month from current_timestamp)  )and
       (extract(year from CV.DATA)  = extract(year from current_timestamp) )) AS SALDO
FROM
VENDEDOR
WHERE
VENDEDOR.ATIVO <> 1
;



/* View: COLETORES */
CREATE OR ALTER VIEW COLETORES(
    CODCOLETOR,
    COLETOR)
AS
select COLETOR.CODCOLETOR,
COLETOR.DESCRICAO || ' - ' ||
coalesce((
 select LOCACAO.DESCRICAO from LOCACAO where LOCACAO.CODLOCACAO = CONTRATO_COLETOR.CODLOCADO
),'') || ' - ' ||
coalesce(
 (select SUBLOCACAO.DESCRICAO from SUBLOCACAO where SUBLOCACAO.CODSUBLOCACAO = CONTRATO_COLETOR.CODSUBLOCADO
 and SUBLOCACAO.CODLOCACAO = CONTRATO_COLETOR.CODLOCADO)
,'') COLETOR
from COLETOR
inner join CONTRATO_COLETOR on CONTRATO_COLETOR.CODCOLETOR = COLETOR.CODCOLETOR
;



/* View: CONDICAO */
CREATE OR ALTER VIEW CONDICAO(
    CODTIPOPAG,
    DESCRICAO,
    TIP_TIPO)
AS
select CODTIPOPAG, DESCRICAO, TIP_TIPO from TIPOPAG
;



/* View: CONECTO_PRODUTO */
CREATE OR ALTER VIEW CONECTO_PRODUTO(
    STATUS,
    RECORD,
    ID,
    BASE_PLU_KEY,
    LINK_PLU_KEY,
    PLU_TYPES,
    MAKE_KEY,
    SHORT_DESCRIPTION,
    LONG_DESCRIPTION,
    COMMERCIAL_DESCRIPTION,
    IMAGE_FILE,
    POS_ID,
    COST_DECIMALS,
    UNIT_KEY,
    PRICE_DECIMALS,
    ADDER,
    DEPARTAMENT_KEY,
    SUGGESTED_PROMPT,
    DATA_ENTRY_KEY,
    TARE_KEY,
    IS_COMPLETION,
    HAS_DEPOSIT,
    HAS_PLU_LINK,
    PRICE_REQUERED,
    QUANTITY_DISALLOWED,
    QUANTITY_REQUERED,
    DECIMAL_DISALLOWED,
    DECIMAL_REQUIRED,
    ID_REQUIRED,
    REPEAT_DISALLOWED,
    SCALE,
    TRACKING_TOTAL,
    DEPOSIT,
    NON_MERCHANDISE,
    RETURN_DISALLOWED,
    REFUND_DISALLOWED,
    MARKDOWN_DISALLOWED,
    REBATE,
    NOT_FOR_SALE,
    NEGATIVE,
    CLERK_REQUIRED,
    KIT,
    FOR_SCALE,
    DELIVERY,
    AUTHRIZER_REQUIRED,
    QTY_FROM_AMOUNT,
    PRINT_ETQ,
    COMPLETION,
    IS_PLU_BASE,
    STORE_ADM_PRICE,
    REVERSE_KIT,
    VERIFY_STOCK,
    VALID_DAYS,
    NCM_SH,
    PIS_COFINS,
    QUANTITY,
    QUANTITY_MIN,
    QUANTITY_MAX,
    CLASS,
    MERCHANDISE_ORIGIN,
    MERCHANDISE_GROUP,
    PACKAGE,
    WHOLESALE_QUANTITY,
    DELIVERY_TYPE,
    MESSAGE_SUBTOTAL,
    STANDARD_UNIT,
    QUANTITY_STANDARD,
    IS_PRODUCED,
    IS_INPUT,
    IS_SCANNED,
    GLOSS_WEIGHT,
    NET_WEIGTH,
    TOTAL_TAX,
    SEFAZ_ID,
    ANP_CODE,
    PIS_POS_ID,
    COFINS_POS_ID)
AS
select
  0,
  10,
  PR.CODPRODFILHO,
  0,
  0,
  0,
  P.CODFABRICANTE,
  PR.DESCRICAO,
  PR.DESCRICAO,
  PR.DESCRICAO,
  ' ',
  (select SIGLA from CONECTO_TRIBUTACAO(PR.TRIBUTADO,PR.ALIQUOTAICMS)) SIGLA,
  (select CASADECIMAL from SYSPARAMS),
  ' ',
  (select CASADECIMAL from SYSPARAMS),
  0,
  P.CODGRUPO,
  ' ',
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  0,
  0,
  0,
  0,
  case PR.ATIVABALANCA
    when 'S' then 1
    else 0
  end ATIVABALANCA,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  case P.ATIVO
    when 2 then 1
    else 0
  end ATIVO,
  0,
  0,
  case PR.PRODCOMBINADO
    when 0 then 1
    else 0
  end PRODCOMBINADO,
  case PR.ATIVABALANCA
    when 'S' then 1
    else 0
  end ATIVABALANCA,
  0,
  0,
  0,
  case PR.ATIVABALANCA
    when 'S' then '1'
    else 0
  end ATIVABALANCA,
  0,
  0,
  ' ',
  ' ',
  0,
  0,
  ' ',
  PR.CLASSFISCAL,
  ' ',
  PR.QTDEMBALAGEM,
  1,
  ' ',
  ' ',
  ' ',
  ' ',
  PR.QTDEMBALAGEM,
  ' ',
  ' ',
  ' ',
  PR.CODUNIDADE,
  PR.QTDEMBALAGEM,
  0,
  0,
  ' ',
  PR.PESOBRUTO,
  PR.PESOLIQUIDO,
  ' ',
  PR.CODANP,
  PR.CODANP,
  ' ',
  ' '
from
  PRODFILHO PR
  inner join PRODUTO P on
    PR.CODPRODUTO = P.CODPRODUTO
;



/* View: CONECTO_PRODUTO_FILIAL */
CREATE OR ALTER VIEW CONECTO_PRODUTO_FILIAL(
    STATUS,
    RECORD,
    STORE_KEY,
    ID,
    DESIRED_MARGIN_PERC,
    QUANTITY_IN_STOCK,
    OUT_OF_STOCK_DAY,
    LAST_ENTERED_DAY,
    LAST_SALE_DAY,
    COST,
    START_COST)
AS
select
  0,
  11,
  1,
  PRODFILHO.CODPRODFILHO,
  PRODFILHO.MARKUP1,
  PRODFILHO.ESTQATUAL,
  '',
  '',
  '',
  PRODFILHO.CUSTOREPOSI,
  null
from
  PRODFILHO
;



/* View: CONECTO_PRODUTO_FILIAL_PLU */
CREATE OR ALTER VIEW CONECTO_PRODUTO_FILIAL_PLU(
    STATUS,
    RECORD,
    STORE_KEY,
    ID,
    PRICE,
    START_PRICE,
    TIME_PRICE,
    TYPE_PRICE,
    PROMOTION,
    CODE_PROMOTION,
    POINTS,
    QUANTITY,
    RATE,
    "SEQUENCE")
AS
select
  0,
  12,
  PLU.CODEMPRESA,
  PLUITEM.CODPRODFILHO,
  PLUITEM.PRECONOVO,
  extract(day from PLUITEM.DT_CADAST) ||substring(PLUITEM.DT_CADAST from 6 for 2) ||extract(year from PLUITEM.DT_CADAST),
  '235959',
  PLU.TIPOPRECO,
  case PLU.TIPO
    when 'ATUALIZACAO' then 0
    else 1
  end TIPO,
  PLU.CODPLU,
  0,
  PRODFILHO.ESTQATUAL,
  0,
  0
from
  PLUITEM
  join PLU on
    PLU.CODPLU = PLUITEM.CODPLU
  join PRODFILHO on
    PRODFILHO.CODPRODFILHO = PLUITEM.CODPRODFILHO
;



/* View: CONECTO_PRODUTO_FILIAL_PLU_QTDE */
CREATE OR ALTER VIEW CONECTO_PRODUTO_FILIAL_PLU_QTDE(
    STATUS,
    RECORD,
    STORE_KEY,
    ID,
    TYPE_PRICE,
    STEP_NUMBER,
    PRICE,
    START_PRICE,
    TIME_PRICE,
    TIMES,
    NEXT_STEP,
    ACTION_TYPE)
AS
select
  0,
  15,
  PLU.CODEMPRESA,
  PLUITEM.CODPRODFILHO,
  PLU.TIPOPRECO,
  0,
  PLUITEM.PRECONOVO,
  cast(PLUITEM.DT_CADAST as date),
  cast(PLUITEM.DT_CADAST as time),
  PLU.TIPOPRECO,
  0,
  0
from
  PLUITEM
  join PLU on
    PLU.CODPLU = PLUITEM.CODPLU
  join PRODFILHO on
    PRODFILHO.CODPRODFILHO = PLUITEM.CODPRODFILHO
;



/* View: CONECTO_SKU */
CREATE OR ALTER VIEW CONECTO_SKU(
    STATUS,
    RECORD,
    SKU_ID,
    PLU_ID)
AS
select
  0,
  '01',
  CODPESQ2,
  CODPRODFILHO
from
  PRODFILHO
;



/* View: CONSULTA_MATERIA_PRIMA */
CREATE OR ALTER VIEW CONSULTA_MATERIA_PRIMA(
    CODPRODFILHO,
    DESCRICAO,
    PRECO_MERCADO)
AS
SELECT
  CODPRODFILHO,
  DESCRICAO,
  PRECO_MERCADO
  FROM PRODFILHO
WHERE
  PRDF_MATERIAPRIMA = 'S'
;



/* View: CONTA_ULTIMAREMESSA */
CREATE OR ALTER VIEW CONTA_ULTIMAREMESSA(
    CODCONTA,
    CODULTIMA_REMESSA)
AS
select
  CONTA_REMESSA.CODCONTA,
  max(CONTA_REMESSA.CODCONTA_REMESSA) CODULTIMA_REMESSA
from
  CONTA_REMESSA
group by 1
;



/* View: DEBITO */
CREATE OR ALTER VIEW DEBITO(
    CODPESSOA,
    DT_EMISSAO,
    DT_VENCIM,
    CODPENDVEND,
    CODNFVENDA,
    VLPARCELA,
    STATUS,
    DT_PAGAMEN)
AS
SELECT
  CODPESSOA, DT_EMISSAO, DT_VENCIM, CODPENDVEND, CODNFVENDA, VLPARCELA, STATUS,
  (SELECT MAX(DT_PAGAMEN)FROM CONTABX CB WHERE CB.CODCONTA = C.CODCONTA) DT_PAGAMEN
FROM CONTA C
WHERE TIPO = 'RECEBER'
  AND STATUS <> 'QUITADO'
;



/* View: DSLCADPRO */
CREATE OR ALTER VIEW DSLCADPRO(
    CODPRO,
    DTCADPRO,
    DESCPRO,
    CODGRU,
    CODSUB,
    REF_FABR,
    PROMOCAO,
    PROATIINA,
    ULTREAVDA,
    PREVENDA,
    PREVENDA2,
    PREVENDA3,
    PREVENDA6,
    PRECOANT,
    SALDESTOQ,
    CODFABRICANTE,
    CUSTOMEDIO,
    CUSTOREPOS,
    FATORCONVERSAO)
AS
SELECT PF.CODPESQ1,
       CAST(PF.DT_CADAST AS DATE),
       PF.DESCRICAO,
       PD.CODGRUPO,
       PD.CODSUBGRUPO,
       UN.SIGLA,
       PF.PROMOCAO,
       CASE PD.ATIVO
       WHEN 1 THEN 'I'
       WHEN 2 THEN 'A' END AS ATIVO,
       CAST('01.01.2006' AS DATE),
       PF.PRECOPRATICADO1,
       PF.PRECOPRATICADO2,
       PF.PRECOPRATICADO3,
       PF.PRECOPRATICADO6,
       1,
       PF.ESTQATUAL,
       PD.CODFABRICANTE,
       COALESCE(PF.CUSTOMEDIO,1) AS CUSTOMEDIO,
       COALESCE(PF.CUSTOREPOSI2,1) AS CUSTOREPOSI2,
       COALESCE(PF.FATORCONVERSAO,1) AS FATORCONVERSAO
       FROM PRODFILHO PF
       INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
       INNER JOIN UNIDADE UN ON (PF.CODUNIDADE = UN.CODUNIDADE)
;



/* View: DSLCADSET_TOTAIS */
CREATE OR ALTER VIEW DSLCADSET_TOTAIS(
    CODSET,
    CODGRUPO,
    VENDAS,
    PEDIDOS,
    ATENDIDOS,
    ULTVENDA,
    FLEX,
    FLEXPERC,
    VENDAUNID)
AS
select
   P.CODVENDEDOR,
   PD.CODGRUPO,
   coalesce(sum(PI.PRECOVEND),0) as VENDAS,
   coalesce(count(distinct P.CODPEDVEND),0) as PEDIDOS,
   coalesce(count(distinct P.CODPESSOA),0) as ATENDIDOS,
   max(DT_SAIDA) ,
   coalesce(sum(PI.QTDE*PI.CUSTOREPOSI2),0) as CUSTO,
   coalesce((1-(sum(PI.QTDE*PI.CUSTOREPOSI2) / sum(PI.PRECOVEND)))*100,0) as MARGEM,
   coalesce(sum(PI.QTDE*PF.FATORCONVERSAO),0) as LITROS
   from PEDVEND P
   inner join PEDVENDITEM PI on (P.CODPEDVEND = PI.CODPEDVEND)
   inner join PRODFILHO PF on (PI.CODPRODFILHO = PF.CODPRODFILHO)
   inner join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
   where P.STATUSPED <> 'CANCELADO' and P.TIPOPED = 'VENDA'
   and extract(month from P.DT_SAIDA) = extract(month from (select first 1 DATAPALM from DATAPALM))
   and extract(year from P.DT_SAIDA) = extract(year from (select first 1 DATAPALM from DATAPALM))
   group by 1,2
;



/* View: DSLCADSET */
CREATE OR ALTER VIEW DSLCADSET(
    CODSET,
    NOMSET,
    CODGRUPO,
    COTASET,
    VENDAS,
    PEDIDOS,
    QUANTCLI,
    ATENDIDOS,
    ULTVENDA,
    FLEX,
    FLEXPERC,
    COTAUNID,
    VENDAUNID,
    TABELA1,
    TABELA2,
    TABELA3,
    TABELA4,
    TABELA5,
    TABELA6)
AS
select
   RIGHT('00000000' || cast(V.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR,
   NOME,
   VM.CODGRUPO,
   coalesce(VM.VALOR,0) as TOT_VALOR,
   coalesce(VENDAS,0) as VENDAS,
   coalesce(PEDIDOS,0) as PEDIDOS,
   coalesce(VM.POTENCIAL,0) as TOT_POTENCIAL,
   coalesce(ATENDIDOS,0) as ATENDIDOS,
   ULTVENDA,
   coalesce(FLEX,0) as CUSTO,
   coalesce(FLEXPERC,0) as MARGEM,
   coalesce(VM.QTD,0) as TOT_QTD,
   coalesce(VENDAUNID,0) as LITROS,
   PRECO1,
   PRECO2,
   PRECO3,
   PRECO4,
   PRECO5,
   PRECO6
   from VENDEDOR V
   inner join VENDEDORMETAS VM on (V.CODVENDEDOR = VM.CODVENDEDOR and
   extract(month from (select first 1 DATAPALM from datapalm)) >= extract(month from VM.INICIO) and
   extract(month from (select first 1 DATAPALM from datapalm)) <= extract(month from VM.FINAL) and
   (extract(year from (select first 1 DATAPALM from datapalm)) = extract(year from VM.FINAL) or
   extract(year from (select first 1 DATAPALM from datapalm)) = extract(year from VM.INICIO)))
   left join DSLCADSET_TOTAIS DT on (DT.CODSET = V.CODVENDEDOR and DT.CODGRUPO = VM.CODGRUPO)
;



/* View: DSLCADSET_RAPIDO */
CREATE OR ALTER VIEW DSLCADSET_RAPIDO(
    CODSET,
    NOMSET,
    TABELA1,
    TABELA2,
    TABELA3)
AS
SELECT
   RIGHT('00000000' || CAST(V.CODVENDEDOR AS VARCHAR(6)) ,4) AS CODVENDEDOR,
   NOME,
   PRECO1,
   PRECO2,
   PRECO3
   FROM VENDEDOR V
;



/* View: EMBARQUEITEMVIEW */
CREATE OR ALTER VIEW EMBARQUEITEMVIEW(
    CODEMBARQUEITEM,
    CODEMBARQUE_FK,
    CODPEDVEND_FK,
    DT_CADAST,
    US_CADAST,
    DT_MODIFI,
    US_MODIFI,
    RETORNO,
    DT_ENTREGAPREV,
    CODPESSOA,
    NOME,
    LOGRADOURO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    STATUSPED,
    CODNFVENDA,
    VALOR_TOTAL,
    TIPOPAG,
    DTFATURADO,
    PDV_CRITICA,
    PESOBRUTO,
    CODPEDVENDITEM)
AS
select
  CODEMBARQUEITEM,
  coalesce(CODEMBARQUE_FK, 0),
  CODPEDVEND_FK,
  E.DT_CADAST,
  E.US_CADAST,
  E.DT_MODIFI,
  E.US_MODIFI,
  E.RETORNO,
  DT_ENTREGAPREV,
  C.CODPESSOA,
  C.NOME,
  LOGRADOURO_1,
  BAIRRO_1,
  CIDADE_1,
  UF_1,
  CEP_1,
  STATUSPED,
  coalesce(P.CODNFVENDA, P.CODFATURAMENTO) CODNFVENDA,
  P.VALOR_TOTAL,
  P.TIPOPAG,
  P.DTFATURADO,
  P.PDV_CRITICA,
  (select
     sum(PF.PESOBRUTO * PI.QTDENTREGUE)
   from
     PEDVENDITEM PI
     join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
   where
     PI.CODPEDVEND = E.CODPEDVEND_FK) PESOBRUTO,
  (select
     count(PI.CODPEDVENDITEM)
   from
     PEDVENDITEM PI
   where
     PI.CODPEDVEND = E.CODPEDVEND_FK) CODPEDVENDITEM
from
  EMBARQUEITEM E
  join PEDVEND P on CODPEDVEND_FK = CODPEDVEND
  join PESSOA C on P.CODPESSOA = C.CODPESSOA
;



/* View: EMP_EMPRESA */
CREATE OR ALTER VIEW EMP_EMPRESA(
    EMAIL,
    PESSOA_CONTATO,
    UF_1,
    BAIRRO_1,
    CIDADE_1,
    UF_11,
    LOGRADOURO_1,
    COMPLEMENTO_1,
    CEP_1,
    FONES,
    CELULAR,
    CPFCGC,
    NOME,
    NOMEFANTAZIA,
    EMP_TIPO_EMPRESA,
    CODPESSOA,
    CODTIPOATV,
    EMP_CD_FORNECEDOR_IMPORT)
AS
SELECT
  PESSOA.EMAIL AS EMP_EMAIL,
  PESSOA.PESSOA_CONTATO AS EMP_CONTATO,
  PESSOA.UF_1 AS EMP_UF_ATUACAO,
  PESSOA.BAIRRO_1 AS EMP_BAIRRO,
  PESSOA.CIDADE_1 AS EMP_CIDADE,
  PESSOA.UF_1 AS EMP_ESTADO,
  PESSOA.LOGRADOURO_1 AS EMP_LOGRADOURO,
  PESSOA.COMPLEMENTO_1 AS EMP_COMPLEMENTO,
  PESSOA.CEP_1 AS EMP_CEP,
  PESSOA.FONES AS EMP_FONE_FIXO,
  PESSOA.CELULAR AS EMP_FONE_CELULAR,
  PESSOA.CPFCGC AS EMP_CNPJ_CPF,
  PESSOA.NOME AS EMP_RAZAO_SOCIAL,
  PESSOA.NOMEFANTAZIA AS EMP_NOME_FANTASIA,
  'PDV' AS EMP_TIPO_EMPRESA,
  PESSOA.CODPESSOA AS EMP_CD_EMPRESA_IMPORT,
  PESSOA.CODTIPOATV AS EMP_CD_SEGMENTACAO_IMPORT,
  'NULO' AS EMP_CD_FORNECEDOR_IMPORT
FROM
 PESSOA
WHERE PESSOA.CODSTATUS = 1
UNION
SELECT
  PESSOA.EMAIL AS EMP_EMAIL,
  PESSOA.PESSOA_CONTATO AS EMP_CONTATO,
  PESSOA.UF_1 AS EMP_UF_ATUACAO,
  PESSOA.BAIRRO_1 AS EMP_BAIRRO,
  PESSOA.CIDADE_1 AS EMP_CIDADE,
  PESSOA.UF_1 AS EMP_ESTADO,
  PESSOA.LOGRADOURO_1 AS EMP_LOGRADOURO,
  PESSOA.COMPLEMENTO_1 AS EMP_COMPLEMENTO,
  PESSOA.CEP_1 AS EMP_CEP,
  PESSOA.FONES AS EMP_FONE_FIXO,
  PESSOA.CELULAR AS EMP_FONE_CELULAR,
  PESSOA.CPFCGC AS EMP_CNPJ_CPF,
  PESSOA.NOME AS EMP_RAZAO_SOCIAL,
  PESSOA.NOMEFANTAZIA AS EMP_NOME_FANTASIA,
  'DIS' AS EMP_TIPO_EMPRESA,
  PESSOA.CODPESSOA AS EMP_CD_EMPRESA_IMPORT,
  PESSOA.CODTIPOATV AS EMP_CD_SEGMENTACAO_IMPORT,
  'NULO' AS EMP_CD_FORNECEDOR_IMPORT
FROM
 PESSOA
WHERE PESSOA.CODSTATUS = 2
UNION
SELECT
  PESSOA.EMAIL AS EMP_EMAIL,
  PESSOA.PESSOA_CONTATO AS EMP_CONTATO,
  PESSOA.UF_1 AS EMP_UF_ATUACAO,
  PESSOA.BAIRRO_1 AS EMP_BAIRRO,
  PESSOA.CIDADE_1 AS EMP_CIDADE,
  PESSOA.UF_1 AS EMP_ESTADO,
  PESSOA.LOGRADOURO_1 AS EMP_LOGRADOURO,
  PESSOA.COMPLEMENTO_1 AS EMP_COMPLEMENTO,
  PESSOA.CEP_1 AS EMP_CEP,
  PESSOA.FONES AS EMP_FONE_FIXO,
  PESSOA.CELULAR AS EMP_FONE_CELULAR,
  PESSOA.CPFCGC AS EMP_CNPJ_CPF,
  PESSOA.NOME AS EMP_RAZAO_SOCIAL,
  PESSOA.NOMEFANTAZIA AS EMP_NOME_FANTASIA,
  'TIM' AS EMP_TIPO_EMPRESA,
  PESSOA.CODPESSOA AS EMP_CD_EMPRESA_IMPORT,
  PESSOA.CODTIPOATV AS EMP_CD_SEGMENTACAO_IMPORT,
  'NULO' AS EMP_CD_FORNECEDOR_IMPORT
FROM
 PESSOA
WHERE PESSOA.CODSTATUS = 3
;



/* View: EST_ESTOQUE */
CREATE OR ALTER VIEW EST_ESTOQUE(
    ESTQATUAL,
    EST_CD_EMPRESA_IMPORT,
    CODPRODFILHO,
    EST_CD_ESTOQUE_IMPORT)
AS
SELECT
  PRODFILHO.ESTQATUAL AS EST_QUANTIDADE,
  (SELECT CODPESSOA FROM PESSOA WHERE CODSTATUS = 2) AS EST_CD_EMPRESA_IMPORT,
  PRODFILHO.CODPRODFILHO AS EST_CD_PROD_DIS,
  'NULO' AS EST_CD_ESTOQUE_IMPORT
FROM
 PRODUTO
 INNER JOIN PRODFILHO ON (PRODUTO.CODPRODUTO=PRODFILHO.CODPRODUTO)
WHERE
  (PRODUTO.CODGRUPO = 3)
;



/* View: ESTADOS */
CREATE OR ALTER VIEW ESTADOS(
    CODESTADO,
    SIGLA,
    ESTADO)
AS
select codestado, 
       '''' || sigla || '''',
       estado
from tbl_estado
;



/* View: FORNECEDOR */
CREATE OR ALTER VIEW FORNECEDOR(
    CODPESSOA,
    NOMEFANTAZIA)
AS
select
  CODPESSOA, NOMEFANTAZIA
from
  PESSOA WHERE TIPOPESSOA = 'Fornecedor'
;



/* View: FRM_PAG */
CREATE OR ALTER VIEW FRM_PAG(
    CODTIPOPAG,
    DESCRICAO,
    TIP_TIPO)
AS
select CODTIPOPAG, DESCRICAO, TIP_TIPO from TIPOPAG
;



/* View: FUNC */
CREATE OR ALTER VIEW FUNC(
    CODVENDEDOR,
    NOMEVENDEDOR,
    NOMESUPERVISOR,
    FONES,
    CELULAR)
AS
select
  v.CODVENDEDOR,
  v.NOME NOMEVENDEDOR,
  coalesce(s.NOME, 'NENHUM') NOMESUPERVISOR,
  v.FONES,
  v.CELULAR
from
  VENDEDOR v
    left join SUPERVISOR s on v.CODSUPERVISOR = s.CODSUPERVISOR
;



/* View: ITN_ITEM_NOTA */
CREATE OR ALTER VIEW ITN_ITEM_NOTA(
    ITN_QUANTIDADE,
    ITN_CD_NOTA_FISCAL_IMPORT,
    ITN_CD_VENDEDOR_IMPORT,
    ITN_CD_PROD_DIS,
    ITN_CD_ITEM_NOTA_IMPORT)
AS
SELECT
  PEDVENDITEM.QTDE AS ITN_QUANTIDADE,
  CAST('S' || PEDVENDITEM.CODPEDVEND AS VARCHAR(17)) AS ITN_CD_NOTA_FISCAL_IMPORT,
  PEDVEND.CODVENDEDOR AS ITN_CD_VENDEDOR_IMPORT,
  PEDVENDITEM.CODPRODFILHO AS ITN_CD_PROD_DIS,
  '00' AS ITN_CD_ITEM_NOTA_IMPORT
FROM
 PEDVENDITEM
 INNER JOIN PEDVEND ON (PEDVENDITEM.CODPEDVEND=PEDVEND.CODPEDVEND)
UNION
SELECT
  AJUSTESTOQITEM.QTDE AS ITN_QUANTIDADE,
  CAST('E' || AJUSTESTOQITEM.CODAJUSTESTOQ AS VARCHAR(17)) AS ITN_CD_NOTA_FISCAL_IMPORT,
  1 AS ITN_CD_VENDEDOR_IMPORT,
  AJUSTESTOQITEM.CODPRODFILHO AS ITN_CD_PROD_DIS,
  '00' AS ITN_CD_ITEM_NOTA_IMPORT
FROM
 AJUSTESTOQITEM
 INNER JOIN AJUSTESTOQ ON (AJUSTESTOQITEM.CODAJUSTESTOQ=AJUSTESTOQ.CODAJUSTESTOQ)
;



/* View: MAPAVENDAS */
CREATE OR ALTER VIEW MAPAVENDAS(
    CODVENDEDOR,
    VENDEDOR,
    CODSTATUS,
    STATUS,
    CODPESSOA,
    PESSOA,
    CODPEDVEND,
    DTFATURADO,
    CODGRUPO,
    GRUPO,
    CODSUBGRUPO,
    SUBGRUPO,
    CODPRODFILHO,
    PRODFILHO,
    UNIDADE,
    QTDENTREGUE,
    CAIXA,
    PRECOPROD,
    DESCONTO_VALOR,
    PESOBRUTO,
    PESOLIQUIDO,
    PERDA,
    USUARIO,
    ACRESCIMOVALOR,
    FRETE,
    CODEMPRESA,
    CIDADE,
    ARE_CODIGO,
    AREA,
    CURVA,
    VALORIPI,
    CODFABRICANTE,
    CUBAGEM,
    CMV,
    CODPESQ1,
    PRECOFORNEC,
    CUSTOREPOSI,
    PRECOPRATICADO1,
    ESTQATUAL,
    BAIRRO,
    UF)
AS
select
  V.CODVENDEDOR,
  V.NOME,
  ST.CODSTATUS,
  ST.DESCRICAO,
  PE.CODPESSOA,
  PE.NOME,
  case (select VALOR from MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0))
  when 0 then
    coalesce(P.CODFATURAMENTO, P.CODNFVENDA, P.CODPEDVEND)
  else
    P.CODPEDVEND
  end,
  cast(coalesce(P.DTFATURADO,P.DT_SAIDA) as date),
  G.CODGRUPO,
  G.DESCRICAO,
  S.CODSUBGRUPO,
  S.DESCRICAO,
  PI.CODPRODFILHO,
  PF.DESCRICAO,
  coalesce(PF.UNIDADE, U.SIGLA),
  PI.QTDENTREGUE,
  PI.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1),
  PI.PRECOPROD,
  (((coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0)) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) + coalesce(PI.DESCONTO_VALOR,0)) as TOTDESCONTO,
  PF.PESOBRUTO * PI.QTDENTREGUE,
  PF.PESOLIQUIDO * PI.QTDENTREGUE,
  PI.PERDA,
  P.US_CADAST,
  (((coalesce(P.ACRESVALOR,0) + (coalesce(P.VALOR_BRUTO,0) * (coalesce(P.ACRESCIMO,0)/100))) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1)))) as TOTDESCONTO,
  (coalesce(P.FRETE,0) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) as FRETE,
  P.CODEMPRESA,
  PE.CIDADE_1,
  PE.ARE_CODIGO,
  COALESCE(TA.ARE_DESCRICAO,'AREA NO ASSOCIADA'),
  PF.CURVA,
  (coalesce(PI.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)),
  PR.CODFABRICANTE,
  (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(PI.QTDENTREGUE,0)),
  (coalesce(PF.CUSTOMEDIO,0) * coalesce(PI.QTDENTREGUE,0)),
  PF.CODPESQ1,
  PF.PRECOFORNEC,
  PF.CUSTOREPOSI,
  PF.PRECOPRATICADO1,
  PF.ESTQATUAL,
  PE.BAIRRO_1,
  PE.UF_1
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join STATUS ST on PE.CODSTATUS = ST.CODSTATUS
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join GRUPO G on PR.CODGRUPO = G.CODGRUPO
  join SUBGRUPO S on PR.CODSUBGRUPO = S.CODSUBGRUPO
  join UNIDADE U on PF.CODUNIDADE = U.CODUNIDADE
  left join TBL_AREA TA on TA.ARE_CODIGO = PE.ARE_CODIGO
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA', 'CADERNO')
;



/* View: MAPAVENDAS_BI2 */
CREATE OR ALTER VIEW MAPAVENDAS_BI2(
    CODVENDEDOR,
    VENDEDOR,
    CODSTATUS,
    STATUS,
    CODPESSOA,
    PESSOA,
    CODPEDVEND,
    DTFATURADO,
    CODGRUPO,
    GRUPO,
    CODSUBGRUPO,
    SUBGRUPO,
    CODPRODFILHO,
    PRODFILHO,
    UNIDADE,
    QTDENTREGUE,
    QTDFATOR,
    CAIXA,
    PRECOPROD,
    DESCONTO_VALOR,
    PESOBRUTO,
    PESOLIQUIDO,
    PERDA,
    USUARIO,
    ACRESCIMOVALOR,
    FRETE,
    CODEMPRESA,
    CIDADE,
    ARE_CODIGO,
    AREA,
    CURVA,
    VALORIPI,
    CODFABRICANTE,
    CUBAGEM,
    CMV,
    CODPESQ1,
    PRECOFORNEC,
    CUSTOREPOSI,
    PRECOPRATICADO1,
    ESTQATUAL,
    BAIRRO,
    UF,
    SUPERVISOR,
    FABRICANTE,
    LATITUDE,
    LONGITUDE,
    CUSTO_ITEM_REPOSICAO,
    RAMO,
    ATIVIDADE,
    TIPO_ATIVIDADE)
AS
select
  V.CODVENDEDOR,
  V.NOME,
  ST.CODSTATUS,
  ST.DESCRICAO,
  PE.CODPESSOA,
  PE.NOME,
  P.CODPEDVEND,
  cast(coalesce(P.DT_ENTREGAPREV,P.DT_SAIDA) as date),
  G.CODGRUPO,
  G.DESCRICAO,
  S.CODSUBGRUPO,
  S.DESCRICAO,
  PI.CODPRODFILHO,
  PF.DESCRICAO,
  coalesce(PF.UNIDADE, U.SIGLA),
  PI.QTDENTREGUE,
  PI.QTDENTREGUE * coalesce(PF.fatorconversao, 1),
  PI.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1),
  PI.precovend / PI.qtdentregue,
  (((coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0)) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) + coalesce(PI.DESCONTO_VALOR,0)) as TOTDESCONTO,
  PF.PESOBRUTO * PI.QTDENTREGUE,
  PF.PESOLIQUIDO * PI.QTDENTREGUE,
  PI.PERDA,
  P.US_CADAST,
  (((coalesce(P.ACRESVALOR,0) + (coalesce(P.VALOR_BRUTO,0) * (coalesce(P.ACRESCIMO,0)/100))) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1)))) as TOTDESCONTO,
  (coalesce(P.FRETE,0) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) as FRETE,
  P.CODEMPRESA,
  PE.CIDADE_1,
  PE.ARE_CODIGO,
  COALESCE(TA.ARE_DESCRICAO,'AREA NO ASSOCIADA'),
  PF.CURVA,
  (coalesce(PI.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)),
  PR.CODFABRICANTE,
  (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(PI.QTDENTREGUE,0)),
  (coalesce(PF.CUSTOMEDIO,0) * coalesce(PI.QTDENTREGUE,0)),
  PF.CODPESQ1,
  PF.PRECOFORNEC,
  PI.CUSTOREPOSI2,
  PF.PRECOPRATICADO1,
  PF.ESTQATUAL,
  PE.BAIRRO_1,
  PE.UF_1,
  SU.NOME SUPERVISOR,
  PE2.NOME FABRICANTE,
  PE.LATITUDE,
  PE.LONGITUDE,
  coalesce((1 - ((PI.QTDE * PI.CUSTOREPOSI2) / PRECOVEND)) * 100,0) CUSTO_ITEM_REPOSICAO,
  TBL_RAMO.DESCRICAO RAMO,
  TBL_RAMOATV.DESCRICAO ATIVIDADE,
  TBL_RAMOATVTIPO.DESCRICAO TIPO_ATIVIDADE
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  LEFT join SUPERVISOR SU on SU.CODSUPERVISOR = V.CODSUPERVISOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join STATUS ST on PE.CODSTATUS = ST.CODSTATUS
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  LEFT join PESSOA PE2 on PR.CODFABRICANTE = PE2.CODPESSOA
  join GRUPO G on PR.CODGRUPO = G.CODGRUPO
  join SUBGRUPO S on PR.CODSUBGRUPO = S.CODSUBGRUPO
  join UNIDADE U on PF.CODUNIDADE = U.CODUNIDADE
  left join TBL_AREA TA on TA.ARE_CODIGO = PE.ARE_CODIGO
  inner join TBL_RAMOATVTIPO on TBL_RAMOATVTIPO.CODTIPO = PE.CODTIPOATV
  inner join TBL_RAMOATV on TBL_RAMOATV.CODATIVIDADE = TBL_RAMOATVTIPO.CODATIVIDADE
  inner join TBL_RAMO on TBL_RAMO.CODRAMO = TBL_RAMOATV.CODRAMO
where
  P.STATUSPED <> 'CANCELADO' and
  P.TIPOPED in ('VENDA', 'CADERNO')
;



/* View: MAPAVENDAS_INDUSTRIA */
CREATE OR ALTER VIEW MAPAVENDAS_INDUSTRIA(
    CODVENDEDOR,
    VENDEDOR,
    CODSTATUS,
    STATUS,
    CODPESSOA,
    PESSOA,
    CODPEDVEND,
    DTFATURADO,
    CODGRUPO,
    GRUPO,
    CODSUBGRUPO,
    SUBGRUPO,
    CODPRODFILHO,
    PRODFILHO,
    UNIDADE,
    QTDENTREGUE,
    CAIXA,
    PRECOPROD,
    DESCONTO_VALOR,
    PESOBRUTO,
    PESOLIQUIDO,
    PERDA,
    USUARIO,
    ACRESCIMOVALOR,
    FRETE,
    CODEMPRESA,
    CIDADE,
    ARE_CODIGO,
    AREA,
    CURVA,
    VALORIPI,
    CODFABRICANTE,
    CUBAGEM,
    CMV,
    CODPESQ1,
    PRECOFORNEC,
    CUSTOREPOSI,
    PRECOPRATICADO1,
    ESTQATUAL,
    BAIRRO,
    UF)
AS
select
  V.CODVENDEDOR,
  V.NOME,
  ST.CODSTATUS,
  ST.DESCRICAO,
  PE.CODPESSOA,
  PE.NOME,
  case (select VALOR from MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0))
  when 0 then
    coalesce(P.CODFATURAMENTO, P.CODNFVENDA, P.CODPEDVEND)
  else
    P.CODPEDVEND
  end,
  cast(coalesce(P.DTFATURADO,P.DT_SAIDA) as date),
  G.CODGRUPO,
  G.DESCRICAO,
  S.CODSUBGRUPO,
  S.DESCRICAO,
  PI.CODPRODFILHO,
  PF.DESCRICAO,
  coalesce(PF.UNIDADE, U.SIGLA),
  PI.QTDENTREGUE,
  PI.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1),
  PI.PRECOPROD,
  (((coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0)) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) + coalesce(PI.DESCONTO_VALOR,0)) as TOTDESCONTO,
  PF.PESOBRUTO * PI.QTDENTREGUE,
  PF.PESOLIQUIDO * PI.QTDENTREGUE,
  PI.PERDA,
  P.US_CADAST,
  (((coalesce(P.ACRESVALOR,0) + (coalesce(P.VALOR_BRUTO,0) * (coalesce(P.ACRESCIMO,0)/100))) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1)))) as TOTDESCONTO,
  (coalesce(P.FRETE,0) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) as FRETE,
  P.CODEMPRESA,
  PE.CIDADE_1,
  PE.ARE_CODIGO,
  COALESCE(TA.ARE_DESCRICAO,'AREA NO ASSOCIADA'),
  PF.CURVA,
  case coalesce(PE.PES_ISENTOIPI,0)
    when 0 then
      (coalesce(PI.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100))
  else
    0
  end,
  PR.CODFABRICANTE,
  (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(PI.QTDENTREGUE,0)),
  (coalesce(PF.CUSTOMEDIO,0) * coalesce(PI.QTDENTREGUE,0)),
  PF.CODPESQ1,
  PF.PRECOFORNEC,
  PF.CUSTOREPOSI,
  PF.PRECOPRATICADO1,
  PF.ESTQATUAL,
  PE.BAIRRO_1,
  PE.UF_1
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join STATUS ST on PE.CODSTATUS = ST.CODSTATUS
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join GRUPO G on PR.CODGRUPO = G.CODGRUPO
  join SUBGRUPO S on PR.CODSUBGRUPO = S.CODSUBGRUPO
  join UNIDADE U on PF.CODUNIDADE = U.CODUNIDADE
  left join TBL_AREA TA on TA.ARE_CODIGO = PE.ARE_CODIGO
where
  P.STATUSPED = 'FATURADO' and
  (P.TIPOPED in (select TIPOPED from TIPOVENDA where GERAFAT = 1) or (p.tipoped in ('VENDA', 'CADERNO')))
;



/* View: MAPAVENDAS_PEDIDOS */
CREATE OR ALTER VIEW MAPAVENDAS_PEDIDOS(
    CODVENDEDOR,
    VENDEDOR,
    CODSTATUS,
    STATUS,
    CODPESSOA,
    PESSOA,
    CODPEDVEND,
    DTFATURADO,
    CODGRUPO,
    GRUPO,
    CODSUBGRUPO,
    SUBGRUPO,
    CODPRODFILHO,
    PRODFILHO,
    UNIDADE,
    QTDENTREGUE,
    CAIXA,
    PRECOPROD,
    DESCONTO_VALOR,
    PESOBRUTO,
    PESOLIQUIDO,
    PERDA,
    USUARIO,
    ACRESCIMOVALOR,
    FRETE,
    CODEMPRESA,
    CIDADE,
    ARE_CODIGO,
    AREA,
    CURVA,
    VALORIPI,
    CODFABRICANTE,
    CUBAGEM,
    CMV,
    CODPESQ1,
    PRECOFORNEC,
    CUSTOREPOSI,
    PRECOPRATICADO1,
    ESTQATUAL,
    BAIRRO,
    UF)
AS
select
  V.CODVENDEDOR,
  V.NOME,
  ST.CODSTATUS,
  ST.DESCRICAO,
  PE.CODPESSOA,
  PE.NOME,
  case (select VALOR from MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0))
  when 0 then
    coalesce(P.CODFATURAMENTO, P.CODNFVENDA, P.CODPEDVEND)
  else
    P.CODPEDVEND
  end,
  cast(coalesce(P.DTFATURADO,P.DT_SAIDA) as date),
  G.CODGRUPO,
  G.DESCRICAO,
  S.CODSUBGRUPO,
  S.DESCRICAO,
  PI.CODPRODFILHO,
  PF.DESCRICAO,
  coalesce(PF.UNIDADE, U.SIGLA),
  PI.QTDENTREGUE,
  PI.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1),
  PI.PRECOPROD,
  (((coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0)) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) + coalesce(PI.DESCONTO_VALOR,0)) as TOTDESCONTO,
  PF.PESOBRUTO * PI.QTDENTREGUE,
  PF.PESOLIQUIDO * PI.QTDENTREGUE,
  PI.PERDA,
  P.US_CADAST,
  (((coalesce(P.ACRESVALOR,0) + (coalesce(P.VALOR_BRUTO,0) * (coalesce(P.ACRESCIMO,0)/100))) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1)))) as TOTDESCONTO,
  (coalesce(P.FRETE,0) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) as FRETE,
  P.CODEMPRESA,
  PE.CIDADE_1,
  PE.ARE_CODIGO,
  COALESCE(TA.ARE_DESCRICAO,'AREA NO ASSOCIADA'),
  PF.CURVA,
  (coalesce(PI.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)),
  PR.CODFABRICANTE,
  (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(PI.QTDENTREGUE,0)),
  (coalesce(PF.CUSTOMEDIO,0) * coalesce(PI.QTDENTREGUE,0)),
  PF.CODPESQ1,
  PF.PRECOFORNEC,
  PF.CUSTOREPOSI,
  PF.PRECOPRATICADO1,
  PF.ESTQATUAL,
  PE.BAIRRO_1,
  PE.UF_1
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join STATUS ST on PE.CODSTATUS = ST.CODSTATUS
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join GRUPO G on PR.CODGRUPO = G.CODGRUPO
  join SUBGRUPO S on PR.CODSUBGRUPO = S.CODSUBGRUPO
  join UNIDADE U on PF.CODUNIDADE = U.CODUNIDADE
  left join TBL_AREA TA on TA.ARE_CODIGO = PE.ARE_CODIGO
where
  P.STATUSPED <> 'CANCELADO'
;



/* View: MAPAVENDAS_PEDIDOS_NORMAIS */
CREATE OR ALTER VIEW MAPAVENDAS_PEDIDOS_NORMAIS(
    CODVENDEDOR,
    VENDEDOR,
    CODSTATUS,
    STATUS,
    CODPESSOA,
    PESSOA,
    CODPEDVEND,
    DTFATURADO,
    CODGRUPO,
    GRUPO,
    CODSUBGRUPO,
    SUBGRUPO,
    CODPRODFILHO,
    PRODFILHO,
    UNIDADE,
    QTDENTREGUE,
    CAIXA,
    PRECOPROD,
    DESCONTO_VALOR,
    PESOBRUTO,
    PESOLIQUIDO,
    PERDA,
    USUARIO,
    ACRESCIMOVALOR,
    FRETE,
    CODEMPRESA,
    CIDADE,
    ARE_CODIGO,
    AREA,
    CURVA,
    VALORIPI,
    CODFABRICANTE,
    CUBAGEM,
    CMV,
    CODPESQ1,
    PRECOFORNEC,
    CUSTOREPOSI,
    PRECOPRATICADO1,
    ESTQATUAL,
    BAIRRO,
    UF)
AS
select
  V.CODVENDEDOR,
  V.NOME,
  ST.CODSTATUS,
  ST.DESCRICAO,
  PE.CODPESSOA,
  PE.NOME,
  case (select VALOR from MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0))
  when 0 then
    coalesce(P.CODFATURAMENTO, P.CODNFVENDA, P.CODPEDVEND)
  else
    P.CODPEDVEND
  end,
  cast(coalesce(P.DTFATURADO,P.DT_SAIDA) as date),
  G.CODGRUPO,
  G.DESCRICAO,
  S.CODSUBGRUPO,
  S.DESCRICAO,
  PI.CODPRODFILHO,
  PF.DESCRICAO,
  coalesce(PF.UNIDADE, U.SIGLA),
  PI.QTDENTREGUE,
  PI.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1),
  PI.PRECOPROD,
  (((coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0)) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) + coalesce(PI.DESCONTO_VALOR,0)) as TOTDESCONTO,
  PF.PESOBRUTO * PI.QTDENTREGUE,
  PF.PESOLIQUIDO * PI.QTDENTREGUE,
  PI.PERDA,
  P.US_CADAST,
  (((coalesce(P.ACRESVALOR,0) + (coalesce(P.VALOR_BRUTO,0) * (coalesce(P.ACRESCIMO,0)/100))) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1)))) as TOTDESCONTO,
  (coalesce(P.FRETE,0) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) as FRETE,
  P.CODEMPRESA,
  PE.CIDADE_1,
  PE.ARE_CODIGO,
  COALESCE(TA.ARE_DESCRICAO,'AREA NO ASSOCIADA'),
  PF.CURVA,
  (coalesce(PI.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)),
  PR.CODFABRICANTE,
  (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(PI.QTDENTREGUE,0)),
  (coalesce(PF.CUSTOMEDIO,0) * coalesce(PI.QTDENTREGUE,0)),
  PF.CODPESQ1,
  PF.PRECOFORNEC,
  PF.CUSTOREPOSI,
  PF.PRECOPRATICADO1,
  PF.ESTQATUAL,
  PE.BAIRRO_1,
  PE.UF_2
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join STATUS ST on PE.CODSTATUS = ST.CODSTATUS
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join GRUPO G on PR.CODGRUPO = G.CODGRUPO
  join SUBGRUPO S on PR.CODSUBGRUPO = S.CODSUBGRUPO
  join UNIDADE U on PF.CODUNIDADE = U.CODUNIDADE
  left join TBL_AREA TA on TA.ARE_CODIGO = PE.ARE_CODIGO
where
  P.STATUSPED = 'NORMAL' and
  P.TIPOPED in ('VENDA', 'CADERNO')
;



/* View: MARFIM_SLCADSET_TOTAIS */
CREATE OR ALTER VIEW MARFIM_SLCADSET_TOTAIS(
    CODSET,
    VENDAS,
    PEDIDOS,
    ATENDIDOS,
    ULTVENDA,
    FLEX,
    FLEXPERC,
    VENDAUNID)
AS
select
  RIGHT('00000000' || cast(P.CODVENDEDOR as varchar(6)), 4),
  coalesce(sum(PI.PRECOVEND),0),
  coalesce(count(distinct P.CODPEDVEND),0),
  coalesce(count(distinct P.CODPESSOA),0),
  max(cast(DTFATURADO as date)) ,
  (coalesce(sum(PI.QTDE*PI.PRECOPROD),0)) - (coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)),
--  ((coalesce(sum(PI.QTDE*PI.PRECOPROD),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  (((coalesce(sum(PI.PRECOVEND),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  coalesce(sum(PI.QTDE),0) as LITROS
from
  PEDVEND P
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA','CADERNO') and
  cast(P.DTFATURADO as date) between '26.12.2012' and '25.01.2013'
group by
  1
;



/* View: MET_META */
CREATE OR ALTER VIEW MET_META(
    MET_META_MENSAL,
    MET_ANO,
    MET_MES,
    MET_CD_VENDEDOR_IMPORT,
    MET_CD_PROD_DIS,
    MET_CD_META_IMPORT)
AS
SELECT 
  VENDEDORMETAS.QTD AS MET_META_MENSAL,
  extract(year from VENDEDORMETAS.INICIO) AS MET_ANO,
  extract(month from VENDEDORMETAS.INICIO) AS MET_MES,
  VENDEDORMETAS.CODVENDEDOR AS MET_CD_VENDEDOR_IMPORT,
  VENDEDORMETAS.CODPRODFILHO AS MET_CD_PROD_DIS,
  VENDEDORMETAS.CODIGO AS MET_CD_META_IMPORT
FROM
 VENDEDORMETAS
;



/* View: MOV_MOVIMENTACAO */
CREATE OR ALTER VIEW MOV_MOVIMENTACAO(
    MOV_CD_MOVIMENTACAO_IMPORT,
    MOV_DESCRICAO)
AS
SELECT
  SUBSTRING(AJUSTESTOQ.TIPO FROM 1 FOR 1) AS MOV_CD_MOVIMENTACAO_IMPORT,
  AJUSTESTOQ.TIPO AS MOV_DESCRICAO
FROM
 AJUSTESTOQ
WHERE TIPO <> 'INVENTRIO'
GROUP BY TIPO
;



/* View: MSLCADPRO */
CREATE OR ALTER VIEW MSLCADPRO(
    CODPRO,
    DTCADPRO,
    DESCPRO,
    CODGRU,
    REF_FABR,
    PROMOCAO,
    PROATIINA,
    ULTREAVDA,
    PREVENDA,
    PRECOANT,
    SALDESTOQ,
    PRECO_UNIT,
    QTDEMBALAGEM,
    FATORCONVERSAO,
    CODFAB,
    DESCONTDESEJ,
    PRECO_PROMOCAO,
    FATOR,
    TRAVA_FRACIONADO,
    QTDEMB)
AS
select
RIGHT('00000' || cast(PF.CODPRODFILHO as varchar(6)) ,6) as CODPRODFILHO,
cast(coalesce(PF.DT_CADAST,'01.01.2007') as timestamp),
PF.DESCRICAO,
RIGHT('00000' || cast(PD.CODGRUPO as varchar(6)) ,6) as CODGRUPO,
coalesce(PF.UNIDADE, UN.SIGLA),
PF.PROMOCAO,
case PD.ATIVO
when 1 then 'I'
when 2 then 'A'
end as ATIVO,
coalesce((select max(cast(DT_ATUALIZACAO as date)) from MODIFIPRECO WHERE CODPRODFILHO = PF.CODPRODFILHO),cast('01.01.06' as date)),
PF.PRECOPRATICADO1,
coalesce((select FIRST 1 ULTIMOPRECO from MODIFIPRECO WHERE CODPRODFILHO = PF.CODPRODFILHO order by DT_ATUALIZACAO DESC),1),
(PF.ESTQATUAL - coalesce(PF.ESTOQANALISE,0)),
(PF.PRECOPRATICADO1 / coalesce(nullif(PF.QTDEMBALAGEM,0),1)),
coalesce(nullif(PF.QTDEMBALAGEM,0),1),
coalesce(nullif(PF.FATORCONVERSAO,0),1),
right('00000' || cast(pd.codfabricante as varchar(6)) ,6) as CODFABRICANTE,
PF.descontdesej,
coalesce((
select first 1 PROMOCAOITEM.PRECOPRATICADO1
   from PROMOCAOITEM
   inner join PROMOCAO on PROMOCAO.CODPROMOCAO = PROMOCAOITEM.CODPROMOCAO_FK
   where PROMOCAOITEM.CODPRODFILHO_FK = PF.CODPRODFILHO
   order by PROMOCAOITEM.CODPROMOCAOITEM desc

),0),
coalesce((
select first 1 PROMOCAOITEM.FATOR1
   from PROMOCAOITEM
   inner join PROMOCAO on PROMOCAO.CODPROMOCAO = PROMOCAOITEM.CODPROMOCAO_FK
   where PROMOCAOITEM.CODPRODFILHO_FK = PF.CODPRODFILHO
   order by PROMOCAOITEM.CODPROMOCAOITEM desc

),0),
coalesce(pf.QTD_MULTIPLA,'N'),
coalesce(nullif(PF.QTDEMBALAGEM,0),1)
from
PRODFILHO PF
join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
join UNIDADE UN on (PF.CODUNIDADE = UN.CODUNIDADE)
where pd.ativo = 2
;



/* View: MSLCADPRO_OLD */
CREATE OR ALTER VIEW MSLCADPRO_OLD(
    CODPRO,
    DTCADPRO,
    DESCPRO,
    CODGRU,
    REF_FABR,
    PROMOCAO,
    PROATIINA,
    ULTREAVDA,
    PREVENDA,
    PRECOANT,
    SALDESTOQ,
    CODFABRICANTE)
AS
SELECT RIGHT('00000000' || CAST(PF.CODPESQ1 AS VARCHAR(6)) ,6) AS CODPRODFILHO,
       CAST(PF.DT_CADAST AS DATE),
       PF.DESCRICAO,
       RIGHT('00000000' || CAST(PD.CODGRUPO AS VARCHAR(6)) ,3) AS CODGRUPO,
       UN.SIGLA,
       PF.PROMOCAO,
       CASE PD.ATIVO
       WHEN 1 THEN 'I'
       WHEN 2 THEN 'A' END AS ATIVO,
       CAST('01.01.2006' AS DATE),
       PF.PRECOPRATICADO1,
       1,
       PF.ESTQATUAL,
       PD.CODFABRICANTE
       FROM PRODFILHO PF
       INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
       INNER JOIN UNIDADE UN ON (PF.CODUNIDADE = UN.CODUNIDADE)
;



/* View: MSTATUSPED */
CREATE OR ALTER VIEW MSTATUSPED(
    STATUSPED)
AS
select distinct
 ''''||STATUSPED||''''
from
PEDVEND
;



/* View: MTIPOSPESSOA */
CREATE OR ALTER VIEW MTIPOSPESSOA(
    TIPOPESSOA)
AS
select distinct
 '''' || PESSOA.TIPOPESSOA || ''''
from  
  PESSOA
;



/* View: NOF_NOTA_FISCAL */
CREATE OR ALTER VIEW NOF_NOTA_FISCAL(
    NOF_DESCRICAO,
    NOF_DT_NOTA,
    NOF_CD_NOTA_IMPORT,
    NOF_CD_MOVIMENTACAO_IMPORT,
    NOF_CD_EMP_DEST_IMPORT,
    NOF_CD_EMP_EMIS_IMPORT)
AS
SELECT
  'ARQUIVOS DE SAIDA   ' AS NOF_DESCRICAO,
  PEDVEND.DT_SAIDA AS NOF_DT_NOTA,
  CAST('S' || PEDVEND.CODPEDVEND AS VARCHAR(17)) AS NOF_CD_NOTA_IMPORT,
  'S' AS NOF_CD_MOVIMENTACAO_IMPORT,
  PEDVEND.CODPESSOA AS NOF_CD_EMP_DEST_IMPORT,
  (SELECT CODPESSOA FROM PESSOA WHERE CODSTATUS = 2)  AS NOF_CD_EMP_EMIS_IMPORT
FROM
 PEDVEND
UNION
SELECT
  'ARQUIVOS DE ENTRADA ' AS NOF_DESCRICAO,
  AJUSTESTOQ.DT_AJUST AS NOF_DT_NOTA,
  CAST('E' || AJUSTESTOQ.CODAJUSTESTOQ AS VARCHAR(17)) AS NOF_CD_NOTA_IMPORT,
  'E' AS NOF_CD_MOVIMENTACAO_IMPORT,
  AJUSTESTOQ.CODPESSOA AS NOF_CD_EMP_DEST_IMPORT,
 (SELECT CODPESSOA FROM PESSOA WHERE CODSTATUS = 2)  AS NOF_CD_EMP_EMIS_IMPORT
FROM
 AJUSTESTOQ
WHERE AJUSTESTOQ.TIPO = 'ENTRADA'
;



/* View: PAGARACUMULADO */
CREATE OR ALTER VIEW PAGARACUMULADO(
    DT_VENCIMENTO,
    VALOR_LIQ,
    CODSTATUS,
    TOTPAGO,
    CODCONTA)
AS
SELECT Conta.DT_VENCIM, Conta.VLPARCELA, PESSOA.CODSTATUS, Conta.TOTPAGO, Conta.CODCONTA
   FROM CONTA
   INNER JOIN PESSOA ON (CONTA.CODPESSOA = PESSOA.CODPESSOA)
   WHERE (Conta.TIPO = 'PAGAR')
   AND  (Conta.STATUS = 'ABERTO')
;



/* View: PEDIDOS_CANCELADOS */
CREATE OR ALTER VIEW PEDIDOS_CANCELADOS(
    NRFORMULARIO,
    MOTIVO1,
    MOTIVO2,
    CLIENTE,
    CODSET,
    CODCLI,
    DTCANCELA,
    VALOR_TOTAL,
    NUMERO_PEDIDO,
    TIPO)
AS
select
  PEDVEND.NRFORMULARIO,
  COALESCE(NFVENDA.OBSCANC1, PEDVEND.OBS1) AS OBS1,
  COALESCE(NFVENDA.OBSCANC2, PEDVEND.OBS2) AS OBS2,
  PESSOA.NOME,
  RIGHT('00000000' || cast(PEDVEND.CODVENDEDOR as varchar(6)), 4) AS CODVENDEDOR,
  RIGHT('00000000' || cast(PESSOA.CODPESSOA as varchar(6)), 6) AS CODPESSOA,
  PEDVEND.DTCANCELA,
  PEDVEND.VALOR_TOTAL,
  COALESCE(PEDVEND.CODNFVENDA, PEDVEND.CODPEDVEND) NRDOC,
  CASE COALESCE(PEDVEND.CODNFVENDA, 'P')
    WHEN 'P' THEN 'P'
    ELSE 'N' END AS TIPO
from
  PEDVEND
  join PESSOA on (PEDVEND.CODPESSOA = PESSOA.CODPESSOA)
  LEFT JOIN NFVENDA ON (PEDVEND.CODPEDVEND = NFVENDA.CODPEDVEND)
where
  STATUSPED = 'CANCELADO'
  and pedvend.dt_saida >= current_date - 30
;



/* View: PEDIDOS_FATURADOS_COM_CORTE */
CREATE OR ALTER VIEW PEDIDOS_FATURADOS_COM_CORTE(
    CODPEDVEND,
    NRFORMULARIO,
    CLIENTE,
    CODSET,
    CODCLI,
    CODPRODFILHO,
    DESCRICAO,
    QTDE,
    VALOR_TOTAL,
    NUMERO_PEDIDO,
    TIPO)
AS
select
  PEDVEND.CODPEDVEND,
  PEDVEND.NRFORMULARIO,
  PESSOA.NOME,
  RIGHT('00000000' || cast(PEDVEND.CODVENDEDOR as varchar(6)), 4) as CODVENDEDOR,
  RIGHT('00000000' || cast(PESSOA.CODPESSOA as varchar(6)), 6) as CODPESSOA,
  PRODFILHO.CODPRODFILHO,
  PRODFILHO.DESCRICAO,
  PEDVENDITEM_CORTADOS.QTDE,
  PEDVEND.VALOR_TOTAL,
  coalesce(PEDVEND.CODNFVENDA, PEDVEND.CODPEDVEND) NRDOC,
  case coalesce(PEDVEND.CODNFVENDA, 'P')
    when 'P' then 'P'
  else 'N' end as TIPO
from
  PEDVEND
  join PEDVENDITEM_CORTADOS on (PEDVEND.CODPEDVEND = PEDVENDITEM_CORTADOS.CODPEDVEND)
  join PRODFILHO on (PRODFILHO.CODPRODFILHO=PEDVENDITEM_CORTADOS.CODPRODFILHO)
  join PESSOA on (PEDVEND.CODPESSOA = PESSOA.CODPESSOA)
where
  STATUSPED = 'FATURADO'
  and PEDVEND.DT_SAIDA between current_date - 5 and current_date
;



/* View: PEDVENDVIEW */
CREATE OR ALTER VIEW PEDVENDVIEW(
    CODPEDVEND,
    CODNFVENDA,
    STATUSPED,
    TIPOPED,
    CODPESSOA,
    NOME,
    CODVENDEDOR,
    VENDEDOR,
    DT_SAIDA,
    VALOR_BRUTO,
    VALOR_TOTAL,
    NRFORMULARIO,
    CODEMBARQUE,
    PDV_NUMEROPEDCLI,
    FINANC,
    ACRESCIMO,
    ACRESVALOR,
    DESCONTO,
    DESC_VALOR,
    FRETE,
    MONTAGEM,
    PERC_FRETE,
    CODEMPRESA)
AS
select
  P.CODPEDVEND,
  coalesce(P.CODFATURAMENTO, P.CODNFVENDA) CODNFVENDA,
  case P.STATUSPED
    when 'NORMAL' then
      case P.PDV_CRITICA
        when 'C' then 'BLOQUEADO'
        when 'B' then 'NORMAL'
      else
        'LIBERADO'
      end
  else
    P.STATUSPED
  end STATUSPED,
  P.TIPOPED,
  P.CODPESSOA,
  PE.NOME,
  V.CODVENDEDOR,
  V.NOME,
  P.DT_SAIDA,
  P.valor_bruto ,
  P.VALOR_TOTAL,
  NRFORMULARIO,
  E.CODEMBARQUE_FK,
  P.PDV_NUMEROPEDCLI,
  coalesce(P.FINANC, 'N'),
  coalesce(P.ACRESCIMO, 0),
  coalesce(P.ACRESVALOR, 0),
  coalesce(P.DESCONTO, 0),
  coalesce(P.DESC_VALOR, 0),
  P.FRETE,
  P.MONTAGEM, 
  P.PERC_FRETE,
  P.CODEMPRESA
from
  PEDVEND P
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  left join EMBARQUEITEM E on P.CODPEDVEND = E.CODPEDVEND_FK
;



/* View: PEDVENDVIEWCAIXAOP_VIEW */
CREATE OR ALTER VIEW PEDVENDVIEWCAIXAOP_VIEW(
    CODPEDVEND,
    CODNFVENDA,
    STATUSPED,
    TIPOPED,
    CODPESSOA,
    NOME,
    CODVENDEDOR,
    VENDEDOR,
    DT_SAIDA,
    VALOR_BRUTO,
    VALOR_TOTAL,
    NRFORMULARIO,
    CODEMBARQUE,
    PDV_NUMEROPEDCLI,
    FINANC,
    ACRESCIMO,
    ACRESVALOR,
    DESCONTO,
    DESC_VALOR,
    FRETE,
    MONTAGEM,
    PERC_FRETE,
    CODEMPRESA)
AS
select
  P.CODPEDVEND,
  coalesce(P.CODFATURAMENTO, P.CODNFVENDA) CODNFVENDA,
  case P.STATUSPED
    when 'NORMAL' then
      case P.PDV_CRITICA
        when 'C' then 'BLOQUEADO'
        when 'B' then 'NORMAL'
      else
        'LIBERADO'
      end
  else
    P.STATUSPED
  end STATUSPED,
  P.TIPOPED,
  P.CODPESSOA,
  PE.NOME,
  V.CODVENDEDOR,
  V.NOME,
  P.DT_SAIDA,
  P.VALOR_BRUTO ,
  P.VALOR_TOTAL,
  NRFORMULARIO,
  E.CODEMBARQUE_FK,
  P.PDV_NUMEROPEDCLI,
  coalesce(P.FINANC, 'N'),
  coalesce(P.ACRESCIMO, 0),
  coalesce(P.ACRESVALOR, 0),
  coalesce(P.DESCONTO, 0),
  coalesce(P.DESC_VALOR, 0),
  P.FRETE,
  P.MONTAGEM, 
  P.PERC_FRETE,
  P.CODEMPRESA
from
  PEDVEND P
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  left join EMBARQUEITEM E on P.CODPEDVEND = E.CODPEDVEND_FK
  join TIPOVENDA on
    P.TIPOPED = TIPOVENDA.TIPOPED
    and coalesce(TIPOVENDA.EXIBIRCAIXAOP,'S') = 'S'
;



/* View: PESQ_CARACTER */
CREATE OR ALTER VIEW PESQ_CARACTER(
    DESCRICAO,
    CODCARACTER)
AS
select distinct '''' || DESCRICAO || '''',CODCARACTER from caracter
;



/* View: PESQ_CONTAS */
CREATE OR ALTER VIEW PESQ_CONTAS(
    CODNFVENDA,
    TIPO,
    NRDOCUMENTO,
    DT_EMISSAO,
    DT_VENCIM,
    VLPARCELA,
    CODPESSOA,
    NOME,
    NRFORMULARIO,
    CPFCGC,
    NUMERO,
    STATUS,
    CODPENDVEND,
    CODCONTA,
    NRDOCUMENTO_BOLETO,
    NRDOCUMENTO_DV)
AS
select
  coalesce(CONTA.CODNFVENDA,0) CODNFVENDA,
  CONTA.TIPO,
  CONTA.NRDOCUMENTO,
  CONTA.DT_EMISSAO,
  CONTA.DT_VENCIM,
  CONTA.VLPARCELA,
  CONTA.CODPESSOA,
  PESSOA.NOME,
  CONTA.NRFORMULARIO,
  PESSOA.CPFCGC,
  CONTA.NUMERO,
  CONTA.STATUS,
  CONTA.CODPENDVEND,
  CONTA.CODCONTA,
  CONTA.NRDOCUMENTO_BOLETO,
  CONTA.NRDOCUMENTO_DV
from
  CONTA
  inner join PESSOA on (CONTA.CODPESSOA = PESSOA.CODPESSOA)
;



/* View: PESQ_EMPRESTIMO */
CREATE OR ALTER VIEW PESQ_EMPRESTIMO(
    CODEMPRES,
    STATUS,
    TIPO,
    MOTIVO,
    PESSOA,
    DT_EMP,
    DT_DEV,
    NRDOCUMENTO,
    OBS1,
    OBS2,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    CODVENDEDOR,
    NOMEVENDEDOR,
    CODPESSOA,
    RAZAOSOCIAL,
    NOMEFANTAZIA,
    CODVEICULO,
    NOME_MOTORISTA,
    DESPESAS_VIAGEM,
    VLR_FRETE,
    OBS_1,
    OBS_2,
    CODPEDVEND)
AS
SELECT
   EMPRES.CODEMPRES,
   EMPRES.STATUS,
   EMPRES.TIPO,
   EMPRES.MOTIVO,
   EMPRES.PESSOA,
   EMPRES.DT_EMP,
   EMPRES.DT_DEV,
   EMPRES.NRDOCUMENTO,
   EMPRES.OBS1,
   EMPRES.OBS2,
   EMPRES.US_CADAST,
   EMPRES.DT_CADAST,
   EMPRES.US_MODIFI,
   EMPRES.DT_MODIFI,
   EMPRES.CODVENDEDOR,
   VENDEDOR.NOME NOMEVENDEDOR,
   EMPRES.CODPESSOA,
   PESSOA.NOME RAZAOSOCIAL,
   PESSOA.NOMEFANTAZIA,
   EMPRES.CODVEICULO,
   EMPRES.NOME_MOTORISTA,
   EMPRES.DESPESAS_VIAGEM,
   EMPRES.VLR_FRETE,
   EMPRES.OBS_1,
   EMPRES.OBS_2,
   EMPRES.CODPEDVEND
FROM
   EMPRES
   INNER JOIN PESSOA ON (EMPRES.CODPESSOA = PESSOA.CODPESSOA)
   INNER JOIN VENDEDOR ON (EMPRES.CODVENDEDOR = VENDEDOR.CODVENDEDOR)
;



/* View: PESQ_FUNCAO */
CREATE OR ALTER VIEW PESQ_FUNCAO(
    CODFUNCAO,
    NOME)
AS
select
  CODFUNCAO,
  NOME
from
  TBL_FUNCAO
;



/* View: PESQ_SETOR */
CREATE OR ALTER VIEW PESQ_SETOR(
    COD_SETOR,
    DESCRICAO,
    COD_GRUPO,
    GRUPO,
    QTD_FUNCIONARIO,
    OBS,
    SETOR_ENCERRAMENTO)
AS
select
  TBL_SETOR.COD_SETOR,
  TBL_SETOR.DESCRICAO,
  TBL_SETOR.COD_GRUPO,
  GRUPO.DESCRICAO GRUPO,
  TBL_SETOR.QTD_FUNCIONARIO,
  TBL_SETOR.OBS,
  TBL_SETOR.SETOR_ENCERRAMENTO
from
  TBL_SETOR
  join GRUPO on TBL_SETOR.COD_GRUPO = GRUPO.CODGRUPO
;



/* View: PESQ_FUNCIONARIO */
CREATE OR ALTER VIEW PESQ_FUNCIONARIO(
    FUNC_COD,
    NOME,
    COD_SETOR,
    SETOR,
    COD_GRUPO,
    GRUPO,
    CODFUNCAO,
    FUNCAO,
    ENDERECO,
    BAIRRO,
    CIDADE,
    UF,
    CEP,
    FONE,
    EMAIL,
    DATA_NASC)
AS
select
  FUNCIONARIO.FUNC_COD,
  FUNCIONARIO.NOME,
  FUNCIONARIO.COD_SETOR,
  PESQ_SETOR.DESCRICAO SETOR,
  PESQ_SETOR.COD_GRUPO,
  PESQ_SETOR.GRUPO,
  FUNCIONARIO.CODFUNCAO,
  TBL_FUNCAO.NOME FUNCAO,
  FUNCIONARIO.ENDERECO,
  FUNCIONARIO.BAIRRO,
  FUNCIONARIO.CIDADE,
  FUNCIONARIO.UF,
  FUNCIONARIO.CEP,
  FUNCIONARIO.FONE,
  FUNCIONARIO.EMAIL,
  FUNCIONARIO.DATA_NASC
from
  FUNCIONARIO
  join PESQ_SETOR on FUNCIONARIO.COD_SETOR = PESQ_SETOR.COD_SETOR
  join TBL_FUNCAO on  FUNCIONARIO.CODFUNCAO = TBL_FUNCAO.CODFUNCAO
;



/* View: PESQ_GRUPO */
CREATE OR ALTER VIEW PESQ_GRUPO(
    CODGRUPO,
    DESCRICAO)
AS
select
  G.CODGRUPO,
  G.DESCRICAO
from
  GRUPO G
;



/* View: PESQ_PEDCPR */
CREATE OR ALTER VIEW PESQ_PEDCPR(
    CODPEDCPR,
    STATUS,
    DT_EMISSAO,
    CODPESSOA,
    NOME,
    VALORITEM)
AS
SELECT
  PEDCPR.CODPEDCPR,
  PEDCPR.STATUS,
  PEDCPR.DT_EMISSAO,
  PEDCPR.CODPESSOA,
  PESSOA.NOME,
  SUM(PEDCPRITENS.VALORITEM) VALORITEM
FROM
  PEDCPR
  INNER JOIN PESSOA ON PESSOA.CODPESSOA = PEDCPR.CODPESSOA
  INNER JOIN PEDCPRITENS ON (PEDCPRITENS.CODPEDCPR = PEDCPR.CODPEDCPR)
WHERE
  PEDCPR.STATUS = 'NORMAL'
GROUP BY
  1,2,3,4,5
;



/* View: PESQ_PEDVEND */
CREATE OR ALTER VIEW PESQ_PEDVEND(
    CODPEDVEND,
    STATUSPED,
    TIPOPED,
    CODPESSOA,
    PESSOA,
    CODVENDEDOR,
    VENDEDOR,
    DT_SAIDA,
    VALOR_BRUTO,
    VALOR_TOTAL)
AS
select
  PEDVEND.CODPEDVEND,
  PEDVEND.STATUSPED,
  PEDVEND.TIPOPED,
  PEDVEND.CODPESSOA,
  PESSOA.NOME PESSOA,
  VENDEDOR.CODVENDEDOR,
  VENDEDOR.NOME VENDEDOR,
  PEDVEND.DT_SAIDA,
  PEDVEND.VALOR_BRUTO,
  PEDVEND.VALOR_TOTAL
from
  PEDVEND
  INNER JOIN PESSOA on(PEDVEND.CODPESSOA = PESSOA.CODPESSOA)
  INNER JOIN VENDEDOR on(PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR)
;



/* View: PESQ_SETORVINCULADO */
CREATE OR ALTER VIEW PESQ_SETORVINCULADO(
    COD_SETOR,
    SETOR,
    COD_VINCULADO,
    VINCULADO,
    QTD_FUNCIONARIO)
AS
select
  TSV.COD_SETOR,
  TSVS.DESCRICAO,
  TS.COD_SETOR,
  TS.DESCRICAO,
  TS.QTD_FUNCIONARIO
from
  TBL_SETOR TS
  join TBL_SETOR_VINCULO TSV on TS.COD_SETOR = TSV.COD_SETOR_VINCULO
  join TBL_SETOR TSVS on TSV.COD_SETOR = TSVS.COD_SETOR
;



/* View: PESQ_SUBSETOR */
CREATE OR ALTER VIEW PESQ_SUBSETOR(
    COD_SUB_SETOR,
    DESCRICAO,
    QTD_FUNCIONARIO,
    OBS)
AS
select
  TBL_SUB_SETOR.COD_SUB_SETOR,
  TBL_SUB_SETOR.DESCRICAO,
  TBL_SUB_SETOR.QTD_FUNCIONARIO,
  TBL_SUB_SETOR.OBS
from
  TBL_SUB_SETOR
;



/* View: PESQ_TIPOMAQUINA */
CREATE OR ALTER VIEW PESQ_TIPOMAQUINA(
    CODMAQUINA,
    DESCRICAO,
    EFICIENCIA,
    REFERENCIA)
AS
select
  CODMAQUINA,
  DESCRICAO,
  EFICIENCIA,
  REFERENCIA
from
  TBL_TIPOMAQUINA
;



/* View: PESQ_UNIDADE */
CREATE OR ALTER VIEW PESQ_UNIDADE(
    CODUNIDADE,
    SIGLA,
    DESCRICAO)
AS
select
  CODUNIDADE,
  SIGLA,
  DESCRICAO
from
  UNIDADE
;



/* View: PESQCUPOM */
CREATE OR ALTER VIEW PESQCUPOM(
    CODCUPOM,
    CUPOM,
    EMISSAO,
    ACRESVALOR,
    DESC_VALOR,
    VALOR_TOTAL,
    VALOR_LIQUIDO)
AS
select
  CODCUPOM,
  (cast(coalesce(nullif(ECF,''),0) as integer)||'-'||cast(coalesce(nullif(COO,''),0) as integer)) CUPOM,
  EMISSAO,
  coalesce(ACRESVALOR,0),
  coalesce(DESC_VALOR,0),
  VALOR_TOTAL,
  (VALOR_TOTAL + coalesce(ACRESVALOR,0) - coalesce(DESC_VALOR,0))
from
  CUPOM
where
  CODNFVENDA is null and STATUSCUPOM = 0 and
  CODEMPRESA = (select
                  E.CODEMPRESA
                from
                  EMPRESA E
                  join SYSPARAMS S on E.CGC = S.CGC)
;



/* View: PESSOA_ARQUITETO */
CREATE OR ALTER VIEW PESSOA_ARQUITETO(
    CODPESSOA,
    PESSOA,
    CPFCGC,
    CODSTATUS,
    NOME,
    COMISVENDEDOR,
    RG,
    DT_NASC,
    SEXO,
    FONES,
    CELULAR,
    EMAIL,
    HOMEPAGE,
    PAI,
    MAE,
    LOGRADOURO_1,
    COMPLEMENTO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    LOGRADOURO_2,
    COMPLEMENTO_2,
    BAIRRO_2,
    CIDADE_2,
    UF_2,
    CEP_2,
    US_CADAST,
    US_MODIFI,
    DT_CADAST,
    DT_MODIFI,
    TIPOPESSOA,
    ATIVO,
    ROTEIROENTREGA,
    CODTIPOPAG,
    BANCO,
    AGENCIA,
    CONTA,
    TIPOCONTA,
    TIP_TIPO)
AS
select
  CODPESSOA,
  PESSOA,
  CPFCGC,
  CODSTATUS,
  NOME,
  COMISVENDEDOR,
  RG,
  DT_NASC,
  SEXO,
  FONES,
  CELULAR,
  EMAIL,
  HOMEPAGE,
  PAI,
  MAE,
  LOGRADOURO_1,
  COMPLEMENTO_1,
  BAIRRO_1,
  CIDADE_1,
  UF_1,
  CEP_1,
  LOGRADOURO_2,
  COMPLEMENTO_2,
  BAIRRO_2,
  CIDADE_2,
  UF_2,
  CEP_2,
  US_CADAST,
  US_MODIFI,
  DT_CADAST,
  DT_MODIFI,
  TIPOPESSOA,
  ATIVO,
  ROTEIROENTREGA,
  CODTIPOPAG,
  BANCO,
  AGENCIA,
  CONTA,
  TIPOCONTA,
  TIP_TIPO
from
  PESSOA
where
  TIPOPESSOA = 'Arquiteto'
;



/* View: PESSOA_STATUS */
CREATE OR ALTER VIEW PESSOA_STATUS(
    CODSTATUS,
    DESCRICAO)
AS
select distinct pessoa.CODSTATUS, STATUS.DESCRICAO from PESSOA
inner join STATUS on (PESSOA.CODSTATUS = STATUS.CODSTATUS)
;



/* View: PESSOA_VENDEDORAGENDAPALM */
CREATE OR ALTER VIEW PESSOA_VENDEDORAGENDAPALM(
    CODPESSOA,
    CODVENDEDOR,
    DTPREVISTO)
AS
select
  P.CODPESSOA,
  V.CODVENDEDOR,
  PVA.DTPREVISTO
from
  PESSOA_VENDEDORAGENDA PVA
  join PESSOA_VENDEDOR PV on PVA.CODPESSOA_VENDEDOR = PV.CODPESSOA_VENDEDOR
  join VENDEDOR V on V.CODVENDEDOR = PV.CODVENDEDOR
  join PESSOA P on PV.CODPESSOA = P.CODPESSOA
where
  PVA.STATUS = 'A VISITAR'
;



/* View: PESSOAVIEW */
CREATE OR ALTER VIEW PESSOAVIEW(
    CODPESSOA,
    NOME,
    CPFCGC,
    UF_1)
AS
SELECT Pessoa.codpessoa, pessoa.nome, PESSOA.CPFCGC,PESSOA.UF_1
FROM PESSOA
;



/* View: PRECO */
CREATE OR ALTER VIEW PRECO(
    CODPRODFILHO,
    PRECOPRATICADO1,
    PRECOPRATICADO2,
    PRECOPRATICADO3,
    PRECOPRATICADO4,
    PRECOPRATICADO5,
    PRECOPRATICADO6)
AS
select
  CODPRODFILHO, PRECOPRATICADO1, PRECOPRATICADO2, PRECOPRATICADO3, PRECOPRATICADO4, PRECOPRATICADO5, PRECOPRATICADO6
from
  PRODFILHO
    INNER JOIN PRODUTO ON (PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO)
where PRODUTO.ATIVO = 2
;



/* View: PRO_PRODUTO */
CREATE OR ALTER VIEW PRO_PRODUTO(
    DESCRICAO,
    FATORCONVERSAO,
    PRECOPRATICADO1,
    CODPESQ1,
    CODPRODFILHO)
AS
SELECT
  PRODFILHO.DESCRICAO AS PRO_DESCRICAO,
  PRODFILHO.FATORCONVERSAO AS PRO_VALOR_FACE,
  PRODFILHO.PRECOPRATICADO1 AS PRO_VALOR_VENDA,
  PRODFILHO.CODPESQ1 AS PRO_CD_PROD_TIM,
  PRODFILHO.CODPRODFILHO AS PRO_CD_PROD_DIS
FROM
 PRODUTO
 INNER JOIN PRODFILHO ON (PRODUTO.CODPRODUTO=PRODFILHO.CODPRODUTO)
WHERE
  (PRODUTO.CODGRUPO = 3)
;



/* View: PRODFILHOVIEW */
CREATE OR ALTER VIEW PRODFILHOVIEW(
    CODPRODFILHO,
    DESCRICAO,
    ESTQATUAL,
    PRECOPRATICADO1)
AS
SELECT PRODFILHO.CODPRODFILHO, PRODFILHO.DESCRICAO, PRODFILHO.ESTQATUAL, PRODFILHO.PRECOPRATICADO1
FROM PRODFILHO
;



/* View: PRODFILHOVIEW_GRADE */
CREATE OR ALTER VIEW PRODFILHOVIEW_GRADE(
    CODPRODFILHO,
    CODPESQ2,
    CODPESQ3,
    DESCRICAO)
AS
SELECT
   PRODFILHO.CODPRODFILHO,PRODFILHO.CODPESQ2,PRODFILHO.CODPESQ3,PRODFILHO.DESCRICAO
FROM PRODFILHO
;



/* View: PRODUTOS_CODPESQ1 */
CREATE OR ALTER VIEW PRODUTOS_CODPESQ1(
    CODPESQ1,
    DESCRICAO)
AS
select '''' || CODPESQ1 || '''', DESCRICAO from PRODFILHO
;



/* View: RECEBEABERTO */
CREATE OR ALTER VIEW RECEBEABERTO(
    DT_EMISSAO,
    NRDOCUMENTO,
    PARCELA,
    DT_VENCIMENTO,
    VALOR_PARC,
    NOME,
    TIPOPAG,
    CARTAOCRED,
    DESCRICAO,
    CODSTATUS,
    TOTPAGO,
    NUMERO,
    CODPESSOA,
    CODCONTA,
    CART_VALOR,
    FONES,
    CONT_CUSTAS,
    CODNFVENDA,
    OBSERVACOES,
    NOMEFANTAZIA,
    CODVENDEDOR,
    UF,
    TOTJUROS,
    TOTDESCONTO,
    STATUS,
    CODEMPRESA)
AS
select
  CONTA.DT_EMISSAO,
  CONTA.NRDOCUMENTO,
  CONTA.PARCELA,
  CONTA.DT_VENCIM,
  CONTA.VLPARCELA,
  PESSOA.NOME,
  CONTA.PREV_TIPOPAG as TIPOPAG,
  CARTAOCRED.DESCRICAO as CARTAOCRED,
  CONTA.DESCRICAO,
  PESSOA.CODSTATUS,
  coalesce(CONTA.TOTPAGO,0),
  CONTA.NUMERO,
  CONTA.CODPESSOA,
  CONTA.CODCONTA,
  CONTA.CART_VALOR,
  PESSOA.FONES,
  CONTA.CONT_CUSTAS,
  CONTA.CODNFVENDA,
  coalesce(coalesce(Conta.OBS1,'') || ' ' || coalesce(Conta.OBS2,''), '') as OBSERVACOES,
  PESSOA.NOMEFANTAZIA,
  CONTA.CODVENDEDOR,
  PESSOA.UF_1,
  coalesce(CONTA.TOTJUROS,0),
  coalesce(CONTA.TOTDESCONTO,0),
  CONTA.STATUS,
  CONTA.CODEMPRESA
from
  CONTA
  left join PESSOA on
    CONTA.CODPESSOA = PESSOA.CODPESSOA
  left join CARTAOCRED on
    CARTAOCRED.CODCARTAOCRED = CONTA.CODCARTAO
where
   CONTA.TIPO   = 'RECEBER' and
   CONTA.STATUS = 'ABERTO'
;



/* View: RECEBIQUITADO */
CREATE OR ALTER VIEW RECEBIQUITADO(
    DT_EMISSAO,
    NRDOCUMENTO,
    PARCELA,
    DT_VENCIMENTO,
    VALOR_PARC,
    NOME,
    TIPOPAG,
    CARTAOCRED,
    DESCRICAO,
    CODSTATUS,
    TOTPAGO,
    NUMERO,
    CODPESSOA,
    CODCONTA,
    CART_VALOR,
    FONES,
    CONT_CUSTAS,
    CODNFVENDA,
    OBSERVACOES,
    NOMEFANTAZIA,
    CODVENDEDOR,
    UF,
    TOTJUROS,
    TOTDESCONTO,
    STATUS,
    CODEMPRESA)
AS
select
  CONTA.DT_EMISSAO,
  CONTA.NRDOCUMENTO,
  CONTA.PARCELA,
  CONTA.DT_VENCIM,
  CONTA.VLPARCELA,
  PESSOA.NOME,
  CONTA.PREV_TIPOPAG as TIPOPAG,
  CARTAOCRED.DESCRICAO as CARTAOCRED,
  CONTA.DESCRICAO,
  PESSOA.CODSTATUS,
  CONTA.TOTPAGO,
  CONTA.NUMERO,
  CONTA.CODPESSOA,
  CONTA.CODCONTA,
  CONTA.CART_VALOR,
  PESSOA.FONES,
  CONTA.CONT_CUSTAS,
  CONTA.CODNFVENDA,
  coalesce(coalesce(Conta.OBS1,'') || ' ' || coalesce(Conta.OBS2,''), '') as OBSERVACOES,
  PESSOA.NOMEFANTAZIA,
  CONTA.CODVENDEDOR,
  PESSOA.UF_1,
  coalesce(CONTA.TOTJUROS,0),
  coalesce(CONTA.TOTDESCONTO,0),
  CONTA.STATUS,
  CONTA.CODEMPRESA
from
  CONTA
  left join PESSOA on
    CONTA.CODPESSOA = PESSOA.CODPESSOA
  left join CARTAOCRED on
    CARTAOCRED.CODCARTAOCRED = CONTA.CODCARTAO
where
  CONTA.TIPO   = 'PAGAR' and
  CONTA.STATUS = 'ABERTO'
;



/* View: SEP_SEGMENTACAO_PDV */
CREATE OR ALTER VIEW SEP_SEGMENTACAO_PDV(
    SEP_CD_SEGMENTACAO_PDV,
    SEP_CD_SEGMENTACAO_TIM,
    SEP_DESCRICAO)
AS
SELECT 
  TBL_RAMOATVTIPO.CODTIPO AS SEP_CD_SEGMENTACAO_PDV,
  TBL_RAMOATVTIPO.REFERENCIA AS SEP_CD_SEGMENTACAO_TIM,
  TBL_RAMOATVTIPO.DESCRICAO AS SEP_DESCRICAO
FROM
 TBL_RAMOATVTIPO
 INNER JOIN TBL_RAMOATV ON (TBL_RAMOATVTIPO.CODATIVIDADE=TBL_RAMOATV.CODATIVIDADE)
 INNER JOIN TBL_RAMO ON (TBL_RAMOATV.CODRAMO=TBL_RAMO.CODRAMO)
;



/* View: SERIES */
CREATE OR ALTER VIEW SERIES(
    SERIE)
AS
select
  '''' || SERIE || ''''
from
  SERIE
order by
  SERIE
;



/* View: SFRCAIXA */
CREATE OR ALTER VIEW SFRCAIXA(
    CODUSERCAD,
    IDLOGIN)
AS
select distinct
  U.CODUSERCAD,
  U.IDLOGIN
from
  CUPOM C
  join USERCAD U on
    C.US_CADAST = U.IDLOGIN
;



/* View: SFRCARTACREDITO */
CREATE OR ALTER VIEW SFRCARTACREDITO(
    CODCARTAOCRED,
    DESCRICAO)
AS
select
  C.CODCARTAOCRED,
  C.DESCRICAO
from
  CARTAOCRED C
;



/* View: SFRFILIAL */
CREATE OR ALTER VIEW SFRFILIAL(
    CODEMPRESA,
    RAZAOSOCIAL)
AS
select
  E.CODEMPRESA,
  substring(E.RAZAOSOCIAL from 1 for 50) RAZAOSOCIAL
from
  EMPRESA E
;



/* View: SFRFORMAPAGAMENTO */
CREATE OR ALTER VIEW SFRFORMAPAGAMENTO(
    CODTIPOPAG,
    DESCRICAO)
AS
select
  T.CODTIPOPAG,
  T.DESCRICAO
from
  TIPOPAG T
;



/* View: SFRGRUPO */
CREATE OR ALTER VIEW SFRGRUPO(
    CODGRUPO,
    DESCRICAO)
AS
select distinct
  G.CODGRUPO,
  substring(G.DESCRICAO from 1 for 50)
from
  GRUPO G
  join PRODUTO P on G.CODGRUPO = P.CODGRUPO
;



/* View: SFRVENDA */
CREATE OR ALTER VIEW SFRVENDA(
    CODCUPOM,
    CPFCGC,
    CODGRUPO,
    QTDE,
    PRECOVEND,
    EMISSAO,
    CODEMPRESA,
    CODUSERCAD)
AS
select
  C.CODCUPOM,
  C.CPFCGC,
  PR.CODGRUPO,
  CI.QTDE,
  CI.PRECOVEND,
  cast(C.EMISSAO as date),
  C.CODEMPRESA,
  (select first 1 U.CODUSERCAD from USERCAD U where U.IDLOGIN = C.US_CADAST)
from
  CUPOM C
  join CUPOMITEM CI on
    C.CODCUPOM = CI.CODCUPOM
  join PRODFILHO P on
    CI.CODPRODFILHO = P.CODPRODFILHO
  join PRODUTO PR on
    P.CODPRODUTO = PR.CODPRODUTO
where
  (C.CPFCGC is not null or C.CARTAO is not null) and
  C.STATUSCUPOM = 0
;



/* View: SFRVENDAFP */
CREATE OR ALTER VIEW SFRVENDAFP(
    CODCUPOM,
    CODTIPOPAG,
    CODCARTAOCRED,
    VALOR)
AS
select
  C.CODCUPOM,
  CI.CODTIPOPAG,
  CC.CODCARTAOCRED,
  CI.VALOR
from
  CUPOM C
  join CUPOMPAG CI on
    C.CODCUPOM = CI.CODCUPOM
  left join CARTAOCRED CC on
    CI.CODCARTAOCRED = CC.CODCARTAOCRED
where
  (C.CPFCGC is not null or C.CARTAO is not null) and
  C.STATUSCUPOM = 0
;



/* View: SISPED_PLU */
CREATE OR ALTER VIEW SISPED_PLU(
    CODPLU,
    STATUS,
    TIPO,
    DATAVALIDADE,
    ATUALIZADOPOR,
    ATUALIZADOEM,
    DT_CADAST,
    US_CADAST,
    DT_MODIFI,
    US_MODIFI,
    TIPOPRECO,
    CODEMPRESA,
    STATUSENVIO)
AS
select CODPLU, 
       STATUS, 
       TIPO, 
       DATAVALIDADE, 
       ATUALIZADOPOR, 
       ATUALIZADOEM, 
       DT_CADAST, 
       US_CADAST, 
       DT_MODIFI, 
       US_MODIFI, 
       TIPOPRECO, 
       CODEMPRESA, 
       STATUSENVIO
from PLU
where
  PLU.DT_CADAST >= current_date -1
;



/* View: SISPED_PLUITEM */
CREATE OR ALTER VIEW SISPED_PLUITEM(
    CODPLUITEM,
    CODPLU,
    CODPRODFILHO,
    CODPESQUISA,
    PRECOATUAL1,
    PRECOATUAL2,
    PRECOATUAL3,
    PRECOATUAL4,
    PRECOATUAL5,
    PRECOATUAL6,
    DT_CADAST,
    US_CADAST,
    DT_MODIFI,
    US_MODIFI,
    DATACOMPRA,
    PRECONOVO,
    DTATUALIZACAO,
    ATUALIZADOEM,
    CODEMPRESA)
AS
select
       PLUITEM.CODPLUITEM,
       PLUITEM.CODPLU,
       PLUITEM.CODPRODFILHO,
       PLUITEM.CODPESQUISA,
       PLUITEM.PRECOATUAL1,
       PLUITEM.PRECOATUAL2,
       PLUITEM.PRECOATUAL3,
       PLUITEM.PRECOATUAL4,
       PLUITEM.PRECOATUAL5,
       PLUITEM.PRECOATUAL6,
       PLUITEM.DT_CADAST,
       PLUITEM.US_CADAST,
       PLUITEM.DT_MODIFI,
       PLUITEM.US_MODIFI,
       PLUITEM.DATACOMPRA,
       PLUITEM.PRECONOVO,
       PLUITEM.DTATUALIZACAO,
       PLU.ATUALIZADOEM,
       PLU.CODEMPRESA
 from PLUITEM inner join PLU ON(PLUITEM.CODPLU = PLU.CODPLU ) and PLU.DT_CADAST >= current_date -1
;



/* View: SISPED_PRODUTO_PLU */
CREATE OR ALTER VIEW SISPED_PRODUTO_PLU(
    CODPRODFILHO,
    DESCRICAO,
    LOCALIZACAO,
    TRIBUTADO,
    ALIQUOTAICMS,
    PRECOPRATICADO1,
    PRECOPRATICADO2,
    PRECOPRATICADO3,
    PRECOPRATICADO4,
    PRECOPRATICADO5,
    PRECOPRATICADO6,
    PRECOPROMOCAO,
    CODPESQ1,
    CODPESQ2,
    CODPESQ3,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    DATAPROMOCAO,
    CODPLU,
    ATUALIZADOEM,
    CODUNIDADE,
    ATIVAQTDEMAXIMA,
    QTDEMAXIMA,
    ATIVABALANCA,
    ESTOQUE,
    DATAESTOQUE,
    IMP_CODIGO,
    FABRICANTE,
    GRUPO,
    DESCONTFLAG,
    DESCONTDESEJ,
    NCM_CODIGO,
    PRDF_CST_ORIGEM_MERCADORIA,
    PRDF_CST_TRIBICMS,
    PERC_COFINS,
    PERC_PIS,
    CSTPIS,
    CODCFOPVENDADENTRO)
AS
select
  PR.CODPRODFILHO,
  PR.DESCRICAO,
  PR.LOCALIZACAO,
  PR.TRIBUTADO,
  PR.ALIQUOTAICMS,
  coalesce(PR.PRECOPRATICADO1,0) PRECOPRATICADO1,
  coalesce(PR.PRECOPRATICADO2,0) PRECOPRATICADO2,
  coalesce(PR.PRECOPRATICADO3,0) PRECOPRATICADO3,
  coalesce(PR.PRECOPRATICADO4,0) PRECOPRATICADO4,
  coalesce(PR.PRECOPRATICADO5,0) PRECOPRATICADO5,
  coalesce(PR.PRECOPRATICADO6,0) PRECOPRATICADO6,
  0 PRECOPROMOCAO,
  PR.CODPESQ1,
  PR.CODPESQ2,
  PR.CODPESQ3,
  PR.US_CADAST,
  PR.DT_CADAST,
  PR.US_MODIFI,
  PR.DT_MODIFI,
  PR.DATAPROMOCAO,
  pi.CODPLU,
  PL.ATUALIZADOEM,
  PR.CODUNIDADE,
  coalesce(ATIVAQTDEMAXIMA,'F') ATIVAQTDEMAXIMA,
  coalesce(QTDEMAXIMA,0) QTDEMAXIMA,
  coalesce(ATIVABALANCA,'N') ATIVABALANCA,
  coalesce(PR.ESTQATUAL,0) ESTQATUAL,
  PR.DATAESTOQ DATAESTOQUE,
  -1 IMP_CODIGO,
  coalesce((
   select pessoa.nome from PESSOA where PESSOA.codpessoa = PD.codfabricante
  ),'') FABRICANTE,
  coalesce((
   select GRUPO.descricao from GRUPO where GRUPO.codgrupo = PD.codgrupo
  ),'') GRUPO,
  PR.DESCONTFLAG,
  PR.DESCONTDESEJ,
  PR.CLASSFISCAL,
  PRDF_CST_ORIGEM_MERCADORIA,
  PRDF_CST_TRIBICMS,
  PERC_COFINS,
  PERC_PIS,
  CSTPIS,
  CODCFOPVENDADENTRO
from
  PRODFILHO PR
  inner join PLUITEM pi on (pi.CODPRODFILHO = PR.CODPRODFILHO)
  inner join PLU PL on (PL.CODPLU = pi.CODPLU)
  inner join PRODUTO PD on (PD.CODPRODUTO = PR.CODPRODUTO)
where
  PL.STATUS = 'ATUALIZADO'
;



/* View: SISPED_PRODUTOCODBARRA_PLU */
CREATE OR ALTER VIEW SISPED_PRODUTOCODBARRA_PLU(
    CODPRODFILHOCODBARRA,
    CODPRODFILHO,
    CODBARRA,
    DT_CADAST,
    US_CADAST,
    DT_MODIFI,
    US_MODIFI,
    ATUALIZADOEM,
    CODUNIDADE,
    QTDEMBALAGEM,
    PRECOPRATICADO)
AS
select
  PC.CODPRODFILHOCODBARRA,
  PC.CODPRODFILHO,
  PC.CODBARRA,
  PC.DT_CADAST,
  PC.US_CADAST,
  PC.DT_MODIFI,
  PC.US_MODIFI,
  PL.ATUALIZADOEM,
  PC.CODUNIDADE,
  PC.QTDEMBALAGEM,
  PC.PRECOPRATICADO1
from
  PRODFILHOCODBARRA PC
  inner join PRODFILHO PR on (PR.CODPRODFILHO = PC.CODPRODFILHO)
  inner join PLUITEM PI on (PI.CODPRODFILHO = PR.CODPRODFILHO)
  inner join PLU PL on (PL.CODPLU = PI.CODPLU)
where
  PL.STATUS = 'ATUALIZADO'
;



/* View: SISPED_PRODUTOCOMBINADO_PLU */
CREATE OR ALTER VIEW SISPED_PRODUTOCOMBINADO_PLU(
    CODNV,
    CODPRO,
    QTD,
    VLRUN,
    CODPRODCOMBINADO,
    CODPESQUISA,
    ATUALIZADOEM)
AS
select
  PC.CODNV,
  PC.CODPRO,
  PC.QTD,
  PC.VLRUN,
  PC.CODPRODCOMBINADO,
  PC.CODPESQUISA,
  P.ATUALIZADOEM
from
  PRODCOMBINADOS PC
  join PRODFILHO PF on
    PC.CODNV = PF.CODPRODFILHO
  join PLUITEM PI on
    PI.CODPRODFILHO = PF.CODPRODFILHO
  join PLU P on
    PI.CODPLU = P.CODPLU
where
  P.STATUS = 'ATUALIZADO'
;



/* View: SISPED_SEF */
CREATE OR ALTER VIEW SISPED_SEF(
    CODIGO,
    CONT_NOME,
    CONT_CPF,
    CONT_CRC,
    CONT_FONE1,
    CONT_FONE2,
    CONT_FAX,
    CONT_CXPOSTAL,
    CONT_EMAIL,
    CONT_CODIBGE)
AS
select
  CODIGO,
  CONT_NOME,
  CONT_CPF, 
  CONT_CRC, 
  CONT_FONE1, 
  CONT_FONE2, 
  CONT_FAX, 
  CONT_CXPOSTAL, 
  CONT_EMAIL, 
  CONT_CODIBGE
from
  SEF
;



/* View: SISPED_TIPOPAG */
CREATE OR ALTER VIEW SISPED_TIPOPAG(
    CODTIPOPAG,
    DESCRICAO,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    EXIBEECF,
    DESCRICAOECF,
    TEF,
    TIP_TIPO,
    ATUALIZADOEM,
    NRPRESTACAO,
    NRDIASPRIMEIRA,
    NRDIAS,
    FATOR)
AS
select
  CODTIPOPAG,
  DESCRICAO,
  US_CADAST,
  DT_CADAST,
  US_MODIFI,
  DT_MODIFI,
  EXIBEECF,
  DESCRICAOECF,
  TEF,
  TIP_TIPO,
  coalesce(DT_MODIFI,DT_CADAST) ATUALIZADOEM,
  NRPRESTACAO,
  NRDIASPRIMEIRA,
  NRDIAS,
  FATOR
from
  TIPOPAG
;



/* View: SISPED_UNIDADE */
CREATE OR ALTER VIEW SISPED_UNIDADE(
    CODUNIDADE,
    SIGLA,
    DESCRICAO,
    TRAVA_FRACIONADO,
    DT_CADAST,
    DT_MODIFI,
    ATUALIZAR,
    ATUALIZADOEM)
AS
select
  CODUNIDADE,
  SIGLA,
  DESCRICAO,
  TRAVA_FRACIONADO,
  DT_CADAST,
  DT_MODIFI,
  ATUALIZAR,
  coalesce(DT_MODIFI,DT_CADAST) ATUALIZADOEM
from
  UNIDADE
;



/* View: SISPED_VENDACASADA */
CREATE OR ALTER VIEW SISPED_VENDACASADA(
    CODVENDACASADAITEM,
    CODVENDACASADA,
    VALIDADE,
    CODPRODFILHO,
    QTD,
    VALOR)
AS
select
  I.CODVENDACASADAITEM,
  V.CODVENDACASADA,
  V.VALIDADE,
  I.CODPRODFILHO,
  I.QTD,
  I.VALOR
from
  VENDACASADA V
  join VENDACASADAITEM I on
    V.CODVENDACASADA = I.CODVENDACASADA
;



/* View: SLCADAGENDAMENTO */
CREATE OR ALTER VIEW SLCADAGENDAMENTO(
    CODPESSOA_VENDEDORAGENDA,
    CODPESSOA_VENDEDOR,
    CODPEDVEND,
    DTPREVISTO,
    DTREALIZADO,
    OBS,
    STATUS,
    DT_CADAST,
    US_CADAST,
    DT_MODIFI,
    US_MODIFI,
    ORDEMVISITA,
    CODPESSOA,
    CODVENDEDOR)
AS
select  PVA.CODPESSOA_VENDEDORAGENDA,
        PVA.CODPESSOA_VENDEDOR,
        PVA.CODPEDVEND,
        PVA.DTPREVISTO,
        PVA.DTREALIZADO,
        PVA.OBS,
        PVA.STATUS,
        PVA.DT_CADAST,
        PVA.US_CADAST,
        PVA.DT_MODIFI,
        PVA.US_MODIFI,
        ORDEMVISITA,
        RIGHT('00000000' || cast(PE.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
        RIGHT('00000000' || cast(VE.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR
from PESSOA_VENDEDORAGENDA PVA
inner join PESSOA_VENDEDOR PV on (PVA.CODPESSOA_VENDEDOR = PV.CODPESSOA_VENDEDOR)
inner join PESSOA PE on (PE.CODPESSOA = PV.CODPESSOA)
inner join VENDEDOR VE on (VE.CODVENDEDOR = PV.CODVENDEDOR)
where PVA.DTPREVISTO >= cast('NOW' as date)
;



/* View: SLCADCLI */
CREATE OR ALTER VIEW SLCADCLI(
    CODCLI,
    TIPOCLI,
    DTCADCLI,
    RAZSOCCLI,
    ENDCLI,
    CIDCLI,
    BAIRCLI,
    CEPCLI,
    ESTCLI,
    FAXCLI,
    TELCLI,
    CGCCLI,
    INSCESCLI,
    CODSET,
    CODSE1,
    CODSE2,
    BLOQCRED,
    SALDEVCLI,
    ULTCOMPRA,
    CODPRAZO,
    PRAZO,
    FORMAPAGTO,
    ATIVO,
    TIPOPED)
AS
select
  RIGHT('00000000' || cast(P.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
  '',
  P.DT_CADAST,
  P.NOME,
  P.LOGRADOURO_1,
  P.CIDADE_1,
  P.BAIRRO_1,
  P.CEP_1,
  P.UF_1,
  P.FAX,
  P.FONES,
  P.CPFCGC,
  P.IE,
  RIGHT('00000000' || cast((select first 1 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 1 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 2 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  'L',
  CAST((SELECT SUM(COALESCE(VLPARCELA,0) - COALESCE(TOTPAGO,0)) FROM CONTA WHERE (CONTA.TIPO = 'RECEBER') and (CONTA.STATUS = 'ABERTO') AND (CONTA.CODPESSOA = P.CODPESSOA)) AS double precision),
  (select first 1 DT_EMISSAO from NFVENDA where NFVENDA.CODPESSOA = P.CODPESSOA order by DT_EMISSAO desc),
  CODTIPOPAG1,
  TP.DESCRICAO,
  SP.CODIGO,
  case P.ATIVO
  when 1 then 'I'
  when 2 then 'A'
  END,
  COALESCE(P.tipoped,'VENDA')
from
  PESSOA P
  left join TIPOPAG TP on P.CODTIPOPAG1 = TP.CODTIPOPAG
  left join SLPAGTO SP on P.TIP_TIPO = SP.TIPOPAG
;



/* View: SLCADCLI_1 */
CREATE OR ALTER VIEW SLCADCLI_1(
    CODCLI,
    TIPOCLI,
    DTCADCLI,
    RAZSOCCLI,
    ENDCLI,
    CIDCLI,
    BAIRCLI,
    CEPCLI,
    ESTCLI,
    FAXCLI,
    TELCLI,
    CGCCLI,
    INSCESCLI,
    CODSET,
    CODSE1,
    CODSE2,
    CODSE3,
    CODSE4,
    CODSE5,
    BLOQCRED,
    SALDEVCLI,
    ULTCOMPRA,
    CODPRAZO,
    PRAZO,
    FORMAPAGTO,
    ATIVO,
    TIPOPED)
AS
select
  RIGHT('00000000' || cast(P.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
  '',
  P.DT_CADAST,
  P.NOME,
  P.LOGRADOURO_1,
  P.CIDADE_1,
  P.BAIRRO_1,
  P.CEP_1,
  P.UF_1,
  P.FAX,
  P.FONES,
  P.CPFCGC,
  P.IE,
  RIGHT('00000000' || cast((select first 1 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 1 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 2 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 3 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 4 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 5 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  'L',
  0.00,
  --CAST((SELECT SUM(COALESCE(VLPARCELA,0) - COALESCE(TOTPAGO,0)) FROM CONTA WHERE (CONTA.TIPO = 'RECEBER') and (CONTA.STATUS = 'ABERTO') AND (CONTA.CODPESSOA = P.CODPESSOA)) AS double precision),
  (select first 1 DT_EMISSAO from NFVENDA where NFVENDA.CODPESSOA = P.CODPESSOA order by DT_EMISSAO desc),
  CODTIPOPAG1,
  TP.DESCRICAO,
  SP.CODIGO,
  case P.ATIVO
  when 1 then 'I'
  when 2 then 'A'
  END,
  COALESCE(P.tipoped,'VENDA')
from
  PESSOA P
  left join TIPOPAG TP on P.CODTIPOPAG1 = TP.CODTIPOPAG
  left join SLPAGTO SP on P.TIP_TIPO = SP.TIPOPAG
;



/* View: SLCADCLI_2 */
CREATE OR ALTER VIEW SLCADCLI_2(
    CODCLI,
    TIPOCLI,
    DTCADCLI,
    RAZSOCCLI,
    ENDCLI,
    CIDCLI,
    BAIRCLI,
    CEPCLI,
    ESTCLI,
    FAXCLI,
    TELCLI,
    CGCCLI,
    INSCESCLI,
    CODSET,
    CODSE1,
    CODSE2,
    CODSE3,
    CODSE4,
    BLOQCRED,
    SALDEVCLI,
    ULTCOMPRA,
    CODPRAZO,
    PRAZO,
    FORMAPAGTO,
    ATIVO,
    TIPOPED)
AS
select
  RIGHT('00000000' || cast(P.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
  '',
  P.DT_CADAST,
  P.NOME,
  P.LOGRADOURO_1,
  P.CIDADE_1,
  P.BAIRRO_1,
  P.CEP_1,
  P.UF_1,
  P.FAX,
  P.FONES,
  P.CPFCGC,
  P.IE,
  RIGHT('00000000' || cast((select first 1 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 1 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 2 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 3 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 4 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  'L',
  0.00,
  --CAST((SELECT SUM(COALESCE(VLPARCELA,0) - COALESCE(TOTPAGO,0)) FROM CONTA WHERE (CONTA.TIPO = 'RECEBER') and (CONTA.STATUS = 'ABERTO') AND (CONTA.CODPESSOA = P.CODPESSOA)) AS double precision),
  (select first 1 DT_EMISSAO from NFVENDA where NFVENDA.CODPESSOA = P.CODPESSOA order by DT_EMISSAO desc),
  CODTIPOPAG1,
  TP.DESCRICAO,
  SP.CODIGO,
  case P.ATIVO
  when 1 then 'I'
  when 2 then 'A'
  END,
  COALESCE(P.tipoped,'VENDA')
from
  PESSOA P
  left join TIPOPAG TP on P.CODTIPOPAG1 = TP.CODTIPOPAG
  left join SLPAGTO SP on P.TIP_TIPO = SP.TIPOPAG
;



/* View: SLCADCLI_ADICIONAIS */
CREATE OR ALTER VIEW SLCADCLI_ADICIONAIS(
    CODCLI,
    FANTASIA,
    SEGMENTO,
    RAMO,
    LIMITE,
    CODSTATUS,
    STATUS,
    DEP1,
    DEP1_NASC,
    DEP2,
    DEP2_NASC,
    DEP3,
    DEP3_NASC)
AS
select
  RIGHT('00000000' || cast(P.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
  P.NOMEFANTAZIA,
  ATV.DESCRICAO,
  RAM.DESCRICAO,
  P.LIMITECRED,
  P.CODSTATUS,
  STATUS.DESCRICAO,
  (select first 1 NOME  from PESSOA_DEPENDENTE PD where PD.CODPESSOA = P.CODPESSOA),
  (select first 1 DTNASCIMENTO  from PESSOA_DEPENDENTE PD where PD.CODPESSOA = P.CODPESSOA),
  (select first 1 skip 1 NOME  from PESSOA_DEPENDENTE PD where PD.CODPESSOA = P.CODPESSOA),
  (select first 1 skip 1 DTNASCIMENTO  from PESSOA_DEPENDENTE PD where PD.CODPESSOA = P.CODPESSOA),
  (select first 1 skip 2 NOME  from PESSOA_DEPENDENTE PD where PD.CODPESSOA = P.CODPESSOA),
  (select first 1 skip 2 DTNASCIMENTO  from PESSOA_DEPENDENTE PD where PD.CODPESSOA = P.CODPESSOA)
from
  PESSOA P
  left join TBL_RAMOATVTIPO ATV on ATV.CODTIPO = P.CODTIPOATV
  LEFT JOIN TBL_RAMOATV ON (ATV.CODATIVIDADE=TBL_RAMOATV.CODATIVIDADE)
  LEFT JOIN TBL_RAMO RAM ON (RAM.CODRAMO=TBL_RAMOATV.CODRAMO)
  LEFT JOIN STATUS ON (P.CODSTATUS = STATUS.CODSTATUS)
;



/* View: SLCADCLI_METAS */
CREATE OR ALTER VIEW SLCADCLI_METAS(
    CODPESSOA,
    QTD,
    CODGRUPO)
AS
select RIGHT('00000000' || cast(PESSOA_META.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
       PESSOA_META.QTD,
       RIGHT('00000000' || CAST(PESSOA_META.CODGRUPO AS VARCHAR(6)) ,6) AS CODGRUPO
from PESSOA_META
;



/* View: SLCADCLI_RAPIDO */
CREATE OR ALTER VIEW SLCADCLI_RAPIDO(
    CODCLI,
    RAZSOCCLI,
    CIDCLI,
    BAIRCLI)
AS
select RIGHT('00000000' || cast(PESSOA.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
       PESSOA.NOME,
       PESSOA.CIDADE_1,
       PESSOA.BAIRRO_1
from PESSOA
;



/* View: SLCADCLI_STATUS */
CREATE OR ALTER VIEW SLCADCLI_STATUS(
    CODCLI,
    STATUS_CLI,
    OBS_BLOQUEIO,
    OBS_BLOQUEIO1)
AS
select
  RIGHT('00000000' || cast(P.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
  S.DESCRICAO,
  P.OBSBLOQUEIO,
  P.OBSBLOQUEIO1
from
  PESSOA P
  inner join STATUS S on S.CODSTATUS = P.CODSTATUS
;



/* View: SLCADCOR_META */
CREATE OR ALTER VIEW SLCADCOR_META(
    CODIGO,
    CODVENDEDOR,
    CODCOR,
    DESCRICAO,
    CAIXA)
AS
SELECT
   VENDEDORMETAS.CODIGO,
   VENDEDORMETAS.CODVENDEDOR,
   VENDEDORMETAS.CODCOR,
   TBL_COR.DESCRICAO,
   VENDEDORMETAS.CAIXA
FROM
   VENDEDORMETAS
   INNER JOIN TBL_COR ON (VENDEDORMETAS.CODCOR = TBL_COR.CODCOR)
WHERE
   VENDEDORMETAS.CODCOR IS NOT NULL
;



/* View: SLCADDIVISAO */
CREATE OR ALTER VIEW SLCADDIVISAO(
    CODPRODFILHO,
    DIVISAO)
AS
select
  RIGHT('000000' || cast(PF.CODPRODFILHO as varchar(7)) ,6) as CODPRODFILHO,
  RIGHT('000000' || cast(PRODC.CODCARACTER as varchar(7)) ,6) as CODPRODCARACTER
from
 PRODFILHO PF
  join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
  join prodcaracter PRODC on (PD.CODPRODUTO = PRODC.CODPRODUTO)
  join CARACTER ON(CARACTER.CODCARACTER = PRODC.CODCARACTER)
 where char_length(pf.codprodfilho) <= 6
;



/* View: SLCADGRU */
CREATE OR ALTER VIEW SLCADGRU(
    CODGRU,
    DESCGRU)
AS
SELECT
   RIGHT('00000' ||CODGRUPO ,6) AS CODGRUPO,
   DESCRICAO
   FROM GRUPO
;



/* View: SLCADPRECOS */
CREATE OR ALTER VIEW SLCADPRECOS(
    CODPRODFILHO,
    PRECOPRATICADO1,
    PRECOPRATICADO2,
    PRECOPRATICADO3,
    PRECOPRATICADO4,
    PRECOPRATICADO5,
    PRECOPRATICADO6)
AS
select
  RIGHT('00000000' || cast(PF.CODPRODFILHO as varchar(6)) ,6) as CODPRODFILHO,
  PF.PRECOPRATICADO1,
  PF.PRECOPRATICADO2,
  PF.PRECOPRATICADO3,
  PF.PRECOPRATICADO4,
  PF.PRECOPRATICADO5,
  PF.PRECOPRATICADO6
from
  PRODFILHO PF
  join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
  where pd.ativo = 2
;



/* View: SLCADPRO */
CREATE OR ALTER VIEW SLCADPRO(
    CODPRO,
    DTCADPRO,
    DESCPRO,
    CODGRU,
    REF_FABR,
    PROMOCAO,
    PROATIINA,
    ULTREAVDA,
    PREVENDA,
    PRECOANT,
    SALDESTOQ,
    PRECO_UNIT,
    QTDEMBALAGEM,
    FATORCONVERSAO,
    PESO_BRUTO)
AS
select
  RIGHT('00000000' || cast(PF.CODPRODFILHO as varchar(7)) ,7) as CODPRODFILHO,
  cast(coalesce(PF.DT_CADAST,'01.01.2007') as timestamp),
  PF.DESCRICAO,
  RIGHT('00000000' || cast(PD.CODGRUPO as varchar(6)) ,6) as CODGRUPO,
  coalesce(PF.UNIDADE, UN.SIGLA),
  PF.PROMOCAO,
  case PD.ATIVO
    when 1 then 'I'
    when 2 then 'A'
  end as ATIVO,
  coalesce((select max(cast(DT_ATUALIZACAO as date)) from MODIFIPRECO WHERE CODPRODFILHO = PF.CODPRODFILHO),cast('01.01.06' as date)),
  PF.PRECOPRATICADO1,
  coalesce((select FIRST 1 ULTIMOPRECO from MODIFIPRECO WHERE CODPRODFILHO = PF.CODPRODFILHO order by DT_ATUALIZACAO DESC),1),
  (PF.ESTQATUAL - coalesce(PF.ESTOQANALISE,0)),
  (PF.PRECOPRATICADO1 / coalesce(nullif(PF.QTDEMBALAGEM,0),1)),
  coalesce(PF.QTDEMBALAGEM,1),
  coalesce(PF.FATORCONVERSAO,1),
  coalesce(PF.PESOBRUTO,1)
from
  PRODFILHO PF
  join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
  join UNIDADE UN on (PF.CODUNIDADE = UN.CODUNIDADE)
;



/* View: SLCADPRODCARACTER */
CREATE OR ALTER VIEW SLCADPRODCARACTER(
    CODPRO,
    CODPRODCARACTER,
    DESCPRODCARACTER)
AS
select
  RIGHT('00000000' || cast(PF.CODPRODFILHO as varchar(7)) ,7) as CODPRODFILHO,
  RIGHT('00000000' || cast(PRODC.CODCARACTER as varchar(7)) ,7) as CODPRODCARACTER,
  CARACTER.DESCRICAO
from
 PRODFILHO PF
  join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
  join prodcaracter PRODC on (PD.CODPRODUTO = PRODC.CODPRODUTO)
  join CARACTER ON(CARACTER.CODCARACTER = PRODC.CODCARACTER)
where
  PD.ativo = 2
;



/* View: SLCADSET */
CREATE OR ALTER VIEW SLCADSET(
    CODSET,
    NOMSET,
    CODGRUPO,
    COTASET,
    QUANTCLI,
    COTAUNID,
    TABELA1,
    TABELA2,
    TABELA3,
    TABELA4,
    TABELA5,
    TABELA6,
    CODDIVISAO)
AS
select
  RIGHT('00000000' || cast(V.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR,
  NOME,
  VM.CODGRUPO,
  coalesce(nullif(VM.VALOR,0),nullif(V.MARGEM,0),0) as TOT_VALOR,
  coalesce((select count(distinct CODPESSOA) from PESSOA_VENDEDOR where CODVENDEDOR = V.CODVENDEDOR),0) as TOT_POTENCIAL,
  coalesce(VM.QTD,0) as TOT_QTD,
  PRECO1,
  PRECO2,
  PRECO3,
  PRECO4,
  PRECO5,
  PRECO6,
  V.CODCOBRADOR
from
  VENDEDOR V
  left join VENDEDORMETAS VM on (V.CODVENDEDOR = VM.CODVENDEDOR and
                                 extract(month from (select cast('NOW' as date) from RDB$DATABASE)) >= extract(month from VM.INICIO) and extract(month from (select cast('NOW' as date) from RDB$DATABASE)) <= extract(month from VM.FINAL))
;



/* View: SLCADSET_META */
CREATE OR ALTER VIEW SLCADSET_META(
    CODVENDEDOR,
    CODGRUPO,
    CODPRODFILHO,
    PRODUTO,
    META,
    METAPOSITIVACAO,
    REALIZADO,
    REALIZADOPOSITIVACAO)
AS
select
  RIGHT('00000000' || cast(V.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR,
  RIGHT('00000000' || cast(PR.CODGRUPO as varchar(6)) ,6) as CODGRUPO,
  RIGHT('00000000' || cast(PI.CODPRODFILHO as varchar(6)) ,6) as CODPRODFILHO,
  PF.DESCRICAO PRODUTO,
  VM.QTD META,
  VM.POSITIVACAO METAPOSITIVACAO,
  sum(PI.QTDENTREGUE) REALIZADO,
  count(distinct P.CODPESSOA) REALIZADOPOSITIVACAO
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join VENDEDORMETAS VM on V.CODVENDEDOR = VM.CODVENDEDOR and PR.codsubgrupo = VM.codsubgrupo
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA', 'CADERNO') and
  extract(month from current_date) = extract(month from cast(P.DTFATURADO as date)) and
  extract(year from current_date) = extract(year from cast(P.DTFATURADO as date))
GROUP BY 1,2,3,4,5,6
;



/* View: SLCADSET_META_ATACAMAX */
CREATE OR ALTER VIEW SLCADSET_META_ATACAMAX(
    CODVENDEDOR,
    CODGRUPO,
    CODSUBGRUPO,
    META,
    METAPOSITIVACAO,
    GRUPO,
    SUBGRUPO,
    EXTRA,
    REALIZADO,
    REALIZADOPOSITIVACAO)
AS
select
  RIGHT('00000000' || cast(V.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR,
  RIGHT('00000000' || cast(PR.CODGRUPO as varchar(6)) ,6) as CODGRUPO,
  RIGHT('00000000' || cast(PR.CODSUBGRUPO as varchar(6)) ,6) as CODSUBGRUPO,
  VM.VALOR META,
  VM.POSITIVACAO METAPOSITIVACAO,
  GRUPO.DESCRICAO GRUPO,
  SUBGRUPO.DESCRICAO SUBGRUPO,
  coalesce(VM.EXTRA,'N') EXTRA,
  sum(pi.precovend) REALIZADO,
  count(distinct P.CODPESSOA) REALIZADOPOSITIVACAO
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join PEDVENDITEM pi on P.CODPEDVEND = pi.CODPEDVEND
  join PRODFILHO PF on pi.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join VENDEDORMETAS VM on V.CODVENDEDOR = VM.CODVENDEDOR and PR.codSUBgrupo = VM.codSUBgrupo
  join GRUPO on GRUPO.codgrupo = PR.CODGRUPO
  join SUBGRUPO on SUBGRUPO.codsubgrupo = PR.codsubgrupo
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA', 'CADERNO') and
  extract(month from current_date) = extract(month from cast(P.DTFATURADO as date)) and
  extract(year from current_date) = extract(year from cast(P.DTFATURADO as date))
group by 1,2,3,4,5,6,7,8
;



/* View: SLCADSET_META_GRUPO */
CREATE OR ALTER VIEW SLCADSET_META_GRUPO(
    CODVENDEDOR,
    CODGRUPO,
    DESCGRUPO,
    CODSUBGRUPO,
    DESCSUBGRUPO,
    CODPRODFILHO,
    PRODUTO,
    QTDPORCAIXA,
    COTADIARIACAIXAS,
    COTADIARIAPOSITIVACAO)
AS
select
  RIGHT('00000000' || cast(V.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR,
  RIGHT('00000000' || cast(PR.CODGRUPO as varchar(6)) ,6) as CODGRUPO,
  grupo.DESCRICAO as DESCGRUPO,
  RIGHT('00000000' || cast(pr.CODSUBGRUPO as varchar(6)) ,6) as CODSUBGRUPO,
  subgrupo.DESCRICAO as DESCSUBGRUPO,
  RIGHT('00000000' || cast(PI.CODPRODFILHO as varchar(6)) ,6) as CODPRODFILHO,
  PF.DESCRICAO PRODUTO,
  PF.QTDEMBALAGEM as QTDPORCAIXA,
  vm.CAIXADIA as COTADIARIACAIXAS,
  vm.POSITDIA as Cotadiariapositivacao
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join VENDEDORMETAS VM on V.CODVENDEDOR = VM.CODVENDEDOR and PR.codsubgrupo = VM.codsubgrupo
  join grupo on (PR.codgrupo = grupo.CODGRUPO)
  join subgrupo on(PR.CODSUBGRUPO = subgrupo.CODSUBGRUPO)
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA', 'CADERNO') and
  extract(month from current_date) = extract(month from cast(P.DTFATURADO as date)) and
  extract(year from current_date) = extract(year from cast(P.DTFATURADO as date))
;



/* View: SLCADSET_RAPIDO */
CREATE OR ALTER VIEW SLCADSET_RAPIDO(
    CODSET,
    NOMSET,
    CODGRUPO,
    COTASET,
    QUANTCLI,
    COTAUNID,
    TABELA1,
    TABELA2,
    TABELA3,
    TABELA4,
    TABELA5,
    TABELA6,
    CODDIVISAO)
AS
select
  RIGHT('00000000' || cast(V.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR,
  NOME,
  VM.CODGRUPO,
  coalesce(nullif(VM.VALOR,0),nullif(V.MARGEM,0),0) as TOT_VALOR,
  coalesce((select count(distinct CODPESSOA) from PESSOA_VENDEDOR where CODVENDEDOR = V.CODVENDEDOR),0) as TOT_POTENCIAL,
  coalesce(VM.QTD,0) as TOT_QTD,
  PRECO1,
  PRECO2,
  PRECO3,
  PRECO4,
  PRECO5,
  PRECO6,
  V.CODCOBRADOR
from
  VENDEDOR V
  left join VENDEDORMETAS VM on (V.CODVENDEDOR = VM.CODVENDEDOR and
                                 extract(month from (select cast('NOW' as date) from RDB$DATABASE)) >= extract(month from VM.INICIO) and extract(month from (select cast('NOW' as date) from RDB$DATABASE)) <= extract(month from VM.FINAL))
;



/* View: SLCADSET_TOTAIS */
CREATE OR ALTER VIEW SLCADSET_TOTAIS(
    CODSET,
    VENDAS,
    PEDIDOS,
    ATENDIDOS,
    ULTVENDA,
    FLEX,
    FLEXPERC,
    VENDAUNID)
AS
select
  RIGHT('00000000' || cast(P.CODVENDEDOR as varchar(6)), 4),
  coalesce(sum(PI.PRECOVEND),0),
  coalesce(count(distinct P.CODPEDVEND),0),
  coalesce(count(distinct P.CODPESSOA),0),
  max(cast(DTFATURADO as date)) ,
  (coalesce(sum(PI.QTDE*PI.PRECOPROD),0)) - (coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)),
--  ((coalesce(sum(PI.QTDE*PI.PRECOPROD),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  (((coalesce(sum(PI.PRECOVEND),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  coalesce(sum(PI.QTDE),0) as LITROS
from
  PEDVEND P
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA','CADERNO') and
  extract(month from cast(P.DTFATURADO as date)) = extract(month from current_date) and
  extract(year from cast(P.DTFATURADO as date)) = extract(year from current_date)
group by
  1
;



/* View: SLCADSET_TOTAIS_ATACAMAX */
CREATE OR ALTER VIEW SLCADSET_TOTAIS_ATACAMAX(
    CODSET,
    VENDAS,
    PEDIDOS,
    ATENDIDOS,
    ULTVENDA,
    FLEX,
    FLEXPERC,
    VENDAUNID)
AS
select
  RIGHT('00000000' || cast(P.CODVENDEDOR as varchar(6)), 4),
  coalesce(sum(PI.PRECOVEND),0),
  coalesce(count(distinct P.CODPEDVEND),0),
  coalesce(count(distinct P.CODPESSOA),0),
  max(cast(DTFATURADO as date)) ,
  ((coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0) - coalesce(sum(PI.PRECOVEND),0))),
  (((coalesce(sum(PI.PRECOVEND),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  coalesce(sum(PI.QTDE),0) as LITROS
from
  PEDVEND P
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA','CADERNO') and
  extract(month from cast(P.DTFATURADO as date)) = extract(month from current_date) and
  extract(year from cast(P.DTFATURADO as date)) = extract(year from current_date)
group by
  1
;



/* View: SLCADSET_TOTAIS_MARFIM */
CREATE OR ALTER VIEW SLCADSET_TOTAIS_MARFIM(
    CODSET,
    VENDAS,
    PEDIDOS,
    ATENDIDOS,
    ULTVENDA,
    FLEX,
    FLEXPERC,
    VENDAUNID)
AS
select
  RIGHT('00000000' || cast(P.CODVENDEDOR as varchar(6)), 4),
  coalesce(sum(PI.PRECOVEND),0),
  coalesce(count(distinct P.CODPEDVEND),0),
  coalesce(count(distinct P.CODPESSOA),0),
  max(cast(DTFATURADO as date)) ,
  (coalesce(sum(PI.QTDE*PI.PRECOPROD),0)) - (coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)),
--  ((coalesce(sum(PI.QTDE*PI.PRECOPROD),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  (((coalesce(sum(PI.PRECOVEND),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  coalesce(sum(PI.QTDE),0) as LITROS
from
  PEDVEND P
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA','CADERNO') and
  cast(P.DTFATURADO as date) between (SELECT RETORNA_MES_MARFIM.DATA_INICIAL FROM RETORNA_MES_MARFIM)
   and (SELECT RETORNA_MES_MARFIM.DATA_FINAL FROM RETORNA_MES_MARFIM)
group by
  1
;



/* View: SLCADTIT_V1 */
CREATE OR ALTER VIEW SLCADTIT_V1(
    NUMMOV,
    TIPODOC,
    DTEMISS,
    CODCLI,
    CODSET,
    CODPOR,
    NMTITULO,
    SITTIT,
    DTVENCLIM,
    VALBRUTO,
    DTPAGTO,
    VALPAGO,
    VALACUJUR,
    PEDIDO,
    ANOTACAO)
AS
SELECT
   RIGHT('00000000' || CAST(CODCONTA AS VARCHAR(7)) ,8) AS NUMMOV,
   CASE PREV_TIPOPAG
   WHEN 'BOLETO BANCRIO' THEN 'BO'
   WHEN 'CHEQUE' THEN 'CH'
   WHEN 'DUPLICATA' THEN 'DU'
   WHEN 'DINHEIRO' THEN 'ES' END AS PREV_TIPOPAG,
   DT_EMISSAO,
   RIGHT('00000000' || CAST(CODPESSOA AS VARCHAR(6)) ,6) AS CODPESSOA,
   RIGHT('00000000' || CAST(CODVENDEDOR AS VARCHAR(6)) ,4) AS CODSET,
   RIGHT('00000000' || CAST(CODBANCO AS VARCHAR(6)) ,3) AS CODPORT,
   NRDOCUMENTO,
   'AB',
   DT_VENCIM,
   (VLPARCELA),
   (SELECT FIRST 1 DT_PAGAMEN FROM CONTABX WHERE CODCONTA = CONTA.CODCONTA) AS DT_PAGAMENTO,
   TOTPAGO,
   0,
   CODPENDVEND,
   CONTA.OBS1||' '||CONTA.OBS2
   FROM CONTA
   WHERE STATUS = 'ABERTO' AND TOTPAGO = 0 AND CODPENDVEND > 0
;



/* View: SLCADTIT_V2 */
CREATE OR ALTER VIEW SLCADTIT_V2(
    NUMMOV,
    TIPODOC,
    DTEMISS,
    CODCLI,
    CODSET,
    CODPOR,
    NMTITULO,
    SITTIT,
    DTVENCLIM,
    VALBRUTO,
    DTPAGTO,
    VALPAGO,
    VALACUJUR,
    PEDIDO,
    ANOTACAO)
AS
SELECT
   RIGHT('00000000' || CAST(CODCONTA AS VARCHAR(7)) ,8) AS NUMMOV,
   CASE PREV_TIPOPAG
   WHEN 'BOLETO BANCRIO' THEN 'BO'
   WHEN 'CHEQUE' THEN 'CH'
   WHEN 'DUPLICATA' THEN 'DU'
   WHEN 'DINHEIRO' THEN 'ES' END AS PREV_TIPOPAG,
   DT_EMISSAO,
   RIGHT('00000000' || CAST(CODPESSOA AS VARCHAR(6)) ,6) AS CODPESSOA,
   RIGHT('00000000' || CAST(CODVENDEDOR AS VARCHAR(6)) ,4) AS CODSET,
   RIGHT('00000000' || CAST(CODBANCO AS VARCHAR(6)) ,3) AS CODPORT,
   NRDOCUMENTO,
   'PC',
   DT_VENCIM,
   (VLPARCELA),
   (SELECT FIRST 1 DT_PAGAMEN FROM CONTABX WHERE CODCONTA = CONTA.CODCONTA) AS DT_PAGAMENTO,
   TOTPAGO,
   0,
   CODPENDVEND,
   CONTA.OBS1||' '||CONTA.OBS2
   FROM CONTA
   WHERE STATUS = 'ABERTO' AND TOTPAGO > 0 AND CODPENDVEND > 0
;



/* View: SLCADTIT_V3 */
CREATE OR ALTER VIEW SLCADTIT_V3(
    NUMMOV,
    TIPODOC,
    DTEMISS,
    CODCLI,
    CODSET,
    CODPOR,
    NMTITULO,
    SITTIT,
    DTVENCLIM,
    VALBRUTO,
    DTPAGTO,
    VALPAGO,
    VALACUJUR,
    PEDIDO,
    ANOTACAO)
AS
SELECT
   RIGHT('00000000' || CAST(CODCONTA AS VARCHAR(7)) ,8) AS NUMMOV,
   CASE PREV_TIPOPAG
   WHEN 'BOLETO BANCRIO' THEN 'BO'
   WHEN 'CHEQUE' THEN 'CH'
   WHEN 'DUPLICATA' THEN 'DU'
   WHEN 'DINHEIRO' THEN 'ES' END AS PREV_TIPOPAG,
   DT_EMISSAO,
   RIGHT('00000000' || CAST(CODPESSOA AS VARCHAR(6)) ,6) AS CODPESSOA,
   RIGHT('00000000' || CAST(CODVENDEDOR AS VARCHAR(6)) ,4) AS CODSET,
   RIGHT('00000000' || CAST(CODBANCO AS VARCHAR(6)) ,3) AS CODPORT,
   NRDOCUMENTO,
   'AB',
   DT_VENCIM,
   (VLPARCELA),
   (SELECT FIRST 1 DT_PAGAMEN FROM CONTABX WHERE CODCONTA = CONTA.CODCONTA) AS DT_PAGAMENTO,
   TOTPAGO,
   0,
   CODPENDVEND,
   CONTA.OBS1||' '||CONTA.OBS2
   FROM CONTA
   WHERE STATUS = 'ABERTO' AND coalesce(CODPENDVEND,0) = 0 and TIPO = 'RECEBER'
;



/* View: SLCADTIT */
CREATE OR ALTER VIEW SLCADTIT(
    NUMMOV,
    TIPODOC,
    DTEMISS,
    CODCLI,
    CODSET,
    CODPOR,
    NMTITULO,
    SITTIT,
    DTVENCLIM,
    VALBRUTO,
    DTPAGTO,
    VALPAGO,
    VALACUJUR,
    PEDIDO,
    ANOTACAO)
AS
SELECT NUMMOV,TIPODOC,DTEMISS,CODCLI,CODSET,CODPOR,NMTITULO,SITTIT,DTVENCLIM,VALBRUTO,DTPAGTO,VALPAGO,VALACUJUR,PEDIDO,ANOTACAO FROM SLCADTIT_V1
UNION
SELECT NUMMOV,TIPODOC,DTEMISS,CODCLI,CODSET,CODPOR,NMTITULO,SITTIT,DTVENCLIM,VALBRUTO,DTPAGTO,VALPAGO,VALACUJUR,PEDIDO,ANOTACAO FROM SLCADTIT_V2
UNION
SELECT NUMMOV,TIPODOC,DTEMISS,CODCLI,CODSET,CODPOR,NMTITULO,SITTIT,DTVENCLIM,VALBRUTO,DTPAGTO,VALPAGO,VALACUJUR,PEDIDO,ANOTACAO FROM SLCADTIT_V3
;



/* View: SLPROMOCAO */
CREATE OR ALTER VIEW SLPROMOCAO(
    CODPRODFILHO,
    "CAST",
    DESCRICAO,
    CODGRUPO,
    "COALESCE",
    PROMOCAO,
    ATIVO,
    COALESCE1,
    PRECOPRATICADO1,
    COALESCE2,
    F_1,
    F_2,
    COALESCE3,
    COALESCE4)
AS
select
  RIGHT('00000000' || cast(PF.CODPRODFILHO as varchar(6)) ,6) as CODPRODFILHO,
  cast(coalesce(PF.DT_CADAST,'01.01.2007') as timestamp),
  PF.DESCRICAO,
  RIGHT('00000000' || cast(PD.CODGRUPO as varchar(6)) ,6) as CODGRUPO,
  coalesce(PF.UNIDADE, UN.SIGLA),
  PF.PROMOCAO,
  case PD.ATIVO
    when 1 then 'I'
    when 2 then 'A'
  end as ATIVO,
  coalesce((select max(cast(DT_ATUALIZACAO as date)) from MODIFIPRECO where CODPRODFILHO = PF.CODPRODFILHO),cast('01.01.06' as date)),
  PF.PRECOPRATICADO1,
  coalesce((select first 1 ULTIMOPRECO from MODIFIPRECO where CODPRODFILHO = PF.CODPRODFILHO order by DT_ATUALIZACAO desc),1),
  (PF.ESTQATUAL - coalesce(PF.ESTOQANALISE,0)),
  (PF.PRECOPRATICADO1 / coalesce(PF.QTDEMBALAGEM,1)),
  coalesce(PF.QTDEMBALAGEM,1),
  coalesce(PF.FATORCONVERSAO,1)
from
  PRODFILHO PF
  join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
  join UNIDADE UN on (PF.CODUNIDADE = UN.CODUNIDADE)
  join PROMOCAOITEM PRI on (PRI.CODPRODFILHO_FK = PF.CODPRODFILHO)
  join promocao pr on (pr.CODPROMOCAO = pri.CODPROMOCAO_FK)
where
  pr.DATAFIM >= CURRENT_DATE and pr.STATUS = 'LIBERADO'
;



/* View: SLULTIMAS_ENTRADA */
CREATE OR ALTER VIEW SLULTIMAS_ENTRADA(
    CODPRODFILHO,
    DESCRICAO,
    ESTOQUE_ATUAL,
    DATA_ENTRADA)
AS
select
  DISTINCT RIGHT('00000000' || cast(PRODFILHO.CODPRODFILHO as varchar(6)) ,6) as CODPRODFILHO,
  PRODFILHO.DESCRICAO,
  (PRODFILHO.ESTQATUAL - coalesce(PRODFILHO.ESTOQANALISE,0)) ESTOQUE_ATUAL,
  MAX(cast(nfentrada.dtentrada as date)) DATA_ENTRADA
from
  PRODFILHO
  inner join nfentradaitens on (PRODFILHO.codprodfilho = nfentradaitens.codprodfilho)
  inner join nfentrada on (nfentrada.codnfentrada = nfentradaitens.codnfentrada)
where
  cast(nfentrada.dtentrada as date) >= current_date - 7
  AND nfentrada.statusconferencia = 'ENTRADA LIBERADA'
  AND nfentrada.status <> 'C'
GROUP BY 1,2,3
;



/* View: SOFTSITE_CLI_ROTA */
CREATE OR ALTER VIEW SOFTSITE_CLI_ROTA(
    CD_VENDEDOR,
    CD_CLIENTE,
    CD_ROTA,
    NR_SEQ_ATEND)
AS
select PESSOA_VENDEDOR.CODVENDEDOR CD_VENDEDOR,
       PESSOA_VENDEDOR.CODPESSOA CD_CLIENTE,
       PESSOA_VENDEDOR.CODROTA_FK CD_ROTA,
       PESSOA.SEQ_ROTA NR_SEQ_ATEND
from PESSOA_VENDEDOR
inner join PESSOA on PESSOA.CODPESSOA = PESSOA_VENDEDOR.CODPESSOA
;



/* View: SOFTSITE_CLIENTES */
CREATE OR ALTER VIEW SOFTSITE_CLIENTES(
    CD_CLIENTE,
    NM_CLIENTE,
    NM_FANTASIA,
    DS_ENDERECO,
    NM_BAIRRO,
    NM_CIDADE,
    NM_ESTADO,
    CD_ROTA,
    NR_SEQ_ATEND,
    VR_SALDO_LIMITE,
    DS_SITUACAO,
    NR_TELEFONE,
    VR_LIMITE,
    NR_CEP,
    NR_CNPJ_CPF,
    NR_CGF,
    PC_SALDO_LIMITE_EXCEDENTE)
AS
select
  PESSOA.CODPESSOA CD_CLIENTE,
  PESSOA.NOME,
  PESSOA.NOMEFANTAZIA,
  PESSOA.LOGRADOURO_1,
  PESSOA.BAIRRO_1,
  PESSOA.CIDADE_1,
  PESSOA.UF_1,
  '' CD_ROTA,
  PESSOA.SEQ_ROTA NR_SEQ_ATEND,
  (select LIMITE_CREDITO.TOTALDISPONIVEL from LIMITE_CREDITO(PESSOA.CODPESSOA)) VR_SALDO_LIMITE,
  '' DS_SITUACAO,
  PESSOA.FONES NR_TELEFONE,
  PESSOA.LIMITECRED VR_LIMITE,
  PESSOA.CEP_1 NR_CEP,
  (select FU_GETTIRAMASCARA.STRRESULT from FU_GETTIRAMASCARA(PESSOA.CPFCGC)) NR_CNPJ_CPF,
  '' NR_CGF,
  0 PC_SALDO_LIMITE_EXCEDENTE
from PESSOA
where PESSOA.TIPOPESSOA = 'Cliente'
;



/* View: SOFTSITE_COND_PAGAMENTO */
CREATE OR ALTER VIEW SOFTSITE_COND_PAGAMENTO(
    CD_COND_PGTO,
    DS_COND_PGTO,
    QT_DIAS_TOTAL,
    PR_DESCONTO,
    DS_DIAS_PARCELAS,
    DS_PR_PARCELAS,
    NR_PRECO)
AS
select TIPOPAG.CODTIPOPAG CD_COND_PGTO,
TIPOPAG.DESCRICAO DS_COND_PGTO,
TIPOPAG.NRPRESTACAO * TIPOPAG.NRDIAS QT_DIAS_TOTAL,
0 PR_DESCONTO,
TIPOPAG.DESCRICAO DS_DIAS_PARCELAS,
'' DS_PR_PARCELAS,
0 NR_PRECO
from TIPOPAG
;



/* View: SOFTSITE_FAIXA_PRECO_PRODUTO */
CREATE OR ALTER VIEW SOFTSITE_FAIXA_PRECO_PRODUTO(
    CD_SEQUENCIAL,
    QT_MIN_FAIXA,
    VR_PRECO_MINIMO,
    VR_PRECO_SUGERIDO,
    VR_PRECO_MAXIMO)
AS
select '1'|| cast('1' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL,
1 QT_MIN_FAIXA,
PRODFILHO.PRECOPRATICADO1 VR_PRECO_MINIMO,
PRODFILHO.PRECOPRATICADO2 VR_PRECO_SUGERIDO,
PRODFILHO.PRECOPRATICADO3 VR_PRECO_MAXIMO
from PRODFILHO
;



/* View: SOFTSITE_FAMILIA */
CREATE OR ALTER VIEW SOFTSITE_FAMILIA(
    CD_FAMILIA,
    NM_FAMILIA,
    CD_FAMILIA_PAI)
AS
select GRUPO.CODGRUPO CD_FAMILIA,
GRUPO.DESCRICAO NM_FAMILIA,
'' CD_FAMILIA_PAI
from GRUPO
;



/* View: SOFTSITE_FORNECEDORES */
CREATE OR ALTER VIEW SOFTSITE_FORNECEDORES(
    CD_FORNECEDOR,
    DS_FORNECEDOR,
    ID_BLOQUEADO)
AS
select
  PESSOA.CODPESSOA CD_FORNECEDOR,
  PESSOA.NOME DS_FORNECEDOR,
  'S' ID_BLOQUEADO
from PESSOA
where PESSOA.TIPOPESSOA = 'Fornecedor'
;



/* View: SOFTSITE_GRUPO_MPGTO */
CREATE OR ALTER VIEW SOFTSITE_GRUPO_MPGTO(
    CD_GRUPO_MPGTO,
    DS_GRUPO)
AS
select 01 CD_GRUPO_MPGTO,
       'PAGAMENTO GERAL' DS_GRUPO
from RDB$DATABASE
;



/* View: SOFTSITE_MEIOS_PAGTO */
CREATE OR ALTER VIEW SOFTSITE_MEIOS_PAGTO(
    CD_MEIO_PGTO,
    DS_MEIO_PGTO,
    TP_MEIO_PGTO)
AS
select 1 CD_MEIO_PGTO, cast('CARTO' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 2 CD_MEIO_PGTO, cast('CHEQUE' as VARCHAR(30)) DS_MEIO_PGTO,
'C' TP_MEIO_PGTO
from RDB$DATABASE
union
select 3 CD_MEIO_PGTO, cast('DINHEIRO' as VARCHAR(30)) DS_MEIO_PGTO,
'D' TP_MEIO_PGTO
from RDB$DATABASE
union
select 4 CD_MEIO_PGTO, cast('VALE' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 5 CD_MEIO_PGTO, cast('DUPLICATA' as VARCHAR(30)) DS_MEIO_PGTO,
'U' TP_MEIO_PGTO
from RDB$DATABASE
union
select 6 CD_MEIO_PGTO, cast('BOLETO BANCRIO' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 7 CD_MEIO_PGTO, cast('PROMISSRIA' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 8 CD_MEIO_PGTO, cast('BONIFICAO' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 9 CD_MEIO_PGTO, cast('TROCA' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 10 CD_MEIO_PGTO, cast('FRETE' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 11 CD_MEIO_PGTO, cast('TRANSFERNCIA' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
;



/* View: SOFTSITE_ITEM_GRUPO_MPGTO */
CREATE OR ALTER VIEW SOFTSITE_ITEM_GRUPO_MPGTO(
    CD_GRUPO_MPGTO,
    CD_MEIO_PGTO,
    CD_COND_PGTO)
AS
select  1 CD_GRUPO_MPGTO,
        (
         select first 1 SOFTSITE_MEIOS_PAGTO.cd_meio_pgto
         from SOFTSITE_MEIOS_PAGTO
         where SOFTSITE_MEIOS_PAGTO.ds_meio_pgto = tipopag.tip_tipo
        ) CD_MEIO_PGTO,
        TIPOPAG.CODTIPOPAG CD_COND_PGTO
from TIPOPAG
;



/* View: SOFTSITE_LISTAPRODUTO */
CREATE OR ALTER VIEW SOFTSITE_LISTAPRODUTO(
    CD_ORG_VENDA,
    CD_TAB_PRECO,
    CD_PRODUTO,
    CD_SEQUENCIAL)
AS
select 1 CD_ORG_VENDA,
1 CD_TAB_PRECO,
PRODFILHO.CODPRODFILHO CD_PRODUTO,
'11' || PRODFILHO.CODPRODFILHO CD_SEQUENCIAL
from PRODFILHO
join produto on (produto.codproduto = prodfilho.codproduto)
where produto.ativo = 2
;
;



/* View: SOFTSITE_ORGVENDA */
CREATE OR ALTER VIEW SOFTSITE_ORGVENDA(
    CD_ORG_VENDA,
    NM_ORGANIZACAO,
    END_ORGANIZACAO,
    BAIRRO_ORGANIZACAO,
    CIDADE_ORGANIZACAO,
    UF_ORGANIZACAO,
    CNPJ_ORGANIZACAO,
    CD_ESTOQUE)
AS
select SYSPARAMS.CODSYSPARAMS CD_ORG_VENDA,
       SYSPARAMS.EMPRESA NM_ORGANIZACAO,
       SYSPARAMS.LOGRADOURO END_ORGANIZACAO,
       SYSPARAMS.BAIRRO BAIRRO_ORGANIZACAO,
       SYSPARAMS.CIDADE CIDADE_ORGANIZACAO,
       SYSPARAMS.UF UF_ORGANIZACAO,
       (select fu_gettiramascara.strresult from fu_gettiramascara(sysparams.CGC)) CNPJ_ORGANIZACAO,
       null CD_ESTOQUE
from SYSPARAMS
;



/* View: SOFTSITE_ORGVENDA_CLIENTE */
CREATE OR ALTER VIEW SOFTSITE_ORGVENDA_CLIENTE(
    CD_ORG_VENDA,
    CD_CLIENTE,
    CD_VENDEDOR,
    CD_TAB_PRECO,
    CD_GRUPO_MPGTO)
AS
SELECT 1 CD_ORG_VENDA,
PESSOA.CODPESSOA CD_CLIENTE,
PESSOA.CODVENDEDOR CD_VENDEDOR,
1 CD_TAB_PRECO,
1 CD_GRUPO_MPGTO --PESSOA.codtipopag1 CD_GRUPO_MPGTO
FROM PESSOA
WHERE PESSOA.TIPOPESSOA = 'Cliente'
and coalesce(PESSOA.CODTIPOPAG1,0) > 0
and coalesce(PESSOA.CODVENDEDOR,0) > 0
;



/* View: SOFTSITE_PRODUTO */
CREATE OR ALTER VIEW SOFTSITE_PRODUTO(
    CD_PRODUTO,
    NM_PRODUTO,
    DS_UNIDADE_BASE,
    QT_BASE,
    CD_FAMILIA,
    QT_ESTOQUE,
    DS_OBS_PRODUTO,
    QT_UNIDADE,
    CD_REFERENCIA,
    PS_PRODUTO_KG,
    VR_MAX_PC_DESCONTO,
    VR_MAX_PC_ACRESCIMO,
    CD_FORNECEDOR,
    ID_MONITORADO)
AS
select PRODFILHO.CODPRODFILHO CD_PRODUTO,
PRODFILHO.DESCRICAO NM_PRODUTO,
SUBSTRING(UNIDADE.SIGLA FROM 1 for 3) DS_UNIDADE_BASE,
'1' QT_BASE, --PRODFILHO.QTDEMBALAGEM QT_BASE,
PRODUTO.CODGRUPO CD_FAMILIA,
PRODFILHO.ESTQATUAL QT_ESTOQUE,
PRODFILHO.DADOS1 DS_OBS_PRODUTO,
PRODFILHO.QTDEMBALAGEM QT_UNIDADE,
PRODFILHO.CODPESQ1 CD_REFERENCIA,
PRODFILHO.PESOLIQUIDO PS_PRODUTO_KG,
PRODFILHO.DESCONTDESEJ VR_MAX_PC_DESCONTO,
0 VR_MAX_PC_ACRESCIMO,
PRODPESSOA.CODPESSOA CD_FORNECEDOR,
'' ID_MONITORADO
from PRODFILHO
inner join UNIDADE on UNIDADE.CODUNIDADE = PRODFILHO.CODUNIDADE
inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
left join PRODPESSOA on PRODPESSOA.CODPRODUTO = PRODFILHO.CODPRODFILHO
where PRODUTO.ATIVO = 2
;



/* View: SOFTSITE_ROTA */
CREATE OR ALTER VIEW SOFTSITE_ROTA(
    CD_ROTA,
    DS_ROTA)
AS
select ROTA.CODROTA CD_ROTA,
       ROTA.DESCRICAO DS_ROTA
from ROTA
;



/* View: SOFTSITE_SEQUENCIAL */
CREATE OR ALTER VIEW SOFTSITE_SEQUENCIAL(
    CD_SEQUENCIAL)
AS
select '1'|| cast('1' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL
from PRODFILHO
union
select '1'|| cast('2' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL
from PRODFILHO
union
select '1'|| cast('3' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL
from PRODFILHO
union
select '1'|| cast('4' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL
from PRODFILHO
union
select '1'|| cast('5' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL
from PRODFILHO
union
select '1'|| cast('6' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL
from PRODFILHO
;



/* View: SOFTSITE_SUPERVISOR */
CREATE OR ALTER VIEW SOFTSITE_SUPERVISOR(
    CD_SUPERVISOR,
    NM_SUPERVISOR,
    CD_USUARIO,
    CD_SUPERVISOR_PAI,
    DS_TELEFONE)
AS
select SUPERVISOR.CODSUPERVISOR CD_SUPERVISOR,
SUPERVISOR.NOME NM_SUPERVISOR,
0 CD_USUARIO,
0 CD_SUPERVISOR_PAI,
SUPERVISOR.FONES DS_TELEFONE
from SUPERVISOR
;



/* View: SOFTSITE_TAB_PRECO */
CREATE OR ALTER VIEW SOFTSITE_TAB_PRECO(
    CD_TAB_PRECO,
    DS_TAB_PRECO)
AS
select 01 CD_TAB_PRECO,
       'TABELA 01' DS_TAB_PRECO
from RDB$DATABASE
;



/* View: SOFTSITE_TITULOS */
CREATE OR ALTER VIEW SOFTSITE_TITULOS(
    CD_TITULO,
    CD_CLIENTE,
    DT_LANCAMENTO,
    VR_TITULO,
    DT_VENCIMENTO,
    CD_MEIO_PGTO)
AS
select CONTA.CODCONTA CD_TITULO,
CONTA.CODPESSOA CD_CLIENTE,
CONTA.DT_EMISSAO DT_LANCAMENTO,
CONTA.VLPARCELA VR_TITULO,
CONTA.DT_VENCIM DT_VENCIMENTO,
coalesce((select softsite_meios_pagto.cd_meio_pgto
from softsite_meios_pagto where
softsite_meios_pagto.ds_meio_pgto = CONTA.prev_tipopag),6) CD_MEIO_PGTO
from CONTA
inner join PESSOA on PESSOA.CODPESSOA = CONTA.CODPESSOA
where PESSOA.TIPOPESSOA = 'Cliente'
      AND CONTA.tipo = 'RECEBER'
      AND CONTA.status = 'ABERTO'
;



/* View: SOFTSITE_TRANSPORTADORA */
CREATE OR ALTER VIEW SOFTSITE_TRANSPORTADORA(
    CD_TRANSPORTADORA,
    NM_TRANSPORTADORA,
    NM_ESTADO,
    NM_CIDADE)
AS
select TRANSPORT.CODTRANSPORT CD_TRANSPORTADORA,
TRANSPORT.NOME NM_TRANSPORTADORA,
TRANSPORT.UF NM_ESTADO,
TRANSPORT.CIDADE NM_CIDADE
from TRANSPORT
;



/* View: SOFTSITE_TRANSPORTADORA_CLIENTE */
CREATE OR ALTER VIEW SOFTSITE_TRANSPORTADORA_CLIENTE(
    CD_CLIENTE,
    CD_TRANSPORTADORA)
AS
select PESSOA.CODPESSOA CD_CLIENTE,
PESSOA.CODTRANSPORT CD_TRANSPORTADORA
from PESSOA
where
coalesce(PESSOA.CODTRANSPORT,0) <> 0
and PESSOA.TIPOPESSOA = 'Cliente'
;



/* View: SOFTSITE_VENDEDOR */
CREATE OR ALTER VIEW SOFTSITE_VENDEDOR(
    CD_VENDEDOR,
    NM_VENDEDOR)
AS
select VENDEDOR.CODVENDEDOR CD_VENDEDOR,
       VENDEDOR.NOME NM_VENDEDOR
from VENDEDOR
;



/* View: TP_CLI */
CREATE OR ALTER VIEW TP_CLI(
    CODSTATUS,
    DESCRICAO)
AS
select
  CODSTATUS,
  DESCRICAO
from
  STATUS
;



/* View: TP_ESTOQ */
CREATE OR ALTER VIEW TP_ESTOQ(
    CODIGO,
    NOME,
    DESCRICAO,
    QTMINIMA,
    ESTOQUESEGURO,
    VENDEDOR)
AS
SELECT 1  , RAZAOSOCIAL  , '' , '', '', ''  FROM SYSPARAMS
;



/* View: TP_PRODUTO */
CREATE OR ALTER VIEW TP_PRODUTO(
    CODGRUPO,
    DESCRICAO)
AS
select
  CODGRUPO, DESCRICAO
from
  GRUPO
;



/* View: VABASTECIMENTOPICKING */
CREATE OR ALTER VIEW VABASTECIMENTOPICKING(
    DOCUMENTO,
    DATA,
    USUARIO)
AS
select distinct
  cast(M.DOCUMENTO as integer),
  M.DATA,
  M.USUARIO
from
  MOVESTOQUE M
where
  M.TIPODOC = 'AP' and
  M.TIPOMOV = 'S'
;



/* View: VCFOP */
CREATE OR ALTER VIEW VCFOP(
    CODCFOP,
    CFOP)
AS
select
  CFOP.CODCFOP,
  CFOP||' - '||NATUREZA CFOP
from
  CFOP
;



/* View: VCHEQUES */
CREATE OR ALTER VIEW VCHEQUES(
    TIPOCHEQUE,
    ID,
    CODEMPRESA,
    CODCARTAOCRED,
    CODPESSOA,
    CH_CODPESSOA,
    CODCONTABANCO,
    CH_BANCO,
    CH_AGENCIA,
    CH_CONTA,
    CH_NRCHEQUE,
    CH_BOMPARA,
    CH_STATUS,
    DEVOLSTATUS,
    CH_DATAFATC,
    CH_DTCOMPENSADO,
    VLPAGO)
AS
select
  1 TIPOCHEQUE,
  CB.CH_BANCO || CB.CH_AGENCIA || CB.CH_CONTA || CB.CH_NRCHEQUE,
  C.CODEMPRESA,
  CB.CODCARTAOCRED,
  C.CODPESSOA,
  CB.CH_CODPESSOA,
  CB.CODCONTABANCO,
  CB.CH_BANCO,
  CB.CH_AGENCIA,
  CB.CH_CONTA,
  CB.CH_NRCHEQUE,
  CB.CH_BOMPARA,
  CB.CH_STATUS,
  CB.DEVOLSTATUS,
  CB.CH_DATAFATC,
  max(CB.CH_DTCOMPENSADO),
  sum(CB.VLPAGO)
from
  CONTABX CB
  join CONTA C on
    CB.CODCONTA = C.CODCONTA
where
  CB.TIPOPAG in ('CHEQUE','CHEQUE-PRE')
  and C.TIPO              = 'RECEBER'
  and (
    not LER_PARAMBOL('EXIBIR CHEQUES DE TTULOS CANCELADOS')
    or (
      LER_PARAMBOL('EXIBIR CHEQUES DE TTULOS CANCELADOS') AND C.STATUS <> 'CANCELADO'  
    )
  )
  and CB.CH_NRCHEQUE is not null
group by
  1,2,3,4,5,6,7,8,9,10,11,12,13,14,15
union all
select
  2 TIPOCHEQUE,
  C.BANCO || C.AGENCIA || C.CONTA || C.NRCHEQUE,
  null CODEMPRESA,
  null CODCARTAOCRED,
  C.CODPESSOA,
  C.CODPESSOA,
  c.CODCONTABANCO,
  C.BANCO CH_BANCO,
  C.AGENCIA CH_AGENCIA,
  C.CONTA CH_CONTA,
  C.NRCHEQUE CH_NRCHEQUE,
  C.BOMPARA CH_BOMPARA,
  c.status CH_STATUS,
  null,
  null,
  max(c.DTCOMPENSADO) CH_DTCOMPENSADO,
  sum(C.VALOR) VALOR
from
  CHEQUE_AVULSO C
group by
  1,2,3,4,5,6,7,8,9,10,11,12,13,14,15
;



/* View: VEN_VENDEDOR */
CREATE OR ALTER VIEW VEN_VENDEDOR(
    NOME,
    CPFCGC,
    CODVENDEDOR,
    CODSUPERVISOR,
    CODGERENTE,
    QTD,
    VEN_TIPO_META,
    VEN_CD_EMPREGADORA_IMPORT)
AS
SELECT 
  VENDEDOR.NOME AS VEN_NOME,
  VENDEDOR.CPFCGC AS VEN_CPF,
  VENDEDOR.CODVENDEDOR AS VEN_CD_VENDEDOR_IMPORT,
  VENDEDOR.CODSUPERVISOR AS VEN_CD_SUPERVISOR_IMPORT,
  '01' as VEN_CD_GERENTE_IMPORT,
  VENDEDORMETAS.QTD AS VEN_META,
  'QTD' AS VEN_TIPO_META,
  'NULO' AS VEN_CD_EMPREGADORA_IMPORT
FROM
 VENDEDOR
 INNER JOIN VENDEDORMETAS ON (VENDEDOR.CODVENDEDOR=VENDEDORMETAS.CODVENDEDOR)
;



/* View: VENDASPERIODO */
CREATE OR ALTER VIEW VENDASPERIODO(
    CODPRODFILHO,
    PRECOPROD,
    PRECOVEND,
    QTDE,
    DESCRICAO,
    DT_SAIDA)
AS
SELECT PEDVENDITEM.CODPRODFILHO, PEDVENDITEM.PRECOPROD, PEDVENDITEM.PRECOVEND, PEDVENDITEM.QTDE, PRODFILHO.DESCRICAO, Pedvend.DT_SAIDA
FROM PEDVENDITEM,PRODFILHO,Pedvend
where
(PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO) and
(PEDVENDITEM.CODPEDVEND = Pedvend.CODPEDVEND) and
(Pedvend.statusped <> 'CANCELADO')
;



/* View: VEXPORTAPED */
CREATE OR ALTER VIEW VEXPORTAPED(
    NUMPED,
    DATAPED,
    CODCLI,
    CODVEN,
    TIPO,
    PRAZO,
    PAGTO,
    TOTITENS,
    VALTOT,
    ASSINATURA,
    TABELA,
    DESCCOM,
    FRETE)
AS
select
  RIGHT('00000000' || cast(CODPEDVEND as varchar(8)) ,8) as NUMPED,
  cast(DT_SAIDA as date) DATAPED,
  RIGHT('0000000' || cast(CODPESSOA as varchar(7)) ,7) as CODCLI,
  RIGHT('00000' || cast(CODVENDEDOR as varchar(5)) ,5) as CODVEN,
  case TIPOPED
    when 'CADERNO' then 'OR'
  else
    'VD'
  end TIPO,
  RIGHT('000' || cast(coalesce(CODTIPOPAG,1) as varchar(5)) ,3) as PRAZO,
  coalesce((select CODIGO from SLPAGTO where TIPOPAG = PEDVEND.TIPOPAG),'E') PAGTO,
  cast(NRITENS as numeric(6,0)) TOTITENS,
  cast(VALOR_TOTAL as numeric(18,5)) VALTOT,
--  (coalesce(OBSPED1,'')||coalesce(OBSPED2,'')||coalesce(OBSPED3,'')) ASSINATURA,
  '',
  substring(PRECOUSADO from 6 for 1) TABELA,
  cast(DESC_VALOR as numeric(4,0)) DESCCOM,
  case TIPOFRETE
    when 1 then 0
    when 2 then 1
    when 3 then 2
  else
    0
  end FRETE
from
  PEDVEND
;



/* View: VEXPORTAPEDITEM */
CREATE OR ALTER VIEW VEXPORTAPEDITEM(
    NUMPED,
    CODPRO,
    CODAPR,
    PRECO,
    QUANT,
    DESCONTO,
    DATAPED)
AS
SELECT
  RIGHT('00000000' || CAST(pedvend.CODPEDVEND AS VARCHAR(8)) ,8) AS NUMPED,
  RIGHT('00000000' || CAST(CODPRODFILHO AS VARCHAR(7)) ,7) AS CODPRO,
  RIGHT('0000' || '999',4) AS CODAPR,
  CAST(PRECOPROD AS NUMERIC(18,5)) PRECO,
  CAST(QTDENTREGUE AS NUMERIC(6,0)) QUANT,
  CAST(PEDVENDITEM.DESCONTO AS NUMERIC(18,5)),
  cast(DT_SAIDA as date) DATAPED
FROM
  PEDVEND
  INNER JOIN PEDVENDITEM ON PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
;



/* View: VFINANCFORNEC */
CREATE OR ALTER VIEW VFINANCFORNEC(
    DOCUMENTO,
    CODPESSOA,
    PESSOA,
    EMISSAO,
    VENCIMENTO,
    CODPRODUTO,
    CODPESQUISA,
    DESCPRODUTO,
    QTD,
    VALORUNIT,
    VALORTOT,
    DATAVENDA,
    TIPO,
    VALORTOTAL,
    TOTALPAGO)
AS
select
  PEDCPR.CODPEDCPR,
  CONTA.CODPESSOA,
  PESSOA.NOME,
  CONTA.DT_EMISSAO,
  CONTA.DT_VENCIM,
  PEDCPRITENS.CODPRODFILHO,
  PEDCPRITENS.CODPESQUISA,
  PRODFILHO.DESCRICAO,
  PEDCPRITENS.QTDEPEDIDA,
  PEDCPRITENS.VALOR_UNIT,
  PEDCPRITENS.VALORITEM,
  PEDCPR.DT_EMISSAO EMISSAO,
  CONTA.TIPO,
  SUM(coalesce(CONTA.VLPARCELA,0)) VALORTOTAL,
  SUM(coalesce(CONTABX.VLPAGO,0)) TOTPAGO
from
  CONTA
  inner join PEDCPR on PEDCPR.CODPEDCPR = CONTA.CODPEDCOMPRA
  inner join PEDCPRITENS on PEDCPRITENS.CODPEDCPR = PEDCPR.CODPEDCPR
  inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDCPRITENS.CODPRODFILHO
  inner join PESSOA on PESSOA.CODPESSOA = CONTA.CODPESSOA
  left join CONTABX on CONTABX.CODCONTA = CONTA.CODCONTA
where
  CONTA.STATUS = 'ABERTO' and
  CONTA.TIPO = 'PAGAR'
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
union
select
  PEDVEND.CODPEDVEND,
  CONTA.CODPESSOA,
  PESSOA.NOME,
  CONTA.DT_EMISSAO,
  CONTA.DT_VENCIM,
  PEDVENDITEM.CODPRODFILHO,
  PEDVENDITEM.CODPESQUISA,
  PRODFILHO.DESCRICAO,
  PEDVENDITEM.QTDE,
  PEDVENDITEM.PRECOPROD,
  PEDVENDITEM.PRECOVEND,
  PEDVEND.DT_SAIDA DATA,
  CONTA.TIPO,
  SUM(coalesce(CONTA.VLPARCELA,0)) VALORTOTAL,
  SUM(coalesce(CONTABX.VLPAGO,0)) TOTPAGO
from
  CONTA
  inner join PEDVEND on PEDVEND.CODPEDVEND = CONTA.CODPENDVEND
  inner join PEDVENDITEM on PEDVENDITEM.CODPEDVENDITEM = PEDVEND.CODPEDVEND
  inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
  inner join PESSOA on PESSOA.CODPESSOA = CONTA.CODPESSOA
  left join CONTABX on CONTABX.CODCONTA = CONTA.CODCONTA
where
  CONTA.STATUS = 'ABERTO' and
  CONTA.TIPO = 'RECEBER'
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
;



/* View: VIEW_CFOP */
CREATE OR ALTER VIEW VIEW_CFOP(
    CFOP,
    NATUREZA)
AS
SELECT DISTINCT CFOP, NATUREZA FROM CFOP
;



/* View: VIEW_ESTOQUE */
CREATE OR ALTER VIEW VIEW_ESTOQUE(
    CODPRODFILHO,
    ESTQATUAL)
AS
select
  CODPRODFILHO, CAST(ESTQATUAL AS NUMERIC(10,2)) AS ESTQATUAL
from
  PRODFILHO
    INNER JOIN PRODUTO ON (PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO)
where PRODUTO.ATIVO = 2
;



/* View: VIEW_PESQUISA_PRODUTOS */
CREATE OR ALTER VIEW VIEW_PESQUISA_PRODUTOS(
    CODPRODFILHO,
    CODPRODUTO,
    CODPESQ1,
    ATIVO,
    DESCRICAO,
    PRECOPRATICADO1,
    PRECOPRATICADO2,
    PRECOPRATICADO3,
    PRECOPRATICADO4,
    PRECOPRATICADO5,
    PRECOPRATICADO6,
    ESTQATUAL,
    CONFERENCIA,
    CLASSFISCAL,
    CODIGOCEST,
    CFOP,
    PRDF_CST_TRIBICMS,
    TRIBUTACAO)
AS
SELECT
    prodfilho.codprodfilho,
    produto.codproduto,
    prodfilho.codpesq1,
    CASE produto.ativo
        WHEN 1 THEN 'N'
        ELSE 'S'
    END AS "ATIVO",
    prodfilho.descricao,
    prodfilho.precopraticado1,
    prodfilho.precopraticado2,
    prodfilho.precopraticado3,
    prodfilho.precopraticado4,
    prodfilho.precopraticado5,
    prodfilho.precopraticado6,
    prodfilho.estqatual,
    (SELECT SALDO FROM stp_retorna_fiscais(prodfilho.codprodfilho,(SELECT CODEMPRESA FROM empresa))) AS CONFERENCIA,
    prodfilho.classfiscal,
    cest.codigocest,
    cfop.cfop,
    prodfilho.prdf_cst_tribicms,
    distintivos_cfop.descricao AS TRIBUTACAO
FROM
    prodfilho
INNER JOIN
    produto ON(prodfilho.codproduto = produto.codproduto)
LEFT JOIN
    CFOP ON (prodfilho.codcfopvendadentro = cfop.codcfop)
LEFT JOIN
    CEST ON (prodfilho.codcest = CEST.codcest)
LEFT JOIN
    distintivos_cfop ON (distintivos_cfop.coddistintivos_cfop = prodfilho.prdf_distintivo)
WHERE
    produto.ativopesq = 1
;



/* View: VIEW_PRODUTO */
CREATE OR ALTER VIEW VIEW_PRODUTO(
    CODPRODFILHO,
    CODFORNEC,
    CODGRUPO,
    CODUNIDADE,
    DESCRICAO,
    OBS,
    QTDEMBALAGEM,
    ACEITARPERDA,
    PESO_PECA)
AS
select
        CODPRODFILHO, (SELECT FIRST 1 CODPESSOA FROM PRODPESSOA WHERE CODPRODUTO = PRODFILHO.CODPRODFILHO) CODFORNEC,
       CODGRUPO, CODUNIDADE, PRODFILHO.DESCRICAO, OBS, QTDEMBALAGEM, coalesce(ACEITARPERDA, 'N') ACEITARPERDA, PRODFILHO.PESO_PECA
      from
        PRODFILHO
        INNER JOIN PRODUTO ON (PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO)
      where PRODUTO.ATIVO = 2
;



/* View: VIEW_UNIDADE */
CREATE OR ALTER VIEW VIEW_UNIDADE(
    CODUNIDADE,
    SIGLA,
    TRAVA_FRACIONADO)
AS
select
   codunidade,
   sigla,
   trava_fracionado
from
  UNIDADE
;



/* View: VIEWREL12 */
CREATE OR ALTER VIEW VIEWREL12(
    CODVEND,
    TIP_PEDIDO,
    CODGRUPO,
    CODSUBGRUPO,
    VLR_BRUTO,
    VLR_TOTAL,
    SAIDA,
    FATORDESCONTO,
    PEDIDO,
    DESC_VALOR,
    DESCPERC_VALOR,
    ITENSVENDIDOS,
    CODFABRICANTE,
    FORNECEDOR,
    CLIENTE)
AS
select
  PEDVEND.CODVENDEDOR,
  PEDVEND.TIPOPED,
  PRODUTO.CODGRUPO,
  PRODUTO.CODSUBGRUPO,
  (PEDVENDITEM.PRECOPROD * PEDVENDITEM.QTDE),
  PEDVENDITEM.PRECOVEND,
  PEDVEND.DT_SAIDA,
  (PEDVENDITEM.PRECOVEND / coalesce(nullif(PEDVEND.VALOR_BRUTO,0),1)),
  PEDVEND.CODPEDVEND,
  coalesce(PEDVEND.DESC_VALOR,0),
  coalesce(PEDVEND.DESCPERC_VALOR,0),
  PEDVENDITEM.CODPEDVENDITEM,
  PRODUTO.CODFABRICANTE,
  PRODPESSOA.CODPESSOA,
  PEDVEND.CODPESSOA
from
  PEDVEND
  join PEDVENDITEM on
    PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
  join PRODFILHO on
    PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
  join PRODPESSOA on
    PRODFILHO.CODPRODUTO = PRODPESSOA.CODPRODUTO
  join PRODUTO on
    PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
;



/* View: VISAOGRUPO */
CREATE OR ALTER VIEW VISAOGRUPO(
    CODGRUPO,
    DESCRICAO)
AS
SELECT GRUPO.CODGRUPO, GRUPO.DESCRICAO FROM GRUPO
;



/* View: VISAOPRODUTO */
CREATE OR ALTER VIEW VISAOPRODUTO(
    CODPRODFILHO,
    DESCRICAO,
    CODGRUPO,
    CODSUBGRUPO,
    OBS)
AS
SELECT A.CODPRODFILHO as CODIGO, B.DESCRICAO as DESCRICAO,B.CODGRUPO as GRUPO,
  B.CODSUBGRUPO as SUBGRUPO, B.OBS as OBSERVACAO
  FROM PRODFILHO A, PRODUTO B  where a.CODPRODUTO = B.CODPRODUTO
;



/* View: VISAORANCKINGVENDAS */
CREATE OR ALTER VIEW VISAORANCKINGVENDAS(
    TOTAL_QTD,
    TOTAL_VALOR,
    DESCRICAO,
    CODGRUPO,
    DESC_GRUPO,
    CODSUBGRUPO,
    DESC_SUBGRUPO)
AS
select sum(qtde) TOTAL_QTD, SUM(PRECOVEND) TOTAL_VALOR,  PRODFILHO.DESCRICAO,
PRODUTO.CODGRUPO,  GRUPO.DESCRICAO DESC_GRUPO, PRODUTO.CODSUBGRUPO, SUBGRUPO.DESCRICAO DESC_SUBGRUPO
 from pedvenditem
inner join PRODFILHO on (PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO)
inner join PRODUTO on (PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO)
inner join GRUPO on (GRUPO.CODGRUPO = PRODUTO.CODGRUPO)
inner join SUBGRUPO on (SUBGRUPO.CODSUBGRUPO = PRODUTO.CODSUBGRUPO)
group by 3,4,5,6,7
;



/* View: VISAOSUBGRUPO */
CREATE OR ALTER VIEW VISAOSUBGRUPO(
    CODSUBGRUPO,
    DESCRICAO,
    CODGRUPO)
AS
SELECT SUBGRUPO.CODSUBGRUPO, SUBGRUPO.DESCRICAO, SUBGRUPO.CODGRUPO FROM SUBGRUPO
;



/* View: VNFENTRADAITENS */
CREATE OR ALTER VIEW VNFENTRADAITENS(
    CODNFENTRADAITENS,
    CODNFENTRADA,
    CODPRODFILHO,
    CODPESQUISA,
    IPIPERC,
    QTD,
    PRODVLR,
    DIFICMS,
    DESPESASRATEADAS,
    FRETERATEADO,
    SEGURORATEADO,
    DESCONTORATEADO,
    PRECOSUGERIDO,
    ATUALIZAPRECO,
    PRECOCOMPRAANTERIOR,
    CODUNIDADE,
    CODPEDCPR,
    CODPEDCPRITENS,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    MARKUP1,
    MARKUP2,
    MARKUP3,
    MARKUP4,
    MARKUP5,
    MARKUP6,
    VALORTOTAL,
    ATZMARK,
    ATZPREC,
    VL_IPIPERC,
    VL_DIFICMS,
    FRETEPERCLTDA,
    FRETEVLRLTDA,
    IPISOBREFRETE,
    ICMSSOBREFRETE,
    FRETEAVULSO,
    CUSTOREPOSI,
    CODCFOP,
    CFOP_CFOP,
    QTDEM3,
    ALIQ_SUBS,
    PERC_VA,
    VA_VALOR,
    BASE_SUBS,
    VALOR_SUBS,
    PESO,
    GNRE_TOTAL,
    TOTAL_NOTA,
    CUSTO_UNIT_IPI_GNRE,
    TOTAL_FRETE_PESO,
    TOTAL_FRETE_VALOR,
    CUSTO_TOTAL,
    CUSTO_UNITARIO,
    TOTALCOMIPI,
    CUSTOUNITCOMIPI,
    QTD_CAIXA,
    VALOR_CAIXA,
    QTDPECAS,
    COD_PROD_MARGEM,
    DESCTO_ITEM,
    DESCTO_ABC,
    NFEI_DESCAUX,
    QTD_VIACEGA,
    QTD_PEDIDO,
    DT_FABRICACAO,
    DT_VALIDADE,
    SITUACAO_VALIDADE,
    FATORCONVERSAO,
    DESCTO_ITEM_PERC,
    PERC_REDUCAO,
    AUX_PESOEMB,
    DESC_PRODFILHO_AUX,
    PRECOSUGERIDO1,
    PRECOSUGERIDO2,
    PRECOSUGERIDO3,
    PRECOSUGERIDO4,
    PRECOSUGERIDO5,
    PRECOSUGERIDO6,
    CODPRODUTO,
    DESC_PRECOPRATICADO1,
    AUX_FATORPROD,
    QTDPRODEMB,
    AUX_COD3,
    VALORTOT_CALC,
    TOTPROD,
    FRETEVLRCALC,
    IPI_VALOR,
    ICMS_VALOR,
    FRETAVULSOCALC,
    VAL_VA,
    VAL_BASESUBS,
    VAL_SUBS,
    UNIDADE,
    CODPESQ1,
    CODPESQ2,
    PISPERC,
    PISVALOR,
    COFINSPERC,
    COFINSVALOR,
    FRETESOBREIPI,
    BASE_IPI,
    STATUS,
    DESC_UNIDADE,
    DESC_CFOP_CFOP)
AS
select
  NI.CODNFENTRADAITENS,
  NI.CODNFENTRADA,
  NI.CODPRODFILHO,
  NI.CODPESQUISA,
  NI.IPIPERC,
  NI.QTD,
  NI.PRODVLR,
  NI.DIFICMS,
  NI.DESPESASRATEADAS,
  NI.FRETERATEADO,
  NI.SEGURORATEADO,
  NI.DESCONTORATEADO,
  NI.PRECOSUGERIDO,
  NI.ATUALIZAPRECO,
  NI.PRECOCOMPRAANTERIOR,
  NI.CODUNIDADE,
  NI.CODPEDCPR,
  NI.CODPEDCPRITENS,
  NI.US_CADAST,
  NI.DT_CADAST,
  NI.US_MODIFI,
  NI.DT_MODIFI,
  NI.MARKUP1,
  NI.MARKUP2,
  NI.MARKUP3,
  NI.MARKUP4,
  NI.MARKUP5,
  NI.MARKUP6,
  NI.VALORTOTAL,
  NI.ATZMARK,
  NI.ATZPREC,
  NI.VL_IPIPERC,
  NI.VL_DIFICMS,
  NI.FRETEPERCLTDA,
  NI.FRETEVLRLTDA,
  NI.IPISOBREFRETE,
  NI.ICMSSOBREFRETE,
  NI.FRETEAVULSO,
  NI.CUSTOREPOSI,
  NI.CODCFOP,
  NI.CFOP_CFOP,
  NI.QTDEM3,
  NI.ALIQ_SUBS,
  NI.PERC_VA,
  NI.VA_VALOR,
  NI.BASE_SUBS,
  NI.VALOR_SUBS,
  NI.PESO,
  NI.GNRE_TOTAL,
  NI.TOTAL_NOTA,
  NI.CUSTO_UNIT_IPI_GNRE,
  NI.TOTAL_FRETE_PESO,
  NI.TOTAL_FRETE_VALOR,
  NI.CUSTO_TOTAL,
  NI.CUSTO_UNITARIO,
  NI.TOTALCOMIPI,
  NI.CUSTOUNITCOMIPI,
  NI.QTD_CAIXA,
  NI.VALOR_CAIXA,
  NI.QTDPECAS,
  NI.COD_PROD_MARGEM,
  NI.DESCTO_ITEM,
  NI.DESCTO_ABC,
  NI.NFEI_DESCAUX,
  NI.QTD_VIACEGA,
  NI.QTD_PEDIDO,
  NI.DT_FABRICACAO,
  NI.DT_VALIDADE,
  NI.SITUACAO_VALIDADE,
  NI.FATORCONVERSAO,
  NI.DESCTO_ITEM_PERC,
  NI.PERC_REDUCAO,
  coalesce(PF.PRDF_PESOEMBALAGEM,1)  AUX_PESOEMB,
  PF.DESCRICAO  DESC_PRODFILHO_AUX,
  coalesce(PF.PRECOSUGERIDO1,0) PRECOSUGERIDO1,
  coalesce(PF.PRECOSUGERIDO2,0) PRECOSUGERIDO2,
  coalesce(PF.PRECOSUGERIDO3,0) PRECOSUGERIDO3,
  coalesce(PF.PRECOSUGERIDO4,0) PRECOSUGERIDO4,
  coalesce(PF.PRECOSUGERIDO5,0) PRECOSUGERIDO5,
  coalesce(PF.PRECOSUGERIDO6,0) PRECOSUGERIDO6,
  PF.CODPRODUTO CODPRODUTO,
  coalesce(PF.PRECOPRATICADO1,0) DESC_PRECOPRATICADO1,
  coalesce(PF.FATORCONVERSAO,0) AUX_FATORPROD,
  coalesce(NI.QTDPRODEMB, PF.QTDEMBALAGEM,1) QTDPRODEMB,
  coalesce(PF.CODPESQ3,'') AUX_COD3,
  coalesce((NI.QTD * NI.PRODVLR - NI.DESCTO_ITEM),0) VALORTOT_CALC,
  coalesce(((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0)) + coalesce(NI.FRETEVLRLTDA,0) + ((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) * (coalesce(NI.FRETEPERCLTDA,0) / 100)) - coalesce(NI.DESCTO_ITEM,0)),0) TOTPROD,
  coalesce(((NI.PRODVLR * NI.QTD) * (NI.FRETEPERCLTDA / 100)),0) FRETEVLRCALC,
  case (select TIPOEMPRESA from SYSPARAMS)
    when 1 then
      case coalesce(NI.IPISOBREFRETE,'N')
        when 'S' then
        coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
      else
        coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.IPIPERC,0) / 100))),0)
      end
  else
    case coalesce(NI.IPISOBREFRETE,'N')
      when 'S' then
      coalesce((((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) - coalesce(NI.DESCTO_ITEM,0) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
    else
      coalesce((((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
    end
  end IPI_VALOR,
  case (select TIPOEMPRESA from SYSPARAMS)
    when 1 then
    case coalesce(NI.ICMSSOBREFRETE,'N')
      when 'S' then
      coalesce(((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.DIFICMS,0) / 100),0)
    else
      case (select SYS_OPTANTESIMPLES from SYSPARAMS)
        when 'S' then
        (((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) +
        (case (select TIPOEMPRESA from SYSPARAMS)
          when 1 then
          case NI.IPISOBREFRETE
            when 'S' then
            coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
          else
            coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.IPIPERC,0) / 100))),0)
          end
        else
          case NI.IPISOBREFRETE
            when 'S' then
            coalesce(((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) - ((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.PERC_REDUCAO,0) / 100))) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
          else
            coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) - ((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.PERC_REDUCAO,0) / 100))) * (coalesce(NI.IPIPERC,0) / 100)),0)
          end
        end)) * (coalesce(NI.DIFICMS,0) / 100))
      else
        (((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) - ((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.PERC_REDUCAO,0) / 100)))  * (coalesce(NI.DIFICMS,0) / 100))
      end
    end
  else
    case coalesce(NI.ICMSSOBREFRETE,'N')
      when 'S' then
      coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) - ((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.PERC_REDUCAO,0) / 100))) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.DIFICMS,0) / 100),0)
    else
      coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) - ((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.PERC_REDUCAO,0) / 100))) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.DIFICMS,0) / 100),0)
    end
  end ICMS_VALOR,
  coalesce(((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) +
  (case (select TIPOEMPRESA from SYSPARAMS)
    when 1 then
    case coalesce(NI.IPISOBREFRETE,'N')
      when 'S' then
      coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
    else
      coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.IPIPERC,0) / 100))),0)
    end
  else
    case coalesce(NI.IPISOBREFRETE,'N')
      when 'S' then
      coalesce((((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
    else
      coalesce((((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
    end
  end) * (coalesce(NI.FRETEAVULSO,0) / 100)),0) FRETAVULSOCALC,
  coalesce((coalesce((((NI.QTD * NI.PRODVLR) + coalesce(NI.FRETEVLRLTDA,0)) + ((NI.PRODVLR * NI.QTD) * (coalesce(NI.FRETEPERCLTDA,0) / 100)) - coalesce(NI.DESCTO_ITEM,0)),0) * (coalesce(NI.PERC_VA,0) / 100)),0) VAL_VA,
  ((coalesce((coalesce((((NI.QTD * NI.PRODVLR) + coalesce(NI.FRETEVLRLTDA,0)) + ((NI.PRODVLR * NI.QTD) * (coalesce(NI.FRETEPERCLTDA,0) / 100)) - coalesce(NI.DESCTO_ITEM,0)),0) * (coalesce(NI.PERC_VA,0) / 100)),0))+(coalesce(((NI.QTD * NI.PRODVLR) + coalesce(NI.FRETEVLRLTDA,0) + ((NI.PRODVLR * NI.QTD) * (coalesce(NI.FRETEPERCLTDA,0) / 100)) - coalesce(NI.DESCTO_ITEM,0)),0))) VAL_BASESUBS,
  ((coalesce((coalesce((((NI.QTD * NI.PRODVLR) + coalesce(NI.FRETEVLRLTDA,0)) + ((NI.PRODVLR * NI.QTD) * (coalesce(NI.FRETEPERCLTDA,0) / 100)) - coalesce(NI.DESCTO_ITEM,0)),0) * (coalesce(NI.PERC_VA,0) / 100)),0))+(coalesce(((NI.QTD * NI.PRODVLR) + coalesce(NI.FRETEVLRLTDA,0) + ((NI.PRODVLR * NI.QTD) * (coalesce(NI.FRETEPERCLTDA,0) / 100)) - coalesce(NI.DESCTO_ITEM,0)),0))) * (NI.ALIQ_SUBS / 100) VAL_SUBS,
  PF.UNIDADE,
  PF.CODPESQ1,
  PF.CODPESQ2,
  NI.PISPERC,
  NI.PISVALOR,
  NI.COFINSPERC,
  NI.COFINSVALOR,
  NI.FRETESOBREIPI,
  NI.BASE_IPI,
  NI.STATUS,
  '',
  ''
from
  NFENTRADAITENS NI
  join NFENTRADA N on N.CODNFENTRADA = NI.CODNFENTRADA
  join PRODFILHO PF on PF.CODPRODFILHO = NI.CODPRODFILHO
;



/* View: VNFVENDAITEM */
CREATE OR ALTER VIEW VNFVENDAITEM(
    CODNFVENDAITEM,
    CODNFVENDA,
    CODPRODFILHO,
    QTDE,
    PRECOTAB,
    PRECOVEND,
    DESCVLR,
    IPIPERC,
    TOTALVLR,
    BAIXARESTOQ,
    DESCPERC,
    CODUNIDADE,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    CODPESQUISA,
    IPIVALOR,
    ICMSPERC,
    ICMSVALOR,
    CODPEDVENDITEM,
    CODPEDVEND,
    CUSTOMEDIO,
    CUSTOREPOSI,
    QTDEEMBALAGEM,
    PRECOUSADO,
    TRATESP,
    NFV_TIPO,
    CODCFOP,
    CFOP_CFOP,
    NATUREZA,
    SERIE,
    DESC_TOTAL,
    TOTAL,
    EMBCALC,
    VAL_IPI,
    VAL_ICMS,
    DESC_CALC,
    LKDESCRICAO2,
    QTDPRODEMB,
    AUX_DADOS1,
    AUX_DADOS2,
    AUX_DADOS3,
    AUX_DADOS4,
    AUX_DADOS5,
    AUX_DADOS6,
    AUX_DADOS7,
    DESC_PRODFILHO_AUX,
    DESCCSTB,
    DESCCSTA,
    DESC_LETRA,
    DESC_CLASSIFICAL,
    DESC_UNIDADE,
    CFOP_REDUZIDO,
    CFOP_NORMAL,
    CFOP_NATUREZA,
    CFOP_CFOPN)
AS
select
   NFVENDAITEM.CODNFVENDAITEM,
   NFVENDAITEM.CODNFVENDA,
   NFVENDAITEM.CODPRODFILHO,
   NFVENDAITEM.QTDE,
   NFVENDAITEM.PRECOTAB,
   NFVENDAITEM.PRECOVEND,
   NFVENDAITEM.DESCVLR,
   NFVENDAITEM.IPIPERC,
   NFVENDAITEM.TOTALVLR,
   NFVENDAITEM.BAIXARESTOQ,
   NFVENDAITEM.DESCPERC,
   NFVENDAITEM.CODUNIDADE,
   NFVENDAITEM.US_CADAST,
   NFVENDAITEM.DT_CADAST,
   NFVENDAITEM.US_MODIFI,
   NFVENDAITEM.DT_MODIFI,
   NFVENDAITEM.CODPESQUISA,
   NFVENDAITEM.IPIVALOR,
   NFVENDAITEM.ICMSPERC,
   NFVENDAITEM.ICMSVALOR,
   NFVENDAITEM.CODPEDVENDITEM,
   NFVENDAITEM.CODPEDVEND,
   NFVENDAITEM.CUSTOMEDIO,
   NFVENDAITEM.CUSTOREPOSI,
   NFVENDAITEM.QTDEEMBALAGEM,
   NFVENDAITEM.PRECOUSADO,
   NFVENDAITEM.TRATESP,
   NFVENDAITEM.NFV_TIPO,
   NFVENDAITEM.CODCFOP,
   NFVENDAITEM.CFOP_CFOP,
   NFVENDAITEM.NATUREZA,
   NFVENDAITEM.SERIE,
  (NFVENDAITEM.DESCVLR + ((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) * (NFVendaItem.DESCPERC / 100))) desc_total,
  ((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) - ((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) * (NFVendaItem.DESCPERC / 100))) total,
  (NFVendaItem.QTDE * coalesce(nullif(PRODFILHO.QTDEMBALAGEM,0),1)) embcalc,
  (((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) - ((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) * (NFVendaItem.DESCPERC / 100))) * (NFVendaItem.IPIPERC / 100)) val_ipi,
  (((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) - ((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) * (NFVendaItem.DESCPERC / 100))) * (NFVendaItem.ICMSPERC / 100)) val_icms,
  ((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) * (NFVendaItem.DESCPERC / 100)) desc_calc,
  PRODFILHO.DADOS1 lkdescricao2,
  PRODFILHO.QTDEMBALAGEM qtdprodemb,
  PRODFILHO.DADOS1 aux_dados1,
  PRODFILHO.DADOS2 aux_dados2,
  PRODFILHO.DADOS3 aux_dados3,
  PRODFILHO.DADOS4 aux_dados4,
  PRODFILHO.DADOS5 aux_dados5,
  PRODFILHO.DADOS6 aux_dados6,
  PRODFILHO.DADOS7 aux_dados7,
  PRODFILHO.DESCRICAO desc_prodfilho_aux,
  PRODFILHO.PRDF_CST_TRIBICMS descCSTB,
  PRODFILHO.PRDF_CST_ORIGEM_MERCADORIA descCSTA,
  PRODFILHO.PRDF_LETRA desc_Letra,
  PRODFILHO.CLASSFISCAL desc_classifical,
  UNIDADE.SIGLA desc_unidade,
  CFOP.IRED cfop_reduzido,
  CFOP.ICMS cfop_normal,
  CFOP.NATUREZA cfop_natureza,
  CFOP.CFOP cfop_cfopn
from
  NFVENDAITEM
  join PRODFILHO on PRODFILHO.CODPRODFILHO = NFVENDAITEM.CODPRODFILHO
  join UNIDADE on UNIDADE.CODUNIDADE = PRODFILHO.CODUNIDADE
  left join CFOP on CFOP.CODCFOP = NFVENDAITEM.CODCFOP
;



/* View: VPESQ_SUBGRUPO */
CREATE OR ALTER VIEW VPESQ_SUBGRUPO(
    CODSUBGRUPOEV,
    GRUPO,
    SUBGRUPO,
    CODMODELO_CARDAPIO)
AS
select distinct
  SBA.CODSUBGRUPOEVAUX,
  GB.DESCRICAO,
  SB.DESCRICAO,
  MC.CODMODELO_CARDAPIO
from
  MODELO_CARDAPIO MC
  left join SUBGRUPO_EVENTOS_AUX SBA on SBA.CODMODELO_CARDAPIO=MC.CODMODELO_CARDAPIO
  left join SUBGRUPO_EVENTOS SB on SB.CODSUBGRUPOEV=SBA.CODSUBGRUPOEV
  left join GRUPO_EVENTOS GB on GB.CODGRUPOEV=SBA.CODGRUPOEV
;



/* View: VPESQUISAVENDA */
CREATE OR ALTER VIEW VPESQUISAVENDA(
    CODPEDVEND,
    CODNFVENDA,
    STATUSPED,
    TIPOPED,
    CODPESSOA,
    PESSOA,
    CODVENDEDOR,
    VENDEDOR,
    DT_SAIDA,
    VALOR_BRUTO,
    VALOR_TOTAL,
    NRFORMULARIO)
AS
select
  PEDVEND.CODPEDVEND,
  coalesce(CODFATURAMENTO, CODNFVENDA) CODNFVENDA,
  PEDVEND.STATUSPED,
  PEDVEND.TIPOPED,
  PEDVEND.CODPESSOA,
  PESSOA.NOME PESSOA,
  PEDVEND.CODVENDEDOR,
  VENDEDOR.NOME VENDEDOR,
  PEDVEND.DT_SAIDA,
  PEDVEND.VALOR_BRUTO,
  PEDVEND.VALOR_TOTAL,
  PEDVEND.NRFORMULARIO
from
  PEDVEND
  join PESSOA ON PEDVEND.CODPESSOA = PESSOA.CODPESSOA
  join VENDEDOR on PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
;



/* View: VPRODUTIVIDADE */
CREATE OR ALTER VIEW VPRODUTIVIDADE(
    CODPRODUTIVIDADE,
    DATA,
    CODOPERACAO,
    DESCRICAO,
    PECAS,
    TEMPO,
    PADRAO,
    CODFUNCIONARIO,
    NOME,
    COD_MAQUINA)
AS
SELECT
  TPO.CODPRODUTIVIDADE,
  TPO.DATA,
  TPO.CODOPERACAO,
  TBO.DESCRICAO,
  TPO.PECAS,
  TPO.TEMPO,
  TPO.PADRAO,
  TPO.CODFUNCIONARIO,
  F.NOME,
  TPO.COD_MAQUINA
FROM
  TBL_PRODUTIVIDADE_OPERACAO TPO
INNER JOIN TBL_OPERACAO TBO ON TBO.COD_OPERACAO=TPO.CODOPERACAO
INNER JOIN FUNCIONARIO F ON F.FUNC_COD=TPO.CODFUNCIONARIO
;



/* View: VTRANSFEREPRODFILHOLOTES */
CREATE OR ALTER VIEW VTRANSFEREPRODFILHOLOTES(
    CODPRODFILHO,
    CODPESQ1,
    DESCRICAO,
    LOCALIZACAO,
    ESTQATUAL,
    QTDPICKING,
    QTDMOV,
    ABASTECER)
AS
select
  P.CODPRODFILHO,
  P.CODPESQ1,
  P.DESCRICAO,
  P.LOCALIZACAO,
  P.ESTQATUAL,
  coalesce(P.QTDPICKING, 0),
  coalesce(sum(PL.QTDMOV), 0),
  coalesce(P.QTDPICKING, 0) - coalesce(sum(PL.QTDMOV), 0)
from
  PRODFILHO P
  left join PRODFILHOLOTES PL on
    P.CODPRODFILHO = PL.CODPRODFILHO and
    P.LOCALIZACAO  = PL.LOTE
where
  coalesce(P.ESTQATUAL, 0) > 0 and
  coalesce((select
             sum(PFL.QTDMOV)
           from
             PRODFILHO PF
             join PRODFILHOLOTES PFL on
               PF.CODPRODFILHO = PFL.CODPRODFILHO
           where
             PF.CODPRODFILHO = P.CODPRODFILHO and
             PF.LOCALIZACAO <> PFL.LOTE), 0) > 0
group by
  P.CODPRODFILHO,
  P.CODPESQ1,
  P.DESCRICAO,
  P.LOCALIZACAO,
  P.ESTQATUAL,
  P.QTDPICKING
having
  (coalesce(P.QTDPICKING, 0) - coalesce(sum(PL.QTDMOV), 0) <> 0)
;



/* View: VVENDEDOR */
CREATE OR ALTER VIEW VVENDEDOR(
    CODVENDEDOR,
    NOME)
AS
select
  CODVENDEDOR,
  NOME
from
  VENDEDOR
;



/* View: VW_MESES */
CREATE OR ALTER VIEW VW_MESES(
    MES,
    NOME)
AS
SELECT
  LISTA.MES,
  CASE LISTA.MES
    WHEN 1 THEN 'JAN'
    WHEN 2 THEN 'FEV'
    WHEN 3 THEN 'MAR'
    WHEN 4 THEN 'ABR'
    WHEN 5 THEN 'MAI'
    WHEN 6 THEN 'JUN'
    WHEN 7 THEN 'JUL'
    WHEN 8 THEN 'AGO'
    WHEN 9 THEN 'SET'
    WHEN 10 THEN 'OUT'
    WHEN 11 THEN 'NOV'
    WHEN 12 THEN 'DEZ'
  END NOME
FROM
(
    WITH RECURSIVE R AS (
    SELECT 1 MES FROM RDB$DATABASE
    UNION ALL
    SELECT
      R.MES + 1
    FROM R
    WHERE
      R.MES < 12
  )
  SELECT * FROM R
) LISTA
;



/* View: VW_SEGMENTOS */
CREATE OR ALTER VIEW VW_SEGMENTOS(
    CODSEGMENTO,
    SEGMENTO)
AS
WITH RECURSIVE R AS (
  SELECT
    SEGMENTOS.CODSEGMENTO,
    SEGMENTOS.SEGMENTO,
    SEGMENTOS.CODSEGMENTOPAI
  FROM
    SEGMENTOS
  WHERE
    SEGMENTOS.CODSEGMENTOPAI IS NULL
  UNION ALL
  SELECT
    SEGMENTOS.CODSEGMENTO,
    R.SEGMENTO || ' >> ' || SEGMENTOS.SEGMENTO,
    SEGMENTOS.CODSEGMENTOPAI
  FROM R
    JOIN SEGMENTOS ON
      SEGMENTOS.CODSEGMENTOPAI = R.CODSEGMENTO
)
SELECT
  CODSEGMENTO,
  SEGMENTO
FROM
  R
WHERE
  NOT EXISTS(SELECT * FROM SEGMENTOS SEG WHERE SEG.CODSEGMENTOPAI = R.CODSEGMENTO)
order by
  r.CODSEGMENTOPAI, SEGMENTO
;



/* View: VWFERIADOS */
CREATE OR ALTER VIEW VWFERIADOS(
    CODFERIADOS,
    DESCRICAO,
    INICIAL,
    FINAL)
AS
select
  CODFERIADOS,
  DESCRICAO,
  DIAINI||'/'||MESINI INICIAL,
  DIAFIM||'/'||MESFIM FINAL
from
  TBL_FERIADOS
;

-- STRLEN
SET TERM ^ ;

ALTER PROCEDURE AGILIS_IMPORTAVENDA_NFCE(
    ECODPEDVEND INTEGER,
    ECODEMPRESA INTEGER = 0)
RETURNS (
    CODPEDVEND INTEGER,
    EMISSAO DATE,
    CODPESSOA INTEGER,
    NOMEPESSOA VARCHAR(60),
    CPFCGCPESSOA VARCHAR(18),
    BAIRRO_1 VARCHAR(45),
    CEP_1 VARCHAR(9),
    CIDADE_1 VARCHAR(45),
    CODIBGE INTEGER,
    COMPLEMENTO_1 VARCHAR(60),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    UF_1 CHAR(2),
    CODVENDEDOR INTEGER,
    NOMEVENDEDOR VARCHAR(60),
    NUMNFCE INTEGER,
    SERIENFCE VARCHAR(10),
    VALOR_BRUTO DOUBLE PRECISION,
    LVALOR_BRUTO DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESC_VALOR NUMERIC(15,2),
    ACRESCIMO DOUBLE PRECISION,
    ACRES_VALOR NUMERIC(15,2),
    VALOR_PAGO DOUBLE PRECISION,
    NRITENS INTEGER,
    CODPEDVENDITEM INTEGER,
    CODPRODFILHO INTEGER,
    CODPESQUISA VARCHAR(30),
    PRECOPROD DOUBLE PRECISION,
    QTDE DOUBLE PRECISION,
    DESC_VALORITEM DOUBLE PRECISION,
    PRECOVEND NUMERIC(15,2),
    CONTITEM INTEGER,
    DESCR_PRODUTO VARCHAR(60),
    ALIQUOTAICMS DOUBLE PRECISION,
    UNIDADEMED VARCHAR(5),
    TRIBUTADO VARCHAR(1),
    NCM_CODIGO VARCHAR(8),
    CODIGOCEST VARCHAR(7),
    PRECOUSADO VARCHAR(10),
    PRDF_CST_ORIGEM_MERCADORIA SMALLINT,
    PRDF_CST_TRIBICMS CHAR(3),
    PERC_COFINS DOUBLE PRECISION,
    PERC_PIS DOUBLE PRECISION,
    CSTPIS CHAR(2),
    CFOP VARCHAR(4),
    CODCLASSIFICACAOSERVICO VARCHAR(5),
    ALIQUOTAISS DOUBLE PRECISION,
    PRECOPRODTABELA DOUBLE PRECISION,
    CODDAV INTEGER,
    PERC_REDUCAO_ICMS DOUBLE PRECISION,
    OBSERVACOES BLOB SUB_TYPE TEXT SEGMENT SIZE 80,
    CODANP VARCHAR(30),
    DESCANP VARCHAR(95),
    LOTE VARCHAR(200),
    DATAVAL VARCHAR(10),
    DATAFAB VARCHAR(10),
    QTDLOTE DOUBLE PRECISION)
AS
declare variable LCODPESSOAVENDA integer;
declare variable LCEP varchar(9);
declare variable LCODIBGE integer;
declare variable LCODEMPRESA integer;
declare variable LCODCEST integer;
declare variable LVALORDESCONTO double precision;
declare variable LFATOR double precision;
declare variable PAR_APENAS_NAO_ESPECIAIS integer;
declare variable PAR_APENAS_PEDIDO_VENDA integer;
declare variable LSQL blob sub_type 1 segment size 80;
declare variable PAR_FILTRO_IMPORTACAO_NFCE blob sub_type 1 segment size 80;
declare variable PAR_APENAS_VALOR_LIQUIDO integer;
declare variable LVALORACRESCIMO double precision;
BEGIN
  IF (EXISTS(SELECT 1 FROM CONSULTA_CUSTOMIZADA WHERE CONSULTA_CUSTOMIZADA.CONSULTA = 'AGILIS_IMPORTAVENDA_NFCE')) THEN
  BEGIN
    SELECT SQL FROM CONSULTA_CUSTOMIZADA WHERE CONSULTA_CUSTOMIZADA.CONSULTA = 'AGILIS_IMPORTAVENDA_NFCE' INTO LSQL;
    FOR EXECUTE STATEMENT (LSQL)
    (
      ECODPEDVEND := :ECODPEDVEND,
      ECODEMPRESA := :ECODEMPRESA
    )
    INTO
      CODPEDVEND, 
      EMISSAO, 
      CODPESSOA, 
      NOMEPESSOA, 
      CPFCGCPESSOA, 
      BAIRRO_1, 
      CEP_1, 
      CIDADE_1, 
      CODIBGE, 
      COMPLEMENTO_1, 
      LOGRADOURO_1, 
      NUMERO_1, 
      UF_1, 
      CODVENDEDOR, 
      NOMEVENDEDOR, 
      NUMNFCE, 
      SERIENFCE, 
      VALOR_BRUTO, 
      LVALOR_BRUTO, 
      VALOR_TOTAL, 
      DESCONTO, 
      DESC_VALOR, 
      ACRESCIMO, 
      ACRES_VALOR, 
      VALOR_PAGO, 
      NRITENS, 
      CODPEDVENDITEM, 
      CODPRODFILHO, 
      CODPESQUISA, 
      PRECOPROD, 
      QTDE, 
      DESC_VALORITEM, 
      PRECOVEND, 
      CONTITEM, 
      DESCR_PRODUTO, 
      ALIQUOTAICMS, 
      UNIDADEMED, 
      TRIBUTADO, 
      NCM_CODIGO, 
      CODIGOCEST, 
      PRECOUSADO, 
      PRDF_CST_ORIGEM_MERCADORIA, 
      PRDF_CST_TRIBICMS, 
      PERC_COFINS, 
      PERC_PIS, 
      CSTPIS, 
      CFOP, 
      CODCLASSIFICACAOSERVICO, 
      ALIQUOTAISS, 
      PRECOPRODTABELA, 
      CODDAV, 
      PERC_REDUCAO_ICMS, 
      OBSERVACOES, 
      CODANP, 
      DESCANP
    DO
    BEGIN
      SUSPEND;
    END
    EXIT;
  END

  CODANP  = null;
  DESCANP = null;
  select
    VALOR
  from
    MLERPARAMETROLOGICO('IMPORTAR APENAS PEDIDO "VENDA"', 0)
  into
    PAR_APENAS_PEDIDO_VENDA;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('IMPORTAR VALOR LIQUIDO DO PEDIDO', 0)
  into
    PAR_APENAS_VALOR_LIQUIDO;

  CODDAV = 0;
  if (ECODEMPRESA = 0) then
  begin
    select
      first 1
      E.CODEMPRESA
    from
      EMPRESA E
      join SYSPARAMS S on
        E.CGC = S.CGC
    into
      LCODEMPRESA;
  end
  else
    LCODEMPRESA = ECODEMPRESA;

  ALIQUOTAISS             = 0;
  CODCLASSIFICACAOSERVICO = null;
  CODPEDVEND              = ECODPEDVEND;
  select
    M.VALOR
  from
    MLERPARAMETROINTEIRO('CLIENTE PADRO DO PDV', 0) M
  into
    LCODPESSOAVENDA;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('IMPORTAR APENAS ITENS NO ESPECIAIS', 0)
  into
    PAR_APENAS_NAO_ESPECIAIS;

  select
    VALOR
  from
    MLERPARAMETROMEMO('FILTRO DE IMPORTACAO NFC-E', null)
  into
    PAR_FILTRO_IMPORTACAO_NFCE;

  select
    (select
      FU_GETTIRAMASCARA.STRRESULT
    from
      FU_GETTIRAMASCARA(S.CEP)),
    coalesce(nullif(S.CODIBGE, '0'), '0000000')
  from
    SYSPARAMS S
  into
    LCEP,
    LCODIBGE;

  LSQL = '';
  LSQL = LSQL || '  select';
  LSQL = LSQL || '    P.CODPESSOA,';
  LSQL = LSQL || '    S.NOME,';
  LSQL = LSQL || '    S.CPFCGC,';
  LSQL = LSQL || '    S.CEP_1,';
  LSQL = LSQL || '    S.LOGRADOURO_1,';
  LSQL = LSQL || '    S.BAIRRO_1,';
  LSQL = LSQL || '    S.CIDADE_1,';
  LSQL = LSQL || '    S.UF_1,';
  LSQL = LSQL || '    S.CODIBGE,';
  LSQL = LSQL || '    S.NUMERO_1,';
  LSQL = LSQL || '    S.COMPLEMENTO_1,';
  LSQL = LSQL || '    V.CODVENDEDOR,';
  LSQL = LSQL || '    V.NOME,';
  LSQL = LSQL || '    cast(coalesce(nullif(P.COO,''''), null) as integer),';
  LSQL = LSQL || '    P.ECF,';
  if (PAR_APENAS_VALOR_LIQUIDO <> 0) then /* LEVAR APENAS O VALOR LIQUIDO SEM DESCONTO OU ACRESCIMO PARA O CUPOM. */
  begin
    LSQL = LSQL || '    0, ';
    LSQL = LSQL || '    0, ';
    LSQL = LSQL || '    cast(P.DT_SAIDA as date),';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.NRITENS,';
  end
  else
  begin
    LSQL = LSQL || '    coalesce(P.VALOR_ACRESCIMO, 0) + coalesce(P.ACRESVALOR,0) + coalesce(P.FRETE,0) + coalesce(P.MONTAGEM,0),';
    LSQL = LSQL || '    coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0),';
    LSQL = LSQL || '    cast(P.DT_SAIDA as date),';
    LSQL = LSQL || '    P.VALOR_BRUTO,';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.NRITENS,';
  end
  LSQL = LSQL || '    coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0),';
  LSQL = LSQL || '    coalesce(P.VALOR_ACRESCIMO, 0) + coalesce(P.ACRESVALOR,0) + coalesce(P.FRETE,0) + coalesce(P.MONTAGEM,0),';
  LSQL = LSQL || '    P.VALOR_BRUTO';
  LSQL = LSQL || '  from';
  LSQL = LSQL || '    PEDVEND P';
  LSQL = LSQL || '    join PESSOA S on';
  LSQL = LSQL || '      P.CODPESSOA = S.CODPESSOA';
  LSQL = LSQL || '    join VENDEDOR V on';
  LSQL = LSQL || '      P.CODVENDEDOR = V.CODVENDEDOR';
  LSQL = LSQL || '  where';
  LSQL = LSQL || '    P.CODPEDVEND = ' || ECODPEDVEND || ' and';
  LSQL = LSQL || '    P.CODEMPRESA = ' || LCODEMPRESA || ' and';
  LSQL = LSQL || '    P.NUMNFCE    is null and ';
  LSQL = LSQL || '    P.CODNFVENDA is null and ';
  LSQL = LSQL || '    P.CODCUPOM   is null and ';
  LSQL = LSQL || '    P.STATUSPED <> ''CANCELADO'' and ';
  LSQL = LSQL || '    (('||:PAR_APENAS_PEDIDO_VENDA||' = 0) ';
  LSQL = LSQL || '    or ((P.TIPOPED = ''VENDA'') and ('||:PAR_APENAS_PEDIDO_VENDA||' <> 0))) ';
  if (PAR_FILTRO_IMPORTACAO_NFCE is not null) then
    LSQL = LSQL || '     ' || PAR_FILTRO_IMPORTACAO_NFCE;

  execute statement
    LSQL
  into
    CODPESSOA,
    NOMEPESSOA,
    CPFCGCPESSOA,
    CEP_1,
    LOGRADOURO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CODIBGE,
    NUMERO_1,
    COMPLEMENTO_1,
    CODVENDEDOR,
    NOMEVENDEDOR,
    NUMNFCE,
    SERIENFCE,
    ACRES_VALOR,
    DESC_VALOR,
    EMISSAO,
    VALOR_BRUTO,
    VALOR_TOTAL,
    VALOR_PAGO,
    NRITENS,
    LVALORDESCONTO,
    LVALORACRESCIMO,
    LVALOR_BRUTO;

  if (VALOR_TOTAL is not null) then
  begin
    if (CODPESSOA = LCODPESSOAVENDA) then
    begin
      CODPESSOA    = null;
      NOMEPESSOA   = null;
      CPFCGCPESSOA = null;
    end
    else
    begin
      select
        F.STRRESULT
      from
        FU_GETTIRAMASCARA(:CPFCGCPESSOA) F
      into
        CPFCGCPESSOA;
    end
  
    select
      FU_GETTIRAMASCARA.STRRESULT
    from
      FU_GETTIRAMASCARA(:CEP_1)
    into
      CEP_1;
  
    CEP_1 = coalesce(nullif(CEP_1, ''), LCEP);
  
    if (CHAR_LENGTH(CODIBGE) <> 7) then
      CODIBGE = LCODIBGE;
  
    DESCONTO  = (DESC_VALOR * 100) / VALOR_BRUTO;
    ACRESCIMO = (ACRES_VALOR * 100) / VALOR_BRUTO;
  
    for select
      I.CODDAVITEM,
      I.CODPRODFILHO,
      I.CODPESQUISA,
      I.PRECOPROD,
      COALESCE(PL.QTD, I.QTDE),
      I.PRECOVEND,
      F.DESCRICAO,
      F.ALIQUOTAICMS,
      U.SIGLA,
      F.TRIBUTADO,
      F.CLASSFISCAL,
      I.PRECOUSADO,
      F.PRDF_CST_ORIGEM_MERCADORIA,
      F.PRDF_CST_TRIBICMS,
      F.PERC_COFINS,
      F.PERC_PIS,
      F.CSTPIS,
      F.CODCEST,
      I.PRECOPRODTABELA,
      I.DESCONTO_VALOR,
      F.PERC_REDUCAO_ICMS,
      I.OBSERVACOES,
      pl.lote,
      DATETOSTRING(cast(pl.datafab as date),0),
      DATETOSTRING(cast(pl.dataval as date),0)
    from
      PEDVEND P
      join PEDVENDITEM I on
        P.CODPEDVEND = I.CODPEDVEND
      join PRODFILHO F on
        I.CODPRODFILHO = F.CODPRODFILHO
      join PRODUTO PR on
        F.CODPRODUTO = PR.CODPRODUTO
      join UNIDADE U on
        coalesce(I.CODUNIDADE, F.CODUNIDADE) = U.CODUNIDADE
      left join PEDVENDITEMLOTE PL on
        I.CODPEDVENDITEM = PL.CODPEDVENDITEM
        and not exists(select * from LOTE)
    where
      P.NUMNFCE    is null and
      P.CODNFVENDA is null and
      P.CODCUPOM   is null and
      P.STATUSPED <> 'CANCELADO' and
      ((:PAR_APENAS_PEDIDO_VENDA = 0) or ((P.TIPOPED = 'VENDA') and (:PAR_APENAS_PEDIDO_VENDA <> 0))) and
      P.CODPEDVEND = :ECODPEDVEND and
      ((:PAR_APENAS_NAO_ESPECIAIS = 0) or ((:PAR_APENAS_NAO_ESPECIAIS <> 0) and (coalesce(PR.TRATESP,1) = 1)))
    into
      CODPEDVENDITEM,
      CODPRODFILHO,
      CODPESQUISA,
      PRECOPROD,
      QTDE,
      PRECOVEND,
      DESCR_PRODUTO,
      ALIQUOTAICMS,
      UNIDADEMED,
      TRIBUTADO,
      NCM_CODIGO,
      PRECOUSADO,
      PRDF_CST_ORIGEM_MERCADORIA,
      PRDF_CST_TRIBICMS,
      PERC_COFINS,
      PERC_PIS,
      CSTPIS,
      LCODCEST,
      PRECOPRODTABELA,
      DESC_VALORITEM,
      PERC_REDUCAO_ICMS,
      OBSERVACOES,
      LOTE,
      DATAFAB,
      DATAVAL
    do
    begin
  /*  0 / I - ISENTO */
  /*  4 / N - NAO TRIBUTADO */
  /*  3 / F - SUBSTITUICAO TRIBUTARIA */
  /*  1 / T - TRIBUTADO PELO ICMS */

      if (PAR_APENAS_VALOR_LIQUIDO <> 0) then
      begin
        LFATOR = PRECOVEND / LVALOR_BRUTO;
        PRECOVEND = PRECOVEND + (LVALORACRESCIMO * LFATOR);
        PRECOVEND = PRECOVEND - (LVALORDESCONTO * LFATOR);
        PRECOPROD = PRECOVEND / QTDE;
        DESC_VALORITEM = 0;
      end
    
      CFOP = '5102';
      if (TRIBUTADO = '3') then
        CFOP = '5405';
  
      CONTITEM = coalesce(CONTITEM, 0) + 1;
  
      select
        C.CODIGOCEST
      from
        CEST C
      where
        C.CODCEST = :LCODCEST
      into
        CODIGOCEST;
      suspend;
    end 
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APC170(
    CODEMPRESA INTEGER,
    CODIGO INTEGER,
    SERIE VARCHAR(3),
    ARQ INTEGER,
    RETTUDO INTEGER = 0)
RETURNS (
    CODPRODFILHO INTEGER,
    CODPESQ1 VARCHAR(30),
    CODPESQ2 VARCHAR(30),
    CODPESQ3 VARCHAR(30),
    DESCRICAO VARCHAR(60),
    QTD DOUBLE PRECISION,
    UNID VARCHAR(5),
    PRODVLR DOUBLE PRECISION,
    VALORTOTAL DOUBLE PRECISION,
    VALORBRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    DESPESAS DOUBLE PRECISION,
    MOVFISICA INTEGER,
    CSTICMS VARCHAR(3),
    CODCFOP INTEGER,
    CFOP VARCHAR(4),
    ICMSBASE DOUBLE PRECISION,
    ICMSPERC DOUBLE PRECISION,
    ICMS DOUBLE PRECISION,
    REDUCAO DOUBLE PRECISION,
    ISENTAS DOUBLE PRECISION,
    OUTRAS DOUBLE PRECISION,
    ICMSSTBASE DOUBLE PRECISION,
    ICMSSTPERC DOUBLE PRECISION,
    ICMSST DOUBLE PRECISION,
    APURACAOIPI INTEGER,
    CSTIPI VARCHAR(2),
    IPIBASE DOUBLE PRECISION,
    IPIPERC DOUBLE PRECISION,
    IPI DOUBLE PRECISION,
    BASE DOUBLE PRECISION,
    ORIGEMDADOS VARCHAR(10),
    CSTPIS VARCHAR(2),
    PIS DOUBLE PRECISION,
    VALORPIS DOUBLE PRECISION,
    CSTCOFINS VARCHAR(2),
    COFINS DOUBLE PRECISION,
    VALORCOFINS DOUBLE PRECISION,
    C176_MODELO VARCHAR(2),
    C176_DOCUMENTO VARCHAR(15),
    C176_SERIE VARCHAR(3),
    C176_DTEMISSAO TIMESTAMP,
    C176_CODPESSOA INTEGER,
    C176_QTD DOUBLE PRECISION,
    C176_PRODVLR DOUBLE PRECISION,
    C176_BASE_SUBS DOUBLE PRECISION,
    C176_CHAVE_NFE_ULT_E VARCHAR(44),
    C176_NUM_ITEM_ULT_E VARCHAR(3),
    C176_VL_UNIT_BC_ICMS_ULT_E DOUBLE PRECISION,
    C176_ALIQ_ICMS_ULT_E DOUBLE PRECISION,
    C176_VL_LIMITE_BC_ICMS_ULT_E DOUBLE PRECISION,
    C176_VL_UNIT_ICMS_ULT_E DOUBLE PRECISION,
    C176_ALIQ_ST_ULT_E DOUBLE PRECISION,
    C176_VL_UNIT_RES DOUBLE PRECISION,
    C176_COD_RESP VARCHAR(1),
    C176_COD_MOT_RES VARCHAR(1),
    C176_CHAVE_NFE_RET VARCHAR(44),
    C176_COD_PART_NFE_RET VARCHAR(60),
    C176_SER_NFE_RET VARCHAR(3),
    C176_NUM_NFE_RET VARCHAR(9),
    C176_ITEM_NFE_RET VARCHAR(3),
    C176_COD_DA VARCHAR(1),
    C176_NUM_DA VARCHAR(10),
    RECEITAEFD VARCHAR(3),
    VALORPISST DOUBLE PRECISION,
    VALORCOFINSST DOUBLE PRECISION,
    ICMSDEST DOUBLE PRECISION,
    ICMSINTER DOUBLE PRECISION,
    VALORFCP DOUBLE PRECISION)
AS
declare variable CODARQUIVO integer;
declare variable PARAM_ESP varchar(1);
declare variable CODAPFISCAL_CFOP integer;
declare variable APFISCAL_ICMS varchar(3);
declare variable APFISCAL_CST varchar(4);
declare variable APFISCAL_ST varchar(3);
declare variable APFISCAL_IPI varchar(3);
declare variable TIPONOTA varchar(1);
declare variable LCST varchar(4);
declare variable LCODUNIDADE integer;
declare variable LBASE double precision;
declare variable LDATA date;
declare variable NF_CST_PIS varchar(2);
declare variable NF_PIS_BASE double precision;
declare variable NF_PIS_PERC double precision;
declare variable NF_PIS_VALOR double precision;
declare variable NF_CST_COFINS varchar(2);
declare variable NF_COFINS_BASE double precision;
declare variable NF_COFINS_PERC double precision;
declare variable NF_COFINS_VALOR double precision;
declare variable CFOP_CSTPIS varchar(2);
declare variable CFOP_PIS double precision;
declare variable CFOP_CSTCOFINS varchar(2);
declare variable CFOP_COFINS double precision;
declare variable CFOP_CSTPISENTRADA varchar(2);
declare variable CFOP_PISENTRADA double precision;
declare variable CFOP_CSTCOFINSENTRADA varchar(2);
declare variable CFOP_COFINSENTRADA double precision;
declare variable PROD_CST_PIS_S varchar(2);
declare variable PROD_CST_COFINS_S varchar(2);
declare variable PROD_PIS_S double precision;
declare variable PROD_COFINS_S double precision;
declare variable PROD_CST_PIS_E varchar(2);
declare variable PROD_CST_COFINS_E varchar(2);
declare variable PROD_PIS_E double precision;
declare variable PROD_COFINS_E double precision;
declare variable PROD_CST_IPI_S varchar(2);
declare variable PROD_CST_IPI_E varchar(2);
declare variable PARAM_ENVIARST varchar(1);
declare variable PARAM_ENVIARIPI varchar(1);
declare variable PARAM_BASE varchar(1);
declare variable ESP_IPI varchar(1);
declare variable ESP_ST varchar(1);
declare variable ESP_FRETE varchar(1);
declare variable ESP_DESCONTO varchar(1);
declare variable ESP_DESPESAS varchar(1);
declare variable SQL varchar(1000);
declare variable PERFIL varchar(1);
declare variable PARAM_SIMPLESPB varchar(1);
declare variable PERC_REDUCAO double precision;
declare variable PARAM_GERAC170 varchar(1);
begin
  SQL = 'SELECT
    COALESCE(PARAM_ENVIARST, ''N''),
    COALESCE(PARAM_ENVIARIPI, ''N''),
    COALESCE(PARAM_BASE, ''N''),
    COALESCE(ESP_IPI, ''N''),
    COALESCE(ESP_ST, ''N''),
    COALESCE(ESP_FRETE, ''N''),
    COALESCE(ESP_DESCONTO, ''N''),
    COALESCE(PERFIL, ''N''),
    COALESCE(ESP_DESPESAS, ''N''),
    COALESCE(PARAM_SIMPLESPB, ''N''),
    COALESCE(PARAM_GERAC170, ''N'')
  FROM
    APFISCAL A
  WHERE
    A.ARQ =' || :ARQ || 'AND ' || 'A.CODEMPRESA = ' || :CODEMPRESA;

  execute statement
    SQL
  into
    PARAM_ENVIARST,
    PARAM_ENVIARIPI,
    PARAM_BASE,
    ESP_IPI,
    ESP_ST,
    ESP_FRETE,
    ESP_DESCONTO,
    PERFIL,
    ESP_DESPESAS,
    PARAM_SIMPLESPB,
    PARAM_GERAC170;

  select
    APFISCAL.CODIGO,
    APFISCAL.PARAM_ESP
  from
    APFISCAL
  where
    APFISCAL.ARQ =:ARQ and
    APFISCAL.CODEMPRESA =:CODEMPRESA
  into
    :CODARQUIVO,
    :PARAM_ESP;

  PARAM_ESP   = coalesce(PARAM_ESP,'N');

  if (SERIE = 'C') then
  begin
    for select
      coalesce(cI.PRDF_CST_ORIGEM_MERCADORIA, '') || coalesce(CI.PRDF_CST_TRIBICMS,''),
      CI.CFOP,
      CI.CSTPIS,
      coalesce(CI.BASEICMS, 0),
      coalesce(CI.ALIQUOTAICMS, 0),
      coalesce(CI.VALORICMS, 0),
      coalesce(CI.BASEST, 0),
      coalesce(CI.VALORST, 0),
      coalesce(CI.BASEPIS, 0),
      coalesce(CI.PERC_PIS, 0),
      coalesce(CI.VALORPIS, 0),
      coalesce(CI.PERC_COFINS, 0),
      coalesce(CI.VALORCOFINS, 0),
      coalesce(CI.PRECOVEND, 0),
      coalesce(CI.DESC_VALOR, 0),
      coalesce(CI.PRECOLIQ, 0),
      coalesce(CI.RECEITAEFD, F.RECEITAEFD)
    from
      CUPOMITEM CI
      join PRODFILHO F on
        CI.CODPRODFILHO = F.CODPRODFILHO
    where
      CI.CODCUPOM = :CODIGO and
      CI.STATUSCUPOMITEM = 0
    into
      LCST, 
      CFOP,
      CSTPIS,
      ICMSBASE,
      ICMSPERC,
      ICMS,
      ICMSSTBASE,
      ICMSST,
      BASE,
      PIS,
      NF_PIS_VALOR,
      COFINS,
      NF_COFINS_VALOR,
      VALORBRUTO,
      DESCONTO,
      VALORTOTAL,
      RECEITAEFD
    do
    begin
      VALORPIS    = 0;
      VALORCOFINS = 0;
      OUTRAS      = 0;
      IPI         = 0;
      REDUCAO     = 0;
      VALORPIS    = NF_PIS_VALOR;
      VALORCOFINS = NF_COFINS_VALOR;
      LCST        = trim(LCST);
      VALORPISST    = 0;
      VALORCOFINSST = 0;

      if (CHAR_LENGTH(LCST) > 3) then
      begin
        LCST      = substring(LCST from 2 for 3);
        LCST      = trim(LCST);
      end
      CSTICMS     = trim(LCST);

      if ((CSTPIS <> '06') and (CSTPIS <> '07') and (CSTPIS <> '08') and (CSTPIS <> '09')) then
      begin
        BASE          = cast(BASE as numeric(18,2));
        PIS           = cast(PIS as numeric(18,2));
        VALORPIS      = cast(VALORPIS as numeric(18,2));
        COFINS        = cast(COFINS as numeric(18,2));
        VALORCOFINS   = cast(VALORCOFINS as numeric(18,2));

        if (CSTPIS = '05') then
        begin
          VALORPISST    = VALORPIS;
          VALORCOFINSST = VALORCOFINS;
        end

      end else
      begin
        BASE          = 0;
        PIS           = 0;
        VALORPIS      = 0;
        COFINS        = 0;
        VALORCOFINS   = 0;
        VALORPISST    = 0;
        VALORCOFINSST = 0;
      end

      if (PARAM_SIMPLESPB = 'N') then
      begin
        ICMSBASE    = cast(ICMSBASE as numeric(18,2));
        ICMSPERC    = cast(ICMSPERC as numeric(18,2));
        ICMS        = cast(ICMS as numeric(18,2));
        ICMSSTBASE  = cast(ICMSSTBASE as numeric(18,2));
        ICMSST      = cast(ICMSST as numeric(18,2));
        IPI         = cast(IPI as numeric(18,2));
        VALORBRUTO  = cast(VALORTOTAL as numeric(18,2));
        DESCONTO    = cast(DESCONTO as numeric(18,2));
        VALORTOTAL  = cast(VALORTOTAL as numeric(18,2));
        ISENTAS     = (VALORBRUTO - ICMSBASE);
      end
      else
      begin
        ICMSBASE    = 0;
        ICMSPERC    = 0;
        ICMS        = 0;
        ICMSSTBASE  = 0;
        ICMSST      = 0;
        IPI         = cast(IPI as numeric(18,2));
        VALORBRUTO  = cast(VALORTOTAL as numeric(18,2));
        DESCONTO    = cast(DESCONTO as numeric(18,2));
        VALORTOTAL  = cast(VALORTOTAL as numeric(18,2));
        ISENTAS     = (VALORBRUTO - ICMSBASE);
      end

      if (ISENTAS < 0) then
        ISENTAS = 0;

      suspend;
    end
  end
/*  else */
  if (SERIE <> '.') then
  begin
    select
      N.TIPONOTA,
      N.DT_EMISSAO
    from
      NFVENDA N
    where
      N.CODNFVENDA = :CODIGO and
      N.SERIE      = :SERIE
    into
      TIPONOTA,
      LDATA;

    for select
      I.CODCFOP,
      F.CODUNIDADE,
      I.CODPRODFILHO,
      I.PRECOVEND,
      I.QTDE,
      coalesce(I.TOTALVLRNOTA, I.TOTALVLR),
      coalesce(I.TOTALVLR, I.TOTALVLRNOTA),
      coalesce(I.DESCVLR, 0),
      coalesce(I.FRETE_VLR, 0),
      coalesce(I.ODESP_VALOR, 0),
      coalesce(trim(I.CST),''),
      coalesce(I.ICMSBASE, 0),
      coalesce(I.ICMSPERC, 0),
      coalesce(I.ICMSVALOR, 0),
      coalesce(I.BASE_SUBS, 0),
      coalesce(I.ALIQ_SUBS, 0),
      coalesce(I.VALOR_SUBS, 0),
      coalesce(I.IPIBASE, 0),
      coalesce(I.IPIPERC, 0),
      coalesce(I.IPIVALOR, 0),
      coalesce(I.VALOR_REDUCAO, 0),
      coalesce(I.ODESP_VALOR, 0),
      coalesce(I.PISCST,''),
      coalesce(I.BASE_PIS, 0),
      coalesce(I.PISPERC, 0),
      coalesce(I.PISVALOR, 0),
      coalesce(I.COFINSCST,''),
      coalesce(I.BASE_COFINS, 0),
      coalesce(I.COFINSPERC, 0),
      coalesce(I.COFINSVALOR, 0),
      coalesce(I.RECEITAEFD, F.RECEITAEFD),
      coalesce(I.PERC_REDUCAO, 0),
      coalesce(I.VALORICMSDEST,0),
      coalesce(I.VALORICMSINTER,0),
      coalesce(I.VALORFCP,0)
    from
      NFVENDAITEM I
      join PRODFILHO F on
        I.CODPRODFILHO = F.CODPRODFILHO
    where
      I.CODNFVENDA = :CODIGO and
      I.SERIE      = :SERIE
    into
      CODCFOP,
      LCODUNIDADE,
      CODPRODFILHO,
      PRODVLR,
      QTD,
      VALORTOTAL,
      VALORBRUTO,
      DESCONTO,
      FRETE,
      DESPESAS,
      LCST,
      ICMSBASE,
      ICMSPERC,
      ICMS,
      ICMSSTBASE,
      ICMSSTPERC,
      ICMSST,
      IPIBASE,
      IPIPERC,
      IPI,
      REDUCAO,
      OUTRAS,
      NF_CST_PIS,
      NF_PIS_BASE,
      NF_PIS_PERC,
      NF_PIS_VALOR,
      NF_CST_COFINS,
      NF_COFINS_BASE,
      NF_COFINS_PERC,
      NF_COFINS_VALOR,
      RECEITAEFD,
      PERC_REDUCAO,
      ICMSDEST,
      ICMSINTER,
      VALORFCP
    do
    begin
      MOVFISICA   = 0;
      ORIGEMDADOS = '';
      CSTPIS      = '';
      PIS         = 0;
      VALORPIS    = 0;
      CSTCOFINS   = '';
      COFINS      = 0;
      VALORCOFINS = 0;
      LBASE       = 0;
      LBASE       = VALORBRUTO;
      APURACAOIPI = 0;
      ISENTAS     = 0;
      OUTRAS      = 0;
      VALORPISST  = 0;
      VALORCOFINSST = 0;
      if (CHAR_LENGTH(LCST) > 3) then
      begin
        LCST      = substring(LCST from 2 for 3);
        LCST      = trim(LCST);
      end
      CSTICMS     = LCST;

      select
        P.PROD_DESCR,
        P.PROD_COD1,
        P.PROD_COD2,
        P.PROD_COD3,
        P.PROD_UND,
        P.PROD_CST_PIS_S,
        P.PROD_CST_COFINS_S,
        P.PROD_PIS_S,
        P.PROD_COFINS_S,
        P.PROD_CST_PIS_E,
        P.PROD_CST_COFINS_E,
        P.PROD_PIS_E,
        P.PROD_COFINS_E,
        P.PROD_CST_IPI_S,
        P.PROD_CST_IPI_E
      from
        APPROD(:CODPRODFILHO,0) P
      into
        DESCRICAO,
        CODPESQ1,
        CODPESQ2,
        CODPESQ3,
        UNID,
        PROD_CST_PIS_S,
        PROD_CST_COFINS_S,
        PROD_PIS_S,
        PROD_COFINS_S,
        PROD_CST_PIS_E,
        PROD_CST_COFINS_E,
        PROD_PIS_E,
        PROD_COFINS_E,
        PROD_CST_IPI_S,
        PROD_CST_IPI_E;
  
      if (LCODUNIDADE <= 0) then
        UNID = UNID;
      else
      begin
        select
          U.SIGLA
        from
          UNIDADE U
        where
          U.CODUNIDADE = :LCODUNIDADE
        into
          UNID;
      end

      select
        C.CFOP,
        coalesce(C.CSTPIS,''),
        coalesce(C.CSTCOFINS,''),
        coalesce(C.PERC_PIS,0),
        coalesce(C.PERC_COFINS,0),
        coalesce(C.CSTPISENTRADA,''),
        coalesce(C.CSTCOFINSENTRADA,''),
        coalesce(C.PERCPISCOMPRA,0),
        coalesce(C.PERCCONFINSCOMPRA,0)
      from
        CFOP C
      where
        C.CODCFOP = :CODCFOP
      into
        CFOP,
        CFOP_CSTPIS,
        CFOP_CSTCOFINS,
        CFOP_PIS,
        CFOP_COFINS,
        CFOP_CSTPISENTRADA,
        CFOP_CSTCOFINSENTRADA,
        CFOP_PISENTRADA,
        CFOP_COFINSENTRADA;

      if (PARAM_BASE = 'S') then
      begin
        LBASE = VALORBRUTO;

        if (ESP_IPI  = 'S') then
          LBASE = LBASE + IPI;
    
        if (ESP_ST  = 'S') then
          LBASE = LBASE + ICMSST;
    
        if (ESP_FRETE = 'S') then
          LBASE = LBASE + FRETE;
    
        if (ESP_DESCONTO = 'S') then
          LBASE = LBASE - DESCONTO;
  
        if (ESP_DESPESAS = 'S') then
          LBASE = LBASE + DESPESAS;
      end

      if (TIPONOTA = 'S') then
      begin
        if (PROD_CST_IPI_S = '') then
          CSTIPI = '99';
        else
          CSTIPI = PROD_CST_IPI_S;
        if ((CSTIPI = '51') or (CSTIPI = '52')) then
        begin
          IPI     = 0;
          IPIBASE = 0;
          IPIPERC = 0;
        end

        if (NF_CST_PIS <> '') then
        begin
          BASE        = NF_PIS_BASE;
          CSTPIS      = NF_CST_PIS;
          PIS         = NF_PIS_PERC;
          VALORPIS    = NF_PIS_VALOR;
          CSTCOFINS   = NF_CST_COFINS;
          COFINS      = NF_COFINS_PERC;
          VALORCOFINS = NF_COFINS_VALOR;
          ORIGEMDADOS = 'NF';
        end else
        if (CFOP_CSTPIS <> '') then
        begin
          BASE        = LBASE;
          CSTPIS      = CFOP_CSTPIS;
          PIS         = CFOP_PIS;
          VALORPIS    = (BASE * CFOP_PIS) / 100;
          CSTCOFINS   = CFOP_CSTCOFINS;
          COFINS      = CFOP_COFINS;
          VALORCOFINS = (BASE * CFOP_COFINS) / 100;
          ORIGEMDADOS = 'CFOP';
        end else
        if (PROD_CST_PIS_S <> '') then
        begin
          BASE        = LBASE;
          CSTPIS      = PROD_CST_PIS_S;
          PIS         = PROD_PIS_S;
          VALORPIS    = (BASE * PROD_PIS_S) / 100;
          CSTCOFINS   = PROD_CST_COFINS_S;
          COFINS      = PROD_COFINS_S;
          VALORCOFINS = (BASE * PROD_COFINS_S) / 100;
          ORIGEMDADOS = 'PRODUTO';
        end

        if ((CSTPIS <> '06') and (CSTPIS <> '07') and (CSTPIS <> '08') and (CSTPIS <> '09')) then
        begin
          BASE          = cast(BASE as numeric(18,2));
          PIS           = cast(PIS as numeric(18,2));
          VALORPIS      = cast(VALORPIS as numeric(18,2));
          COFINS        = cast(COFINS as numeric(18,2));
          VALORCOFINS   = cast(VALORCOFINS as numeric(18,2));
          if (CSTPIS = '05') then
          begin
            VALORPISST    = VALORPIS;
            VALORCOFINSST = VALORCOFINS;
          end
        end else
        begin
          BASE          = 0;
          PIS           = 0;
          VALORPIS      = 0;
          COFINS        = 0;
          VALORCOFINS   = 0;
          VALORPISST    = 0;
          VALORCOFINSST = 0;
        end

      end
      else
      if (TIPONOTA = 'E') then
      begin
        if (PROD_CST_IPI_E = '') then
          CSTIPI = '49';
        else
          CSTIPI = PROD_CST_IPI_E;
        if ((CSTIPI = '01') or (CSTIPI = '02')) then
        begin
          IPI     = 0;
          IPIBASE = 0;
          IPIPERC = 0;
        end
        
        if (NF_CST_PIS <> '') then
        begin
          BASE        = NF_PIS_BASE;
          CSTPIS      = NF_CST_PIS;
          PIS         = NF_PIS_PERC;
          VALORPIS    = NF_PIS_VALOR;
          CSTCOFINS   = NF_CST_COFINS;
          COFINS      = NF_COFINS_PERC;
          VALORCOFINS = NF_COFINS_VALOR;
          ORIGEMDADOS = 'NF';
        end else
        if (CFOP_CSTPISENTRADA <> '') then
        begin
          BASE        = LBASE;
          CSTPIS      = CFOP_CSTPISENTRADA;
          PIS         = CFOP_PISENTRADA;
          VALORPIS    = (BASE * CFOP_PISENTRADA) / 100;
          CSTCOFINS   = CFOP_CSTCOFINSENTRADA;
          COFINS      = CFOP_COFINSENTRADA;
          VALORCOFINS = (BASE * CFOP_COFINSENTRADA) / 100;
          ORIGEMDADOS = 'CFOP';
        end else
        if (PROD_CST_PIS_E <> '') then
        begin
          BASE        = LBASE;
          CSTPIS      = PROD_CST_PIS_E;
          PIS         = PROD_PIS_E;
          VALORPIS    = (BASE * PROD_PIS_E) / 100;
          CSTCOFINS   = PROD_CST_COFINS_E;
          COFINS      = PROD_COFINS_E;
          VALORCOFINS = (BASE * PROD_COFINS_E) / 100;
          ORIGEMDADOS = 'PRODUTO';
        end

        if ((CSTPIS <> '70') and (CSTPIS <> '71') and (CSTPIS <> '72') and (CSTPIS <> '73') and
            (CSTPIS <> '74') and (CSTPIS <> '98') and (CSTPIS <> '99')) then
        begin
          BASE          = cast(BASE as numeric(18,2));
          PIS           = cast(PIS as numeric(18,2));
          VALORPIS      = cast(VALORPIS as numeric(18,2));
          COFINS        = cast(COFINS as numeric(18,2));
          VALORCOFINS   = cast(VALORCOFINS as numeric(18,2));
          if (CSTPIS = '75') then
          begin
            VALORPISST    = VALORPIS;
            VALORCOFINSST = VALORCOFINS;
          end
        end else
        begin
          BASE          = 0;
          PIS           = 0;
          VALORPIS      = 0;
          COFINS        = 0;
          VALORCOFINS   = 0;
          VALORPISST    = 0;
          VALORCOFINSST = 0;
        end
      end

      if (PERC_REDUCAO > 0) then
      begin
        REDUCAO = VALORTOTAL - ICMSBASE;
      end

      if ((IPIPERC > 0) and (IPIBASE <= 0)) then
        IPIBASE = VALORBRUTO;
  
      if ((IPIPERC <= 0) and (IPIBASE > 0)) then
      begin
        IPIBASE = 0;
        IPIPERC = 0;
        IPI     = 0;
      end

      if (PARAM_ENVIARIPI = 'N') then
      begin
        IPIBASE = 0;
        IPIPERC = 0;
        IPI     = 0;
      end
  
      if  (PARAM_ENVIARST = 'N') then
      begin
        ICMSST     = 0;
        ICMSSTBASE = 0;
        ICMSSTPERC = 0;
      end

      PRODVLR     = cast(PRODVLR as numeric(18,2));
      VALORTOTAL  = cast(VALORTOTAL as numeric(18,2));
      DESCONTO    = cast(DESCONTO as numeric(18,2));
      FRETE       = cast(FRETE as numeric(18,2));
      DESPESAS    = cast(DESPESAS as numeric(18,2));
      ICMSBASE    = cast(ICMSBASE as numeric(18,2));
      ICMSPERC    = cast(ICMSPERC as numeric(18,2));
      ICMS        = cast(ICMS as numeric(18,2));
      ICMSSTBASE  = cast(ICMSSTBASE as numeric(18,2));
      ICMSSTPERC  = cast(ICMSSTPERC as numeric(18,2));
      ICMSST      = cast(ICMSST as numeric(18,2));
      IPIBASE     = cast(IPIBASE as numeric(18,2));
      IPIPERC     = cast(IPIPERC as numeric(18,2));
      IPI         = cast(IPI as numeric(18,2));
      ISENTAS     = (VALORBRUTO - ICMSBASE);

      if (ISENTAS < 0) then
        ISENTAS = 0;

      if ((ARQ = 2) and (PARAM_SIMPLESPB = 'N')) then
      begin
        C176_BASE_SUBS  = 0;
        C176_VL_UNIT_BC_ICMS_ULT_E = 0;
        C176_ALIQ_ICMS_ULT_E = 0;
        C176_VL_LIMITE_BC_ICMS_ULT_E = 0;
        C176_VL_UNIT_ICMS_ULT_E = 0;

        select
          MODELO, 
          DOCUMENTO, 
          SERIE, 
          DTEMISSAO, 
          CODPESSOA, 
          QTD, 
          PRODVLR, 
          BASE_SUBS,
          CHAVENFE,
          BASE_ICMS,
          ALIQ_ICMS,
          VLRRETENCAO,
          VLR_ICMS
        from
          APSTRE(:CODEMPRESA, :CODPRODFILHO, :LDATA)
        into
          C176_MODELO,
          C176_DOCUMENTO,
          C176_SERIE,
          C176_DTEMISSAO,
          C176_CODPESSOA,
          C176_QTD,
          C176_PRODVLR,
          C176_BASE_SUBS,
          C176_CHAVE_NFE_ULT_E,
          C176_VL_UNIT_BC_ICMS_ULT_E,
          C176_ALIQ_ICMS_ULT_E,
          C176_VL_LIMITE_BC_ICMS_ULT_E,
          C176_VL_UNIT_ICMS_ULT_E;

          C176_BASE_SUBS  = cast(C176_BASE_SUBS as numeric(18,2));
          C176_VL_UNIT_BC_ICMS_ULT_E = cast(C176_VL_UNIT_BC_ICMS_ULT_E as numeric(18,2));
          C176_ALIQ_ICMS_ULT_E = cast(C176_ALIQ_ICMS_ULT_E as numeric(18,2));
          C176_VL_LIMITE_BC_ICMS_ULT_E = cast(C176_VL_LIMITE_BC_ICMS_ULT_E as numeric(18,2));
          C176_VL_UNIT_ICMS_ULT_E = cast(C176_VL_UNIT_ICMS_ULT_E as numeric(18,2));
      end

      if (PARAM_SIMPLESPB = 'S') then
      begin
        ICMSBASE    = 0;
        ICMSPERC    = 0;
        ICMS        = 0;
        ICMSSTBASE  = 0;
        ICMSSTPERC  = 0;
        ICMSST      = 0;
        ISENTAS     = 0;
      end

      if (RETTUDO = 0) then
      begin
        if ((ARQ = 2) and (PARAM_SIMPLESPB = 'N') and PARAM_GERAC170<>'S') then
        begin
          if (C176_ALIQ_ICMS_ULT_E >0 ) then
            suspend;
        end
        else
          suspend;
      end
      else
        suspend;
    end

  end else
/*  if (SERIE = '') then */
  begin
    TIPONOTA = 'E';
    for select
      I.CODCFOP,
      F.CODUNIDADE,
      I.CODPRODFILHO,
      I.PRODVLR,
      I.QTD,
      coalesce(coalesce(I.TOTAL_NOTA, I.VALORTOTAL), I.TOTALPROD),
      coalesce(I.TOTALPROD, (I.QTD * I.PRODVLR)),
      coalesce(I.DESCTO_ITEM, 0),
      coalesce(I.FRETEVLRLTDA, 0),
      coalesce(I.DESP_VALOR, 0),
      coalesce(I.PRDF_CST_ORIGEM_MERCADORIA, '') || coalesce(I.PRDF_CST_TRIBICMS,''),
      coalesce(I.BASE_ICMS, 0),
      coalesce(I.DIFICMS, 0),
      coalesce(I.VL_DIFICMS, 0),
      coalesce(I.BASE_SUBS, 0),
      coalesce(I.ALIQ_SUBS, 0),
      coalesce(I.VALOR_SUBS, 0),
      coalesce(I.BASE_IPI, 0),
      coalesce(I.IPIPERC, 0),
      coalesce(I.VL_IPIPERC, 0),
      coalesce(I.REDUCAO_VALOR, 0),
      coalesce(I.PISCST,''),
      coalesce(I.BASE_PIS, 0),
      coalesce(I.PISPERC, 0),
      coalesce(I.PISVALOR, 0),
      coalesce(I.COFINSCST,''),
      coalesce(I.BASE_COFINS, 0),
      coalesce(I.COFINSPERC, 0),
      coalesce(I.COFINSVALOR, 0)
    from
      NFENTRADAITENS I
      join PRODFILHO F on
        I.CODPRODFILHO = F.CODPRODFILHO
    where
      I.CODNFENTRADA = :CODIGO
    into
      CODCFOP,
      LCODUNIDADE,
      CODPRODFILHO,
      PRODVLR,
      QTD,
      VALORTOTAL,
      VALORBRUTO,
      DESCONTO,
      FRETE,
      DESPESAS,
      LCST,
      ICMSBASE,
      ICMSPERC,
      ICMS,
      ICMSSTBASE,
      ICMSSTPERC,
      ICMSST,
      IPIBASE,
      IPIPERC,
      IPI,
      REDUCAO,
      NF_CST_PIS,
      NF_PIS_BASE,
      NF_PIS_PERC,
      NF_PIS_VALOR,
      NF_CST_COFINS,
      NF_COFINS_BASE,
      NF_COFINS_PERC,
      NF_COFINS_VALOR
    do
    begin
      MOVFISICA   = 0;
      ORIGEMDADOS = '';
      CSTPIS      = '';
      PIS         = 0;
      VALORPIS    = 0;
      CSTCOFINS   = '';
      COFINS      = 0;
      VALORCOFINS = 0;
      LBASE       = 0;
      LBASE       = VALORBRUTO;
      APURACAOIPI = 0;
      if (CHAR_LENGTH(LCST) > 3) then
      begin
        LCST      = substring(LCST from 2 for 3);
        LCST      = trim(LCST);
      end
      CSTICMS     = LCST;
      ISENTAS     = 0;
      OUTRAS      = 0;

      select
        C.CFOP,
        coalesce(C.CSTPISENTRADA,''),
        coalesce(C.CSTCOFINSENTRADA,''),
        coalesce(C.PERCPISCOMPRA,0),
        coalesce(C.PERCCONFINSCOMPRA,0)
      from
        CFOP C
      where
        C.CODCFOP = :CODCFOP
      into
        CFOP,
        CFOP_CSTPISENTRADA,
        CFOP_CSTCOFINSENTRADA,
        CFOP_PISENTRADA,
        CFOP_COFINSENTRADA;

      CODAPFISCAL_CFOP = Null;
      APFISCAL_ICMS    = Null;
      APFISCAL_IPI     = Null;
      APFISCAL_ST      = Null;
      APFISCAL_CST     = Null;

      if (PARAM_ESP = 'S') then
      begin
        select
          APFISCAL_CFOP.CODIGO,
          APFISCAL_CFOP.APFISCAL_ICMS,
          APFISCAL_CFOP.APFISCAL_IPI,
          APFISCAL_CFOP.APFISCAL_ST,
          APFISCAL_CFOP.APFISCAL_CST
        from
          APFISCAL_CFOP
        where
          APFISCAL_CFOP.CODIGOAP =:CODARQUIVO and
          APFISCAL_CFOP.CODCFOP =:CODCFOP
        into
          :CODAPFISCAL_CFOP,
          :APFISCAL_ICMS,
          :APFISCAL_IPI,
          :APFISCAL_ST,
          :APFISCAL_CST;
    
        APFISCAL_ICMS = coalesce(APFISCAL_ICMS,'NO');
        APFISCAL_IPI  = coalesce(APFISCAL_IPI,'NO');
        APFISCAL_ST   = coalesce(APFISCAL_ST,'NO');
  
        if (CODAPFISCAL_CFOP >= 1) then
        begin
          if (APFISCAL_CST is not null) then
          begin
            if (CHAR_LENGTH(APFISCAL_CST) > 3) then
            begin
              APFISCAL_CST  = substring(APFISCAL_CST from 2 for 3);
              APFISCAL_CST  = trim(APFISCAL_CST);
            end
            CSTICMS     = APFISCAL_CST;
          end

          if (APFISCAL_ICMS = 'SIM')then
          begin
            ICMSBASE     = ICMSBASE;
            ICMSPERC     = ICMSPERC;
            ICMS         = ICMS;
          end
          else
          begin
            ICMSBASE     = 0;
            ICMS         = 0;
            ICMSPERC     = 0;
            REDUCAO      = 0;
          end
  
          if (APFISCAL_IPI = 'SIM')then
          begin
            IPIBASE     = IPIBASE;
            IPIPERC     = IPIPERC;
            IPI         = IPI;
          end
          else
          begin
            IPIBASE     = 0;
            IPIPERC     = 0;
            IPI         = 0;
          end
  
          if (APFISCAL_ST = 'SIM')then
          begin
            ICMSSTBASE = ICMSSTBASE;
            ICMSSTPERC = ICMSSTPERC;
            ICMSST     = ICMSST;
          end
          else
          begin
            ICMSSTBASE = 0;
            ICMSSTPERC = 0;
            ICMSST     = 0;
          end
        end
      end

      select
        P.PROD_DESCR,
        P.PROD_COD1,
        P.PROD_COD2,
        P.PROD_COD3,
        P.PROD_UND,
        P.PROD_CST_PIS_E,
        P.PROD_CST_COFINS_E,
        P.PROD_PIS_E,
        P.PROD_COFINS_E,
        P.PROD_CST_IPI_S,
        P.PROD_CST_IPI_E
      from
        APPROD(:CODPRODFILHO,0) P
      into
        DESCRICAO,
        CODPESQ1,
        CODPESQ2,
        CODPESQ3,
        UNID,
        PROD_CST_PIS_E,
        PROD_CST_COFINS_E,
        PROD_PIS_E,
        PROD_COFINS_E,
        PROD_CST_IPI_S,
        PROD_CST_IPI_E;
  
      if (LCODUNIDADE <= 0) then
        UNID = UNID;
      else
      begin
        select
          U.SIGLA
        from
          UNIDADE U
        where
          U.CODUNIDADE = :LCODUNIDADE
        into
          UNID;
      end

      if (PARAM_BASE = 'S') then
      begin
        LBASE = VALORBRUTO;

        if (ESP_IPI  = 'S') then
          LBASE = LBASE + IPI;
    
        if (ESP_ST  = 'S') then
          LBASE = LBASE + ICMSST;
    
        if (ESP_FRETE = 'S') then
          LBASE = LBASE + FRETE;
    
        if (ESP_DESCONTO = 'S') then
          LBASE = LBASE - DESCONTO;
  
        if (ESP_DESPESAS = 'S') then
          LBASE = LBASE + DESPESAS;
      end

      if (TIPONOTA = 'E') then
      begin
        if (PROD_CST_IPI_E = '') then
          CSTIPI = '49';
        else
          CSTIPI = PROD_CST_IPI_E;
        if ((CSTIPI = '01') or (CSTIPI = '02')) then
        begin
          IPI     = 0;
          IPIBASE = 0;
          IPIPERC = 0;
        end
        
        if (NF_CST_PIS <> '') then
        begin
          BASE        = NF_PIS_BASE;
          CSTPIS      = NF_CST_PIS;
          PIS         = NF_PIS_PERC;
          VALORPIS    = NF_PIS_VALOR;
          CSTCOFINS   = NF_CST_COFINS;
          COFINS      = NF_COFINS_PERC;
          VALORCOFINS = NF_COFINS_VALOR;
          ORIGEMDADOS = 'NF';
        end else
        if (CFOP_CSTPISENTRADA <> '') then
        begin
          BASE        = LBASE;
          CSTPIS      = CFOP_CSTPISENTRADA;
          PIS         = CFOP_PISENTRADA;
          VALORPIS    = (BASE * CFOP_PISENTRADA) / 100;
          CSTCOFINS   = CFOP_CSTCOFINSENTRADA;
          COFINS      = CFOP_COFINSENTRADA;
          VALORCOFINS = (BASE * CFOP_COFINSENTRADA) / 100;
          ORIGEMDADOS = 'CFOP';
        end else
        if (PROD_CST_PIS_E <> '') then
        begin
          BASE        = LBASE;
          CSTPIS      = PROD_CST_PIS_E;
          PIS         = PROD_PIS_E;
          VALORPIS    = (BASE * PROD_PIS_E) / 100;
          CSTCOFINS   = PROD_CST_COFINS_E;
          COFINS      = PROD_COFINS_E;
          VALORCOFINS = (BASE * PROD_COFINS_E) / 100;
          ORIGEMDADOS = 'PRODUTO';
        end

        if (CFOP_CSTPISENTRADA <> '') then
        begin
          PIS         = CFOP_PISENTRADA;
          COFINS      = CFOP_COFINSENTRADA;
          CSTPIS      = CFOP_CSTPISENTRADA;
          CSTCOFINS   = CFOP_CSTCOFINSENTRADA;
          if (PIS > 0) then
          begin
            BASE        = LBASE;
            VALORPIS    = (BASE * CFOP_PISENTRADA) / 100;
            VALORCOFINS = (BASE * CFOP_COFINSENTRADA) / 100;
          end else
          begin
            BASE        = 0;
            VALORPIS    = 0;
            VALORCOFINS = 0;
          end
          ORIGEMDADOS = 'CFOP';
        end

        if ((CSTPIS <> '70') and (CSTPIS <> '71') and (CSTPIS <> '72') and (CSTPIS <> '73') and
            (CSTPIS <> '74')) then
        begin
          BASE        = cast(BASE as numeric(18,2));
          PIS         = cast(PIS as numeric(18,2));
          VALORPIS    = cast(VALORPIS as numeric(18,2));
          COFINS      = cast(COFINS as numeric(18,2));
          VALORCOFINS = cast(VALORCOFINS as numeric(18,2));
          if (CSTPIS = '75') then
          begin
            VALORPISST    = VALORPIS;
            VALORCOFINSST = VALORCOFINS;
          end
        end else
        begin
          BASE        = 0;
          PIS         = 0;
          VALORPIS    = 0;
          COFINS      = 0;
          VALORCOFINS = 0;
        end
      end

      if ((IPIPERC > 0) and (IPIBASE <= 0)) then
        IPIBASE = VALORBRUTO;
  
      if ((IPIPERC <= 0) and (IPIBASE > 0)) then
      begin
        IPIBASE = 0;
        IPIPERC = 0;
        IPI     = 0;
      end

      if (PARAM_ENVIARIPI = 'N') then
      begin
        IPIBASE = 0;
        IPIPERC = 0;
        IPI     = 0;
      end
  
      if  (PARAM_ENVIARST = 'N') then
      begin
        ICMSST     = 0;
        ICMSSTBASE = 0;
        ICMSSTPERC = 0;
      end

      PRODVLR     = cast(PRODVLR as numeric(18,2));
      VALORTOTAL  = cast(VALORTOTAL as numeric(18,2));
      DESCONTO    = cast(DESCONTO as numeric(18,2));
      FRETE       = cast(FRETE as numeric(18,2));
      DESPESAS    = cast(DESPESAS as numeric(18,2));
      ICMSBASE    = cast(ICMSBASE as numeric(18,2));
      ICMSPERC    = cast(ICMSPERC as numeric(18,2));
      ICMS        = cast(ICMS as numeric(18,2));
      ICMSSTBASE  = cast(ICMSSTBASE as numeric(18,2));
      ICMSSTPERC  = cast(ICMSSTPERC as numeric(18,2));
      ICMSST      = cast(ICMSST as numeric(18,2));
      IPIBASE     = cast(IPIBASE as numeric(18,2));
      IPIPERC     = cast(IPIPERC as numeric(18,2));
      IPI         = cast(IPI as numeric(18,2));
      ISENTAS     = (VALORBRUTO - ICMSBASE);

      if (ISENTAS < 0) then
        ISENTAS = 0;

      if (PARAM_SIMPLESPB = 'S') then
      begin
        ICMSBASE    = 0;
        ICMSPERC    = 0;
        ICMS        = 0;
        ICMSSTBASE  = 0;
        ICMSSTPERC  = 0;
        ICMSST      = 0;
        ISENTAS     = 0;
      end

      suspend;
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_ACOMPANHAMENTO_CLIENTE(
    ECODVENDEDOR INTEGER,
    EDATAINI DATE,
    EDATAFIM DATE,
    EATIVO INTEGER,
    ECODPESSOA INTEGER,
    ECODSTATUS INTEGER,
    EBAIRRO VARCHAR(60),
    ECIDADE VARCHAR(60),
    EDATAINICADASTRO DATE,
    EDATAFIMCADASTRO DATE)
RETURNS (
    ATIVO INTEGER,
    CODPESSOA INTEGER,
    NOME VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    PESSOA INTEGER,
    CPFCGC VARCHAR(18),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(10),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    FONES VARCHAR(15),
    CODVENDEDOR INTEGER,
    CODIBGE INTEGER,
    IE VARCHAR(30),
    LIMITECRED DOUBLE PRECISION,
    EMAIL VARCHAR(100),
    TOTALCREDITO DOUBLE PRECISION,
    DT_CADAST TIMESTAMP,
    CODPESSOAMATRIZ INTEGER,
    NOMEPESSOAMATRIZ VARCHAR(60),
    OBSBLOQUEIO VARCHAR(200),
    STATUSDESC VARCHAR(60))
AS
DECLARE VARIABLE CODBAIRRO INTEGER;
DECLARE VARIABLE CODESTADO INTEGER;
DECLARE VARIABLE CODCIDADE INTEGER;
DECLARE VARIABLE LVALOR_TOTAL DOUBLE PRECISION;

DECLARE FUNCTION VALOR_TOTAL(ECODPESSOA INTEGER)
RETURNS DOUBLE PRECISION
AS
DECLARE VARIABLE LVALOR_TOTAL DOUBLE PRECISION;
BEGIN
    SELECT
    SUM(PEDVEND.VALOR_TOTAL) VALOR_TOTAL
  FROM
    PEDVEND
  WHERE
    PEDVEND.CODPESSOA = :ECODPESSOA
    AND PEDVEND.STATUSPED = 'FATURADO'
    AND PEDVEND.TIPOPED IN ('VENDA', 'CADERNO')
  INTO
    LVALOR_TOTAL;
  RETURN LVALOR_TOTAL;
END

DECLARE FUNCTION CLIENTEPOSSUIVENDA(
ECODPESSOA INTEGER,
EDTINI TIMESTAMP,
EDTFIM TIMESTAMP)
RETURNS BOOLEAN
AS
DECLARE VARIABLE LQTD INTEGER;
BEGIN
    SELECT
      COUNT(PEDVEND.CODPEDVEND)
    FROM
      PEDVEND
    WHERE
      PEDVEND.CODPESSOA = :ECODPESSOA
      AND PEDVEND.DTFATURADO BETWEEN :EDTINI AND :EDTFIM
      AND PEDVEND.STATUSPED <> 'CANCELADO'
      AND PEDVEND.TIPOPED IN ('VENDA', 'CADERNO')
    INTO
      LQTD;
    
    RETURN LQTD > 0;
END

BEGIN     
  
FOR SELECT
  PESSOA.ATIVO,
  PESSOA.CODPESSOA,
  SUBSTRING(PESSOA.NOME FROM 1 FOR 60) AS NOME,
  SUBSTRING(COALESCE(NULLIF(TRIM(PESSOA.NOMEFANTAZIA), ''), PESSOA.NOME) FROM 1 FOR 60) AS NOMEFANTAZIA,
  PESSOA.PESSOA,
  SUBSTRING(PESSOA.CPFCGC FROM 1 FOR 18) AS CPFCGC,
  SUBSTRING(PESSOA.LOGRADOURO_1 FROM 1 FOR 60) AS LOGRADOURO,
  SUBSTRING(PESSOA.NUMERO_1 FROM 1 FOR 10) AS NUMERO_1,
  SUBSTRING(PESSOA.COMPLEMENTO_1 FROM 1 FOR 60) AS COMPLEMENTO_1,
  PESSOA.CODBAIRRO1,
  SUBSTRING(PESSOA.BAIRRO_1 FROM 1 FOR 45) AS BAIRRO_1,
  SUBSTRING(PESSOA.CIDADE_1 FROM 1 FOR 45) AS CIDADE_1,
  SUBSTRING(PESSOA.UF_1 FROM 1 FOR 2) AS UF_1,
  SUBSTRING(PESSOA.CEP_1 FROM 1 FOR 9) AS CEP_1,
  SUBSTRING(PESSOA.FONES FROM 1 FOR 15) AS FONES,
  PESSOA.CODVENDEDOR,
  PESSOA.CODIBGE,
  PESSOA.IE,
  PESSOA.LIMITECRED,
  SUBSTRING(PESSOA.EMAIL FROM 1 FOR 100) AS EMAIL,
  PESSOA.DT_CADAST,
  COALESCE(PESSOA.CODPESSOAMATRIZ,0),
  COALESCE(PESSOA.OBSBLOQUEIO,'')|| COALESCE(PESSOA.OBSBLOQUEIO1, ''),
  STATUS.DESCRICAO,
  VALOR_TOTAL(PESSOA.CODPESSOA)
FROM
  PESSOA
JOIN STATUS ON
  PESSOA.CODSTATUS = STATUS.CODSTATUS
WHERE
  UPPER(TIPOPESSOA) = 'CLIENTE' AND 
  PESSOA.ATIVO = :EATIVO AND  
  ((:EDATAINI IS NULL AND :EDATAFIM IS NULL) OR (NOT CLIENTEPOSSUIVENDA(PESSOA.CODPESSOA, :EDATAINI, :EDATAFIM))) AND 
  (:ECODPESSOA IS NULL OR PESSOA.CODPESSOAMATRIZ = :ECODPESSOA) AND
  (:EBAIRRO IS NULL OR PESSOA.BAIRRO_1 = :EBAIRRO) AND
  (:ECIDADE IS NULL OR PESSOA.CIDADE_1 = :ECIDADE) AND
  ((:EDATAINICADASTRO IS NULL AND :EDATAFIMCADASTRO IS NULL) OR (PESSOA.DT_CADAST BETWEEN :EDATAINICADASTRO AND :EDATAFIMCADASTRO)) AND
  (:ECODSTATUS IS NULL OR PESSOA.CODSTATUS = :ECODSTATUS)
ORDER BY
  25 DESC
  INTO
  ATIVO,
  CODPESSOA,
  NOME,
  NOMEFANTAZIA,
  PESSOA,
  CPFCGC,
  LOGRADOURO_1,
  NUMERO_1,
  COMPLEMENTO_1,
  CODBAIRRO,
  BAIRRO_1,
  CIDADE_1,
  UF_1,
  CEP_1,
  FONES,
  CODVENDEDOR,
  CODIBGE,
  IE,
  LIMITECRED,
  EMAIL,
  DT_CADAST,
  CODPESSOAMATRIZ,
  OBSBLOQUEIO,
  STATUSDESC,
  LVALOR_TOTAL
  DO
  BEGIN
    
  CEP_1 = REPLACE(CEP_1, '-', '');
  CPFCGC = REPLACE(CPFCGC, '-', '');
  CPFCGC = REPLACE(CPFCGC, '.', '');
  CPFCGC = REPLACE(CPFCGC, '/', '');
  CPFCGC = REPLACE(CPFCGC, ' ', '');

SELECT
  SALDO
FROM
  GET_PESSOASALDO(:CODPESSOA)
INTO
  TOTALCREDITO;

IF (CODPESSOAMATRIZ > 0) THEN
 BEGIN
   SELECT
    NOME
  FROM
    PESSOA
  WHERE
    PESSOA.CODPESSOA = :CODPESSOAMATRIZ
  INTO
    NOMEPESSOAMATRIZ;
  END

IF (CHAR_LENGTH(CPFCGC) <= 11) THEN
    PESSOA = 1;
ELSE
    PESSOA = 2;

IF (COALESCE(CODBAIRRO, 0) > 0) THEN
  BEGIN
    SELECT
      SUBSTRING(TBL_BAIRRO.DESCBAIRRO FROM 1 FOR 45), TBL_BAIRRO.CODCIDADE
    FROM
      TBL_BAIRRO
    WHERE
      TBL_BAIRRO.CODBAIRRO =:CODBAIRRO
      INTO
  BAIRRO_1,
  CODCIDADE;

SELECT
  SUBSTRING(TBL_CIDADES.NOMECIDADE FROM 1 FOR 45) AS NOMECIDADE,
  TBL_CIDADES.CODESTADO,
  COALESCE(NULLIF(:CODIBGE,
  0),
  TBL_CIDADES.CODIBGE)
FROM
  TBL_CIDADES
WHERE
  TBL_CIDADES.CODCIDADE =:CODCIDADE
      INTO
  CIDADE_1,
  CODESTADO,
  CODIBGE;

SELECT
  SUBSTRING(TBL_ESTADO.SIGLA FROM 1 FOR 2) AS SIGLA
FROM
  TBL_ESTADO
WHERE
  TBL_ESTADO.CODESTADO =:CODESTADO
      INTO
  UF_1;
END
    
    SUSPEND;
END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_FABRICANTE(
    EEMAIL VARCHAR(100),
    EFILTRO VARCHAR(100))
RETURNS (
    ATIVO INTEGER,
    CODPESSOA INTEGER,
    NOME VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    PESSOA_CONTATO VARCHAR(30),
    PESSOA INTEGER,
    CPFCGC VARCHAR(18),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(10),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    FONES VARCHAR(15),
    CODVENDEDOR INTEGER,
    CODIBGE INTEGER,
    IE VARCHAR(30),
    EMAIL VARCHAR(100),
    DT_CADAST TIMESTAMP,
    FLAG_BLOQUEADO SMALLINT,
    OBSBLOQUEIO VARCHAR(200),
    STATUSDESC VARCHAR(60))
AS
DECLARE VARIABLE CODBAIRRO INTEGER;
DECLARE VARIABLE CODESTADO INTEGER;
DECLARE VARIABLE CODCIDADE INTEGER;
DECLARE VARIABLE LCODVENDEDOR INTEGER;
DECLARE VARIABLE LCODEMPRESA INTEGER;
DECLARE VARIABLE LCODSTATUSBLOQUEADO INTEGER;
DECLARE VARIABLE FILTRARCODIGO BOOLEAN;
DECLARE VARIABLE LCODIGOFILTRO INTEGER;
DECLARE VARIABLE LSQL BLOB SUB_TYPE 1 SEGMENT SIZE 80;
BEGIN
  IF (EXISTS(SELECT 1 FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_FABRICANTE')) THEN
  BEGIN
    SELECT SQL FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_FABRICANTE' INTO LSQL;
    FOR EXECUTE STATEMENT (LSQL)
    (
        EEMAIL := :EEMAIL,
        EFILTRO := :EFILTRO
    )
    INTO
      ATIVO, 
      CODPESSOA, 
      NOME, 
      NOMEFANTAZIA, 
      PESSOA_CONTATO, 
      PESSOA, 
      CPFCGC, 
      LOGRADOURO_1, 
      NUMERO_1, 
      COMPLEMENTO_1, 
      BAIRRO_1, 
      CIDADE_1, 
      UF_1, 
      CEP_1, 
      FONES, 
      CODVENDEDOR, 
      CODIBGE, 
      IE, 
      EMAIL, 
      DT_CADAST, 
      FLAG_BLOQUEADO, 
      OBSBLOQUEIO, 
      STATUSDESC
    DO
    BEGIN
      SUSPEND;
    END
    EXIT;
  END

  SELECT CODEMPRESA, COALESCE(CODVENDEDOR,0) FROM USERCAD WHERE EMAIL = :EEMAIL INTO LCODEMPRESA, LCODVENDEDOR;
  SELECT SYSPARAMS.CODSTATUS FROM SYSPARAMS INTO LCODSTATUSBLOQUEADO;

  FOR SELECT
    PESSOA.ATIVO,
    PESSOA.CODPESSOA, 
    SUBSTRING(PESSOA.NOME FROM 1 FOR 60) AS NOME,   
    SUBSTRING(COALESCE(NULLIF(TRIM(PESSOA.NOMEFANTAZIA),''),PESSOA.NOME) FROM 1 FOR 60) AS NOMEFANTAZIA,
    PESSOA_CONTATO,
    PESSOA.PESSOA, 
    SUBSTRING(PESSOA.CPFCGC FROM 1 FOR 18) AS CPFCGC, 
    SUBSTRING(PESSOA.LOGRADOURO_1 FROM 1 FOR 60) AS LOGRADOURO,
    SUBSTRING(PESSOA.NUMERO_1 FROM 1 FOR 10) AS NUMERO_1, 
    SUBSTRING(PESSOA.COMPLEMENTO_1 FROM 1 FOR 60) AS COMPLEMENTO_1,  
    PESSOA.CODBAIRRO1,
    SUBSTRING(PESSOA.BAIRRO_1 FROM 1 FOR 45) AS BAIRRO_1, 
    SUBSTRING(PESSOA.CIDADE_1 FROM 1 FOR 45) AS CIDADE_1,   
    SUBSTRING(PESSOA.UF_1 FROM 1 FOR 2) AS UF_1,  
    SUBSTRING(PESSOA.CEP_1 FROM 1 FOR 9) AS CEP_1, 
    SUBSTRING(PESSOA.FONES FROM 1 FOR 15) AS FONES, 
    PESSOA.CODVENDEDOR, 
    PESSOA.CODIBGE,
    PESSOA.IE,
    SUBSTRING(PESSOA.EMAIL FROM 1 FOR 100) AS EMAIL,
    PESSOA.DT_CADAST,
    IIF(PESSOA.CODSTATUS = :LCODSTATUSBLOQUEADO, 1, 0),
    COALESCE(PESSOA.OBSBLOQUEIO,'')||COALESCE(PESSOA.OBSBLOQUEIO1,''),
    STATUS.DESCRICAO
  FROM
    PESSOA
    JOIN STATUS ON
      PESSOA.CODSTATUS = STATUS.CODSTATUS
    WHERE (
      :EFILTRO = '' OR 
      (
      (UPPER(PESSOA.NOME) CONTAINING :EFILTRO) OR
      (UPPER(PESSOA.NOMEFANTAZIA) CONTAINING :EFILTRO) OR
      (TIRARMASCARA(PESSOA.CPFCGC) CONTAINING :EFILTRO) OR
      ('C'||CAST(PESSOA.CODPESSOA AS VARCHAR(100)) = :EFILTRO)
      )  
    ) AND UPPER(PESSOA.TIPOPESSOA)  ='FABRICANTE'
  INTO
    ATIVO,
    CODPESSOA,
    NOME,
    NOMEFANTAZIA,
    PESSOA_CONTATO,
    PESSOA,
    CPFCGC,
    LOGRADOURO_1,
    NUMERO_1,
    COMPLEMENTO_1,
    CODBAIRRO,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    CODVENDEDOR,
    CODIBGE,
    IE,
    EMAIL,
    DT_CADAST,
    FLAG_BLOQUEADO,
    OBSBLOQUEIO,
    STATUSDESC
  DO
  BEGIN
    CEP_1  = TIRARMASCARA(CEP_1);
    CPFCGC = TIRARMASCARA(CPFCGC);
   
    IF (CHAR_LENGTH(CPFCGC) <= 11) THEN
      PESSOA = 1;
    ELSE
      PESSOA = 2;

    IF (COALESCE(CODBAIRRO,0) > 0) THEN
    BEGIN
      SELECT
        SUBSTRING(TBL_BAIRRO.DESCBAIRRO FROM 1 FOR 45),
        TBL_BAIRRO.CODCIDADE
      FROM
        TBL_BAIRRO
      WHERE
        TBL_BAIRRO.CODBAIRRO =:CODBAIRRO
      INTO
        BAIRRO_1,
        CODCIDADE;

      SELECT
        SUBSTRING(TBL_CIDADES.NOMECIDADE FROM 1 FOR 45) AS NOMECIDADE,
        TBL_CIDADES.CODESTADO,
        COALESCE(NULLIF(:CODIBGE,0),TBL_CIDADES.CODIBGE)
      FROM
        TBL_CIDADES
      WHERE
        TBL_CIDADES.CODCIDADE =:CODCIDADE
      INTO
        CIDADE_1,
        CODESTADO,
        CODIBGE;

      SELECT
        SUBSTRING(TBL_ESTADO.SIGLA FROM 1 FOR 2) AS SIGLA
      FROM
        TBL_ESTADO
      WHERE
        TBL_ESTADO.CODESTADO =:CODESTADO
      INTO
        UF_1;
    END       
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_LISTAR_FORNECEDOR(
    EEMAIL VARCHAR(100),
    EFILTRO VARCHAR(100))
RETURNS (
    ATIVO INTEGER,
    CODPESSOA INTEGER,
    NOME VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    PESSOA_CONTATO VARCHAR(30),
    PESSOA INTEGER,
    CPFCGC VARCHAR(18),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(10),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    FONES VARCHAR(15),
    CODVENDEDOR INTEGER,
    CODIBGE INTEGER,
    IE VARCHAR(30),
    EMAIL VARCHAR(100),
    DT_CADAST TIMESTAMP,
    FLAG_BLOQUEADO SMALLINT,
    OBSBLOQUEIO VARCHAR(200),
    STATUSDESC VARCHAR(60))
AS
DECLARE VARIABLE CODBAIRRO INTEGER;
DECLARE VARIABLE CODESTADO INTEGER;
DECLARE VARIABLE CODCIDADE INTEGER;
DECLARE VARIABLE LCODVENDEDOR INTEGER;
DECLARE VARIABLE LCODEMPRESA INTEGER;
DECLARE VARIABLE LCODSTATUSBLOQUEADO INTEGER;
DECLARE VARIABLE FILTRARCODIGO BOOLEAN;
DECLARE VARIABLE LCODIGOFILTRO INTEGER;
DECLARE VARIABLE LSQL BLOB SUB_TYPE 1 SEGMENT SIZE 80;
BEGIN
  IF (EXISTS(SELECT 1 FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_FORNECEDOR')) THEN
  BEGIN
    SELECT SQL FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_FORNECEDOR' INTO LSQL;
    FOR EXECUTE STATEMENT (LSQL)
    (
        EEMAIL := :EEMAIL,
        EFILTRO := :EFILTRO
    )
    INTO
      ATIVO, 
      CODPESSOA, 
      NOME, 
      NOMEFANTAZIA, 
      PESSOA_CONTATO, 
      PESSOA, 
      CPFCGC, 
      LOGRADOURO_1, 
      NUMERO_1, 
      COMPLEMENTO_1, 
      BAIRRO_1, 
      CIDADE_1, 
      UF_1, 
      CEP_1, 
      FONES, 
      CODVENDEDOR, 
      CODIBGE, 
      IE, 
      EMAIL, 
      DT_CADAST, 
      FLAG_BLOQUEADO, 
      OBSBLOQUEIO, 
      STATUSDESC
    DO
    BEGIN
      SUSPEND;
    END
    EXIT;
  END

  SELECT CODEMPRESA, COALESCE(CODVENDEDOR,0) FROM USERCAD WHERE EMAIL = :EEMAIL INTO LCODEMPRESA, LCODVENDEDOR;
  SELECT SYSPARAMS.CODSTATUS FROM SYSPARAMS INTO LCODSTATUSBLOQUEADO;

  FOR SELECT
    PESSOA.ATIVO,
    PESSOA.CODPESSOA, 
    SUBSTRING(PESSOA.NOME FROM 1 FOR 60) AS NOME,   
    SUBSTRING(COALESCE(NULLIF(TRIM(PESSOA.NOMEFANTAZIA),''),PESSOA.NOME) FROM 1 FOR 60) AS NOMEFANTAZIA,
    PESSOA_CONTATO,
    PESSOA.PESSOA, 
    SUBSTRING(PESSOA.CPFCGC FROM 1 FOR 18) AS CPFCGC, 
    SUBSTRING(PESSOA.LOGRADOURO_1 FROM 1 FOR 60) AS LOGRADOURO,
    SUBSTRING(PESSOA.NUMERO_1 FROM 1 FOR 10) AS NUMERO_1, 
    SUBSTRING(PESSOA.COMPLEMENTO_1 FROM 1 FOR 60) AS COMPLEMENTO_1,  
    PESSOA.CODBAIRRO1,
    SUBSTRING(PESSOA.BAIRRO_1 FROM 1 FOR 45) AS BAIRRO_1, 
    SUBSTRING(PESSOA.CIDADE_1 FROM 1 FOR 45) AS CIDADE_1,   
    SUBSTRING(PESSOA.UF_1 FROM 1 FOR 2) AS UF_1,  
    SUBSTRING(PESSOA.CEP_1 FROM 1 FOR 9) AS CEP_1, 
    SUBSTRING(PESSOA.FONES FROM 1 FOR 15) AS FONES, 
    PESSOA.CODVENDEDOR, 
    PESSOA.CODIBGE,
    PESSOA.IE,
    SUBSTRING(PESSOA.EMAIL FROM 1 FOR 100) AS EMAIL,
    PESSOA.DT_CADAST,
    IIF(PESSOA.CODSTATUS = :LCODSTATUSBLOQUEADO, 1, 0),
    COALESCE(PESSOA.OBSBLOQUEIO,'')||COALESCE(PESSOA.OBSBLOQUEIO1,''),
    STATUS.DESCRICAO
  FROM
    PESSOA
    JOIN STATUS ON
      PESSOA.CODSTATUS = STATUS.CODSTATUS
    WHERE (
      :EFILTRO = '' OR 
      (
      (UPPER(PESSOA.NOME) CONTAINING :EFILTRO) OR
      (UPPER(PESSOA.NOMEFANTAZIA) CONTAINING :EFILTRO) OR
      (TIRARMASCARA(PESSOA.CPFCGC) CONTAINING :EFILTRO) OR
      ('C'||CAST(PESSOA.CODPESSOA AS VARCHAR(100)) = :EFILTRO)
      )  
    ) AND PESSOA.TIPOPESSOA  ='FORNECEDOR'
  INTO
    ATIVO,
    CODPESSOA,
    NOME,
    NOMEFANTAZIA,
    PESSOA_CONTATO,
    PESSOA,
    CPFCGC,
    LOGRADOURO_1,
    NUMERO_1,
    COMPLEMENTO_1,
    CODBAIRRO,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    CODVENDEDOR,
    CODIBGE,
    IE,
    EMAIL,
    DT_CADAST,
    FLAG_BLOQUEADO,
    OBSBLOQUEIO,
    STATUSDESC
  DO
  BEGIN
    CEP_1  = TIRARMASCARA(CEP_1);
    CPFCGC = TIRARMASCARA(CPFCGC);
   
    IF (CHAR_LENGTH(CPFCGC) <= 11) THEN
      PESSOA = 1;
    ELSE
      PESSOA = 2;

    IF (COALESCE(CODBAIRRO,0) > 0) THEN
    BEGIN
      SELECT
        SUBSTRING(TBL_BAIRRO.DESCBAIRRO FROM 1 FOR 45),
        TBL_BAIRRO.CODCIDADE
      FROM
        TBL_BAIRRO
      WHERE
        TBL_BAIRRO.CODBAIRRO =:CODBAIRRO
      INTO
        BAIRRO_1,
        CODCIDADE;

      SELECT
        SUBSTRING(TBL_CIDADES.NOMECIDADE FROM 1 FOR 45) AS NOMECIDADE,
        TBL_CIDADES.CODESTADO,
        COALESCE(NULLIF(:CODIBGE,0),TBL_CIDADES.CODIBGE)
      FROM
        TBL_CIDADES
      WHERE
        TBL_CIDADES.CODCIDADE =:CODCIDADE
      INTO
        CIDADE_1,
        CODESTADO,
        CODIBGE;

      SELECT
        SUBSTRING(TBL_ESTADO.SIGLA FROM 1 FOR 2) AS SIGLA
      FROM
        TBL_ESTADO
      WHERE
        TBL_ESTADO.CODESTADO =:CODESTADO
      INTO
        UF_1;
    END       
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_MVARQUITETOS(
    EEMAIL VARCHAR(100))
RETURNS (
    ATIVO INTEGER,
    CODPESSOA INTEGER,
    NOME VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    PESSOA_CONTATO VARCHAR(30),
    PESSOA INTEGER,
    CPFCGC VARCHAR(18),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(10),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    FONES VARCHAR(15),
    CODVENDEDOR INTEGER,
    CODIBGE INTEGER,
    IE VARCHAR(30),
    LIMITECRED DOUBLE PRECISION,
    EMAIL VARCHAR(100),
    TOTALCREDITO DOUBLE PRECISION,
    DT_CADAST TIMESTAMP,
    CODPESSOAMATRIZ INTEGER,
    NOMEPESSOAMATRIZ VARCHAR(60),
    OBSBLOQUEIO VARCHAR(200),
    STATUSDESC VARCHAR(60))
AS
DECLARE VARIABLE CODBAIRRO INTEGER;
DECLARE VARIABLE CODESTADO INTEGER;
DECLARE VARIABLE CODCIDADE INTEGER;
DECLARE VARIABLE LCODVENDEDOR INTEGER;
DECLARE VARIABLE LCODEMPRESA INTEGER;
BEGIN     
  SELECT CODEMPRESA, COALESCE(CODVENDEDOR,0) FROM USERCAD WHERE NULLIF(EMAIL,'') = :EEMAIL INTO LCODEMPRESA, LCODVENDEDOR;

  FOR SELECT
    PESSOA.ATIVO,
    PESSOA.CODPESSOA, 
    SUBSTRING(PESSOA.NOME FROM 1 FOR 60) AS NOME,   
    SUBSTRING(COALESCE(NULLIF(TRIM(PESSOA.NOMEFANTAZIA),''),PESSOA.NOME) FROM 1 FOR 60) AS NOMEFANTAZIA,
    PESSOA_CONTATO,
    PESSOA.PESSOA, 
    SUBSTRING(PESSOA.CPFCGC FROM 1 FOR 18) AS CPFCGC, 
    SUBSTRING(PESSOA.LOGRADOURO_1 FROM 1 FOR 60) AS LOGRADOURO,
    SUBSTRING(PESSOA.NUMERO_1 FROM 1 FOR 10) AS NUMERO_1, 
    SUBSTRING(PESSOA.COMPLEMENTO_1 FROM 1 FOR 60) AS COMPLEMENTO_1,  
    PESSOA.CODBAIRRO1,
    SUBSTRING(PESSOA.BAIRRO_1 FROM 1 FOR 45) AS BAIRRO_1, 
    SUBSTRING(PESSOA.CIDADE_1 FROM 1 FOR 45) AS CIDADE_1,   
    SUBSTRING(PESSOA.UF_1 FROM 1 FOR 2) AS UF_1,  
    SUBSTRING(PESSOA.CEP_1 FROM 1 FOR 9) AS CEP_1, 
    SUBSTRING(PESSOA.FONES FROM 1 FOR 15) AS FONES, 
    PESSOA.CODVENDEDOR, 
    PESSOA.CODIBGE,
    PESSOA.IE,
    PESSOA.LIMITECRED,
    SUBSTRING(PESSOA.EMAIL FROM 1 FOR 100) AS EMAIL,
    PESSOA.DT_CADAST,
    COALESCE(PESSOA.CODPESSOAMATRIZ,0),
    COALESCE(PESSOA.OBSBLOQUEIO,'')||COALESCE(PESSOA.OBSBLOQUEIO1,''),
    STATUS.DESCRICAO
  FROM
    PESSOA
    LEFT JOIN STATUS ON
      PESSOA.CODSTATUS = STATUS.CODSTATUS
  WHERE
    UPPER(TIPOPESSOA) = 'ARQUITETO'
  INTO
    ATIVO,
    CODPESSOA,
    NOME,
    NOMEFANTAZIA,
    PESSOA_CONTATO,
    PESSOA,
    CPFCGC,
    LOGRADOURO_1,
    NUMERO_1,
    COMPLEMENTO_1,
    CODBAIRRO,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    CODVENDEDOR,
    CODIBGE,
    IE,
    LIMITECRED,
    EMAIL,
    DT_CADAST,
    CODPESSOAMATRIZ,
    OBSBLOQUEIO,
    STATUSDESC
  DO
  BEGIN
    CEP_1  = REPLACE(CEP_1,'-','');
    CPFCGC = REPLACE(CPFCGC,'-','');
    CPFCGC = REPLACE(CPFCGC,'.','');
    CPFCGC = REPLACE(CPFCGC,'/','');
    CPFCGC = REPLACE(CPFCGC,' ','');

    SELECT SALDO FROM GET_PESSOASALDO(:CODPESSOA) INTO TOTALCREDITO;

    IF (CODPESSOAMATRIZ > 0) THEN
    BEGIN
      SELECT NOME FROM PESSOA WHERE PESSOA.CODPESSOA = :CODPESSOAMATRIZ INTO NOMEPESSOAMATRIZ;
    END

    IF (CHAR_LENGTH(CPFCGC) <= 11) THEN
      PESSOA = 1;
    ELSE
      PESSOA = 2;

    IF (COALESCE(CODBAIRRO,0) > 0) THEN
    BEGIN
      SELECT
        SUBSTRING(TBL_BAIRRO.DESCBAIRRO FROM 1 FOR 45),
        TBL_BAIRRO.CODCIDADE
      FROM
        TBL_BAIRRO
      WHERE
        TBL_BAIRRO.CODBAIRRO =:CODBAIRRO
      INTO
        BAIRRO_1,
        CODCIDADE;

      SELECT
        SUBSTRING(TBL_CIDADES.NOMECIDADE FROM 1 FOR 45) AS NOMECIDADE,
        TBL_CIDADES.CODESTADO,
        COALESCE(NULLIF(:CODIBGE,0),TBL_CIDADES.CODIBGE)
      FROM
        TBL_CIDADES
      WHERE
        TBL_CIDADES.CODCIDADE =:CODCIDADE
      INTO
        CIDADE_1,
        CODESTADO,
        CODIBGE;

      SELECT
        SUBSTRING(TBL_ESTADO.SIGLA FROM 1 FOR 2) AS SIGLA
      FROM
        TBL_ESTADO
      WHERE
        TBL_ESTADO.CODESTADO =:CODESTADO
      INTO
        UF_1;
    END       
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DIACCERA_VENDAS(
    EDATAINI DATE,
    EDATAFIM DATE,
    ECOD INTEGER)
RETURNS (
    DUN VARCHAR(30),
    CNPJCLIENTE VARCHAR(18),
    CLIENTE VARCHAR(60),
    CODSEGMENTO INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA VARCHAR(20),
    TIPOPED VARCHAR(10),
    TIPOPESSOA VARCHAR(1),
    PDV_EMPRESA VARCHAR(60),
    PDV_CEP VARCHAR(9),
    NOME_VENDEDOR VARCHAR(60),
    CODNFVENDA VARCHAR(14),
    VLRVENDIDO VARCHAR(30),
    QTDVENDIDA VARCHAR(30),
    QTDEMBALAGEM INTEGER,
    TIPOCODIGO VARCHAR(10),
    CODGRUPO INTEGER,
    CODPESSOA INTEGER,
    CODSTATUS_CHECKOUT INTEGER,
    ATIVIDADE VARCHAR(60),
    CODPRODFILHO INTEGER,
    PRODUTO VARCHAR(60),
    QTD NUMERIC(15,2),
    QTDUNIDADE NUMERIC(15,2),
    VALOR NUMERIC(15,2),
    CODSUPERVISOR INTEGER,
    CNPJFABRICANTE VARCHAR(20))
AS
declare variable DTINI date;
declare variable LFABRICANTES varchar(100);
declare variable LGRUPOS varchar(500);
BEGIN
  SELECT COALESCE(CODFABRICANTE,''), COALESCE(CODGRUPOS,'') FROM INTEGRACAOARQ WHERE IDINTEGRACAOARQ = :ECOD INTO LFABRICANTES, LGRUPOS;
  LFABRICANTES = TRIM(REPLACE(LFABRICANTES,' ',''));
  LGRUPOS = TRIM(REPLACE(LGRUPOS,' ',''));

  SELECT
    TIRARMASCARA(EMPRESA.CGC),
    TIRARMASCARA(EMPRESA.CEP)
  FROM
    EMPRESA
    JOIN INTEGRACAOARQ ON
      EMPRESA.CODEMPRESA = INTEGRACAOARQ.CODEMPRESA
  WHERE
    IDINTEGRACAOARQ = :ECOD
  INTO
    CNPJDISTRIBUIDOR,
    PDV_CEP;

  FOR SELECT
   CASE COALESCE(PRODFILHO.CODPESQ2 ,'')
      WHEN '' THEN
        PRODFILHO.CODPRODFILHO
      ELSE
        PRODFILHO.CODPESQ2
    END DUN,
    TIRARMASCARA(PESSOA.CPFCGC) CNPJCLIENTE,
    PESSOA.NOME CLIENTE,
    PESSOA.NOME,
    TIRARMASCARA(PESSOA.CEP_1),
    CASE COALESCE(TBL_RAMOATVTIPO.REFERENCIA,'')
      WHEN '' THEN 0
      ELSE TBL_RAMOATVTIPO.REFERENCIA
      END CODSEGMENTOPEPSICO,
    PEDVEND.CODVENDEDOR,
    (EXTRACT(YEAR FROM COALESCE(PEDVEND.DTFATURADO, PEDVEND.DT_SAIDA)) || RIGHT('00'||EXTRACT(MONTH FROM COALESCE(PEDVEND.DTFATURADO, PEDVEND.DT_SAIDA)),2) || RIGHT('00'||EXTRACT(DAY FROM COALESCE(PEDVEND.DTFATURADO, PEDVEND.DT_SAIDA)),2)) AS DATAVENDA,
    CASE
      WHEN PEDVEND.STATUSPED = 'CANCELADO' THEN 'C'
      WHEN PEDVEND.STATUSPED = 'DEVOLVIDO' THEN 'DV'
      WHEN ((PEDVEND.STATUSPED = 'FATURADO') AND (PEDVEND.TIPOPED IN ('VENDA','CADERNO'))) THEN 'V'
      WHEN ((PEDVEND.STATUSPED = 'FATURADO') AND (PEDVEND.TIPOPED = 'BONIFICA')) THEN 'B'
      WHEN ((PEDVEND.STATUSPED = 'FATURADO') AND (PEDVEND.TIPOPED IN ('TRANSFERENCIA','REMESSA F.')))  THEN 'T'
    END AS TIPOPED,
    COALESCE(PEDVEND.CODNFVENDA,PEDVEND.CODPEDVEND),
    PESSOA.PESSOA,
    COALESCE(NULLIF(PRODFILHO.QTDEMBALAGEM,1),1),
    CAST(CAST(SUM(((COALESCE(PEDVENDITEM.PRECOPROD,0) * COALESCE(PEDVENDITEM.QTDENTREGUE,1))
    + (((COALESCE(PEDVEND.ACRESVALOR,0) + (COALESCE(PEDVEND.VALOR_BRUTO,0) * (COALESCE(PEDVEND.ACRESCIMO,0)/100))) * (COALESCE(PEDVENDITEM.PRECOVEND,0) / COALESCE(NULLIF(PEDVEND.VALOR_BRUTO,1),1))))
    ) - (((COALESCE(PEDVEND.DESC_VALOR,0) + COALESCE(PEDVEND.DESCPERC_VALOR,0)) * (COALESCE(PEDVENDITEM.PRECOVEND,0) / COALESCE(NULLIF(PEDVEND.VALOR_BRUTO,1),1))) + COALESCE(PEDVENDITEM.DESCONTO_VALOR,0))) AS NUMERIC(18,2)) AS VARCHAR(30)) AS VLRVENDIDO,
    CAST(SUM(COALESCE(PEDVENDITEM.QTDE,0)) AS NUMERIC(18,5)) AS QTDVENDIDA,
    PRODUTO.CODGRUPO,
    PEDVEND.CODPESSOA,
    PESSOA.CODSTATUS_CHECKOUT,
    PRODFILHO.CODPRODFILHO,
    PRODFILHO.DESCRICAO
  FROM
    PEDVEND
    JOIN PESSOA ON (PESSOA.CODPESSOA = PEDVEND.CODPESSOA)
    LEFT JOIN TBL_RAMOATVTIPO ON (PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO)
    JOIN PEDVENDITEM ON PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
    JOIN PRODFILHO ON PEDVENDITEM.CODPRODFILHO =  PRODFILHO.CODPRODFILHO
    JOIN PRODUTO ON PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
  WHERE
    PEDVEND.STATUSPED in ('FATURADO','CANCELADO', 'DEVOLVIDO') AND
    PEDVEND.TIPOPED IN ('VENDA','CADERNO','BONIFICA','DEVOLU????O') AND
    COALESCE(PEDVEND.DTFATURADO, PEDVEND.DT_SAIDA) BETWEEN :EDATAINI AND :EDATAFIM
    AND (
      :LFABRICANTES = '' OR
      ','||:LFABRICANTES||',' CONTAINING ','||PRODUTO.CODFABRICANTE||','
    )
    AND (
      :LGRUPOS = '' OR
      ','||:LGRUPOS||',' CONTAINING ','||PRODUTO.CODGRUPO||','
    )
  GROUP BY
    1,2,3,4,5,6,7,8,9,10,11,12,15,16,17,18,19
  INTO
    :DUN,
    :CNPJCLIENTE,
    :CLIENTE,
    :PDV_EMPRESA,
    :PDV_CEP,
    :CODSEGMENTO,
    :CODVENDEDOR,
    :DATAVENDA,
    :TIPOPED,
    :CODNFVENDA,
    :TIPOPESSOA,
    :QTDEMBALAGEM,
    :VALOR,
    :QTD,
    :CODGRUPO,
    :CODPESSOA,
    :CODSTATUS_CHECKOUT,
    :CODPRODFILHO,
    PRODUTO
  DO
  BEGIN
    IF (CHAR_LENGTH(DUN) > 13) THEN
    BEGIN
       QTDUNIDADE = QTD * QTDEMBALAGEM;
       QTDVENDIDA = CAST(((QTD * QTDEMBALAGEM) * 1000) AS INTEGER);
       TIPOCODIGO = 'DUN';
    END
    ELSE
    BEGIN
       QTDUNIDADE = QTD;
       QTDVENDIDA = CAST((QTD * 1000) AS INTEGER);
       TIPOCODIGO = 'EAN';
    END

    VLRVENDIDO = CAST((VALOR * 100) AS INTEGER);

    CODSUPERVISOR = 0;

    SELECT
      VENDEDOR.CODVENDEDOR || ' - ' || VENDEDOR.NOME,
      VENDEDOR.CODSUPERVISOR
    FROM
      VENDEDOR
    WHERE
      VENDEDOR.CODVENDEDOR = :CODVENDEDOR
    INTO
      :NOME_VENDEDOR,
      :CODSUPERVISOR;

    ATIVIDADE = '';

    SELECT STATUS.DESCRICAO FROM STATUS WHERE STATUS.CODSTATUS = :CODSTATUS_CHECKOUT INTO :ATIVIDADE;

    IF (ATIVIDADE = 'S.M. 05 A 09') THEN
    BEGIN
      ATIVIDADE = '5 A 9 CKS';
    END
    ELSE
    BEGIN
      ATIVIDADE = 'TRADICIONAL';
    END
    
    IF (COALESCE(CNPJCLIENTE,'') = '') THEN
    BEGIN
      CNPJCLIENTE = '11111111111111';
    END

    CNPJFABRICANTE = '50955707000472';

    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MVALIDANFEIBGE(
    ECODPEDVEND INTEGER,
    ECODANALISECRITERIO INTEGER)
RETURNS (
    APROVADO VARCHAR(1))
AS
declare variable LMENSAGEM varchar(200);
declare variable LCAMPOS varchar(130);
declare variable LCODIBGE integer;
declare variable LTIPOPED varchar(10);
declare variable LCODBAIRRO1 integer;
declare variable LCODIBGECIDADE varchar(7);
BEGIN
  /* ROTINA QUE VERIFICA OS CAMPOS OBRIGATORIOS DA PESSOA FORAM PREENCHIDOS */
  APROVADO = 'S';
  LCAMPOS = '';
  IF (NOT EXISTS(SELECT CODIGO FROM PEDVEND_VALIDADOSNFE WHERE CODPEDVEND = :ECODPEDVEND AND

  TIPO_CRITICA = :ECODANALISECRITERIO AND USUARIO_LIBEROU IS NOT NULL)) THEN
  BEGIN
    DELETE FROM
      PEDVEND_VALIDADOSNFE
    WHERE
      CODPEDVEND = :ECODPEDVEND AND
      TIPO_CRITICA = :ECODANALISECRITERIO;

    SELECT
      coalesce(PS.CODIBGE,0),
      p.tipoped,
      PS.CODBAIRRO1
    FROM
      PEDVEND P JOIN PESSOA PS ON P.CODPESSOA = PS.CODPESSOA
    WHERE
      CODPEDVEND = :ECODPEDVEND and P.TIPOPED <> 'CADERNO'
    into
      :LCODIBGE,
      :LTIPOPED,
      :LCODBAIRRO1;

    select TBL_CIDADES.CODIBGE from TBL_BAIRRO
    inner join TBL_CIDADES on TBL_CIDADES.CODCIDADE = TBL_BAIRRO.CODCIDADE
    inner join TBL_ESTADO on TBL_CIDADES.CODESTADO = TBL_ESTADO.CODESTADO
    where TBL_BAIRRO.CODBAIRRO = :LCODBAIRRO1
    into :LCODIBGECIDADE;

    if (CHAR_LENGTH(LCODIBGECIDADE) = 7) then
    begin
       LCODIBGE = LCODIBGECIDADE;
    end

    if ((coalesce(LCODIBGE,0) = 0) and (LTIPOPED <> 'CADERNO')) then
    begin
      APROVADO = 'N';
      LMENSAGEM = 'O CLIENTE SEM O CDIGO IBGE';
      EXECUTE PROCEDURE MINSERECRITICANFE(:ECODPEDVEND, :ECODANALISECRITERIO, :LMENSAGEM);
    END
  END
  SUSPEND;
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE NOTAFISCALELETRONICA(
    ECODNFVENDA INTEGER,
    ESERIE VARCHAR(3))
RETURNS (
    SCODUFEMITENTE INTEGER,
    SCODIBGEEMITENTE INTEGER,
    SCNPJEMITENTE VARCHAR(18),
    SIEEMITENTE VARCHAR(30),
    SIMEMITENTE VARCHAR(30),
    SRAZAOSOCIALEMITENTE VARCHAR(60),
    SEMPRESAEMITENTE VARCHAR(60),
    SLOGRADOUROEMITENTE VARCHAR(60),
    SNUMEROEMITENTE VARCHAR(30),
    SBAIRROEMITENTE VARCHAR(45),
    SCIDADEEMITENTE VARCHAR(60),
    SUFEMITENTE VARCHAR(2),
    SCEPEMITENTE VARCHAR(9),
    SFONESEMITENTE VARCHAR(42),
    SCNAEFISCALEMITENTE INTEGER,
    SCODRANDOMICO VARCHAR(9),
    SNFREFERENCIADA VARCHAR(44),
    SNATUREZA VARCHAR(50),
    SCODTIPOPAG INTEGER,
    SSERIE VARCHAR(3),
    SCODNFVENDA INTEGER,
    SDT_EMISSAO TIMESTAMP,
    STIPONOTA CHAR(1),
    SCODPESSOA INTEGER,
    SFRETE DOUBLE PRECISION,
    SSUGURO DOUBLE PRECISION,
    SICMSBASE DOUBLE PRECISION,
    SICMSISENTOTOTAL DOUBLE PRECISION,
    SICMSSUBSTPERC DOUBLE PRECISION,
    SICMSSUBSTVALOR DOUBLE PRECISION,
    SICMSTOTAL DOUBLE PRECISION,
    SICMS_FRETE DOUBLE PRECISION,
    SNRSELO VARCHAR(11),
    STOTALPRODUTOS DOUBLE PRECISION,
    SOUTRASDESPESA DOUBLE PRECISION,
    STOTALNOTA DOUBLE PRECISION,
    SDESCONTONOTA DOUBLE PRECISION,
    SVALORIPI DOUBLE PRECISION,
    STIPOFRETE CHAR(1),
    SCODTRANSPORT INTEGER,
    STIPODOCTRANST INTEGER,
    SCGCTRANSPORT VARCHAR(18),
    SNOMETRANSPORT VARCHAR(60),
    SIETRANSPORT VARCHAR(30),
    SLOGRADOUROTRANSPORT VARCHAR(60),
    SCIDADETRANSPORT VARCHAR(45),
    SUFTRANSPORT VARCHAR(2),
    SPLACATRANSPORT VARCHAR(8),
    STIPODESTINATARIO SMALLINT,
    SCPFCGCDESTINATARIO VARCHAR(18),
    SNOMEDESTINATARIO VARCHAR(60),
    SLOGRADOURO_1DESTINATARIO VARCHAR(60),
    SNUMERO_1DESTINATARIO VARCHAR(30),
    SBAIRRO_1DESTINATARIO VARCHAR(45),
    SCODIBGEDESTINATARIO VARCHAR(7),
    SCIDADE_1DESTINATARIO VARCHAR(45),
    SUF_1DESTINATARIO CHAR(2),
    SCEP_1DESTINATARIO VARCHAR(9),
    SIEDESTINATARIO VARCHAR(30),
    SSUFRAMADESTINATARIO INTEGER,
    SCODNFVENDAITEM INTEGER,
    SCODPRODFILHO INTEGER,
    SCODPESQUISA VARCHAR(30),
    SCODPESQ1 VARCHAR(30),
    SCODPESQ2 VARCHAR(30),
    SDESCRICAOPRODUTO VARCHAR(120),
    SUNIDADE VARCHAR(15),
    STRIBUTADO VARCHAR(4),
    SORIGEMMERCADORIA SMALLINT,
    SSIGLA VARCHAR(5),
    SCODCFOP INTEGER,
    SCFOP_CFOP VARCHAR(4),
    SQTDE DOUBLE PRECISION,
    SPRECOVEND DOUBLE PRECISION,
    STOTALVLR DOUBLE PRECISION,
    SDESCVLR DOUBLE PRECISION,
    SICMSPERC DOUBLE PRECISION,
    SICMSVALOR DOUBLE PRECISION,
    SIPIBASE DOUBLE PRECISION,
    SIPIPERC DOUBLE PRECISION,
    SIPIVALOR DOUBLE PRECISION,
    SALIQ_SUBS DOUBLE PRECISION,
    SBASE_SUBS DOUBLE PRECISION,
    SVALOR_SUBS DOUBLE PRECISION,
    SICMSISENTO DOUBLE PRECISION,
    SCSTPIS CHAR(2),
    SPISBASE DOUBLE PRECISION,
    SPERC_PIS DOUBLE PRECISION,
    SPISVALOR DOUBLE PRECISION,
    SCSTCOFINS CHAR(2),
    SCOFINSBASE DOUBLE PRECISION,
    SPERC_COFINS DOUBLE PRECISION,
    SCOFINSVALOR DOUBLE PRECISION,
    SQTDETRANSPORTADO DOUBLE PRECISION,
    SPESOBRUTO DOUBLE PRECISION,
    SPESOLIQUI DOUBLE PRECISION,
    SQTDEVOLUME DOUBLE PRECISION,
    SMARCA VARCHAR(15),
    SESPECIE VARCHAR(15),
    SNFV_OBSNOTA3 VARCHAR(70),
    SNFV_OBSNOTA4 VARCHAR(70),
    SNFV_OBSNOTA5 VARCHAR(70),
    SNFV_OBSNOTA6 VARCHAR(70),
    SNFV_OBSNOTA7 VARCHAR(70),
    SNFV_OBSNOTA8 VARCHAR(70),
    SNFV_OBSNOTA9 VARCHAR(70),
    SOBSCORPONOTA1 VARCHAR(255),
    SOBSCORPONOTA2 VARCHAR(255),
    SOBSCORPONOTA3 VARCHAR(255),
    SCHAVE VARCHAR(44),
    SSTATUSCHAVE VARCHAR(1),
    STIPOSUBSTRIB INTEGER,
    SVALORAGREGADO DOUBLE PRECISION,
    SCODPEDVENDITEM INTEGER,
    SLISTA CHAR(1),
    SCLASSFISCAL VARCHAR(20),
    SPMC DOUBLE PRECISION,
    SOBSLOTE VARCHAR(1000),
    SPERC_REDUCAO DOUBLE PRECISION,
    SBASEICMS_PRODUTO DOUBLE PRECISION,
    SBASEICMSSUBS_NOTA DOUBLE PRECISION,
    SPERC_VA DOUBLE PRECISION,
    SFONES_CLI VARCHAR(120),
    SFRETEIMP VARCHAR(1),
    LCFOPCABECARIO VARCHAR(1),
    SPROTOCOLO VARCHAR(15),
    SDT_CONFIRMACAO TIMESTAMP,
    SQTD_PECAS DOUBLE PRECISION,
    SEMBARQUE INTEGER,
    SDT_SAIDA TIMESTAMP,
    SEMAILCLIENTE VARCHAR(60),
    SFRETEITEM DOUBLE PRECISION,
    SOUTRASDESPESASITEM DOUBLE PRECISION,
    SANP VARCHAR(9),
    STOTALTRIBUTOS DOUBLE PRECISION,
    SPEDIDOCOMPRA VARCHAR(10),
    SSEQITEM INTEGER,
    SGRUPO VARCHAR(60),
    SOBSERVACAO BLOB SUB_TYPE TEXT SEGMENT SIZE 4096,
    SPAIS VARCHAR(35),
    SCODPAIS VARCHAR(4),
    SDT_VENCIM TIMESTAMP,
    STOTALTRIBUTOSITEM DOUBLE PRECISION,
    SBASEUFDEST DOUBLE PRECISION,
    SPERCFCP DOUBLE PRECISION,
    SICMSDEST DOUBLE PRECISION,
    SICMSINTER DOUBLE PRECISION,
    SPERCPARTILHA DOUBLE PRECISION,
    SVALORFCP DOUBLE PRECISION,
    SVALORICMSDEST DOUBLE PRECISION,
    SVALORICMSINTER DOUBLE PRECISION,
    SPERCICMSCREDITO DOUBLE PRECISION)
AS
declare variable LTRIBUTADO char(1);
declare variable LTRIBUTADOICMS char(3);
declare variable LTRIBUTADOICMSFORA char(3);
declare variable CODPEDVENDITEM integer;
declare variable LCOD integer;
declare variable LQTDE double precision;
declare variable LPRECO double precision;
declare variable LSIGLA varchar(5);
declare variable LLOTE varchar(12);
declare variable LQTDLOTE double precision;
declare variable LDATAVALIDADE timestamp;
declare variable LBASEICMS_CORPO char(10);
declare variable LUTILIZARPESOPEDIDO integer;
declare variable LCODPEDVEND integer;
declare variable LNAO_IMPORTA_DESC_PED char(1);
declare variable LICMSCFOP char(1);
declare variable LPECAS_QUANT_QUANDO_ZERO varchar(1);
declare variable LCODEMPRESA integer;
declare variable LSSYS_OPTANTESIMPLES char(1);
declare variable LFATORITEM double precision;
declare variable LVALOR_UND smallint;
declare variable LCODANP integer;
declare variable LORIGEM integer;
declare variable LOBSERVACAOITEM varchar(200);
declare variable LUTILIZAROBSPORATIVIDADE char(1);
declare variable LCODOBS integer;
declare variable LCODIBGECIDADE varchar(7);
declare variable LCODBAIRRO1 integer;
declare variable LCST varchar(4);
begin
  select 
    coalesce(SE.CODEMPRESA, 0)
  from
    SERIE SE
  where 
    SE.SERIE = :ESERIE
  into
    LCODEMPRESA;

  select
    coalesce(NP.NAOIMPORT_DESC_PED, 'N'),
    coalesce(NP.IMPRIMIRCFOP_CABECARIO, 'N'),
    coalesce(NP.PECAS_QUANT_QUANDO_ZERO, 'N')
  from
    NFPARAMS NP
  where 
    ((NP.CODEMPRESA = :LCODEMPRESA) or (:LCODEMPRESA = 0))
  into
    LNAO_IMPORTA_DESC_PED,
    LCFOPCABECARIO,
    LPECAS_QUANT_QUANDO_ZERO;

  SBASEICMSSUBS_NOTA = 0;

  select
    sum(coalesce((select first 1 IB.ALIQ_NAC from IBPT IB where IB.NCM = PF.CLASSFISCAL), 0) / 100 * NI.TOTALVLR)
  from
    NFVENDAITEM NI
    join PRODFILHO PF on PF.CODPRODFILHO = NI.CODPRODFILHO
  where
    NI.CODNFVENDA = :ECODNFVENDA and
    NI.SERIE      = :ESERIE
  into
    STOTALTRIBUTOS;

  select
    SP.CODUF,
    SP.CODIBGE,
    SP.CGC,
    SP.IE,
    SP.IM,
    SP.RAZAOSOCIAL,
    SP.EMPRESA,
    SP.LOGRADOURO,
    SP.NUMERO,
    SP.BAIRRO,
    SP.CIDADE,
    SP.UF,
    SP.CEP,
    SP.FONES,
    SP.CNAEFISCAL,
    SP.ICMSCFOP,
    SP.SYS_OPTANTESIMPLES
  from
    SYSPARAMS SP
  into
    SCODUFEMITENTE,
    SCODIBGEEMITENTE,
    SCNPJEMITENTE,
    SIEEMITENTE,
    SIMEMITENTE,
    SRAZAOSOCIALEMITENTE,
    SEMPRESAEMITENTE,
    SLOGRADOUROEMITENTE,
    SNUMEROEMITENTE,
    SBAIRROEMITENTE,
    SCIDADEEMITENTE,
    SUFEMITENTE,
    SCEPEMITENTE,
    SFONESEMITENTE,
    SCNAEFISCALEMITENTE,
    LICMSCFOP,
    LSSYS_OPTANTESIMPLES;

  select
    ML.VALOR
  from
    MLERPARAMETROLOGICO('UTILIZAR OBS POR TIPO DE ATIVIDADE', 0) ML
  into
    LUTILIZAROBSPORATIVIDADE;

  select
    NV.CODRANDOMICO,
    NV.NFREFERENCIADA,
    NV.NATUREZA,
    NV.CODTIPOPAG,
    NV.SERIE,
    NV.CODNFVENDA,
    NV.DT_EMISSAO,
    coalesce(NV.NFV_DTIMPRESSAO, current_timestamp),
    NV.TIPONOTA,
    NV.CODPESSOA,
    coalesce(NV.FRETEVLR, 0),
    coalesce(NV.SEGUROVLR, 0),
    coalesce(NV.ICMSBASE, 0),
    coalesce(NV.ICMSISENTOTOTAL, 0),
    coalesce(NV.ICMSSUBSTPERC, 0),
    coalesce(NV.ICMSSUBSTVALOR, 0),
    coalesce(NV.ICMSTOTAL, 0),
    coalesce(NV.ICMS_FRETE, 0),
    NV.NRSELO,
    coalesce(NV.TOTALPRODUTOS, 0),
    coalesce(NV.OUTRASDESPESA, 0),
    coalesce(NV.TOTALNOTA, 0),
    coalesce(NV.VLRDESCONT, 0),
    coalesce(NV.VALORIPI, 0),
    coalesce(NV.TIPOFRETE,'1'),
    coalesce(NV.CODTRANSPORT, 0),
    coalesce(NV.QTDETRANSPORTADO, 0),
    coalesce(NV.PESOBRUTO, 0),
    coalesce(NV.PESOLIQUI, 0),
    coalesce(NV.QTDEVOLUME, 0),
    NV.MARCA,
    NV.ESPECIE,
    NV.NFV_OBSNOTA3,
    NV.NFV_OBSNOTA4,
    NV.NFV_OBSNOTA5,
    NV.NFV_OBSNOTA6,
    NV.NFV_OBSNOTA7,
    NV.NFV_OBSNOTA8,
    NV.NFV_OBSNOTA9,
    NV.OBSCORPONOTA1,
    NV.OBSCORPONOTA2,
    NV.OBSCORPONOTA3,
    NV.CHAVE,
    NV.STATUSCHAVE,
    coalesce(NV.ICMSSUBSBASE, 0),
    NV.PLACA_TRANSP,
    coalesce(NV.CODPEDVEND, 0),
    NV.PROTOCOLO,
    NV.DT_CONFIRMACAONFE,
    coalesce(NV.ICMSCREDITO,0)
  from
    NFVENDA NV
  where
    NV.CODNFVENDA = :ECODNFVENDA and
    NV.SERIE      = :ESERIE
  into
    SCODRANDOMICO,
    SNFREFERENCIADA,
    SNATUREZA,
    SCODTIPOPAG,
    SSERIE,
    SCODNFVENDA,
    SDT_EMISSAO,
    SDT_SAIDA,
    STIPONOTA,
    SCODPESSOA,
    SFRETE,
    SSUGURO,
    SICMSBASE,
    SICMSISENTOTOTAL,
    SICMSSUBSTPERC,
    SICMSSUBSTVALOR,
    SICMSTOTAL,
    SICMS_FRETE,
    SNRSELO,
    STOTALPRODUTOS,
    SOUTRASDESPESA,
    STOTALNOTA,
    SDESCONTONOTA,
    SVALORIPI,
    STIPOFRETE,
    SCODTRANSPORT,
    SQTDETRANSPORTADO,
    SPESOBRUTO,
    SPESOLIQUI,
    SQTDEVOLUME,
    SMARCA,
    SESPECIE,
    SNFV_OBSNOTA3,
    SNFV_OBSNOTA4,
    SNFV_OBSNOTA5,
    SNFV_OBSNOTA6,
    SNFV_OBSNOTA7,
    SNFV_OBSNOTA8,
    SNFV_OBSNOTA9,
    SOBSCORPONOTA1,
    SOBSCORPONOTA2,
    SOBSCORPONOTA3,
    SCHAVE,
    SSTATUSCHAVE,
    SBASEICMSSUBS_NOTA,
    SPLACATRANSPORT,
    LCODPEDVEND,
    SPROTOCOLO,
    SDT_CONFIRMACAO,
    SPERCICMSCREDITO;

  SFRETEIMP = STIPOFRETE;
  
  if (STIPOFRETE = 1) then
    STIPOFRETE = 0;
  else if (STIPOFRETE = 2) then
    STIPOFRETE = 1;

  if (coalesce(SCODTRANSPORT, 0) = 0) then
    STIPOFRETE = 9;

  SICMSBASE      = cast(coalesce(SICMSBASE, 0) as numeric(18,2));
  SICMSTOTAL     = cast(coalesce(SICMSTOTAL, 0) as numeric(18,2));
  SFRETE         = cast(coalesce(SFRETE, 0) as numeric(18,2));
  SSUGURO        = cast(coalesce(SSUGURO, 0) as numeric(18,2));
  STOTALPRODUTOS = cast(coalesce(STOTALPRODUTOS, 0) as numeric(18,2));
  SOUTRASDESPESA = cast(coalesce(SOUTRASDESPESA, 0) as numeric(18,2));
  SVALORIPI      = cast(coalesce(SVALORIPI, 0) as numeric(18,2));
  STOTALNOTA     = cast(STOTALNOTA as numeric(18,2));

  select
    coalesce(TR.PESSOA,1),
    TR.CGC,
    TR.NOME,
    TR.IE,
    TR.LOGRADOURO,
    TR.CIDADE,
    TR.UF
  from
    TRANSPORT TR
  where
    TR.CODTRANSPORT = :SCODTRANSPORT
  into
    STIPODOCTRANST,
    SCGCTRANSPORT,
    SNOMETRANSPORT,
    SIETRANSPORT,
    SLOGRADOUROTRANSPORT,
    SCIDADETRANSPORT,
    SUFTRANSPORT;

  select
    PE.PESSOA,
    PE.CPFCGC,
    PE.NOME,
    PE.LOGRADOURO_1,
    PE.NUMERO_1,
    PE.BAIRRO_1,
    PE.CODIBGE,
    PE.CIDADE_1,
    PE.UF_1,
    PE.CEP_1,
    PE.IE,
    PE.PES_CODIGOSUFRAMA,
    PE.FONES,
    coalesce(PE.EMAIL_NFE, PE.EMAIL),
    coalesce(nullif(PE.CODPAIS, ''), '1058'),
    PE.CODBAIRRO1
  from
    PESSOA PE
  where
    PE.CODPESSOA = :SCODPESSOA
  into
    STIPODESTINATARIO,
    SCPFCGCDESTINATARIO,
    SNOMEDESTINATARIO,
    SLOGRADOURO_1DESTINATARIO,
    SNUMERO_1DESTINATARIO,
    SBAIRRO_1DESTINATARIO,
    SCODIBGEDESTINATARIO,
    SCIDADE_1DESTINATARIO,
    SUF_1DESTINATARIO,
    SCEP_1DESTINATARIO,
    SIEDESTINATARIO,
    SSUFRAMADESTINATARIO,
    SFONES_CLI,
    SEMAILCLIENTE,
    SCODPAIS,
    LCODBAIRRO1;

  if (SCODPAIS is not null) then
  begin
    select
      T.DESCRICAO
    from
      TBL_PAIS T
    where
      T.CODPAIS = :SCODPAIS
    into
      SPAIS;
  end

  SPAIS       = coalesce(SPAIS, 'BRASIL');
  SCODPAIS    = coalesce(SCODPAIS, '1058');
  SOBSERVACAO = '';
  if (LUTILIZAROBSPORATIVIDADE <> 0) then
  begin
    for select distinct
      NI.CODOBS,
      NI.OBSERVACAO
    from
      NFVENDAITEM NI
    where
      NI.CODNFVENDA = :ECODNFVENDA and
      NI.SERIE      = :ESERIE
    into
      LCODOBS,
      LOBSERVACAOITEM
    do
    begin
      SOBSERVACAO = SOBSERVACAO || ' ' || LOBSERVACAOITEM;
    end
  end

  for select
    NI.CODNFVENDAITEM,
    NI.CODPRODFILHO,
    coalesce(case NI.CODPESQUISA_CAT
               when '' then
                 NI.CODPESQUISA
               else
                 NI.CODPESQUISA_CAT
             end, NI.CODPESQUISA),
    PF.CODPESQ1,
    PF.CODPESQ2,
    PF.DESCRICAO,
    PF.UNIDADE,
    coalesce(PF.TRIBUTADO,''),
    coalesce(PF.PRDF_CST_TRIBICMS,''),
    PF.PRDF_CST_TRIBICMS_FORA,
    coalesce(PF.PRDF_CST_ORIGEM_MERCADORIA, 0),
    UN.SIGLA,
    NI.CODCFOP,
    NI.CFOP_CFOP,
    coalesce(NI.QTDE, 0),
    coalesce(NI.PRECOVEND, 0),
    coalesce(NI.TOTALVLR, 0),
    coalesce(NI.DESCVLR, 0),
    coalesce(NI.ICMSBASE, 0),
    coalesce(NI.ICMSPERC, 0),
    coalesce(NI.ICMSVALOR, 0),
    case
     when coalesce(NI.IPIPERC, 0) > 0 then
       coalesce(NI.TOTALVLR, 0)
    else 
      0
    end,
    coalesce(NI.IPIPERC, 0),
    coalesce(NI.IPIVALOR, 0),
    coalesce(NI.ALIQ_SUBS, 0),
    coalesce(NI.BASE_SUBS, 0),
    coalesce(NI.VALOR_SUBS, 0),
    coalesce(NI.ICMSISENTO, 0),
    coalesce(PF.CSTPIS,'08'),
    case
     when coalesce(PF.PERC_PIS, 0) > 0 then
       coalesce(NI.TOTALVLR, 0)
    else 
      0
    end,
    coalesce(PF.PERC_PIS, 0),
    case
     when coalesce(PF.PERC_PIS, 0) > 0 then
       (coalesce(NI.TOTALVLR, 0) * coalesce(PF.PERC_PIS, 0)) / 100
    else 
      0
    end,
    coalesce(PF.CSTCOFINS,'08'),
    case
     when coalesce(PF.PERC_COFINS, 0) > 0 then
       coalesce(NI.TOTALVLR, 0)
    else 
      0
    end,
    coalesce(PF.PERC_COFINS, 0),
    case
     when coalesce(PF.PERC_COFINS, 0) > 0 then
       (coalesce(NI.TOTALVLR, 0) * coalesce(PF.PERC_COFINS, 0)) / 100
    else 
     0
    end,
    coalesce(NI.PERC_VA, 0),
    COD_PROD_MARGEM,
    CODPEDVENDITEM,
    PF.CLASSFISCAL,
    PF.PMC,
    NI.PERC_REDUCAO,
    coalesce(NI.FRETE_VLR, 0),
    PF.CODANP,
    NI.OBSERVACAO,
    NI.BASEUFDEST,
    NI.PERCFCP,
    NI.ICMSDEST,
    NI.ICMSINTER,
    NI.PERCPARTILHA,
    NI.VALORFCP,
    NI.VALORICMSDEST,
    NI.VALORICMSINTER,
    NI.CST
  from
    NFVENDAITEM NI
    join PRODFILHO PF on
      NI.CODPRODFILHO = PF.CODPRODFILHO
    join UNIDADE UN on
      NI.CODUNIDADE = UN.CODUNIDADE
  where
    NI.CODNFVENDA = :ECODNFVENDA and
    NI.SERIE      = :ESERIE
  order by
    NI.CODNFVENDAITEM
  into
    SCODNFVENDAITEM,
    SCODPRODFILHO,
    SCODPESQUISA,
    SCODPESQ1,
    SCODPESQ2,
    SDESCRICAOPRODUTO,
    SUNIDADE,
    LTRIBUTADO,
    LTRIBUTADOICMS,
    LTRIBUTADOICMSFORA,
    SORIGEMMERCADORIA,
    SSIGLA,
    SCODCFOP,
    SCFOP_CFOP,
    SQTDE,
    SPRECOVEND,
    STOTALVLR,
    SDESCVLR,
    SBASEICMS_PRODUTO,
    SICMSPERC,
    SICMSVALOR,
    SIPIBASE,
    SIPIPERC,
    SIPIVALOR,
    SALIQ_SUBS,
    SBASE_SUBS,
    SVALOR_SUBS,
    SICMSISENTO,
    SCSTPIS,
    SPISBASE,
    SPERC_PIS,
    SPISVALOR,
    SCSTCOFINS,
    SCOFINSBASE,
    SPERC_COFINS,
    SCOFINSVALOR,
    SPERC_VA,
    STIPOSUBSTRIB,
    CODPEDVENDITEM,
    SCLASSFISCAL,
    SPMC,
    SPERC_REDUCAO,
    SFRETEITEM,
    LCODANP,
    LOBSERVACAOITEM,
    SBASEUFDEST,
    SPERCFCP,
    SICMSDEST,
    SICMSINTER,
    SPERCPARTILHA,
    SVALORFCP,
    SVALORICMSDEST,
    SVALORICMSINTER,
    LCST
  do
  begin
    if (STOTALPRODUTOS > 0) then
       LFATORITEM = STOTALVLR / (STOTALPRODUTOS - SDESCONTONOTA);

    SOUTRASDESPESASITEM = SOUTRASDESPESA * LFATORITEM;
    STOTALTRIBUTOSITEM = STOTALTRIBUTOS * LFATORITEM;
    SCODPEDVENDITEM = CODPEDVENDITEM;

    select
      coalesce(PN.CODPEDVENDITEM_NFVENDA, 0),
      PN.QTDE,
      PN.PRECOVEND / PN.QTDE,
      UN.SIGLA
    from
      PEDVENDITEM_NFVENDA PN
      left join UNIDADE UN on
        UN.CODUNIDADE = PN.CODUNIDADE
    where
      PN.CODPEDVENDITEM = :CODPEDVENDITEM
    into
      LCOD,
      LQTDE,
      LPRECO,
      LSIGLA;
      
    if (LCOD > 0) then
    begin
      SQTDE = LQTDE;
      SPRECOVEND = LPRECO;
      SUNIDADE = LSIGLA;
      SSIGLA   = LSIGLA;
    end

    LCOD   = null;
    LQTDE  = null;
    LPRECO = null;
    LSIGLA = null;

    if (LICMSCFOP = 'P') then
    begin
      if (SUFEMITENTE <> SUF_1DESTINATARIO) then
        STRIBUTADO = LTRIBUTADOICMSFORA;
      else
        STRIBUTADO = LTRIBUTADOICMS;
    end
    else
    begin
      if (STIPONOTA = 'S') then
      begin
        select
          coalesce(CF.CSTPIS, ''),
          coalesce(CF.PERC_PIS, 0),
          coalesce(CF.PERC_COFINS, 0),
          coalesce(CF.PRDF_CST_ORIGEM_MERCADORIA, 0),
          CF.PRDF_CST_TRIBICMS
        from
          CFOP CF
        where
          CF.CODCFOP = :SCODCFOP
        into
          SCSTPIS,
          SPERC_PIS,
          SPERC_COFINS,
          LORIGEM,
          LTRIBUTADOICMS;
      end
      else if (STIPONOTA = 'E') then
      begin
        select
          coalesce(CF.CSTPISENTRADA, ''),
          coalesce(CF.PERCPISCOMPRA, 0),
          coalesce(CF.PERCCONFINSCOMPRA, 0),
          coalesce(CF.PRDF_CST_ORIGEM_MERCADORIA, 0),
          CF.PRDF_CST_TRIBICMS
        from
          CFOP CF
        where
          CF.CODCFOP = :SCODCFOP
        into
          SCSTPIS,
          SPERC_PIS,
          SPERC_COFINS,
          LORIGEM,
          LTRIBUTADOICMS;
      end
--      STRIBUTADO        = LTRIBUTADOICMS;
--      SORIGEMMERCADORIA = LORIGEM;
    end

    if (coalesce(LCST,'') = '') then
    begin
      STRIBUTADO        = LTRIBUTADOICMS;
      SORIGEMMERCADORIA = LORIGEM;
    end
    else
    begin
      STRIBUTADO        = substring(LCST from 2 for 3);
      SORIGEMMERCADORIA = substring(LCST from 1 for 1);
    end

    SCSTCOFINS = SCSTPIS;

    select
      coalesce(CF.PRDF_VA, 0)
    from
      CFOP CF
    where
      CF.CODCFOP = :SCODCFOP
    into
      SVALORAGREGADO;

    if (exists(select
                 PN.CODPEDVENDITEM
               from
                 PEDVENDITEM_NFVENDA PN
               where
                 PN.CODPEDVENDITEM = :CODPEDVENDITEM)) then
    begin
      select
        PN.DESCRICAO,
        PN.CODPESQUISA,
        PN.QTDE,
        PN.PRECOVEND / PN.QTDE,
        UN.SIGLA
      from
        PEDVENDITEM_NFVENDA PN
        left join UNIDADE UN on
          UN.CODUNIDADE = PN.CODUNIDADE
      where
        PN.CODPEDVENDITEM = :CODPEDVENDITEM
      into
        SDESCRICAOPRODUTO,
        SCODPESQUISA,
        SQTDE,
        SPRECOVEND,
        SUNIDADE;
    end

    SLISTA = '';
    select
      PM.SINAL
    from
      PRODFILHO PF
      join PROD_MARGEM PM on
        PM.COD_PROD_MARGEM = PF.COD_PROD_MARGEM
    where
      PF.CODPRODFILHO = :SCODPRODFILHO
    into
      SLISTA;

    select
      coalesce(pi.QTDE_PECAS, 0)
    from
      PEDVENDITEM pi
    where
      pi.CODPEDVENDITEM = :SCODPEDVENDITEM
    into
      SQTD_PECAS;

    SQTD_PECAS = coalesce(SQTD_PECAS, 0);

    if ((SQTD_PECAS = 0) and (LPECAS_QUANT_QUANDO_ZERO = 'S')) then
      SQTD_PECAS = SQTDE;

    SOBSLOTE = 'LOTE: ';
    if (not exists(select
                     NL.CODNFVENDAITEM
                   from
                     NFVENDAITEMLOTE NL
                   where
                     NL.CODNFVENDAITEM = :SCODNFVENDAITEM)) then
    begin
      for select 
        PL.LOTE,
        PL.QTD,
        PL.DATAVAL
      from
        PEDVENDITEMLOTE PL
        join PEDVENDITEM pi on
          pi.CODPEDVENDITEM = PL.CODPEDVENDITEM
        join PRODFILHO PF on
          PF.CODPRODFILHO = pi.CODPRODFILHO
        where
          PL.CODPEDVENDITEM = :SCODPEDVENDITEM
        into
          LLOTE,
          LQTDLOTE,
          LDATAVALIDADE
      do 
      begin
        SOBSLOTE = SOBSLOTE || LLOTE || ' - ' || cast(LQTDLOTE as numeric(10,2)) || ' - ' || extract(day from :LDATAVALIDADE)||'/'||extract(month from :LDATAVALIDADE)||'/'||extract(year from :LDATAVALIDADE);
        SOBSLOTE = SOBSLOTE || '   ';
      end
    end
    else
    begin
      for select
        NL.LOTE,
        NL.QTD,
        NL.DATAVAL
      from
        NFVENDAITEMLOTE NL
        join NFVENDAITEM NI on
          NL.CODNFVENDAITEM = NI.CODNFVENDAITEM
        join PRODFILHO PF on
          PF.CODPRODFILHO = NI.CODPRODFILHO
      where
        NI.CODNFVENDAITEM = :SCODNFVENDAITEM
      into
        LLOTE,
        LQTDLOTE,
        LDATAVALIDADE
      do 
      begin
        SOBSLOTE = SOBSLOTE || LLOTE || ' - ' || cast(LQTDLOTE as numeric(10,2)) || ' - ' || extract(day from :LDATAVALIDADE)||'/'||extract(month from :LDATAVALIDADE)||'/'||extract(year from :LDATAVALIDADE);
        SOBSLOTE = SOBSLOTE || '   ';
      end
    end

    LCFOPCABECARIO = 'N';
    if (LCFOPCABECARIO = 'S') then
    begin
      select first 1
        NI.NATUREZA
      from
        NFVENDAITEM NI
      where
        NI.CODNFVENDA = :ECODNFVENDA and
        NI.SERIE      = :ESERIE
      into
        SNATUREZA;
    end

    select first 1
      coalesce(NFPARAMS.BASEICMS_CORPO, 'N')
    from
      NFPARAMS
    into
      LBASEICMS_CORPO;

    if (LBASEICMS_CORPO = 'S') then
    begin
      if (SBASEICMSSUBS_NOTA > 0) then
      begin
        select
          STOTALNORMAL,
          SICMS
        from
          STP_VALORESNOTASUBS(:ECODNFVENDA, :ESERIE)
        into
          SICMSBASE,
          SICMSTOTAL;
      end
    end

    select
      ML.VALOR
    from
      MLERPARAMETROLOGICO('IMPRIMIR O PESO DO PEDIDO', 0) ML
    into
      LUTILIZARPESOPEDIDO;

    if ((LUTILIZARPESOPEDIDO <> 0) and (LCODPEDVEND > 0)) then
    begin
      select
        sum(pi.QTDE * PF.PESOLIQUIDO),
        sum(pi.QTDE * PF.PESOBRUTO)
      from
        PRODFILHO PF
        join PEDVENDITEM pi on
          PF.CODPRODFILHO = pi.CODPRODFILHO
      where
        pi.CODPEDVEND = :LCODPEDVEND
      into
        SPESOLIQUI,
        SPESOBRUTO;
    end

    select first 1
      EI.CODEMBARQUE_FK
    from
      EMBARQUEITEM EI
    where
      EI.CODPEDVEND_FK = :LCODPEDVEND
    into
      SEMBARQUE;

    if(coalesce(LSSYS_OPTANTESIMPLES,'N') = 'S') then
    begin
      if (STRIBUTADO <> '900') then
      begin
        SICMSBASE  = 0;
        SICMSTOTAL = 0;
      end
    end

    if (SCSTPIS in ('06','07','08','09')) then
    begin
      SPISBASE     = 0;
      SPISVALOR    = 0;
      SPERC_PIS    = 0;
      SCOFINSBASE  = 0;
      SCOFINSVALOR = 0;
      SPERC_COFINS = 0;
    end

    select
      ML.VALOR
    from
      MLERPARAMETROLOGICO('IMPRIMIR PRIORITARIAMENTE A UND SECUNDRIA', 0) ML
    into
      LVALOR_UND;
    
    if (LVALOR_UND = 1) then
      SSIGLA = coalesce(SUNIDADE,SSIGLA);

    SANP = '';

    if (coalesce(LCODANP, 0) > 0) then
    begin
      select
        TA.REFERENCIA
      from
        TBL_ANP TA
      where
        TA.COD_TBL_ANP = :LCODANP
      into
        SANP;
    end

    SQTDETRANSPORTADO = cast(SQTDETRANSPORTADO as integer);

    select
      PV.PDV_NUMEROPEDCLI
    from
      PEDVEND PV
    where
      PV.CODPEDVEND = :LCODPEDVEND
    into
      SPEDIDOCOMPRA;

    if (coalesce(SPEDIDOCOMPRA,'') = '') then
      SPEDIDOCOMPRA = 0;

    if (SPEDIDOCOMPRA <> '') then
      SSEQITEM = coalesce(SSEQITEM, 0) + 1;

    select
      GR.DESCRICAO
    from
      PRODFILHO PF
      join PRODUTO PD on
        PD.CODPRODUTO = PF.CODPRODUTO
      join GRUPO GR on
        GR.CODGRUPO = PD.CODGRUPO
    where
      PF.CODPRODFILHO = :SCODPRODFILHO
    into
      SGRUPO;

    select first 1
      C.DT_VENCIM
    from
      CONTA C
    where
      C.CODNFVENDA = :ECODNFVENDA and
      C.SERIENF    = :ESERIE
    into
      SDT_VENCIM;

    select tbl_cidades.codibge from tbl_bairro
    inner join tbl_cidades on tbl_cidades.codcidade = tbl_bairro.codcidade
    inner join tbl_estado on tbl_cidades.codestado = tbl_estado.codestado
    where tbl_bairro.codbairro = :lcodbairro1
    into :lcodibgecidade;

    if (CHAR_LENGTH(lcodibgecidade) = 7) then
    begin
       scodibgedestinatario = lcodibgecidade;
    end

    select coalesce(empresa.coduf, (select sysparams.coduf from sysparams))
    from SERIE
      join EMPRESA on SERIE.CODEMPRESA = EMPRESA.CODEMPRESA
    where
      SERIE.SERIE = :ESERIE
    into :SCODUFEMITENTE;

    if (SCSTPIS = '') then
      SCSTPIS = '01';

    if (SCSTCOFINS = '') then
      SCSTCOFINS = '01';

    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE NOTAFISCALELETRONICA2(
    ECODNFVENDA INTEGER,
    ESERIE VARCHAR(3))
RETURNS (
    SCODUFEMITENTE INTEGER,
    SCODIBGEEMITENTE INTEGER,
    SCNPJEMITENTE VARCHAR(18),
    SIEEMITENTE VARCHAR(30),
    SIMEMITENTE VARCHAR(30),
    SRAZAOSOCIALEMITENTE VARCHAR(60),
    SEMPRESAEMITENTE VARCHAR(60),
    SLOGRADOUROEMITENTE VARCHAR(60),
    SNUMEROEMITENTE VARCHAR(30),
    SBAIRROEMITENTE VARCHAR(45),
    SCIDADEEMITENTE VARCHAR(60),
    SUFEMITENTE VARCHAR(2),
    SCEPEMITENTE VARCHAR(9),
    SFONESEMITENTE VARCHAR(42),
    SCNAEFISCALEMITENTE INTEGER,
    SCODRANDOMICO VARCHAR(9),
    SNFREFERENCIADA VARCHAR(44),
    SNATUREZA VARCHAR(50),
    SCODTIPOPAG INTEGER,
    SSERIE VARCHAR(3),
    SCODNFVENDA INTEGER,
    SDT_EMISSAO TIMESTAMP,
    STIPONOTA CHAR(1),
    SCODPESSOA INTEGER,
    SFRETE DOUBLE PRECISION,
    SSUGURO DOUBLE PRECISION,
    SICMSBASE DOUBLE PRECISION,
    SICMSISENTOTOTAL DOUBLE PRECISION,
    SICMSSUBSTPERC DOUBLE PRECISION,
    SICMSSUBSTVALOR DOUBLE PRECISION,
    SICMSTOTAL DOUBLE PRECISION,
    SICMS_FRETE DOUBLE PRECISION,
    SNRSELO VARCHAR(11),
    STOTALPRODUTOS DOUBLE PRECISION,
    SOUTRASDESPESA DOUBLE PRECISION,
    STOTALNOTA DOUBLE PRECISION,
    SDESCONTONOTA DOUBLE PRECISION,
    SVALORIPI DOUBLE PRECISION,
    STIPOFRETE CHAR(1),
    SCODTRANSPORT INTEGER,
    STIPODOCTRANST INTEGER,
    SCGCTRANSPORT VARCHAR(18),
    SNOMETRANSPORT VARCHAR(60),
    SIETRANSPORT VARCHAR(30),
    SLOGRADOUROTRANSPORT VARCHAR(60),
    SCIDADETRANSPORT VARCHAR(45),
    SUFTRANSPORT VARCHAR(2),
    SPLACATRANSPORT VARCHAR(8),
    STIPODESTINATARIO SMALLINT,
    SCPFCGCDESTINATARIO VARCHAR(18),
    SNOMEDESTINATARIO VARCHAR(60),
    SLOGRADOURO_1DESTINATARIO VARCHAR(60),
    SNUMERO_1DESTINATARIO VARCHAR(30),
    SBAIRRO_1DESTINATARIO VARCHAR(45),
    SCODIBGEDESTINATARIO VARCHAR(7),
    SCIDADE_1DESTINATARIO VARCHAR(45),
    SUF_1DESTINATARIO CHAR(2),
    SCEP_1DESTINATARIO VARCHAR(9),
    SIEDESTINATARIO VARCHAR(30),
    SSUFRAMADESTINATARIO INTEGER,
    SCODNFVENDAITEM INTEGER,
    SCODPRODFILHO INTEGER,
    SCODPESQUISA VARCHAR(30),
    SCODPESQ1 VARCHAR(30),
    SCODPESQ2 VARCHAR(30),
    SDESCRICAOPRODUTO VARCHAR(120),
    SUNIDADE VARCHAR(15),
    STRIBUTADO VARCHAR(4),
    SORIGEMMERCADORIA SMALLINT,
    SSIGLA VARCHAR(5),
    SCODCFOP INTEGER,
    SCFOP_CFOP VARCHAR(4),
    SQTDE DOUBLE PRECISION,
    SPRECOVEND DOUBLE PRECISION,
    STOTALVLR DOUBLE PRECISION,
    SDESCVLR DOUBLE PRECISION,
    SICMSPERC DOUBLE PRECISION,
    SICMSVALOR DOUBLE PRECISION,
    SIPIBASE DOUBLE PRECISION,
    SIPIPERC DOUBLE PRECISION,
    SIPIVALOR DOUBLE PRECISION,
    SALIQ_SUBS DOUBLE PRECISION,
    SBASE_SUBS DOUBLE PRECISION,
    SVALOR_SUBS DOUBLE PRECISION,
    SICMSISENTO DOUBLE PRECISION,
    SCSTPIS CHAR(2),
    SPISBASE DOUBLE PRECISION,
    SPERC_PIS DOUBLE PRECISION,
    SPISVALOR DOUBLE PRECISION,
    SCSTCOFINS CHAR(2),
    SCOFINSBASE DOUBLE PRECISION,
    SPERC_COFINS DOUBLE PRECISION,
    SCOFINSVALOR DOUBLE PRECISION,
    SQTDETRANSPORTADO DOUBLE PRECISION,
    SPESOBRUTO DOUBLE PRECISION,
    SPESOLIQUI DOUBLE PRECISION,
    SQTDEVOLUME DOUBLE PRECISION,
    SMARCA VARCHAR(15),
    SESPECIE VARCHAR(15),
    SNFV_OBSNOTA3 VARCHAR(70),
    SNFV_OBSNOTA4 VARCHAR(70),
    SNFV_OBSNOTA5 VARCHAR(70),
    SNFV_OBSNOTA6 VARCHAR(70),
    SNFV_OBSNOTA7 VARCHAR(70),
    SNFV_OBSNOTA8 VARCHAR(70),
    SNFV_OBSNOTA9 VARCHAR(70),
    SOBSCORPONOTA1 VARCHAR(255),
    SOBSCORPONOTA2 VARCHAR(255),
    SOBSCORPONOTA3 VARCHAR(255),
    SCHAVE VARCHAR(44),
    SSTATUSCHAVE VARCHAR(1),
    STIPOSUBSTRIB INTEGER,
    SVALORAGREGADO DOUBLE PRECISION,
    SCODPEDVENDITEM INTEGER,
    SLISTA CHAR(1),
    SCLASSFISCAL VARCHAR(20),
    SPMC DOUBLE PRECISION,
    SOBSLOTE VARCHAR(1000),
    SPERC_REDUCAO DOUBLE PRECISION,
    SBASEICMS_PRODUTO DOUBLE PRECISION,
    SBASEICMSSUBS_NOTA DOUBLE PRECISION,
    SPERC_VA DOUBLE PRECISION,
    SFONES_CLI VARCHAR(120),
    SFRETEIMP VARCHAR(1),
    LCFOPCABECARIO VARCHAR(1),
    SPROTOCOLO VARCHAR(15),
    SDT_CONFIRMACAO TIMESTAMP,
    SQTD_PECAS DOUBLE PRECISION,
    SEMBARQUE INTEGER,
    SDT_SAIDA TIMESTAMP,
    SEMAILCLIENTE VARCHAR(60),
    SFRETEITEM DOUBLE PRECISION,
    SOUTRASDESPESASITEM DOUBLE PRECISION,
    SANP VARCHAR(9),
    STOTALTRIBUTOS DOUBLE PRECISION,
    SPEDIDOCOMPRA VARCHAR(10),
    SSEQITEM INTEGER,
    SGRUPO VARCHAR(60),
    SOBSERVACAO BLOB SUB_TYPE TEXT SEGMENT SIZE 4096,
    SPAIS VARCHAR(35),
    SCODPAIS VARCHAR(4),
    SDT_VENCIM TIMESTAMP,
    STOTALTRIBUTOSITEM DOUBLE PRECISION,
    SBASEUFDEST DOUBLE PRECISION,
    SPERCFCP DOUBLE PRECISION,
    SICMSDEST DOUBLE PRECISION,
    SICMSINTER DOUBLE PRECISION,
    SPERCPARTILHA DOUBLE PRECISION,
    SVALORFCP DOUBLE PRECISION,
    SVALORICMSDEST DOUBLE PRECISION,
    SVALORICMSINTER DOUBLE PRECISION,
    SPERCICMSCREDITO DOUBLE PRECISION)
AS
declare variable LTRIBUTADO char(1);
declare variable LTRIBUTADOICMS char(3);
declare variable LTRIBUTADOICMSFORA char(3);
declare variable CODPEDVENDITEM integer;
declare variable LCOD integer;
declare variable LQTDE double precision;
declare variable LPRECO double precision;
declare variable LSIGLA varchar(5);
declare variable LLOTE varchar(12);
declare variable LQTDLOTE double precision;
declare variable LDATAVALIDADE timestamp;
declare variable LBASEICMS_CORPO char(10);
declare variable LUTILIZARPESOPEDIDO integer;
declare variable LCODPEDVEND integer;
declare variable LNAO_IMPORTA_DESC_PED char(1);
declare variable LICMSCFOP char(1);
declare variable LPECAS_QUANT_QUANDO_ZERO varchar(1);
declare variable LCODEMPRESA integer;
declare variable LSSYS_OPTANTESIMPLES char(1);
declare variable LFATORITEM double precision;
declare variable LVALOR_UND smallint;
declare variable LCODANP integer;
declare variable LORIGEM integer;
declare variable LOBSERVACAOITEM varchar(200);
declare variable LUTILIZAROBSPORATIVIDADE char(1);
declare variable LCODOBS integer;
declare variable LCODIBGECIDADE varchar(7);
declare variable LCODBAIRRO1 integer;
declare variable LCST varchar(4);
begin
  select 
    coalesce(SE.CODEMPRESA, 0)
  from
    SERIE SE
  where 
    SE.SERIE = :ESERIE
  into
    LCODEMPRESA;

  select
    coalesce(NP.NAOIMPORT_DESC_PED, 'N'),
    coalesce(NP.IMPRIMIRCFOP_CABECARIO, 'N'),
    coalesce(NP.PECAS_QUANT_QUANDO_ZERO, 'N')
  from
    NFPARAMS NP
  where 
    ((NP.CODEMPRESA = :LCODEMPRESA) or (:LCODEMPRESA = 0))
  into
    LNAO_IMPORTA_DESC_PED,
    LCFOPCABECARIO,
    LPECAS_QUANT_QUANDO_ZERO;

  SBASEICMSSUBS_NOTA = 0;

  select
    sum(coalesce((select first 1 IB.ALIQ_NAC from IBPT IB where IB.NCM = PF.CLASSFISCAL), 0) / 100 * NI.TOTALVLR)
  from
    NFVENDAITEM NI
    join PRODFILHO PF on PF.CODPRODFILHO = NI.CODPRODFILHO
  where
    NI.CODNFVENDA = :ECODNFVENDA and
    NI.SERIE      = :ESERIE
  into
    STOTALTRIBUTOS;

  select
    SP.CODUF,
    SP.CODIBGE,
    SP.CGC,
    SP.IE,
    SP.IM,
    SP.RAZAOSOCIAL,
    SP.EMPRESA,
    SP.LOGRADOURO,
    SP.NUMERO,
    SP.BAIRRO,
    SP.CIDADE,
    SP.UF,
    SP.CEP,
    SP.FONES,
    SP.CNAEFISCAL,
    SP.ICMSCFOP,
    SP.SYS_OPTANTESIMPLES
  from
    SYSPARAMS SP
  into
    SCODUFEMITENTE,
    SCODIBGEEMITENTE,
    SCNPJEMITENTE,
    SIEEMITENTE,
    SIMEMITENTE,
    SRAZAOSOCIALEMITENTE,
    SEMPRESAEMITENTE,
    SLOGRADOUROEMITENTE,
    SNUMEROEMITENTE,
    SBAIRROEMITENTE,
    SCIDADEEMITENTE,
    SUFEMITENTE,
    SCEPEMITENTE,
    SFONESEMITENTE,
    SCNAEFISCALEMITENTE,
    LICMSCFOP,
    LSSYS_OPTANTESIMPLES;

  select
    ML.VALOR
  from
    MLERPARAMETROLOGICO('UTILIZAR OBS POR TIPO DE ATIVIDADE', 0) ML
  into
    LUTILIZAROBSPORATIVIDADE;

  select
    NV.CODRANDOMICO,
    NV.NFREFERENCIADA,
    NV.NATUREZA,
    NV.CODTIPOPAG,
    NV.SERIE,
    NV.CODNFVENDA,
    NV.DT_EMISSAO,
    coalesce(NV.NFV_DTIMPRESSAO, current_timestamp),
    NV.TIPONOTA,
    NV.CODPESSOA,
    coalesce(NV.FRETEVLR, 0),
    coalesce(NV.SEGUROVLR, 0),
    coalesce(NV.ICMSBASE, 0),
    coalesce(NV.ICMSISENTOTOTAL, 0),
    coalesce(NV.ICMSSUBSTPERC, 0),
    coalesce(NV.ICMSSUBSTVALOR, 0),
    coalesce(NV.ICMSTOTAL, 0),
    coalesce(NV.ICMS_FRETE, 0),
    NV.NRSELO,
    coalesce(NV.TOTALPRODUTOS, 0),
    coalesce(NV.OUTRASDESPESA, 0),
    coalesce(NV.TOTALNOTA, 0),
    coalesce(NV.VLRDESCONT, 0),
    coalesce(NV.VALORIPI, 0),
    coalesce(NV.TIPOFRETE,'1'),
    coalesce(NV.CODTRANSPORT, 0),
    coalesce(NV.QTDETRANSPORTADO, 0),
    coalesce(NV.PESOBRUTO, 0),
    coalesce(NV.PESOLIQUI, 0),
    coalesce(NV.QTDEVOLUME, 0),
    NV.MARCA,
    NV.ESPECIE,
    NV.NFV_OBSNOTA3,
    NV.NFV_OBSNOTA4,
    NV.NFV_OBSNOTA5,
    NV.NFV_OBSNOTA6,
    NV.NFV_OBSNOTA7,
    NV.NFV_OBSNOTA8,
    NV.NFV_OBSNOTA9,
    NV.OBSCORPONOTA1,
    NV.OBSCORPONOTA2,
    NV.OBSCORPONOTA3,
    NV.CHAVE,
    NV.STATUSCHAVE,
    coalesce(NV.ICMSSUBSBASE, 0),
    NV.PLACA_TRANSP,
    coalesce(NV.CODPEDVEND, 0),
    NV.PROTOCOLO,
    NV.DT_CONFIRMACAONFE,
    coalesce(NV.ICMSCREDITO,0)
  from
    NFVENDA NV
  where
    NV.CODNFVENDA = :ECODNFVENDA and
    NV.SERIE      = :ESERIE
  into
    SCODRANDOMICO,
    SNFREFERENCIADA,
    SNATUREZA,
    SCODTIPOPAG,
    SSERIE,
    SCODNFVENDA,
    SDT_EMISSAO,
    SDT_SAIDA,
    STIPONOTA,
    SCODPESSOA,
    SFRETE,
    SSUGURO,
    SICMSBASE,
    SICMSISENTOTOTAL,
    SICMSSUBSTPERC,
    SICMSSUBSTVALOR,
    SICMSTOTAL,
    SICMS_FRETE,
    SNRSELO,
    STOTALPRODUTOS,
    SOUTRASDESPESA,
    STOTALNOTA,
    SDESCONTONOTA,
    SVALORIPI,
    STIPOFRETE,
    SCODTRANSPORT,
    SQTDETRANSPORTADO,
    SPESOBRUTO,
    SPESOLIQUI,
    SQTDEVOLUME,
    SMARCA,
    SESPECIE,
    SNFV_OBSNOTA3,
    SNFV_OBSNOTA4,
    SNFV_OBSNOTA5,
    SNFV_OBSNOTA6,
    SNFV_OBSNOTA7,
    SNFV_OBSNOTA8,
    SNFV_OBSNOTA9,
    SOBSCORPONOTA1,
    SOBSCORPONOTA2,
    SOBSCORPONOTA3,
    SCHAVE,
    SSTATUSCHAVE,
    SBASEICMSSUBS_NOTA,
    SPLACATRANSPORT,
    LCODPEDVEND,
    SPROTOCOLO,
    SDT_CONFIRMACAO,
    SPERCICMSCREDITO;

  SFRETEIMP = STIPOFRETE;
  
  if (STIPOFRETE = 1) then
    STIPOFRETE = 0;
  else if (STIPOFRETE = 2) then
    STIPOFRETE = 1;

  if (coalesce(SCODTRANSPORT, 0) = 0) then
    STIPOFRETE = 9;

  SICMSBASE      = cast(coalesce(SICMSBASE, 0) as numeric(18,2));
  SICMSTOTAL     = cast(coalesce(SICMSTOTAL, 0) as numeric(18,2));
  SFRETE         = cast(coalesce(SFRETE, 0) as numeric(18,2));
  SSUGURO        = cast(coalesce(SSUGURO, 0) as numeric(18,2));
  STOTALPRODUTOS = cast(coalesce(STOTALPRODUTOS, 0) as numeric(18,2));
  SOUTRASDESPESA = cast(coalesce(SOUTRASDESPESA, 0) as numeric(18,2));
  SVALORIPI      = cast(coalesce(SVALORIPI, 0) as numeric(18,2));
  STOTALNOTA     = cast(STOTALNOTA as numeric(18,2));

  select
    coalesce(TR.PESSOA,1),
    TR.CGC,
    TR.NOME,
    TR.IE,
    TR.LOGRADOURO,
    TR.CIDADE,
    TR.UF
  from
    TRANSPORT TR
  where
    TR.CODTRANSPORT = :SCODTRANSPORT
  into
    STIPODOCTRANST,
    SCGCTRANSPORT,
    SNOMETRANSPORT,
    SIETRANSPORT,
    SLOGRADOUROTRANSPORT,
    SCIDADETRANSPORT,
    SUFTRANSPORT;

  select
    PE.PESSOA,
    PE.CPFCGC,
    PE.NOME,
    PE.LOGRADOURO_1,
    PE.NUMERO_1,
    PE.BAIRRO_1,
    PE.CODIBGE,
    PE.CIDADE_1,
    PE.UF_1,
    PE.CEP_1,
    PE.IE,
    PE.PES_CODIGOSUFRAMA,
    PE.FONES,
    coalesce(PE.EMAIL_NFE, PE.EMAIL),
    coalesce(nullif(PE.CODPAIS, ''), '1058'),
    PE.CODBAIRRO1
  from
    PESSOA PE
  where
    PE.CODPESSOA = :SCODPESSOA
  into
    STIPODESTINATARIO,
    SCPFCGCDESTINATARIO,
    SNOMEDESTINATARIO,
    SLOGRADOURO_1DESTINATARIO,
    SNUMERO_1DESTINATARIO,
    SBAIRRO_1DESTINATARIO,
    SCODIBGEDESTINATARIO,
    SCIDADE_1DESTINATARIO,
    SUF_1DESTINATARIO,
    SCEP_1DESTINATARIO,
    SIEDESTINATARIO,
    SSUFRAMADESTINATARIO,
    SFONES_CLI,
    SEMAILCLIENTE,
    SCODPAIS,
    LCODBAIRRO1;

  if (SCODPAIS is not null) then
  begin
    select
      T.DESCRICAO
    from
      TBL_PAIS T
    where
      T.CODPAIS = :SCODPAIS
    into
      SPAIS;
  end

  SPAIS       = coalesce(SPAIS, 'BRASIL');
  SCODPAIS    = coalesce(SCODPAIS, '1058');
  SOBSERVACAO = '';
  if (LUTILIZAROBSPORATIVIDADE <> 0) then
  begin
    for select distinct
      NI.CODOBS,
      NI.OBSERVACAO
    from
      NFVENDAITEM NI
    where
      NI.CODNFVENDA = :ECODNFVENDA and
      NI.SERIE      = :ESERIE
    into
      LCODOBS,
      LOBSERVACAOITEM
    do
    begin
      SOBSERVACAO = SOBSERVACAO || ' ' || LOBSERVACAOITEM;
    end
  end

  for select
    NI.CODNFVENDAITEM,
    NI.CODPRODFILHO,
    coalesce(case NI.CODPESQUISA_CAT
               when '' then
                 NI.CODPESQUISA
               else
                 NI.CODPESQUISA_CAT
             end, NI.CODPESQUISA),
    PF.CODPESQ1,
    PF.CODPESQ2,
    PF.DESCRICAO,
    PF.UNIDADE,
    coalesce(PF.TRIBUTADO,''),
    coalesce(PF.PRDF_CST_TRIBICMS,''),
    PF.PRDF_CST_TRIBICMS_FORA,
    coalesce(PF.PRDF_CST_ORIGEM_MERCADORIA, 0),
    UN.SIGLA,
    NI.CODCFOP,
    NI.CFOP_CFOP,
    coalesce(NI.QTDE, 0),
    coalesce(NI.PRECOVEND, 0),
    coalesce(NI.TOTALVLR, 0),
    coalesce(NI.DESCVLR, 0),
    coalesce(NI.ICMSBASE, 0),
    coalesce(NI.ICMSPERC, 0),
    coalesce(NI.ICMSVALOR, 0),
    case
     when coalesce(NI.IPIPERC, 0) > 0 then
       coalesce(NI.TOTALVLR, 0)
    else 
      0
    end,
    coalesce(NI.IPIPERC, 0),
    coalesce(NI.IPIVALOR, 0),
    coalesce(NI.ALIQ_SUBS, 0),
    coalesce(NI.BASE_SUBS, 0),
    coalesce(NI.VALOR_SUBS, 0),
    coalesce(NI.ICMSISENTO, 0),
    coalesce(PF.CSTPIS,'08'),
    case
     when coalesce(PF.PERC_PIS, 0) > 0 then
       coalesce(NI.TOTALVLR, 0)
    else 
      0
    end,
    coalesce(PF.PERC_PIS, 0),
    case
     when coalesce(PF.PERC_PIS, 0) > 0 then
       (coalesce(NI.TOTALVLR, 0) * coalesce(PF.PERC_PIS, 0)) / 100
    else 
      0
    end,
    coalesce(PF.CSTCOFINS,'08'),
    case
     when coalesce(PF.PERC_COFINS, 0) > 0 then
       coalesce(NI.TOTALVLR, 0)
    else 
      0
    end,
    coalesce(PF.PERC_COFINS, 0),
    case
     when coalesce(PF.PERC_COFINS, 0) > 0 then
       (coalesce(NI.TOTALVLR, 0) * coalesce(PF.PERC_COFINS, 0)) / 100
    else 
     0
    end,
    coalesce(NI.PERC_VA, 0),
    COD_PROD_MARGEM,
    CODPEDVENDITEM,
    PF.CLASSFISCAL,
    PF.PMC,
    NI.PERC_REDUCAO,
    coalesce(NI.FRETE_VLR, 0),
    PF.CODANP,
    NI.OBSERVACAO,
    NI.BASEUFDEST,
    NI.PERCFCP,
    NI.ICMSDEST,
    NI.ICMSINTER,
    NI.PERCPARTILHA,
    NI.VALORFCP,
    NI.VALORICMSDEST,
    NI.VALORICMSINTER,
    NI.CST
  from
    NFVENDAITEM NI
    join PRODFILHO PF on
      NI.CODPRODFILHO = PF.CODPRODFILHO
    join UNIDADE UN on
      NI.CODUNIDADE = UN.CODUNIDADE
  where
    NI.CODNFVENDA = :ECODNFVENDA and
    NI.SERIE      = :ESERIE
  order by
    NI.CODNFVENDAITEM
  into
    SCODNFVENDAITEM,
    SCODPRODFILHO,
    SCODPESQUISA,
    SCODPESQ1,
    SCODPESQ2,
    SDESCRICAOPRODUTO,
    SUNIDADE,
    LTRIBUTADO,
    LTRIBUTADOICMS,
    LTRIBUTADOICMSFORA,
    SORIGEMMERCADORIA,
    SSIGLA,
    SCODCFOP,
    SCFOP_CFOP,
    SQTDE,
    SPRECOVEND,
    STOTALVLR,
    SDESCVLR,
    SBASEICMS_PRODUTO,
    SICMSPERC,
    SICMSVALOR,
    SIPIBASE,
    SIPIPERC,
    SIPIVALOR,
    SALIQ_SUBS,
    SBASE_SUBS,
    SVALOR_SUBS,
    SICMSISENTO,
    SCSTPIS,
    SPISBASE,
    SPERC_PIS,
    SPISVALOR,
    SCSTCOFINS,
    SCOFINSBASE,
    SPERC_COFINS,
    SCOFINSVALOR,
    SPERC_VA,
    STIPOSUBSTRIB,
    CODPEDVENDITEM,
    SCLASSFISCAL,
    SPMC,
    SPERC_REDUCAO,
    SFRETEITEM,
    LCODANP,
    LOBSERVACAOITEM,
    SBASEUFDEST,
    SPERCFCP,
    SICMSDEST,
    SICMSINTER,
    SPERCPARTILHA,
    SVALORFCP,
    SVALORICMSDEST,
    SVALORICMSINTER,
    LCST
  do
  begin
    if (STOTALPRODUTOS > 0) then
       LFATORITEM = STOTALVLR / (STOTALPRODUTOS - SDESCONTONOTA);

    SOUTRASDESPESASITEM = SOUTRASDESPESA * LFATORITEM;
    STOTALTRIBUTOSITEM = STOTALTRIBUTOS * LFATORITEM;
    SCODPEDVENDITEM = CODPEDVENDITEM;

    select
      coalesce(PN.CODPEDVENDITEM_NFVENDA, 0),
      PN.QTDE,
      PN.PRECOVEND / PN.QTDE,
      UN.SIGLA
    from
      PEDVENDITEM_NFVENDA PN
      left join UNIDADE UN on
        UN.CODUNIDADE = PN.CODUNIDADE
    where
      PN.CODPEDVENDITEM = :CODPEDVENDITEM
    into
      LCOD,
      LQTDE,
      LPRECO,
      LSIGLA;
      
    if (LCOD > 0) then
    begin
      SQTDE = LQTDE;
      SPRECOVEND = LPRECO;
      SUNIDADE = LSIGLA;
      SSIGLA   = LSIGLA;
    end

    LCOD   = null;
    LQTDE  = null;
    LPRECO = null;
    LSIGLA = null;

    if (LICMSCFOP = 'P') then
    begin
      if (SUFEMITENTE <> SUF_1DESTINATARIO) then
        STRIBUTADO = LTRIBUTADOICMSFORA;
      else
        STRIBUTADO = LTRIBUTADOICMS;
    end
    else
    begin
      if (STIPONOTA = 'S') then
      begin
        select
          coalesce(CF.CSTPIS, ''),
          coalesce(CF.PERC_PIS, 0),
          coalesce(CF.PERC_COFINS, 0),
          coalesce(CF.PRDF_CST_ORIGEM_MERCADORIA, 0),
          CF.PRDF_CST_TRIBICMS
        from
          CFOP CF
        where
          CF.CODCFOP = :SCODCFOP
        into
          SCSTPIS,
          SPERC_PIS,
          SPERC_COFINS,
          LORIGEM,
          LTRIBUTADOICMS;
      end
      else if (STIPONOTA = 'E') then
      begin
        select
          coalesce(CF.CSTPISENTRADA, ''),
          coalesce(CF.PERCPISCOMPRA, 0),
          coalesce(CF.PERCCONFINSCOMPRA, 0),
          coalesce(CF.PRDF_CST_ORIGEM_MERCADORIA, 0),
          CF.PRDF_CST_TRIBICMS
        from
          CFOP CF
        where
          CF.CODCFOP = :SCODCFOP
        into
          SCSTPIS,
          SPERC_PIS,
          SPERC_COFINS,
          LORIGEM,
          LTRIBUTADOICMS;
      end
--      STRIBUTADO        = LTRIBUTADOICMS;
--      SORIGEMMERCADORIA = LORIGEM;
    end

    if (coalesce(LCST,'') = '') then
    begin
      STRIBUTADO        = LTRIBUTADOICMS;
      SORIGEMMERCADORIA = LORIGEM;
    end
    else
    begin
      STRIBUTADO        = substring(LCST from 2 for 3);
      SORIGEMMERCADORIA = substring(LCST from 1 for 1);
    end

    SCSTCOFINS = SCSTPIS;

    select
      coalesce(CF.PRDF_VA, 0)
    from
      CFOP CF
    where
      CF.CODCFOP = :SCODCFOP
    into
      SVALORAGREGADO;

    if (exists(select
                 PN.CODPEDVENDITEM
               from
                 PEDVENDITEM_NFVENDA PN
               where
                 PN.CODPEDVENDITEM = :CODPEDVENDITEM)) then
    begin
      select
        PN.DESCRICAO,
        PN.CODPESQUISA,
        PN.QTDE,
        PN.PRECOVEND / PN.QTDE,
        UN.SIGLA
      from
        PEDVENDITEM_NFVENDA PN
        left join UNIDADE UN on
          UN.CODUNIDADE = PN.CODUNIDADE
      where
        PN.CODPEDVENDITEM = :CODPEDVENDITEM
      into
        SDESCRICAOPRODUTO,
        SCODPESQUISA,
        SQTDE,
        SPRECOVEND,
        SUNIDADE;
    end

    SLISTA = '';
    select
      PM.SINAL
    from
      PRODFILHO PF
      join PROD_MARGEM PM on
        PM.COD_PROD_MARGEM = PF.COD_PROD_MARGEM
    where
      PF.CODPRODFILHO = :SCODPRODFILHO
    into
      SLISTA;

    select
      coalesce(pi.QTDE_PECAS, 0)
    from
      PEDVENDITEM pi
    where
      pi.CODPEDVENDITEM = :SCODPEDVENDITEM
    into
      SQTD_PECAS;

    SQTD_PECAS = coalesce(SQTD_PECAS, 0);

    if ((SQTD_PECAS = 0) and (LPECAS_QUANT_QUANDO_ZERO = 'S')) then
      SQTD_PECAS = SQTDE;

    SOBSLOTE = 'LOTE: ';
    if (not exists(select
                     NL.CODNFVENDAITEM
                   from
                     NFVENDAITEMLOTE NL
                   where
                     NL.CODNFVENDAITEM = :SCODNFVENDAITEM)) then
    begin
      for select 
        PL.LOTE,
        PL.QTD,
        PL.DATAVAL
      from
        PEDVENDITEMLOTE PL
        join PEDVENDITEM pi on
          pi.CODPEDVENDITEM = PL.CODPEDVENDITEM
        join PRODFILHO PF on
          PF.CODPRODFILHO = pi.CODPRODFILHO
        where
          PL.CODPEDVENDITEM = :SCODPEDVENDITEM
        into
          LLOTE,
          LQTDLOTE,
          LDATAVALIDADE
      do 
      begin
        SOBSLOTE = SOBSLOTE || LLOTE || ' - ' || cast(LQTDLOTE as numeric(10,2)) || ' - ' || extract(day from :LDATAVALIDADE)||'/'||extract(month from :LDATAVALIDADE)||'/'||extract(year from :LDATAVALIDADE);
        SOBSLOTE = SOBSLOTE || '   ';
      end
    end
    else
    begin
      for select
        NL.LOTE,
        NL.QTD,
        NL.DATAVAL
      from
        NFVENDAITEMLOTE NL
        join NFVENDAITEM NI on
          NL.CODNFVENDAITEM = NI.CODNFVENDAITEM
        join PRODFILHO PF on
          PF.CODPRODFILHO = NI.CODPRODFILHO
      where
        NI.CODNFVENDAITEM = :SCODNFVENDAITEM
      into
        LLOTE,
        LQTDLOTE,
        LDATAVALIDADE
      do 
      begin
        SOBSLOTE = SOBSLOTE || LLOTE || ' - ' || cast(LQTDLOTE as numeric(10,2)) || ' - ' || extract(day from :LDATAVALIDADE)||'/'||extract(month from :LDATAVALIDADE)||'/'||extract(year from :LDATAVALIDADE);
        SOBSLOTE = SOBSLOTE || '   ';
      end
    end

    LCFOPCABECARIO = 'N';
    if (LCFOPCABECARIO = 'S') then
    begin
      select first 1
        NI.NATUREZA
      from
        NFVENDAITEM NI
      where
        NI.CODNFVENDA = :ECODNFVENDA and
        NI.SERIE      = :ESERIE
      into
        SNATUREZA;
    end

    select first 1
      coalesce(NFPARAMS.BASEICMS_CORPO, 'N')
    from
      NFPARAMS
    into
      LBASEICMS_CORPO;

    if (LBASEICMS_CORPO = 'S') then
    begin
      if (SBASEICMSSUBS_NOTA > 0) then
      begin
        select
          STOTALNORMAL,
          SICMS
        from
          STP_VALORESNOTASUBS(:ECODNFVENDA, :ESERIE)
        into
          SICMSBASE,
          SICMSTOTAL;
      end
    end

    select
      ML.VALOR
    from
      MLERPARAMETROLOGICO('IMPRIMIR O PESO DO PEDIDO', 0) ML
    into
      LUTILIZARPESOPEDIDO;

    if ((LUTILIZARPESOPEDIDO <> 0) and (LCODPEDVEND > 0)) then
    begin
      select
        sum(pi.QTDE * PF.PESOLIQUIDO),
        sum(pi.QTDE * PF.PESOBRUTO)
      from
        PRODFILHO PF
        join PEDVENDITEM pi on
          PF.CODPRODFILHO = pi.CODPRODFILHO
      where
        pi.CODPEDVEND = :LCODPEDVEND
      into
        SPESOLIQUI,
        SPESOBRUTO;
    end

    select first 1
      EI.CODEMBARQUE_FK
    from
      EMBARQUEITEM EI
    where
      EI.CODPEDVEND_FK = :LCODPEDVEND
    into
      SEMBARQUE;

    if(coalesce(LSSYS_OPTANTESIMPLES,'N') = 'S') then
    begin
      if (STRIBUTADO <> '900') then
      begin
        SICMSBASE  = 0;
        SICMSTOTAL = 0;
      end
    end

    if (SCSTPIS in ('06','07','08','09')) then
    begin
      SPISBASE     = 0;
      SPISVALOR    = 0;
      SPERC_PIS    = 0;
      SCOFINSBASE  = 0;
      SCOFINSVALOR = 0;
      SPERC_COFINS = 0;
    end

    select
      ML.VALOR
    from
      MLERPARAMETROLOGICO('IMPRIMIR PRIORITARIAMENTE A UND SECUNDRIA', 0) ML
    into
      LVALOR_UND;
    
    if (LVALOR_UND = 1) then
      SSIGLA = coalesce(SUNIDADE,SSIGLA);

    SANP = '';

    if (coalesce(LCODANP, 0) > 0) then
    begin
      select
        TA.REFERENCIA
      from
        TBL_ANP TA
      where
        TA.COD_TBL_ANP = :LCODANP
      into
        SANP;
    end

    SQTDETRANSPORTADO = cast(SQTDETRANSPORTADO as integer);

    select
      PV.PDV_NUMEROPEDCLI
    from
      PEDVEND PV
    where
      PV.CODPEDVEND = :LCODPEDVEND
    into
      SPEDIDOCOMPRA;

    if (coalesce(SPEDIDOCOMPRA,'') = '') then
      SPEDIDOCOMPRA = 0;

    if (SPEDIDOCOMPRA <> '') then
      SSEQITEM = coalesce(SSEQITEM, 0) + 1;

    select
      GR.DESCRICAO
    from
      PRODFILHO PF
      join PRODUTO PD on
        PD.CODPRODUTO = PF.CODPRODUTO
      join GRUPO GR on
        GR.CODGRUPO = PD.CODGRUPO
    where
      PF.CODPRODFILHO = :SCODPRODFILHO
    into
      SGRUPO;

    select first 1
      C.DT_VENCIM
    from
      CONTA C
    where
      C.CODNFVENDA = :ECODNFVENDA and
      C.SERIENF    = :ESERIE
    into
      SDT_VENCIM;

    select tbl_cidades.codibge from tbl_bairro
    inner join tbl_cidades on tbl_cidades.codcidade = tbl_bairro.codcidade
    inner join tbl_estado on tbl_cidades.codestado = tbl_estado.codestado
    where tbl_bairro.codbairro = :lcodbairro1
    into :lcodibgecidade;

    if (CHAR_LENGTH(lcodibgecidade) = 7) then
    begin
       scodibgedestinatario = lcodibgecidade;
    end

    select coalesce(empresa.coduf, (select sysparams.coduf from sysparams))
    from SERIE
      join EMPRESA on SERIE.CODEMPRESA = EMPRESA.CODEMPRESA
    where
      SERIE.SERIE = :ESERIE
    into :SCODUFEMITENTE;

    if (SCSTPIS = '') then
      SCSTPIS = '01';

    if (SCSTCOFINS = '') then
      SCSTCOFINS = '01';

    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER TRIGGER CUPOMZITEM_BIU
as
declare variable TOT varchar(2);
declare variable ALIQ double precision;
declare variable TIPO varchar(1);
begin
  new.TRIBUTADO = null;
  if (CHAR_LENGTH(new.ALIQUOTA) <= 5) then
  begin
    new.SEQUENCIA  = null;
    new.PADRAO     = new.ALIQUOTA;
    new.ICMS       = 0;
    new.PERCENTUAL = 0;
  end
  else
  begin
    new.SEQUENCIA = substring(new.ALIQUOTA from 1 for 2);
    TIPO          = substring(new.ALIQUOTA from 3 for 1);

    if (TIPO = 'T') then
    begin
      new.PADRAO    = 'XxTnnnn';
      new.TRIBUTADO = '1';
      TOT = substring(new.ALIQUOTA from 4 for 1);

      if ((coalesce(new.ICMS, 0) <= 0) or (old.ALIQUOTA <> new.ALIQUOTA) or (old.VALOR <> new.VALOR)) then
      begin
        if (cast(TOT as integer) > 0) then
          ALIQ = substring(new.ALIQUOTA from 4 for 2);
        else
        begin
          ALIQ = substring(new.ALIQUOTA from 5 for 2);
          ALIQ = ALIQ / 10;
          new.TRIBUTADO = '2';
        end

        new.PERCENTUAL = ALIQ;
        new.ICMS       = (new.VALOR * ALIQ) / 100;
      end
    end else
    if (TIPO = 'S') then
    begin
      new.PADRAO     = 'XxSnnnn';
      new.PERCENTUAL = 0;
      new.ICMS       = 0;
      new.TRIBUTADO  = '5';
    end
  end

  if (new.PADRAO = 'Fn') then
    new.TRIBUTADO = '3';
  else
  if (new.PADRAO = 'In') then
    new.TRIBUTADO = '0';
  else
  if (new.PADRAO = 'Nn') then
    new.TRIBUTADO = '4';
  else
  if (new.PADRAO = 'FSn') then
    new.TRIBUTADO = '8';
  else
  if (new.PADRAO = 'ISn') then
    new.TRIBUTADO = '6';
  else
  if (new.PADRAO = 'NSn') then
    new.TRIBUTADO = '7';
end^

SET TERM ; ^

SET TERM ^ ;

ALTER TRIGGER PRODFILHO_BU
as
declare variable LNFE_CASAS integer;
declare variable LCUSTO double precision;
declare variable LCODEMPRESA integer;
declare variable LPRECOBASEATUALIZACAO integer;
declare variable LPERCENTUAL1 double precision;
declare variable LPERCENTUAL2 double precision;
declare variable LPERCENTUAL3 double precision;
declare variable LPERCENTUAL4 double precision;
declare variable LPERCENTUAL5 double precision;
declare variable LNCM varchar(8);
begin
  select
    DATANET,
    ATUALIZADATANET,
    CODEMPRESA,
    ATUALIZACODEMPRESANET
  from
    MATUALIZADATANET(new.DATANET, new.ATUALIZADATANET, new.CODEMPRESANET, new.ATUALIZACODEMPRESANET)
  into
    new.DATANET,
    new.ATUALIZADATANET,
    new.CODEMPRESANET,
    new.ATUALIZACODEMPRESANET;

    select
      M.CODEMPRESA
    from
      MRETORNACODEMPRESA(null, 'S') M
    into
      LCODEMPRESA;
  
  if (((new.CODEMPRESA is null) or (new.CODEMPRESA = LCODEMPRESA))) then
  begin
    select
      VALOR
    from
      MLERPARAMETROINTEIRO('CASAS DECIMAS PARA EXIBIO DO PREO',2)
    into
      LNFE_CASAS;

    if (LNFE_CASAS = 0) then
    begin
       LNFE_CASAS = 2;
    end
  
    select
      M.VALOR
    from
      MLERPARAMETROINTEIRO('PREO BASE PARA ATUALIZAO DE PREOS', 0) M
    into
      LPRECOBASEATUALIZACAO;
  
    if (LPRECOBASEATUALIZACAO > 0) then
    begin
      select
        M.VALOR
      from
        MLERPARAMETRONUMERO('PERCENTUAL 1', 0) M
      into
        LPERCENTUAL1;
  
      select
        M.VALOR
      from
        MLERPARAMETRONUMERO('PERCENTUAL 2', 0) M
      into
        LPERCENTUAL2;
  
      select
        M.VALOR
      from
        MLERPARAMETRONUMERO('PERCENTUAL 3', 0) M
      into
        LPERCENTUAL3;
  
      select
        M.VALOR
      from
        MLERPARAMETRONUMERO('PERCENTUAL 4', 0) M
      into
        LPERCENTUAL4;
  
      select
        M.VALOR
      from
        MLERPARAMETRONUMERO('PERCENTUAL 5', 0) M
      into
        LPERCENTUAL5;
  
      if (LPRECOBASEATUALIZACAO = 1) then
      begin
        new.PRECOPRATICADO2 = new.PRECOPRATICADO1 * ((LPERCENTUAL1 / 100) + 1);
        new.PRECOPRATICADO3 = new.PRECOPRATICADO1 * ((LPERCENTUAL2 / 100) + 1);
        new.PRECOPRATICADO4 = new.PRECOPRATICADO1 * ((LPERCENTUAL3 / 100) + 1);
        new.PRECOPRATICADO5 = new.PRECOPRATICADO1 * ((LPERCENTUAL4 / 100) + 1);
        new.PRECOPRATICADO6 = new.PRECOPRATICADO1 * ((LPERCENTUAL5 / 100) + 1);
      end
      else if (LPRECOBASEATUALIZACAO = 2) then
      begin
        new.PRECOPRATICADO1 = new.PRECOPRATICADO2 * ((LPERCENTUAL1 / 100) + 1);
        new.PRECOPRATICADO3 = new.PRECOPRATICADO2 * ((LPERCENTUAL2 / 100) + 1);
        new.PRECOPRATICADO4 = new.PRECOPRATICADO2 * ((LPERCENTUAL3 / 100) + 1);
        new.PRECOPRATICADO5 = new.PRECOPRATICADO2 * ((LPERCENTUAL4 / 100) + 1);
        new.PRECOPRATICADO6 = new.PRECOPRATICADO2 * ((LPERCENTUAL5 / 100) + 1);
      end
      else if (LPRECOBASEATUALIZACAO = 3) then
      begin
        new.PRECOPRATICADO1 = new.PRECOPRATICADO3 * ((LPERCENTUAL1 / 100) + 1);
        new.PRECOPRATICADO2 = new.PRECOPRATICADO3 * ((LPERCENTUAL2 / 100) + 1);
        new.PRECOPRATICADO4 = new.PRECOPRATICADO3 * ((LPERCENTUAL3 / 100) + 1);
        new.PRECOPRATICADO5 = new.PRECOPRATICADO3 * ((LPERCENTUAL4 / 100) + 1);
        new.PRECOPRATICADO6 = new.PRECOPRATICADO3 * ((LPERCENTUAL5 / 100) + 1);
      end
      else if (LPRECOBASEATUALIZACAO = 4) then
      begin
        new.PRECOPRATICADO1 = new.PRECOPRATICADO4 * ((LPERCENTUAL1 / 100) + 1);
        new.PRECOPRATICADO2 = new.PRECOPRATICADO4 * ((LPERCENTUAL2 / 100) + 1);
        new.PRECOPRATICADO3 = new.PRECOPRATICADO4 * ((LPERCENTUAL3 / 100) + 1);
        new.PRECOPRATICADO5 = new.PRECOPRATICADO4 * ((LPERCENTUAL4 / 100) + 1);
        new.PRECOPRATICADO6 = new.PRECOPRATICADO4 * ((LPERCENTUAL5 / 100) + 1);
      end
      else if (LPRECOBASEATUALIZACAO = 5) then
      begin
        new.PRECOPRATICADO1 = new.PRECOPRATICADO5 * ((LPERCENTUAL1 / 100) + 1);
        new.PRECOPRATICADO2 = new.PRECOPRATICADO5 * ((LPERCENTUAL2 / 100) + 1);
        new.PRECOPRATICADO3 = new.PRECOPRATICADO5 * ((LPERCENTUAL3 / 100) + 1);
        new.PRECOPRATICADO4 = new.PRECOPRATICADO5 * ((LPERCENTUAL4 / 100) + 1);
        new.PRECOPRATICADO6 = new.PRECOPRATICADO5 * ((LPERCENTUAL5 / 100) + 1);
      end
      else if (LPRECOBASEATUALIZACAO = 6) then
      begin
        new.PRECOPRATICADO1 = new.PRECOPRATICADO6 * ((LPERCENTUAL1 / 100) + 1);
        new.PRECOPRATICADO2 = new.PRECOPRATICADO6 * ((LPERCENTUAL2 / 100) + 1);
        new.PRECOPRATICADO3 = new.PRECOPRATICADO6 * ((LPERCENTUAL3 / 100) + 1);
        new.PRECOPRATICADO4 = new.PRECOPRATICADO6 * ((LPERCENTUAL4 / 100) + 1);
        new.PRECOPRATICADO5 = new.PRECOPRATICADO6 * ((LPERCENTUAL5 / 100) + 1);
      end
    end

    if (old.PRECOPRATICADO1 <> new.PRECOPRATICADO1) then
    begin
      if (LNFE_CASAS = 0) then
        new.PRECOPRATICADO1 = cast(new.PRECOPRATICADO1 as numeric(18, 0));
      else if (LNFE_CASAS = 2) then
        new.PRECOPRATICADO1 = cast(new.PRECOPRATICADO1 as numeric(18, 2));
      else if (LNFE_CASAS = 3) then
        new.PRECOPRATICADO1 = cast(new.PRECOPRATICADO1 as numeric(18, 3));
      else if (LNFE_CASAS = 4) then
        new.PRECOPRATICADO1 = cast(new.PRECOPRATICADO1 as numeric(18, 4));
      else if (LNFE_CASAS = 5) then
        new.PRECOPRATICADO1 = cast(new.PRECOPRATICADO1 as numeric(18, 5));
      else if (LNFE_CASAS = 6) then
        new.PRECOPRATICADO1 = cast(new.PRECOPRATICADO1 as numeric(18, 6));
    end
  
    if (old.PRECOPRATICADO2 <> new.PRECOPRATICADO2) then
    begin
      if (LNFE_CASAS = 0) then
        new.PRECOPRATICADO2 = cast(new.PRECOPRATICADO2 as numeric(18, 0));
      else if (LNFE_CASAS = 2) then
        new.PRECOPRATICADO2 = cast(new.PRECOPRATICADO2 as numeric(18, 2));
      else if (LNFE_CASAS = 3) then
        new.PRECOPRATICADO2 = cast(new.PRECOPRATICADO2 as numeric(18, 3));
      else if (LNFE_CASAS = 4) then
        new.PRECOPRATICADO2 = cast(new.PRECOPRATICADO2 as numeric(18, 4));
      else if (LNFE_CASAS = 5) then
        new.PRECOPRATICADO2 = cast(new.PRECOPRATICADO2 as numeric(18, 5));
      else if (LNFE_CASAS = 6) then
        new.PRECOPRATICADO2 = cast(new.PRECOPRATICADO2 as numeric(18, 6));
    end
  
    if (old.PRECOPRATICADO3 <> new.PRECOPRATICADO3) then
    begin
      if (LNFE_CASAS = 0) then
        new.PRECOPRATICADO3 = cast(new.PRECOPRATICADO3 as numeric(18, 0));
      else if (LNFE_CASAS = 2) then
        new.PRECOPRATICADO3 = cast(new.PRECOPRATICADO3 as numeric(18, 2));
      else if (LNFE_CASAS = 3) then
        new.PRECOPRATICADO3 = cast(new.PRECOPRATICADO3 as numeric(18, 3));
      else if (LNFE_CASAS = 4) then
        new.PRECOPRATICADO3 = cast(new.PRECOPRATICADO3 as numeric(18, 4));
      else if (LNFE_CASAS = 5) then
        new.PRECOPRATICADO3 = cast(new.PRECOPRATICADO3 as numeric(18, 5));
      else if (LNFE_CASAS = 6) then
        new.PRECOPRATICADO3 = cast(new.PRECOPRATICADO3 as numeric(18, 6));
    end
  
    if (old.PRECOPRATICADO4 <> new.PRECOPRATICADO4) then
    begin
      if (LNFE_CASAS = 0) then
        new.PRECOPRATICADO4 = cast(new.PRECOPRATICADO4 as numeric(18, 0));
      else if (LNFE_CASAS = 2) then
        new.PRECOPRATICADO4 = cast(new.PRECOPRATICADO4 as numeric(18, 2));
      else if (LNFE_CASAS = 3) then
        new.PRECOPRATICADO4 = cast(new.PRECOPRATICADO4 as numeric(18, 3));
      else if (LNFE_CASAS = 4) then
        new.PRECOPRATICADO4 = cast(new.PRECOPRATICADO4 as numeric(18, 4));
      else if (LNFE_CASAS = 5) then
        new.PRECOPRATICADO4 = cast(new.PRECOPRATICADO4 as numeric(18, 5));
      else if (LNFE_CASAS = 6) then
        new.PRECOPRATICADO4 = cast(new.PRECOPRATICADO4 as numeric(18, 6));
    end
  
    if (old.PRECOPRATICADO5 <> new.PRECOPRATICADO5) then
    begin
      if (LNFE_CASAS = 0) then
        new.PRECOPRATICADO5 = cast(new.PRECOPRATICADO5 as numeric(18, 0));
      else if (LNFE_CASAS = 2) then
        new.PRECOPRATICADO5 = cast(new.PRECOPRATICADO5 as numeric(18, 2));
      else if (LNFE_CASAS = 3) then
        new.PRECOPRATICADO5 = cast(new.PRECOPRATICADO5 as numeric(18, 3));
      else if (LNFE_CASAS = 4) then
        new.PRECOPRATICADO5 = cast(new.PRECOPRATICADO5 as numeric(18, 4));
      else if (LNFE_CASAS = 5) then
        new.PRECOPRATICADO5 = cast(new.PRECOPRATICADO5 as numeric(18, 5));
      else if (LNFE_CASAS = 6) then
        new.PRECOPRATICADO5 = cast(new.PRECOPRATICADO5 as numeric(18, 6));
    end
  
    if (old.PRECOPRATICADO6 <> new.PRECOPRATICADO6) then
    begin
      if (LNFE_CASAS = 0) then
        new.PRECOPRATICADO6 = cast(new.PRECOPRATICADO6 as numeric(18, 0));
      else if (LNFE_CASAS = 2) then
        new.PRECOPRATICADO6 = cast(new.PRECOPRATICADO6 as numeric(18, 2));
      else if (LNFE_CASAS = 3) then
        new.PRECOPRATICADO6 = cast(new.PRECOPRATICADO6 as numeric(18, 3));
      else if (LNFE_CASAS = 4) then
        new.PRECOPRATICADO6 = cast(new.PRECOPRATICADO6 as numeric(18, 4));
      else if (LNFE_CASAS = 5) then
        new.PRECOPRATICADO6 = cast(new.PRECOPRATICADO6 as numeric(18, 5));
      else if (LNFE_CASAS = 6) then
        new.PRECOPRATICADO6 = cast(new.PRECOPRATICADO6 as numeric(18, 6));
    end
  
    select
      C.CUSTO
    from
      MCALCULACUSTO(new.CODPRODFILHO) C
    into
      LCUSTO;
  
    -- ATUALIZANDO O PREO SUGERIDO
    if ((coalesce(new.PRECOSUGERIDO1, 0) <= 0) and (coalesce(new.MARKUP1, 0) > 0)) then
    begin
      new.PRECOSUGERIDO1 = LCUSTO / ((100 - coalesce(nullif(new.MARKUP1, 100), 0)) / 100);
      new.PRECOSUGERIDO1 = new.PRECOSUGERIDO1 / ((100 - (coalesce(new.PERC_PIS, 0) + coalesce(new.PERC_COFINS, 0) + coalesce(new.PERC_CSLL, 0) + coalesce(new.PERCMVOUTROS, 0))) / 100);
    end
  
    if ((coalesce(new.PRECOSUGERIDO2, 0) <= 0) and (coalesce(new.MARKUP2, 0) > 0)) then
    begin
      new.PRECOSUGERIDO2 = LCUSTO / ((100 - coalesce(nullif(new.MARKUP2, 100), 0)) / 100);
      new.PRECOSUGERIDO2 = new.PRECOSUGERIDO2 / ((100 - (coalesce(new.PERC_PIS, 0) + coalesce(new.PERC_COFINS, 0) + coalesce(new.PERC_CSLL, 0) + coalesce(new.PERCMVOUTROS, 0))) / 100);
    end
  
    if ((coalesce(new.PRECOSUGERIDO3, 0) <= 0) and (coalesce(new.MARKUP3, 0) > 0)) then
    begin
      new.PRECOSUGERIDO3 = LCUSTO / ((100 - coalesce(nullif(new.MARKUP3, 100), 0)) / 100);
      new.PRECOSUGERIDO3 = new.PRECOSUGERIDO3 / ((100 - (coalesce(new.PERC_PIS, 0) + coalesce(new.PERC_COFINS, 0) + coalesce(new.PERC_CSLL, 0) + coalesce(new.PERCMVOUTROS, 0))) / 100);
    end

    if ((coalesce(new.PRECOSUGERIDO4, 0) <= 0) and (coalesce(new.MARKUP4, 0) > 0)) then
    begin
      new.PRECOSUGERIDO4 = LCUSTO / ((100 - coalesce(nullif(new.MARKUP4, 100), 0)) / 100);
      new.PRECOSUGERIDO4 = new.PRECOSUGERIDO4 / ((100 - (coalesce(new.PERC_PIS, 0) + coalesce(new.PERC_COFINS, 0) + coalesce(new.PERC_CSLL, 0) + coalesce(new.PERCMVOUTROS, 0))) / 100);
    end

    if ((coalesce(new.PRECOSUGERIDO5, 0) <= 0) and (coalesce(new.MARKUP5, 0) > 0)) then
    begin
      new.PRECOSUGERIDO5 = LCUSTO / ((100 - coalesce(nullif(new.MARKUP5, 100), 0)) / 100);
      new.PRECOSUGERIDO5 = new.PRECOSUGERIDO5 / ((100 - (coalesce(new.PERC_PIS, 0) + coalesce(new.PERC_COFINS, 0) + coalesce(new.PERC_CSLL, 0) + coalesce(new.PERCMVOUTROS, 0))) / 100);
    end

    if ((coalesce(new.PRECOSUGERIDO6, 0) <= 0) and (coalesce(new.MARKUP6, 0) > 0)) then
    begin
      new.PRECOSUGERIDO6 = LCUSTO / ((100 - coalesce(nullif(new.MARKUP6, 100), 0)) / 100);
      new.PRECOSUGERIDO6 = new.PRECOSUGERIDO6 / ((100 - (coalesce(new.PERC_PIS, 0) + coalesce(new.PERC_COFINS, 0) + coalesce(new.PERC_CSLL, 0) + coalesce(new.PERCMVOUTROS, 0))) / 100);
    end

    if (LNFE_CASAS = 0) then
    begin
      new.PRECOSUGERIDO1 = cast(new.PRECOSUGERIDO1 as numeric(18, 0));
      new.PRECOSUGERIDO2 = cast(new.PRECOSUGERIDO2 as numeric(18, 0));
      new.PRECOSUGERIDO3 = cast(new.PRECOSUGERIDO3 as numeric(18, 0));
      new.PRECOSUGERIDO4 = cast(new.PRECOSUGERIDO4 as numeric(18, 0));
      new.PRECOSUGERIDO5 = cast(new.PRECOSUGERIDO5 as numeric(18, 0));
      new.PRECOSUGERIDO6 = cast(new.PRECOSUGERIDO6 as numeric(18, 0));
    end 
    else if (LNFE_CASAS = 2) then
    begin
      new.PRECOSUGERIDO1 = cast(new.PRECOSUGERIDO1 as numeric(18, 2));
      new.PRECOSUGERIDO2 = cast(new.PRECOSUGERIDO2 as numeric(18, 2));
      new.PRECOSUGERIDO3 = cast(new.PRECOSUGERIDO3 as numeric(18, 2));
      new.PRECOSUGERIDO4 = cast(new.PRECOSUGERIDO4 as numeric(18, 2));
      new.PRECOSUGERIDO5 = cast(new.PRECOSUGERIDO5 as numeric(18, 2));
      new.PRECOSUGERIDO6 = cast(new.PRECOSUGERIDO6 as numeric(18, 2));
    end 
    else if (LNFE_CASAS = 3) then
    begin
      new.PRECOSUGERIDO1 = cast(new.PRECOSUGERIDO1 as numeric(18, 3));
      new.PRECOSUGERIDO2 = cast(new.PRECOSUGERIDO2 as numeric(18, 3));
      new.PRECOSUGERIDO3 = cast(new.PRECOSUGERIDO3 as numeric(18, 3));
      new.PRECOSUGERIDO4 = cast(new.PRECOSUGERIDO4 as numeric(18, 3));
      new.PRECOSUGERIDO5 = cast(new.PRECOSUGERIDO5 as numeric(18, 3));
      new.PRECOSUGERIDO6 = cast(new.PRECOSUGERIDO6 as numeric(18, 3));
    end 
    else if (LNFE_CASAS = 4) then
    begin
      new.PRECOSUGERIDO1 = cast(new.PRECOSUGERIDO1 as numeric(18, 4));
      new.PRECOSUGERIDO2 = cast(new.PRECOSUGERIDO2 as numeric(18, 4));
      new.PRECOSUGERIDO3 = cast(new.PRECOSUGERIDO3 as numeric(18, 4));
      new.PRECOSUGERIDO4 = cast(new.PRECOSUGERIDO4 as numeric(18, 4));
      new.PRECOSUGERIDO5 = cast(new.PRECOSUGERIDO5 as numeric(18, 4));
      new.PRECOSUGERIDO6 = cast(new.PRECOSUGERIDO6 as numeric(18, 4));
    end 
    else if (LNFE_CASAS = 5) then
    begin
      new.PRECOSUGERIDO1 = cast(new.PRECOSUGERIDO1 as numeric(18, 5));
      new.PRECOSUGERIDO2 = cast(new.PRECOSUGERIDO2 as numeric(18, 5));
      new.PRECOSUGERIDO3 = cast(new.PRECOSUGERIDO3 as numeric(18, 5));
      new.PRECOSUGERIDO4 = cast(new.PRECOSUGERIDO4 as numeric(18, 5));
      new.PRECOSUGERIDO5 = cast(new.PRECOSUGERIDO5 as numeric(18, 5));
      new.PRECOSUGERIDO6 = cast(new.PRECOSUGERIDO6 as numeric(18, 5));
    end 
    else if (LNFE_CASAS = 6) then
    begin
      new.PRECOSUGERIDO1 = cast(new.PRECOSUGERIDO1 as numeric(18, 6));
      new.PRECOSUGERIDO2 = cast(new.PRECOSUGERIDO2 as numeric(18, 6));
      new.PRECOSUGERIDO3 = cast(new.PRECOSUGERIDO3 as numeric(18, 6));
      new.PRECOSUGERIDO4 = cast(new.PRECOSUGERIDO4 as numeric(18, 6));
      new.PRECOSUGERIDO5 = cast(new.PRECOSUGERIDO5 as numeric(18, 6));
      new.PRECOSUGERIDO6 = cast(new.PRECOSUGERIDO6 as numeric(18, 6));
    end 
  
    if (not exists(select CODNV from PRODCOMBINADOS where PRODCOMBINADOS.CODNV = new.CODPRODFILHO)) then
      new.PRODCOMBINADO = 1;
    else
      new.PRODCOMBINADO = 2;
  end

  if (coalesce(new.CODNCM, 0) <> 0) then
  begin
    select
      NCM.NCM_CODIGO
    from
      NCM
    where
      NCM.CODNCM = new.CODNCM
    into
      LNCM;

    if (CHAR_LENGTH(LNCM) = 8) then
      new.CLASSFISCAL = :LNCM;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER TRIGGER TRG_APCUPOMZITEM_BIU
as
declare variable ALIQ double precision;
declare variable TIPO varchar(1);
declare variable VIRG integer;
begin
  new.TRIBUTADO = null;
  if (CHAR_LENGTH(new.ALIQUOTA) <= 5) then
  begin
    new.SEQUENCIA  = null;
    new.PADRAO     = new.ALIQUOTA;
    new.ICMS       = 0;
    new.PERCENTUAL = 0;
  end
  else
  begin
    new.SEQUENCIA = substring(new.ALIQUOTA from 1 for 2);
    TIPO          = substring(new.ALIQUOTA from 3 for 1);
    VIRG          = 0;

    if (TIPO = 'T') then
    begin
      new.PADRAO    = 'XxTnnnn';
      if ((coalesce(new.ICMS, 0) <= 0) or (old.ALIQUOTA <> new.ALIQUOTA) or (old.VALOR <> new.VALOR)) then
      begin
        VIRG = substring(new.ALIQUOTA from 6 for 1);
        ALIQ = substring(new.ALIQUOTA from 4 for 4);
        ALIQ = ALIQ / 100;
        new.PERCENTUAL = ALIQ;
        new.ICMS       = (new.VALOR * ALIQ) / 100;

        if (VIRG = 0) then
          new.TRIBUTADO = '1';
        else
          new.TRIBUTADO = '2';
      end
    end else
    if (TIPO = 'S') then
    begin
      new.PADRAO     = 'XxSnnnn';
      new.PERCENTUAL = 0;
      new.ICMS       = 0;
      new.TRIBUTADO  = '5';
    end
  end

  if (new.PADRAO = 'Fn') then
    new.TRIBUTADO = '3';
  else
  if (new.PADRAO = 'In') then
    new.TRIBUTADO = '0';
  else
  if (new.PADRAO = 'Nn') then
    new.TRIBUTADO = '4';
  else
  if (new.PADRAO = 'FSn') then
    new.TRIBUTADO = '8';
  else
  if (new.PADRAO = 'ISn') then
    new.TRIBUTADO = '6';
  else
  if (new.PADRAO = 'NSn') then
    new.TRIBUTADO = '7';
end^

SET TERM ; ^
