-- LTRIM

SET TERM ^ ;

ALTER PROCEDURE FRANALISECOMPRASDISTCEASA(
    ECODUSERCAD INTEGER,
    ECODEMPRESA BLOB SUB_TYPE TEXT SEGMENT SIZE 80,
    EDTINI DATE,
    EDTFIM DATE,
    ECOBERTURA INTEGER,
    EDDEMENORQUE INTEGER,
    EDDEMARIOQUE INTEGER,
    EFORADELINA VARCHAR(1),
    ECODFORNECEDOR INTEGER,
    ECODFABRICANTE BLOB SUB_TYPE TEXT SEGMENT SIZE 80,
    ECODGRUPO BLOB SUB_TYPE TEXT SEGMENT SIZE 80,
    ECODSUBGRUPO BLOB SUB_TYPE TEXT SEGMENT SIZE 80,
    EFILTRO_DESCRICAO VARCHAR(100))
RETURNS (
    CODGRUPO INTEGER,
    GRUPO VARCHAR(60),
    CODSUBGRUPO INTEGER,
    SUBGRUPO VARCHAR(60),
    CODFABRICANTE INTEGER,
    FABRICANTE VARCHAR(60),
    CODPRODFILHO INTEGER,
    DESCRICAO VARCHAR(60),
    CODPESQ1 VARCHAR(30),
    TOTALVENDAS DOUBLE PRECISION,
    MEDIAVENDAS DOUBLE PRECISION,
    COBERTURA DOUBLE PRECISION,
    NECESSIDADE DOUBLE PRECISION,
    ESTOQUE DOUBLE PRECISION,
    ESTQCRITCO DOUBLE PRECISION,
    ESTQANALISE DOUBLE PRECISION,
    TRANSITO DOUBLE PRECISION,
    QTDSUGERIDA DOUBLE PRECISION,
    CAIXASSUGERIDA DOUBLE PRECISION,
    CODPESQ2 VARCHAR(30),
    CODPESQ3 VARCHAR(7),
    UNIDADE VARCHAR(15),
    QTDEMBALAGEM DOUBLE PRECISION,
    QTD_COMPRA DOUBLE PRECISION,
    PRECO_ULT_COMPRA DOUBLE PRECISION,
    PRECO_ULT_COMPRA_UNIT DOUBLE PRECISION,
    PRECO_ACORDO DOUBLE PRECISION,
    FORADELINHA CHAR(1),
    PROMOCAO CHAR(1),
    ATIVOPESQ SMALLINT,
    UNIDADEESP VARCHAR(15),
    QTD_ULTIMACOMPRA DOUBLE PRECISION,
    PRAZOMEDIOENTREGA DOUBLE PRECISION,
    ESTQMAX DOUBLE PRECISION,
    ESTQMIN DOUBLE PRECISION,
    DTULTMACOMPRA DATE,
    DDE INTEGER,
    DISPONIVEL DOUBLE PRECISION,
    INDICE_RUPTURA DOUBLE PRECISION,
    QTD_PALETIZADA DOUBLE PRECISION,
    FATORCONVERSAO DOUBLE PRECISION,
    PRECOPRATICADO1 DOUBLE PRECISION,
    PRECOPRATICADO2 DOUBLE PRECISION,
    PRECOPRATICADO3 DOUBLE PRECISION,
    PRECOPRATICADO4 DOUBLE PRECISION,
    PRECOPRATICADO5 DOUBLE PRECISION,
    PRECOPRATICADO6 DOUBLE PRECISION,
    APLICACAO VARCHAR(2000))
AS
declare variable CODPRODUTO integer;
declare variable DIAS_MEDIA integer;
declare variable MATERIAPRIMA varchar(1);
declare variable DIFDIAS integer;
declare variable LESTOQUELOTE varchar(1);
declare variable LLOTE varchar(200);
BEGIN
  DIFDIAS = datediff(DAY,EDTINI,EDTFIM);

  SELECT
    COALESCE(SYSPARAMS.DIAS_MEDIA_SUG_COMPRAS, 30)
  FROM
    SYSPARAMS
  WHERE
    SYSPARAMS.CODSYSPARAMS = 1
  INTO
    DIAS_MEDIA;

  delete from ACD_TOTALIZACAO;

  INSERT INTO ACD_TOTALIZACAO(
    CODPRODFILHO,
    TIPO,
    QUANTIDADE)
  SELECT
    PEDVENDITEM.CODPRODFILHO,
    'V',
    SUM(PEDVENDITEM.QTDE)
  FROM
    PEDVENDITEM
    JOIN PEDVEND ON 
      PEDVENDITEM.CODPEDVEND = PEDVEND.CODPEDVEND
  WHERE
    PEDVEND.STATUSPED = 'FATURADO' AND
    PEDVEND.TIPOPED IN ('VENDA', 'CADERNO') AND
    PEDVEND.DTFATURADO BETWEEN :EDTINI AND :EDTFIM
    AND ((:ECODEMPRESA = '') or (:ECODEMPRESA containing PEDVEND.CODEMPRESA))
  GROUP BY
    1,2;

  INSERT INTO ACD_TOTALIZACAO(
    CODPRODFILHO,
    TIPO,
    QUANTIDADE)
  SELECT
    PEDCPRITENS.CODPRODFILHO,
    'T',
    SUM(COALESCE(PEDCPRITENS.QTDEPEDIDA, 0) - COALESCE(PEDCPRITENS.QTDERECEBI, 0))
  FROM
    PEDCPRITENS
    JOIN PEDCPR ON
      PEDCPR.CODPEDCPR = PEDCPRITENS.CODPEDCPR
  WHERE
    PEDCPRITENS.EMTRANSITO   = 'S' AND
    PEDCPR.STATUS       NOT IN ('CANCELADO', 'FATURADO', 'COTAÃ?ÃfO')
    AND ((:ECODEMPRESA = '') or (:ECODEMPRESA containing PEDCPR.CODEMPRESA))
  GROUP BY 1,2;

  INSERT INTO ACD_TOTALIZACAO(
    CODPRODFILHO,
    TIPO,
    QUANTIDADE)
  SELECT
    NFENTRADAITENS.CODPRODFILHO,
    'E',
    AVG(DATEDIFF(DAY, NFENTRADA.DTEMISSAO, NFENTRADA.DTENTRADA))
  FROM
    NFENTRADA
    JOIN NFENTRADAITENS ON
      NFENTRADA.CODNFENTRADA = NFENTRADAITENS.CODNFENTRADA
  WHERE
    NFENTRADA.STATUS = 'F' and
    NFENTRADA.NFE_TIPO = 'ENTRADA'
    AND ((:ECODEMPRESA = '') or (:ECODEMPRESA containing NFENTRADA.CODEMPRESA))
  group by 1,2;

  FOR SELECT
    PRODFILHO.CODPRODFILHO,
    TRIM(PRODFILHO.DESCRICAO),
    PRODFILHO.CODPESQ1,
    PRODFILHO.CODPESQ2,
    PRODFILHO.CODPESQ3,
    PRODFILHO.CODPRODUTO,
    COALESCE(PRODFILHO.PRDF_MATERIAPRIMA, 'N'),
    COALESCE(PRODFILHO.COBERTURA, 0),
    PRODFILHO.ESTQATUAL,
    COALESCE(NULLIF(PRODFILHO.QTDEMBALAGEM, 0), 1),
    UNIDADE.SIGLA,
    (COALESCE(PRODFILHO.PRECOFORNEC, 0) + COALESCE(PRODFILHO.PRECOCAT, 0)) * COALESCE(NULLIF(PRODFILHO.QTDEMBALAGEM, 0), 1),
    COALESCE(PRODFILHO.PRECO_ACORDO, 0),
    PRODFILHO.ESTQCRITCO,
    COALESCE(NULLIF(PRODFILHO.FORADELINHA, 'N'), 'N'),
    COALESCE(PRODFILHO.PROMOCAO, 0),
    PRODFILHO.ESTOQANALISE,
    PRODFILHO.UNIDADE,
    COALESCE(PRODFILHO.QTDULTIMACOMPRA, 0),
    coalesce(PRODFILHO.ESTQMAX,0),
    coalesce(PRODFILHO.ESTQMIN,0),
    PRODFILHO.DTULTMACOMPRA,
    CAST(SUBSTRING(PRODUTO.OBS FROM 1 FOR 2000) AS VARCHAR(2000)) APLICACAO,
    COALESCE(PRODFILHO.ESTOQUELOTE, 'N'),
    coalesce(PRODFILHO.QTD_PALETIZADA,0),
    coalesce(PRODFILHO.FATORCONVERSAO,1),
    coalesce(PRODFILHO.PRECOPRATICADO1,0),
    coalesce(PRODFILHO.PRECOPRATICADO2,0),
    coalesce(PRODFILHO.PRECOPRATICADO3,0),
    coalesce(PRODFILHO.PRECOPRATICADO4,0),
    coalesce(PRODFILHO.PRECOPRATICADO5,0),
    coalesce(PRODFILHO.PRECOPRATICADO6,0)
  FROM
    PRODFILHO
    JOIN PRODUTO ON
      PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
      AND PRODUTO.ATIVO = 2
    JOIN UNIDADE ON
      PRODFILHO.CODUNIDADE = UNIDADE.CODUNIDADE
  WHERE
    1 = 1
    AND (
      (:EFORADELINA = 'S') OR
      ((:EFORADELINA = 'N') AND (COALESCE(PRODFILHO.FORADELINHA,'N') = 'N'))
    )
    AND (
      (:ECODFORNECEDOR = 0) OR (EXISTS(SELECT * FROM PRODPESSOA
                                       WHERE PRODPESSOA.CODPRODUTO = PRODFILHO.CODPRODFILHO
                                             AND PRODPESSOA.CODPESSOA = :ECODFORNECEDOR))
    )
    AND (
      (:ECODFABRICANTE = '') OR ( ','||replace(:ECODFABRICANTE,' ','')||',' CONTAINING ','||PRODUTO.CODFABRICANTE||',' )
    )
    AND (
      (:ECODGRUPO = '') OR ( ','||replace(:ECODGRUPO,' ','')||',' CONTAINING ','||PRODUTO.CODGRUPO||',' )
    )
    AND (
      (:ECODSUBGRUPO = '') OR ( ','||replace(:ECODSUBGRUPO,' ','')||',' CONTAINING ','||PRODUTO.CODSUBGRUPO||',' )
    )
    AND (
      (:EFILTRO_DESCRICAO = '') OR ( PRODFILHO.DESCRICAO containing :EFILTRO_DESCRICAO )
    )
  ORDER BY
    PRODFILHO.DESCRICAO
  INTO
    CODPRODFILHO,
    DESCRICAO,
    CODPESQ1,
    CODPESQ2,
    CODPESQ3,
    CODPRODUTO,
    MATERIAPRIMA,
    COBERTURA,
    ESTOQUE,
    QTDEMBALAGEM,
    UNIDADE,
    PRECO_ULT_COMPRA,
    PRECO_ACORDO,
    ESTQCRITCO,
    FORADELINHA,
    PROMOCAO,
    ESTQANALISE,
    UNIDADEESP,
    QTD_ULTIMACOMPRA,
    ESTQMAX,
    ESTQMIN,
    DTULTMACOMPRA,
    APLICACAO,
    LESTOQUELOTE,
    QTD_PALETIZADA,
    FATORCONVERSAO,
    PRECOPRATICADO1,
    PRECOPRATICADO2,
    PRECOPRATICADO3,
    PRECOPRATICADO4,
    PRECOPRATICADO5,
    PRECOPRATICADO6
  DO
  BEGIN
    TOTALVENDAS = 0;

    SELECT
      QUANTIDADE
    FROM
      ACD_TOTALIZACAO
    WHERE
      CODPRODFILHO = :CODPRODFILHO
      AND TIPO = 'V'
    INTO
      TOTALVENDAS;

    TOTALVENDAS = COALESCE(TOTALVENDAS,0);

    IF (LESTOQUELOTE = 'S') THEN
    BEGIN
      IF (EXISTS(SELECT * FROM LOTE)) THEN
      BEGIN
        SELECT
          SUM(PF.QTD)
        FROM
          PRODFILHO PDF
          JOIN PRODFILHOLOTES PF
            ON PDF.CODPRODFILHO = PF.CODPRODFILHO
          JOIN LOTE ON
            PF.LOTE = LOTE.DESCRICAO
            AND ((:ECODEMPRESA = '') OR (:ECODEMPRESA CONTAINING LOTE.CODEMPRESA))
        WHERE
          PDF.CODPRODFILHO = :CODPRODFILHO
        INTO
          ESTOQUE;
      END 
      ELSE
      BEGIN
        SELECT
          SUM(PF.QTD)
        FROM
          PRODFILHO PDF
          JOIN PRODFILHOLOTES PF
            ON PDF.CODPRODFILHO = PF.CODPRODFILHO
        WHERE
          PDF.CODPRODFILHO = :CODPRODFILHO
        INTO
          ESTOQUE;
      END 
    END
    
    SELECT
      PRODUTO.CODGRUPO,
      PRODUTO.CODSUBGRUPO,
      PRODUTO.CODFABRICANTE,
      PRODUTO.ATIVOPESQ
    FROM
      PRODUTO
    WHERE
      PRODUTO.CODPRODUTO =:CODPRODUTO
    INTO
      CODGRUPO,
      CODSUBGRUPO,
      CODFABRICANTE,
      ATIVOPESQ;

    SELECT
      GRUPO.DESCRICAO
    FROM
      GRUPO
    WHERE
      GRUPO.CODGRUPO =:CODGRUPO
    INTO
      GRUPO;

    SELECT
      SUBGRUPO.DESCRICAO
    FROM
      SUBGRUPO
    WHERE
      SUBGRUPO.CODSUBGRUPO =:CODSUBGRUPO
    INTO
      SUBGRUPO;

    SELECT
      PESSOA.NOME
    FROM
      PESSOA
    WHERE
      PESSOA.CODPESSOA = :CODFABRICANTE
    INTO
      FABRICANTE;

    QTD_COMPRA = 0;
    SELECT
      COALESCE(AC.QTD, 0),
      COALESCE(AC.VALOR,:PRECO_ULT_COMPRA)
    FROM
      ANALISECOMPRADIST AC
    WHERE
      AC.CODPRODFILHO = :CODPRODFILHO
      AND AC.CODUSERCAD = :ECODUSERCAD
    INTO
      QTD_COMPRA,
      PRECO_ULT_COMPRA;


    PRECO_ULT_COMPRA_UNIT = SIMPLEROUNDTO(:PRECO_ULT_COMPRA / :QTDEMBALAGEM,-2);

    QTD_COMPRA = COALESCE(QTD_COMPRA, 0);

    IF (DIAS_MEDIA > 0) THEN
    BEGIN
      MEDIAVENDAS = CAST(TOTALVENDAS / COALESCE(NULLIF(DIFDIAS, 0), 1) AS NUMERIC(10, 2));
      NECESSIDADE = DIAS_MEDIA * MEDIAVENDAS;
    END
    ELSE
    BEGIN
      MEDIAVENDAS = CAST(TOTALVENDAS / COALESCE(NULLIF(DIFDIAS, 0), 1) AS NUMERIC(10, 2));
      NECESSIDADE = COBERTURA * MEDIAVENDAS;
    END

    IF (COALESCE(ECOBERTURA,0) > 0) THEN
    BEGIN
      NECESSIDADE = ECOBERTURA * MEDIAVENDAS;
    END
    TRANSITO = 0;
    SELECT
      QUANTIDADE
    FROM
      ACD_TOTALIZACAO
    WHERE
      CODPRODFILHO = :CODPRODFILHO
      AND TIPO = 'T'
    INTO
      TRANSITO;

    DISPONIVEL = COALESCE(ESTOQUE,0) - coalesce(ESTQANALISE,0) ;

    IF (NECESSIDADE - (DISPONIVEL + TRANSITO) > 0) THEN
      QTDSUGERIDA = (NECESSIDADE - (DISPONIVEL + TRANSITO));
    ELSE
      QTDSUGERIDA = 0;

    IF (DTULTMACOMPRA = '30.12.1899') THEN
        DTULTMACOMPRA = NULL;

    IF (QTDEMBALAGEM > 0) THEN
      CAIXASSUGERIDA = SIMPLEROUNDTO(QTDSUGERIDA / QTDEMBALAGEM);

    DDE = 0;
    IF (COALESCE(MEDIAVENDAS,0) > 0) THEN
       DDE = (COALESCE(DISPONIVEL,0) + COALESCE(TRANSITO,0)) / MEDIAVENDAS;

    SELECT
      QUANTIDADE
    FROM
      ACD_TOTALIZACAO
    WHERE
      CODPRODFILHO = :CODPRODFILHO
      AND TIPO = 'E'

    INTO
      :PRAZOMEDIOENTREGA;

    INDICE_RUPTURA   = (MEDIAVENDAS * COALESCE(PRAZOMEDIOENTREGA,0));

    if ((EDDEMENORQUE > 0) or (EDDEMARIOQUE > 0)) then
    begin
      if (((EDDEMENORQUE > 0) and (DDE < EDDEMENORQUE)) and ((EDDEMARIOQUE > 0) and (DDE > EDDEMARIOQUE))) then
      begin
        suspend;
      end
      else if ((EDDEMENORQUE > 0) and (DDE < EDDEMENORQUE)) then
      begin
        suspend;
      end
      else if ((EDDEMARIOQUE > 0) and (DDE > EDDEMARIOQUE)) then
      begin
        suspend;
      end
    END
    else
      SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MAJUSTAMASCARACENTCUSTO(
    ECODLIVRE VARCHAR(60))
RETURNS (
    CODLIVRE VARCHAR(60))
AS
declare variable LX integer;
begin
  LX = 1;
  while (CHAR_LENGTH(ECODLIVRE) >= LX) do
  begin
    CODLIVRE = coalesce(CODLIVRE, '') || substring(ECODLIVRE from LX for 1);
    LX = LX + 1;
    if (substring(ECODLIVRE from LX for 1) = '') then
      LX = CHAR_LENGTH(ECODLIVRE) + 1;
  end
  if (substring(CODLIVRE from CHAR_LENGTH(CODLIVRE) for 1) = '.') then
    CODLIVRE = substring(CODLIVRE from 1 for CHAR_LENGTH(CODLIVRE) - 1);

  CODLIVRE = TRIM(CODLIVRE);
  CODLIVRE = TRIM(CODLIVRE);

  suspend;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MRETORNACENTCUSTOACIMA(
    ECODLIVRE VARCHAR(60))
RETURNS (
    CODLIVRESEMMASK VARCHAR(60),
    CODCENTCUSTO INTEGER,
    DESCRICAO VARCHAR(60),
    CODLIVRE VARCHAR(60))
AS
declare variable LX integer;
declare variable LCONTA varchar(60);
declare variable LENCONTROU smallint;
begin
  select
    M.CODLIVRE
  from
    MAJUSTAMASCARACENTCUSTO(:ECODLIVRE) M
  into
    CODLIVRESEMMASK;

  LCONTA = CODLIVRESEMMASK;
  CODLIVRESEMMASK = null;
  LX = CHAR_LENGTH(LCONTA);
  LENCONTROU = 0;
  while (LX > 0) do
  begin
    if ((LENCONTROU = 0) and (substring(LCONTA from LX for 1) = '.')) then
      LENCONTROU = 1;
    if ((LENCONTROU = 1) and (substring(LCONTA from LX for 1) <> '.')) then
      CODLIVRESEMMASK = substring(LCONTA from LX for 1) || coalesce(CODLIVRESEMMASK, '');
    LX = LX - 1;
  end

  CODLIVRESEMMASK = TRIM(CODLIVRESEMMASK);
  CODLIVRESEMMASK = TRIM(CODLIVRESEMMASK);

  if (CODLIVRESEMMASK is not null) then
  begin
    select
      C.CODCENTCUSTO,
      C.DESCRICAO,
      C.CODLIVRE
    from
      CENTCUSTO C
    where
      C.CODLIVRESEMMASK = :CODLIVRESEMMASK
    into
      CODCENTCUSTO,
      DESCRICAO,
      CODLIVRE;

    if (CODCENTCUSTO is not null) then
    begin
      select
        M.CODLIVRE
      from
        MAJUSTAMASCARACENTCUSTO(:CODLIVRE) M
      into
        CODLIVRE;
    end
  end
  CODLIVRESEMMASK = nullif(CODLIVRESEMMASK, '');
  suspend;
end^

SET TERM ; ^

-- RTRIM

SET TERM ^ ;

ALTER PROCEDURE GETIDEMPRESA(
    ECODEMPRESA INTEGER,
    EGERADOR VARCHAR(100),
    EID INTEGER,
    ENAOVERICARID CHAR(1))
RETURNS (
    IDENTIFICADOR INTEGER)
AS
declare variable LSQL varchar(1000);
declare variable LQTDDIGITOS integer;
declare variable LDIGITOSREPETIDOS varchar(255);
begin

  select
      VALOR
    from
      MLERPARAMETROINTEIRO('QUANTIDADE DE DIGITOS PARA DISTRIBUIÇÃO DE ID',2)
    into
      LQTDDIGITOS;
  
    if (LQTDDIGITOS < 2) then
      LQTDDIGITOS = 2;
  
    select 
      R_REPLICATE
    from
      FU_REPLICATE(:LQTDDIGITOS,'0')
    into
      LDIGITOSREPETIDOS;
  
    if (coalesce(nullif(TRIM(ENAOVERICARID), ''), 'N') = 'N') then
    begin
      if (IDENTIFICADOR is null) then
      begin
        if (EID is null) then
        begin
          LSQL = 'SELECT CAST(GEN_ID(' || EGERADOR || ', 1) AS INTEGER) FROM RDB$DATABASE';
          execute statement
            LSQL
          into
            IDENTIFICADOR;
  
          IDENTIFICADOR = cast(IDENTIFICADOR||RIGHT(LDIGITOSREPETIDOS||ECODEMPRESA,LQTDDIGITOS) as integer);
        end
        else
          IDENTIFICADOR = EID;
      end
    end
    else
      IDENTIFICADOR = EID;
  suspend;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE IMP_EVENTOS_ROSE(
    ECODEVENTOS_OS INTEGER)
RETURNS (
    CODEVENTOS_OS INTEGER,
    CODEVENTOS INTEGER,
    DESCRICAO VARCHAR(60),
    CODVENDEDOR INTEGER,
    NOME VARCHAR(60),
    CODMODELO_CARDAPIO INTEGER,
    MC_DESCRICAO VARCHAR(60),
    STATUS VARCHAR(15),
    NR_PESSOA INTEGER,
    NR_PESSOA_EXTENSO VARCHAR(250),
    DATA DATE,
    DATA_EXTENSO VARCHAR(60),
    DATAATUAL_EXTENSO VARCHAR(60),
    DATASALDO VARCHAR(60),
    HORA TIME,
    NR_CRIANADOLES INTEGER,
    NR_CRIANADOLES_EXTENSO VARCHAR(250),
    NR_PESSOASADIC INTEGER,
    DESCRICAO_LOCALNOVO VARCHAR(60),
    PERCDESC_CASA DECIMAL(18,2),
    VLRDESC_CASA DECIMAL(18,2),
    PERCDESC_TAXASERVICO DECIMAL(18,2),
    VLRDESC_TAXASERVICO DECIMAL(18,2),
    DATAFINAL DATE,
    HORAFINAL TIME,
    VALIDADE DATE,
    LOCAL VARCHAR(1),
    DESCRICAO_LOCAL VARCHAR(60),
    DESCEVENTO VARCHAR(80),
    NOME1 VARCHAR(60),
    TIPOPESSOA SMALLINT,
    CPFCGC VARCHAR(18),
    EMAIL VARCHAR(60),
    TELEFONE VARCHAR(60),
    TOTALCARDAPIO NUMERIC(18,2),
    TOTALCARDAPIO_EXTENSO VARCHAR(126),
    TAXACARDAPIO NUMERIC(18,2),
    TAXACARDAPIO_EXTENSO VARCHAR(126),
    TOTALDOCES NUMERIC(18,2),
    TAXADOCES NUMERIC(18,2),
    TOTALBARMAN NUMERIC(18,2),
    TAXABARMAN NUMERIC(18,2),
    TXCASA NUMERIC(18,2),
    TXCASA_EXTENSO VARCHAR(126),
    TXCASACDESC NUMERIC(18,2),
    TXCASACDESC_EXTENSO VARCHAR(126),
    TAXA_TRANSPORT NUMERIC(18,2),
    TAXA_TRANSPORT_EXTENSO VARCHAR(126),
    VALORDESC NUMERIC(18,2),
    VALORACRES NUMERIC(18,2),
    PERCDESCONTO NUMERIC(18,2),
    PERCACRESC NUMERIC(18,2),
    TOTALPARCIAL NUMERIC(18,2),
    TOTALPARCIAL_EXTENSO VARCHAR(126),
    TOTALGERAL NUMERIC(18,2),
    TOTALGERAL_EXTENSO VARCHAR(126),
    ENTRADA NUMERIC(18,4),
    ENTRADA_EXTENSO VARCHAR(126),
    DT_CADAST TIMESTAMP,
    TAXAS_EXTENSO VARCHAR(126),
    TOTALPORPESSOA NUMERIC(18,2),
    TOTALPORPESSOA_EXTENSO VARCHAR(126),
    NR_TOTALPESSOAS BIGINT,
    NR_TOTALPESSOAS_EXTENSO VARCHAR(250),
    VALOR_MODELO NUMERIC(18,2),
    VLRDESC_CARDAPIO DECIMAL(18,5),
    PERCDESC_CARDAPIO DECIMAL(18,5),
    VLRACRES_CARDAPIO DECIMAL(18,5),
    PERCACRESC_CARDAPIO DECIMAL(18,5),
    VALORCARDAPIODESC NUMERIC(18,5),
    VALORCARDAPIODESC_EXTENSO VARCHAR(126),
    TOTALCARDAPIOCDESC NUMERIC(18,5),
    TOTALCARDAPIODESC_EXTENSO VARCHAR(126),
    OBSSERVICOSADICIONAIS VARCHAR(2000),
    OBSSERVICOSADICIONAIS1 VARCHAR(2000),
    OBSSERVICOSADICIONAIS2 VARCHAR(2000),
    DATAFINAL_EXTENSO VARCHAR(60),
    VALORSUSHI NUMERIC(18,2),
    QTDEGARCONS BIGINT,
    GARCONS_EXTENSO VARCHAR(250),
    TAXA_DE_SERVICO NUMERIC(18,3),
    TAXA_DE_SERVICO_EXTENSO VARCHAR(250),
    TAXA_DA_CASA_EXTENSO VARCHAR(250),
    PRATOS_SERVIDOS VARCHAR(500))
AS
BEGIN
  PRATOS_SERVIDOS = '';
  FOR
    SELECT
      EVENTOS_OS.CODEVENTOS_OS,
      EVENTOS_OS.CODEVENTOS,
      EVENTOS.DESCRICAO,
      EVENTOS_OS.CODVENDEDOR,
      VENDEDOR.NOME,
      MODELO_CARDAPIO.CODMODELO_CARDAPIO,
      MODELO_CARDAPIO.MC_DESCRICAO,
      EVENTOS_OS.STATUS,
      EVENTOS_OS.NR_PESSOA,
      (SELECT VALOREXTENSO FROM FU_EXTENSOII(EVENTOS_OS.NR_PESSOA,NULL)) AS NR_PESSOA_EXTENSO,
      EVENTOS_OS.DATA,
      (SELECT DATAEXTENSO FROM FU_RETORNADATAEXTENSO(EVENTOS_OS.DATA) )DATA_EXTENSO,
      (SELECT DATAEXTENSO FROM FU_RETORNADATAEXTENSO(CURRENT_DATE))DATAATUAL_EXTENSO,
      (SELECT DATAEXTENSO FROM FU_RETORNADATAEXTENSO((EVENTOS_OS.DATA - 10)) )DATASALDO,
      EVENTOS_OS.HORA,
      EVENTOS_OS.NR_CRIANADOLES,
      (SELECT VALOREXTENSO FROM FU_EXTENSOII(EVENTOS_OS.NR_CRIANADOLES,NULL)) AS NR_CRIANADOLES_EXTENSO,
      EVENTOS_OS.NR_PESSOASADIC,
      EVENTOS_OS.DESCRICAO_LOCALNOVO,
      EVENTOS_OS.PERCDESC_CASA,
      EVENTOS_OS.VLRDESC_CASA,
      EVENTOS_OS.PERCDESC_TAXASERVICO,
      EVENTOS_OS.VLRDESC_TAXASERVICO,
      EVENTOS_OS.DATAFINAL,
      EVENTOS_OS.HORAFINAL,
      EVENTOS_OS.VALIDADE,
      EVENTOS_OS.LOCAL,
      EVENTOS_OS.DESCRICAO_LOCAL,
      EVENTOS_OS.DESCEVENTO,
      EVENTOS_OS.NOME,
      EVENTOS_OS.TIPOPESSOA,
      PESSOA.CPFCGC,
      EVENTOS_OS.EMAIL,
      EVENTOS_OS.TELEFONE,
      EVENTOS_OS.TOTALCARDAPIO,
      (SELECT R_EXT1 FROM FU_EXTENSO(EVENTOS_OS.TOTALCARDAPIO,126,126)) AS TOTALCARDAPIO_EXTENSO,
      EVENTOS_OS.TAXACARDAPIO,
      (SELECT R_EXT1 FROM FU_EXTENSO(EVENTOS_OS.TAXACARDAPIO,126,126)) AS TAXACARDAPIO_EXTENSO,
      EVENTOS_OS.TOTALDOCES,
      EVENTOS_OS.TAXADOCES,
      EVENTOS_OS.TOTALBARMAN,
      EVENTOS_OS.TAXABARMAN,
      EVENTOS_OS.TXCASA,
      (SELECT R_EXT1 FROM FU_EXTENSO(EVENTOS_OS.TXCASA,126,126)) AS TXCASA_EXTENSO,
      (EVENTOS_OS.TXCASA - EVENTOS_OS.VLRDESC_CASA) AS TXCASACDESC,
      (SELECT R_EXT1 FROM FU_EXTENSO(EVENTOS_OS.TXCASA - EVENTOS_OS.VLRDESC_CASA,126,126)) AS TXCASACDESC_EXTENSO,
      EVENTOS_OS.TAXA_TRANSPORT,
      (SELECT R_EXT1 FROM FU_EXTENSO(EVENTOS_OS.TAXA_TRANSPORT,126,126)) AS TAXA_TRANSPORT_EXTENSO,
      EVENTOS_OS.VALORDESC,
      EVENTOS_OS.VALORACRES,
      EVENTOS_OS.PERCDESCONTO,
      EVENTOS_OS.PERCACRESC,
      EVENTOS_OS.TOTALPARCIAL,
      (SELECT R_EXT1 FROM FU_EXTENSO(EVENTOS_OS.TOTALPARCIAL,126,126)) AS TOTALPARCIAL_EXTENSO,
      EVENTOS_OS.TOTALGERAL,
      (SELECT R_EXT1 FROM FU_EXTENSO(EVENTOS_OS.TOTALGERAL,126,126)) AS TOTALGERAL_EXTENSO,
      (EVENTOS_OS.TOTALGERAL * 0.10)ENTRADA,
      (SELECT R_EXT1 FROM FU_EXTENSO((EVENTOS_OS.TOTALGERAL * 0.10),126,126)) AS ENTRADA_EXTENSO,
      EVENTOS_OS.DT_CADAST,
      (SELECT R_EXT1 FROM FU_EXTENSO((EVENTOS_OS.TAXACARDAPIO + EVENTOS_OS.TAXADOCES + EVENTOS_OS.TAXABARMAN),126,126)) AS TAXAS_EXTENSO,
      (EVENTOS_OS.TOTALCARDAPIO/(EVENTOS_OS.NR_PESSOA + EVENTOS_OS.NR_CRIANADOLES)) TOTALPORPESSOA,
      (SELECT R_EXT1 FROM FU_EXTENSO((EVENTOS_OS.TOTALCARDAPIO / (EVENTOS_OS.NR_PESSOA + EVENTOS_OS.NR_CRIANADOLES)),126,126)) AS TOTALPORPESSOA_EXTENSO,
      (EVENTOS_OS.NR_PESSOA + EVENTOS_OS.NR_CRIANADOLES) NR_TOTALPESSOAS,
      (SELECT VALOREXTENSO FROM FU_EXTENSOII(EVENTOS_OS.NR_PESSOA + EVENTOS_OS.NR_CRIANADOLES,NULL)) AS NR_TOTALPESSOAS_EXTENSO,
      MODELO_CARDAPIO.VALOR_MODELO,
      EVENTOS_MODELO.VLRDESC_CARDAPIO,
      EVENTOS_MODELO.PERCDESC_CARDAPIO,
      EVENTOS_MODELO.VLRACRES_CARDAPIO,
      EVENTOS_MODELO.PERCACRESC_CARDAPIO,
      (EVENTOS_OS.TOTALCARDAPIO - EVENTOS_MODELO.VLRDESC_CARDAPIO) / (EVENTOS_OS.NR_PESSOA + EVENTOS_OS.NR_CRIANADOLES)VALORCARDAPIODESC,
      (SELECT R_EXT1 FROM FU_EXTENSO(((EVENTOS_OS.TOTALCARDAPIO - EVENTOS_MODELO.VLRDESC_CARDAPIO) / (EVENTOS_OS.NR_PESSOA + EVENTOS_OS.NR_CRIANADOLES)),126,126)) AS VALORCARDAPIODESC_EXTENSO,
      (EVENTOS_OS.TOTALCARDAPIO - EVENTOS_MODELO.VLRDESC_CARDAPIO)TOTALCARDAPIOCDESC,
      (SELECT R_EXT1 FROM FU_EXTENSO((EVENTOS_OS.TOTALCARDAPIO - EVENTOS_MODELO.VLRDESC_CARDAPIO),126,126)) AS TOTALCARDAPIODESC_EXTENSO,
      cast(substring(EVENTOS_OS.OBSSERVICOSADICIONAIS from 1 for 2000) as varchar(2000)) OBSSERVICOSADICIONAIS,
      cast(substring(EVENTOS_OS.OBSSERVICOSADICIONAIS1 from 1 for 2000) as varchar(2000)) OBSSERVICOSADICIONAIS1,
      cast(substring(EVENTOS_OS.OBSSERVICOSADICIONAIS2 from 1 for 2000) as varchar(2000)) OBSSERVICOSADICIONAIS2,
      (SELECT DATAEXTENSO FROM FU_RETORNADATAEXTENSO((EVENTOS_OS.DATA - 15)))DATAFINAL_EXTENSO,
      (SELECT SUM(ESA.VALORTOTAL) FROM EVENTOS_SERVTAXAS_AUX ESA JOIN EVENTOS_SERVTAXAS ES ON ES.CODSERVTAXA = ESA.CODSERVTAXAS
      WHERE ESA.CODEVENTOS_OS = EVENTOS_OS.CODEVENTOS_OS AND ESA.DESCRICAO CONTAINING 'SUSHI')VALORSUSHI,
      (EVENTOS_OS.NR_PESSOA /(SELECT FIRST 1 PROPORCAO FROM EVENTOS_FUNCOES WHERE EVENTOS_FUNCOES.FUNCAO CONTAINING 'GARÇ'))QTDEGARCONS,
      (SELECT VALOREXTENSO FROM FU_EXTENSOII(EVENTOS_OS.NR_PESSOA /(SELECT FIRST 1 PROPORCAO FROM EVENTOS_FUNCOES WHERE EVENTOS_FUNCOES.FUNCAO CONTAINING 'GARÇ'),NULL)) AS GARCONS_EXTENSO,
      EVENTOS_OS.TOTALCARDAPIO * 0.1 TAXA_DE_SERVICO,
      (SELECT R_EXT1 FROM FU_EXTENSO((EVENTOS_OS.TOTALCARDAPIO * 0.1),126,126)) AS TAXA_DE_SERVICO_EXTENSO,
      (SELECT R_EXT1 FROM FU_EXTENSO((EVENTOS_OS.TXCASA),126,126)) AS TAXA_DA_CASA_EXTENSO
    FROM
      EVENTOS_OS
      INNER JOIN EVENTOS ON EVENTOS.CODEVENTOS = EVENTOS_OS.CODEVENTOS
      INNER JOIN VENDEDOR  ON VENDEDOR.CODVENDEDOR = EVENTOS_OS.CODVENDEDOR
      INNER JOIN EVENTOS_MODELO ON EVENTOS_MODELO.CODEVENTOS_OS = EVENTOS_OS.CODEVENTOS_OS
      INNER JOIN MODELO_CARDAPIO  ON MODELO_CARDAPIO.CODMODELO_CARDAPIO = EVENTOS_MODELO.CODMODELO_CARDAPIO
      INNER JOIN PESSOA ON PESSOA.CODPESSOA = EVENTOS_OS.CODPESSOA
    WHERE
      EVENTOS_OS.CODEVENTOS_OS =:ECODEVENTOS_OS
    INTO :CODEVENTOS_OS,
         :CODEVENTOS,
         :DESCRICAO,
         :CODVENDEDOR,
         :NOME,
         :CODMODELO_CARDAPIO,
         :MC_DESCRICAO,
         :STATUS,
         :NR_PESSOA,
         :NR_PESSOA_EXTENSO,
         :DATA,
         :DATA_EXTENSO,
         :DATAATUAL_EXTENSO,
         :DATASALDO,
         :HORA,
         :NR_CRIANADOLES,
         :NR_CRIANADOLES_EXTENSO,
         :NR_PESSOASADIC,
         :DESCRICAO_LOCALNOVO,
         :PERCDESC_CASA,
         :VLRDESC_CASA,
         :PERCDESC_TAXASERVICO,
         :VLRDESC_TAXASERVICO,
         :DATAFINAL,
         :HORAFINAL,
         :VALIDADE,
         :LOCAL,
         :DESCRICAO_LOCAL,
         :DESCEVENTO,
         :NOME1,
         :TIPOPESSOA,
         :CPFCGC,
         :EMAIL,
         :TELEFONE,
         :TOTALCARDAPIO,
         :TOTALCARDAPIO_EXTENSO,
         :TAXACARDAPIO,
         :TAXACARDAPIO_EXTENSO,
         :TOTALDOCES,
         :TAXADOCES,
         :TOTALBARMAN,
         :TAXABARMAN,
         :TXCASA,
         :TXCASA_EXTENSO,
         :TXCASACDESC,
         :TXCASACDESC_EXTENSO,
         :TAXA_TRANSPORT,
         :TAXA_TRANSPORT_EXTENSO,
         :VALORDESC,
         :VALORACRES,
         :PERCDESCONTO,
         :PERCACRESC,
         :TOTALPARCIAL,
         :TOTALPARCIAL_EXTENSO,
         :TOTALGERAL,
         :TOTALGERAL_EXTENSO,
         :ENTRADA,
         :ENTRADA_EXTENSO,
         :DT_CADAST,
         :TAXAS_EXTENSO,
         :TOTALPORPESSOA,
         :TOTALPORPESSOA_EXTENSO,
         :NR_TOTALPESSOAS,
         :NR_TOTALPESSOAS_EXTENSO,
         :VALOR_MODELO,
         :VLRDESC_CARDAPIO,
         :PERCDESC_CARDAPIO,
         :VLRACRES_CARDAPIO,
         :PERCACRESC_CARDAPIO,
         :VALORCARDAPIODESC,
         :VALORCARDAPIODESC_EXTENSO,
         :TOTALCARDAPIOCDESC,
         :TOTALCARDAPIODESC_EXTENSO,
         :OBSSERVICOSADICIONAIS,
         :OBSSERVICOSADICIONAIS1,
         :OBSSERVICOSADICIONAIS2,
         :DATAFINAL_EXTENSO,
         :VALORSUSHI,
         :QTDEGARCONS,
         :GARCONS_EXTENSO,
         :TAXA_DE_SERVICO,
         :TAXA_DE_SERVICO_EXTENSO,
         :TAXA_DA_CASA_EXTENSO
  DO
  BEGIN
    TOTALPORPESSOA_EXTENSO = '(' || trim(TOTALPORPESSOA_EXTENSO) || ')';
    TOTALCARDAPIO_EXTENSO = '(' || trim(TOTALCARDAPIO_EXTENSO) || ')';
    TAXA_DE_SERVICO_EXTENSO = '(' || trim(TAXA_DE_SERVICO_EXTENSO) || ')';
    TAXA_DA_CASA_EXTENSO = '(' || trim(TAXA_DA_CASA_EXTENSO) || ')';
    TOTALGERAL_EXTENSO = '(' || trim(TOTALGERAL_EXTENSO) || ')';
    PRATOS_SERVIDOS = PRATOS_SERVIDOS || MC_DESCRICAO || ' / ';
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MATUALIZACONTAIMPRIMIRBOLETO(
    CODBANCO INTEGER,
    DTINI DATE,
    DTFIM DATE,
    ENVIADOS INTEGER)
AS
declare variable LFILTRARPELOBANCO smallint;
declare variable LCODBANCO integer;
declare variable LSQL varchar(3000);
declare variable LSALDORESTANTE double precision;
declare variable LTOTDESCONTO double precision;
declare variable LTOTJUROS double precision;
declare variable LCHEQUEABERTO double precision;
declare variable LTOTPAGO double precision;
declare variable LSTATUS varchar(10);
declare variable LCODCONTA integer;
declare variable LFINANCEIROABERTO smallint;
begin
  select
    VALOR
  from
    MLERPARAMETROLOGICO('QUITAR O FINANCEIRO PARA CHEQUES EM ABERTO',0)
  into
    :LFINANCEIROABERTO;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('FILTRAR PELO BANCO',0)
  into
    LFILTRARPELOBANCO;

  LSQL = '';
  LSQL = LSQL||'  select ';
  LSQL = LSQL||'    distinct R.CODCONTA ';
  LSQL = LSQL||'  from ';
  LSQL = LSQL||'    CONTA R ';
  LSQL = LSQL||'  where ';
  LSQL = LSQL||'    R.PREV_TIPOPAG = ''BOLETO BANCÁRIO'' and ';
  if (LFILTRARPELOBANCO <> 0) then
  begin
     select
       coalesce(CODBANCO,0)
     from
       BANCO
     where
       CODBANCO =  TRIM(:CODBANCO)
     into
       LCODBANCO;

     if  (LCODBANCO <> 0) then
       LSQL = LSQL||' R.CODBANCO = '||LCODBANCO||' and ';
  end

  LSQL = LSQL||'  R.STATUS = ''ABERTO'' and ';
  LSQL = LSQL||'  R.TIPO = ''RECEBER'' and ';
  LSQL = LSQL||'  cast(R.DT_EMISSAO as date) between '''||extract(day from :DTINI)||'.'||extract(month from :DTINI)||'.'||extract(year from :DTINI);
  LSQL = LSQL||''' and '''||extract(day from :DTFIM)||'.'||extract(month from :DTFIM)||'.'||extract(year from :DTFIM)||'''';
  if (ENVIADOS = 0) then
    LSQL = LSQL||'  and (coalesce(R.BOLETOIMPRESSO, ''N'') = ''N'') ';
  else if (ENVIADOS = 1) then
    LSQL = LSQL||'  and (coalesce(R.BOLETOIMPRESSO, ''N'') = ''S'') and R.CODBANCO = '||TRIM(CODBANCO);
  else if (ENVIADOS = 2) then
    LSQL = LSQL||'  and (coalesce(R.BOLETOIMPRESSO, ''N'') = ''E'') and R.CODBANCO = '||TRIM(CODBANCO);
  else if (ENVIADOS = 3) then
    LSQL = LSQL||'  and R.CODBANCO = '||TRIM(CODBANCO);
  --suspend;
  for execute statement
    LSQL
  into
    :LCODCONTA
  do
  begin
    select
      SALDORESTANTE,
      TOTDESCONTO,
      TOTJUROS,
      CHEQUEABERTO,
      TOTPAGO
    from
      MCONTASALDORESTANTE(:LCODCONTA)
    into
      LSALDORESTANTE,
      LTOTDESCONTO,
      LTOTJUROS,
      LCHEQUEABERTO,
      LTOTPAGO;
    
    LSTATUS = 'ABERTO';
    
    if (LSALDORESTANTE > 0) then
      LSTATUS = 'ABERTO';
    else
    begin
      if (LFINANCEIROABERTO <> 0) then
      begin
        if (cast(LSALDORESTANTE as numeric(18,2)) <= 0) then
          LSTATUS = 'QUITADO';
      end
      else
      begin
        if (LCHEQUEABERTO = 0) then
          LSTATUS = 'QUITADO';
      end
    end
    
  /* update
      CONTA
    set
      TOTDESCONTO = :LTOTDESCONTO,
      TOTJUROS = :LTOTJUROS,
      TOTPAGO = :LTOTPAGO,
      RESTA = :LSALDORESTANTE,
      STATUS = :LSTATUS
    where
      CODCONTA = :LCODCONTA;  */
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MATUALIZACONTAIMPRIMIRBOLETOEMP(
    CODBANCO INTEGER,
    DTINI DATE,
    DTFIM DATE,
    ENVIADOS INTEGER,
    CODEMPRESA INTEGER)
AS
declare variable LFILTRARPELOBANCO smallint;
declare variable LCODBANCO integer;
declare variable LSQL varchar(3000);
declare variable LSALDORESTANTE double precision;
declare variable LTOTDESCONTO double precision;
declare variable LTOTJUROS double precision;
declare variable LCHEQUEABERTO double precision;
declare variable LTOTPAGO double precision;
declare variable LSTATUS varchar(10);
declare variable LCODCONTA integer;
declare variable LFINANCEIROABERTO smallint;
begin
  select
    VALOR
  from
    MLERPARAMETROLOGICO('QUITAR O FINANCEIRO PARA CHEQUES EM ABERTO',0)
  into
    :LFINANCEIROABERTO;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('FILTRAR PELO BANCO',0)
  into
    LFILTRARPELOBANCO;

  LSQL = '';
  LSQL = LSQL||'  select ';
  LSQL = LSQL||'    distinct R.CODCONTA ';
  LSQL = LSQL||'  from ';
  LSQL = LSQL||'    CONTA R ';
  LSQL = LSQL||'  where ';
  LSQL = LSQL||'    R.PREV_TIPOPAG = ''BOLETO BANCÁRIO'' and ';
  if (LFILTRARPELOBANCO <> 0) then
  begin
     select
       coalesce(CODBANCO,0)
     from
       BANCO
     where
       CODBANCO =  TRIM(:CODBANCO) and BANCO.CODEMPRESA =:CODEMPRESA
     into
       LCODBANCO;

     if  (LCODBANCO <> 0) then
       LSQL = LSQL||' R.CODBANCO = '||LCODBANCO||' and ';
  end

  LSQL = LSQL||'  R.STATUS = ''ABERTO'' and ';
  LSQL = LSQL||'  R.TIPO = ''RECEBER'' and ';
  LSQL = LSQL||'  cast(R.DT_EMISSAO as date) between '''||extract(day from :DTINI)||'.'||extract(month from :DTINI)||'.'||extract(year from :DTINI);
  LSQL = LSQL||''' and '''||extract(day from :DTFIM)||'.'||extract(month from :DTFIM)||'.'||extract(year from :DTFIM)||'''';
  if (ENVIADOS = 0) then
    LSQL = LSQL||'  and (coalesce(R.BOLETOIMPRESSO, ''N'') = ''N'') ';
  else if (ENVIADOS = 1) then
    LSQL = LSQL||'  and (coalesce(R.BOLETOIMPRESSO, ''N'') = ''S'') and R.CODBANCO = '||TRIM(CODBANCO);
  else if (ENVIADOS = 2) then
    LSQL = LSQL||'  and (coalesce(R.BOLETOIMPRESSO, ''N'') = ''E'') and R.CODBANCO = '||TRIM(CODBANCO);
  else if (ENVIADOS = 3) then
    LSQL = LSQL||'  and R.CODBANCO = '||TRIM(CODBANCO);
  --suspend;
  for execute statement
    LSQL
  into
    :LCODCONTA
  do
  begin
    select
      SALDORESTANTE,
      TOTDESCONTO,
      TOTJUROS,
      CHEQUEABERTO,
      TOTPAGO
    from
      MCONTASALDORESTANTE(:LCODCONTA)
    into
      LSALDORESTANTE,
      LTOTDESCONTO,
      LTOTJUROS,
      LCHEQUEABERTO,
      LTOTPAGO;
    
    LSTATUS = 'ABERTO';
    
    if (LSALDORESTANTE > 0) then
      LSTATUS = 'ABERTO';
    else
    begin
      if (LFINANCEIROABERTO <> 0) then
      begin
        if (cast(LSALDORESTANTE as numeric(18,2)) <= 0) then
          LSTATUS = 'QUITADO';
      end
      else
      begin
        if (LCHEQUEABERTO = 0) then
          LSTATUS = 'QUITADO';
      end
    end
    
    update 
      CONTA
    set
      TOTDESCONTO = :LTOTDESCONTO,
      TOTJUROS = :LTOTJUROS,
      TOTPAGO = :LTOTPAGO,
      RESTA = :LSALDORESTANTE,
      STATUS = :LSTATUS
    where
      CODCONTA = :LCODCONTA;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MATUALIZADATANET(
    EDATANET TIMESTAMP,
    EATUALIZADATANET CHAR(1),
    ECODEMPRESA INTEGER,
    EATUALIZACODEMPRESANET CHAR(1))
RETURNS (
    DATANET TIMESTAMP,
    ATUALIZADATANET CHAR(1),
    CODEMPRESA INTEGER,
    ATUALIZACODEMPRESANET CHAR(1))
AS
begin
  if (coalesce(nullif(TRIM(EATUALIZADATANET), ''), 'S') = 'S') then
    DATANET = 'NOW';
  else
    DATANET = EDATANET;
  ATUALIZADATANET = 'S';

  if (coalesce(nullif(TRIM(EATUALIZACODEMPRESANET), ''), 'S') = 'S') then
  begin
    select first 1
      E.CODEMPRESA
    from
      EMPRESA E
      join SYSPARAMS S on E.CGC = S.CGC
    into
      CODEMPRESA;

    CODEMPRESA = coalesce(CODEMPRESA, ECODEMPRESA);
  end
  else
    CODEMPRESA = ECODEMPRESA;
  ATUALIZACODEMPRESANET = 'S';
  suspend;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MCAIXAOPFECHAMENTO(
    ECODCAIXAOP INTEGER)
RETURNS (
    CODCAIXAOP INTEGER,
    DATAABERTURA TIMESTAMP,
    DATAFECHAMENTO TIMESTAMP,
    IDLOGIN VARCHAR(45),
    TIPO VARCHAR(18),
    DOCUMENTO VARCHAR(30),
    CODPESSOA INTEGER,
    PESSOA VARCHAR(60),
    NFVENDA INTEGER,
    NRFORMULARIO VARCHAR(30),
    STATUSPED VARCHAR(10),
    VALORBRUTO DOUBLE PRECISION,
    ACREPERC DOUBLE PRECISION,
    ACREVAL DOUBLE PRECISION,
    DESCPERC DOUBLE PRECISION,
    DESCVAL DOUBLE PRECISION,
    VALORLIQ DOUBLE PRECISION)
AS
declare variable LCODPEDVEND integer;
declare variable LCODCONTA integer;
declare variable LNRDOCUMENTO varchar(30);
declare variable LPARCELA varchar(5);
declare variable LGERARNUMEROVENCIMENTOPARCELA smallint;
declare variable LEXIBIRRAZAOSOCIAL smallint;
declare variable LTEMINF smallint;
declare variable LTIPO varchar(10);
begin
  LTEMINF = 0;
  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR RAZÃO SOCIAL', 0)
  into
    LEXIBIRRAZAOSOCIAL;

  CODCAIXAOP = ECODCAIXAOP;
  select
    C.DATAABERTURA,
    C.DATAFECHAMENTO,
    U.IDLOGIN
  from
    CAIXAOP C
    join USERCAD U on

      C.CODUSERCAD = U.CODUSERCAD
  where
    C.CODCAIXAOP = :ECODCAIXAOP
  into
    DATAABERTURA,
    DATAFECHAMENTO,
    IDLOGIN;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('GERAR NÚMEROS DOS VENCIMENTOS COM AS PARCELAS', 0)
  into
    LGERARNUMEROVENCIMENTOPARCELA;

  for select
    C.CODPEDVEND,
    C.CODCONTA,
    C.VALORBRUTO,
    coalesce(C.ACREVAL, 0) * 100 / C.VALORBRUTO + coalesce(C.ACREPERC, 0),
    coalesce(C.ACREPERC, 0) * C.VALORBRUTO / 100 + coalesce(C.ACREVAL, 0),
    coalesce(C.DESCVAL, 0) * 100 / C.VALORBRUTO + coalesce(C.DESCPERC, 0),
    coalesce(C.DESCPERC, 0) * C.VALORBRUTO / 100 + coalesce(C.DESCVAL, 0),
    C.VALORLIQ
  from
    CAIXAOPPEDTIT C
    join CAIXAOPRECEBIMENTO CR on C.CODCAIXAOPRECEBIMENTO = CR.CODCAIXAOPRECEBIMENTO
  where
    CR.CODCAIXAOP = :ECODCAIXAOP
  order by
    C.CODPEDVEND,
    C.CODCONTA
  into
    LCODPEDVEND,
    LCODCONTA,
    VALORBRUTO,
    ACREPERC,
    ACREVAL,
    DESCPERC,
    DESCVAL,
    VALORLIQ
  do
  begin
    LTEMINF = 1;
    ACREPERC = nullif(ACREPERC, 0);
    ACREVAL  = nullif(ACREVAL, 0);
    DESCPERC = nullif(DESCPERC, 0);
    DESCVAL  = nullif(DESCVAL, 0);
    NFVENDA = null;
    NRFORMULARIO = null;
    STATUSPED = null;

    if (LCODCONTA is null) then
    begin
      TIPO      = 'PEDIDO';
      DOCUMENTO = LCODPEDVEND;
      select
        P.CODPESSOA,
        case 
          when (:LEXIBIRRAZAOSOCIAL <> 0) then
            TRIM(P.NOME)
        else
          coalesce(nullif(TRIM(P.NOMEFANTAZIA), ''), P.NOME)
        end,
        PV.CODNFVENDA,
        PV.NRFORMULARIO,
        case PV.STATUSPED
          when 'NORMAL' then 'PENDENCIA'
          when 'FATURADO' then 'FATURADO'
        else
          '-'
        end STATUSPED
      from
        PESSOA P
        join PEDVEND PV on
          P.CODPESSOA = PV.CODPESSOA
      where
        PV.CODPEDVEND = :LCODPEDVEND
      into
        CODPESSOA,
        PESSOA,
        NFVENDA,
        NRFORMULARIO,
        STATUSPED;
    end
    else
    begin
      TIPO = 'TÍTULO';
      select
        C.NRDOCUMENTO,
        C.PARCELA,
        P.CODPESSOA,
        case 
          when (:LEXIBIRRAZAOSOCIAL <> 0) then
            TRIM(P.NOME)
        else
          coalesce(nullif(TRIM(P.NOMEFANTAZIA), ''), P.NOME)
        end,
        C.TIPO
      from
        PESSOA P
        join CONTA C on
          P.CODPESSOA = C.CODPESSOA
      where
        C.CODCONTA = :LCODCONTA
      into
        LNRDOCUMENTO,
        LPARCELA,
        CODPESSOA,
        PESSOA,
        LTIPO;

      if (LGERARNUMEROVENCIMENTOPARCELA = 0) then
        DOCUMENTO = substring(LNRDOCUMENTO || '-' || LPARCELA from 1 for 30);
      else
        DOCUMENTO = LNRDOCUMENTO;
    end
    if ( coalesce(LTIPO, 'RECEBER') = 'RECEBER') then
      suspend;
  end


  for select
    C.CODCONTA,
    C.VALORBRUTO,
    coalesce(C.ACREVAL, 0),
    coalesce(C.DESCVAL, 0),
    C.VALORLIQ
  from
    CAIXAOPPAGAMENTO C
    join CAIXAOPRECEBIMENTO CR on
      C.CODCAIXAOPRECEBIMENTO = CR.CODCAIXAOPRECEBIMENTO
  where
    CR.CODCAIXAOP = :ECODCAIXAOP
  order by
    C.CODCONTA
  into
    LCODCONTA,
    VALORBRUTO,
    ACREVAL,
    DESCVAL,
    VALORLIQ
  do
  begin
    LTEMINF = 1;
    ACREPERC = nullif(ACREPERC, 0);
    ACREVAL  = nullif(ACREVAL, 0);
    DESCPERC = nullif(DESCPERC, 0);
    DESCVAL  = nullif(DESCVAL, 0);
    TIPO = 'PAGAMENTO';
    select
      C.NRDOCUMENTO,
      C.PARCELA,
      P.CODPESSOA,
      case 
        when (:LEXIBIRRAZAOSOCIAL <> 0) then
          TRIM(P.NOME)
      else
        coalesce(nullif(TRIM(P.NOMEFANTAZIA), ''), P.NOME)
      end
    from
      PESSOA P
      join CONTA C on
        P.CODPESSOA = C.CODPESSOA
    where
      C.CODCONTA = :LCODCONTA
    into
      LNRDOCUMENTO,
      LPARCELA,
      CODPESSOA,
      PESSOA;

    if (LGERARNUMEROVENCIMENTOPARCELA = 0) then
      DOCUMENTO = substring(LNRDOCUMENTO || '-' || LPARCELA from 1 for 30);
    else
      DOCUMENTO = LNRDOCUMENTO;
    suspend;
  end

  VALORBRUTO = null;
  CODPESSOA  = null;
  for select
    C.TIPOMOV,
    C.VALOR,
    C.TIPOMOV,
    C.OBS
  from
    CAIXAOPMOV C
  where
    C.CODCAIXAOP             = :ECODCAIXAOP and
    C.CODCAIXAOPRECEBIMENTO is null
  order by
    C.TIPOMOV,
    C.CODCAIXAOPMOV
  into
    TIPO,
    VALORLIQ,
    DOCUMENTO,
    PESSOA
  do
  begin
    LTEMINF = 1;
    suspend;
  end
  if (LTEMINF = 0) then
    suspend;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MCAIXAOPFECHAMENTO_CREDITO(
    ECODCAIXAOP INTEGER)
RETURNS (
    CODCAIXAOP INTEGER,
    DATAABERTURA TIMESTAMP,
    DATAFECHAMENTO TIMESTAMP,
    IDLOGIN VARCHAR(45),
    TIPO VARCHAR(18),
    DOCUMENTO VARCHAR(30),
    CODPESSOA INTEGER,
    PESSOA VARCHAR(60),
    NFVENDA INTEGER,
    NRFORMULARIO VARCHAR(30),
    STATUSPED VARCHAR(10),
    VALORBRUTO DOUBLE PRECISION,
    ACREPERC DOUBLE PRECISION,
    ACREVAL DOUBLE PRECISION,
    DESCPERC DOUBLE PRECISION,
    DESCVAL DOUBLE PRECISION,
    VALORLIQ DOUBLE PRECISION)
AS
declare variable LCODPEDVEND integer;
declare variable LCODCONTA integer;
declare variable LNRDOCUMENTO varchar(30);
declare variable LPARCELA varchar(5);
declare variable LGERARNUMEROVENCIMENTOPARCELA smallint;
declare variable LEXIBIRRAZAOSOCIAL smallint;
declare variable LTEMINF smallint;
begin
  LTEMINF = 0;
  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR RAZÃO SOCIAL', 0)
  into
    LEXIBIRRAZAOSOCIAL;

  CODCAIXAOP = ECODCAIXAOP;
  select
    C.DATAABERTURA,
    C.DATAFECHAMENTO,
    U.IDLOGIN
  from
    CAIXAOP C
    join USERCAD U on

      C.CODUSERCAD = U.CODUSERCAD
  where
    C.CODCAIXAOP = :ECODCAIXAOP
  into
    DATAABERTURA,
    DATAFECHAMENTO,
    IDLOGIN;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('GERAR NÚMEROS DOS VENCIMENTOS COM AS PARCELAS', 0)
  into
    LGERARNUMEROVENCIMENTOPARCELA;

  for select
    C.CODPEDVEND,
    C.CODCONTA,
    C.VALORBRUTO,
    coalesce(C.ACREVAL, 0) * 100 / C.VALORBRUTO + coalesce(C.ACREPERC, 0),
    coalesce(C.ACREPERC, 0) * C.VALORBRUTO / 100 + coalesce(C.ACREVAL, 0),
    coalesce(C.DESCVAL, 0) * 100 / C.VALORBRUTO + coalesce(C.DESCPERC, 0),
    coalesce(C.DESCPERC, 0) * C.VALORBRUTO / 100 + coalesce(C.DESCVAL, 0),
    C.VALORLIQ
  from
    CAIXAOPPEDTIT C
    join CAIXAOPRECEBIMENTO CR on C.CODCAIXAOPRECEBIMENTO = CR.CODCAIXAOPRECEBIMENTO
    inner join conta on
      conta.codconta = C.codconta
  where
    CR.CODCAIXAOP = :ECODCAIXAOP
    and
    conta.tipo = 'CXOPCRED'
  order by
    C.CODPEDVEND,
    C.CODCONTA
  into
    LCODPEDVEND,
    LCODCONTA,
    VALORBRUTO,
    ACREPERC,
    ACREVAL,
    DESCPERC,
    DESCVAL,
    VALORLIQ
  do
  begin
    LTEMINF = 1;
    ACREPERC = nullif(ACREPERC, 0);
    ACREVAL  = nullif(ACREVAL, 0);
    DESCPERC = nullif(DESCPERC, 0);
    DESCVAL  = nullif(DESCVAL, 0);
    NFVENDA = null;
    NRFORMULARIO = null;
    STATUSPED = null;

    begin
      TIPO = 'TÍTULO';
      select
        C.NRDOCUMENTO,
        C.PARCELA,
        P.CODPESSOA,
        case 
          when (:LEXIBIRRAZAOSOCIAL <> 0) then
            TRIM(P.NOME)
        else
          coalesce(nullif(TRIM(P.NOMEFANTAZIA), ''), P.NOME)
        end
      from
        PESSOA P
        join CONTA C on
          P.CODPESSOA = C.CODPESSOA
      where
        C.CODCONTA = :LCODCONTA
      into
        LNRDOCUMENTO,
        LPARCELA,
        CODPESSOA,
        PESSOA;

      if (LGERARNUMEROVENCIMENTOPARCELA = 0) then
        DOCUMENTO = substring(LNRDOCUMENTO || '-' || LPARCELA from 1 for 30);
      else
        DOCUMENTO = LNRDOCUMENTO;
    end
    suspend;
  end

  if (LTEMINF = 0) then
    suspend;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MCAIXAOPFECHAMENTOPER(
    ECODEMPRESA INTEGER,
    EDTINI DATE,
    EDTFIM DATE)
RETURNS (
    CODCAIXAOP INTEGER,
    DATAABERTURA TIMESTAMP,
    DATAFECHAMENTO TIMESTAMP,
    IDLOGIN VARCHAR(45),
    TIPO VARCHAR(18),
    DOCUMENTO VARCHAR(30),
    CODPESSOA INTEGER,
    PESSOA VARCHAR(60),
    NFVENDA INTEGER,
    NRFORMULARIO VARCHAR(30),
    STATUSPED VARCHAR(10),
    VALORBRUTO DOUBLE PRECISION,
    ACREPERC DOUBLE PRECISION,
    ACREVAL DOUBLE PRECISION,
    DESCPERC DOUBLE PRECISION,
    DESCVAL DOUBLE PRECISION,
    VALORLIQ DOUBLE PRECISION)
AS
declare variable LCODPEDVEND integer;
declare variable LCODCONTA integer;
declare variable LNRDOCUMENTO varchar(30);
declare variable LPARCELA varchar(5);
declare variable LGERARNUMEROVENCIMENTOPARCELA smallint;
declare variable LEXIBIRRAZAOSOCIAL smallint;
declare variable LTEMINF smallint;
begin
  LTEMINF = 0;
  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR RAZÃO SOCIAL', 0)
  into
    LEXIBIRRAZAOSOCIAL;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('GERAR NÚMEROS DOS VENCIMENTOS COM AS PARCELAS', 0)
  into
    LGERARNUMEROVENCIMENTOPARCELA;

  for select
    C.CODCAIXAOP,
    U.IDLOGIN,
    C.DATAABERTURA,
    C.DATAFECHAMENTO
  from
    CAIXAOP C
    join USERCAD U on
      C.CODUSERCAD = U.CODUSERCAD
  where
    U.CODEMPRESA = :ECODEMPRESA and
    C.DATAFECHAMENTO between :EDTINI and :EDTFIM
  into
    CODCAIXAOP,
    IDLOGIN,
    DATAABERTURA,
    DATAFECHAMENTO
  do
  begin
    for select
      C.CODPEDVEND,
      C.CODCONTA,
      C.VALORBRUTO,
      coalesce(C.ACREVAL, 0) * 100 / C.VALORBRUTO + coalesce(C.ACREPERC, 0),
      coalesce(C.ACREPERC, 0) * C.VALORBRUTO / 100 + coalesce(C.ACREVAL, 0),
      coalesce(C.DESCVAL, 0) * 100 / C.VALORBRUTO + coalesce(C.DESCPERC, 0),
      coalesce(C.DESCPERC, 0) * C.VALORBRUTO / 100 + coalesce(C.DESCVAL, 0),
      C.VALORLIQ
    from
      CAIXAOPPEDTIT C
      join CAIXAOPRECEBIMENTO CR on C.CODCAIXAOPRECEBIMENTO = CR.CODCAIXAOPRECEBIMENTO
    where
      CR.CODCAIXAOP = :CODCAIXAOP
    order by
      C.CODPEDVEND,
      C.CODCONTA
    into
      LCODPEDVEND,
      LCODCONTA,
      VALORBRUTO,
      ACREPERC,
      ACREVAL,
      DESCPERC,
      DESCVAL,
      VALORLIQ
    do
    begin
      LTEMINF = 1;
      ACREPERC = nullif(ACREPERC, 0);
      ACREVAL  = nullif(ACREVAL, 0);
      DESCPERC = nullif(DESCPERC, 0);
      DESCVAL  = nullif(DESCVAL, 0);
      NFVENDA = null;
      NRFORMULARIO = null;
      STATUSPED = null;
  
      if (LCODCONTA is null) then
      begin
        TIPO      = 'PEDIDO';
        DOCUMENTO = LCODPEDVEND;
        select
          P.CODPESSOA,
          case 
            when (:LEXIBIRRAZAOSOCIAL <> 0) then
              TRIM(P.NOME)
          else
            coalesce(nullif(TRIM(P.NOMEFANTAZIA), ''), P.NOME)
          end,
          PV.CODNFVENDA,
          PV.NRFORMULARIO,
          case PV.STATUSPED
            when 'NORMAL' then 'PENDENCIA'
            when 'FATURADO' then 'FATURADO'
          else
            '-'
          end STATUSPED
        from
          PESSOA P
          join PEDVEND PV on
            P.CODPESSOA = PV.CODPESSOA
        where
          PV.CODPEDVEND = :LCODPEDVEND
        into
          CODPESSOA,
          PESSOA,
          NFVENDA,
          NRFORMULARIO,
          STATUSPED;
      end
      else
      begin
        TIPO = 'TÍTULO';
        select
          C.NRDOCUMENTO,
          C.PARCELA,
          P.CODPESSOA,
          case 
            when (:LEXIBIRRAZAOSOCIAL <> 0) then
              TRIM(P.NOME)
          else
            coalesce(nullif(TRIM(P.NOMEFANTAZIA), ''), P.NOME)
          end
        from
          PESSOA P
          join CONTA C on
            P.CODPESSOA = C.CODPESSOA
        where
          C.CODCONTA = :LCODCONTA
        into
          LNRDOCUMENTO,
          LPARCELA,
          CODPESSOA,
          PESSOA;
  
        if (LGERARNUMEROVENCIMENTOPARCELA = 0) then
          DOCUMENTO = substring(LNRDOCUMENTO || '-' || LPARCELA from 1 for 30);
        else
          DOCUMENTO = LNRDOCUMENTO;
      end
      suspend;
    end
  
  
    for select
      C.CODCONTA,
      C.VALORBRUTO,
      coalesce(C.ACREVAL, 0),
      coalesce(C.DESCVAL, 0),
      C.VALORLIQ
    from
      CAIXAOPPAGAMENTO C
      join CAIXAOPRECEBIMENTO CR on
        C.CODCAIXAOPRECEBIMENTO = CR.CODCAIXAOPRECEBIMENTO
    where
      CR.CODCAIXAOP = :CODCAIXAOP
    order by
      C.CODCONTA
    into
      LCODCONTA,
      VALORBRUTO,
      ACREVAL,
      DESCVAL,
      VALORLIQ
    do
    begin
      LTEMINF = 1;
      ACREPERC = nullif(ACREPERC, 0);
      ACREVAL  = nullif(ACREVAL, 0);
      DESCPERC = nullif(DESCPERC, 0);
      DESCVAL  = nullif(DESCVAL, 0);
      TIPO = 'PAGAMENTO';
      select
        C.NRDOCUMENTO,
        C.PARCELA,
        P.CODPESSOA,
        case 
          when (:LEXIBIRRAZAOSOCIAL <> 0) then
            TRIM(P.NOME)
        else
          coalesce(nullif(TRIM(P.NOMEFANTAZIA), ''), P.NOME)
        end
      from
        PESSOA P
        join CONTA C on
          P.CODPESSOA = C.CODPESSOA
      where
        C.CODCONTA = :LCODCONTA
      into
        LNRDOCUMENTO,
        LPARCELA,
        CODPESSOA,
        PESSOA;
  
      if (LGERARNUMEROVENCIMENTOPARCELA = 0) then
        DOCUMENTO = substring(LNRDOCUMENTO || '-' || LPARCELA from 1 for 30);
      else
        DOCUMENTO = LNRDOCUMENTO;
      suspend;
    end
  
    VALORBRUTO = null;
    CODPESSOA  = null;
    for select
      C.TIPOMOV,
      C.VALOR,
      C.TIPOMOV,
      C.OBS
    from
      CAIXAOPMOV C
    where
      C.CODCAIXAOP             = :CODCAIXAOP and
      C.CODCAIXAOPRECEBIMENTO is null
    order by
      C.TIPOMOV,
      C.CODCAIXAOPMOV
    into
      TIPO,
      VALORLIQ,
      DOCUMENTO,
      PESSOA
    do
    begin
      LTEMINF = 1;
      suspend;
    end
    if (LTEMINF = 0) then
      suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MEXPORTAMASTERMACFMVIM(
    EDATAINI DATE,
    EDATAFIM DATE,
    EFILIAL VARCHAR(2))
RETURNS (
    TIPO CHAR(1),
    NFISCAL CHAR(8),
    NFISCAL2 CHAR(6),
    FILIAL CHAR(2),
    XREF CHAR(8),
    UNIDADE CHAR(2),
    EMISSAO CHAR(8),
    ENTRADA CHAR(8),
    CDFISC CHAR(4),
    CP CHAR(10),
    ESPECIE CHAR(3),
    SERIE CHAR(3),
    VLCTABIL NUMERIC(13,2),
    VL_VISTA NUMERIC(13,2),
    VLCTBRURAL NUMERIC(13,2),
    UF CHAR(2),
    VISTAPRAZO CHAR(1),
    ENTRAPROP VARCHAR(1),
    CXADATA CHAR(8),
    CXAVALOR NUMERIC(13,2),
    CXAHISTC CHAR(3),
    CXAHIST VARCHAR(1),
    FATUR_3 NUMERIC(13,2),
    FATUR_35 NUMERIC(13,2),
    FATUR_8 NUMERIC(13,2),
    FATUR_20 NUMERIC(13,2),
    INTEG_TO CHAR(1),
    ITENSCAN NUMERIC(13,2),
    TIPDOC CHAR(2),
    AUX VARCHAR(1),
    USER_ VARCHAR(1),
    REDUCAO_Z VARCHAR(1),
    SUBFISC VARCHAR(1),
    TIPODOCFISC CHAR(2),
    AIDF_ANO VARCHAR(1),
    AIDF_NUM VARCHAR(1),
    VL_FRETE NUMERIC(13,2),
    VL_SEG NUMERIC(13,2),
    VL_DA NUMERIC(13,2),
    HREMISSAO TIME,
    HR_E_S_PRD TIME,
    PREPOSTO VARCHAR(10),
    UF_PSRV CHAR(2),
    MUNIC_PSRV VARCHAR(6),
    FORM_INI VARCHAR(10),
    FORM_FIM VARCHAR(10),
    CHV_NFE VARCHAR(44),
    VEIC_ID VARCHAR(8),
    UF_ID CHAR(2))
AS
declare variable LXREF integer;
declare variable LPESSOA smallint;
declare variable LCPFCGC varchar(18);
declare variable LIDNOTA integer;
begin
  FILIAL      = RIGHT('00' || coalesce(EFILIAL, '0'), 2);
  LXREF       = 0;
  UNIDADE     = '00';
  VL_VISTA    = 0;
  VLCTBRURAL  = 0;
  ENTRAPROP   = '';
  CXADATA     = '';
  CXAVALOR    = 0;
  CXAHISTC    = '001';
  CXAHIST     = '';
  FATUR_3     = 0;
  FATUR_8     = 0;
  FATUR_20    = 0;
  INTEG_TO    = '';
  ITENSCAN    = 0;
  AUX         = '';
  USER_       = '';
  REDUCAO_Z   = '';
  SUBFISC     = '';
  TIPODOCFISC = '55';
  AIDF_ANO    = '';
  AIDF_NUM    = '';
  PREPOSTO = '';
  UF_PSRV = '';
  MUNIC_PSRV = '';
  FORM_INI = '';
  FORM_FIM = '';
  CHV_NFE = '';
  VEIC_ID = '';
  UF_ID = '';


  for select
    'S',
    RIGHT('000000' || cast(N.CODNFVENDA as varchar (6)), 6),
    RIGHT('0000' || extract(year from N.DT_EMISSAO), 4) || RIGHT('00' || extract(month from N.DT_EMISSAO), 2) ||  RIGHT('00' || extract(day from N.DT_EMISSAO), 2),
    RIGHT('0000' || extract(year from N.DT_EMISSAO), 4) || RIGHT('00' || extract(month from N.DT_EMISSAO), 2) ||  RIGHT('00' || extract(day from N.DT_EMISSAO), 2),
    (select first 1
       NI.CFOP_CFOP
     from
       NFVENDAITEM NI
     where
       NI.CODNFVENDA = N.CODNFVENDA and
       NI.SERIE      = N.SERIE),
    P.PESSOA,
    P.CPFCGC,
    cast(coalesce(substring(N.ESPECIE from 1 for 3), 'NFE ') as varchar(3)),
    cast(N.SERIE as char(3)),
    N.TOTALNOTA,
    P.UF_1,
    ' ',
    coalesce(N.FRETEVLR, 0),
    coalesce(N.SEGUROVLR, 0),
    coalesce(N.OUTRASDESPESA, 0),
    cast(N.DT_CADAST as time),
    N.CODNFVENDA,
    N.CHAVE
  from
    NFVENDA N
    join PESSOA P on
      N.CODPESSOA = P.CODPESSOA
  where
    cast(N.DT_EMISSAO AS date) between :EDATAINI and :EDATAFIM and
    N.STATUS                         = 'F'

  union

  select
    'E',
    RIGHT('000000' || cast(substring(NE.DOCUMENTO from 1 for 6) as varchar (6)), 6),
    RIGHT('0000' || extract(year from NE.DTEMISSAO), 4) || RIGHT('00' || extract(month from NE.DTEMISSAO), 2) ||  RIGHT('00' || extract(day from NE.DTEMISSAO), 2),
    RIGHT('0000' || extract(year from NE.DTENTRADA), 4) || RIGHT('00' || extract(month from NE.DTENTRADA), 2) ||  RIGHT('00' || extract(day from NE.DTENTRADA), 2),
    NE.CFOP_CFOP,
    P.PESSOA,
    P.CPFCGC,
    cast('NFE ' as varchar(3)),
    cast(NE.SERIE as char(3)),
    NE.TOTNOTVLR,
    P.UF_1,
    'T',
    coalesce(NE.FRETEVLR, 0),
    coalesce(NE.SEGVLR, 0),
    coalesce(NE.DESPVLR, 0),
    cast(NE.DT_CADAST as time),
    NE.CODNFENTRADA,
    cast((select
      STRRESULT
    from
      FU_GETTIRAMASCARA(NE.CHAVENFE)) as varchar(44))
  from
    NFENTRADA NE
    join PESSOA P on
      NE.CODPESSOA = P.CODPESSOA
  where
    cast(NE.DTENTRADA as date) between :EDATAINI and :EDATAFIM and
    NE.STATUS                        = 'F'
  order by
    4,
    2,
    7,
    9
  into
    TIPO,
    NFISCAL,
    EMISSAO,
    ENTRADA,
    CDFISC,
    LPESSOA,
    LCPFCGC,
    ESPECIE,
    SERIE,
    VLCTABIL,
    UF,
    TIPDOC,
    VL_FRETE,
    VL_SEG,
    VL_DA,
    HREMISSAO,
    LIDNOTA,
    CHV_NFE
  do
  begin
    LXREF      = LXREF + 1;
    XREF       = RIGHT('000000' || LXREF, 6);
    FATUR_35   = VLCTABIL;
    HR_E_S_PRD = HREMISSAO;

    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:CHV_NFE)
    into
      CHV_NFE;

    if (TIPO = 'S') then
      NFISCAL2 = NFISCAL;
    else
      NFISCAL2 = '      ';

    if (LPESSOA = 1) then
      CP = substring(LCPFCGC from 1 for 3) || substring(LCPFCGC from 5 for 3) || substring(LCPFCGC from 9 for 3) || substring(LCPFCGC from 13 for 1);
    else
      CP = substring(LCPFCGC from 1 for 2) || substring(LCPFCGC from 4 for 3) || substring(LCPFCGC from 8 for 3) || substring(LCPFCGC from 14 for 2);

    if (CDFISC in ('1152', '2910', '5152', '5202', '5910')) then
      VISTAPRAZO = '5';
    else
    begin
      if (TIPO = 'S') then
      begin
        if (exists(select
                     C.CODCONTA
                   from
                     CONTA C
                   where
                     C.CODNFVENDA = :LIDNOTA and
                     C.SERIENF    = TRIM(:SERIE))) then
        begin
          VISTAPRAZO = '2';
        end
        else
          VISTAPRAZO = '1';
      end
      else
      begin
        if (exists(select
                     C.CODCONTA
                   from
                     CONTA C
                   where
                     C.CODNFENTRADA = :LIDNOTA)) then
        begin
          VISTAPRAZO = '2';
        end
        else
          VISTAPRAZO = '1';
      end
    end
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MPRODUTOSAUX(
    CODPRODFILHO INTEGER)
RETURNS (
    DESCRICAO VARCHAR(60),
    CODPESQ1 VARCHAR(30),
    CODPESQ2 VARCHAR(30),
    CODPESQ3 VARCHAR(7),
    CODUNIDADE INTEGER,
    UNID VARCHAR(5),
    TIPOITEM VARCHAR(2),
    NCM VARCHAR(8),
    CODGEN VARCHAR(2),
    ICMS DOUBLE PRECISION,
    CSTPIS VARCHAR(2),
    PIS DOUBLE PRECISION,
    CSTCOFINS VARCHAR(2),
    COFINS DOUBLE PRECISION,
    CSTPISENTRADA VARCHAR(2),
    PISENTRADA DOUBLE PRECISION,
    CSTCOFINSENTRADA VARCHAR(2),
    COFINSENTRADA DOUBLE PRECISION,
    CSTIPI VARCHAR(2),
    CSTIPIENTRADA VARCHAR(2),
    IPI DOUBLE PRECISION,
    CODPRODUTO INTEGER,
    CODGRUPO INTEGER,
    CODSUBGRUPO INTEGER,
    CODFABRICANTE INTEGER,
    TRIBUTADO VARCHAR(1),
    CST VARCHAR(4),
    ALIQUOTAICMS DOUBLE PRECISION,
    ALIQUOTAICMSFORA DOUBLE PRECISION,
    REDICMS DOUBLE PRECISION,
    POSSEITEM INTEGER)
AS
declare variable CODNCM integer;
declare variable CLASSFISCAL varchar(20);
declare variable LORIGEM varchar(1);
declare variable LCST varchar(3);
begin
  select
    PRODFILHO.DESCRICAO,
    coalesce(nullif(PRODFILHO.CODPESQ1,''),CODPRODFILHO),
    coalesce(nullif(PRODFILHO.CODPESQ2,''),CODPRODFILHO),
    coalesce(nullif(PRODFILHO.CODPESQ3,''),CODPRODFILHO),
    PRODFILHO.IND_TIPO_ITEM_INVENT,
    PRODFILHO.ICMSVENDADENTRO,
    PRODFILHO.CODUNIDADE,
    PRODFILHO.CODNCM,
    PRODFILHO.CLASSFISCAL,
    coalesce(nullif(PRODFILHO.CSTPIS,''),''),
    coalesce(nullif(PRODFILHO.CSTCOFINS,''),''),
    coalesce(nullif(PRODFILHO.PERC_PIS,0),0),
    coalesce(nullif(PRODFILHO.PERC_COFINS,0),0),
    coalesce(nullif(PRODFILHO.CSTPISENTRADA,''),''),
    coalesce(nullif(PRODFILHO.CSTCOFINSENTRADA,''),''),
    coalesce(nullif(PRODFILHO.PERCPISCOMPRA,0),0),
    coalesce(nullif(PRODFILHO.PERCCONFINSCOMPRA,0),0),
    coalesce(nullif(PRODFILHO.PRDF_CST_IPISAIDA,''),''),
    coalesce(nullif(PRODFILHO.PRDF_CST_IPIENTRADA,''),''),
    coalesce(PRODFILHO.ALIQUOTAIPI,0) ALIQUOTAIPI,
    coalesce(nullif(PRODFILHO.TRIBUTADO,'0'),'0'),
    coalesce(nullif(PRODFILHO.PRDF_CST_ORIGEM_MERCADORIA,'0'),'0') LORIGEM,
    coalesce(nullif(PRODFILHO.PRDF_CST_TRIBICMS,'0'),'0') LCST,
    coalesce(PRODFILHO.ALIQUOTAICMS,0),
    coalesce(PRODFILHO.ALIQUOTAICMSFORA,0),
    coalesce(PRODFILHO.PERC_REDUCAO_ICMS,0),
    coalesce(PRODFILHO.IND_PROPRIEDADE,0)
  from
    PRODFILHO
  where
    PRODFILHO.CODPRODFILHO =:CODPRODFILHO
  into :DESCRICAO,
       :CODPESQ1,
       :CODPESQ2,
       :CODPESQ3,
       :TIPOITEM,
       :ICMS,
       :CODUNIDADE,
       :CODNCM,
       :CLASSFISCAL,
       :CSTPIS,
       :CSTCOFINS,
       :PIS,
       :COFINS,
       :CSTPISENTRADA,
       :CSTCOFINSENTRADA,
       :PISENTRADA,
       :COFINSENTRADA,
       :CSTIPI,
       :CSTIPIENTRADA,
       :IPI,
       :TRIBUTADO,
       :LORIGEM,
       :LCST,
       :ALIQUOTAICMS,
       :ALIQUOTAICMSFORA,
       :REDICMS,
       :POSSEITEM;

  CODUNIDADE = coalesce(CODUNIDADE,1);
  ICMS       = coalesce(ICMS,0);
  CODPESQ1   = coalesce(CODPESQ1,CODPRODFILHO);
  TIPOITEM   = coalesce(TIPOITEM,'00');
  POSSEITEM  = coalesce(POSSEITEM,0);

  if (coalesce(ICMS,0) = 0) then
    ICMS = ALIQUOTAICMS;

  select
    UNIDADE.SIGLA
  from
    UNIDADE
  where
    UNIDADE.CODUNIDADE=:CODUNIDADE
  into
    :UNID;

  CODNCM = coalesce(CODNCM,0);
  if (CODNCM > 0) then
  begin
  select
    NCM.NCM_CODIGO
  from
    NCM
  where
    NCM.CODNCM=:CODNCM
  into
    NCM;
  end else
  begin
    CLASSFISCAL = substring(CLASSFISCAL from 1 for 8);
    NCM = CLASSFISCAL;
  end

  if ((NCM is null) or (TRIM(NCM) = '')) then
  begin
    CLASSFISCAL = substring(CLASSFISCAL from 1 for 8);
    NCM = CLASSFISCAL;
  end

  CODGEN = substring(NCM from 1 for 2);

  select R_TRIM from FU_TRIM(:LORIGEM)       into :LORIGEM;
  if (CHAR_LENGTH(LORIGEM) <= 0) then
    LORIGEM = '0';

  select R_TRIM from FU_TRIM(:LCST)          into :LCST;
  if (CHAR_LENGTH(LCST) <= 1) then
    LCST = '40';

  CST = LORIGEM || LCST;

  select R_TRIM from FU_TRIM(:CSTPIS)        into :CSTPIS;
  select R_TRIM from FU_TRIM(:CSTCOFINS)     into :CSTCOFINS;
  select R_TRIM from FU_TRIM(:CSTIPI)        into :CSTIPI;
  select R_TRIM from FU_TRIM(:CSTIPIENTRADA) into :CSTIPIENTRADA;

  select
    PRODFILHO.CODPRODUTO
  from
    PRODFILHO
  where
    PRODFILHO.CODPRODFILHO=:CODPRODFILHO
  into
    :CODPRODUTO;

  select
    PRODUTO.CODGRUPO,
    PRODUTO.CODSUBGRUPO,
    PRODUTO.CODFABRICANTE
  from
    PRODUTO
  where
    PRODUTO.CODPRODUTO=:CODPRODUTO
  into
    :CODGRUPO,
    :CODSUBGRUPO,
    :CODFABRICANTE;

    CODGRUPO      = coalesce(CODGRUPO,0);
    CODSUBGRUPO   = coalesce(CODSUBGRUPO,0);
    CODFABRICANTE = coalesce(CODFABRICANTE,0);

  suspend;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MRETORNACODEMPRESA(
    ECODEMPRESA INTEGER,
    EATUALIZACODEMPRESANET CHAR(1))
RETURNS (
    CODEMPRESA INTEGER)
AS
begin
  if (nullif(nullif(ECODEMPRESA,0),-1) is null) then
  begin
    if (coalesce(nullif(TRIM(EATUALIZACODEMPRESANET), ''), 'S') = 'S') then
    begin
      select first 1
        E.CODEMPRESA
      from
        EMPRESA E
        join SYSPARAMS S on E.CGC = S.CGC
      into
        CODEMPRESA;
    end
  
    CODEMPRESA = coalesce(CODEMPRESA, ECODEMPRESA);
  end
  else
    CODEMPRESA = ECODEMPRESA;
  suspend;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE R_2576MESES(
    MES_INI INTEGER,
    ANO_INI INTEGER,
    TIPO_PERIODO CHAR(1),
    TIPO_CONTA CHAR(1),
    SITUACAO CHAR(1),
    US_CADAST VARCHAR(45),
    QTD_MESES INTEGER)
RETURNS (
    CODCENTCUSTO INTEGER,
    CODLIVRESEMMASK VARCHAR(60),
    DESCRICAO VARCHAR(60),
    MES1 DOUBLE PRECISION,
    MES2 DOUBLE PRECISION,
    MES3 DOUBLE PRECISION,
    MES4 DOUBLE PRECISION,
    MES5 DOUBLE PRECISION,
    MES6 DOUBLE PRECISION,
    CODLIVRE VARCHAR(60),
    MEDIA DOUBLE PRECISION)
AS
declare variable CONT integer;
declare variable MES_ATU integer;
declare variable ANO_ATU integer;
declare variable TOTALTEMP double precision;
declare variable LTOTALGERAL double precision;
begin
  delete from
    R_TBLTEMP6MESES;

  for select
    CODCENTCUSTO,
    CODLIVRESEMMASK,
    DESCRICAO,
    CODLIVRE
  from
    CENTCUSTO
  order by
    CODLIVRESEMMASK
  into
    CODCENTCUSTO,
    CODLIVRESEMMASK,
    DESCRICAO,
    CODLIVRE
  do
  begin
    MES1 = 0;
    MES2 = 0;
    MES3 = 0;
    MES4 = 0;
    MES5 = 0;
    MES6 = 0;

    CONT = 1;
    MES_ATU = MES_INI;
    ANO_ATU = ANO_INI;
    LTOTALGERAL = 0;
    while (CONT <= 6) do
    begin
      select
        TOTAL
      from
        R_257TOTAL6MESES(
          :MES_ATU,
          :ANO_ATU,
          :CODCENTCUSTO,
          :TIPO_PERIODO,
          :TIPO_CONTA,
          :SITUACAO)
      into
        TOTALTEMP;

      TOTALTEMP = coalesce(TOTALTEMP, 0);

      if (CONT = 1) then
        MES1 = TOTALTEMP;
      else if (CONT = 2) then
        MES2 = TOTALTEMP;
      else if (CONT = 3) then
        MES3 = TOTALTEMP;
      else if (CONT = 4) then
        MES4 = TOTALTEMP;
      else if (CONT = 5) then
        MES5 = TOTALTEMP;
      else if (CONT = 6) then
        MES6 = TOTALTEMP;

      CONT = CONT + 1;
      MES_ATU = MES_ATU + 1;

      if (MES_ATU = 13) then
      begin
        ANO_ATU = ANO_ATU + 1;
        MES_ATU = 1;
      end
    end

    insert into
      R_TBLTEMP6MESES(
        CODCENTCUSTO,
        CODLIVRESEMMASK,
        DESCRICAO,
        MES1,
        MES2,
        MES3,
        MES4,
        MES5,
        MES6,
        US_CADAST,
        CODLIVRE)
      values(
        :CODCENTCUSTO,
        TRIM(:CODLIVRESEMMASK),
        :DESCRICAO,
        :MES1,
        :MES2,
        :MES3,
        :MES4,
        :MES5,
        :MES6,
        :US_CADAST,
        :CODLIVRE);
  end

  /* CALCULA OS VALORES DAS CONTAS TOTALIZADORAS */
  for select
    CODLIVRESEMMASK
  from
    R_TBLTEMP6MESES
  order by
    CODLIVRESEMMASK
  into
    CODLIVRESEMMASK
  do
  begin
    select
      MES1,
      MES2,
      MES3,
      MES4,
      MES5,
      MES6
    from
      R_257CALC6MESES(:CODLIVRESEMMASK)
    into
      :MES1,
      :MES2,
      :MES3,
      :MES4,
      :MES5,
      :MES6;

    if (QTD_MESES = 1) then
    begin
      MES2 = 0;
      MES3 = 0;
      MES4 = 0;
      MES5 = 0;
      MES6 = 0;
    end

    if (QTD_MESES = 2) then
    begin
      MES3 = 0;
      MES4 = 0;
      MES5 = 0;
      MES6 = 0;
    end

    if (QTD_MESES = 3) then
    begin
      MES4 = 0;
      MES5 = 0;
      MES6 = 0;
    end

    if (QTD_MESES = 4) then
    begin
      MES5 = 0;
      MES6 = 0;
    end

    if (QTD_MESES = 5) then
    begin
      MES6 = 0;
    end

    update
      R_TBLTEMP6MESES
    set
      MES1 = :MES1,
      MES2 = :MES2,
      MES3 = :MES3,
      MES4 = :MES4,
      MES5 = :MES5,
      MES6 = :MES6,
      TOTAL = :MES1 + :MES2 + :MES3 + :MES4 + :MES5 + :MES6,
      MEDIA = TOTAL / :QTD_MESES
    where
      CODLIVRESEMMASK = :CODLIVRESEMMASK;
  end

  delete from 
    R_TBLTEMP6MESES
  where 
    coalesce(TOTAL,0) = 0;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE R_2576MESES_EMPRESA(
    MES_INI INTEGER,
    ANO_INI INTEGER,
    TIPO_PERIODO CHAR(1),
    TIPO_CONTA CHAR(1),
    SITUACAO CHAR(1),
    US_CADAST VARCHAR(45),
    QTD_MESES INTEGER,
    CODEMPRESA INTEGER)
RETURNS (
    CODCENTCUSTO INTEGER,
    CODLIVRESEMMASK VARCHAR(60),
    DESCRICAO VARCHAR(60),
    MES1 DOUBLE PRECISION,
    MES2 DOUBLE PRECISION,
    MES3 DOUBLE PRECISION,
    MES4 DOUBLE PRECISION,
    MES5 DOUBLE PRECISION,
    MES6 DOUBLE PRECISION,
    CODLIVRE VARCHAR(60),
    MEDIA DOUBLE PRECISION)
AS
declare variable CONT integer;
declare variable MES_ATU integer;
declare variable ANO_ATU integer;
declare variable TOTALTEMP double precision;
declare variable LTOTALGERAL double precision;
begin
  delete from
    R_TBLTEMP6MESES;

  for select
    CODCENTCUSTO,
    CODLIVRESEMMASK,
    DESCRICAO,
    CODLIVRE
  from
    CENTCUSTO
  order by
    CODLIVRESEMMASK
  into
    CODCENTCUSTO,
    CODLIVRESEMMASK,
    DESCRICAO,
    CODLIVRE
  do
  begin
    MES1 = 0;
    MES2 = 0;
    MES3 = 0;
    MES4 = 0;
    MES5 = 0;
    MES6 = 0;

    CONT = 1;
    MES_ATU = MES_INI;
    ANO_ATU = ANO_INI;
    LTOTALGERAL = 0;
    while (CONT <= 6) do
    begin
      select
        TOTAL
      from
        R_257TOTAL6MESES(
          :MES_ATU,
          :ANO_ATU,
          :CODCENTCUSTO,
          :TIPO_PERIODO,
          :TIPO_CONTA,
          :SITUACAO,
          :CODEMPRESA)
      into
        TOTALTEMP;

      TOTALTEMP = coalesce(TOTALTEMP, 0);

      if (CONT = 1) then
        MES1 = TOTALTEMP;
      else if (CONT = 2) then
        MES2 = TOTALTEMP;
      else if (CONT = 3) then
        MES3 = TOTALTEMP;
      else if (CONT = 4) then
        MES4 = TOTALTEMP;
      else if (CONT = 5) then
        MES5 = TOTALTEMP;
      else if (CONT = 6) then
        MES6 = TOTALTEMP;

      CONT = CONT + 1;
      MES_ATU = MES_ATU + 1;

      if (MES_ATU = 13) then
      begin
        ANO_ATU = ANO_ATU + 1;
        MES_ATU = 1;
      end
    end

    insert into
      R_TBLTEMP6MESES(
        CODCENTCUSTO,
        CODLIVRESEMMASK,
        DESCRICAO,
        MES1,
        MES2,
        MES3,
        MES4,
        MES5,
        MES6,
        US_CADAST,
        CODLIVRE)
      values(
        :CODCENTCUSTO,
        TRIM(:CODLIVRESEMMASK),
        :DESCRICAO,
        :MES1,
        :MES2,
        :MES3,
        :MES4,
        :MES5,
        :MES6,
        :US_CADAST,
        :CODLIVRE);
  end

  /* CALCULA OS VALORES DAS CONTAS TOTALIZADORAS */
  for select
    CODLIVRESEMMASK
  from
    R_TBLTEMP6MESES
  order by
    CODLIVRESEMMASK
  into
    CODLIVRESEMMASK
  do
  begin
    select
      MES1,
      MES2,
      MES3,
      MES4,
      MES5,
      MES6
    from
      R_257CALC6MESES(:CODLIVRESEMMASK)
    into
      :MES1,
      :MES2,
      :MES3,
      :MES4,
      :MES5,
      :MES6;

    if (QTD_MESES = 1) then
    begin
      MES2 = 0;
      MES3 = 0;
      MES4 = 0;
      MES5 = 0;
      MES6 = 0;
    end

    if (QTD_MESES = 2) then
    begin
      MES3 = 0;
      MES4 = 0;
      MES5 = 0;
      MES6 = 0;
    end

    if (QTD_MESES = 3) then
    begin
      MES4 = 0;
      MES5 = 0;
      MES6 = 0;
    end

    if (QTD_MESES = 4) then
    begin
      MES5 = 0;
      MES6 = 0;
    end

    if (QTD_MESES = 5) then
    begin
      MES6 = 0;
    end

    update
      R_TBLTEMP6MESES
    set
      MES1 = :MES1,
      MES2 = :MES2,
      MES3 = :MES3,
      MES4 = :MES4,
      MES5 = :MES5,
      MES6 = :MES6,
      TOTAL = :MES1 + :MES2 + :MES3 + :MES4 + :MES5 + :MES6,
      MEDIA = TOTAL / :QTD_MESES
    where
      CODLIVRESEMMASK = :CODLIVRESEMMASK;
  end

  delete from 
    R_TBLTEMP6MESES
  where 
    coalesce(TOTAL,0) = 0;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE R171RANKINGMUNICIPIO(
    EDATAINI DATE,
    EDATAFIM DATE,
    EGRUPO1 INTEGER,
    EGRUPO2 INTEGER,
    EGRUPO3 INTEGER,
    EGRUPO4 INTEGER,
    ESTATUSPED VARCHAR(20))
RETURNS (
    CIDADE_1 VARCHAR(45),
    NOMEGRUPO1 VARCHAR(60),
    VENDAGRUPO1 DOUBLE PRECISION,
    NOMEGRUPO2 VARCHAR(60),
    VENDAGRUPO2 DOUBLE PRECISION,
    NOMEGRUPO3 VARCHAR(60),
    VENDAGRUPO3 DOUBLE PRECISION,
    NOMEGRUPO4 VARCHAR(60),
    VENDAGRUPO4 DOUBLE PRECISION,
    VENDAGRUPOOUTROS DOUBLE PRECISION,
    QTDPEDIDOS INTEGER)
AS
declare variable LCODGRUPO integer;
declare variable LPRECOVEND double precision;
declare variable LCODPEDVEND integer;
begin
  /* LOCALIZO OS NOMES DOS GRUPO PASSADOS NA ENTRADA */
  if (EGRUPO1 is not null) then
  begin
    select
      DESCRICAO
    from
      GRUPO
    where
      CODGRUPO = :EGRUPO1
    into
      :NOMEGRUPO1;
  end 

  if (EGRUPO2 is not null) then
  begin
    select
      DESCRICAO
    from
      GRUPO
    where
      CODGRUPO = :EGRUPO2
    into
      :NOMEGRUPO2;
  end 

  if (EGRUPO3 is not null) then
  begin
    select
      DESCRICAO
    from
      GRUPO
    where
      CODGRUPO = :EGRUPO3
    into
      :NOMEGRUPO3;
  end 

  if (EGRUPO4 is not null) then
  begin
    select
      DESCRICAO
    from
      GRUPO
    where
      CODGRUPO = :EGRUPO4
    into
      :NOMEGRUPO4;
  end 

  if (ESTATUSPED = 'TODOS') THEN
  begin
    /* RELACIONO OS SUPERVISORES DO PERÍODO */
    for select distinct
      TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA'))
    from
      PEDVEND P
      join PESSOA C on P.CODPESSOA = C.CODPESSOA
    where
      P.DT_SAIDA between :EDATAINI and :EDATAFIM
    into
      :CIDADE_1
    do
    begin
      VENDAGRUPO1      = 0;
      VENDAGRUPO2      = 0;
      VENDAGRUPO3      = 0;
      VENDAGRUPO4      = 0;
      VENDAGRUPOOUTROS = 0;
      QTDPEDIDOS       = 0;
      /* CALCULO OS TOTAIS DE CADA GRUPO */
      for select
        PR.CODGRUPO,
        coalesce(sum(PI.PRECOVEND - PI.PERDA), 0),
        count(distinct P.CODPEDVEND)
      from
        PEDVENDITEM PI
        join PEDVEND P on PI.CODPEDVEND = P.CODPEDVEND
        join PESSOA C on P.CODPESSOA = C.CODPESSOA
        join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
        join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
      where
        TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA')) = :CIDADE_1 and
        P.DT_SAIDA                                   between :EDATAINI and :EDATAFIM
      group by
        1
      into
        :LCODGRUPO,
        :LPRECOVEND,
        :LCODPEDVEND
      do
      begin
        QTDPEDIDOS = coalesce(QTDPEDIDOS, 0) + LCODPEDVEND;
        if (LCODGRUPO = EGRUPO1) then
          VENDAGRUPO1 = coalesce(VENDAGRUPO1, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO2) then
          VENDAGRUPO2 = coalesce(VENDAGRUPO2, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO3) then
          VENDAGRUPO3 = coalesce(VENDAGRUPO3, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO4) then
          VENDAGRUPO4 = coalesce(VENDAGRUPO4, 0) + LPRECOVEND;
        else
          VENDAGRUPOOUTROS = coalesce(VENDAGRUPOOUTROS, 0) + LPRECOVEND;
      end
      suspend;
    end
  end
  else if (ESTATUSPED = 'NÃO CANCELADO') then
  begin
    /* RELACIONO OS SUPERVISORES DO PERÍODO */
    for select distinct
      TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA'))
    from
      PEDVEND P
      join PESSOA C on P.CODPESSOA = C.CODPESSOA
    where
      P.DT_SAIDA between :EDATAINI and :EDATAFIM and
      P.STATUSPED <> 'CANCELADO'
    into
      :CIDADE_1
    do
    begin
      VENDAGRUPO1      = 0;
      VENDAGRUPO2      = 0;
      VENDAGRUPO3      = 0;
      VENDAGRUPO4      = 0;
      VENDAGRUPOOUTROS = 0;
      QTDPEDIDOS       = 0;
      /* CALCULO OS TOTAIS DE CADA GRUPO */
      for select
        PR.CODGRUPO,
        coalesce(sum(PI.PRECOVEND - PI.PERDA), 0),
        count(distinct P.CODPEDVEND)
      from
        PEDVENDITEM PI
        join PEDVEND P on PI.CODPEDVEND = P.CODPEDVEND
        join PESSOA C on P.CODPESSOA = C.CODPESSOA
        join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
        join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
      where
        TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA')) = :CIDADE_1 and
        P.DT_SAIDA                                   between :EDATAINI and :EDATAFIM and
        P.STATUSPED <> 'CANCELADO'
      group by
        1
      into
        :LCODGRUPO,
        :LPRECOVEND,
        :LCODPEDVEND
      do
      begin
        QTDPEDIDOS = coalesce(QTDPEDIDOS, 0) + LCODPEDVEND;
        if (LCODGRUPO = EGRUPO1) then
          VENDAGRUPO1 = coalesce(VENDAGRUPO1, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO2) then
          VENDAGRUPO2 = coalesce(VENDAGRUPO2, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO3) then
          VENDAGRUPO3 = coalesce(VENDAGRUPO3, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO4) then
          VENDAGRUPO4 = coalesce(VENDAGRUPO4, 0) + LPRECOVEND;
        else
          VENDAGRUPOOUTROS = coalesce(VENDAGRUPOOUTROS, 0) + LPRECOVEND;
      end
      suspend;
    end
  end
  else
  begin
    /* RELACIONO OS SUPERVISORES DO PERÍODO */
    for select distinct
      TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA'))
    from
      PEDVEND P
      join PESSOA C on P.CODPESSOA = C.CODPESSOA
    where
      P.DT_SAIDA between :EDATAINI and :EDATAFIM and
      P.STATUSPED      = :ESTATUSPED
    into
      :CIDADE_1
    do
    begin
      VENDAGRUPO1      = 0;
      VENDAGRUPO2      = 0;
      VENDAGRUPO3      = 0;
      VENDAGRUPO4      = 0;
      VENDAGRUPOOUTROS = 0;
      QTDPEDIDOS       = 0;
      /* CALCULO OS TOTAIS DE CADA GRUPO */
      for select
        PR.CODGRUPO,
        coalesce(sum(PI.PRECOVEND - PI.PERDA), 0),
        count(distinct P.CODPEDVEND)
      from
        PEDVENDITEM PI
        join PEDVEND P on PI.CODPEDVEND = P.CODPEDVEND
        join PESSOA C on P.CODPESSOA = C.CODPESSOA
        join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
        join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
      where
        TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA')) = :CIDADE_1 and
        P.DT_SAIDA                                   between :EDATAINI and :EDATAFIM and
        P.STATUSPED                                        = :ESTATUSPED
      group by
        1
      into
        :LCODGRUPO,
        :LPRECOVEND,
        :LCODPEDVEND
      do
      begin
        QTDPEDIDOS = coalesce(QTDPEDIDOS, 0) + LCODPEDVEND;
        if (LCODGRUPO = EGRUPO1) then
          VENDAGRUPO1 = coalesce(VENDAGRUPO1, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO2) then
          VENDAGRUPO2 = coalesce(VENDAGRUPO2, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO3) then
          VENDAGRUPO3 = coalesce(VENDAGRUPO3, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO4) then
          VENDAGRUPO4 = coalesce(VENDAGRUPO4, 0) + LPRECOVEND;
        else
          VENDAGRUPOOUTROS = coalesce(VENDAGRUPOOUTROS, 0) + LPRECOVEND;
      end
      suspend;
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE R171RANKINGMUNICIPIOSUPERVISOR(
    EDATAINI DATE,
    EDATAFIM DATE,
    EGRUPO1 INTEGER,
    EGRUPO2 INTEGER,
    EGRUPO3 INTEGER,
    EGRUPO4 INTEGER,
    ESTATUSPED VARCHAR(20))
RETURNS (
    CODIGO INTEGER,
    NOME VARCHAR(60),
    CIDADE_1 VARCHAR(45),
    NOMEGRUPO1 VARCHAR(60),
    VENDAGRUPO1 DOUBLE PRECISION,
    NOMEGRUPO2 VARCHAR(60),
    VENDAGRUPO2 DOUBLE PRECISION,
    NOMEGRUPO3 VARCHAR(60),
    VENDAGRUPO3 DOUBLE PRECISION,
    NOMEGRUPO4 VARCHAR(60),
    VENDAGRUPO4 DOUBLE PRECISION,
    VENDAGRUPOOUTROS DOUBLE PRECISION,
    QTDPEDIDOS INTEGER)
AS
declare variable LCODGRUPO integer;
declare variable LPRECOVEND double precision;
declare variable LCODPEDVEND integer;
begin
  /* LOCALIZO OS NOMES DOS GRUPO PASSADOS NA ENTRADA */
  if (EGRUPO1 is not null) then
  begin
    select
      DESCRICAO
    from
      GRUPO
    where
      CODGRUPO = :EGRUPO1
    into
      :NOMEGRUPO1;
  end 

  if (EGRUPO2 is not null) then
  begin
    select
      DESCRICAO
    from
      GRUPO
    where
      CODGRUPO = :EGRUPO2
    into
      :NOMEGRUPO2;
  end 

  if (EGRUPO3 is not null) then
  begin
    select
      DESCRICAO
    from
      GRUPO
    where
      CODGRUPO = :EGRUPO3
    into
      :NOMEGRUPO3;
  end 

  if (EGRUPO4 is not null) then
  begin
    select
      DESCRICAO
    from
      GRUPO
    where
      CODGRUPO = :EGRUPO4
    into
      :NOMEGRUPO4;
  end 

  if (ESTATUSPED = 'TODOS') THEN
  begin
    for select distinct
      coalesce(S.CODSUPERVISOR, 0),
      coalesce(S.NOME, 'SUPERVISOR INEXISTENTE'),
      TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA'))
    from
      PEDVEND P
      left join SUPERVISOR S on P.CODSUPERVISOR = S.CODSUPERVISOR
      join PESSOA C on P.CODPESSOA = C.CODPESSOA
    where
      P.DT_SAIDA between :EDATAINI and :EDATAFIM
    into
      :CODIGO,
      :NOME,
      :CIDADE_1
    do
    begin
      VENDAGRUPO1      = 0;
      VENDAGRUPO2      = 0;
      VENDAGRUPO3      = 0;
      VENDAGRUPO4      = 0;
      VENDAGRUPOOUTROS = 0;
      QTDPEDIDOS       = 0;
      /* CALCULO OS TOTAIS DE CADA GRUPO */
      for select
        PR.CODGRUPO,
        coalesce(sum(PI.PRECOVEND - PI.PERDA), 0),
        count(distinct P.CODPEDVEND)
      from
        PEDVENDITEM PI
        join PEDVEND P on PI.CODPEDVEND = P.CODPEDVEND
        join PESSOA C on P.CODPESSOA = C.CODPESSOA
        join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
        join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
      where
        TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA')) = :CIDADE_1 and
        coalesce(P.CODSUPERVISOR, 0)                       = :CODIGO and
        P.DT_SAIDA                                   between :EDATAINI and :EDATAFIM
      group by
        1
      into
        :LCODGRUPO,
        :LPRECOVEND,
        :LCODPEDVEND
      do
      begin
        QTDPEDIDOS = coalesce(QTDPEDIDOS, 0) + LCODPEDVEND;
        if (LCODGRUPO = EGRUPO1) then
          VENDAGRUPO1 = coalesce(VENDAGRUPO1, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO2) then
          VENDAGRUPO2 = coalesce(VENDAGRUPO2, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO3) then
          VENDAGRUPO3 = coalesce(VENDAGRUPO3, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO4) then
          VENDAGRUPO4 = coalesce(VENDAGRUPO4, 0) + LPRECOVEND;
        else
          VENDAGRUPOOUTROS = coalesce(VENDAGRUPOOUTROS, 0) + LPRECOVEND;
      end
      suspend;
    end
  end
  else if (ESTATUSPED = 'NÃO CANCELADO') then
  begin
    for select distinct
      coalesce(S.CODSUPERVISOR, 0),
      coalesce(S.NOME, 'SUPERVISOR INEXISTENTE'),
      TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA'))
    from
      PEDVEND P
      left join SUPERVISOR S on P.CODSUPERVISOR = S.CODSUPERVISOR
      join PESSOA C on P.CODPESSOA = C.CODPESSOA
    where
      P.DT_SAIDA between :EDATAINI and :EDATAFIM and
      P.STATUSPED <> 'CANCELADO'
    into
      :CODIGO,
      :NOME,
      :CIDADE_1
    do
    begin
      VENDAGRUPO1      = 0;
      VENDAGRUPO2      = 0;
      VENDAGRUPO3      = 0;
      VENDAGRUPO4      = 0;
      VENDAGRUPOOUTROS = 0;
      QTDPEDIDOS       = 0;
      /* CALCULO OS TOTAIS DE CADA GRUPO */
      for select
        PR.CODGRUPO,
        coalesce(sum(PI.PRECOVEND - PI.PERDA), 0),
        count(distinct P.CODPEDVEND)
      from
        PEDVENDITEM PI
        join PEDVEND P on PI.CODPEDVEND = P.CODPEDVEND
        join PESSOA C on P.CODPESSOA = C.CODPESSOA
        join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
        join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
      where
        TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA')) = :CIDADE_1 and
        coalesce(P.CODSUPERVISOR, 0)                       = :CODIGO and
        P.DT_SAIDA                                   between :EDATAINI and :EDATAFIM and
        P.STATUSPED <> 'CANCELADO'
      group by
        1
      into
        :LCODGRUPO,
        :LPRECOVEND,
        :LCODPEDVEND
      do
      begin
        QTDPEDIDOS = coalesce(QTDPEDIDOS, 0) + LCODPEDVEND;
        if (LCODGRUPO = EGRUPO1) then
          VENDAGRUPO1 = coalesce(VENDAGRUPO1, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO2) then
          VENDAGRUPO2 = coalesce(VENDAGRUPO2, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO3) then
          VENDAGRUPO3 = coalesce(VENDAGRUPO3, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO4) then
          VENDAGRUPO4 = coalesce(VENDAGRUPO4, 0) + LPRECOVEND;
        else
          VENDAGRUPOOUTROS = coalesce(VENDAGRUPOOUTROS, 0) + LPRECOVEND;
      end
      suspend;
    end
  end
  else
  begin
    for select distinct
      coalesce(S.CODSUPERVISOR, 0),
      coalesce(S.NOME, 'SUPERVISOR INEXISTENTE'),
      TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA'))
    from
      PEDVEND P
      left join SUPERVISOR S on P.CODSUPERVISOR = S.CODSUPERVISOR
      left join PESSOA C on P.CODPESSOA = C.CODPESSOA
    where
      P.DT_SAIDA between :EDATAINI and :EDATAFIM and
      P.STATUSPED      = :ESTATUSPED
    into
      :CODIGO,
      :NOME,
      :CIDADE_1
    do
    begin
      VENDAGRUPO1      = 0;
      VENDAGRUPO2      = 0;
      VENDAGRUPO3      = 0;
      VENDAGRUPO4      = 0;
      VENDAGRUPOOUTROS = 0;
      QTDPEDIDOS       = 0;
      /* CALCULO OS TOTAIS DE CADA GRUPO */
      for select
        PR.CODGRUPO,
        coalesce(sum(PI.PRECOVEND - PI.PERDA), 0),
        count(distinct P.CODPEDVEND)
      from
        PEDVENDITEM PI
        join PEDVEND P on PI.CODPEDVEND = P.CODPEDVEND
        join PESSOA C on P.CODPESSOA = C.CODPESSOA
        join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
        join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
      where
        TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA')) = :CIDADE_1 and
        coalesce(P.CODSUPERVISOR, 0)                       = :CODIGO and
        P.DT_SAIDA                                   between :EDATAINI and :EDATAFIM and
        P.STATUSPED                                        = :ESTATUSPED
      group by
        1
      into
        :LCODGRUPO,
        :LPRECOVEND,
        :LCODPEDVEND
      do
      begin
        QTDPEDIDOS = coalesce(QTDPEDIDOS, 0) + LCODPEDVEND;
        if (LCODGRUPO = EGRUPO1) then
          VENDAGRUPO1 = coalesce(VENDAGRUPO1, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO2) then
          VENDAGRUPO2 = coalesce(VENDAGRUPO2, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO3) then
          VENDAGRUPO3 = coalesce(VENDAGRUPO3, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO4) then
          VENDAGRUPO4 = coalesce(VENDAGRUPO4, 0) + LPRECOVEND;
        else
          VENDAGRUPOOUTROS = coalesce(VENDAGRUPOOUTROS, 0) + LPRECOVEND;
      end
      suspend;
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE R171RANKINGMUNICIPIOVENDEDOR(
    EDATAINI DATE,
    EDATAFIM DATE,
    EGRUPO1 INTEGER,
    EGRUPO2 INTEGER,
    EGRUPO3 INTEGER,
    EGRUPO4 INTEGER,
    ESTATUSPED VARCHAR(20))
RETURNS (
    CODIGO INTEGER,
    NOME VARCHAR(60),
    CIDADE_1 VARCHAR(45),
    NOMEGRUPO1 VARCHAR(60),
    VENDAGRUPO1 DOUBLE PRECISION,
    NOMEGRUPO2 VARCHAR(60),
    VENDAGRUPO2 DOUBLE PRECISION,
    NOMEGRUPO3 VARCHAR(60),
    VENDAGRUPO3 DOUBLE PRECISION,
    NOMEGRUPO4 VARCHAR(60),
    VENDAGRUPO4 DOUBLE PRECISION,
    VENDAGRUPOOUTROS DOUBLE PRECISION,
    QTDPEDIDOS INTEGER)
AS
declare variable LCODGRUPO integer;
declare variable LPRECOVEND double precision;
declare variable LCODPEDVEND integer;
begin
  /* LOCALIZO OS NOMES DOS GRUPO PASSADOS NA ENTRADA */
  if (EGRUPO1 is not null) then
  begin
    select
      DESCRICAO
    from
      GRUPO
    where
      CODGRUPO = :EGRUPO1
    into
      :NOMEGRUPO1;
  end 

  if (EGRUPO2 is not null) then
  begin
    select
      DESCRICAO
    from
      GRUPO
    where
      CODGRUPO = :EGRUPO2
    into
      :NOMEGRUPO2;
  end 

  if (EGRUPO3 is not null) then
  begin
    select
      DESCRICAO
    from
      GRUPO
    where
      CODGRUPO = :EGRUPO3
    into
      :NOMEGRUPO3;
  end 

  if (EGRUPO4 is not null) then
  begin
    select
      DESCRICAO
    from
      GRUPO
    where
      CODGRUPO = :EGRUPO4
    into
      :NOMEGRUPO4;
  end 

  if (ESTATUSPED = 'TODOS') then
  begin
    /* RELACIONO OS SUPERVISORES DO PERÍODO */
    for select distinct
      coalesce(V.CODVENDEDOR, 0),
      coalesce(V.NOME, 'VENDEDOR INEXISTENTE'),
      TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA'))
    from
      PEDVEND P
      left join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
      join PESSOA C on P.CODPESSOA = C.CODPESSOA
    where
      P.DT_SAIDA between :EDATAINI and :EDATAFIM
    into
      :CODIGO,
      :NOME,
      :CIDADE_1
    do
    begin
      VENDAGRUPO1      = 0;
      VENDAGRUPO2      = 0;
      VENDAGRUPO3      = 0;
      VENDAGRUPO4      = 0;
      VENDAGRUPOOUTROS = 0;
      QTDPEDIDOS       = 0;
      /* CALCULO OS TOTAIS DE CADA GRUPO */
      for select
        PR.CODGRUPO,
        coalesce(sum(PI.PRECOVEND - PI.PERDA), 0),
        count(distinct P.CODPEDVEND)
      from
        PEDVENDITEM PI
        join PEDVEND P on PI.CODPEDVEND = P.CODPEDVEND
        join PESSOA C on P.CODPESSOA = C.CODPESSOA
        join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
        join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
      where
        TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA')) = :CIDADE_1 and
        coalesce(P.CODVENDEDOR, 0)                    = :CODIGO and
        P.DT_SAIDA                              between :EDATAINI and :EDATAFIM
      group by
        1
      into
        :LCODGRUPO,
        :LPRECOVEND,
        :LCODPEDVEND
      do
      begin
        QTDPEDIDOS = coalesce(QTDPEDIDOS, 0) + LCODPEDVEND;
        if (LCODGRUPO = EGRUPO1) then
          VENDAGRUPO1 = coalesce(VENDAGRUPO1, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO2) then
          VENDAGRUPO2 = coalesce(VENDAGRUPO2, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO3) then
          VENDAGRUPO3 = coalesce(VENDAGRUPO3, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO4) then
          VENDAGRUPO4 = coalesce(VENDAGRUPO4, 0) + LPRECOVEND;
        else
          VENDAGRUPOOUTROS = coalesce(VENDAGRUPOOUTROS, 0) + LPRECOVEND;
      end
      suspend;
    end
  end
  else if (ESTATUSPED = 'NÃO CANCELADO') then
  begin
    /* RELACIONO OS SUPERVISORES DO PERÍODO */
    for select distinct
      coalesce(V.CODVENDEDOR, 0),
      coalesce(V.NOME, 'VENDEDOR INEXISTENTE'),
      TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA'))
    from
      PEDVEND P
      left join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
      join PESSOA C on P.CODPESSOA = C.CODPESSOA
    where
      P.DT_SAIDA between :EDATAINI and :EDATAFIM and
      P.STATUSPED <> 'CANCELADO'
    into
      :CODIGO,
      :NOME,
      :CIDADE_1
    do
    begin
      VENDAGRUPO1      = 0;
      VENDAGRUPO2      = 0;
      VENDAGRUPO3      = 0;
      VENDAGRUPO4      = 0;
      VENDAGRUPOOUTROS = 0;
      QTDPEDIDOS       = 0;
      /* CALCULO OS TOTAIS DE CADA GRUPO */
      for select
        PR.CODGRUPO,
        coalesce(sum(PI.PRECOVEND - PI.PERDA), 0),
        count(distinct P.CODPEDVEND)
      from
        PEDVENDITEM PI
        join PEDVEND P on PI.CODPEDVEND = P.CODPEDVEND
        join PESSOA C on P.CODPESSOA = C.CODPESSOA
        join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
        join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
      where
        TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA')) = :CIDADE_1 and
        coalesce(P.CODVENDEDOR, 0)                    = :CODIGO and
        P.DT_SAIDA                              between :EDATAINI and :EDATAFIM and
        P.STATUSPED <> 'CANCELADO'
      group by
        1
      into
        :LCODGRUPO,
        :LPRECOVEND,
        :LCODPEDVEND
      do
      begin
        QTDPEDIDOS = coalesce(QTDPEDIDOS, 0) + LCODPEDVEND;
        if (LCODGRUPO = EGRUPO1) then
          VENDAGRUPO1 = coalesce(VENDAGRUPO1, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO2) then
          VENDAGRUPO2 = coalesce(VENDAGRUPO2, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO3) then
          VENDAGRUPO3 = coalesce(VENDAGRUPO3, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO4) then
          VENDAGRUPO4 = coalesce(VENDAGRUPO4, 0) + LPRECOVEND;
        else
          VENDAGRUPOOUTROS = coalesce(VENDAGRUPOOUTROS, 0) + LPRECOVEND;
      end
      suspend;
    end
  end
  else
  begin
    /* RELACIONO OS SUPERVISORES DO PERÍODO */
    for select distinct
      coalesce(V.CODVENDEDOR, 0),
      coalesce(V.NOME, 'VENDEDOR INEXISTENTE'),
      TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA'))
    from
      PEDVEND P
      left join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
      join PESSOA C on P.CODPESSOA = C.CODPESSOA
    where
      P.DT_SAIDA between :EDATAINI and :EDATAFIM and
      P.STATUSPED      = :ESTATUSPED
    into
      :CODIGO,
      :NOME,
      :CIDADE_1
    do
    begin
      VENDAGRUPO1      = 0;
      VENDAGRUPO2      = 0;
      VENDAGRUPO3      = 0;
      VENDAGRUPO4      = 0;
      VENDAGRUPOOUTROS = 0;
      QTDPEDIDOS       = 0;
      /* CALCULO OS TOTAIS DE CADA GRUPO */
      for select
        PR.CODGRUPO,
        coalesce(sum(PI.PRECOVEND - PI.PERDA), 0),
        count(distinct P.CODPEDVEND)
      from
        PEDVENDITEM PI
        join PEDVEND P on PI.CODPEDVEND = P.CODPEDVEND
        join PESSOA C on P.CODPESSOA = C.CODPESSOA
        join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
        join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
      where
        TRIM(coalesce(nullif(C.CIDADE_1,''), 'CIDADE NAO CADASTRADA')) = :CIDADE_1 and
        coalesce(P.CODVENDEDOR, 0)                    = :CODIGO and
        P.DT_SAIDA                              between :EDATAINI and :EDATAFIM and
        P.STATUSPED                                   = :ESTATUSPED
      group by
        1
      into
        :LCODGRUPO,
        :LPRECOVEND,
        :LCODPEDVEND
      do
      begin
        QTDPEDIDOS = coalesce(QTDPEDIDOS, 0) + LCODPEDVEND;
        if (LCODGRUPO = EGRUPO1) then
          VENDAGRUPO1 = coalesce(VENDAGRUPO1, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO2) then
          VENDAGRUPO2 = coalesce(VENDAGRUPO2, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO3) then
          VENDAGRUPO3 = coalesce(VENDAGRUPO3, 0) + LPRECOVEND;
        else if (LCODGRUPO = EGRUPO4) then
          VENDAGRUPO4 = coalesce(VENDAGRUPO4, 0) + LPRECOVEND;
        else
          VENDAGRUPOOUTROS = coalesce(VENDAGRUPOOUTROS, 0) + LPRECOVEND;
      end
      suspend;
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE SPNFENTRADAITENS(
    ECODNFENTRADA INTEGER,
    EGEN_CODNFENTRADA_TEMP VARCHAR(40),
    ETIPOCONSULTA VARCHAR(1))
RETURNS (
    CODNFENTRADAITENS INTEGER,
    CODNFENTRADA INTEGER,
    DESPFRONTVLRITEM DOUBLE PRECISION,
    CODPRODFILHO INTEGER,
    CODPESQUISA VARCHAR(30),
    IPIPERC DOUBLE PRECISION,
    QTD DOUBLE PRECISION,
    PRODVLR DOUBLE PRECISION,
    DIFICMS DOUBLE PRECISION,
    DESPESASRATEADAS DOUBLE PRECISION,
    FRETERATEADO DOUBLE PRECISION,
    SEGURORATEADO DOUBLE PRECISION,
    DESCONTORATEADO DOUBLE PRECISION,
    PRECOSUGERIDO DOUBLE PRECISION,
    ATUALIZAPRECO VARCHAR(1),
    PRECOCOMPRAANTERIOR DOUBLE PRECISION,
    CODUNIDADE INTEGER,
    CODPEDCPR INTEGER,
    CODPEDCPRITENS INTEGER,
    US_CADAST VARCHAR(45),
    DT_CADAST TIMESTAMP,
    US_MODIFI VARCHAR(45),
    DT_MODIFI TIMESTAMP,
    MARKUP1 DOUBLE PRECISION,
    MARKUP2 DOUBLE PRECISION,
    MARKUP3 DOUBLE PRECISION,
    MARKUP4 DOUBLE PRECISION,
    MARKUP5 DOUBLE PRECISION,
    MARKUP6 DOUBLE PRECISION,
    VALORTOTAL DOUBLE PRECISION,
    ATZMARK CHAR(1),
    ATZPREC CHAR(1),
    VL_IPIPERC DOUBLE PRECISION,
    VL_DIFICMS DOUBLE PRECISION,
    FRETEPERCLTDA DOUBLE PRECISION,
    FRETEVLRLTDA DOUBLE PRECISION,
    IPISOBREFRETE CHAR(1),
    ICMSSOBREFRETE CHAR(1),
    FRETEAVULSO DOUBLE PRECISION,
    CUSTOREPOSI DOUBLE PRECISION,
    CODCFOP INTEGER,
    CFOP_CFOP VARCHAR(4),
    QTDEM3 DOUBLE PRECISION,
    ALIQ_SUBS DOUBLE PRECISION,
    PERC_VA DOUBLE PRECISION,
    VA_VALOR DOUBLE PRECISION,
    BASE_SUBS DOUBLE PRECISION,
    VALOR_SUBS DOUBLE PRECISION,
    PESO DOUBLE PRECISION,
    GNRE_TOTAL DOUBLE PRECISION,
    TOTAL_NOTA DOUBLE PRECISION,
    CUSTO_UNIT_IPI_GNRE DOUBLE PRECISION,
    TOTAL_FRETE_PESO DOUBLE PRECISION,
    TOTAL_FRETE_VALOR DOUBLE PRECISION,
    CUSTO_TOTAL DOUBLE PRECISION,
    CUSTO_UNITARIO DOUBLE PRECISION,
    TOTALCOMIPI DOUBLE PRECISION,
    CUSTOUNITCOMIPI DOUBLE PRECISION,
    QTD_CAIXA DOUBLE PRECISION,
    VALOR_CAIXA DOUBLE PRECISION,
    QTDPECAS DOUBLE PRECISION,
    COD_PROD_MARGEM INTEGER,
    DESCTO_ITEM DOUBLE PRECISION,
    DESCTO_ABC CHAR(1),
    NFEI_DESCAUX VARCHAR(254),
    QTD_VIACEGA DOUBLE PRECISION,
    QTD_PEDIDO DOUBLE PRECISION,
    DT_FABRICACAO TIMESTAMP,
    DT_VALIDADE TIMESTAMP,
    SITUACAO_VALIDADE VARCHAR(20),
    FATORCONVERSAO DOUBLE PRECISION,
    DESCTO_ITEM_PERC DOUBLE PRECISION,
    PERC_REDUCAO DOUBLE PRECISION,
    REDUCAO_VALOR DOUBLE PRECISION,
    AUX_PESOEMB DOUBLE PRECISION,
    DESC_PRODFILHO_AUX VARCHAR(60),
    PRECOSUGERIDO1 DOUBLE PRECISION,
    PRECOSUGERIDO2 DOUBLE PRECISION,
    PRECOSUGERIDO3 DOUBLE PRECISION,
    PRECOSUGERIDO4 DOUBLE PRECISION,
    PRECOSUGERIDO5 DOUBLE PRECISION,
    PRECOSUGERIDO6 DOUBLE PRECISION,
    CODPRODUTO INTEGER,
    DESC_PRECOPRATICADO1 DOUBLE PRECISION,
    AUX_FATORPROD DOUBLE PRECISION,
    QTDPRODEMB DOUBLE PRECISION,
    AUX_COD3 VARCHAR(7),
    UNIDADE VARCHAR(15),
    CODPESQ1 VARCHAR(30),
    CODPESQ2 VARCHAR(30),
    PISPERC DOUBLE PRECISION,
    PISVALOR DOUBLE PRECISION,
    COFINSPERC DOUBLE PRECISION,
    COFINSVALOR DOUBLE PRECISION,
    FRETESOBREIPI VARCHAR(1),
    BASE_IPI DOUBLE PRECISION,
    STATUS VARCHAR(10),
    DESC_UNIDADE VARCHAR(15),
    DESC_CFOP_CFOP VARCHAR(4),
    NCM_CODIGO VARCHAR(8),
    DESCTO_ITEM_INCIDE_ICMS VARCHAR(1),
    DESP_PERC DOUBLE PRECISION,
    DESP_VALOR DOUBLE PRECISION,
    DESP_INCIDE_ICMS VARCHAR(1),
    SEG_PERC DOUBLE PRECISION,
    SEG_VALOR DOUBLE PRECISION,
    SEG_INCIDE_ICMS VARCHAR(1),
    TOTALPROD DOUBLE PRECISION,
    BASE_ICMS DOUBLE PRECISION,
    PREDUCAOST DOUBLE PRECISION,
    VREDUCAOST DOUBLE PRECISION,
    PISCST VARCHAR(3),
    COFINSCST VARCHAR(3),
    PRDF_CST_ORIGEM_MERCADORIA VARCHAR(1),
    PRDF_CST_TRIBICMS VARCHAR(3),
    PRDF_CST_IPIENTRADA VARCHAR(2),
    BASE_PIS DOUBLE PRECISION,
    BASE_COFINS DOUBLE PRECISION,
    DESCTO_ITEM_INCIDE_IPI VARCHAR(1),
    IPI_INCIDE_BC_ICMSST VARCHAR(1),
    ST_INFORMADOMANUAL VARCHAR(1),
    IPI_INCIDE_BC_ICMS VARCHAR(1),
    SERIE BLOB SUB_TYPE TEXT SEGMENT SIZE 4096,
    IPI_INCIDE_MVA VARCHAR(1),
    CODCENTCUSTO INTEGER,
    CODMAQUINA INTEGER,
    DESCRICAOCCUSTO VARCHAR(60),
    DESCRICAOCCUSTOSMASCARA VARCHAR(60),
    DESCRICAOMAQUINA VARCHAR(60),
    DIVIDIR_PELA_ENTRADA VARCHAR(1),
    GEN_CODNFENTRADA_TEMP VARCHAR(40),
    CEAN VARCHAR(60),
    DESPFRONTPERCITEM DOUBLE PRECISION,
    VALOR_UNITARIO_DOLAR DOUBLE PRECISION,
    VALOR_DOLAR_DIA DOUBLE PRECISION,
    CODNFENTRADAITENSCOMPRA INTEGER,
    VFCPST DOUBLE PRECISION,
    VBCFCPST DOUBLE PRECISION,
    PFCPST DOUBLE PRECISION,
    VICMSDESON DOUBLE PRECISION,
    MOTDESICMS INTEGER,
    XPEDIDO VARCHAR(15),
    NITEMPED VARCHAR(6),
    IDNFENTRADAITEM VARCHAR(40),
    PESOPECA DOUBLE PRECISION)
AS
declare variable LQTDPRODEMB_CAD_PROD double precision;
begin
  for select
    NI.CODNFENTRADAITENS,
    NI.CODNFENTRADA,
    NI.CODPRODFILHO,
    NI.CODPESQUISA,
    NI.IPIPERC,
    NI.QTD,
    NI.PRODVLR,
    NI.DIFICMS,
    NI.DESPESASRATEADAS,
    NI.FRETERATEADO,
    NI.SEGURORATEADO,
    NI.DESCONTORATEADO,
    NI.PRECOSUGERIDO,
    NI.ATUALIZAPRECO,
    NI.PRECOCOMPRAANTERIOR,
    NI.CODUNIDADE,
    NI.CODPEDCPR,
    NI.CODPEDCPRITENS,
    NI.US_CADAST,
    NI.DT_CADAST,
    NI.US_MODIFI,
    NI.DT_MODIFI,
    NI.MARKUP1,
    NI.MARKUP2,
    NI.MARKUP3,
    NI.MARKUP4,
    NI.MARKUP5,
    NI.MARKUP6,
    NI.VALORTOTAL,
    NI.ATZMARK,
    NI.ATZPREC,
    NI.VL_IPIPERC,
    NI.VL_DIFICMS,
    NI.FRETEPERCLTDA,
    NI.FRETEVLRLTDA,
    NI.IPISOBREFRETE,
    NI.ICMSSOBREFRETE,
    NI.FRETEAVULSO,
    NI.CUSTOREPOSI,
    NI.CODCFOP,
    NI.CFOP_CFOP,
    NI.QTDEM3,
    NI.ALIQ_SUBS,
    NI.PERC_VA,
    NI.VA_VALOR,
    NI.BASE_SUBS,
    NI.VALOR_SUBS,
    NI.PESO,
    NI.GNRE_TOTAL,
    NI.TOTAL_NOTA,
    NI.CUSTO_UNIT_IPI_GNRE,
    NI.TOTAL_FRETE_PESO,
    NI.TOTAL_FRETE_VALOR,
    NI.CUSTO_TOTAL,
    NI.CUSTO_UNITARIO,
    NI.TOTALCOMIPI,
    NI.CUSTOUNITCOMIPI,
    NI.QTD_CAIXA,
    NI.VALOR_CAIXA,
    NI.QTDPECAS,
    NI.COD_PROD_MARGEM,
    NI.DESCTO_ITEM,
    NI.DESCTO_ABC,
    NI.NFEI_DESCAUX,
    NI.QTD_VIACEGA,
    NI.QTD_PEDIDO,
    NI.DT_FABRICACAO,
    NI.DT_VALIDADE,
    NI.SITUACAO_VALIDADE,
    NI.FATORCONVERSAO,
    NI.DESCTO_ITEM_PERC,
    coalesce(NI.PERC_REDUCAO, 0) PERC_REDUCAO,
    NI.QTDPRODEMB,
    NI.PISPERC,
    NI.PISVALOR,
    NI.COFINSPERC,
    NI.COFINSVALOR,
    NI.FRETESOBREIPI,
    NI.BASE_IPI,
    NI.STATUS,
    NI.NCM_CODIGO,
    NI.DESCTO_ITEM_INCIDE_ICMS,
    NI.DESP_PERC,
    NI.DESP_VALOR,
    NI.DESP_INCIDE_ICMS,
    NI.SEG_PERC,
    NI.SEG_VALOR,
    NI.SEG_INCIDE_ICMS,
    NI.TOTALPROD,
    NI.BASE_ICMS,
    NI.REDUCAO_VALOR,
    NI.PREDUCAOST,
    NI.VREDUCAOST,
    NI.PISCST,
    NI.COFINSCST,
    coalesce(NI.PRDF_CST_ORIGEM_MERCADORIA,'0'),
    TRIM(coalesce(NI.PRDF_CST_TRIBICMS,'')),
    NI.PRDF_CST_IPIENTRADA,
    NI.DESPFRONTVLRITEM,
    NI.BASE_PIS,
    NI.BASE_COFINS,
    NI.DESCTO_ITEM_INCIDE_IPI,
    NI.IPI_INCIDE_BC_ICMSST,
    NI.ST_INFORMADOMANUAL,
    NI.IPI_INCIDE_BC_ICMS,
    NI.SERIE,
    NI.IPI_INCIDE_MVA,
    NI.CODCENTCUSTO,
    NI.CODMAQUINA,
    CC.DESCRICAO,
    CC.CODLIVRESEMMASK,
    M.MAQUINA,
    NI.GEN_CODNFENTRADA_TEMP,
    NI.CEAN,
    NI.DESPFRONTPERCITEM,
    NI.CODNFENTRADAITENSCOMPRA,
    NI.VFCPST,
    NI.VBCFCPST,
    NI.PFCPST,
    NI.VALOR_UNITARIO_DOLAR,
    NI.VALOR_DOLAR_DIA,
    NI.VICMSDESON,
    NI.MOTDESICMS,
    NI.XPEDIDO,
    NI.NITEMPED,
    NI.IDNFENTRADAITEM,
    NI.PESOPECA
  from
    NFENTRADAITENS NI
    left join CENTCUSTO CC on
      CC.CODCENTCUSTO = NI.CODCENTCUSTO
    left join MAQUINAS M on
      M.CODMAQUINA = NI.CODMAQUINA
  where
    NI.CODNFENTRADA = :ECODNFENTRADA or
    NI.GEN_CODNFENTRADA_TEMP = :EGEN_CODNFENTRADA_TEMP
  into
    CODNFENTRADAITENS,
    CODNFENTRADA,
    CODPRODFILHO,
    CODPESQUISA,
    IPIPERC,
    QTD,
    PRODVLR,
    DIFICMS,
    DESPESASRATEADAS,
    FRETERATEADO,
    SEGURORATEADO,
    DESCONTORATEADO,
    PRECOSUGERIDO,
    ATUALIZAPRECO,
    PRECOCOMPRAANTERIOR,
    CODUNIDADE,
    CODPEDCPR,
    CODPEDCPRITENS,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    MARKUP1,
    MARKUP2,
    MARKUP3,
    MARKUP4,
    MARKUP5,
    MARKUP6,
    VALORTOTAL,
    ATZMARK,
    ATZPREC,
    VL_IPIPERC,
    VL_DIFICMS,
    FRETEPERCLTDA,
    FRETEVLRLTDA,
    IPISOBREFRETE,
    ICMSSOBREFRETE,
    FRETEAVULSO,
    CUSTOREPOSI,
    CODCFOP,
    CFOP_CFOP,
    QTDEM3,
    ALIQ_SUBS,
    PERC_VA,
    VA_VALOR,
    BASE_SUBS,
    VALOR_SUBS,
    PESO,
    GNRE_TOTAL,
    TOTAL_NOTA,
    CUSTO_UNIT_IPI_GNRE,
    TOTAL_FRETE_PESO,
    TOTAL_FRETE_VALOR,
    CUSTO_TOTAL,
    CUSTO_UNITARIO,
    TOTALCOMIPI,
    CUSTOUNITCOMIPI,
    QTD_CAIXA,
    VALOR_CAIXA,
    QTDPECAS,
    COD_PROD_MARGEM,
    DESCTO_ITEM,
    DESCTO_ABC,
    NFEI_DESCAUX,
    QTD_VIACEGA,
    QTD_PEDIDO,
    DT_FABRICACAO,
    DT_VALIDADE,
    SITUACAO_VALIDADE,
    FATORCONVERSAO,
    DESCTO_ITEM_PERC,
    PERC_REDUCAO,
    QTDPRODEMB,
    PISPERC,
    PISVALOR,
    COFINSPERC,
    COFINSVALOR,
    FRETESOBREIPI,
    BASE_IPI,
    STATUS,
    NCM_CODIGO,
    DESCTO_ITEM_INCIDE_ICMS,
    DESP_PERC,
    DESP_VALOR,
    DESP_INCIDE_ICMS,
    SEG_PERC,
    SEG_VALOR,
    SEG_INCIDE_ICMS,
    TOTALPROD,
    BASE_ICMS,
    REDUCAO_VALOR,
    PREDUCAOST,
    VREDUCAOST,
    PISCST,
    COFINSCST,
    PRDF_CST_ORIGEM_MERCADORIA,
    PRDF_CST_TRIBICMS,
    PRDF_CST_IPIENTRADA,
    DESPFRONTVLRITEM,
    BASE_PIS,
    BASE_COFINS,
    DESCTO_ITEM_INCIDE_IPI,
    IPI_INCIDE_BC_ICMSST,
    ST_INFORMADOMANUAL,
    IPI_INCIDE_BC_ICMS,
    SERIE,
    IPI_INCIDE_MVA,
    CODCENTCUSTO,
    CODMAQUINA,
    DESCRICAOCCUSTO,
    DESCRICAOCCUSTOSMASCARA,
    DESCRICAOMAQUINA,
    GEN_CODNFENTRADA_TEMP,
    CEAN,
    DESPFRONTPERCITEM,
    CODNFENTRADAITENSCOMPRA,
    VFCPST,
    VBCFCPST,
    PFCPST,
    VALOR_UNITARIO_DOLAR,
    VALOR_DOLAR_DIA,
    VICMSDESON,
    MOTDESICMS,
    XPEDIDO,
    NITEMPED,
    IDNFENTRADAITEM,
    PESOPECA
  do
  begin
    TOTAL_FRETE_PESO = coalesce(TOTAL_FRETE_PESO,0);
    TOTAL_FRETE_VALOR = coalesce(TOTAL_FRETE_VALOR,0);
    CUSTO_UNIT_IPI_GNRE = coalesce(CUSTO_UNIT_IPI_GNRE,0);

    select
      coalesce(PF.PRDF_PESOEMBALAGEM,1)  AUX_PESOEMB,
      PF.DESCRICAO  DESC_PRODFILHO_AUX,
      coalesce(PF.PRECOSUGERIDO1,0) PRECOSUGERIDO1,
      coalesce(PF.PRECOSUGERIDO2,0) PRECOSUGERIDO2,
      coalesce(PF.PRECOSUGERIDO3,0) PRECOSUGERIDO3,
      coalesce(PF.PRECOSUGERIDO4,0) PRECOSUGERIDO4,
      coalesce(PF.PRECOSUGERIDO5,0) PRECOSUGERIDO5,
      coalesce(PF.PRECOSUGERIDO6,0) PRECOSUGERIDO6,
      PF.CODPRODUTO CODPRODUTO,
      coalesce(PF.PRECOPRATICADO1,0) DESC_PRECOPRATICADO1,
      coalesce(PF.FATORCONVERSAO,0) AUX_FATORPROD,
      coalesce(PF.CODPESQ3,'') AUX_COD3,
      PF.UNIDADE,
      PF.CODPESQ1,
      PF.CODPESQ2,
      PF.QTDEMBALAGEM
    from
      PRODFILHO PF
    where
      PF.CODPRODFILHO = :CODPRODFILHO
    into
      AUX_PESOEMB,
      DESC_PRODFILHO_AUX,
      PRECOSUGERIDO1,
      PRECOSUGERIDO2,
      PRECOSUGERIDO3,
      PRECOSUGERIDO4,
      PRECOSUGERIDO5,
      PRECOSUGERIDO6,
      CODPRODUTO,
      DESC_PRECOPRATICADO1,
      AUX_FATORPROD,
      AUX_COD3,
      UNIDADE,
      CODPESQ1,
      CODPESQ2,
      LQTDPRODEMB_CAD_PROD;

    select
      U.SIGLA,
      coalesce(U.DIVIDIR_PELA_ENTRADA, 'N')
    from
      UNIDADE U
    where
      U.CODUNIDADE = :CODUNIDADE
    into
      DESC_UNIDADE,
      DIVIDIR_PELA_ENTRADA;

    select
      C.CFOP
    from
      CFOP C
    where
      C.CODCFOP = :CODCFOP
    into
      DESC_CFOP_CFOP;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE TSCONTA(
    ECODCONTABANCO INTEGER)
RETURNS (
    CODCONTABANCO INTEGER,
    NRBANCO VARCHAR(10),
    CODIGOBENEFICIARIO VARCHAR(30),
    CODIGOEMPRESA VARCHAR(30),
    NRAGENCIA VARCHAR(45),
    NRAGENCIADV VARCHAR(1),
    NRCONTA VARCHAR(45),
    NRCONTADV VARCHAR(1))
AS
declare variable LCODBANCO integer;
begin
  CODCONTABANCO = :ECODCONTABANCO;
  select
    C.CODBANCO,
    C.CODIGOBENEFICIARIO, 
    C.CODIGOEMPRESA, 
    C.NRAGENCIA, 
    C.NRAGENCIADV, 
    C.NRCONTA, 
    C.NRCONTADV
  from
    CONTABANCO C
  where
    C.CODCONTABANCO = :ECODCONTABANCO
  into
    LCODBANCO,
    CODIGOBENEFICIARIO, 
    CODIGOEMPRESA, 
    NRAGENCIA, 
    NRAGENCIADV, 
    NRCONTA, 
    NRCONTADV;

  select
    TRIM(B.NRBANCO)
  from
    BANCO B
  where
    B.CODBANCO = :LCODBANCO
  into
    NRBANCO;
  suspend;
end^

SET TERM ; ^

-- SRIGHT

SET TERM ^ ;

ALTER TRIGGER TRG_ORC_MARMORE_BU
AS
begin
  if ((old.STATUS = 0) and (new.STATUS = 1)) then
  begin
    NEW.NRCONTRATO = RIGHT('0000'||extract(year from current_date),4)||RIGHT('00'||extract(month from current_date),2)||RIGHT('00000'||gen_id(GEN_ORC_MARMORE_FAT, 1),4);
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APC420(
    CODEMPRESA INTEGER,
    ARQ INTEGER,
    CODIGO INTEGER)
RETURNS (
    CODCUPOMZITEM INTEGER,
    CODCUPOMZ INTEGER,
    ALIQUOTA VARCHAR(10),
    PADRAO VARCHAR(10),
    SEQUENCIA VARCHAR(2),
    VALOR DOUBLE PRECISION,
    CST VARCHAR(4),
    TRIBUTADO VARCHAR(1),
    CFOP VARCHAR(4),
    BASEICMS DOUBLE PRECISION,
    ICMS DOUBLE PRECISION,
    VALORICMS DOUBLE PRECISION,
    VALORPIS DOUBLE PRECISION,
    VALORCOFINS DOUBLE PRECISION)
AS
declare variable PARAM_CFOP varchar(4);
declare variable PARAM_CFOPST varchar(4);
declare variable SQL varchar(1000);
declare variable NUM integer;
begin
  SQL = 'SELECT
    COALESCE(A.PARAM_CFOP, ''N''),
    COALESCE(A.PARAM_CFOPST, ''N'')
  FROM
    APFISCAL A
  WHERE
    A.ARQ = ' || :ARQ || ' AND ' || 'A.CODEMPRESA = ' || :CODEMPRESA;

  execute statement
    SQL
  into
    PARAM_CFOP,
    PARAM_CFOPST;

  for select
    I.CODCUPOMZITEM,
    I.CODCUPOMZ,
    I.ALIQUOTA,
    I.PADRAO,
    I.SEQUENCIA,
    I.VALOR,
    I.ICMS,
    I.PERCENTUAL,
    I.TRIBUTADO
  from
    APCUPOMZITEM I
  where
    I.CODCUPOMZ          = :CODIGO and
    coalesce(I.VALOR, 0) > 0 and
    I.PADRAO not in ('Can-T','Can-S','Can-O')
  order by
    1
  into
    CODCUPOMZITEM,
    CODCUPOMZ,
    ALIQUOTA,
    PADRAO,
    SEQUENCIA,
    VALOR,
    VALORICMS,
    ICMS,
    TRIBUTADO
  do
  begin
    VALORPIS    = 0;
    VALORCOFINS = 0;
    SEQUENCIA   = RIGHT('0' || SEQUENCIA, 2);
    BASEICMS    = VALOR;
    NUM         = 1;

    if (TRIBUTADO = '0') then
    begin
      CST      = '040';
      CFOP     = PARAM_CFOP;
      BASEICMS = 0;
      NUM      = NUM + cast(TRIBUTADO as integer);
      ALIQUOTA = substring(ALIQUOTA from 1 for 1) || NUM;
    end else
    if (TRIBUTADO = '1') then
    begin
      CST      = '000';
      CFOP     = PARAM_CFOP;
      BASEICMS = VALOR;
    end
    else
    if (TRIBUTADO = '2') then
    begin
      CST      = '070';
      CFOP     = PARAM_CFOP;
      BASEICMS = VALOR;
    end
    else
    if (TRIBUTADO = '3') then
    begin
      CST      = '060';
      CFOP     = PARAM_CFOPST;
      BASEICMS = 0;
      NUM      = NUM + cast(TRIBUTADO as integer);
      ALIQUOTA = substring(ALIQUOTA from 1 for 1) || NUM;
    end
    else
    if (TRIBUTADO = '4') then
    begin
      CST      = '041';
      CFOP     = PARAM_CFOP;
      BASEICMS = 0;
      NUM      = NUM + cast(TRIBUTADO as integer);
      ALIQUOTA = substring(ALIQUOTA from 1 for 1) || NUM;
    end
    else
    if (TRIBUTADO = '5') then
    begin
      CST      = '090';
      CFOP     = PARAM_CFOP;
      BASEICMS = VALOR;
    end
    else
    if (TRIBUTADO = '6') then
    begin
      CST      = '040';
      CFOP     = PARAM_CFOP;
      BASEICMS = 0;
      NUM      = NUM + cast(TRIBUTADO as integer);
      ALIQUOTA = substring(ALIQUOTA from 1 for 2) || NUM;
    end
    else
    if (TRIBUTADO = '7') then
    begin
      CST      = '041';
      CFOP     = PARAM_CFOP;
      BASEICMS = 0;
      NUM      = NUM + cast(TRIBUTADO as integer);
      ALIQUOTA = substring(ALIQUOTA from 1 for 2) || NUM;
    end
    else
    if (TRIBUTADO = '8') then
    begin
      CST      = '060';
      CFOP     = PARAM_CFOPST;
      BASEICMS = 0;
      NUM      = NUM + cast(TRIBUTADO as integer);
      ALIQUOTA = substring(ALIQUOTA from 1 for 2) || NUM;
    end

    VALOR       = cast(VALOR as numeric(18,2));
    VALORPIS    = coalesce(VALORPIS, 0);
    VALORCOFINS = coalesce(VALORCOFINS, 0);

    if ((PADRAO in ('AT','AS','AO','DT','DS','DO','Can-T','Can-S','Can-O','IOF','OPNF'))) then
    begin
      TRIBUTADO = null;
      CFOP      = null;
      CST       = null;
      BASEICMS  = 0;
      VALORICMS = 0;
      ICMS      = 0;
    end

    if ((ARQ = 3) and (PADRAO not in ('AT','AS','AO','DT','DS','DO','Can-T','Can-S','Can-O','IOF','OPNF','FSn','ISn','NSn'))) then
      suspend;
    if (ARQ = 2) then
      suspend;
  end
  if (exists(select
    I.CODCUPOMZITEM,
    I.CODCUPOMZ,
    I.ALIQUOTA,
    I.PADRAO,
    I.SEQUENCIA,
    I.VALOR,
    I.ICMS,
    I.PERCENTUAL,
    I.TRIBUTADO
  from
    APCUPOMZITEM I
  where
    I.CODCUPOMZ          = :CODIGO and
    coalesce(I.VALOR, 0) > 0 and
    I.PADRAO in ('Can-T','Can-S','Can-O'))) then
  begin
    for select
      I.CODCUPOMZITEM,
      I.CODCUPOMZ,
      I.ALIQUOTA,
      I.PADRAO,
      I.SEQUENCIA,
      I.VALOR,
      I.ICMS,
      I.PERCENTUAL,
      I.TRIBUTADO
    from
      APCUPOMZITEM I
    where
      I.CODCUPOMZ          = :CODIGO and
      coalesce(I.VALOR, 0) > 0 and
      I.PADRAO in ('Can-T','Can-S','Can-O')
    order by
      1
    into
      CODCUPOMZITEM,
      CODCUPOMZ,
      ALIQUOTA,
      PADRAO,
      SEQUENCIA,
      VALOR,
      VALORICMS,
      ICMS,
      TRIBUTADO
    do
    begin
      VALOR       = cast(VALOR as numeric(18,2));
      VALORPIS    = coalesce(VALORPIS, 0);
      VALORCOFINS = coalesce(VALORCOFINS, 0);
    
      if ((PADRAO in ('AT','AS','AO','DT','DS','DO','Can-T','Can-S','Can-O','IOF','OPNF'))) then
      begin
        TRIBUTADO = null;
        CFOP      = null;
        CST       = null;
        BASEICMS  = 0;
        VALORICMS = 0;
        ICMS      = 0;
      end
  
      if ((ARQ = 3) and (PADRAO not in ('AT','AS','AO','DT','DS','DO','Can-T','Can-S','Can-O','IOF','OPNF','FSn','ISn','NSn'))) then
        suspend;
      if (ARQ = 2) then
        suspend;  
    end
  end
  else
  begin
    ALIQUOTA    = 'Can-T';
    PADRAO      = 'Can-T';
    VALOR       = 0;
    VALORPIS    = 0;
    VALORCOFINS = 0;
    TRIBUTADO   = null;
    CFOP        = null;
    CST         = null;
    BASEICMS    = 0;
    VALORICMS   = 0;
    ICMS        = 0;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APC481(
    CODEMPRESA INTEGER,
    CODIGO INTEGER)
RETURNS (
    CST VARCHAR(2),
    CODPRODFILHO INTEGER,
    VALOR DOUBLE PRECISION,
    BASE NUMERIC(18,2),
    PIS DOUBLE PRECISION,
    VALORPIS DOUBLE PRECISION,
    COFINS DOUBLE PRECISION,
    VALORCOFINS DOUBLE PRECISION)
AS
declare variable CODCUPOM integer;
declare variable LRECEITAEFD varchar(3);
declare variable LEMISSAO timestamp;
declare variable LCOD_CTA varchar(255);
begin
  delete from
    CODTEMP
  where
    1=1;

  for select
    C.CODCUPOM,
    C.EMISSAO
  from
    APCUPOM C
  where
    C.CODCUPOMZ  = :CODIGO and
    C.CODEMPRESA = :CODEMPRESA
  into
    CODCUPOM,
    LEMISSAO
  do
  begin
    execute procedure
      INS_CODTEMP(:CODCUPOM);
  end

  select
    COD_CTA
  from
    AP0500RETORNAPLACONTABIL('ECF')
  into
    LCOD_CTA;

  for select
    I.CSTPC,
    I.CODPRODFILHO,
    I.PIS,
    I.COFINS,
    sum(I.PRECOLIQ),
    sum(I.PRECOLIQ),
    sum(I.VALORPIS),
    sum(I.VALORCOFINS)
  from
    CODTEMP C
    join APCUPOMITEM I on
      C.CODIGO = I.CODCUPOM
  where
    coalesce(I.STATUSCUPOMITEM, 1) = 0
  group by
    1,
    2,
    3,
    4
  into
    :CST,
    :CODPRODFILHO,
    :PIS,
    :COFINS,
    :VALOR,
    :BASE,
    :VALORPIS,
    :VALORCOFINS
  do
  begin
    if (CST in ('04', '05', '06', '07', '08', '09')) then
    begin
      select
        F.RECEITAEFD
      from
        PRODFILHO F
      where
        F.CODPRODFILHO = :CODPRODFILHO
      into
        LRECEITAEFD;

      execute procedure STP_APFISCALEFDM410(
        extract(year from :LEMISSAO) || RIGHT('00' || extract(month from :LEMISSAO), 2),
        :CST,
        :LCOD_CTA,
        :LRECEITAEFD,
        :BASE);

      execute procedure STP_APFISCALEFDM810(
        extract(year from :LEMISSAO) || RIGHT('00' || extract(month from :LEMISSAO), 2),
        :CST,
        :LCOD_CTA,
        :LRECEITAEFD,
        :BASE);
    end

    if ((CST <> '06') and (CST <> '07') and (CST <> '08') and (CST <> '09')) then
    begin
      BASE        = cast(BASE as numeric(18,2));
      PIS         = cast(PIS as numeric(18,2));
      VALORPIS    = cast(VALORPIS as numeric(18,2));
      COFINS      = cast(COFINS as numeric(18,2));
      VALORCOFINS = cast(VALORCOFINS as numeric(18,2));
    end else
    begin
      BASE        = 0;
      PIS         = 0;
      VALORPIS    = 0;
      COFINS      = 0;
      VALORCOFINS = 0;
    end

    suspend;
  end

  delete from
    CODTEMP
  where
    1=1;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APC600(
    CODEMPRESA INTEGER,
    DTINI DATE,
    DTFIM DATE)
RETURNS (
    CODIGO INTEGER,
    CPF VARCHAR(11),
    CNPJ VARCHAR(14),
    MODELO VARCHAR(2),
    SITUACAO VARCHAR(2),
    ECF VARCHAR(10),
    SERIEECF VARCHAR(20),
    CRO VARCHAR(10),
    CRZ VARCHAR(10),
    DOCUMENTO VARCHAR(10),
    COP VARCHAR(4),
    DATA DATE,
    VALOR DOUBLE PRECISION,
    CANCELAMENTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    ACRESCIMO DOUBLE PRECISION,
    ICMSBASE DOUBLE PRECISION,
    ICMSVALOR DOUBLE PRECISION,
    ISENTO_ICMS DOUBLE PRECISION,
    NAOTRIBUTADO_ICMS DOUBLE PRECISION,
    SUBSTITUTO_ICMS DOUBLE PRECISION,
    ISSBASE DOUBLE PRECISION,
    ISSVALOR DOUBLE PRECISION,
    ISENTO_ISS DOUBLE PRECISION,
    NAOTRIBUTADO_ISS DOUBLE PRECISION,
    SUBSTITUTO_ISS DOUBLE PRECISION)
AS
declare variable LDTINI timestamp;
declare variable LDTFIM timestamp;
declare variable CPFCGC varchar(30);
declare variable PESSOA smallint;
declare variable CODPESSOA integer;
declare variable CODCUPOMZ integer;
begin
  LDTINI = cast(DTINI||' 00:00:00' as timestamp);
  LDTFIM = cast(DTFIM||' 23:59:59' as timestamp);
  CANCELAMENTO = 0;

  for select
    C.CODCUPOM,
    coalesce(C.CODPESSOA, 0) CODPESSOA,
    C.STATUSCUPOM,
    C.ECF,
    C.COO,
    C.EMISSAO,
    C.CODCUPOMZ,
    C.VALORPAGO,
    C.DESC_VALOR,
    C.ACRES_VALOR
  from
    APCUPOM C
  where
    C.EMISSAO            between :LDTINI and :LDTFIM and
    coalesce(C.CODEMPRESA, 1)  = :CODEMPRESA and
    coalesce(C.STATUSCUPOM, 0) = 0
  into
    CODIGO,
    CODPESSOA,
    SITUACAO,
    ECF,
    DOCUMENTO,
    DATA,
    CODCUPOMZ,
    VALOR,
    DESCONTO,
    ACRESCIMO
  do
  begin
    MODELO = '2D';
    COP    = 'SP10';
    CPF    = '';
    CNPJ   = '';
    CRO    = '';
    CRZ    = '';

    if (SITUACAO = '0') then
      SITUACAO = '00';
    else
    if (SITUACAO = '1') then
      SITUACAO = '90';

    select
      Z.CRO,
      Z.CONTADORZ
    from
      APCUPOMZ Z
    where
      Z.CODCUPOMZ  = :CODCUPOMZ and
      Z.CODEMPRESA = :CODEMPRESA
    into
      CRO,
      CRZ;

    select first 1
      E.SERIEECF
    from
      ECF E
    where
      RIGHT('0' || E.ORDEM, 3) = RIGHT('0' || :ECF, 3) and
      E.CODEMPRESA            = :CODEMPRESA
    into
      SERIEECF;

    if (CODPESSOA > 0) then
    begin
      select
        P.CPFCGC,
        coalesce(P.PESSOA,1)
      from
        PESSOA P
      where
        P.CODPESSOA = :CODPESSOA
        and P.CPFCGC <> '000.000.000-00'
      into
        CPFCGC,
        PESSOA;

      select F.STRRESULT from FU_GETTIRAMASCARA(:CPFCGC) F into CPFCGC;
      select F.R_TRIM from FU_TRIM(:CPFCGC) F into CPFCGC;
 
      if (PESSOA = 1) then
       CPF = CPFCGC;
      else
        CNPJ = CPFCGC;
    end

    ICMSBASE          = 0;
    ICMSVALOR         = 0;
    ISENTO_ICMS       = 0;
    NAOTRIBUTADO_ICMS = 0;
    SUBSTITUTO_ICMS   = 0;
    ISSBASE           = 0;
    ISSVALOR          = 0;
    ISENTO_ISS        = 0;
    NAOTRIBUTADO_ISS  = 0;
    SUBSTITUTO_ISS    = 0;

    select
      sum(SP.ICMSBASE),
      sum(SP.ICMSVALOR),
      sum(SP.ISENTO_ICMS),
      sum(SP.NAOTRIBUTADO_ICMS),
      sum(SP.SUBSTITUTO_ICMS),
      sum(SP.ISSBASE),
      sum(SP.ISSVALOR),
      sum(SP.ISENTO_ISS),
      sum(SP.NAOTRIBUTADO_ISS),
      sum(SP.SUBSTITUTO_ISS)
    from
      APC610(:CODIGO, null) SP
    into
      ICMSBASE,
      ICMSVALOR,
      ISENTO_ICMS,
      NAOTRIBUTADO_ICMS,
      SUBSTITUTO_ICMS,
      ISSBASE,
      ISSVALOR,
      ISENTO_ISS,
      NAOTRIBUTADO_ISS,
      SUBSTITUTO_ISS;

    VALOR             = cast(VALOR as numeric (18,2));
    ACRESCIMO         = cast(ACRESCIMO as numeric (18,2));
    DESCONTO          = cast(DESCONTO as numeric (18,2));
    ACRESCIMO         = cast(ACRESCIMO as numeric (18,2));
    CANCELAMENTO      = cast(CANCELAMENTO as numeric (18,2));

    ICMSBASE          = cast(ICMSBASE as numeric (18,2));
    ICMSVALOR         = cast(ICMSVALOR as numeric (18,2));
    ISENTO_ICMS       = cast(ISENTO_ICMS as numeric (18,2));
    NAOTRIBUTADO_ICMS = cast(NAOTRIBUTADO_ICMS as numeric (18,2));
    SUBSTITUTO_ICMS   = cast(SUBSTITUTO_ICMS as numeric (18,2));
    ISSBASE           = cast(ISSBASE as numeric (18,2));
    ISSVALOR          = cast(ISSVALOR as numeric (18,2));
    ISENTO_ISS        = cast(ISENTO_ISS as numeric (18,2));
    NAOTRIBUTADO_ISS  = cast(NAOTRIBUTADO_ISS as numeric (18,2));
    SUBSTITUTO_ISS    = cast(SUBSTITUTO_ISS as numeric (18,2));
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APFORTESCCF(
    CODCUPOMZ INTEGER,
    CODEMPRESA INTEGER)
RETURNS (
    CODCUPOM INTEGER,
    COO VARCHAR(10),
    SITUACAO VARCHAR(1),
    EMISSAO DATE,
    ECF VARCHAR(4),
    DESC_VALOR DOUBLE PRECISION,
    ACRES_VALOR DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    VALOR_SERVICOS DOUBLE PRECISION)
AS
declare variable STATUSCUPOM smallint;
begin
  for select
    APCUPOM.CODCUPOM,
    APCUPOM.COO,
    APCUPOM.EMISSAO,
    APCUPOM.ECF,
    APCUPOM.DESC_VALOR,
    APCUPOM.VALORPAGO,
    --APCUPOM.VALOR_TOTAL,
    APCUPOM.ACRES_VALOR,
    APCUPOM.STATUSCUPOM
  from
    APCUPOM
  where
    APCUPOM.CODCUPOMZ =:CODCUPOMZ and
    coalesce(APCUPOM.CODEMPRESA,1) =:CODEMPRESA
    --and coalesce(APCUPOM.STATUSCUPOM,0) = 0
  order by 2
  into
    :CODCUPOM,
    :COO,
    :EMISSAO,
    :ECF,
    :DESC_VALOR,
    :VALOR_TOTAL,
    :ACRES_VALOR,
    :STATUSCUPOM
  do
  begin
    if (STATUSCUPOM = 0) then
      SITUACAO = '0';
    else
      SITUACAO = '2';

    VALOR_SERVICOS = 0;
    ECF            =  RIGHT('000' || cast(cast(ECF as integer) as varchar(4)) ,3);
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APFORTESCFC(
    DTINI DATE,
    DTFIM DATE,
    CODEMPRESA INTEGER)
RETURNS (
    TIPO VARCHAR(3),
    ESTABELECIMENTO VARCHAR(4),
    CODCUPOMZ INTEGER,
    DATA DATE,
    ORDEM VARCHAR(4),
    ECF VARCHAR(4),
    COOZ VARCHAR(10),
    COOINICIAL VARCHAR(10),
    COOFINAL VARCHAR(10),
    CRZ VARCHAR(10),
    CRO VARCHAR(10),
    VENDABRUTA DOUBLE PRECISION,
    VENDALIQUIDA DOUBLE PRECISION,
    GT DOUBLE PRECISION,
    CANCELAMENTOS DOUBLE PRECISION,
    DESCONTOS DOUBLE PRECISION,
    ACRESCIMOS DOUBLE PRECISION,
    SUBSTITUICAO DOUBLE PRECISION,
    ISENTAS DOUBLE PRECISION,
    NAOTRIBUTADOS DOUBLE PRECISION,
    SERVICOS DOUBLE PRECISION)
AS
begin
  TIPO            = 'CFC';
  ESTABELECIMENTO = '0001';

  CODEMPRESA      = cast(coalesce(:CODEMPRESA,1) as integer);

  for select
    APCUPOMZ.CODCUPOMZ,
 --   APCUPOM.CODCUPOM,
    APCUPOMZ.DATAMOVIMENTO,
    APCUPOMZ.ECF,
    APCUPOMZ.COOZ,
    APCUPOMZ.COOINICIAL,
    APCUPOMZ.COOFINAL,
    APCUPOMZ.CONTADORZ,
    APCUPOMZ.CRO,
    APCUPOMZ.VENDABRUTA, 
    APCUPOMZ.VENDALIQUIDA,
    APCUPOMZ.TOTALIZACAOGERAL, 
    APCUPOMZ.CANCELAMENTOS, 
    APCUPOMZ.DESCONTOS, 
    APCUPOMZ.SUBSTITUICAO, 
    APCUPOMZ.ISENTAS, 
    APCUPOMZ.NAOTRIBUTADOS,
    APCUPOMZ.ACRESCIMOS
  from
    APCUPOMZ
--    join APCUPOM on
--      APCUPOM.CODCUPOMZ = APCUPOMZ.CODCUPOMZ
  where
    APCUPOMZ.DATAMOVIMENTO between :DTINI and :DTFIM and
    coalesce(APCUPOMZ.CODEMPRESA,1) =:CODEMPRESA and
    coalesce(APCUPOMZ.VENDALIQUIDA,0) > 0
  into
    :CODCUPOMZ,
--    :CODCUPOM,
    :DATA,
    :ECF,
    :COOZ,
    :COOINICIAL,
    :COOFINAL,
    :CRZ,
    :CRO,
    :VENDABRUTA,
    :VENDALIQUIDA,
    :GT,
    :CANCELAMENTOS,
    :DESCONTOS,
    :SUBSTITUICAO,
    :ISENTAS,
    :NAOTRIBUTADOS,
    :ACRESCIMOS
  do
  begin
    ORDEM    = ECF;
    ECF      =  RIGHT('000' || cast(cast(ECF as integer) as varchar(4)) ,3);
    SERVICOS = 0;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APSPED_E113_PE020022(
    DTINI DATE,
    DTFIM DATE)
RETURNS (
    CODNFENTRADA INTEGER,
    DOCUMENTO VARCHAR(15),
    SERIE VARCHAR(3),
    UF VARCHAR(2),
    DTENTRADA DATE,
    TOTNOTVLR DOUBLE PRECISION,
    VALOR DOUBLE PRECISION,
    VALOR_SISTEMATICA DOUBLE PRECISION,
    CODPESSOA INTEGER,
    MODELO INTEGER,
    CHAVENFE VARCHAR(54))
AS
declare variable LMES_INI integer;
declare variable LANO_INI integer;
declare variable LMES_FIM integer;
declare variable LANO_FIM integer;
declare variable LDATA_INI date;
declare variable LDATA_FIM date;
declare variable LCONTADOR integer;
BEGIN
  --Data inicial Mês e Ano
  LMES_INI = extract (month from cast(DTINI as date));
  LANO_INI = extract (year from cast(DTINI as date));
  LCONTADOR = LMES_INI - 1;

  --Data final Mês e Ano
  LMES_FIM = extract (month from cast(DTFIM as date));
  LANO_FIM = extract (year from cast(DTFIM as date));

  if (LCONTADOR <> 0) then
    LDATA_INI = '01.'|| RIGHT('00' || cast( :LCONTADOR as varchar(2)), 2 ) || '.' || :LANO_INI;

  if (LCONTADOR = 12) then
  begin
    LDATA_FIM = '31.12.' || :LANO_FIM;
  end
  else if (LCONTADOR = 0) then
  begin
    LDATA_INI = '01.12' || '.' || (:LANO_INI - 1);
    LDATA_FIM = '31.12' || '.' || (:LANO_FIM - 1);
  end
  else
    LDATA_FIM = '01.' || RIGHT('00' || cast( (:LCONTADOR + 1) as varchar(2)), 2)  || '.' || :LANO_FIM;

  if (LCONTADOR <> 0) then
  begin
    FOR
      select
        CODNFENTRADA, 
        DOCUMENTO,
        SERIE,                         
        UF, 
        DTENTRADA, 
        TOTNOTVLR, 
        VALOR, 
        VALOR_SISTEMATICA,
        CODPESSOA,
        MODELO,
        CHAVENFE
      from
        ATACAMAX_COMPRASFORA(:LDATA_INI,(:LDATA_FIM - 1))
      where
        VALOR_SISTEMATICA > 0
      INTO
        CODNFENTRADA,
        DOCUMENTO,
        SERIE,
        UF,
        DTENTRADA,
        TOTNOTVLR,
        VALOR,
        VALOR_SISTEMATICA,
        CODPESSOA,
        MODELO,
        CHAVENFE
    DO
    BEGIN
      SUSPEND;
    END
  end
  else
  begin
    FOR
      select
        CODNFENTRADA, 
        DOCUMENTO,
        SERIE,                         
        UF, 
        DTENTRADA, 
        TOTNOTVLR, 
        VALOR, 
        VALOR_SISTEMATICA,
        CODPESSOA,
        MODELO,
        CHAVENFE
      from
        ATACAMAX_COMPRASFORA(:LDATA_INI,:LDATA_FIM)
      where
        VALOR_SISTEMATICA > 0
      INTO
        CODNFENTRADA,
        DOCUMENTO,
        SERIE,
        UF,
        DTENTRADA,
        TOTNOTVLR,
        VALOR,
        VALOR_SISTEMATICA,
        CODPESSOA,
        MODELO,
        CHAVENFE
    DO
    BEGIN
      SUSPEND;
    END
  end
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APSPED_E113_PE020062(
    DTINI DATE,
    DTFIM DATE)
RETURNS (
    CODNFENTRADA INTEGER,
    DOCUMENTO VARCHAR(15),
    SERIE VARCHAR(3),
    UF VARCHAR(2),
    DTENTRADA DATE,
    TOTNOTVLR DOUBLE PRECISION,
    VALOR DOUBLE PRECISION,
    VALOR_SISTEMATICA DOUBLE PRECISION,
    CODPESSOA INTEGER,
    MODELO INTEGER,
    CHAVENFE VARCHAR(54))
AS
declare variable LMES_INI integer;
declare variable LANO_INI integer;
declare variable LMES_FIM integer;
declare variable LANO_FIM integer;
declare variable LDATA_INI date;
declare variable LDATA_FIM date;
declare variable LCONTADOR integer;
BEGIN
  --Data inicial Mês e Ano
  LMES_INI = extract (month from cast(DTINI as date));
  LANO_INI = extract (year from cast(DTINI as date));
  LCONTADOR = LMES_INI - 1;

  --Data final Mês e Ano
  LMES_FIM = extract (month from cast(DTFIM as date));
  LANO_FIM = extract (year from cast(DTFIM as date));

  if (LCONTADOR <> 0) then
    LDATA_INI = '01.'|| RIGHT('00' || cast( :LCONTADOR as varchar(2)), 2 ) || '.' || :LANO_INI;

  if (LCONTADOR = 12) then
  begin
    LDATA_FIM = '31.12.' || :LANO_FIM;
  end
  else if (LCONTADOR = 0) then
  begin
    LDATA_INI = '01.12' || '.' || (:LANO_INI - 1);
    LDATA_FIM = '31.12' || '.' || (:LANO_FIM - 1);
  end
  else
    LDATA_FIM = '01.' || RIGHT('00' || cast( (:LCONTADOR + 1) as varchar(2)), 2)  || '.' || :LANO_FIM;

  if (LCONTADOR <> 0) then
  begin
    for select
      CODNFENTRADA, 
      DOCUMENTO,
      SERIE,                         
      UF,
      DTENTRADA,
      TOTNOTVLR,
      VALOR,
      VALOR_SISTEMATICA,
      RCODPESSOA,
      RMODELO,
      RCHAVENFE
    from
      ATACAMAX_COMPRASDENTRO_SIS(:LDATA_INI,(:LDATA_FIM - 1))
    where
      VALOR_SISTEMATICA > 0
    into
      CODNFENTRADA,
      DOCUMENTO,
      SERIE,                         
      UF,
      DTENTRADA,
      TOTNOTVLR,
      VALOR,
      VALOR_SISTEMATICA,
      CODPESSOA,
      MODELO,
      CHAVENFE
    DO
    BEGIN
      SUSPEND;
    END
  end
  else
  begin
    for select
      CODNFENTRADA, 
      DOCUMENTO,
      SERIE,                         
      UF,
      DTENTRADA,
      TOTNOTVLR,
      VALOR,
      VALOR_SISTEMATICA,
      RCODPESSOA,
      RMODELO,
      RCHAVENFE
    from
      ATACAMAX_COMPRASDENTRO_SIS(:LDATA_INI,:LDATA_FIM)
    where
      VALOR_SISTEMATICA > 0
    into
      CODNFENTRADA,
      DOCUMENTO,
      SERIE,                         
      UF,
      DTENTRADA,
      TOTNOTVLR,
      VALOR,
      VALOR_SISTEMATICA,
      CODPESSOA,
      MODELO,
      CHAVENFE
    DO
    BEGIN
      SUSPEND;
    END
  end
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE BLT_AT_REMESSA_RECEBIMENTO(
    ECODCONTA INTEGER,
    ECODRECEBIMENTO INTEGER,
    ESEQREMESSA INTEGER,
    ELOCAL_ARQUIVO VARCHAR(100))
AS
declare variable LNOSSONUMERO varchar(100);
begin
  in autonomous transaction do
  begin
    select
      NRDOCUMENTO_BOLETO
    from
      CONTA
    where
      CODCONTA = :ECODRECEBIMENTO
    into
      LNOSSONUMERO;

    insert into CONTA_REMESSA (
      CODCONTA,
      DT_ENVIO,
      NRREMESSA,
      LOCAL_ARQUIVO,
      NOSSO_NUMERO,
      CODBANCO)
    values(
      :ECODRECEBIMENTO,
      current_timestamp,
      RIGHT('0000000000'||:ESEQREMESSA, 10),
      :ELOCAL_ARQUIVO,
      :LNOSSONUMERO,
      :ECODCONTA);

      update conta set boletoimpresso = 'E'
      where conta.codconta =:ECODRECEBIMENTO;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_LISTAR_SUPERVISOR(
    EFILTRO VARCHAR(100))
RETURNS (
    ATIVO INTEGER,
    CODSUPERVISOR INTEGER,
    CPFCGC VARCHAR(18),
    DT_ADMISSAO VARCHAR(10),
    CODSTATUS INTEGER,
    NOME VARCHAR(60),
    PERCCOMISS DOUBLE PRECISION,
    PERCCOMISS2 DOUBLE PRECISION,
    DT_NASC VARCHAR(10),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    COMPLEMENTO_1 VARCHAR(60),
    UF_1 VARCHAR(2),
    FONES VARCHAR(42),
    CELULAR VARCHAR(14),
    EMAIL VARCHAR(45),
    CODSUPERVISORGERAL INTEGER)
AS
BEGIN
    FOR SELECT 
      S.ATIVO,
      S.CODSUPERVISOR,
      S.CPFCGC,
      EXTRACT(YEAR FROM S.DT_ADMISSAO) || '-' || RIGHT('00'||EXTRACT(MONTH FROM S.DT_ADMISSAO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM S.DT_ADMISSAO),2),
    S.CODSTATUS,
      S.NOME,
      S.PERCCOMISS,
    S.PERCCOMISS2,
    EXTRACT(YEAR FROM S.DT_NASC) || '-' || RIGHT('00'||EXTRACT(MONTH FROM S.DT_NASC),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM S.DT_NASC),2),
    S.CEP_1,
    S.LOGRADOURO_1,
    S.BAIRRO_1,
    S.CIDADE_1,
    S.COMPLEMENTO_1,
    S.UF_1,
    S.FONES,
    S.CELULAR,
    S.EMAIL,
    S.CODSUPERVISORGERAL 
    FROM 
      SUPERVISOR S 
      WHERE UPPER(S.NOME) CONTAINING(UPPER(:EFILTRO))
    INTO
      :ATIVO,
      :CODSUPERVISOR,
      :CPFCGC,
      :DT_ADMISSAO,
      :CODSTATUS,
      :NOME,
      :PERCCOMISS,
    :PERCCOMISS2,
    :DT_NASC,
    :CEP_1,
    :LOGRADOURO_1,
    :BAIRRO_1,
    :CIDADE_1,
    :COMPLEMENTO_1,
    :UF_1,
    :FONES,
    :CELULAR,
    :EMAIL,
    :CODSUPERVISORGERAL
     
    DO
    BEGIN       
      SUSPEND;
    END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_LISTAR_SUPERVISOR_ATIVO
RETURNS (
    ATIVO INTEGER,
    CODSUPERVISOR INTEGER,
    CPFCGC VARCHAR(18),
    DT_ADMISSAO VARCHAR(10),
    CODSTATUS INTEGER,
    NOME VARCHAR(60),
    PERCCOMISS DOUBLE PRECISION,
    PERCCOMISS2 DOUBLE PRECISION,
    DT_NASC VARCHAR(10),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    COMPLEMENTO_1 VARCHAR(60),
    UF_1 VARCHAR(2),
    FONES VARCHAR(42),
    CELULAR VARCHAR(14),
    EMAIL VARCHAR(45),
    CODSUPERVISORGERAL INTEGER)
AS
BEGIN
    FOR SELECT 
      S.ATIVO,
      S.CODSUPERVISOR,
      S.CPFCGC,
      EXTRACT(YEAR FROM S.DT_ADMISSAO) || '-' || RIGHT('00'||EXTRACT(MONTH FROM S.DT_ADMISSAO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM S.DT_ADMISSAO),2),
    S.CODSTATUS,
      S.NOME,
      S.PERCCOMISS,
    S.PERCCOMISS2,
    EXTRACT(YEAR FROM S.DT_NASC) || '-' || RIGHT('00'||EXTRACT(MONTH FROM S.DT_NASC),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM S.DT_NASC),2),
    S.CEP_1,
    S.LOGRADOURO_1,
    S.BAIRRO_1,
    S.CIDADE_1,
    S.COMPLEMENTO_1,
    S.UF_1,
    S.FONES,
    S.CELULAR,
    S.EMAIL,
    S.CODSUPERVISORGERAL 
    FROM 
      SUPERVISOR S 
      WHERE S.ATIVO = 2
    INTO
      :ATIVO,
      :CODSUPERVISOR,
      :CPFCGC,
      :DT_ADMISSAO,
      :CODSTATUS,
      :NOME,
      :PERCCOMISS,
    :PERCCOMISS2,
    :DT_NASC,
    :CEP_1,
    :LOGRADOURO_1,
    :BAIRRO_1,
    :CIDADE_1,
    :COMPLEMENTO_1,
    :UF_1,
    :FONES,
    :CELULAR,
    :EMAIL,
    :CODSUPERVISORGERAL
     
    DO
    BEGIN       
      SUSPEND;
    END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_LISTAR_VENDEDOR(
    EATIVO SMALLINT,
    ECODSUPERVISOR INTEGER)
RETURNS (
    CODVENDEDOR INTEGER,
    NOME VARCHAR(60),
    CPFCGC VARCHAR(18),
    DT_NASC VARCHAR(10),
    ATIVO SMALLINT,
    LOGRADOURO_1 VARCHAR(60),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    TIPOVENDEDOR CHAR(1),
    DT_ADMISSAO VARCHAR(10),
    DT_DEMISSAO VARCHAR(10),
    CODSTATUS INTEGER,
    DESCRICAO_STATUS VARCHAR(60),
    CODEMPRESA INTEGER,
    DESCRICAO_EMPRESA VARCHAR(60),
    URL_FOTO VARCHAR(500),
    PRECO1 CHAR(1),
    PRECO2 CHAR(1),
    PRECO3 CHAR(1),
    PRECO4 CHAR(1),
    PRECO5 CHAR(1),
    PRECO6 CHAR(1),
    CODSUPERVISOR INTEGER,
    NOMESUPERVISOR VARCHAR(60),
    CODDIVISAOVENDAS INTEGER,
    DESCDIVISAOVENDAS VARCHAR(100),
    CAPACIDADE SMALLINT,
    CODVEND_APOIO INTEGER,
    NOMEVEND_APOIO VARCHAR(60))
AS
BEGIN
    FOR SELECT 
    V.CODVENDEDOR,
    V.NOME,
    V.CPFCGC,
    EXTRACT(YEAR FROM V.DT_NASC)||'-'||RIGHT('00'||EXTRACT(MONTH FROM V.DT_NASC),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM V.DT_NASC),2) DT_NASC,
    V.ATIVO,
    V.LOGRADOURO_1,
    V.COMPLEMENTO_1,
    V.BAIRRO_1,
    V.CIDADE_1,
    V.UF_1,
    V.CEP_1,
    V.TIPOVENDEDOR,
    EXTRACT(YEAR FROM V.DT_ADMISSAO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM V.DT_ADMISSAO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM V.DT_ADMISSAO),2) DT_ADMISSAO ,
    EXTRACT(YEAR FROM V.DT_DEMISSAO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM V.DT_DEMISSAO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM V.DT_ADMISSAO),2) DT_DEMISSAO,
    COALESCE(V.CODSTATUS, 1),
    COALESCE (S.DESCRICAO,''),
    COALESCE(V.CODEMPRESA, 0),
    COALESCE(E.EMPRESA, ''),
    V.FOTO,
    V.PRECO1,
    V.PRECO2,
    V.PRECO3,
    V.PRECO4,
    V.PRECO5,
    V.PRECO6,
    D.CODSUPERVISOR,
    D.NOME,
    V.CODDIVISAOVENDAS,
    DV.DESCRICAO,
    V.CAPACIDADE,
    V.CODVEND_APOIO,
    VA.NOME
    FROM 
      VENDEDOR V 
     LEFT JOIN STATUS S ON
       V.CODSTATUS = S.CODSTATUS
     LEFT JOIN EMPRESA E ON
       V.CODEMPRESA = E.CODEMPRESA
     LEFT JOIN DIVISAOVENDAS DV ON
       V.CODDIVISAOVENDAS = DV.CODDIVISAOVENDAS
     LEFT JOIN VENDEDOR VA ON
       V.CODVEND_APOIO = VA.CODVENDEDOR
     LEFT JOIN SUPERVISOR D ON
       D.CODSUPERVISOR = V.CODSUPERVISOR
     WHERE
      (
        :EATIVO IS NULL OR
        (:EATIVO IS not NULL and V.ATIVO = 2)
      )
      and (
        :ECODSUPERVISOR is null or
        V.CODSUPERVISOR = :ECODSUPERVISOR
      )
    INTO
      :CODVENDEDOR ,
      :NOME,
      :CPFCGC,
      :DT_NASC,
      :ATIVO,
      :LOGRADOURO_1,
      :COMPLEMENTO_1,
      :BAIRRO_1,
      :CIDADE_1,
      :UF_1,
      :CEP_1,
      :TIPOVENDEDOR,
      :DT_ADMISSAO,
      :DT_DEMISSAO,
      :CODSTATUS,
      :DESCRICAO_STATUS,
      :CODEMPRESA,
      :DESCRICAO_EMPRESA,
      :URL_FOTO,
      :PRECO1,
      :PRECO2,
      :PRECO3,
      :PRECO4,
      :PRECO5,
      :PRECO6,
      :CODSUPERVISOR,
      :NOMESUPERVISOR,
      :CODDIVISAOVENDAS,
      :DESCDIVISAOVENDAS,
      :CAPACIDADE,
      :CODVEND_APOIO,
      :NOMEVEND_APOIO
    DO
    BEGIN         
      SUSPEND;
    END    
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_MVPEDIDO(
    EIDPEDIDO VARCHAR(40))
RETURNS (
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    STATUSPED VARCHAR(10),
    TIPOPED VARCHAR(10),
    DTFATURADO VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    OBS3 VARCHAR(100),
    CODNFVENDA INTEGER,
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1),
    IDVENDA VARCHAR(40),
    OUTRASINF BLOB SUB_TYPE TEXT SEGMENT SIZE 80)
AS
DECLARE VARIABLE LCODEMPRESA INTEGER;
DECLARE VARIABLE LSQL BLOB SUB_TYPE 1 SEGMENT SIZE 80;
BEGIN
  IF (EXISTS(SELECT 1 FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_MVPEDIDO')) THEN
  BEGIN
    SELECT SQL FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_MVPEDIDO' INTO LSQL;
    FOR EXECUTE STATEMENT 
      (LSQL)
      (EIDPEDIDO := :EIDPEDIDO)
    INTO
      CODPEDVEND, 
      CODTIPOPAG, 
      STATUSPED, 
      TIPOPED, 
      DTFATURADO, 
      DT_SAIDA, 
      DT_ENTREGA, 
      DT_ENTREGAPREV, 
      H_ENTREGAPREV, 
      TIPOPAG, 
      FORMA_PAGAMENTO, 
      CODPESSOA, 
      CPFCNPJ_CLIENTE, 
      NOME_CLIENTE, 
      NOMEFANTAZIA, 
      CEP_1, 
      LOGRADOURO_1, 
      NUMERO_1, 
      BAIRRO_1, 
      CIDADE_1, 
      UF_1, 
      FONES, 
      EMAIL_CLIENTE, 
      IE, 
      PESSOA_CONTATO, 
      CODVENDEDOR, 
      NOME_VENDEDOR, 
      OBS1, 
      OBS2, 
      OBS3, 
      CODNFVENDA, 
      VALOR_BRUTO, 
      DESCONTO, 
      DESCPERC_VALOR, 
      DESC_VALOR, 
      ACRESVALOR, 
      FRETE, 
      VALOR_TOTAL, 
      EMPRESA_CNPJ, 
      EMPRESA_RAZAO, 
      EMPRESA_FANTAZIA, 
      EMPRESA_CEP, 
      EMPRESA_LOGRADOURO, 
      EMPRESA_NUMERO, 
      EMPRESA_BAIRRO, 
      EMPRESA_CIDADE, 
      EMPRESA_UF, 
      EMPRESA_FONES, 
      EMPRESA_EMAIL, 
      ENTREGUE, 
      IDVENDA, 
      OUTRASINF
    DO
    BEGIN
      SUSPEND;
    END
    EXIT;
  END

  FOR SELECT 
    PEDVEND.CODPEDVEND,
    PEDVEND.CODPESSOA,
    PEDVEND.STATUSPED, 
    PEDVEND.TIPOPED,
    EXTRACT(YEAR FROM PEDVEND.DT_ENTREGAPREV)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGAPREV),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGAPREV),2),
    RIGHT('00'||EXTRACT(HOUR FROM PEDVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM PEDVEND.DT_ENTREGAPREV),2),
    EXTRACT(YEAR FROM PEDVEND.DTFATURADO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DTFATURADO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DTFATURADO),2),
    EXTRACT(YEAR FROM PEDVEND.DT_SAIDA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_SAIDA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_SAIDA),2),
  EXTRACT(YEAR FROM PEDVEND.DT_ENTREGA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGA),2),
    PESSOA.CPFCGC,
    COALESCE(NULLIF(PEDVEND.NOME,''), PESSOA.NOME),
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    PEDVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    COALESCE(PEDVEND.OBSPED1,''),
    COALESCE(PEDVEND.OBSPED2,''),
    COALESCE(PEDVEND.OBSPED3,''),
    COALESCE(PEDVEND.CODNFVENDA, 0) CODNFVENDA,
    PEDVEND.VALOR_BRUTO,
    COALESCE(PEDVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(PEDVEND.ACRESVALOR, 0) ACRESVALOR,
    COALESCE(PEDVEND.FRETE, 0) FRETE,
    PEDVEND.VALOR_TOTAL,
    PEDVEND.CODTIPOPAG,
    PEDVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(PEDVEND.DESCONTO,0),
    COALESCE(PEDVEND.DESCPERC_VALOR, 0),
    COALESCE(PEDVEND.ENTREGUE,'N'),
    PEDVEND.GEN_TEMPESTOQTEMP,
    PEDVEND.CODEMPRESA
  FROM
    PEDVEND
    JOIN PESSOA ON
      PEDVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    LEFT JOIN TIPOPAG ON 
      PEDVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
  WHERE
    (PEDVEND.GEN_TEMPESTOQTEMP = :EIDPEDIDO
    OR CAST(PEDVEND.CODPEDVEND AS VARCHAR(40)) = :EIDPEDIDO) 
 ORDER BY
    PEDVEND.DT_ENTREGAPREV DESC
  INTO
    CODPEDVEND,
    CODPESSOA,
    STATUSPED, 
    TIPOPED,
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DTFATURADO,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    OBS3,
    CODNFVENDA,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    IDVENDA,
    LCODEMPRESA
  DO
  BEGIN
    SELECT
      EMPRESA.CGC ,
      EMPRESA.RAZAOSOCIAL ,
      EMPRESA.EMPRESA ,
      EMPRESA.CEP ,    
      EMPRESA.LOGRADOURO ,
      EMPRESA.NUMERO ,
      EMPRESA.BAIRRO ,
      EMPRESA.CIDADE,
      EMPRESA.UF    ,
      EMPRESA.FONES,
      EMPRESA.EMAIL    
    FROM 
      EMPRESA
    WHERE 
      CODEMPRESA = :LCODEMPRESA
    INTO 
      EMPRESA_CNPJ,
      EMPRESA_RAZAO,
      EMPRESA_FANTAZIA,
      EMPRESA_CEP,
      EMPRESA_LOGRADOURO,
      EMPRESA_NUMERO,
      EMPRESA_BAIRRO,
      EMPRESA_CIDADE,
      EMPRESA_UF,
      EMPRESA_FONES,
      EMPRESA_EMAIL;    
    OUTRASINF = '';
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_ORCAMENTO(
    EIDORCVEND VARCHAR(40))
RETURNS (
    IDORCVEND VARCHAR(40),
    CODORCVEND INTEGER,
    IDVENDA VARCHAR(40),
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    STATUSORC VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    OBS3 VARCHAR(100),
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    ACRESCIMO DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    EMPRESA_CODEMPRESA VARCHAR(60),
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1))
AS
DECLARE VARIABLE LCODVENDEDOR INTEGER;
BEGIN
  FOR SELECT 
    TBL_ORCVEND.CODORCVEND,
    TBL_ORCVEND.CODPEDVEND,
    TBL_ORCVEND.CODPESSOA,
    TBL_ORCVEND.STATUSORC, 
    EXTRACT(YEAR FROM TBL_ORCVEND.DT_ENTREGAPREV)||'-'||RIGHT('00'||EXTRACT(MONTH FROM TBL_ORCVEND.DT_ENTREGAPREV),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM TBL_ORCVEND.DT_ENTREGAPREV),2),
    RIGHT('00'||EXTRACT(HOUR FROM TBL_ORCVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM TBL_ORCVEND.DT_ENTREGAPREV),2),
    EXTRACT(YEAR FROM TBL_ORCVEND.DT_SAIDA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM TBL_ORCVEND.DT_SAIDA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM TBL_ORCVEND.DT_SAIDA),2),
    EXTRACT(YEAR FROM TBL_ORCVEND.DT_ENTREGA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM TBL_ORCVEND.DT_ENTREGA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM TBL_ORCVEND.DT_ENTREGA),2),
    PESSOA.CPFCGC,
    PESSOA.NOME,
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    TBL_ORCVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    COALESCE(TBL_ORCVEND.OBSORC1,''),
    COALESCE(TBL_ORCVEND.OBSORC2,''),
    COALESCE(TBL_ORCVEND.OBSORC3,''),
    TBL_ORCVEND.VALOR_BRUTO,
    COALESCE(TBL_ORCVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(TBL_ORCVEND.ACRESVALOR, 0) ACRESVALOR,
    COALESCE(TBL_ORCVEND.ACRESCIMO, 0) ACRESCIMO,    
    COALESCE(TBL_ORCVEND.FRETE,0 ) FRETE,
    TBL_ORCVEND.VALOR_TOTAL,
    TBL_ORCVEND.CODTIPOPAG,
    TBL_ORCVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(TBL_ORCVEND.DESCONTO,0),
    COALESCE(TBL_ORCVEND.DESCPERC_VALOR, 0),
    COALESCE(TBL_ORCVEND.ENTREGUE,'N'),
    TBL_ORCVEND.IDORCVEND,
    TBL_ORCVEND.CODEMPRESA
  FROM
    TBL_ORCVEND
    JOIN PESSOA ON
      TBL_ORCVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      TBL_ORCVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    LEFT JOIN TIPOPAG ON 
      TBL_ORCVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
  WHERE
    (TBL_ORCVEND.IDORCVEND = :EIDORCVEND
    OR CAST(TBL_ORCVEND.CODORCVEND AS VARCHAR(40)) = :EIDORCVEND) 
 ORDER BY
    TBL_ORCVEND.DT_ENTREGAPREV DESC
 INTO
    CODORCVEND,
    CODPEDVEND,
    CODPESSOA,
    STATUSORC, 
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    OBS3,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    ACRESCIMO,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    IDORCVEND,
    EMPRESA_CODEMPRESA
  DO
  BEGIN
    SELECT GEN_TEMPESTOQTEMP  FROM PEDVEND WHERE CODPEDVEND  = :CODPEDVEND INTO IDVENDA;   
    SELECT
      EMPRESA.CGC ,
      EMPRESA.RAZAOSOCIAL ,
      EMPRESA.EMPRESA ,
      EMPRESA.CEP ,    
      EMPRESA.LOGRADOURO ,
      EMPRESA.NUMERO ,
      EMPRESA.BAIRRO ,
      EMPRESA.CIDADE,
      EMPRESA.UF    ,
      EMPRESA.FONES,
      EMPRESA.EMAIL    
    FROM 
      EMPRESA
    WHERE 
      CODEMPRESA = :EMPRESA_CODEMPRESA
    INTO 
      EMPRESA_CNPJ,
      EMPRESA_RAZAO,
      EMPRESA_FANTAZIA,
      EMPRESA_CEP,
      EMPRESA_LOGRADOURO,
      EMPRESA_NUMERO,
      EMPRESA_BAIRRO,
      EMPRESA_CIDADE,
      EMPRESA_UF,
      EMPRESA_FONES,
      EMPRESA_EMAIL;    
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_ORCAMENTOS(
    EEMAIL VARCHAR(100),
    EFILTROCLIENTE VARCHAR(100),
    EFILTROPEDIDO VARCHAR(100),
    EDATAINICIO DATE,
    EDATAFIM DATE,
    EFILTROSTATUS VARCHAR(1),
    ECOVENDEDOR INTEGER = 0)
RETURNS (
    CODORCVEND INTEGER,
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    IDORCVEND VARCHAR(40),
    STATUSORC VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    OBS3 VARCHAR(100),
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1),
    IDVENDA VARCHAR(40))
AS
DECLARE VARIABLE LCODEMPRESA INTEGER;
BEGIN
  SELECT CODEMPRESA FROM USERCAD WHERE EMAIL = :EEMAIL INTO LCODEMPRESA;
 
  SELECT
    EMPRESA.CGC ,
    EMPRESA.RAZAOSOCIAL ,
    EMPRESA.EMPRESA ,
    EMPRESA.CEP ,    
    EMPRESA.LOGRADOURO ,
    EMPRESA.NUMERO ,
    EMPRESA.BAIRRO ,
    EMPRESA.CIDADE,
    EMPRESA.UF    ,
    EMPRESA.FONES,
    EMPRESA.EMAIL    
  FROM 
    EMPRESA
  WHERE 
    CODEMPRESA = :LCODEMPRESA
  INTO 
    EMPRESA_CNPJ,
    EMPRESA_RAZAO,
    EMPRESA_FANTAZIA,
    EMPRESA_CEP,
    EMPRESA_LOGRADOURO,
    EMPRESA_NUMERO,
    EMPRESA_BAIRRO,
    EMPRESA_CIDADE,
    EMPRESA_UF,
    EMPRESA_FONES,
    EMPRESA_EMAIL;

  FOR SELECT 
    TBL_ORCVEND.CODORCVEND,
    TBL_ORCVEND.CODPEDVEND,
    TBL_ORCVEND.CODPESSOA,
    TBL_ORCVEND.IDORCVEND,
    TBL_ORCVEND.STATUSORC, 
    DATETOSTRING(TBL_ORCVEND.DT_ENTREGAPREV),
    RIGHT('00'||EXTRACT(HOUR FROM TBL_ORCVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM TBL_ORCVEND.DT_ENTREGAPREV),2),
    DATETOSTRING(TBL_ORCVEND.DT_SAIDA),
    DATETOSTRING(TBL_ORCVEND.DT_ENTREGA),
    PESSOA.CPFCGC,
    PESSOA.NOME,
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    TBL_ORCVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    COALESCE(TBL_ORCVEND.OBSORC1,''),
    COALESCE(TBL_ORCVEND.OBSORC2,''),
    COALESCE(TBL_ORCVEND.OBSORC3,''),
    TBL_ORCVEND.VALOR_BRUTO,
    COALESCE(TBL_ORCVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(TBL_ORCVEND.ACRESVALOR, 0) ACRESVALOR,
    COALESCE(TBL_ORCVEND.FRETE,0 ) FRETE,
    TBL_ORCVEND.VALOR_TOTAL,
    TBL_ORCVEND.CODTIPOPAG,
    TBL_ORCVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(TBL_ORCVEND.DESCONTO,0),
    COALESCE(TBL_ORCVEND.DESCPERC_VALOR, 0),
    COALESCE(TBL_ORCVEND.ENTREGUE,'N'),
    TBL_ORCVEND.IDORCVEND,
    TBL_ORCVEND.CODEMPRESA
  FROM
    TBL_ORCVEND
    JOIN PESSOA ON
      TBL_ORCVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      TBL_ORCVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    LEFT JOIN TIPOPAG ON 
      TBL_ORCVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
  WHERE
    (
      (CAST(TBL_ORCVEND.CODORCVEND AS VARCHAR(100)) = :EFILTROPEDIDO) OR
      (
        (:EFILTROPEDIDO = '') AND
        (
          (:EFILTROSTATUS = 'T') OR
          ((:EFILTROSTATUS = 'C') AND (TBL_ORCVEND.STATUSORC = 'CANCELADO')) OR
          ((:EFILTROSTATUS = 'F') AND (TBL_ORCVEND.STATUSORC = 'FATURADO')) OR
          ((:EFILTROSTATUS = 'N') AND (TBL_ORCVEND.STATUSORC = 'NORMAL'))
        )
        AND (
          (:EFILTROCLIENTE = '') OR
          (PESSOA.NOME CONTAINING :EFILTROCLIENTE) OR
          (REPLACE(REPLACE(REPLACE(PESSOA.CPFCGC,'.',''),'/',''),'-','') CONTAINING :EFILTROCLIENTE) OR
          (CAST(PESSOA.CODPESSOA AS VARCHAR(60)) CONTAINING :EFILTROCLIENTE) OR
          (TBL_ORCVEND.CODORCVEND CONTAINING :EFILTROCLIENTE)
        )
        AND (
          CAST(TBL_ORCVEND.DT_SAIDA AS DATE) BETWEEN :EDATAINICIO AND :EDATAFIM
        )
      )
    )
    AND ((:ECOVENDEDOR = 0) OR (TBL_ORCVEND.CODVENDEDOR = :ECOVENDEDOR))
 ORDER BY
    TBL_ORCVEND.DT_ENTREGAPREV DESC
 INTO
    CODORCVEND,
    CODPEDVEND,
    CODPESSOA,
    IDORCVEND,
    STATUSORC, 
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    OBS3,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    IDVENDA,
    LCODEMPRESA
  DO
  BEGIN
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_PEDIDO(
    EIDPEDIDO VARCHAR(40))
RETURNS (
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    STATUSPED VARCHAR(10),
    TIPOPED VARCHAR(10),
    DTFATURADO VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    OBS3 VARCHAR(100),
    CODNFVENDA INTEGER,
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    ACRESCIMO DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    ENTREGA_CEP VARCHAR(9),
    ENTREGA_LOGRADOURO VARCHAR(60),
    ENTREGA_NUMERO VARCHAR(30),
    ENTREGA_BAIRRO VARCHAR(45),
    ENTREGA_CIDADE VARCHAR(45),
    ENTREGA_UF VARCHAR(2),
    EMPRESA_CODEMPRESA INTEGER,
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1),
    TIPOFRETE VARCHAR(1),
    IDVENDA VARCHAR(40),
    OUTRASINF BLOB SUB_TYPE BINARY SEGMENT SIZE 80,
    CODTIPOPED INTEGER,
    DT_CADAST VARCHAR(10),
    VALOR_PESOVAR DOUBLE PRECISION,
    PRECOPRATICADO VARCHAR(10))
AS
declare variable LSQL blob sub_type 1 segment size 80;
BEGIN
  
   IF (EXISTS(SELECT 1 FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_PEDIDO')) THEN
  BEGIN
    SELECT SQL FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_PEDIDO' INTO LSQL;
    FOR EXECUTE STATEMENT 
      (LSQL)
      (EIDPEDIDO := :EIDPEDIDO)
    INTO
      CODPEDVEND, 
      CODTIPOPAG, 
      STATUSPED, 
      TIPOPED, 
      DTFATURADO, 
      DT_SAIDA, 
      DT_ENTREGA, 
      DT_ENTREGAPREV, 
      H_ENTREGAPREV, 
      TIPOPAG, 
      FORMA_PAGAMENTO, 
      CODPESSOA, 
      CPFCNPJ_CLIENTE, 
      NOME_CLIENTE, 
      NOMEFANTAZIA, 
      CEP_1, 
      LOGRADOURO_1, 
      NUMERO_1, 
      BAIRRO_1, 
      CIDADE_1, 
      UF_1, 
      FONES, 
      EMAIL_CLIENTE, 
      IE, 
      PESSOA_CONTATO, 
      CODVENDEDOR, 
      NOME_VENDEDOR, 
      OBS1, 
      OBS2, 
      OBS3, 
      CODNFVENDA, 
      VALOR_BRUTO, 
      DESCONTO, 
      DESCPERC_VALOR, 
      DESC_VALOR, 
      ACRESVALOR, 
      FRETE, 
      VALOR_TOTAL, 
      EMPRESA_CODEMPRESA,
      EMPRESA_CNPJ, 
      EMPRESA_RAZAO, 
      EMPRESA_FANTAZIA, 
      EMPRESA_CEP, 
      EMPRESA_LOGRADOURO, 
      EMPRESA_NUMERO, 
      EMPRESA_BAIRRO, 
      EMPRESA_CIDADE, 
      EMPRESA_UF, 
      EMPRESA_FONES, 
      EMPRESA_EMAIL, 
      ENTREGUE, 
      IDVENDA,
      OUTRASINF,
      CODTIPOPED,
      DT_CADAST,
      VALOR_PESOVAR,
      PRECOPRATICADO
    DO
    BEGIN
      SUSPEND;
    END
    EXIT;
  END
  
  
  FOR SELECT 
    PEDVEND.CODPEDVEND,
    PEDVEND.CODPESSOA,
    PEDVEND.STATUSPED, 
    PEDVEND.TIPOPED,
    EXTRACT(YEAR FROM PEDVEND.DT_ENTREGAPREV)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGAPREV),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGAPREV),2),
    RIGHT('00'||EXTRACT(HOUR FROM PEDVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM PEDVEND.DT_ENTREGAPREV),2),
    EXTRACT(YEAR FROM PEDVEND.DTFATURADO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DTFATURADO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DTFATURADO),2),
    EXTRACT(YEAR FROM PEDVEND.DT_SAIDA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_SAIDA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_SAIDA),2),
    EXTRACT(YEAR FROM PEDVEND.DT_ENTREGA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGA),2),
    PESSOA.CPFCGC,
    COALESCE(NULLIF(PEDVEND.NOME,''), PESSOA.NOME),
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    PEDVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    COALESCE(PEDVEND.OBSPED1,''),
    COALESCE(PEDVEND.OBSPED2,''),
    COALESCE(PEDVEND.OBSPED3,''),
    COALESCE(PEDVEND.CODNFVENDA, 0) CODNFVENDA,
    PEDVEND.VALOR_BRUTO,
    COALESCE(PEDVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(PEDVEND.ACRESVALOR , 0) ACRESVALOR,
    COALESCE(PEDVEND.ACRESCIMO , 0) ACRESCIMO,
    COALESCE(PEDVEND.FRETE, 0) FRETE,
    PEDVEND.VALOR_TOTAL,
    PEDVEND.CODTIPOPAG,
    PEDVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(PEDVEND.DESCONTO,0),
    COALESCE(PEDVEND.DESCPERC_VALOR, 0),
    COALESCE(PEDVEND.ENTREGUE,'N'),
    PEDVEND.TIPOFRETE,
    PEDVEND.GEN_TEMPESTOQTEMP,
    PEDVEND.CODEMPRESA,  
    COALESCE(PEDVEND_ENDERECO.CEP, PESSOA.CEP_1),
    COALESCE(PEDVEND_ENDERECO.LOGRADOURO, PESSOA.LOGRADOURO_1),
    COALESCE(PEDVEND_ENDERECO.NUMERO, PESSOA.NUMERO_1),
    COALESCE(PEDVEND_ENDERECO.BAIRRO, PESSOA.BAIRRO_1),
    COALESCE(PEDVEND_ENDERECO.MUNICIPIO, PESSOA.CIDADE_1), 
    COALESCE(PEDVEND_ENDERECO.UF, PESSOA.UF_1),
    TIPOVENDA.CODTIPOPED,
    EXTRACT(YEAR FROM PEDVEND.DT_CADAST)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_CADAST),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_CADAST),2),
    PEDVEND.PRECOUSADO 
  FROM
    PEDVEND
    JOIN PESSOA ON
      PEDVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    JOIN TIPOVENDA ON
      PEDVEND.TIPOPED = TIPOVENDA.TIPOPED
    LEFT JOIN TIPOPAG ON 
      PEDVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
    LEFT JOIN PEDVEND_ENDERECO ON
      PEDVEND_ENDERECO.CODPEDVEND = PEDVEND.CODPEDVEND      
  WHERE
    PEDVEND.GEN_TEMPESTOQTEMP = :EIDPEDIDO
 ORDER BY
    PEDVEND.DT_ENTREGAPREV DESC
  INTO
    CODPEDVEND,
    CODPESSOA,
    STATUSPED, 
    TIPOPED,
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DTFATURADO,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    OBS3,
    CODNFVENDA,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    ACRESCIMO,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    TIPOFRETE,
    IDVENDA,
    EMPRESA_CODEMPRESA,
    ENTREGA_CEP,
    ENTREGA_LOGRADOURO,
    ENTREGA_NUMERO,
    ENTREGA_BAIRRO,
    ENTREGA_CIDADE,
    ENTREGA_UF,
    CODTIPOPED,
    DT_CADAST,
    PRECOPRATICADO
  DO
  begin
    
    SELECT 
      sum(SIMPLEROUNDTO( ( (PEDVENDITEM.QTDE * PEDVENDITEM.PRECOPROD) * (PRODFILHO.TOLERANCIA_PECA / 100) ), -2))
    FROM 
      PEDVENDITEM 
      JOIN PRODFILHO ON
        PEDVENDITEM.CODPRODFILHO  = PRODFILHO.CODPRODFILHO 
        AND PRODFILHO.FLAG_PESOVARIAVEL = 'S'
    WHERE 
      PEDVENDITEM.CODPEDVEND = :CODPEDVEND 
    into 
      VALOR_PESOVAR;
        
    SELECT
      EMPRESA.CGC ,
      EMPRESA.RAZAOSOCIAL ,
      EMPRESA.EMPRESA ,
      EMPRESA.CEP ,    
      EMPRESA.LOGRADOURO ,
      EMPRESA.NUMERO ,
      EMPRESA.BAIRRO ,
      EMPRESA.CIDADE,
      EMPRESA.UF    ,
      EMPRESA.FONES,
      EMPRESA.EMAIL    
    FROM 
      EMPRESA
    WHERE 
      CODEMPRESA = :EMPRESA_CODEMPRESA
    INTO 
      EMPRESA_CNPJ,
      EMPRESA_RAZAO,
      EMPRESA_FANTAZIA,
      EMPRESA_CEP,
      EMPRESA_LOGRADOURO,
      EMPRESA_NUMERO,
      EMPRESA_BAIRRO,
      EMPRESA_CIDADE,
      EMPRESA_UF,
      EMPRESA_FONES,
      EMPRESA_EMAIL;  
    OUTRASINF = '';
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_PEDIDOS_FILTRADOS(
    EEMAIL VARCHAR(100),
    EENTREGUE VARCHAR(1),
    EFILTROCLIENTE VARCHAR(100),
    EFILTROPEDIDO VARCHAR(100),
    EDATAINICIO DATE,
    EDATAFIM DATE,
    ECODVENDEDOR INTEGER = 0)
RETURNS (
    CODPEDVEND INTEGER,
    CODTIPOPAG INTEGER,
    STATUSPED VARCHAR(10),
    TIPOPED VARCHAR(10),
    DTFATURADO VARCHAR(10),
    DT_SAIDA VARCHAR(10),
    DT_ENTREGA VARCHAR(10),
    DT_ENTREGAPREV VARCHAR(10),
    H_ENTREGAPREV VARCHAR(5),
    TIPOPAG VARCHAR(20),
    FORMA_PAGAMENTO VARCHAR(60),
    CODPESSOA INTEGER,
    CPFCNPJ_CLIENTE VARCHAR(18),
    NOME_CLIENTE VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    CEP_1 VARCHAR(9),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    FONES VARCHAR(120),
    EMAIL_CLIENTE VARCHAR(45),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    CODVENDEDOR INTEGER,
    NOME_VENDEDOR VARCHAR(60),
    OBS1 VARCHAR(100),
    OBS2 VARCHAR(100),
    CODNFVENDA INTEGER,
    VALOR_BRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESCPERC_VALOR DOUBLE PRECISION,
    DESC_VALOR DOUBLE PRECISION,
    ACRESVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    EMPRESA_CNPJ VARCHAR(18),
    EMPRESA_RAZAO VARCHAR(60),
    EMPRESA_FANTAZIA VARCHAR(60),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO VARCHAR(30),
    EMPRESA_BAIRRO VARCHAR(45),
    EMPRESA_CIDADE VARCHAR(45),
    EMPRESA_UF VARCHAR(2),
    EMPRESA_FONES VARCHAR(120),
    EMPRESA_EMAIL VARCHAR(45),
    ENTREGUE VARCHAR(1),
    IDVENDA VARCHAR(40))
AS
DECLARE VARIABLE LCODEMPRESA INTEGER;
BEGIN
  SELECT CODEMPRESA FROM USERCAD WHERE EMAIL = :EEMAIL INTO LCODEMPRESA;
 
  SELECT
    EMPRESA.CGC ,
    EMPRESA.RAZAOSOCIAL ,
    EMPRESA.EMPRESA ,
    EMPRESA.CEP ,    
    EMPRESA.LOGRADOURO ,
    EMPRESA.NUMERO ,
    EMPRESA.BAIRRO ,
    EMPRESA.CIDADE,
    EMPRESA.UF    ,
    EMPRESA.FONES,
    EMPRESA.EMAIL    
  FROM 
    EMPRESA
  WHERE 
    CODEMPRESA = :LCODEMPRESA
  INTO 
    EMPRESA_CNPJ,
  EMPRESA_RAZAO,
  EMPRESA_FANTAZIA,
  EMPRESA_CEP,
  EMPRESA_LOGRADOURO,
  EMPRESA_NUMERO,
  EMPRESA_BAIRRO,
  EMPRESA_CIDADE,
  EMPRESA_UF,
  EMPRESA_FONES,
  EMPRESA_EMAIL;


FOR SELECT 
    PEDVEND.CODPEDVEND,
    PEDVEND.CODPESSOA,
    PEDVEND.STATUSPED, 
    PEDVEND.TIPOPED,
    EXTRACT(YEAR FROM PEDVEND.DT_ENTREGAPREV)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGAPREV),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGAPREV),2),
    RIGHT('00'||EXTRACT(HOUR FROM PEDVEND.DT_ENTREGAPREV),2)||':'||RIGHT('00'||EXTRACT(MINUTE FROM PEDVEND.DT_ENTREGAPREV),2),
    EXTRACT(YEAR FROM PEDVEND.DTFATURADO)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DTFATURADO),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DTFATURADO),2),
    EXTRACT(YEAR FROM PEDVEND.DT_SAIDA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_SAIDA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_SAIDA),2),
  EXTRACT(YEAR FROM PEDVEND.DT_ENTREGA)||'-'||RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DT_ENTREGA),2)||'-'||RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DT_ENTREGA),2),
    PESSOA.CPFCGC,
    COALESCE(NULLIF(PEDVEND.NOME,''), PESSOA.NOME),
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.FONES,
    PESSOA.EMAIL,
    PESSOA.IE,
    PESSOA.PESSOA_CONTATO, 
    PEDVEND.CODVENDEDOR,
    VENDEDOR.NOME,
    PEDVEND.OBS1,
    PEDVEND.OBS2,
    COALESCE(PEDVEND.CODNFVENDA, 0) CODNFVENDA,
    PEDVEND.VALOR_BRUTO,
    COALESCE(PEDVEND.DESC_VALOR, 0) DESC_VALOR,
    COALESCE(PEDVEND.ACRESVALOR, 0) ACRESVALOR,
    COALESCE(PEDVEND.FRETE, 0) FRETE,    
    PEDVEND.VALOR_TOTAL,
    PEDVEND.CODTIPOPAG,
    PEDVEND.TIPOPAG,
    TIPOPAG.DESCRICAO,
    COALESCE(PEDVEND.DESCONTO,0),
    COALESCE(PEDVEND.DESCPERC_VALOR, 0),
    COALESCE(PEDVEND.ENTREGUE,'N'),
    PEDVEND.GEN_TEMPESTOQTEMP,
    PEDVEND.CODEMPRESA
  FROM
    PEDVEND
    JOIN PESSOA ON
      PEDVEND.CODPESSOA = PESSOA.CODPESSOA
    JOIN VENDEDOR ON
      PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
    LEFT JOIN TIPOPAG ON 
      PEDVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG 
  WHERE
    (
      (CAST(PEDVEND.CODPEDVEND AS VARCHAR(100)) = :EFILTROPEDIDO) OR
      (
        (:EFILTROPEDIDO = '')
        AND (PEDVEND.STATUSPED <> 'CANCELADO')
        AND (:EENTREGUE = 'T' OR PEDVEND.ENTREGUE = :EENTREGUE)
        AND (
          (:EFILTROCLIENTE = '') OR
          (COALESCE(NULLIF(PEDVEND.NOME,''), PESSOA.NOME) CONTAINING :EFILTROCLIENTE) OR
          (REPLACE(REPLACE(REPLACE(PESSOA.CPFCGC,'.',''),'/',''),'-','') CONTAINING :EFILTROCLIENTE) OR
          (PESSOA.CODPESSOA CONTAINING :EFILTROCLIENTE)
        ) 
        AND PEDVEND.TIPOPED IN ('VENDA', 'CADERNO', 'DELIVERY')
        AND PEDVEND.STATUSPED IN ('FATURADO', 'NORMAL')
        AND CAST(PEDVEND.DT_ENTREGAPREV AS DATE) BETWEEN :EDATAINICIO AND :EDATAFIM
      )
    )
    AND ((:ECODVENDEDOR = 0) OR (PEDVEND.CODVENDEDOR = :ECODVENDEDOR))
 ORDER BY
    PEDVEND.DT_ENTREGAPREV DESC
 INTO
    CODPEDVEND,
    CODPESSOA,
    STATUSPED, 
    TIPOPED,
    DT_ENTREGAPREV,
    H_ENTREGAPREV,
    DTFATURADO,
    DT_SAIDA,
    DT_ENTREGA,
    CPFCNPJ_CLIENTE,
    NOME_CLIENTE,
    NOMEFANTAZIA,
    CEP_1,
    LOGRADOURO_1,
    NUMERO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    FONES,
    EMAIL_CLIENTE,
    IE,
    PESSOA_CONTATO, 
    CODVENDEDOR,
    NOME_VENDEDOR,
    OBS1,
    OBS2,
    CODNFVENDA,
    VALOR_BRUTO,
    DESC_VALOR,
    ACRESVALOR,
    FRETE,
    VALOR_TOTAL,
    CODTIPOPAG,
    TIPOPAG,
    FORMA_PAGAMENTO,
    DESCONTO,
    DESCPERC_VALOR,
    ENTREGUE,
    IDVENDA,
    LCODEMPRESA
  DO
  BEGIN
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DIACCERA_ENTRADAS(
    EDATAINI DATE,
    EDATAFIM DATE,
    ECOD INTEGER)
RETURNS (
    CPFCGC VARCHAR(18),
    CNPJDISTRIBUIDOR VARCHAR(18),
    DOCUMENTO VARCHAR(15),
    STATUS CHAR(1),
    TOTNOTVLR INTEGER,
    QTD VARCHAR(30),
    DTEMISSAO VARCHAR(8),
    DTENTRADA VARCHAR(8))
AS
DECLARE VARIABLE LFABRICANTES VARCHAR(100);
DECLARE VARIABLE LGRUPOS VARCHAR(500);
BEGIN
  SELECT COALESCE(CODFABRICANTE,''), COALESCE(CODGRUPOS,'') FROM INTEGRACAOARQ WHERE IDINTEGRACAOARQ = :ECOD INTO LFABRICANTES, LGRUPOS;
  LFABRICANTES = TRIM(REPLACE(LFABRICANTES,' ',''));
  LGRUPOS = TRIM(REPLACE(LGRUPOS,' ',''));

  SELECT
    TIRARMASCARA(EMPRESA.CGC)
  FROM
    EMPRESA
    JOIN INTEGRACAOARQ ON
      EMPRESA.CODEMPRESA = INTEGRACAOARQ.CODEMPRESA
  WHERE
    IDINTEGRACAOARQ = :ECOD
  INTO
    CNPJDISTRIBUIDOR;

  FOR SELECT
    TIRARMASCARA(P.CPFCGC),
    N.DOCUMENTO,
    CASE
      WHEN N.NFE_TIPO = 'ENTRADA' THEN 'E'
    ELSE
      'R'
    END STATUS,
    CAST(N.TOTNOTVLR AS INTEGER) TOTNOTVLR,
    CAST(SUM(NI.QTD) AS INTEGER) QTD,
    (EXTRACT( YEAR FROM N.DTEMISSAO) || RIGHT('00' || EXTRACT(MONTH FROM N.DTEMISSAO), 2) || RIGHT('00' || EXTRACT(DAY FROM N.DTEMISSAO), 2)) AS DTEMISSAO,
    (EXTRACT( YEAR FROM N.DTENTRADA) || RIGHT('00' || EXTRACT(MONTH FROM N.DTENTRADA), 2) || RIGHT('00' || EXTRACT(DAY FROM N.DTENTRADA), 2)) AS DTENTRADA
  FROM
    NFENTRADA N
    JOIN PESSOA P ON
      N.CODPESSOA = P.CODPESSOA
    JOIN NFENTRADAITENS NI ON
      N.CODNFENTRADA = NI.CODNFENTRADA
    join prodfilho pf on
      ni.CODPRODFILHO = pf.CODPRODFILHO
    join produto pr on
      pf.CODPRODUTO = pr.CODPRODUTO
  WHERE
    CAST(N.DT_CADAST AS DATE) BETWEEN :EDATAINI AND :EDATAFIM
    AND (
      :LFABRICANTES = '' OR
      ','||:LFABRICANTES||',' CONTAINING ','||PR.CODFABRICANTE||','
    )
    AND (
      :LGRUPOS = '' OR
      ','||:LGRUPOS||',' CONTAINING ','||PR.CODGRUPO||','
    )
  GROUP BY
    1,2,3,4,6,7
  INTO
    :CPFCGC,
    :DOCUMENTO,
    :STATUS,
    :TOTNOTVLR,
    :QTD,
    :DTEMISSAO,
    :DTENTRADA
  DO
  BEGIN
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DIACCERA_ESTOQUE(
    EDATAINI DATE,
    EDATAFIM DATE,
    ECOD INTEGER)
RETURNS (
    CNPJDISTRIBUIDOR VARCHAR(18),
    CNPJEMPRESA VARCHAR(18),
    DUN VARCHAR(30),
    QTDESTOQUE VARCHAR(30),
    DATA VARCHAR(8),
    LOTE VARCHAR(200),
    DTVAL VARCHAR(8),
    CODGRUPO INTEGER,
    CODPRODFIHO INTEGER)
AS
declare variable LQTDEMBALAGEM double precision;
declare variable LQTDESTOQUE double precision;
declare variable LFABRICANTES varchar(100);
declare variable LGRUPOS varchar(500);
BEGIN
  SELECT COALESCE(CODFABRICANTE,''), COALESCE(CODGRUPOS,'') FROM INTEGRACAOARQ WHERE IDINTEGRACAOARQ = :ECOD INTO LFABRICANTES, LGRUPOS;
  LFABRICANTES = TRIM(REPLACE(LFABRICANTES,' ',''));
  LGRUPOS = TRIM(REPLACE(LGRUPOS,' ',''));

  SELECT
    TIRARMASCARA(EMPRESA.CGC)
  FROM
    EMPRESA
    JOIN INTEGRACAOARQ ON
      EMPRESA.CODEMPRESA = INTEGRACAOARQ.CODEMPRESA
  WHERE
    IDINTEGRACAOARQ = :ECOD
  INTO
    CNPJDISTRIBUIDOR;

  FOR SELECT
    PRODFILHO.CODPRODFILHO,
    TIRARMASCARA(PESSOA.CPFCGC),
    COALESCE(PRODFILHO.CODPESQ2,PRODFILHO.CODPRODFILHO) DUN,
    PRODFILHO.QTDEMBALAGEM,
    (EXTRACT(YEAR FROM CURRENT_DATE) || RIGHT('00' || EXTRACT(MONTH FROM CURRENT_DATE), 2) || RIGHT('00' || EXTRACT(DAY FROM CURRENT_DATE), 2)) AS DATA,
    PRODFILHO.ESTQATUAL,
    PRODUTO.CODGRUPO
  FROM
     PRODFILHO
     JOIN PRODUTO ON
       (PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO)
     JOIN PESSOA ON
      (PESSOA.CODPESSOA = PRODUTO.CODFABRICANTE)
  where
    (
      :LFABRICANTES = '' OR
      ','||:LFABRICANTES||',' CONTAINING ','||PRODUTO.CODFABRICANTE||','
    )
    AND (
      :LGRUPOS = '' OR
      ','||:LGRUPOS||',' CONTAINING ','||PRODUTO.CODGRUPO||','
    )
  INTO
    :CODPRODFIHO,
    :CNPJEMPRESA,
    :DUN,
    :LQTDEMBALAGEM,
    :DATA,
    :LQTDESTOQUE,
    :CODGRUPO
  DO
  BEGIN
    IF (COALESCE(LQTDEMBALAGEM,0) > 1) THEN
    BEGIN
      LQTDESTOQUE = LQTDESTOQUE / LQTDEMBALAGEM;
    END

    QTDESTOQUE = cast(trunc(LQTDESTOQUE * 1000) as integer);

    IF (LQTDESTOQUE > 0) THEN
      SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DIACCERA_VENDAS(
    EDATAINI DATE,
    EDATAFIM DATE,
    ECOD INTEGER)
RETURNS (
    DUN VARCHAR(30),
    CNPJCLIENTE VARCHAR(18),
    CLIENTE VARCHAR(60),
    CODSEGMENTO INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA VARCHAR(20),
    TIPOPED VARCHAR(10),
    TIPOPESSOA VARCHAR(1),
    PDV_EMPRESA VARCHAR(60),
    PDV_CEP VARCHAR(9),
    NOME_VENDEDOR VARCHAR(60),
    CODNFVENDA VARCHAR(14),
    VLRVENDIDO VARCHAR(30),
    QTDVENDIDA VARCHAR(30),
    QTDEMBALAGEM INTEGER,
    TIPOCODIGO VARCHAR(10),
    CODGRUPO INTEGER,
    CODPESSOA INTEGER,
    CODSTATUS_CHECKOUT INTEGER,
    ATIVIDADE VARCHAR(60),
    CODPRODFILHO INTEGER,
    QTD NUMERIC(15,2),
    VALOR NUMERIC(15,2),
    CODSUPERVISOR INTEGER,
    CNPJFABRICANTE VARCHAR(20))
AS
DECLARE VARIABLE DTINI DATE;
DECLARE VARIABLE LFABRICANTES VARCHAR(100);
DECLARE VARIABLE LGRUPOS VARCHAR(500);
BEGIN
  SELECT COALESCE(CODFABRICANTE,''), COALESCE(CODGRUPOS,'') FROM INTEGRACAOARQ WHERE IDINTEGRACAOARQ = :ECOD INTO LFABRICANTES, LGRUPOS;
  LFABRICANTES = TRIM(REPLACE(LFABRICANTES,' ',''));
  LGRUPOS = TRIM(REPLACE(LGRUPOS,' ',''));

  SELECT
    TIRARMASCARA(EMPRESA.CGC),
    TIRARMASCARA(EMPRESA.CEP)
  FROM
    EMPRESA
    JOIN INTEGRACAOARQ ON
      EMPRESA.CODEMPRESA = INTEGRACAOARQ.CODEMPRESA
  WHERE
    IDINTEGRACAOARQ = :ECOD
  INTO
    CNPJDISTRIBUIDOR,
    PDV_CEP;

  FOR SELECT
   CASE COALESCE(PRODFILHO.CODPESQ2 ,'')
      WHEN '' THEN
        PRODFILHO.CODPRODFILHO
      ELSE
        PRODFILHO.CODPESQ2
    END DUN,
    TIRARMASCARA(PESSOA.CPFCGC) CNPJCLIENTE,
    PESSOA.NOME CLIENTE,
    PESSOA.NOME,
    TIRARMASCARA(PESSOA.CEP_1),
    CASE COALESCE(TBL_RAMOATVTIPO.REFERENCIA,'')
      WHEN '' THEN 0
      ELSE TBL_RAMOATVTIPO.REFERENCIA
      END CODSEGMENTOPEPSICO,
    PEDVEND.CODVENDEDOR,
    (EXTRACT(YEAR FROM PEDVEND.DTFATURADO) || RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DTFATURADO),2) || RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DTFATURADO),2)) AS DATAVENDA,
    CASE
      WHEN ((PEDVEND.TIPOPED = 'VENDA') OR (PEDVEND.TIPOPED = 'CADERNO'))  THEN 'V'
      WHEN PEDVEND.TIPOPED = 'BONIFICA' THEN 'B'
      WHEN ((PEDVEND.TIPOPED = 'DEVOLUÇÃO') OR (PEDVEND.TIPOPED = 'DEVOLUCAO'))  THEN 'DV'
      WHEN PEDVEND.TIPOPED = 'CANCELAMENTO' THEN 'C'
      WHEN ((PEDVEND.TIPOPED = 'TRANSFERENCIA') OR (PEDVEND.TIPOPED = 'REMESSA F.'))  THEN 'T'
    END AS TIPOPED,
    COALESCE(PEDVEND.CODNFVENDA,PEDVEND.CODPEDVEND),
    PESSOA.PESSOA,
    COALESCE(NULLIF(PRODFILHO.QTDEMBALAGEM,1),1),
    CAST(CAST(SUM(((COALESCE(PEDVENDITEM.PRECOPROD,0) * COALESCE(PEDVENDITEM.QTDENTREGUE,1))
    + (((COALESCE(PEDVEND.ACRESVALOR,0) + (COALESCE(PEDVEND.VALOR_BRUTO,0) * (COALESCE(PEDVEND.ACRESCIMO,0)/100))) * (COALESCE(PEDVENDITEM.PRECOVEND,0) / COALESCE(NULLIF(PEDVEND.VALOR_BRUTO,1),1))))
    ) - (((COALESCE(PEDVEND.DESC_VALOR,0) + COALESCE(PEDVEND.DESCPERC_VALOR,0)) * (COALESCE(PEDVENDITEM.PRECOVEND,0) / COALESCE(NULLIF(PEDVEND.VALOR_BRUTO,1),1))) + COALESCE(PEDVENDITEM.DESCONTO_VALOR,0))) AS NUMERIC(18,2)) AS VARCHAR(30)) AS VLRVENDIDO,
    CAST(SUM(COALESCE(PEDVENDITEM.QTDE,0)) AS NUMERIC(18,5)) AS QTDVENDIDA,
    PRODUTO.CODGRUPO,
    PEDVEND.CODPESSOA,
    PESSOA.CODSTATUS_CHECKOUT,
    PRODFILHO.CODPRODFILHO
  FROM
    PEDVEND
    JOIN PESSOA ON (PESSOA.CODPESSOA = PEDVEND.CODPESSOA)
    JOIN TBL_RAMOATVTIPO ON (PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO)
    JOIN PEDVENDITEM ON PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
    JOIN PRODFILHO ON PEDVENDITEM.CODPRODFILHO =  PRODFILHO.CODPRODFILHO
    JOIN PRODUTO ON PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
  WHERE
    PEDVEND.STATUSPED = 'FATURADO' AND
    PEDVEND.TIPOPED IN ('VENDA','CADERNO','BONIFICA','DEVOLUÇÃO') AND
    PEDVEND.DTFATURADO BETWEEN :EDATAINI AND :EDATAFIM
    AND (
      :LFABRICANTES = '' OR
      ','||:LFABRICANTES||',' CONTAINING ','||PRODUTO.CODFABRICANTE||','
    )
    AND (
      :LGRUPOS = '' OR
      ','||:LGRUPOS||',' CONTAINING ','||PRODUTO.CODGRUPO||','
    )
  GROUP BY
    1,2,3,4,5,6,7,8,9,10,11,12,15,16,17,18
  INTO
    :DUN,
    :CNPJCLIENTE,
    :CLIENTE,
    :PDV_EMPRESA,
    :PDV_CEP,
    :CODSEGMENTO,
    :CODVENDEDOR,
    :DATAVENDA,
    :TIPOPED,
    :CODNFVENDA,
    :TIPOPESSOA,
    :QTDEMBALAGEM,
    :VLRVENDIDO,
    :QTDVENDIDA,
    :CODGRUPO,
    :CODPESSOA,
    :CODSTATUS_CHECKOUT,
    :CODPRODFILHO
  DO
  BEGIN
    QTD = 0;
    VALOR= 0;

    QTD = CAST(COALESCE(QTDVENDIDA,0) AS DOUBLE PRECISION);
    VALOR = CAST(COALESCE(VLRVENDIDO,0) AS DOUBLE PRECISION);

    IF (STRLEN(DUN) > 13) THEN
    BEGIN
       QTDVENDIDA = CAST(((CAST(QTDVENDIDA AS DOUBLE PRECISION) / QTDEMBALAGEM) * 1000) AS INTEGER);
       TIPOCODIGO = 'DUN';
    END
    ELSE
    BEGIN
       QTDVENDIDA = CAST((CAST(QTDVENDIDA AS DOUBLE PRECISION) * 1000) AS INTEGER);
       TIPOCODIGO = 'EAN';
    END

    VLRVENDIDO = CAST((CAST(VLRVENDIDO AS DOUBLE PRECISION) * 100) AS INTEGER);

    CODSUPERVISOR = 0;

    SELECT
      VENDEDOR.CODVENDEDOR || ' - ' || VENDEDOR.NOME,
      VENDEDOR.CODSUPERVISOR
    FROM
      VENDEDOR
    WHERE
      VENDEDOR.CODVENDEDOR = :CODVENDEDOR
    INTO
      :NOME_VENDEDOR,
      :CODSUPERVISOR;

    ATIVIDADE = '';

    SELECT STATUS.DESCRICAO FROM STATUS WHERE STATUS.CODSTATUS = :CODSTATUS_CHECKOUT INTO :ATIVIDADE;

    IF (ATIVIDADE = 'S.M. 05 A 09') THEN
    BEGIN
      ATIVIDADE = '5 A 9 CKS';
    END
    ELSE
    BEGIN
      ATIVIDADE = 'TRADICIONAL';
    END
    
    IF (COALESCE(CNPJCLIENTE,'') = '') THEN
    BEGIN
      CNPJCLIENTE = '11111111111111';
    END

    CNPJFABRICANTE = '50955707000472';

    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE FECHAMENTO_BOLETOS(
    INI TIMESTAMP,
    FIM TIMESTAMP,
    DATAVENCIMENTO TIMESTAMP,
    EUS_CADAST VARCHAR(45),
    VALORMINIMO DOUBLE PRECISION)
RETURNS (
    CODFAMILIA INTEGER,
    FAMILIA VARCHAR(60),
    FONES VARCHAR(120),
    EMAIL VARCHAR(45),
    SEQ VARCHAR(30),
    ALUNO VARCHAR(60),
    DESCRICAO VARCHAR(45),
    SALDO NUMERIC(18,2),
    TOTAL_FAMILIA DOUBLE PRECISION,
    LCODFAMILIA INTEGER,
    CODALUNO INTEGER,
    CODCONTA INTEGER,
    VALORPARCELA DOUBLE PRECISION)
AS
declare variable LMES varchar(20);
declare variable LOBS2 varchar(100);
declare variable LQTDFILHOS integer;
declare variable LFILHOATUAL integer;
BEGIN
  TOTAL_FAMILIA = 0;
  LOBS2 = '';
  LFILHOATUAL = 1;

  FOR
    select
           P1.codpessoamatriz CODFAMILIA,
           P2.nome FAMILIA,
           p2.fones,
           coalesce(p2.email,p1.email) email,
           p1.codpesq SEQ,
           P1.nome ALUNO,
           tipopag.descricao,
           (select saldo_aluno.saldofinal from saldo_aluno(p1.codpessoa,'01.01.2000',:FIM)) saldo,
           p1.CODPESSOA
    from pessoa p1
    join pessoa p2 on p1.codpessoamatriz = P2.codpessoa
    left join  tipopag on tipopag.codtipopag = p1.codtipopag
    WHERE 1 = 1
    and tipopag.descricao = 'BOLETO BANCÁRIO'
    --AND P1.codpessoa = 11999
    order by P2.codpessoa,p1.codpesq
    INTO :CODFAMILIA,
         :FAMILIA,
         :FONES,
         :EMAIL,
         :SEQ,
         :ALUNO,
         :DESCRICAO,
         :SALDO,
         :CODALUNO
  DO
  BEGIN

    if (CODFAMILIA <> 9) then
    begin
      select count(pessoa.CODPESSOA) from pessoa where pessoa.CODPESSOAMATRIZ = :CODFAMILIA into :LQTDFILHOS;
  
      if (CODFAMILIA = LCODFAMILIA) then
      begin
         TOTAL_FAMILIA = COALESCE(SALDO,0) + TOTAL_FAMILIA;
         LOBS2 = COALESCE(:LOBS2,'') || RIGHT('0000' || cast((SEQ) as varchar(4)), 4) || ' R$: ' || (CAST(:SALDO AS NUMERIC(15,2)) * (-1));
         LOBS2 = COALESCE(:LOBS2,'') || ' | ';
         LFILHOATUAL = coalesce(LFILHOATUAL,0) + 1;
      end
      else
      begin
         LOBS2 = RIGHT('0000' || cast((SEQ) as varchar(4)), 4) || ' R$: ' || (CAST(:SALDO AS NUMERIC(15,2)) * (-1));
         LOBS2 = COALESCE(:LOBS2,'') || ' | ';
         TOTAL_FAMILIA = COALESCE(SALDO,0);
         LFILHOATUAL = 1;
      end
    end
    else
    begin
         CODFAMILIA = CODALUNO;
         LQTDFILHOS = 1;
         LFILHOATUAL = 1;
         LOBS2 = RIGHT('0000' || cast((SEQ) as varchar(4)), 4) || ' R$: ' || (CAST(:SALDO AS NUMERIC(15,2)) * (-1));
         LOBS2 = COALESCE(:LOBS2,'') || ' | EAR';
         TOTAL_FAMILIA = COALESCE(SALDO,0);
    end

    codconta = null;
    VALORPARCELA = 0;

    if ((:TOTAL_FAMILIA * (-1)) > 0 and (coalesce(LQTDFILHOS,0) = coalesce(LFILHOATUAL,0)) and (:TOTAL_FAMILIA * (-1) > COALESCE(VALORMINIMO,0))) then
    begin
        SELECT FU_RETORNOMEMES.NOME FROM FU_RETORNOMEMES(extract(month from :INI)) INTO :LMES;

        CODCONTA = gen_id(GEN_CONTA, 1);

        VALORPARCELA = :TOTAL_FAMILIA * (-1);

        insert into CONTA(
          CODCONTA,
          STATUS,
          TIPO,
          DESCRICAO,
          NRDOCUMENTO,
          CODPESSOA,
          DT_EMISSAO,
          DT_VENCIM,
          DIAS,
          PARCELA,
          PREV_TIPOPAG,
          VLPARCELA,
          VLTOTAL,
          CODCENTCUSTO,
          US_CADAST,
          DT_CADAST,
          TOTDESCONTO,
          TOTJUROS,
          TOTPAGO,
          CODPENDVEND,
          CODNFVENDA,
          CODCARTAO,
          CODVENDEDOR,
          COMISCARTAO,
          VLRNEGOCIA,
          COMISTIPOPAG,
          PERCJUROS,
          CART_PERC,
          CART_VALOR,
          CODBANCO,
          SERIENF,
          DESC_FINANCEIRO,
          CODCONTABANCO,
          CODEMPRESA,
          NRBANCO,
          OBS1,
          OBS2)
        values(
          :CODCONTA,
          'ABERTO',
          'RECEBER',
          'FECHAMENTO DE PERÍODO ' || :LMES,
          CAST(extract(month from :INI) AS VARCHAR(20)) || '-' || :CODFAMILIA,
          :CODFAMILIA,
          current_date,
          :DATAVENCIMENTO,
          cast(:DATAVENCIMENTO - current_timestamp as integer),
          '01/01',
          'BOLETO BANCÁRIO',
          :valorparcela,
          :valorparcela,
          NULL,
          :EUS_CADAST,
          'NOW',
          0,
          0,
          0,
          NULL,
          NULL,
          NULL,
          NULL,
          0,
          0,
          0,
          0,
          0,
          0,
          2,
          NULL,
          NULL,
          2,
          1,
          '341',
          'PERÍODO DO EXTRATO: ' ||
               RIGHT('00' || cast((extract(day from :INI)) as varchar(2)), 2) ||
               '/' ||
               RIGHT('00' || cast((extract(month from :INI)) as varchar(2)), 2) ||
               '/' ||
               extract(year from :INI) || ' À ' ||  RIGHT('00' || cast((extract(day from :FIM)) as varchar(2)), 2) ||
               '/' ||
               RIGHT('00' || cast((extract(month from :FIM)) as varchar(2)), 2) ||
               '/' ||
               extract(year from :FIM),
               :LOBS2);

        LFILHOATUAL = 1;

        insert into CONTA_CENTCUSTO (CODCENTCUSTO,CODCONTA, VALOR, CODEMPRESA) values (385,:CODCONTA, :TOTAL_FAMILIA * (-1),1);
    end

    if (:TOTAL_FAMILIA * (-1) > COALESCE(VALORMINIMO,0)) then
    begin
       insert into
          EXTRATO_ALUNO (
            CODPESSOA,
            VALOR,
            US_CADAST,
            DT_CADAST)
        values (
            :CODALUNO,
            :SALDO * (-1),
            'SISTEMA',
            CAST(:FIM AS DATE) || ' 23:59:59');
    end

    SUSPEND;

    LCODFAMILIA = CODFAMILIA;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE FR01_MARFIM_DESCONTOS(
    INI DATE,
    FIM DATE)
RETURNS (
    CODPEDVEND INTEGER,
    USUARIO_LIBEROU VARCHAR(45),
    NOTAFISCAL VARCHAR(30),
    TIPOFRETE VARCHAR(10),
    VALORDESCONTO DOUBLE PRECISION,
    CODPESSOA INTEGER,
    CODVENDEDOR INTEGER,
    PESSOA VARCHAR(60),
    VENDEDOR VARCHAR(60),
    VALOR_TOTAL DOUBLE PRECISION,
    DESCPEDVEND DOUBLE PRECISION,
    CODPRODFILHO INTEGER,
    DESCRICAO VARCHAR(60),
    QTDE DOUBLE PRECISION,
    PRECOPROD DOUBLE PRECISION,
    PRECOPRODTABELA DOUBLE PRECISION,
    DESCONTO_VALOR DOUBLE PRECISION,
    PRECOVEND DOUBLE PRECISION,
    DTFATURADO DATE,
    DESCONTO DOUBLE PRECISION,
    IDENIZACAO CHAR(1),
    PRECOUSADO VARCHAR(10),
    TIPOPED VARCHAR(10),
    FLEXEMBUTE DOUBLE PRECISION,
    FORMAPAG VARCHAR(45),
    CODSUPERVISOR INTEGER,
    SUPERVISOR VARCHAR(60))
AS
declare variable lcodanalisecriterio integer;
declare variable lcodfaturamento integer;
declare variable lserie varchar(3);
declare variable lcodtipopag integer;
begin
  select
    A.CODANALISECRITERIO
  from
    ANALISECRITERIO A
  where
    A.ATIVO = 'S' and
    A.NOME = 'MANALISADESCOTNO'
  into
    :LCODANALISECRITERIO;

  if (LCODANALISECRITERIO is not null) then
  begin
    for select
      distinct
      PC.CODPEDVEND,
      PC.USUARIO_LIBEROU,
      P.DTFATURADO
    from
      PEDVEND P
      join PEDVEND_CRITICADOS PC on P.CODPEDVEND = PC.CODPEDVEND
      join VENDEDOR VE on P.codvendedor = VE.codvendedor
    where
      PC.TIPO_CRITICA = :LCODANALISECRITERIO and
      cast(P.DTFATURADO as date) between :INI and :FIM and
      P.STATUSPED = 'FATURADO'
      --AND VE.nome starting WITH 'P&G'
    into
      CODPEDVEND,
      USUARIO_LIBEROU,
      DTFATURADO
    do
    begin
      LCODFATURAMENTO = null;
      LSERIE = null;
      select 
        case coalesce(PEDVEND.TIPOFRETE,1)
          when 1 then 'EMPRESA'
          when 2 then 'CLIENTE'
          when 3 then 'VENDEDOR'
        end,
        nullif(CODFATURAMENTO,0),
        PESSOA.CODPESSOA,
        PESSOA.NOME,
        VENDEDOR.CODVENDEDOR,
        VENDEDOR.NOME,
        PEDVEND.VALOR_TOTAL,
        (coalesce(PEDVEND.DESC_VALOR,0) + coalesce(PEDVEND.DESCPERC_VALOR,0)),
        coalesce(PEDVEND.IDENIZACAO,'N'),
        PEDVEND.PRECOUSADO,
        PEDVEND.TIPOPED,
        PEDVEND.CODTIPOPAG
      from
        PEDVEND
        join PESSOA on PEDVEND.CODPESSOA = PESSOA.CODPESSOA
        join VENDEDOR on PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
      where
        CODPEDVEND = :CODPEDVEND
      into
        :TIPOFRETE,
        :LCODFATURAMENTO,
        :CODPESSOA,
        :PESSOA,
        :CODVENDEDOR,
        :VENDEDOR,
        :VALOR_TOTAL,
        :DESCPEDVEND,
        :IDENIZACAO,
        :PRECOUSADO,
        :TIPOPED,
        :LCODTIPOPAG;

      select
        supervisor.codsupervisor,
        supervisor.nome
      from
        VENDEDOR
         join supervisor on (supervisor.codsupervisor = VENDEDOR.codsupervisor)
      where
        VENDEDOR.codvendedor =  :CODVENDEDOR
      into
        :codsupervisor,
        :supervisor;


      select
        DESCRICAO
      from
        TIPOPAG
      where
        CODTIPOPAG = :LCODTIPOPAG
      into
        :FORMAPAG;

      select
        cast(((sum(PI.QTDENTREGUE * PI.PRECOPROD) - sum(PI.QTDENTREGUE * PI.PRECOPRODTABELA)) * 100 / coalesce(nullif(sum(PI.QTDENTREGUE * PI.PRECOPRODTABELA), 0), 1)) as numeric (18,3))
      from
        PEDVENDITEM PI
      where
        CODPEDVEND = :CODPEDVEND or
        CODPEDVEND is null
      into
        FLEXEMBUTE;

      if (LCODFATURAMENTO is null) then
      begin
        select
          CODNFVENDA,
          RIGHT('000'||coalesce(SERIE,'000'),3),
          NFVENDA.TOTALNOTA
        from
          NFVENDA
        where
          CODPEDVEND = :CODPEDVEND and
          STATUS = 'F'
        into
          LCODFATURAMENTO,
          LSERIE,
          VALOR_TOTAL;
      end
      LSERIE = coalesce(LSERIE,'');
      LCODFATURAMENTO = coalesce(LCODFATURAMENTO,0);

      if (LSERIE <> '') then
        NOTAFISCAL = RIGHT('0000000000'||coalesce(LCODFATURAMENTO,0),10)||'-'||LSERIE;
      else
        NOTAFISCAL = RIGHT('0000000000'||coalesce(LCODFATURAMENTO,0),10);

      select
        cast(sum(PI.DESCONTO_VALOR) as numeric (18,3))
      from
        PEDVENDITEM PI
        join PEDVEND_CRITICADOS PC on PI.CODPEDVEND = PC.CODPEDVEND and
          PI.CODPRODFILHO = PC.CODPRODFILHO
        join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
      where
        PC.TIPO_CRITICA = :LCODANALISECRITERIO and
        PC.CODPEDVEND = :CODPEDVEND and
        PC.USUARIO_LIBEROU = :USUARIO_LIBEROU
      into
        VALORDESCONTO;

      for select
        PC.CODPRODFILHO,
        PF.DESCRICAO,
        PI.QTDE,
        cast(PI.PRECOPROD as numeric (18,3)),
        PI.PRECOPRODTABELA,
        cast(PI.DESCONTO_VALOR as numeric (18,3)),
        cast(PI.DESCONTO as numeric (18,3)),
        cast(PI.PRECOVEND as numeric (18,3))
      from
        PEDVENDITEM PI
        join PEDVEND_CRITICADOS PC on PI.CODPEDVEND = PC.CODPEDVEND and
          PI.CODPRODFILHO = PC.CODPRODFILHO
        join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
      where
        PC.TIPO_CRITICA = :LCODANALISECRITERIO and
        PC.CODPEDVEND = :CODPEDVEND and
        PC.USUARIO_LIBEROU = :USUARIO_LIBEROU
      into
        :CODPRODFILHO,
        :DESCRICAO,
        :QTDE,
        :PRECOPROD,
        :PRECOPRODTABELA,
        :DESCONTO_VALOR,
        :DESCONTO,
        :PRECOVEND
      do
      begin
        suspend;
      end
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE FR01_MARFIM_DESCONTOSAUTORIZADO(
    INI DATE,
    FIM DATE)
RETURNS (
    CODPEDVEND INTEGER,
    USUARIO_LIBEROU VARCHAR(45),
    NOTAFISCAL VARCHAR(30),
    TIPOFRETE VARCHAR(10),
    VALORDESCONTO DOUBLE PRECISION,
    CODPESSOA INTEGER,
    CODVENDEDOR INTEGER,
    PESSOA VARCHAR(60),
    VENDEDOR VARCHAR(60),
    VALOR_TOTAL DOUBLE PRECISION,
    DESCPEDVEND DOUBLE PRECISION,
    CODPRODFILHO INTEGER,
    DESCRICAO VARCHAR(60),
    QTDE DOUBLE PRECISION,
    PRECOPROD DOUBLE PRECISION,
    PRECOPRODTABELA DOUBLE PRECISION,
    DESCONTO_VALOR DOUBLE PRECISION,
    PRECOVEND DOUBLE PRECISION,
    DTFATURADO DATE,
    DESCONTO DOUBLE PRECISION,
    IDENIZACAO CHAR(1),
    PRECOUSADO VARCHAR(10),
    TIPOPED VARCHAR(10),
    FLEXEMBUTE DOUBLE PRECISION,
    FORMAPAG VARCHAR(45))
AS
declare variable LCODANALISECRITERIO integer;
declare variable LCODFATURAMENTO integer;
declare variable LSERIE varchar(3);
declare variable LCODTIPOPAG integer;
begin
  select
    A.CODANALISECRITERIO
  from
    ANALISECRITERIO A
  where
    A.ATIVO = 'S' and
    A.NOME = 'MANALISADESCOTNO'
  into
    :LCODANALISECRITERIO;

  if (LCODANALISECRITERIO is not null) then
  begin
    for select
      distinct
      PC.CODPEDVEND,
      PC.USUARIO_LIBEROU,
      P.DTFATURADO
    from
      PEDVEND P
      join PEDVEND_CRITICADOS PC on P.CODPEDVEND = PC.CODPEDVEND
    where
      PC.TIPO_CRITICA = :LCODANALISECRITERIO and
      cast(P.DTFATURADO as date) between :INI and :FIM and
      P.STATUSPED = 'FATURADO'
    into
      CODPEDVEND,
      USUARIO_LIBEROU,
      DTFATURADO
    do
    begin
      LCODFATURAMENTO = null;
      LSERIE = null;
      select 
        case coalesce(PEDVEND.TIPOFRETE,1)
          when 1 then 'EMPRESA'
          when 2 then 'CLIENTE'
          when 3 then 'VENDEDOR'
        end,
        nullif(CODFATURAMENTO,0),
        PESSOA.CODPESSOA,
        PESSOA.NOME,
        VENDEDOR.CODVENDEDOR,
        VENDEDOR.NOME,
        PEDVEND.VALOR_TOTAL,
        (coalesce(PEDVEND.DESC_VALOR,0) + coalesce(PEDVEND.DESCPERC_VALOR,0)),
        coalesce(PEDVEND.IDENIZACAO,'N'),
        PEDVEND.PRECOUSADO,
        PEDVEND.TIPOPED,
        PEDVEND.CODTIPOPAG
      from
        PEDVEND
        join PESSOA on PEDVEND.CODPESSOA = PESSOA.CODPESSOA
        join VENDEDOR on PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
      where
        CODPEDVEND = :CODPEDVEND
      into
        :TIPOFRETE,
        :LCODFATURAMENTO,
        :CODPESSOA,
        :PESSOA,
        :CODVENDEDOR,
        :VENDEDOR,
        :VALOR_TOTAL,
        :DESCPEDVEND,
        :IDENIZACAO,
        :PRECOUSADO,
        :TIPOPED,
        :LCODTIPOPAG;

      select
        DESCRICAO
      from
        TIPOPAG
      where
        CODTIPOPAG = :LCODTIPOPAG
      into
        :FORMAPAG;

      select
        cast(((sum(PI.QTDENTREGUE * PI.PRECOPROD) - sum(PI.QTDENTREGUE * PI.PRECOPRODTABELA)) * 100 / coalesce(nullif(sum(PI.QTDENTREGUE * PI.PRECOPRODTABELA), 0), 1)) as numeric (18,3))
      from
        PEDVENDITEM PI
      where
        CODPEDVEND = :CODPEDVEND or
        CODPEDVEND is null
      into
        FLEXEMBUTE;

      if (LCODFATURAMENTO is null) then
      begin
        select
          CODNFVENDA,
          RIGHT('000'||coalesce(SERIE,'000'),3),
          NFVENDA.TOTALNOTA
        from
          NFVENDA
        where
          CODPEDVEND = :CODPEDVEND and
          STATUS = 'F'
        into
          LCODFATURAMENTO,
          LSERIE,
          VALOR_TOTAL;
      end
      LSERIE = coalesce(LSERIE,'');
      LCODFATURAMENTO = coalesce(LCODFATURAMENTO,0);

      if (LSERIE <> '') then
        NOTAFISCAL = RIGHT('0000000000'||coalesce(LCODFATURAMENTO,0),10)||'-'||LSERIE;
      else
        NOTAFISCAL = RIGHT('0000000000'||coalesce(LCODFATURAMENTO,0),10);

      select
        cast(sum(PI.DESCONTO_VALOR) as numeric (18,3))
      from
        PEDVENDITEM PI
        join PEDVEND_CRITICADOS PC on PI.CODPEDVEND = PC.CODPEDVEND and
          PI.CODPRODFILHO = PC.CODPRODFILHO
        join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
      where
        PC.TIPO_CRITICA = :LCODANALISECRITERIO and
        PC.CODPEDVEND = :CODPEDVEND and
        PC.USUARIO_LIBEROU = :USUARIO_LIBEROU
      into
        VALORDESCONTO;

      for select
        PC.CODPRODFILHO,
        PF.DESCRICAO,
        PI.QTDE,
        cast(PI.PRECOPROD as numeric (18,3)),
        PI.PRECOPRODTABELA,
        cast(PI.DESCONTO_VALOR as numeric (18,3)),
        cast(PI.DESCONTO as numeric (18,3)),
        cast(PI.PRECOVEND as numeric (18,3))
      from
        PEDVENDITEM PI
        join PEDVEND_CRITICADOS PC on PI.CODPEDVEND = PC.CODPEDVEND and
          PI.CODPRODFILHO = PC.CODPRODFILHO
        join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
      where
        PC.TIPO_CRITICA = :LCODANALISECRITERIO and
        PC.CODPEDVEND = :CODPEDVEND and
        PC.USUARIO_LIBEROU = :USUARIO_LIBEROU
      into
        :CODPRODFILHO,
        :DESCRICAO,
        :QTDE,
        :PRECOPROD,
        :PRECOPRODTABELA,
        :DESCONTO_VALOR,
        :DESCONTO,
        :PRECOVEND
      do
      begin
        suspend;
      end
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE GERAFINANCEIRO_PEDIDO_COMP(
    ECODPEDVEND INTEGER,
    EUSUARIO VARCHAR(45),
    ECODTIPOPAG INTEGER)
AS
declare variable LDT_SAIDA date;
declare variable LDT_ULTIMOVENC date;
declare variable LCONT integer;
declare variable LDT_VENCIM date;
declare variable LVLPARCELA double precision;
declare variable LCODTIPOPAG integer;
declare variable LTIPOPAG varchar(20);
declare variable LNRPRESTACAO integer;
declare variable LNRDIASPRIMEIRA integer;
declare variable LNRDIAS integer;
declare variable LVLRESTA double precision;
declare variable LCODCONTA integer;
declare variable LSTATUS varchar(10);
declare variable LPARCELA varchar(5);
declare variable LNRDOCUMENTO varchar(30);
declare variable QDIVIDPACE integer;
declare variable LCODPESSOA integer;
declare variable LCODVENDEDOR integer;
declare variable LCODEMPRESA integer;
declare variable LCODCENTCUSTO integer;
declare variable LCODTIPOPAGPADRAO integer;
declare variable LTOTAL_VENDA double precision;
declare variable LTOTAL_FINANCEIRO double precision;
declare variable LDIFERENCA double precision;
declare variable LDESCRICAO varchar(60);
begin
  select
    CODPESSOA,
    CODVENDEDOR,
    CODEMPRESA,
    DT_SAIDA,
    VALOR_TOTAL
  from
    PEDVEND
  where
    CODPEDVEND = :ECODPEDVEND
  into
    LCODPESSOA,
    LCODVENDEDOR,
    LCODEMPRESA,
    LDT_SAIDA,
    LTOTAL_VENDA;

  select
    max(CONTA.DT_VENCIM),
    sum(CONTA.VLPARCELA)
  from
    CONTA
  where
    CODPENDVEND = :ECODPEDVEND
  into
    LDT_ULTIMOVENC,
    LTOTAL_FINANCEIRO;

  LDIFERENCA = LTOTAL_VENDA - LTOTAL_FINANCEIRO;

  if (LDIFERENCA > 0) then
  begin

    if (:ECODTIPOPAG is null) then
    begin
      select
        VALOR
      from
        MLERPARAMETROINTEIRO('CODIGO DO TIPO DE PAGAMENTO COMPLEMENTO', null)
      into
        LCODTIPOPAGPADRAO;
    
      if (LCODTIPOPAGPADRAO is null) then
        exception EXCECAO('parÃ¢metro dinÃ¢mico "CODIGO DO TIPO DE PAGAMENTO COMPLEMENTO" nÃ£o configurado para executar essa operaÃ§Ã£o!');
    end
    else
      LCODTIPOPAGPADRAO = :ECODTIPOPAG;

    select
      TIPOPAG.CODTIPOPAG,
      TIPOPAG.TIP_TIPO,
      TIPOPAG.NRPRESTACAO,
      TIPOPAG.NRDIASPRIMEIRA,
      TIPOPAG.NRDIAS,
      nullif(TIPOPAG.CODCENTCUSTO,0)
    from
      TIPOPAG
    where
      CODTIPOPAG = :LCODTIPOPAGPADRAO
    into
      LCODTIPOPAG,
      LTIPOPAG,
      LNRPRESTACAO,
      LNRDIASPRIMEIRA,
      LNRDIAS,
      LCODCENTCUSTO;

    if (LCODCENTCUSTO is null) then
      exception EXCECAO('Centro de custo nÃ£o configurado para a forma de pagamento de cÃ³digo '||LCODCENTCUSTO||' ! ');

    insert into PEDVENDPRAZOS(
      PEDVENDPRAZOS.CODPEDVEND_FK,
      PEDVENDPRAZOS.CODTIPOPAG,
      PEDVENDPRAZOS.TIPOPAG,
      PEDVENDPRAZOS.VALOR)
    values(
      :ECODPEDVEND,
      :LCODTIPOPAG,
      :LTIPOPAG,
      :LDIFERENCA);

    LVLRESTA = LDIFERENCA;
    LCONT = 1;
    while (LCONT <= LNRPRESTACAO) do
    begin
      QDIVIDPACE = 1 + (LNRPRESTACAO - LCONT);
      LVLPARCELA =  cast((LVLRESTA / QDIVIDPACE) as numeric(18,2));

      LCODCONTA    = gen_id(GEN_CONTA, 1);
      LSTATUS      = 'ABERTO';
      LNRDOCUMENTO = ECODPEDVEND;
  
      LPARCELA     = RIGHT('00'||LCONT,2)||'/'||RIGHT('00'||LNRPRESTACAO,2);
      LDESCRICAO   = 'FECHAMENTO DE CONTRATO - COMPLEMENTO';

      if (LCONT = 1) then
        LDT_VENCIM = LDT_ULTIMOVENC + LNRDIASPRIMEIRA;
      else
        LDT_VENCIM = LDT_VENCIM + LNRDIAS;

      insert into CONTA(
        CODCONTA,
        STATUS,
        TIPO,
        DESCRICAO,
        NRDOCUMENTO,
        CODPESSOA,
        DT_EMISSAO,
        DT_VENCIM,
        DIAS,
        PARCELA,
        PREV_TIPOPAG,
        VLPARCELA,
        VLTOTAL,
        CODCENTCUSTO,
        US_CADAST,
        DT_CADAST,
        TOTDESCONTO,
        TOTJUROS,
        TOTPAGO,
        CODPENDVEND,
        CODNFVENDA,
        CODCARTAO,
        CODVENDEDOR,
        VLRNEGOCIA,
        COMISTIPOPAG,
        PERCJUROS,
        CART_PERC,
        CART_VALOR,
        CODBANCO,
        SERIENF,
        DESC_FINANCEIRO,
        CODCONTABANCO,
        CODEMPRESA,
        COMISCARTAO,
        NRBANCO,
        CODTIPOPAG)
      values(
        :LCODCONTA,
        :LSTATUS,
        'RECEBER',
        :LDESCRICAO,
        :LNRDOCUMENTO,
        :LCODPESSOA,
        :LDT_SAIDA,
        :LDT_VENCIM,
        (:LDT_VENCIM - :LDT_SAIDA),
        :LPARCELA,
        :LTIPOPAG,
        :LVLPARCELA,
        :LTOTAL_VENDA,
        :LCODCENTCUSTO,
        :EUSUARIO,
        current_timestamp,
        0,
        0,
        0,
        :ECODPEDVEND,
        null,
        null,
        :LCODVENDEDOR,
        0,
        0,
        0,
        0,
        0,
        null,
        null,
        0,
        null,
        :LCODEMPRESA,
        null,
        null,
        :LCODTIPOPAG);
  
      if (LCODCENTCUSTO > 0) then
      begin
        insert into CONTA_CENTCUSTO(
          CODCENTCUSTO,
          CODCONTA,
          VALOR,
          CODEMPRESA)
        values(
          :LCODCENTCUSTO,
          :LCODCONTA,
          :LVLPARCELA,
          :LCODEMPRESA);
      end

      LVLRESTA = LVLRESTA - LVLPARCELA;
      LCONT    = LCONT + 1;
    end
  end
  else if (LDIFERENCA < 0) then
  begin
    LDIFERENCA = LDIFERENCA * -1;
    insert into PESSOA_SALDO (
      CODPESSOA,
      DATA,
      STATUS,
      VALOR,
      VALORUSADO,
      US_CADAST,
      DT_CADAST,
      OBSERVACAO)
    values (
      :LCODPESSOA,
      current_date,
      'ABERTO',
      :LDIFERENCA,
      0,
      :EUSUARIO,
      current_timestamp,
      'CREDITO GERADO PELA CONFERENCIA DE MEDIDAS');

    insert into MOVSALDO(
      MOVSALDO.CODPESSOA,
      MOVSALDO.VALOR,
      MOVSALDO.CODMOVIMENTACAO,
      MOVSALDO.CAMPOREFERENCIADO,
      MOVSALDO.LOCALORIGEM,
      MOVSALDO.TIPOMOV,
      MOVSALDO.DATAMOVIMENTACAO,
      MOVSALDO.OBSERVACAO)
    values(
      :LCODPESSOA,
      :LDIFERENCA,
      :ECODPEDVEND,
      'CODPEDVEND',
      'PEDVEND',
      'E',
      current_timestamp,
      'CREDITO GERADO PELA CONFERENCIA DE MEDIDAS');
  end
  when any do
  begin
    exception;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE GERAFINANCEIRO_PEDIDO_PRAZOS(
    ECODPEDVEND INTEGER,
    ECODEMPRESA INTEGER,
    ECODVENDEDOR INTEGER,
    ECODPESSOA INTEGER,
    EVALORTOTAL DOUBLE PRECISION,
    EDATAEMISSAO DATE,
    EUSUARIO VARCHAR(45))
AS
declare variable LCONT integer;
declare variable LDT_VENCIM date;
declare variable LVLPARCELA double precision;
declare variable LCODTIPOPAG integer;
declare variable LTIPOPAG varchar(20);
declare variable LNRPRESTACAO integer;
declare variable LNRDIASPRIMEIRA integer;
declare variable LNRDIAS integer;
declare variable LCODCARTAOCRED integer;
declare variable LCODBANCO integer;
declare variable LNRBANCO integer;
declare variable LVLPAGAMENTO double precision;
declare variable LVLRESTA double precision;
declare variable LCOMISPAGA double precision;
declare variable LCODCONTA integer;
declare variable LSTATUS varchar(10);
declare variable LPARCELA varchar(5);
declare variable LNRDOCUMENTO varchar(30);
declare variable QDIVIDPACE integer;
declare variable LBANCOPADRAO integer;
declare variable LCALCCARTAO varchar(3);
declare variable LCODCENTCUSTO integer;
declare variable LCODPESSOASALDO integer;
declare variable LCOMISCARTAO double precision;
declare variable LDESCRICAO varchar(60);
begin
  select
    VALOR
  from
    MLERPARAMETROINTEIRO('BANCO PADRÃO', null)
  into
    LBANCOPADRAO;

  LNRBANCO = null;
  if (LBANCOPADRAO is null) then
  begin
    select
      VALOR
    from
      MLERPARAMETROINTEIRO('BANCO PADRÃOII', null)
    into
      LBANCOPADRAO;
  end

  select
    CALCCARTAO
  from
    SYSPARAMS
  into
    :LCALCCARTAO;

  LCONT = 1;
  for select
    TIPOPAG.CODTIPOPAG,
    P.TIPOPAG,
    TIPOPAG.NRPRESTACAO,
    TIPOPAG.NRDIASPRIMEIRA,
    TIPOPAG.NRDIAS,
    P.VALOR,
    coalesce(P.CODBANCO_FK,:LBANCOPADRAO),
    P.CODCARTAOCRED_FK,
    P.CODCENTCUSTO,
    P.CODPESSOASALDO
  from
    PEDVENDPRAZOS P
    join TIPOPAG on
      P.CODTIPOPAG = TIPOPAG.CODTIPOPAG
  where
    P.CODPEDVEND_FK = :ECODPEDVEND
  order by
    1
  into
    LCODTIPOPAG,
    LTIPOPAG,
    LNRPRESTACAO,
    LNRDIASPRIMEIRA,
    LNRDIAS,
    LVLPAGAMENTO,
    LCODBANCO,
    LCODCARTAOCRED,
    LCODCENTCUSTO,
    LCODPESSOASALDO
  do
  begin
    select
      coalesce(COMISPAGA, 0) as COMISPAGA
    from
      CARTAOCRED
    where
      CODCARTAOCRED = :LCODCARTAOCRED
    into
      LCOMISPAGA;

    select
      cast(NRBANCO as integer)
    from
      BANCO
    where
      CODBANCO = :LCODBANCO
    into
      LNRBANCO;

    LVLRESTA = LVLPAGAMENTO;
    LCONT = 1;
    while (LCONT <= LNRPRESTACAO) do
    begin
      QDIVIDPACE = 1 + (LNRPRESTACAO - LCONT);
      LVLPARCELA =  cast((LVLRESTA / QDIVIDPACE) as numeric(18,2));

      LCODCONTA    = gen_id(GEN_CONTA, 1);
      LSTATUS      = 'ABERTO';
      LNRDOCUMENTO = ECODPEDVEND;
  
      LCOMISCARTAO = 0;
      if (LCALCCARTAO = 'SIM') then
      begin
        LCOMISCARTAO = LVLPARCELA * (coalesce(LCOMISPAGA,0) / 100);
        LVLPARCELA   = LVLPARCELA - coalesce(LCOMISCARTAO,0);
      end
      LPARCELA     = RIGHT('00'||LCONT,2)||'/'||RIGHT('00'||LNRPRESTACAO,2);
      LDESCRICAO   = 'FECHAMENTO DE CONTRATO';

      if (LCONT = 1) then
        LDT_VENCIM = EDATAEMISSAO + LNRDIASPRIMEIRA;
      else
        LDT_VENCIM = LDT_VENCIM + LNRDIAS;

      insert into CONTA(
        CODCONTA,
        STATUS,
        TIPO,
        DESCRICAO,
        NRDOCUMENTO,
        CODPESSOA,
        DT_EMISSAO,
        DT_VENCIM,
        DIAS,
        PARCELA,
        PREV_TIPOPAG,
        VLPARCELA,
        VLTOTAL,
        CODCENTCUSTO,
        US_CADAST,
        DT_CADAST,
        TOTDESCONTO,
        TOTJUROS,
        TOTPAGO,
        CODPENDVEND,
        CODNFVENDA,
        CODCARTAO,
        CODVENDEDOR,
        VLRNEGOCIA,
        COMISTIPOPAG,
        PERCJUROS,
        CART_PERC,
        CART_VALOR,
        CODBANCO,
        SERIENF,
        DESC_FINANCEIRO,
        CODCONTABANCO,
        CODEMPRESA,
        COMISCARTAO,
        NRBANCO,
        CODTIPOPAG)
      values(
        :LCODCONTA,
        :LSTATUS,
        'RECEBER',
        :LDESCRICAO,
        :LNRDOCUMENTO,
        :ECODPESSOA,
        :EDATAEMISSAO,
        :LDT_VENCIM,
        (:LDT_VENCIM - :EDATAEMISSAO),
        :LPARCELA,
        :LTIPOPAG,
        :LVLPARCELA,
        :EVALORTOTAL,
        :LCODCENTCUSTO,
        :EUSUARIO,
        current_timestamp,
        0,
        0,
        0,
        :ECODPEDVEND,
        null,
        :LCODCARTAOCRED,
        :ECODVENDEDOR,
        0,
        0,
        0,
        0,
        0,
        :LCODBANCO,
        null,
        0,
        null,
        :ECODEMPRESA,
        :LCOMISCARTAO,
        :LNRBANCO,
        :LCODTIPOPAG);
  
      if (LCODCENTCUSTO > 0) then
      begin
        insert into CONTA_CENTCUSTO(
          CODCENTCUSTO,
          CODCONTA,
          VALOR,
          CODEMPRESA)
        values(
          :LCODCENTCUSTO,
          :LCODCONTA,
          :LVLPARCELA,
          :ECODEMPRESA);
      end

      LVLRESTA = LVLRESTA - LVLPARCELA;
      LCONT    = LCONT + 1;
    end
  end
  when any do
  begin
    exception;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE LCDPR_BLOCO_Q100_PAG_FOLHA_AUX(
    DTINI DATE,
    DTFIM DATE,
    P_CODEMPRESA INTEGER,
    P_CODCONTABANCO INTEGER)
RETURNS (
    DATA DATE,
    CODEMPRESA INTEGER,
    CODCONTABANCO INTEGER,
    TIPO VARCHAR(10),
    HISTORICO VARCHAR(202),
    CPFCGC VARCHAR(18),
    VALOR DOUBLE PRECISION,
    TIPO_DOC VARCHAR(10))
AS
declare variable LMES_INI integer;
declare variable LANO_INI integer;
declare variable LMES_FIM integer;
declare variable LANO_FIM integer;
declare variable LDATA_INI date;
declare variable LDATA_FIM date;
declare variable LCONTADOR integer;
BEGIN
  --Data inicial Mês e Ano
  LMES_INI = extract (month from cast(DTINI as date));
  LANO_INI = extract (year from cast(DTINI as date));
  LCONTADOR = LMES_INI;

  --Data final Mês e Ano
  LMES_FIM = extract (month from cast(DTFIM as date));
  LANO_FIM = extract (year from cast(DTFIM as date));

  while ( LCONTADOR <= LMES_FIM ) do
  begin

    LDATA_INI = '01.'|| RIGHT('00' || cast( :LCONTADOR as varchar(2)), 2 ) || '.' || :LANO_INI;
  
    if (LCONTADOR = 12) then
    begin
      LDATA_FIM = '31.12.' || :LANO_FIM;
    end
    else
      LDATA_FIM = '01.' || RIGHT('00' || cast( (:LCONTADOR + 1) as varchar(2)), 2)  || '.' || :LANO_FIM;

    select
      max(cast(CONTABX.DT_PAGAMEN as date)),
      CONTA.CODEMPRESA,
      CONTABX.CODCONTABANCO,
      CONTA.TIPO,
      'FOLHA DE PAGAMENTO E ENCARGOS' DESCRICAO,
      (select
        EMPRESA.CGC
       from
        EMPRESA
       where
        EMPRESA.CODEMPRESA =:P_CODEMPRESA ) as CPFCGC,
      '5' TIPO_DOC,
      sum(CONTABX.VLPAGO)
    from
      CONTA
      join CONTABX on
        CONTA.CODCONTA = CONTABX.CODCONTA
      join PESSOA on
        CONTA.CODPESSOA = PESSOA.CODPESSOA
    where
      cast(CONTABX.DT_PAGAMEN as date) between :LDATA_INI and (:LDATA_FIM - 1)
      and CONTA.CODEMPRESA = :P_CODEMPRESA
      and CONTA.CONTABILIDADE_EXPORTA = 1
      and CONTABX.CODCONTABANCO = :P_CODCONTABANCO
      and coalesce(CONTA.NRFORMULARIO, '6') = '5'
    group by
      2,3,4,5,6
    into
      DATA,
      CODEMPRESA,
      CODCONTABANCO,
      TIPO,
      HISTORICO,
      CPFCGC,
      TIPO_DOC,
      VALOR;
      
    suspend;
    LCONTADOR = LCONTADOR + 1;
    DATA = null;
    CODEMPRESA = Null;
    CODCONTABANCO = null;
    TIPO = null;
    HISTORICO = null;
    CPFCGC = null;
    TIPO_DOC = null;
    VALOR = 0;
  end
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE LCDPR_BLOCO_Q100_PRINCIPAL(
    DTINI DATE,
    DTFIM DATE)
RETURNS (
    DATA DATE,
    CODEMPRESA INTEGER,
    CODCONTABANCO INTEGER,
    TIPO VARCHAR(10),
    HISTORICO VARCHAR(202),
    CPFCGC VARCHAR(18),
    VALOR DOUBLE PRECISION,
    SLD_VL DOUBLE PRECISION,
    TIPO_DOC VARCHAR(10))
AS
declare variable LSLD_VL_FOLHA double precision;
declare variable LCODCONTABANCO integer;
declare variable LCODEMPRESA integer;

declare variable LMES_INI integer;
declare variable LANO_INI integer;
declare variable LMES_FIM integer;
declare variable LANO_FIM integer;
declare variable LDATA_INI date;
declare variable LDATA_FIM date;
declare variable LCONTADOR integer;

-- Variaveis para calcular o Saldo
declare variable LVALOR double precision;
declare variable LDESPESA_VL double precision;
declare variable LRECEITA_VL double precision;
declare variable LSLD_VL double precision;

BEGIN
  --Data inicial Mês e Ano
  LMES_INI = extract (month from cast(DTINI as date));
  LANO_INI = extract (year from cast(DTINI as date));
  LCONTADOR = LMES_INI;

  --Data final Mês e Ano
  LMES_FIM = extract (month from cast(DTFIM as date));
  LANO_FIM = extract (year from cast(DTFIM as date));


  LDESPESA_VL = 0;
  LRECEITA_VL = 0;
  LSLD_VL  = 0;
  SLD_VL = 0;
  VALOR = 0;
  LSLD_VL_FOLHA = 0;

  for select
    CODEMPRESA
  from
    LCDPR_BLOCO_0040
  into
    LCODEMPRESA
  do
  begin
    for select
      CB.CODCONTABANCO
    from
      BANCO
      join CONTABANCO CB on
        BANCO.CODBANCO = CB.CODBANCO
    where
      CB.TIPO = 'CORRENTE'
    order by
      1
    into
      LCODCONTABANCO
    do
    begin
      -- Quando for uma nova conta, recomeça tudo
      LCONTADOR = LMES_INI;
      LDESPESA_VL = 0;
      LRECEITA_VL = 0;
      LSLD_VL  = 0;
      SLD_VL = 0;
      VALOR = 0;
      LSLD_VL_FOLHA = 0;

      while ( LCONTADOR <= LMES_FIM ) do
      begin
        LDATA_INI = '01.'|| RIGHT('00' || cast( :LCONTADOR as varchar(2)), 2 ) || '.' || :LANO_INI;
    
        if (LCONTADOR = 12) then
        begin
          LDATA_FIM = '31.12.' || :LANO_FIM;
        end
        else
          LDATA_FIM = '01.' || RIGHT('00' || cast( (:LCONTADOR + 1) as varchar(2)), 2)  || '.' || :LANO_FIM;
    
        for select
          DATA,
          CODEMPRESA,
          CODCONTABANCO,
          TIPO,
          HISTORICO,
          CPFCGC,
          VALOR,
          TIPO_DOC
        from
          LCDPR_BLOCO_Q100_PAG_FOLHA_AUX(:LDATA_INI, (:LDATA_FIM - 1),:LCODEMPRESA,:LCODCONTABANCO)
        into
          DATA,
          CODEMPRESA,
          CODCONTABANCO,
          TIPO,
          HISTORICO,
          CPFCGC,
          LVALOR,
          TIPO_DOC
        do
        begin
          if (LVALOR > 0) then
          begin
            LSLD_VL_FOLHA = LVALOR;
            VALOR = LVALOR;
            LSLD_VL = LSLD_VL - LSLD_VL_FOLHA;
            
            if (LSLD_VL < 0 ) then
            begin
              SLD_VL = LSLD_VL;
              SLD_VL = SLD_VL * (-1);
            end
            else
              SLD_VL = LSLD_VL;

            if ( ( CODCONTABANCO = 1 ) or ( CODCONTABANCO = 4 ) or ( CODCONTABANCO = 5 ) or ( CODCONTABANCO = 6 ) or ( CODCONTABANCO = 8 ) )then
            begin
              CODCONTABANCO = 0;
            end

            suspend;
          end
          else
            VALOR = LVALOR;

          FOR select
            DATA,
            CODEMPRESA,
            CODCONTABANCO,
            TIPO,
            HISTORICO,
            CPFCGC,
            VALOR,
            SLD_VL,
            TIPO_DOC
          from
            LCDPR_BLOCO_Q100(:LDATA_INI, (:LDATA_FIM - 1), :LCODEMPRESA, :LCODCONTABANCO)
          into
            DATA,
            CODEMPRESA,
            CODCONTABANCO,
            TIPO,
            HISTORICO,
            CPFCGC,
            LVALOR,
            SLD_VL,
            TIPO_DOC
          do
          begin

            if ( ( CODCONTABANCO = 1 ) or ( CODCONTABANCO = 4 ) or ( CODCONTABANCO = 5 ) or ( CODCONTABANCO = 6 ) or ( CODCONTABANCO = 8 ) )then
            begin
              CODCONTABANCO = 0;
            end

            if ( TIPO = 'PAGAR' ) then
              LDESPESA_VL = LVALOR;
            else
              LRECEITA_VL = LVALOR;

            VALOR = LVALOR;

            LSLD_VL = LSLD_VL + (LRECEITA_VL - LDESPESA_VL);
        
            if (LSLD_VL < 0 ) then
            begin
              SLD_VL = LSLD_VL;
              SLD_VL = SLD_VL * (-1);
            end
            else
              SLD_VL = LSLD_VL;
        
            LDESPESA_VL = 0;
            LRECEITA_VL = 0;
            LSLD_VL_FOLHA = 0;


            suspend;
            DATA = null;
            CODEMPRESA = null;
            CODCONTABANCO = null;
            TIPO = null;
            HISTORICO = null;
            CPFCGC = null;
            VALOR = null;
            SLD_VL = null;
            TIPO_DOC = null;
          end
        end
    
        LCONTADOR = LCONTADOR + 1;
      end

    end
  end
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE LCDPR_BLOCO_Q200(
    DTINI DATE,
    DTFIM DATE)
RETURNS (
    MES_ANO VARCHAR(6),
    VL_ENTRADA DOUBLE PRECISION,
    VL_SAIDA DOUBLE PRECISION,
    SLD_FIN DOUBLE PRECISION)
AS
declare variable LMES integer;
declare variable LANO integer;
declare variable LDATA_INI date;
declare variable LDATA_FIM date;
BEGIN

  SLD_FIN    = 0;
  VL_ENTRADA = 0;
  VL_SAIDA   = 0;

  FOR select
    extract (month from cast(DATA as date)),
    extract (year from cast(DATA as date)),
    sum(VALOR)
  from
    LCDPR_BLOCO_Q100_AUX(:DTINI,:DTFIM)
  where
    TIPO = 'PAGAR'
  group by 1,2
  INTO
    LMES,
    LANO,
    VL_SAIDA
  DO
  BEGIN
    MES_ANO = :LMES || :LANO;

    LDATA_INI = '01.'|| RIGHT('00' || cast( :LMES as varchar(2)), 2 ) || '.' || :LANO;

    if (LMES = 12) then
    begin
      LDATA_FIM = '31.12.' || :LANO;
    end
    else
      LDATA_FIM = '01.' || RIGHT('00' || cast( (:LMES + 1) as varchar(2)), 2)  || '.' || :LANO;

    select
      SUM(VALOR)
    from
      LCDPR_BLOCO_Q100_AUX(:LDATA_INI , (:LDATA_FIM -1 ) )
    where
      TIPO = 'RECEBER'
    INTO
      VL_ENTRADA;

    SLD_FIN = VL_ENTRADA - VL_SAIDA;
    suspend;

    SLD_FIN    = 0;
    VL_ENTRADA = 0;
    VL_SAIDA   = 0;

  END

END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_CLIENTES
RETURNS (
    CNPJPDV VARCHAR(100),
    RAZAO_PDV VARCHAR(60),
    NOME_FANTASIA_PDV VARCHAR(60),
    PAIS_PDV VARCHAR(3),
    ESTADO_PDV VARCHAR(2),
    CIDADE_PDV VARCHAR(60),
    BAIRRO_PDV VARCHAR(60),
    ENDERECO_PDV VARCHAR(120),
    NOME_VENDEDOR VARCHAR(60),
    DT_CADASTRO VARCHAR(8),
    CEP_PDV VARCHAR(18),
    STATUS_PDV VARCHAR(1),
    CNPJDISTRIBUIDOR VARCHAR(100),
    EMAIL VARCHAR(45))
AS
BEGIN
  FOR select
    PESSOA.CPFCGC,
    PESSOA.NOME,
    PESSOA.NOMEFANTAZIA,
    'BRA',
    PESSOA.UF_1,
    PESSOA.CIDADE_1,
    PESSOA.BAIRRO_1,
    PESSOA.LOGRADOURO_1,
  vendedor.codvendedor  || ' - ' || VENDEDOR.NOME,
    extract(year from PESSOA.DT_CADAST)|| RIGHT('00' || extract(month from PESSOA.DT_CADAST), 2) || RIGHT('00' || extract(day from PESSOA.DT_CADAST), 2),
    (SELECT F.STRRESULT FROM FU_GETTIRAMASCARA(PESSOA.CEP_1) F) CEP_1,
    case
      when PESSOA.ATIVO = '2' then 'A' else 'I'
    end as ATIVO,
    PESSOA.EMAIL
  from
    PESSOA
      join VENDEDOR on VENDEDOR.CODVENDEDOR = PESSOA.CODVENDEDOR
  where
    PESSOA.TIPOPESSOA = 'Cliente'
  into
    :CNPJPDV,
    :RAZAO_PDV,
    :NOME_FANTASIA_PDV,
    :PAIS_PDV,
    :ESTADO_PDV,
    :CIDADE_PDV,
    :BAIRRO_PDV,
    :ENDERECO_PDV,
    :NOME_VENDEDOR,
    :DT_CADASTRO,
    :CEP_PDV,
    :STATUS_PDV,
    :EMAIL
  DO
  BEGIN
    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:CNPJPDV)
    into
      CNPJPDV;

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;

    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_ENTRADAS(
    INI DATE,
    FIM DATE)
RETURNS (
    CPFCGC VARCHAR(18),
    DOCUMENTO VARCHAR(15),
    STATUS CHAR(1),
    TOTNOTVLR INTEGER,
    QTD VARCHAR(30),
    DTEMISSAO VARCHAR(8),
    DTENTRADA VARCHAR(8))
AS
declare variable LCPFCGC varchar(18);
BEGIN
  FOR
    select
    P.CPFCGC,
    n.documento,
    CASE n.nfe_tipo
    WHEN 'ENTRADA' THEN 'E'
    ELSE
    'R'
    END STATUS,
    cast(n.totnotvlr as integer) totnotvlr,
    cast(sum(ni.qtd) as integer) QTD,
    (extract( year from n.dtemissao) || RIGHT('00' || extract(month from n.dtemissao), 2) || RIGHT('00' || extract(day from n.dtemissao), 2)) as dtemissao,
    (extract( year from n.dtentrada) || RIGHT('00' || extract(month from n.dtentrada), 2) || RIGHT('00' || extract(day from n.dtentrada), 2)) as dtentrada
    
    
    from
    nfentrada n join pessoa p on
    n.codpessoa = p.codpessoa
    join nfentradaitens ni on
    n.codnfentrada = ni.codnfentrada
    where
    cast(n.dt_cadast as date) between :ini and :fim
    group by
    1,2,3,4,6,7
    INTO :LCPFCGC,
         :DOCUMENTO,
         :STATUS,
         :TOTNOTVLR,
         :QTD,
         :DTEMISSAO,
         :DTENTRADA

  DO
  BEGIN
   SELECT F.STRRESULT FROM FU_GETTIRAMASCARA(:LCPFCGC) F
         INTO cpfcgc;
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_ESTOQUE(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    CNPJDISTRIBUIDOR VARCHAR(18),
    CNPJEMPRESA VARCHAR(18),
    DUN VARCHAR(30),
    QTDESTOQUE VARCHAR(30),
    DATA VARCHAR(8),
    LOTE VARCHAR(200),
    DTVAL VARCHAR(8))
AS
declare variable DTINI date;
declare variable DTFIM timestamp;
declare variable LCODPRODFILHO integer;
declare variable LQTDEMBALAGEM double precision;
declare variable LQTDESTOQUE double precision;
declare variable LESTOQUELOTE varchar(1);
begin
  DTINI = '01.'||extract(month from current_date)||'.'||extract(year from current_date);
  EDATAINI = cast(coalesce(EDATAINI,DTINI) as date);
  DTFIM = cast(coalesce(cast(EDATAFIM as timestamp),current_timestamp) as timestamp);

  for select
    PRODFILHO.CODPRODFILHO,
    PESSOA.CPFCGC,
    coalesce(PRODFILHO.CODPESQ2,PRODFILHO.CODPRODFILHO) DUN,
    PRODFILHO.QTDEMBALAGEM,
    (extract(year from current_date) || RIGHT('00' || extract(month from current_date), 2) || RIGHT('00' || extract(day from current_date), 2)) as DATA,
    PRODFILHOLOTES.LOTE,
    (extract( year from PRODFILHOLOTES.DATAVAL) || RIGHT('00' || extract(month from PRODFILHOLOTES.DATAVAL), 2) || RIGHT('00' || extract(day from PRODFILHOLOTES.DATAVAL), 2)) as DATAVAL,
    PRODFILHO.ESTOQUELOTE
  from
    PRODUTO
      join PRODFILHO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
      join PRODPESSOA on PRODPESSOA.CODPRODUTO = PRODUTO.CODPRODUTO
      join PESSOA on ((PESSOA.CODPESSOA = PRODPESSOA.CODPESSOA) and (PESSOA.TIPOPESSOA = 'Fornecedor'))
      Join prodfilholotes on prodfilho.codprodfilho = prodfilholotes.codprodfilho
  into
    LCODPRODFILHO,
    :CNPJEMPRESA,
    :DUN,
    :LQTDEMBALAGEM,
    :DATA,
    :lote,
    :dtval,
    :lestoquelote
  do
  begin
    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:CNPJEMPRESA)
    into
      :CNPJEMPRESA;
     if (lestoquelote = 'S') then
     begin
    select
      cast(SALDOFINAL as integer)
    from
      STP_MOVESTOQUE_RESUMO_LOTE(:LCODPRODFILHO,:DTFIM,:lote)
    into
      LQTDESTOQUE;
      end
      else
      begin
        select
      cast(SALDOFINAL as integer)
    from
      STP_MOVESTOQUE_RESUMO(:LCODPRODFILHO,:EDATAINI,:DTFIM)
    into
      LQTDESTOQUE;
      end


    if (coalesce(LQTDESTOQUE,0) > 0) then
      QTDESTOQUE = coalesce(cast(LQTDESTOQUE / coalesce(nullif(LQTDEMBALAGEM,1),1) as integer),0);

    QTDESTOQUE = coalesce(QTDESTOQUE,0);
   /* QTDESTOQUE = cast((cast(QTDESTOQUE as double precision) * 1000) as integer); */

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_PRODUTOS
RETURNS (
    CNPJ_FABRICANTE VARCHAR(100),
    DESC_FABRICANTE VARCHAR(100),
    COD_PRODUTO INTEGER,
    DESC_PRODUTO VARCHAR(100),
    COD_GRUPO INTEGER,
    DESC_GRUPO VARCHAR(100),
    COD_FAMILIA VARCHAR(18),
    DESC_FAMILIA VARCHAR(60),
    COD_SUBFAMILIA VARCHAR(18),
    DESC_SUBFAMILIA VARCHAR(60),
    TIPO_CODBARRAS VARCHAR(1),
    CODBARRAS VARCHAR(30),
    TIPO_EMBALAGEM VARCHAR(20),
    UNIDADE_PRODUTO VARCHAR(8),
    VOLUME_EMBALAGEM VARCHAR(15),
    STATUS_PRODUTO VARCHAR(1),
    DT_CADASTRO VARCHAR(8),
    CNPJDISTRIBUIDOR VARCHAR(100))
AS
BEGIN
  FOR select
    PESSOA.CPFCGC,
    PESSOA.NOME,
    PRODFILHO.CODPRODFILHO,
    PRODFILHO.DESCRICAO,
    PRODUTO.CODGRUPO,
    GRUPO.DESCRICAO,
    '' COD_FAMILIA,
    '' DESC_FAMILIA,
    '' COD_SUBFAMILIA,
    '' DESC_SUBFAMILIA,
    'E' TIPO_CODBARRAS,
    PRODFILHO.CODPESQ2,
    substring(PRODFILHO.UNIDADE from 1 for 8),
/*    UNIDADE.DESCRICAO, */
    'UN' SIGLA,
    PRODFILHO.QTDEMBALAGEM,
    case
      when PRODUTO.ATIVO = '2' then 'A' else 'I'
    end as STATUS_PRODUTO,
    (extract(year from PRODFILHO.DT_CADAST) || RIGHT('00' || extract(month from PRODFILHO.DT_CADAST), 2) || RIGHT('00' || extract(day from PRODFILHO.DT_CADAST), 2)) as DATA
  from
    PRODUTO
     join PRODFILHO on PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
     join PESSOA on ((PESSOA.CODPESSOA = PRODUTO.CODFABRICANTE) and (PESSOA.TIPOPESSOA = 'Fornecedor'))
     join GRUPO on GRUPO.CODGRUPO = PRODUTO.CODGRUPO
     join UNIDADE on UNIDADE.CODUNIDADE = PRODFILHO.CODUNIDADE
  INTO
    :CNPJ_FABRICANTE,
    :DESC_FABRICANTE,
    :COD_PRODUTO,
    :DESC_PRODUTO,
    :COD_GRUPO,
    :DESC_GRUPO,
    :COD_FAMILIA,
    :DESC_FAMILIA,
    :COD_SUBFAMILIA,
    :DESC_SUBFAMILIA,
    :TIPO_CODBARRAS,
    :CODBARRAS,
    :TIPO_EMBALAGEM,
    :UNIDADE_PRODUTO,
    :VOLUME_EMBALAGEM,
    :STATUS_PRODUTO,
    :DT_CADASTRO
  DO
  BEGIN
    VOLUME_EMBALAGEM = cast((cast(VOLUME_EMBALAGEM as double precision) * 1000) as integer);
    select
      STRRESULT
    from
       FU_GETTIRAMASCARA(:CNPJ_FABRICANTE)
    into
      CNPJ_FABRICANTE;

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;

    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMACCERA_VENDAS(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    DUN VARCHAR(30),
    CNPJCLIENTE VARCHAR(18),
    CLIENTE VARCHAR(60),
    CODSEGMENTO INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA VARCHAR(8),
    TIPOPED VARCHAR(10),
    TIPOPESSOA VARCHAR(1),
    PDV_EMPRESA VARCHAR(60),
    PDV_CEP VARCHAR(9),
    NOME_VENDEDOR VARCHAR(60),
    CODNFVENDA VARCHAR(14),
    VLRVENDIDO VARCHAR(30),
    QTDVENDIDA VARCHAR(30),
    LOTE VARCHAR(200),
    DATAVAL VARCHAR(8),
    QTD INTEGER,
    CFOP VARCHAR(4))
AS
declare variable DTINI date;
begin
  DTINI = '01.'||extract(month from current_date)||'.'||extract(year from current_date);
  EDATAINI = cast(coalesce(EDATAINI,DTINI) as date);
  EDATAFIM = cast(coalesce(EDATAFIM,current_date) as date);
  for select
   case coalesce(PRODFILHO.CODPESQ2 ,'')
      when '' then
        PRODFILHO.CODPRODFILHO
      else
        PRODFILHO.CODPESQ2
    end DUN,
    PESSOA.CPFCGC CNPJCLIENTE,
    PESSOA.NOME CLIENTE,
    PESSOA.NOMEFANTAZIA,
    PESSOA.CEP_1,
    case coalesce(TBL_RAMOATVTIPO.referencia,'')
      when '' THEN 0
      else TBL_RAMOATVTIPO.referencia
      end CODSEGMENTOPEPSICO,
    PEDVEND.CODVENDEDOR,
    (extract(year from PEDVEND.DTFATURADO) || RIGHT('00'||extract(month from PEDVEND.DTFATURADO),2) || RIGHT('00'||extract(day from PEDVEND.DTFATURADO),2)) as DATAVENDA,
    case
      when ((PEDVEND.TIPOPED = 'VENDA') or (PEDVEND.TIPOPED = 'CADERNO'))  then 'V'
      when PEDVEND.TIPOPED = 'BONIFICA' then 'B'
      when ((PEDVEND.TIPOPED = 'DEVOLUÃ?ÃfO') or (PEDVEND.TIPOPED = 'DEVOLUCAO'))  then 'DV'
      when PEDVEND.TIPOPED = 'CANCELAMENTO' then 'C'
      when ((PEDVEND.TIPOPED = 'TRANSFERENCIA') or (PEDVEND.TIPOPED = 'REMESSA F.'))  then 'T'
    end as TIPOPED,
    nfvenda.CODNFVENDA,
    PESSOA.PESSOA,
    cast(cast(sum(((coalesce(PEDVENDITEM.PRECOPROD,0) * coalesce(PEDVENDITEM.QTDENTREGUE,1))
    + (((coalesce(PEDVEND.ACRESVALOR,0) + (coalesce(PEDVEND.VALOR_BRUTO,0) * (coalesce(PEDVEND.ACRESCIMO,0)/100))) * (coalesce(PEDVENDITEM.PRECOVEND,0) / coalesce(nullif(PEDVEND.VALOR_BRUTO,1),1))))
    ) - (((coalesce(PEDVEND.DESC_VALOR,0) + coalesce(PEDVEND.DESCPERC_VALOR,0)) * (coalesce(PEDVENDITEM.PRECOVEND,0) / coalesce(nullif(PEDVEND.VALOR_BRUTO,1),1))) + coalesce(PEDVENDITEM.DESCONTO_VALOR,0))) as numeric(18,2)) as varchar(30)) as VLRVENDIDO,
    cast(cast(sum(coalesce(PEDVENDITEM.QTDE,0) / coalesce(nullif(PRODFILHO.QTDEMBALAGEM,1),1)) as numeric(18,5)) as varchar(30)) as QTDVENDIDA,
    nfvendaitem.cfop_cfop,
    nfvendaitemlote.lote,
     (extract( year from nfvendaitemlote.DATAVAL) || RIGHT('00' || extract(month from nfvendaitemlote.DATAVAL), 2) || RIGHT('00' || extract(day from nfvendaitemlote.DATAVAL), 2)) as DATAVAL,
    CAST(nfvendaitemlote.qtd AS integer)qtd

  from
    PEDVEND
    join PESSOA on (PESSOA.CODPESSOA = PEDVEND.CODPESSOA)
    join TBL_RAMOATVTIPO on (PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO)
    join PEDVENDITEM on PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
    join PRODFILHO on PEDVENDITEM.CODPRODFILHO =  PRODFILHO.CODPRODFILHO
    join PRODUTO on PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
    join nfvenda on pedvend.codnfvenda = nfvenda.codnfvenda
    join nfvendaitem on nfvenda.codnfvenda = nfvendaitem.codnfvenda
    join nfvendaitemlote on nfvendaitem.codnfvendaitem = nfvendaitemlote.codnfvendaitem
  where
    PEDVEND.STATUSPED = 'FATURADO' and
    PEDVEND.TIPOPED in ('VENDA','CADERNO') and
    cast(PEDVEND.DTFATURADO as date) between :EDATAINI and :EDATAFIM
  group by 
     1,2,3,4,5,6,7,8,9,10,11,14,15,16,17
  into
    :DUN,
    :CNPJCLIENTE,
    :CLIENTE,
    :PDV_EMPRESA,
    :PDV_CEP,
    :CODSEGMENTO,
    :CODVENDEDOR,
    :DATAVENDA,
    :TIPOPED,
    :CODNFVENDA,
    :TIPOPESSOA,
    :VLRVENDIDO,
    :QTDVENDIDA,
    :cfop, 
    :LOTE,
    :DATAVAL,
    :QTD
  do
  begin
    QTDVENDIDA = cast((cast(QTDVENDIDA as double precision) * 1000) as integer);
    select
      VENDEDOR.NOME
    from
      VENDEDOR
    where
      VENDEDOR.CODVENDEDOR = :CODVENDEDOR
    into
      :NOME_VENDEDOR;

    select
     STRRESULT
   from
     FU_GETTIRAMASCARA(:CNPJCLIENTE)
   into
     CNPJCLIENTE;

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC)),
      SYSPARAMS.EMPRESA,
      SYSPARAMS.CEP
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR,
      :PDV_EMPRESA,
      :PDV_CEP;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMMASTERFOODS_ESTOQUE(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    DUN VARCHAR(30),
    CNPJDISTRIBUIDOR VARCHAR(18),
    DATA DATE,
    QTDESTOQUE INTEGER)
AS
declare variable dtini date;
declare variable dtfim timestamp;
declare variable lcodprodfilho integer;
declare variable lqtdembalagem double precision;
declare variable lqtdestoque double precision;
begin
  DTINI = '01.'||extract(month from current_date)||'.'||extract(year from current_date);
  EDATAINI = cast(coalesce(EDATAINI,DTINI) as date);
  DTFIM = cast(coalesce(cast(EDATAFIM as timestamp),current_timestamp) as timestamp);
  for select
    PRODFILHO.CODPRODFILHO,
    coalesce(PRODFILHO.CODPESQ2,PRODFILHO.CODPRODFILHO) DUN,
    PRODFILHO.QTDEMBALAGEM,
    (extract(year from current_date)||'-'||RIGHT('00'||extract(month from current_date),2)||'-'||RIGHT('00'||extract(day from current_date),2)) as DATA,
    coalesce(prodfilho.estqatual,0)
  from
    PRODUTO
    join PRODFILHO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
  where
    PRODUTO.CODGRUPO in (31,32,34)
    and PRODUTO.ATIVO = 2
  into
    LCODPRODFILHO,
    :DUN,
    :LQTDEMBALAGEM,
    :DATA,
    :QTDESTOQUE
  do
  begin
    /*select
      cast(cast(SALDOFINAL as numeric(18,5)) as varchar(30))
    from
      STP_MOVESTOQUE_RESUMO(:LCODPRODFILHO,:EDATAINI,:EDATAFIM)
    into
      LQTDESTOQUE;

    if (LQTDESTOQUE > 0) then
      QTDESTOQUE = cast(cast(LQTDESTOQUE / coalesce(nullif(LQTDEMBALAGEM,0),1) as numeric(18,0)) as varchar(9));
    */
    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;

   -- QTDESTOQUE = QTDESTOQUE * 100;

   if (QTDESTOQUE < 0) then
       QTDESTOQUE = 0;

    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMMASTERFOODS_NOTASFISCAIS(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    CODSEGMENTOMASTERFOODS INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA VARCHAR(20),
    QTDNFEMITIDAS INTEGER)
AS
declare variable DTINI date;
begin
  DTINI = '01.'||extract(month from current_date)||'.'||extract(year from current_date);
  EDATAINI = cast(coalesce(EDATAINI,DTINI) as date);
  EDATAFIM = cast(coalesce(EDATAFIM,current_date) as date);

  for select
    PESSOA.CODSTATUS CODSEGMENTOPEPSICO,
    PEDVEND.CODVENDEDOR,
    (extract(year from PEDVEND.DTFATURADO)||'-'||RIGHT('00'||extract(month from PEDVEND.DTFATURADO),2)||'-'||RIGHT('00'||extract(day from PEDVEND.DTFATURADO),2)) as DATAVENDA,
    count(distinct PEDVEND.CODPEDVEND)
  from
    PEDVEND
    join PESSOA on (PESSOA.CODPESSOA = PEDVEND.CODPESSOA)
    join PEDVENDITEM on PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
    join PRODFILHO on PEDVENDITEM.CODPRODFILHO =  PRODFILHO.CODPRODFILHO
    join PRODUTO on PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
  where
    PRODUTO.CODGRUPO = 40 and
    PEDVEND.STATUSPED = 'FATURADO' and
    PEDVEND.TIPOPED in ('VENDA','CADERNO') and
    cast(PEDVEND.DTFATURADO as date) between :EDATAINI and :EDATAFIM
  group by 
    1,2,3
  into
    :CODSEGMENTOMASTERFOODS,
    :CODVENDEDOR,
    :DATAVENDA,
    :QTDNFEMITIDAS
  do
  begin
    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMMASTERFOODS_VENDAS(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    DUN VARCHAR(30),
    CNPJCLIENTE VARCHAR(18),
    CLIENTE VARCHAR(60),
    CODSEGMENTOMASTERFOODS INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA DATE,
    VLRVENDIDO VARCHAR(30),
    QTDVENDIDA INTEGER,
    ENDERECO_CLIENTE VARCHAR(60),
    CODCLIENTE VARCHAR(18),
    CEP VARCHAR(9),
    CIDADE VARCHAR(45),
    UF VARCHAR(2),
    CODNFVENDA INTEGER,
    BONIFICA VARCHAR(1),
    TIPOPED VARCHAR(10),
    PESOBRUTO DOUBLE PRECISION)
AS
declare variable dtini date;
declare variable ldatavenda date;
declare variable lfatorconversao double precision;
declare variable lfatorconversao2 double precision;
declare variable lvlrvendido double precision;
declare variable lstatusped varchar(10);
declare variable lcodprodfilho integer;
begin
  DTINI = '01.'||extract(month from current_date)||'.'||extract(year from current_date);
 /* EDATAINI = cast(coalesce(EDATAINI,DTINI) as date);
  EDATAFIM = cast(coalesce(EDATAFIM,current_date) as date);*/

  for select
    coalesce(PRODFILHO.CODPESQ2,PRODFILHO.CODPRODFILHO) DUN,
    coalesce(FATORCONVERSAO2, 0),
    PEDVEND.CODVENDEDOR,
    PEDVEND.CODPESSOA,
    coalesce(PEDVEND.CODNFVENDA,PEDVEND.CODFATURAMENTO),
    PEDVEND.TIPOPED,

    sum((PEDVENDITEM.PRECOPROD * PEDVENDITEM.QTDENTREGUE)
    + ((coalesce(PEDVEND.ACRESVALOR,0) + (coalesce(PEDVEND.VALOR_BRUTO,0) * (coalesce(PEDVEND.ACRESCIMO,0)/100))) * coalesce(PEDVENDITEM.PRECOVEND,0) / coalesce(nullif(PEDVEND.VALOR_BRUTO,0),1))
    - (((coalesce(PEDVEND.DESC_VALOR,0) + coalesce(PEDVEND.DESCPERC_VALOR,0)) * coalesce(PEDVENDITEM.PRECOVEND,0) / coalesce(nullif(PEDVEND.VALOR_BRUTO,0),1)) + coalesce(PEDVENDITEM.DESCONTO_VALOR,0))),

    cast(PEDVEND.DTFATURADO as date),
    sum(PEDVENDITEM.QTDE) as QTDVENDIDA,
    coalesce(PRODFILHO.FATORCONVERSAO,0),
    PEDVEND.STATUSPED,
    PEDVENDITEM.CODPRODFILHO,
    sum(coalesce(PEDVENDITEM.QTDE,0) * coalesce(prodfilho.pesobruto,0)) as PESOBRUTO
  from
    PEDVEND
    join PEDVENDITEM on PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
    join PRODFILHO on PEDVENDITEM.CODPRODFILHO =  PRODFILHO.CODPRODFILHO
    join PRODUTO on PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
  where
    PRODUTO.CODGRUPO in (31,32,34) and
    PEDVEND.STATUSPED IN ('FATURADO','DEVOLVIDO') and
    PEDVEND.TIPOPED in ('VENDA','CADERNO','BONIFICA','DEVOLUÇÃO') and
    PEDVEND.DTFATURADO between :EDATAINI and :EDATAFIM AND
    coalesce(PEDVEND.CODNFVENDA,PEDVEND.CODFATURAMENTO) > 0 and
    PRODUTO.ATIVO = 2
  group by 
    1,2,3,4,5,6,8,10,11,12
  into
    :DUN,
    :LFATORCONVERSAO2,
    :CODVENDEDOR,
    :CODCLIENTE,
    :CODNFVENDA,
    :TIPOPED,
    :LVLRVENDIDO,
    :LDATAVENDA,
    :QTDVENDIDA,
    :LFATORCONVERSAO,
    :LSTATUSPED,
    :LCODPRODFILHO,
    :PESOBRUTO
  do
  begin
    DATAVENDA = (extract(year from LDATAVENDA)||'-'||RIGHT('00'||extract(month from LDATAVENDA),2)||'-'||RIGHT('00'||extract(day from LDATAVENDA),2));
    VLRVENDIDO = cast(cast(LVLRVENDIDO  as numeric(18,2)) as varchar(30));

    select
      PESSOA.CPFCGC CNPJCLIENTE,
      PESSOA.NOME CLIENTE,
      cast(TBL_RAMOATVTIPO.REFERENCIA as integer) CODSEGMENTOPEPSICO
    from
      PESSOA
      join TBL_RAMOATVTIPO on
        (PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO)
    where
      PESSOA.CODPESSOA = :CODCLIENTE
    into 
      :CNPJCLIENTE,
      :CLIENTE,
      :CODSEGMENTOMASTERFOODS;


    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:CNPJCLIENTE)
    into
      CNPJCLIENTE;

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;

    select
      PESSOA.LOGRADOURO_1,
      PESSOA.CEP_1,
      PESSOA.CIDADE_1,
      PESSOA.UF_1
    from
      PESSOA
    where
      PESSOA.CODPESSOA = :CODCLIENTE
    into
      :ENDERECO_CLIENTE,
      :CEP,
      :CIDADE,
      :UF;

    BONIFICA = 'N';


    if (TIPOPED = 'BONIFICA') then
    begin
       BONIFICA = 'B';
    end

    if (TIPOPED = 'CADERNO') then
    begin
       TIPOPED = 'VENDA';
    end

    if (coalesce(LFATORCONVERSAO,0) > 0) then
    begin
      QTDVENDIDA = QTDVENDIDA * LFATORCONVERSAO;
      LVLRVENDIDO = (LVLRVENDIDO / QTDVENDIDA);

      if (coalesce(LFATORCONVERSAO2,0) > 0) then
      begin
        QTDVENDIDA = QTDVENDIDA / LFATORCONVERSAO2;
        LVLRVENDIDO = LVLRVENDIDO / LFATORCONVERSAO2;
      end
      VLRVENDIDO = cast(cast(LVLRVENDIDO  as numeric(18,2)) as varchar(30));
    end
    else
    begin
      LVLRVENDIDO = LVLRVENDIDO / QTDVENDIDA;
      VLRVENDIDO = cast(cast(LVLRVENDIDO  as numeric(18,2)) as varchar(30));
    end

    if (LSTATUSPED = 'DEVOLVIDO') then
    begin
       QTDVENDIDA = QTDVENDIDA * (-1);
    end

    if (TIPOPED = 'DEVOLUÇÃO') then
    begin
       QTDVENDIDA = QTDVENDIDA * (-1);
    end

    CODCLIENTE = CNPJCLIENTE;

    --DISPLAYS ONDE DEVO MULTIPLICAR A QUANTIDADE POR 6
    if (LCODPRODFILHO IN (90217)) then
    begin
       QTDVENDIDA = QTDVENDIDA * 6;
    end

    --DISPLAYS ONDE DEVO MULTIPLICAR A QUANTIDADE POR 12
    if (LCODPRODFILHO IN (88429,33443,33442,35192,33816,88506,35149,87194,33595,87195)) then
    begin
       QTDVENDIDA = QTDVENDIDA * 12;
    end

    --DISPLAYS ONDE DEVO MULTIPLICAR A QUANTIDADE POR 18
    if (LCODPRODFILHO IN (90018,90019,90021,90020)) then
    begin
       QTDVENDIDA = QTDVENDIDA * 18;
    end

    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMMASTERFOODS_VENDAS_2(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    DUN VARCHAR(30),
    CNPJCLIENTE VARCHAR(18),
    CLIENTE VARCHAR(60),
    CODSEGMENTOMASTERFOODS INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA DATE,
    VLRVENDIDO VARCHAR(30),
    QTDVENDIDA INTEGER,
    ENDERECO_CLIENTE VARCHAR(60),
    CODCLIENTE INTEGER,
    CEP VARCHAR(9),
    CIDADE VARCHAR(45),
    UF VARCHAR(2),
    CODNFVENDA INTEGER,
    BONIFICA VARCHAR(1),
    TIPOPED VARCHAR(10))
AS
declare variable DTINI date;
declare variable LDATAVENDA date;
declare variable LFATORCONVERSAO double precision;
declare variable LFATORCONVERSAO2 double precision;
declare variable LVLRVENDIDO double precision;
begin
  DTINI = '01.'||extract(month from current_date)||'.'||extract(year from current_date);
  EDATAINI = cast(coalesce(EDATAINI,DTINI) as date);
  EDATAFIM = cast(coalesce(EDATAFIM,current_date) as date);

  for select
    coalesce(PRODFILHO.CODPESQ2,PRODFILHO.CODPRODFILHO) DUN,
    coalesce(FATORCONVERSAO2, 0),
    PEDVEND.CODVENDEDOR,
    PEDVEND.CODPESSOA,
    coalesce(PEDVEND.CODNFVENDA,PEDVEND.CODFATURAMENTO),
    PEDVEND.TIPOPED,

    sum((PEDVENDITEM.PRECOPROD * PEDVENDITEM.QTDENTREGUE)
    + ((coalesce(PEDVEND.ACRESVALOR,0) + (coalesce(PEDVEND.VALOR_BRUTO,0) * (coalesce(PEDVEND.ACRESCIMO,0)/100))) * coalesce(PEDVENDITEM.PRECOVEND,0) / coalesce(nullif(PEDVEND.VALOR_BRUTO,0),1))
    - (((coalesce(PEDVEND.DESC_VALOR,0) + coalesce(PEDVEND.DESCPERC_VALOR,0)) * coalesce(PEDVENDITEM.PRECOVEND,0) / coalesce(nullif(PEDVEND.VALOR_BRUTO,0),1)) + coalesce(PEDVENDITEM.DESCONTO_VALOR,0))),

    cast(PEDVEND.DTFATURADO as date),
    sum(PEDVENDITEM.QTDE) as QTDVENDIDA,
    coalesce(PRODFILHO.FATORCONVERSAO,0)
  from
    PEDVEND
    join PEDVENDITEM on PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
    join PRODFILHO on PEDVENDITEM.CODPRODFILHO =  PRODFILHO.CODPRODFILHO
    join PRODUTO on PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
  where
    PRODUTO.CODGRUPO in (31,32,34) and
    PEDVEND.STATUSPED = 'FATURADO' and
    PEDVEND.TIPOPED in ('VENDA','CADERNO') and
    PEDVEND.DTFATURADO between :EDATAINI and :EDATAFIM and
    coalesce(PEDVEND.CODNFVENDA,PEDVEND.CODFATURAMENTO) > 0 and
    PRODUTO.ATIVO = 2
  group by 
    1,2,3,4,5,6,8,10
  into
    :DUN,
    :LFATORCONVERSAO2,
    :CODVENDEDOR,
    :CODCLIENTE,
    :CODNFVENDA,
    :LDATAVENDA,
    :TIPOPED,
    :LVLRVENDIDO,
    :QTDVENDIDA,
    :LFATORCONVERSAO
  do
  begin
    DATAVENDA = (extract(year from LDATAVENDA)||'-'||RIGHT('00'||extract(month from LDATAVENDA),2)||'-'||RIGHT('00'||extract(day from LDATAVENDA),2));
    VLRVENDIDO = cast(LVLRVENDIDO as varchar(30));

    select
      PESSOA.CPFCGC CNPJCLIENTE,
      PESSOA.NOME CLIENTE,
      cast(TBL_RAMOATVTIPO.REFERENCIA as integer) CODSEGMENTOPEPSICO
    from
      PESSOA
      join TBL_RAMOATVTIPO on
        (PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO)
    where
      PESSOA.CODPESSOA = :CODCLIENTE
    into 
      :CNPJCLIENTE,
      :CLIENTE,
      :CODSEGMENTOMASTERFOODS;


    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:CNPJCLIENTE)
    into
      CNPJCLIENTE;

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;

    select
      PESSOA.LOGRADOURO_1,
      PESSOA.CEP_1,
      PESSOA.CIDADE_1,
      PESSOA.UF_1
    from
      PESSOA
    where
      PESSOA.CODPESSOA = :CODCLIENTE
    into
      :ENDERECO_CLIENTE,
      :CEP,
      :CIDADE,
      :UF;

    BONIFICA = 'N';


    if (TIPOPED = 'BONIFICA') then
    begin
       BONIFICA = 'S';
    end

    if (TIPOPED = 'CADERNO') then
    begin
       TIPOPED = 'VENDA';
    end

    if (coalesce(LFATORCONVERSAO,0) > 0) then
    begin
      QTDVENDIDA = QTDVENDIDA * LFATORCONVERSAO;
      LVLRVENDIDO = LVLRVENDIDO * LFATORCONVERSAO;

      if (LFATORCONVERSAO2 > 0) then
      begin
        QTDVENDIDA = QTDVENDIDA / LFATORCONVERSAO2;
        LVLRVENDIDO = LVLRVENDIDO / LFATORCONVERSAO2;
      end
      VLRVENDIDO = cast(LVLRVENDIDO as varchar(30));
    end

    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMMASTERFOODS_VENDAS_REL(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    DUN VARCHAR(30),
    CNPJCLIENTE VARCHAR(18),
    CLIENTE VARCHAR(60),
    CODSEGMENTOMASTERFOODS INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA DATE,
    VLRVENDIDO VARCHAR(30),
    QTDVENDIDA INTEGER,
    ENDERECO_CLIENTE VARCHAR(60),
    CODCLIENTE VARCHAR(18),
    CEP VARCHAR(9),
    CIDADE VARCHAR(45),
    UF VARCHAR(2),
    CODNFVENDA INTEGER,
    BONIFICA VARCHAR(1),
    TIPOPED VARCHAR(10),
    PESOBRUTO DOUBLE PRECISION)
AS
declare variable DTINI date;
declare variable LDATAVENDA date;
declare variable LFATORCONVERSAO double precision;
declare variable LFATORCONVERSAO2 double precision;
declare variable LVLRVENDIDO double precision;
begin
  DTINI = '01.' || extract(month from current_date) || '.' || extract(year from current_date);

  for select
    coalesce(PF.CODPESQ2, PF.CODPRODFILHO),
    coalesce(PF.FATORCONVERSAO2, 0),
    P.CODVENDEDOR,
    P.CODPESSOA,
    coalesce(P.CODNFVENDA, P.CODFATURAMENTO),
    P.TIPOPED,
    sum((PVI.PRECOPROD * PVI.QTDENTREGUE) + ((coalesce(P.ACRESVALOR, 0) + (coalesce(P.VALOR_BRUTO, 0) * (coalesce(P.ACRESCIMO, 0) / 100))) * coalesce(PVI.PRECOVEND, 0) / coalesce(nullif(P.VALOR_BRUTO, 0), 1)) - (((coalesce(P.DESC_VALOR, 0) + coalesce(P.DESCPERC_VALOR, 0)) * coalesce(PVI.PRECOVEND, 0) / coalesce(nullif(P.VALOR_BRUTO, 0), 1)) + coalesce(PVI.DESCONTO_VALOR, 0))),
    cast(P.DTFATURADO as date),
    sum(PVI.QTDE) as QTDVENDIDA,
    coalesce(PF.FATORCONVERSAO, 0),
    sum(coalesce(PVI.QTDE, 0) * coalesce(PF.PESOBRUTO, 0)) as PESOBRUTO
  from
    PEDVEND P
    join PEDVENDITEM PVI on
      P.CODPEDVEND = PVI.CODPEDVEND
    join PRODFILHO PF on
      PVI.CODPRODFILHO = PF.CODPRODFILHO
    join PRODUTO PR on
      PF.CODPRODUTO = PR.CODPRODUTO
  where
    PR.CODGRUPO                              = 34 and
    P.STATUSPED                              = 'FATURADO' and
    P.TIPOPED                               in ('VENDA', 'CADERNO', 'BONIFICA') and
    P.DTFATURADO                       between :EDATAINI || ' 00:00:00' and :EDATAFIM || ' 23:59:59' and
    coalesce(P.CODNFVENDA, P.CODFATURAMENTO) > 0 and
    PR.ATIVO                                 = 2
  group by
    1,
    2,
    3,
    4,
    5,
    6,
    8,
    10
  into
    DUN,
    LFATORCONVERSAO2,
    CODVENDEDOR,
    CODCLIENTE,
    CODNFVENDA,
    TIPOPED,
    LVLRVENDIDO,
    LDATAVENDA,
    QTDVENDIDA,
    LFATORCONVERSAO,
    PESOBRUTO
  do
  begin
    DATAVENDA  = (extract(year from LDATAVENDA) || '-' || RIGHT('00' || extract(month from LDATAVENDA), 2) || '-' || RIGHT('00' || extract(day from LDATAVENDA), 2));
    VLRVENDIDO = cast(cast(LVLRVENDIDO as numeric(18,2)) as varchar(30));

    select
      P.CPFCGC CNPJCLIENTE,
      P.NOME CLIENTE,
      cast(T.REFERENCIA as integer)
    from
      PESSOA P
      join TBL_RAMOATVTIPO T on
        P.CODTIPOATV = T.CODTIPO
    where
      P.CODPESSOA = :CODCLIENTE
    into
      CNPJCLIENTE,
      CLIENTE,
      CODSEGMENTOMASTERFOODS;

    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:CNPJCLIENTE)
    into
      CNPJCLIENTE;

    select (
      select
        STRRESULT
      from
        FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;

    select
      P.LOGRADOURO_1,
      P.CEP_1,
      P.CIDADE_1,
      P.UF_1
    from
      PESSOA P
    where
      P.CODPESSOA = :CODCLIENTE
    into
      ENDERECO_CLIENTE,
      CEP,
      CIDADE,
      UF;

    BONIFICA = 'N';

    if (TIPOPED = 'BONIFICA') then
    begin
      BONIFICA = 'B';
    end

    if (TIPOPED = 'CADERNO') then
    begin
      TIPOPED = 'VENDA';
    end

    if (coalesce(LFATORCONVERSAO, 0) > 0) then
    begin
      QTDVENDIDA  = QTDVENDIDA * LFATORCONVERSAO;
      LVLRVENDIDO = (LVLRVENDIDO / QTDVENDIDA);

      if (coalesce(LFATORCONVERSAO2, 0) > 0) then
      begin
        QTDVENDIDA  = QTDVENDIDA / LFATORCONVERSAO2;
        LVLRVENDIDO = LVLRVENDIDO / LFATORCONVERSAO2;
      end
      VLRVENDIDO = cast(cast(LVLRVENDIDO as numeric(18,2)) as varchar(30));
    end
    else
    begin
      LVLRVENDIDO = LVLRVENDIDO / QTDVENDIDA;
      VLRVENDIDO  = cast(cast(LVLRVENDIDO as numeric(18,2)) as varchar(30));
    end

    CODCLIENTE = CNPJCLIENTE;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMPEPISICO_ESTOQUE(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    DUN VARCHAR(30),
    CNPJDISTRIBUIDOR VARCHAR(18),
    DATA VARCHAR(20),
    QTDESTOQUE VARCHAR(30))
AS
declare variable DTINI date;
declare variable DTFIM timestamp;
declare variable LCODPRODFILHO integer;
declare variable LQTDEMBALAGEM double precision;
declare variable LQTDESTOQUE double precision;
begin
  DTINI    = '01.' ||extract(month from current_date) || '.' || extract(year from current_date);
  EDATAINI = cast(coalesce(EDATAINI, DTINI) as date);
  DTFIM    = cast(coalesce(cast(EDATAFIM as timestamp), current_timestamp) as timestamp);

  for select
    PF.CODPRODFILHO,
    coalesce(PF.CODPESQ2, PF.CODPRODFILHO),
    PF.QTDEMBALAGEM,
    (extract(year from current_date) || '-' || RIGHT('00' ||extract(month from current_date), 2) || '-' || RIGHT('00' || extract(day from current_date), 2))
  from
    PRODUTO PR
    join PRODFILHO PF on
      PR.CODPRODUTO = PF.CODPRODUTO
  where
    PR.CODGRUPO in (40, 152)
  into
    LCODPRODFILHO,
    DUN,
    LQTDEMBALAGEM,
    DATA
  do
  begin
    select
      cast(SALDOFINAL as numeric(18,5))
    from
      STP_MOVESTOQUE_RESUMO(:LCODPRODFILHO, :EDATAINI, :DTFIM)
    into
      LQTDESTOQUE;

    QTDESTOQUE = 0.00;
    if (coalesce(LQTDESTOQUE, 0) > 0) then
      QTDESTOQUE = cast(LQTDESTOQUE / coalesce(nullif(LQTDEMBALAGEM, 0), 1) as numeric(18,5));

    select
      (select
         STRRESULT
       from
         FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMPEPISICO_NOTASFISCAIS(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    CODSEGMENTOPEPSICO INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA VARCHAR(20),
    QTDNFEMITIDAS INTEGER)
AS
declare variable DTINI date;
begin
  DTINI = '01.' || extract(month from current_date) || '.' || extract(year from current_date);
  EDATAINI = cast(coalesce(EDATAINI, DTINI) as date);
  EDATAFIM = cast(coalesce(EDATAFIM, current_date) as date);

  for select
    P.CODSTATUS,
    PV.CODVENDEDOR,
    (extract(year from PV.DTFATURADO) || '-' || RIGHT('00' || extract(month from PV.DTFATURADO), 2) || '-' || RIGHT('00' || extract(day from PV.DTFATURADO), 2)),
    count(distinct PV.CODPEDVEND)
  from
    PEDVEND PV
    join PESSOA P on
      P.CODPESSOA = PV.CODPESSOA
    join PEDVENDITEM PVI on
      PV.CODPEDVEND = PVI.CODPEDVEND
    join PRODFILHO PF on
      PVI.CODPRODFILHO = PF.CODPRODFILHO
    join PRODUTO PR on
      PF.CODPRODUTO = PR.CODPRODUTO
  where
    PR.CODGRUPO                      in (147, 40, 152) and
    PV.STATUSPED                      = 'FATURADO' and
    PV.TIPOPED                       in ('VENDA', 'CADERNO') and
    cast(PV.DTFATURADO as date) between :EDATAINI and :EDATAFIM
  group by
    1,
    2,
    3
  into
    CODSEGMENTOPEPSICO,
    CODVENDEDOR,
    DATAVENDA,
    QTDNFEMITIDAS
  do
  begin
    select (
      select
        STRRESULT
      from
        FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMPEPISICO_VENDAS(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    DUN VARCHAR(30),
    CNPJCLIENTE VARCHAR(18),
    CLIENTE VARCHAR(60),
    CODSEGMENTOPEPSICO INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA VARCHAR(20),
    VLRVENDIDO VARCHAR(30),
    QTDVENDIDA VARCHAR(30))
AS
declare variable DTINI date;
begin
  DTINI    = '01.' || extract(month from current_date) || '.' || extract(year from current_date);
  EDATAINI = cast(coalesce(EDATAINI, DTINI) as date);
  EDATAFIM = cast(coalesce(EDATAFIM, current_date) as date);

  for select
    case coalesce(PF.CODPESQ2, '')
      when '' then PF.CODPRODFILHO
      else PF.CODPESQ2
    end DUN,
    P.CPFCGC,
    P.NOME,
    case coalesce(T.REFERENCIA, '')
      when '' then 0
      else T.REFERENCIA
    end CODSEGMENTOPEPSICO,
    PV.CODVENDEDOR,
    (extract(year from PV.DTFATURADO) || '-' || RIGHT('00' || extract(month from PV.DTFATURADO), 2) || '-' || RIGHT('00' || extract(day from PV.DTFATURADO), 2)),
    cast(cast(sum(((coalesce(PVI.PRECOPROD, 0) * coalesce(PVI.QTDENTREGUE, 1)) + (((coalesce(PV.ACRESVALOR, 0) + (coalesce(PV.VALOR_BRUTO, 0) * (coalesce(PV.ACRESCIMO, 0) / 100))) * (coalesce(PVI.PRECOVEND, 0) / coalesce(nullif(PV.VALOR_BRUTO, 1), 1))))) - (((coalesce(PV.DESC_VALOR, 0) + coalesce(PV.DESCPERC_VALOR, 0)) * (coalesce(PVI.PRECOVEND, 0) / coalesce(nullif(PV.VALOR_BRUTO, 1), 1))) + coalesce(PVI.DESCONTO_VALOR, 0))) as numeric(18,2)) as varchar(30)),
    cast(cast(sum(coalesce(PVI.QTDE, 0) / coalesce(nullif(PF.QTDEMBALAGEM, 1), 1)) as numeric(18,5)) as varchar(30))
  from
    PEDVEND PV
    join PESSOA P on
      P.CODPESSOA = PV.CODPESSOA
    join TBL_RAMOATVTIPO T on
      P.CODTIPOATV = T.CODTIPO
    join PEDVENDITEM PVI on
      PV.CODPEDVEND = PVI.CODPEDVEND
    join PRODFILHO PF on
      PVI.CODPRODFILHO = PF.CODPRODFILHO
    join PRODUTO PR on
      PF.CODPRODUTO = PR.CODPRODUTO
  where
    PR.CODGRUPO                      in (147, 40, 152) and
    PV.STATUSPED                      = 'FATURADO' and
    PV.TIPOPED                       in ('VENDA', 'CADERNO') and
    cast(PV.DTFATURADO as date) between :EDATAINI and :EDATAFIM
  group by
    1,
    2,
    3,
    4,
    5,
    6
  into
    DUN,
    CNPJCLIENTE,
    CLIENTE,
    CODSEGMENTOPEPSICO,
    CODVENDEDOR,
    DATAVENDA,
    VLRVENDIDO,
    QTDVENDIDA
  do
  begin
    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:CNPJCLIENTE)
    into
      CNPJCLIENTE;

    select (
      select
        STRRESULT
      from
        FU_GETTIRAMASCARA(SYSPARAMS.CGC))
    from
      SYSPARAMS
    into
      CNPJDISTRIBUIDOR;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMSRICO_VENDAS(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    ANOMES VARCHAR(6),
    CODCLIENTE INTEGER,
    CODPRODSRICO VARCHAR(10),
    DESCFAMILIASRICO VARCHAR(40),
    CODMARFIMSRICO VARCHAR(6),
    CODFAMILIASRICO VARCHAR(3),
    QTDVENDIDA DOUBLE PRECISION,
    VLRVENDIDO DOUBLE PRECISION,
    CODVENDEDOR INTEGER)
AS
declare variable DTINI date;
declare variable CODGRUPO integer;
declare variable DESC_PRODUTO varchar(30);
declare variable DESC_GRUPO varchar(10);
begin
  DTINI    = '01.' || extract(month from current_date) || '.' || extract(year from current_date);
  EDATAINI = cast(coalesce(EDATAINI, DTINI) as date);
  EDATAFIM = cast(coalesce(EDATAFIM, current_date) as date);

  for select
    (extract(year from PV.DTFATURADO) || RIGHT('00' || extract(month from PV.DTFATURADO), 2)),
    PV.CODPESSOA,
    substring(cast(coalesce(PF.CODPESQ2, '') as varchar(30)) from 1 for 10),
    PR.CODGRUPO,
    PV.CODVENDEDOR,
    substring(PF.DESCRICAO from 1 for 30),
    cast(sum(coalesce(PVI.QTDE, coalesce(nullif(PF.QTDEMBALAGEM, 0), 1))) as numeric(18,5)),
    cast(sum(coalesce(PVI.PRECOVEND, 0) / coalesce(PVI.QTDE, 0)) as numeric(18,5))
  from
    PEDVEND PV
    join PEDVENDITEM PVI on
      PV.CODPEDVEND = PVI.CODPEDVEND
    join PRODFILHO PF on
      PVI.CODPRODFILHO = PF.CODPRODFILHO
    join PRODUTO PR on
      PF.CODPRODUTO = PR.CODPRODUTO
  where
    PR.CODGRUPO                       = 147 and
    PV.STATUSPED                      = 'FATURADO' and
    PV.TIPOPED                       in ('VENDA', 'CADERNO') and
    cast(PV.DTFATURADO as date) between :EDATAINI and :EDATAFIM
  group by
    1,
    2,
    3,
    4,
    5,
    6
  into
    ANOMES,
    CODCLIENTE,
    CODPRODSRICO,
    CODGRUPO,
    CODVENDEDOR,
    DESC_PRODUTO,
    QTDVENDIDA,
    VLRVENDIDO

  do
  begin
    select
      substring(G.DESCRICAO from 1 for 10),
      '001',
      '00' || '1082'
    from
      GRUPO G
    where
      G.CODGRUPO = :CODGRUPO
    into
      DESC_GRUPO,
      CODFAMILIASRICO,
      CODMARFIMSRICO;

    DESCFAMILIASRICO = DESC_GRUPO || ' ' || DESC_PRODUTO;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMTHUNDER_DATA(
    DT_ENTRADA TIMESTAMP)
RETURNS (
    NOTA VARCHAR(10),
    NOMECLIENTE VARCHAR(61),
    PESOBRUTO DOUBLE PRECISION,
    DATA VARCHAR(10),
    PLACA VARCHAR(8),
    CODEMBARQUE INTEGER)
AS
declare variable PEDIDO integer;
declare variable LPLACA1 varchar(3);
declare variable LPLACA2 varchar(5);
declare variable QTDPEDIDOS integer;
declare variable LQTDATUAL integer;
begin
  select
    count(coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND))
  from
    EMBARQUEITEM E
    join PEDVEND P on
      E.CODPEDVEND_FK = P.CODPEDVEND
    join PESSOA PE on
      P.CODPESSOA = PE.CODPESSOA
    join EMBARQUE EM on
      EM.CODEMBARQUE = E.CODEMBARQUE_FK
  where
    EM.DATALIBERADO = :DT_ENTRADA and
    PDV_CRITICA    in ('V', 'M', 'A')
  into
    QTDPEDIDOS;

  LQTDATUAL = 1;

  for select
    coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND),
    RIGHT('00' || extract(day from P.DTFATURADO), 2) || '-' || RIGHT('00' || extract(month from P.DTFATURADO), 2) || '-' || extract(year from P.DTFATURADO),
    PE.NOME,
    P.CODPEDVEND,
    E.CODEMBARQUE_FK
  from
    EMBARQUEITEM E
    join PEDVEND P on
      E.CODPEDVEND_FK = P.CODPEDVEND
    join PESSOA PE on
      P.CODPESSOA = PE.CODPESSOA
    join EMBARQUE EM on
      EM.CODEMBARQUE = E.CODEMBARQUE_FK
  where
    EM.DATALIBERADO = :DT_ENTRADA and
    PDV_CRITICA    in ('V', 'M', 'A')
  group by
    coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND),
    P.DTFATURADO,
    PE.NOME,
    P.CODPEDVEND,
    E.CODEMBARQUE_FK
  order by
    E.CODEMBARQUE_FK,
    coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND)
  into
    NOTA,
    DATA,
    NOMECLIENTE,
    PEDIDO,
    CODEMBARQUE
  do
  begin
    select
      sum(pi.QTDENTREGUE * PF.PESOBRUTO)
    from
      PEDVENDITEM pi
      join PRODFILHO PF on
        pi.CODPRODFILHO = PF.CODPRODFILHO
    where
      pi.CODPEDVEND = :PEDIDO
    into
      PESOBRUTO;

    select
      V.PLACA
    from
      EMBARQUE E
      left join VEICULOS V on
        E.CODVEICULO_FK = V.CODVEICULO
    where
      E.CODEMBARQUE = :CODEMBARQUE
    into
      PLACA;

    LPLACA1 = substring(PLACA from 1 for 3);

    select
      R_TRIM
    from
      FU_TRIM(:LPLACA1)
    into
      LPLACA1;

    LPLACA2 = substring(PLACA from 4 for 8);

    select
      R_TRIM
    from
      FU_TRIM(:LPLACA2)
    into
      LPLACA2;

    PLACA = LPLACA1 || LPLACA2;
    PLACA = substring(PLACA from 1 for 7);

    if (LQTDATUAL < QTDPEDIDOS) then
      NOMECLIENTE = NOMECLIENTE || ';';

    LQTDATUAL = LQTDATUAL + 1;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MARFIMTHUNDERTRACK(
    CODEMBARQUE INTEGER)
RETURNS (
    NOTA VARCHAR(10),
    NOMECLIENTE VARCHAR(65),
    PESOBRUTO DOUBLE PRECISION,
    DATA VARCHAR(10),
    PLACA VARCHAR(8),
    INFO1 VARCHAR(500),
    INFO2 VARCHAR(200),
    INFO3 VARCHAR(200),
    INFO4 VARCHAR(200))
AS
declare variable PEDIDO integer;
declare variable LPLACA1 varchar(3);
declare variable LPLACA2 varchar(5);
declare variable QTDPEDIDOS integer;
declare variable LQTDATUAL integer;
declare variable LCODPESSOA integer;
declare variable LINFO3 varchar(255);
declare variable LTIPOPED varchar(10);
begin
  select
    count(coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND))
  from
    EMBARQUEITEM E
    join PEDVEND P on
      E.CODPEDVEND_FK = P.CODPEDVEND
  where
    E.CODEMBARQUE_FK = :CODEMBARQUE and
    P.PDV_CRITICA   in ('V', 'M', 'A')
  into
    QTDPEDIDOS;

  LQTDATUAL = 1;

  for select
    coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND),
    RIGHT('00' || extract(day from P.DTFATURADO), 2) || '-' || RIGHT('00' || extract(month from P.DTFATURADO), 2) || '-' || extract(year from P.DTFATURADO),
    P.CODPESSOA,
    P.CODPEDVEND,
    P.TIPOPED
  from
    EMBARQUEITEM E
    join PEDVEND P on
      E.CODPEDVEND_FK = P.CODPEDVEND
    join PESSOA PE on
      P.CODPESSOA = PE.CODPESSOA
  where
    E.CODEMBARQUE_FK = :CODEMBARQUE and
    P.PDV_CRITICA   in ('V', 'M', 'A')
  group by
    coalesce(P.CODNFVENDA, P.CODFATURAMENTO, P.CODPEDVEND),
    P.DTFATURADO,
    P.CODPESSOA,
    P.CODPEDVEND,
    P.TIPOPED
  into
    NOTA,
    DATA,
    LCODPESSOA,
    PEDIDO,
    LTIPOPED
  do
  begin
    INFO1 = coalesce(INFO1, '');
    INFO2 = coalesce(INFO2, '');
    INFO3 = coalesce(INFO3, '');
    INFO4 = coalesce(INFO4, '');

    INFO4 = '';

    select
      sum(pi.QTDENTREGUE * PF.PESOBRUTO)
    from
      PEDVENDITEM pi
      join PRODFILHO PF on
        pi.CODPRODFILHO = PF.CODPRODFILHO
    where
      pi.CODPEDVEND = :PEDIDO
    into
      PESOBRUTO;

    select
      V.PLACA
    from
      EMBARQUE E
      left join VEICULOS V on
        E.CODVEICULO_FK = V.CODVEICULO
    where
      E.CODEMBARQUE = :CODEMBARQUE
    into
      PLACA;

    select
      CLI.NOME,
      coalesce(CLI.LOGRADOURO_1, '') || ' ' || coalesce(CLI.NUMERO_1, '') || ' ' || coalesce(CLI.COMPLEMENTO_1, '') || ' ' || coalesce(CLI.CIDADE_1, '') || ' ' || coalesce(CLI.UF_1, '') || ' ' || coalesce(CLI.CEP_1, ''),
      coalesce(CLI.PESSOA_CONTATO, '') || ' Fone: ' || coalesce(CLI.FONES, ''),
      coalesce(cast(CLI.ROTEIROENTREGA as varchar(255)), '')
    from
      PESSOA CLI
    where
      CLI.CODPESSOA = :LCODPESSOA
    into
      NOMECLIENTE,
      INFO1,
      INFO2,
      LINFO3;

    INFO1 = substring(INFO1 || '. P. REF.: ' || coalesce(LINFO3, '') from 1 for 500);

    LINFO3 = '';

    INFO3 = DATA;

    if (LTIPOPED = 'CADERNO') then
    begin
      select first 1
        RIGHT('00' || extract(day from C.DT_EMISSAO), 2) || '-' || RIGHT('00' || extract(month from C.DT_EMISSAO), 2) || '-' || extract(year from C.DT_EMISSAO)
      from
        CONTA C
      where
        C.CODPENDVEND = :PEDIDO
      into
        DATA;
    end
    else
    begin
      select first 1
        RIGHT('00' || extract(day from C.DT_EMISSAO), 2) || '-' || RIGHT('00' || extract(month from C.DT_EMISSAO), 2) || '-' || extract(year from C.DT_EMISSAO) DATA
      from
        NFVENDA N
        join CONTA C on
          C.CODNFVENDA = N.CODNFVENDA and
          C.SERIENF    = N.SERIE
      where
        N.CODPEDVEND = :PEDIDO
      into
        DATA;
    end

    LPLACA1 = substring(PLACA from 1 for 3);

    select
      R_TRIM
    from
      FU_TRIM(:LPLACA1)
    into
      LPLACA1;

    LPLACA2 = substring(PLACA from 5 for 8);

    select
      R_TRIM
    from
      FU_TRIM(:LPLACA2)
    into
      LPLACA2;

    PLACA = LPLACA1 || LPLACA2;
    PLACA = substring(PLACA from 1 for 7);

    if (LQTDATUAL < QTDPEDIDOS) then
    begin
      INFO4 = INFO4 || ';';
    end

    LQTDATUAL = LQTDATUAL + 1;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MDEVOLUCAOGERANF(
    ECODPESSOA INTEGER,
    ECODVENDEDOR INTEGER,
    ECODCFOP INTEGER,
    ECOD_SERIE INTEGER,
    EDT_EMISSAO DATE,
    ENFV_DTIMPRESSAO DATE,
    ENFV_OBSNOTA3 VARCHAR(70),
    ENFV_OBSNOTA4 VARCHAR(70),
    ENFV_OBSNOTA5 VARCHAR(70),
    ENFV_OBSNOTA6 VARCHAR(70),
    ENFV_OBSNOTA7 VARCHAR(70),
    ENFV_OBSNOTA8 VARCHAR(70),
    ENFV_OBSNOTA9 VARCHAR(70),
    EUS_CADAST VARCHAR(45),
    ECODTRANSPORT INTEGER,
    EPLACA_TRANSP VARCHAR(8),
    D1 DATE,
    D2 DATE,
    EQTD DOUBLE PRECISION,
    EPESOB DOUBLE PRECISION,
    EPESOL DOUBLE PRECISION,
    EVALOUMES DOUBLE PRECISION,
    EMARCA VARCHAR(15),
    EESPECIE VARCHAR(30))
RETURNS (
    CODNFVENDA INTEGER,
    SERIE VARCHAR(3))
AS
declare variable LNRFORMULARIO varchar(10);
declare variable LNRSELO varchar(11);
declare variable LCFOP_CFOP varchar(4);
declare variable LNATUREZA varchar(50);
declare variable LCODPRODFILHO integer;
declare variable LQTDE double precision;
declare variable LPRECOVEND double precision;
declare variable LIPIPERC double precision;
declare variable LTOTALVLR double precision;
declare variable LTOTALVLRNOTA double precision;
declare variable LCODUNIDADE integer;
declare variable LCODPESQUISA varchar(30);
declare variable LICMSPERC double precision;
declare variable LCUSTOMEDIO double precision;
declare variable LCUSTOREPOSI double precision;
declare variable LQTDEMBALAGEM double precision;
declare variable LPESO double precision;
declare variable LICMSPERCISENTO double precision;
declare variable LTOTALPRODUTOS double precision;
declare variable LTOTALNOTA double precision;
declare variable LICMSTOTAL double precision;
declare variable LIPITOTAL double precision;
declare variable LICMSISENTOTOTAL double precision;
declare variable LCODTROCAENTRA integer;
declare variable LICMSBASE double precision;
declare variable LDESCVLR double precision;
declare variable LDESCPERC double precision;
declare variable LIPIVALOR double precision;
declare variable LICMSVALOR double precision;
declare variable LQTDEEMBALAGEM double precision;
declare variable LPRECOUSADO varchar(10);
declare variable LTRATESP varchar(10);
declare variable LNFV_TIPO varchar(1);
declare variable LBASEICMS double precision;
declare variable LBASEIPI double precision;
declare variable LPESOBTOTAL double precision;
declare variable LPESOLTOTAL double precision;
declare variable LQTDTRANS integer;
declare variable EQTDTOTAL integer;
declare variable EVALOUMESTOTAL integer;
declare variable LBAIXARESTOQ varchar(1);
declare variable LBAIXARESTOQUE smallint;
declare variable LCODNFVENDAITEM integer;
declare variable LCODMOVESTOQUE integer;
declare variable LDESCONTO double precision;
declare variable LTODOSVALORES smallint;
declare variable LORIGEM integer;
declare variable LCSTICMS varchar(4);
declare variable LPERC_VA numeric(18,2);
declare variable LALIQ_SUBS numeric(18,2);
declare variable CSTPIS varchar(2);
declare variable CSTCOFINS varchar(2);
declare variable PERCPIS numeric(18,2);
declare variable PERCOFINS numeric(18,2);
declare variable CSTIPI varchar(2);
declare variable LVA_VALOR numeric(18,2);
declare variable LBASE_SUBS numeric(18,2);
declare variable LVALOR_SUBS numeric(18,2);
declare variable LCSTICMSITEM varchar(4);
declare variable LICMSPERCITEM double precision;
begin
  --PEGANDO OS SEQUENCIAIS FISCAIS
  select
    coalesce(SEQUENCIAL, 1) as SEQUENCIAL,
    SERIE,
    LETRASELO || SEQUENCIALSELO,
    NRFORMULARIO
  from
    SERIE
  where
    COD_SERIE = :ECOD_SERIE
  into
    CODNFVENDA,
    SERIE,
    LNRSELO,
    LNRFORMULARIO;

  update
    SERIE S
  set
    S.SEQUENCIAL     = S.SEQUENCIAL + 1,
    S.SEQUENCIALSELO = S.SEQUENCIALSELO + 1,
    S.NRFORMULARIO   = RIGHT('00000' || cast(cast(coalesce(S.NRFORMULARIO, '0') as integer) + 1 as varchar(10)), 6)
  where
    S.COD_SERIE = :ECOD_SERIE;

  --PEGANDO O CFOP
  select
    C.CFOP,
    C.NATUREZA
  from
    CFOP C
  where
    C.CODCFOP = :ECODCFOP
  into
    LCFOP_CFOP,
    LNATUREZA;

  /* --------------------- GERANDO A NOTA FISCAL --------------------- */
  insert into NFVENDA (
    CODNFVENDA,
    CODPESSOA,
    CODVENDEDOR,
    CODCFOP,
    CFOP_CFOP,
    DT_EMISSAO,
    STATUS,
    NATUREZA,
    PRECOUSADO,
    US_CADAST,
    DT_CADAST,
    FRETEVLR,
    SEGUROVLR,
    OUTRASDESPESA,
    TIPOFRETE,
    TIPONOTA,
    NFV_TIPO,
    NFV_OBSNOTA3,
    NFV_OBSNOTA4,
    NFV_OBSNOTA5,
    NFV_OBSNOTA6,
    NFV_OBSNOTA7,
    NFV_OBSNOTA8,
    NFV_OBSNOTA9,
    ICMSSUBSTPERC,
    SERIE,
    NFCORRECAO,
    NFV_DTIMPRESSAO,
    NRSELO,
    NRFORMULARIO,
    CODTRANSPORT,
    PLACA_TRANSP,
    MARCA,
    ESPECIE)
  values(
    :CODNFVENDA,
    :ECODPESSOA,
    :ECODVENDEDOR,
    :ECODCFOP,
    :LCFOP_CFOP,
    :EDT_EMISSAO,
    'F',
    :LNATUREZA,
    'Preço1',
    :EUS_CADAST,
    'now',
    0,
    0,
    0,
    '1',
    'E',
    'I',
    :ENFV_OBSNOTA3,
    :ENFV_OBSNOTA4,
    :ENFV_OBSNOTA5,
    :ENFV_OBSNOTA6,
    :ENFV_OBSNOTA7,
    :ENFV_OBSNOTA8,
    :ENFV_OBSNOTA9,
    0,
    :SERIE,
    'N',
    :ENFV_DTIMPRESSAO,
    :LNRSELO,
    :LNRFORMULARIO,
    :ECODTRANSPORT,
    :EPLACA_TRANSP,
    :EMARCA,
    :EESPECIE);

  select
    SP.VALOR
  from
    MLERPARAMETROLOGICO('MOVIMENTAR ESTOQUE NA NF DE DEVOLUÇÃO VENDA',0) SP
  into
    :LBAIXARESTOQUE;

  if (LBAIXARESTOQUE = 1) then
    LBAIXARESTOQ = 'S';
  else
    LBAIXARESTOQ = 'N';

  select
    SP.VALOR
  from
    MLERPARAMETROLOGICO('ENVIAR TODOS OS VALORES',0) SP
  into
    :LTODOSVALORES;

  --GERANDO OS ITENS
  for select
    CODPRODFILHO,
    QTDE,
    PRODVLR,
    PRECOBRUTO,
    DESC_VALOR,
    DESC_PERC,
    PRECOTOTAL,
    CODUNIDADE,
    CODPESQUISA,
    CUSTOMEDIO,
    CUSTOREPOSI,
    QTDEMBALAGEM,
    'Preço1',
    'N',
    'I',
    PESO,
    PERC_ICMS,
    BASE_ICMS,
    VALOR_ICMS,
    PERC_IPI,
    BASE_IPI,
    VALOR_IPI,
    CODTROCAENTRA,
    QTDTRANS,
    CSTICMS
  from
    MDEVOLUCAOGERANFITENS(:D1, :D2, :ECODPESSOA)
  where
    MARCADO = 'S'
  into
    LCODPRODFILHO,
    LQTDE,
    LPRECOVEND,
    LTOTALVLR,
    LDESCVLR,
    LDESCPERC,
    LTOTALVLRNOTA,
    LCODUNIDADE,
    LCODPESQUISA,
    LCUSTOMEDIO,
    LCUSTOREPOSI,
    LQTDEEMBALAGEM,
    LPRECOUSADO,
    LTRATESP,
    LNFV_TIPO,
    LPESO,
    LICMSPERCITEM,
    LBASEICMS,
    LICMSVALOR,
    LIPIPERC,
    LBASEIPI,
    LIPIVALOR,
    LCODTROCAENTRA,
    LQTDTRANS,
    LCSTICMSITEM
  do
  begin
    /* distintivo */
    select
      coalesce(SP.CODCFOP, :ECODCFOP),
      SP.CFOP,
      SP.NATUREZA,
      SP.PRDF_CST_ORIGEM_MERCADORIA,
      SP.PRDF_CST_TRIBICMS,
      SP.ICMS,
      SP.PRDF_VA,
      SP.ALIQICMSSUBS,
      SP.CSTPISENTRADA,
      SP.CSTCOFINSENTRADA,
      SP.PERCPISCOMPRA,
      SP.PERCCONFINSCOMPRA,
      SP.IPI,
      SP.CSTIPIENTRADA
    from
      MDEVOLUCAOGERANFCFOP(:ECODPESSOA, :ECOD_SERIE, :LCODPRODFILHO) SP
    into
      ECODCFOP,
      LCFOP_CFOP,
      LNATUREZA,
      LORIGEM,
      LCSTICMS,
      LICMSPERC,
      LPERC_VA,
      LALIQ_SUBS,
      CSTPIS,
      CSTCOFINS,
      PERCPIS,
      PERCOFINS,
      LIPIPERC,
      CSTIPI;

    LBASEICMS     = 0;
    LICMSVALOR    = 0;

    LVA_VALOR     = 0;
    LBASE_SUBS    = 0;
    LVALOR_SUBS   = 0;

    LBASEIPI      = 0;
    LIPIVALOR     = 0;

    LTOTALVLRNOTA = 0;

    if (coalesce(LICMSPERC,0) > 0) then
    begin
      LBASEICMS  = :LTOTALVLR;
      LICMSVALOR = :LTOTALVLR * LICMSPERC / 100;
    end

    if ((coalesce(LALIQ_SUBS,0) > 0) and (coalesce(LICMSPERC,0) > 0)) then
    begin
      LBASE_SUBS  = LBASEICMS;
      LVA_VALOR   = LBASE_SUBS * (LPERC_VA / 100);
      LBASE_SUBS  = LBASE_SUBS + LVA_VALOR;
      LVALOR_SUBS = ((LBASE_SUBS * (LALIQ_SUBS / 100)) - LICMSVALOR);
    end

    if (coalesce(LIPIPERC,0) > 0) then
    begin
      LBASEIPI  = LTOTALVLR;
      LIPIVALOR = LBASEIPI * LIPIPERC / 100;
    end

    if (LTODOSVALORES = 0) then
    begin
      LDESCVLR      = 0;
      LDESCPERC     = 0;
    end

    LTOTALVLRNOTA = LTOTALVLR - LDESCVLR + LIPIVALOR + LVALOR_SUBS;

    if (LCSTICMSITEM is not null) then
      LCSTICMS = LCSTICMSITEM;

    if (LICMSPERCITEM is not null) then
      LICMSPERC = LICMSPERCITEM;

    insert into NFVENDAITEM(
      CODNFVENDA,
      SERIE,
      NFV_TIPO,
      CODPRODFILHO,
      QTDE,
      PRECOVEND,
      DESCVLR,
      DESCPERC,
      TOTALVLR,
      BAIXARESTOQ,
      CODUNIDADE,
      US_CADAST,
      DT_CADAST,
      CODPESQUISA,
      CUSTOMEDIO,
      CUSTOREPOSI,
      QTDEEMBALAGEM,
      PRECOUSADO,
      TRATESP,
      CODCFOP,
      CFOP_CFOP,
      NATUREZA,
      NFVI_VLBONIFICACAO,
      ALIQ_SUBS,
      PERC_VA,
      VA_VALOR,
      BASE_SUBS,
      VALOR_SUBS,
      PESO,
      QTDE_PECAS,
      PRDF_CST_ORIGEM_MERCADORIA,
      PRDF_CST_TRIBICMS,
      CST,
      ICMSISENTO,
      ICMSPERC,
      ICMSBASE,
      ICMSVALOR,
      IPIPERC,
      IPIBASE,
      IPIVALOR,
      TOTALVLRNOTA)
    values(
      :CODNFVENDA,
      :SERIE,
      'I',
      :LCODPRODFILHO,
      :LQTDE,
      :LPRECOVEND,
      :LDESCVLR,
      :LDESCPERC,
      :LTOTALVLR,
      'S',
      :LCODUNIDADE,
      :EUS_CADAST,
      'NOW',
      :LCODPESQUISA,
      :LCUSTOMEDIO,
      :LCUSTOREPOSI,
      :LQTDEMBALAGEM,
      'Preço1',
      'N',
      :ECODCFOP,
      :LCFOP_CFOP,
      :LNATUREZA,
      0,
      :LALIQ_SUBS,
      :LPERC_VA,
      :LVA_VALOR,
      :LBASE_SUBS,
      :LVALOR_SUBS,
      :LPESO,
      0,
      substring(:LCSTICMS from 1 for 1),
      substring(:LCSTICMS from 2),
      :LCSTICMS, --:LORIGEM || :LCSTICMS,
      :LTOTALVLRNOTA * ((:LICMSPERCISENTO - :LICMSPERC) / 100),
      :LICMSPERC,
      :LBASEICMS,
      :LICMSVALOR,
      :LIPIPERC,
      :LBASEIPI,
      :LIPIVALOR,
      :LTOTALVLRNOTA)
    returning
      CODNFVENDAITEM
    into
      :LCODNFVENDAITEM;

    LTOTALPRODUTOS   = coalesce(LTOTALPRODUTOS, 0)   + coalesce(LTOTALVLR,0);
    LTOTALNOTA       = coalesce(LTOTALNOTA, 0)       + coalesce(LTOTALVLRNOTA,0);
    LICMSISENTOTOTAL = coalesce(LICMSISENTOTOTAL, 0) + coalesce(LTOTALVLRNOTA,0) * ((LICMSPERCISENTO - LICMSPERC) / 100);
    LICMSTOTAL       = coalesce(LICMSTOTAL, 0)       + coalesce(LICMSVALOR,0);
    LIPITOTAL        = coalesce(LIPIVALOR, 0)        + coalesce(LIPIVALOR,0);
    LDESCONTO        = coalesce(LDESCONTO, 0)        + coalesce(LDESCVLR,0);

    --Verificando os Pesos.
    if ((:EPESOB > 0) and (:EPESOL > 0)) then
    begin
     LPESOBTOTAL = :EPESOB;
     LPESOLTOTAL = :EPESOL;
    end
    else
    begin
     LPESOBTOTAL = coalesce(LPESOBTOTAL, 0) + LPESO;
     LPESOLTOTAL = coalesce(LPESOLTOTAL, 0) + LPESO;
    end

    --Verificando a Quantidade Transportada.
    if (:EQTD > 0) then
     EQTDTOTAL = :EQTD;
    else
     EQTDTOTAL = coalesce(EQTDTOTAL,0) + LQTDTRANS;

    if (:EVALOUMES > 0) then
     EVALOUMESTOTAL = :EVALOUMES;
    else
     EVALOUMESTOTAL = 0;

    update
      TROCAENTRA T
    set
      T.CODNFVENDA = :CODNFVENDA,
      T.SERIENF    = :SERIE,
      T.NFV_TIPO   = :LNFV_TIPO,
      T.MARCADO    = 'X'
    where
      T.CODTROCAENTRA = :LCODTROCAENTRA;


    if (LBAIXARESTOQUE = 1) then
    begin
      execute procedure
       MATUALIZAESTOQUE(:LCODPRODFILHO,
         :CODNFVENDA,
         :SERIE,
         cast(:CODNFVENDA as varchar(30)),
         'DNV',
         'E',
         :LQTDE,
         0,
         :EUS_CADAST,
         1,
         'N',
         :LCODNFVENDAITEM)
      returning_values
         LCODMOVESTOQUE;
    end
  end 

  --TOTALIZANDO A NOTA
--  LTOTALNOTA       = LTOTALPRODUTOS + LIPITOTAL - LDESCONTO;
  LTOTALPRODUTOS   = cast(LTOTALPRODUTOS as numeric(18,2));
  LICMSTOTAL       = cast(LICMSTOTAL as numeric(18,2));
  LICMSISENTOTOTAL = cast(LICMSISENTOTOTAL as numeric(18,2));
  LICMSBASE        = cast(LICMSBASE as numeric(18,2));
  LIPITOTAL        = cast(LIPITOTAL as numeric(18,2));
  LTOTALNOTA       = cast(LTOTALNOTA as numeric(18,2));

  update
    NFVENDA
  set
    NFVENDA.VLRDESCONT        = :LDESCONTO,
    NFVENDA.TOTALPRODUTOS     = :LTOTALPRODUTOS,
    NFVENDA.TOTALNOTA         = :LTOTALNOTA,
    NFVENDA.ICMSTOTAL         = :LICMSTOTAL,
    NFVENDA.ICMSISENTOTOTAL   = :LICMSISENTOTOTAL,
    NFVENDA.ICMSBASE          = :LICMSBASE,
    NFVENDA.ICMSSUBSBASE      = 0,
    NFVENDA.ICMSSUBSTVALOR    = 0,
    NFVENDA.VALORIPI          = :LIPITOTAL,
    NFVENDA.GNRE              = 0,
    NFVENDA.PESOBRUTO         = :LPESOBTOTAL,
    NFVENDA.PESOLIQUI         = :LPESOLTOTAL,
    NFVENDA.QTDETRANSPORTADO  = :EQTDTOTAL,
    NFVENDA.QTDEVOLUME        = cast(:EVALOUMESTOTAL as numeric(10,3)),
    NFVENDA.MARCA             = :EMARCA,
    NFVENDA.ESPECIE           = :EESPECIE
  where
    NFVENDA.CODNFVENDA = :CODNFVENDA and
    NFVENDA.SERIE      = :SERIE and
    NFVENDA.NFV_TIPO   = 'I';

  suspend;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MEXPORTAFORTES0001(
    CODEMPRESA VARCHAR(4),
    DTINI DATE,
    DTFIM DATE,
    ECOMENTARIO VARCHAR(40))
RETURNS (
    IDENTIFICACAO VARCHAR(1),
    VERSAO VARCHAR(1),
    SISTEMA_DESTINO VARCHAR(10),
    SISTEMA_ORIGEM VARCHAR(10),
    COD_EMPRESA VARCHAR(4),
    DT_INICIAL VARCHAR(8),
    DT_FINAL VARCHAR(8),
    COMENTARIOS VARCHAR(40))
AS
begin
  for
    select
      '0' IDENTIFICACAO,
      '6' VERSAO,
      'AC' SISTEMA_DESTINO,
      'SCGWIN' SISTEMA_ORIGEM
    from
      RDB$DATABASE
    into
      :IDENTIFICACAO,
      :VERSAO,
      :SISTEMA_DESTINO,
      :SISTEMA_ORIGEM
  do
  begin
    select R_TRIM from FU_TRIM(:SISTEMA_DESTINO) into :SISTEMA_DESTINO;
    select R_TRIM from FU_TRIM(:SISTEMA_ORIGEM)  into :SISTEMA_ORIGEM;

    COD_EMPRESA = :CODEMPRESA;
    DT_INICIAL = (extract(year from :DTINI)||RIGHT('00'||extract(month from :DTINI),2)||RIGHT('00'||extract(day from :DTINI),2));
    DT_FINAL   = (extract(year from :DTFIM)||RIGHT('00'||extract(month from :DTFIM),2)||RIGHT('00'||extract(day from :DTFIM),2));
    COMENTARIOS = :ECOMENTARIO;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MEXPORTAFORTES0040(
    DTINI DATE,
    DTFIM DATE,
    CODEMPRESA INTEGER)
RETURNS (
    REGISTRO INTEGER,
    IDENTIFICACAO VARCHAR(4),
    DATA VARCHAR(8),
    SEQUENCIAL INTEGER,
    NUMARQUIVO VARCHAR(1),
    NUMLOTE VARCHAR(1),
    VALOR NUMERIC(18,2),
    CODHISTORICO VARCHAR(1),
    HISTORICO VARCHAR(40))
AS
declare variable LDTINI timestamp;
declare variable LDTFIM timestamp;
declare variable DATACONTABIL date;
declare variable CODCONTA integer;
declare variable DESCRICAO varchar(60);
begin
  CODEMPRESA = coalesce(CODEMPRESA,1);
  LDTINI = cast(DTINI||' 00:00:00' as timestamp);
  LDTFIM = cast(DTFIM||' 23:59:59' as timestamp);

  for select
    C.CODCONTA,
    C.DESCRICAO,
    C.DT_VENCIM,
    C.VLPARCELA
  from
    CONTA C
  where
    coalesce(C.TOTPAGO,0) > 0 and
    coalesce(C.VLPARCELA,0) > 0 and
    C.DT_VENCIM between :LDTINI and :LDTFIM and
    coalesce(C.CODEMPRESA,1) =:CODEMPRESA and C.STATUS = 'QUITADO'
  order by
    3 asc
  into
    :CODCONTA,
    :DESCRICAO,
    :DATACONTABIL,
    :VALOR
  do
  begin
    IDENTIFICACAO = '0040';
    REGISTRO      = 1;
    NUMARQUIVO    = '';
    NUMLOTE       = '0';
    CODHISTORICO  = '';

    DATA          = (extract(year from :DATACONTABIL)||RIGHT('00'||extract(month from :DATACONTABIL),2)||RIGHT('00'||extract(day from :DATACONTABIL),2));
    SEQUENCIAL    = :CODCONTA;
    VALOR         = cast(:VALOR as numeric(18,2));
    HISTORICO     = substring(:DESCRICAO from 1 for 40);
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MEXPORTAFORTESCCF(
    CODCUPOMZ INTEGER)
RETURNS (
    CODCUPOM INTEGER,
    COO VARCHAR(10),
    SITUACAO VARCHAR(1),
    EMISSAO DATE,
    ECF VARCHAR(4),
    DESC_VALOR DOUBLE PRECISION,
    ACRES_VALOR DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    VALOR_SERVICOS DOUBLE PRECISION)
AS
declare variable STATUSCUPOM smallint;
begin
  for select
    CUPOM.CODCUPOM,
    CUPOM.COO,
    CUPOM.EMISSAO,
    CUPOM.ECF,
    CUPOM.DESC_VALOR,
    CUPOM.VALORPAGO,
    --CUPOM.VALOR_TOTAL,
    CUPOM.ACRES_VALOR,
    CUPOM.STATUSCUPOM
  from
    CUPOM
  where
    CUPOM.CODCUPOMZ =:CODCUPOMZ
    --and coalesce(CUPOM.STATUSCUPOM,0) = 0
  order by 2
  into
    :CODCUPOM,
    :COO,
    :EMISSAO,
    :ECF,
    :DESC_VALOR,
    :VALOR_TOTAL,
    :ACRES_VALOR,
    :STATUSCUPOM
  do
  begin
    if (STATUSCUPOM = 0) then
      SITUACAO = '0';
    else
      SITUACAO = '2';

    VALOR_SERVICOS = 0;
    ECF            =  RIGHT('000' || cast(cast(ECF as integer) as varchar(4)) ,3);
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MEXPORTAFORTESCFC(
    DTINI DATE,
    DTFIM DATE,
    CODEMPRESA INTEGER)
RETURNS (
    TIPO VARCHAR(3),
    ESTABELECIMENTO VARCHAR(4),
    CODCUPOMZ INTEGER,
    DATA DATE,
    ORDEM VARCHAR(4),
    ECF VARCHAR(4),
    COOZ VARCHAR(10),
    COOINICIAL VARCHAR(10),
    COOFINAL VARCHAR(10),
    CRZ VARCHAR(10),
    CRO VARCHAR(10),
    VENDABRUTA DOUBLE PRECISION,
    VENDALIQUIDA DOUBLE PRECISION,
    GT DOUBLE PRECISION,
    CANCELAMENTOS DOUBLE PRECISION,
    DESCONTOS DOUBLE PRECISION,
    ACRESCIMOS DOUBLE PRECISION,
    SUBSTITUICAO DOUBLE PRECISION,
    ISENTAS DOUBLE PRECISION,
    NAOTRIBUTADOS DOUBLE PRECISION,
    SERVICOS DOUBLE PRECISION)
AS
begin
  TIPO            = 'CFC';
  ESTABELECIMENTO = '0001';

  CODEMPRESA      = cast(coalesce(:CODEMPRESA,1) as integer);

  for select
    CUPOMZ.CODCUPOMZ,
    CUPOMZ.DATAMOVIMENTO,
    CUPOMZ.ECF,
    CUPOMZ.COOZ,
    CUPOMZ.COOINICIAL,
    CUPOMZ.COOFINAL,
    CUPOMZ.CONTADORZ,
    CUPOMZ.CRO,
    CUPOMZ.VENDABRUTA, 
    CUPOMZ.VENDALIQUIDA,
    CUPOMZ.TOTALIZACAOGERAL, 
    CUPOMZ.CANCELAMENTOS, 
    CUPOMZ.DESCONTOS, 
    CUPOMZ.SUBSTITUICAO, 
    CUPOMZ.ISENTAS, 
    CUPOMZ.NAOTRIBUTADOS,
    CUPOMZ.ACRESCIMOS
  from
    CUPOMZ
  where
    CUPOMZ.DATAMOVIMENTO between :DTINI and :DTFIM and
    coalesce(CUPOMZ.CODEMPRESA,1) =:CODEMPRESA and
    coalesce(CUPOMZ.VENDALIQUIDA,0) > 0
  into
    :CODCUPOMZ,
    :DATA,
    :ECF,
    :COOZ,
    :COOINICIAL,
    :COOFINAL,
    :CRZ,
    :CRO,
    :VENDABRUTA,
    :VENDALIQUIDA,
    :GT,
    :CANCELAMENTOS,
    :DESCONTOS,
    :SUBSTITUICAO,
    :ISENTAS,
    :NAOTRIBUTADOS,
    :ACRESCIMOS
  do
  begin
    ORDEM    = ECF;
    ECF      =  RIGHT('000' || cast(cast(ECF as integer) as varchar(4)) ,3);
    SERVICOS = 0;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MEXPORTAMASTERMACDUPLS(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    TIPO VARCHAR(1),
    ANO DATE,
    DOCUMENTOD VARCHAR(1),
    CHAVE CHAR(33),
    ALTERA CHAR(1),
    CONTEUDODUP CHAR(15),
    ALTERA2 CHAR(1),
    CONTEUDOVEN CHAR(15),
    ALTERA3 CHAR(1),
    CONTEUDOVAL CHAR(15),
    BRANCOS CHAR(16),
    PISCOFINSCS CHAR(47),
    HISTORICOS CHAR(1))
AS
declare variable LTIPO varchar(10);
declare variable LCODNFENTRADA integer;
declare variable LCODNFVENDA integer;
declare variable LSERIENF varchar(3);
declare variable LNOTAFISCAL varchar(15);
declare variable LCPFCGC varchar(18);
declare variable LPESSOA smallint;
declare variable LDOCUMENTO varchar(9);
declare variable LCHAVE varchar(33);
declare variable LSTATUS varchar(10);
declare variable LCODCONTA integer;
declare variable LCONTEUDODUP varchar(15);
declare variable LDT_PAGAMEN date;
declare variable LCONTEUDOVEN varchar(15);
declare variable LCONTEUDOVAL varchar(15);
begin
  TIPO        = 'I';
  ALTERA      = ' ';
  ALTERA2     = ' ';
  ALTERA3     = ' ';
  BRANCOS     = '                ';
  PISCOFINSCS = '000000000000.00000000000000.00000000000000.0001';
  HISTORICOS  = ' ';
  for select
    C.TIPO,
    C.CODNFENTRADA,
    C.CODNFVENDA,
    C.SERIENF,
    P.CPFCGC,
    P.PESSOA,
    substring(C.NRDOCUMENTO from 1 for 6) || '/' || substring(C.PARCELA from 1 for 2),
    C.STATUS,
    C.CODCONTA,
    extract(year from C.DT_VENCIM) || RIGHT('00' || extract(month from C.DT_VENCIM), 2) || RIGHT('00' || extract(day from C.DT_VENCIM), 2),
    cast(C.VLPARCELA as numeric(15, 2)),
    cast(C.DT_EMISSAO as date)
  from
    CONTA C
    join PESSOA P on
      C.CODPESSOA = P.CODPESSOA
  where
    cast(C.DT_EMISSAO as date) between :EDATAINI and :EDATAFIM
  into
    LTIPO,
    LCODNFENTRADA,
    LCODNFVENDA,
    LSERIENF,
    LCPFCGC,
    LPESSOA,
    LDOCUMENTO,
    LSTATUS,
    LCODCONTA,
    LCONTEUDOVEN,
    LCONTEUDOVAL,
    ANO
  do
  begin
    if ((LCODNFENTRADA is not null) or (LCODNFVENDA is not null)) then
    begin
      if (LPESSOA = 2) then
        LCPFCGC = substring(LCPFCGC from 1 for 2) || substring(LCPFCGC from 4 for 3) || substring(LCPFCGC from 8 for 3) || substring(LCPFCGC from 14 for 2);
      else
        LCPFCGC = substring(LCPFCGC from 1 for 3) || substring(LCPFCGC from 4 for 3) || substring(LCPFCGC from 8 for 3) || substring(LCPFCGC from 13 for 1);
        
      if (LTIPO = 'RECEBER') then
      begin
        LCHAVE = 'S';
        LCHAVE = LCHAVE || '  ' || RIGHT('000000' || LCODNFVENDA, 6) || LCPFCGC || '00' || LSERIENF;
      end 
      else
      begin
        select
          N.DOCUMENTO,
          N.SERIE
        from
          NFENTRADA N
        where
          N.CODNFENTRADA = :LCODNFENTRADA
        into
          LNOTAFISCAL,
          LSERIENF;
        LCHAVE = 'E';
        LCHAVE = LCHAVE || RIGHT('00000000' || LNOTAFISCAL, 8) || LCPFCGC || '00' || LSERIENF;
      end
      LCHAVE = LCHAVE || LDOCUMENTO;
      CHAVE = cast(LCHAVE as char(33));
      if (LSTATUS = 'ABERTO') then
      begin
        DOCUMENTOD   = 'D';
        LCONTEUDODUP = LDOCUMENTO;
      end
      else
      begin
        DOCUMENTOD = 'B';
        select
          max(cast(CB.DT_PAGAMEN as date)),
          cast(sum(coalesce(CB.JUROS, 0)) as numeric(15, 2)),
          cast(sum(coalesce(CB.DESCONTO, 0)) as numeric(15, 2))
        from
          CONTABX CB
        where
          CB.CODCONTA = :LCODCONTA
        into
          LDT_PAGAMEN,
          LCONTEUDOVEN,
          LCONTEUDOVAL;
        LCONTEUDODUP = extract(year from LDT_PAGAMEN) || RIGHT('00' || extract(month from LDT_PAGAMEN), 2) || RIGHT('00' || extract(day from LDT_PAGAMEN), 2);
        LCONTEUDOVEN = RIGHT('000000000000000' || LCONTEUDOVEN, 15);
      end
      CONTEUDODUP = cast(LCONTEUDODUP as char(15));
      CONTEUDOVEN = cast(LCONTEUDOVEN as char(15));
      CONTEUDOVAL = RIGHT('000000000000000' || LCONTEUDOVAL, 15);
      suspend;
    end 
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MEXPORTAMASTERMACFMVI2(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    TIPO CHAR(1),
    XREF CHAR(8),
    XREF2 CHAR(8),
    KDIMPOSTO CHAR(1),
    BASE NUMERIC(15,2),
    ALIQ NUMERIC(15,2),
    ALIQ2 NUMERIC(15,2),
    IMPOSTO NUMERIC(15,2),
    CDFISC CHAR(4),
    SUBCD CHAR(1),
    CDTRIB CHAR(1),
    OBSERVACOES VARCHAR(1),
    CD2TRIB VARCHAR(2),
    SUBFISC VARCHAR(1),
    CFPS VARCHAR(1))
AS
declare variable LXREF integer;
declare variable LNAOVAZIO varchar(1);
declare variable LTIPO char(1);
declare variable LTIPOLOCAL char(1);
declare variable LALIQLOCAL numeric(15,2);
declare variable LALIQ numeric(15,2);
declare variable LBASE double precision;
declare variable LID varchar(20);
declare variable LCDFISC char(4);
declare variable LCDFISCLOCAL char(4);
declare variable LIMPOSTO char(3);
declare variable LIMPOSTOLOCAL char(3);
declare variable LENTRADALOCAL char(8);
declare variable LNFISCALLOCAL char(6);
declare variable LCPFCGCLOCAL char(18);
declare variable LSERIELOCAL char(3);
declare variable LENTRADA char(8);
declare variable LNFISCAL char(6);
declare variable LCPFCGC char(18);
declare variable LSERIE char(3);
declare variable LICMSLOCAL double precision;
declare variable LICMS double precision;
declare variable LBASELOCAL double precision;
begin
  KDIMPOSTO   = '1';
  ALIQ2       = 0;
  SUBCD       = ' ';
  OBSERVACOES = ' ';
  CD2TRIB     = ' ';
  SUBFISC     = ' ';
  CFPS        = ' ';
  lbase = 0;
  lbaselocal = 0;
  for select
    'ICM',
    cast('S' || NI.CODNFVENDAITEM as varchar(20)),
    'S',
    NI.ICMSPERC,
    NI.TOTALVLR - NI.DESCVLR,
    NI.CFOP_CFOP,
    RIGHT('0000' || extract(year from N.DT_EMISSAO), 4) || RIGHT('00' || extract(month from N.DT_EMISSAO), 2) ||  RIGHT('00' || extract(day from N.DT_EMISSAO), 2),
    RIGHT('000000' || cast(N.CODNFVENDA as varchar (6)), 6),
    P.CPFCGC,
    cast(N.SERIE as char(3)),
    NI.ICMSVALOR
  from
    NFVENDAITEM NI
    join PRODFILHO PR on
      NI.CODPRODFILHO = PR.CODPRODFILHO
    join NFVENDA N on
      NI.CODNFVENDA = N.CODNFVENDA and
      NI.SERIE      = N.SERIE
    join PESSOA P on
      N.CODPESSOA = P.CODPESSOA
  where
    cast(N.DT_EMISSAO as date) between :EDATAINI and :EDATAFIM and
    N.STATUS                         = 'F'

  union

  select
    'ICM',
    cast('E' || NEI.CODNFENTRADAITENS as varchar(20)),
    'E',
    coalesce(NEI.DIFICMS,0),
    NEI.VALORTOTAL,
    NEI.CFOP_CFOP,
    RIGHT('0000' || extract(year from NE.DTENTRADA), 4) || RIGHT('00' || extract(month from NE.DTENTRADA), 2) ||  RIGHT('00' || extract(day from NE.DTENTRADA), 2),
    RIGHT('000000' || cast(substring(NE.DOCUMENTO from 1 for 6) as varchar (6)), 6),
    P.CPFCGC,
    cast(NE.SERIE as char(3)),
    NEI.VL_DIFICMS
  from
    NFENTRADAITENS NEI
    join PRODFILHO PR on
      NEI.CODPRODFILHO = PR.CODPRODFILHO
    join NFENTRADA NE on
      NEI.CODNFENTRADA = NE.CODNFENTRADA
    join PESSOA P on
      NE.CODPESSOA = P.CODPESSOA
  where
    cast(NE.DTENTRADA as date) between :EDATAINI and :EDATAFIM and
    NE.STATUS                         = 'F'
    --and ne.codnfentrada= 4408
  union

  select
    'IPI',
    cast('I' || NEI.CODNFENTRADAITENS as varchar(20)),
    'E',
    cast(1 as double precision),
    NEI.VALORTOTAL,
    NEI.CFOP_CFOP,
    RIGHT('0000' || extract(year from NE.DTENTRADA), 4) || RIGHT('00' || extract(month from NE.DTENTRADA), 2) ||  RIGHT('00' || extract(day from NE.DTENTRADA), 2),
    RIGHT('000000' || cast(substring(NE.DOCUMENTO from 1 for 6) as varchar (6)), 6),
    P.CPFCGC,
    cast(NE.SERIE as char(3)),
    NEI.VL_IPIPERC
  from
    NFENTRADAITENS NEI
    join PRODFILHO PR on
      NEI.CODPRODFILHO = PR.CODPRODFILHO
    join NFENTRADA NE on
      NEI.CODNFENTRADA = NE.CODNFENTRADA
    join PESSOA P on
      NE.CODPESSOA = P.CODPESSOA
  where
    cast(NE.DTENTRADA as date) between :EDATAINI and :EDATAFIM and
    NE.STATUS                         = 'F' and
    NEI.IPIPERC                       > 0
  order by
    7,
    8,
    9,
    10,
    1,
    4,
    6
  into
    LIMPOSTOLOCAL,
    LID,
    LTIPOLOCAL,
    LALIQLOCAL,
    LBASELOCAL,
    LCDFISCLOCAL,
    LENTRADALOCAL,
    LNFISCALLOCAL,
    LCPFCGCLOCAL,
    LSERIELOCAL,
    LICMSLOCAL
  do
  begin
    LBASELOCAL = coalesce(LBASELOCAL,0);
    LNAOVAZIO = 'N';
    if ((LENTRADA || LNFISCAL || LCPFCGC || LSERIE || LALIQ || LCDFISC || LIMPOSTO) is null) then
    begin
      LXREF     = coalesce(LXREF, 0) + 1;
      LTIPO     = LTIPOLOCAL;
      LALIQ     = LALIQLOCAL;
      LCDFISC   = LCDFISCLOCAL;
      LIMPOSTO  = LIMPOSTOLOCAL;
      LENTRADA  = LENTRADALOCAL;
      LNFISCAL  = LNFISCALLOCAL;
      LCPFCGC   = LCPFCGCLOCAL;
      LSERIE    = LSERIELOCAL;
      LBASE     = 0;
      LICMS     = 0;
    end

    if ((LENTRADA || LNFISCAL || LCPFCGC || LSERIE || LALIQ || LCDFISC || LIMPOSTO) <> (LENTRADALOCAL || LNFISCALLOCAL || LCPFCGCLOCAL || LSERIELOCAL || LALIQLOCAL || LCDFISCLOCAL || LIMPOSTOLOCAL)) then
    begin
      TIPO    = LTIPO;
      ALIQ    = LALIQ;
      CDFISC  = LCDFISC;
      XREF    = RIGHT('00000000' || LXREF, 8);
      XREF2   = LNFISCAL;
      BASE    = LBASE;
      IMPOSTO = LICMS;

      if (ALIQ > 0) then
      begin
        CDTRIB = '1';
        if (LIMPOSTO = 'IPI') then
        begin
          CDTRIB  = 'I';
          BASE    = IMPOSTO;
          IMPOSTO = 0;
          ALIQ    = 0;
        end
      end
      else
      begin
        IMPOSTO = 0;
        CDTRIB  = '2';
        if (CDFISC in ('1403', '1551', '1556', '1653','2551', '2556', '2653')) then
          CDTRIB = '9';
        if (CDFISC in ('1152', '2403', '2910', '1403', '1910', '5152', '5405', '5910', '6910')) then
          CDTRIB = '6';
      end

      if (xref2 = '000330') then
        xref2 = '000330';

      suspend;

      if ((LENTRADA || LNFISCAL || LCPFCGC || LSERIE) <> (LENTRADALOCAL || LNFISCALLOCAL || LCPFCGCLOCAL || LSERIELOCAL)) then
        LXREF = coalesce(LXREF, 0) + 1;
      LTIPO     = LTIPOLOCAL;
      LALIQ     = LALIQLOCAL;
      LCDFISC   = LCDFISCLOCAL;
      LIMPOSTO  = LIMPOSTOLOCAL;
      LENTRADA  = LENTRADALOCAL;
      LNFISCAL  = LNFISCALLOCAL;
      LCPFCGC   = LCPFCGCLOCAL;
      LSERIE    = LSERIELOCAL;
      LBASE     = 0;
      LICMS     = 0;
    end
    LBASE = LBASE + LBASELOCAL;
    LICMS = LICMS + LICMSLOCAL;
  end
  if (LNAOVAZIO is not null) then
  begin
    TIPO    = LTIPO;
    ALIQ    = LALIQ;
    CDFISC  = LCDFISC;
    XREF    = RIGHT('00000000' || LXREF, 8);
    XREF2   = LNFISCAL;
    IMPOSTO = LICMS;
    BASE    = LBASE;

    if (ALIQ > 0) then
    begin
      CDTRIB = '1';
      if (LIMPOSTO = 'IPI') then
      begin
        CDTRIB  = 'I';
        BASE    = IMPOSTO;
        IMPOSTO = 0;
        ALIQ    = 0;
      end
    end
    else
    begin
      CDTRIB = '2';
      if (CDFISC in ('1403', '1551', '1556', '1653','2551', '2556', '2653')) then
        CDTRIB = '9';
      if (CDFISC in ('1152', '2403', '2910', '1403', '1910', '5152', '5405', '5910', '6910')) then
        CDTRIB = '6';
    end
          if (xref2 = '000330') then
        xref2 = '000330';

    suspend;

      LBASE     = 0;
      IMPOSTO = 0;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MEXPORTAMASTERMACFMVI4(
    EDATAINI DATE,
    EDATAFIM DATE,
    EFILIAL VARCHAR(2))
RETURNS (
    XREF2 CHAR(8),
    XREF CHAR(8),
    FILIAL CHAR(2),
    MATERIAL VARCHAR(30),
    QUANT NUMERIC(16,6),
    VL_UNIT NUMERIC(16,6),
    CDFISC CHAR(4),
    ALIQICM NUMERIC(5,2),
    TRIBICM CHAR(1),
    TRIB2ICM VARCHAR(1),
    RED_BSCALC NUMERIC(7,3),
    BCALC_ST NUMERIC(13,2),
    TRIBIPI CHAR(1),
    ALIQIPI NUMERIC(5,2),
    TRIBISS CHAR(1),
    ALIQISS NUMERIC(5,2),
    IVA NUMERIC(6,2),
    ICMSNORMAL NUMERIC(11,2),
    IS_SERV CHAR(1),
    DESCONTO NUMERIC(13,2),
    CODAPUR CHAR(2),
    IND_ESP CHAR(2),
    BC_ICMS NUMERIC(13,2),
    ALIQ_ST NUMERIC(5,2),
    VL_ST NUMERIC(13,2),
    BCALC_IPI NUMERIC(13,2),
    VL_IPI NUMERIC(13,2),
    CFPS VARCHAR(1),
    ACRESCIMO1 NUMERIC(13,2),
    TIPO VARCHAR(1),
    ICMSCALCULADO NUMERIC(15,2),
    ICMSTOTAL NUMERIC(15,2),
    COD_CLASSE VARCHAR(4),
    IND_REC VARCHAR(1),
    TRIBST VARCHAR(1),
    ICMS_IPI VARCHAR(1),
    MOV_ESTOQUE VARCHAR(1),
    BCALC_ISS NUMERIC(13,2),
    VL_ISS NUMERIC(13,2),
    TRIBPIS VARCHAR(2),
    BCALC_PIS NUMERIC(13,2),
    ALIQ_PIS NUMERIC(8,4),
    VL_PIS NUMERIC(13,2),
    TRIBCOFINS VARCHAR(2),
    BCALC_COFINS NUMERIC(13,2),
    ALIQ_COFINS NUMERIC(8,4),
    VL_COFINS NUMERIC(13,2),
    DT_APROP CHAR(8),
    COD_MATER2 VARCHAR(60),
    NSERIEARM VARCHAR(20),
    TIPOOPER VARCHAR(1),
    CP_CONCESS VARCHAR(10),
    CP_CONCESS2 VARCHAR(20),
    CHASSI_VEI VARCHAR(17),
    LOTEMEDIC VARCHAR(20),
    QTDLOTE VARCHAR(14),
    DATA_FABRI VARCHAR(8),
    DATA_VALID VARCHAR(8),
    DESC_COMP VARCHAR(255),
    IND_TPARMA VARCHAR(1),
    ITEMCANCEL VARCHAR(1),
    ORIGEM_MERC VARCHAR(1))
AS
declare variable LXREF integer;
declare variable LENTRADALOCAL char(8);
declare variable LNFISCALLOCAL char(6);
declare variable LCPFCGCLOCAL char(18);
declare variable LSERIELOCAL char(3);
declare variable LENTRADA char(8);
declare variable LNFISCAL char(6);
declare variable LCPFCGC char(18);
declare variable LSERIE char(3);
declare variable LIDITEM integer;
declare variable LBASE numeric(15,2);
declare variable LALIQICM numeric(5,2);
declare variable LALIQIPI numeric(5,2);
declare variable LALIQ_ST numeric(5,2);
declare variable LBCALC_ST numeric(13,2);
declare variable LCDFISC char(4);
declare variable LDESCONTO numeric(13,2);
declare variable LICMSNORMAL numeric(13,2);
declare variable LMATERIAL varchar(30);
declare variable LQUANT numeric(16,6);
declare variable LTIPO varchar(1);
declare variable LVL_IPI numeric(13,2);
declare variable LVL_ST numeric(13,2);
declare variable LVL_UNIT numeric(16,6);
declare variable LALIQICMLOCAL numeric(5,2);
declare variable LALIQIPILOCAL numeric(5,2);
declare variable LALIQ_STLOCAL numeric(5,2);
declare variable LBCALC_STLOCAL numeric(13,2);
declare variable LCDFISCLOCAL char(4);
declare variable LDESCONTOLOCAL numeric(13,2);
declare variable LICMSNORMALLOCAL numeric(13,2);
declare variable LMATERIALLOCAL varchar(30);
declare variable LQUANTLOCAL numeric(16,6);
declare variable LTIPOLOCAL varchar(1);
declare variable LVL_IPILOCAL numeric(13,2);
declare variable LVL_STLOCAL numeric(13,2);
declare variable LVL_UNITLOCAL numeric(16,6);
declare variable LIDITEMLOCAL integer;
declare variable LNAOVAZIO char(1);
declare variable LICMSCALCULADO numeric(15,2);
declare variable LICMSTOTALLOCAL numeric(15,2);
declare variable LICMSTOTAL numeric(15,2);
declare variable LBASELOCAL double precision;
begin
  FILIAL     = RIGHT('00' || coalesce(EFILIAL, '0'), 2);
  TRIB2ICM   = '';
  BCALC_ST   = 0;
  TRIBIPI    = '9';
  TRIBISS    = '9';
  ALIQISS    = 0;
  IVA        = 0;
  IS_SERV    = 'M';
  CODAPUR    = '00';
  IND_ESP    = '00';
  CFPS       = '';
  ACRESCIMO1 = 0;
  COD_CLASSE = '';
  IND_REC = '';
  TRIBST = '';
  ICMS_IPI = '0';
  MOV_ESTOQUE = '1';
  BCALC_ISS = 0;
  VL_ISS = 0;
  ITEMCANCEL = '0';

  BCALC_PIS = 0;
  ALIQ_PIS = 0;
  VL_PIS = 0;

  BCALC_COFINS = 0;
  ALIQ_COFINS = 0;
  VL_COFINS = 0;

  for select
    RIGHT('0000' || extract(year from N.DT_EMISSAO), 4) || RIGHT('00' || extract(month from N.DT_EMISSAO), 2) ||  RIGHT('00' || extract(day from N.DT_EMISSAO), 2),
    RIGHT('000000' || cast(N.CODNFVENDA as varchar (6)), 6),
    P.CPFCGC,
    cast(N.SERIE as char(3)),
    NI.CODNFVENDAITEM,
    PR.CODPESQ1,
    NI.QTDE,
    NI.PRECOVEND,
    coalesce(NI.CFOP_CFOP, ''),
    coalesce(NI.ICMSPERC, 0),
    coalesce(NI.IPIPERC, 0),
    coalesce(NI.ICMSVALOR, 0),
    coalesce(NI.DESCVLR, 0),
    coalesce(NI.TOTALVLR, 0),
    coalesce(NI.ALIQ_SUBS, 0),
    coalesce(NI.BASE_SUBS, 0),
    coalesce(NI.VALOR_SUBS,0),
    coalesce(NI.IPIVALOR, 0),
    'S',
    coalesce(cast(N.ICMSTOTAL as numeric(15, 2)), 0),
    PR.cstpis,
    PR.cstcofins,
    PR.prdf_cst_origem_mercadoria
  from
    NFVENDAITEM NI
    join PRODFILHO PR on
      NI.CODPRODFILHO = PR.CODPRODFILHO
    join NFVENDA N on
      NI.CODNFVENDA = N.CODNFVENDA and
      NI.SERIE      = N.SERIE
    join PESSOA P on
      N.CODPESSOA = P.CODPESSOA
  where
    cast(N.DT_EMISSAO as date) between :EDATAINI and :EDATAFIM and
    N.STATUS                         = 'F'

  union

  select
    RIGHT('0000' || extract(year from NE.DTENTRADA), 4) || RIGHT('00' || extract(month from NE.DTENTRADA), 2) ||  RIGHT('00' || extract(day from NE.DTENTRADA), 2),
    RIGHT('000000' || cast(substring(NE.DOCUMENTO from 1 for 6) as varchar (6)), 6),
    P.CPFCGC,
    cast(NE.SERIE as char(3)),
    NEI.CODNFENTRADAITENS,
    PR.CODPESQ1,
    NEI.QTD,
    NEI.PRODVLR,
    coalesce(NEI.CFOP_CFOP, ''),
    coalesce(NEI.DIFICMS, 0),
    coalesce(NEI.IPIPERC, 0),
    (coalesce(NEI.DIFICMS, 0) * coalesce(NEI.VALORTOTAL, 0) / 100),
    coalesce(NEI.DESCTO_ITEM, 0),
    coalesce(NEI.VALORTOTAL, 0),
    coalesce(NEI.ALIQ_SUBS, 0),
    coalesce(NEI.BASE_SUBS, 0),
    coalesce(NEI.VALOR_SUBS,0),
    coalesce(NEI.IPIPERC, 0) * coalesce(NEI.VALORTOTAL, 0) / 100,
    'E',
    coalesce(cast(NE.ICMSVLR as numeric(15, 2)), 0),
    PR.cstpisentrada,
    PR.cstcofinsentrada,
    PR.prdf_cst_origem_mercadoria
  from
    NFENTRADAITENS NEI
    join PRODFILHO PR on
      NEI.CODPRODFILHO = PR.CODPRODFILHO
    join NFENTRADA NE on
      NEI.CODNFENTRADA = NE.CODNFENTRADA
    join PESSOA P on
      NE.CODPESSOA = P.CODPESSOA
  where
    cast(NE.DTENTRADA as date) between :EDATAINI and :EDATAFIM and
    NE.STATUS                         = 'F'
  order by
    1,
    2,
    3,
    4,
    5
  into
    LENTRADALOCAL,
    LNFISCALLOCAL,
    LCPFCGCLOCAL,
    LSERIELOCAL,
    LIDITEMLOCAL,
    LMATERIALLOCAL,
    LQUANTLOCAL,
    LVL_UNITLOCAL,
    LCDFISCLOCAL,
    LALIQICMLOCAL,
    LALIQIPILOCAL,
    LICMSNORMALLOCAL,
    LDESCONTOLOCAL,
    LBASELOCAL,
    LALIQ_STLOCAL,
    LBCALC_STLOCAL,
    LVL_STLOCAL,
    LVL_IPILOCAL,
    LTIPOLOCAL,
    LICMSTOTALLOCAL,
    TRIBPIS,
    tribCOFINS,
    ORIGEM_MERC
  do
  begin
    LNAOVAZIO = 'N';
    if ((LENTRADA || LNFISCAL || LCPFCGC || LSERIE || LIDITEM) <> (LENTRADALOCAL || LNFISCALLOCAL || LCPFCGCLOCAL || LSERIELOCAL || LIDITEMLOCAL)) then
    begin
      XREF       = RIGHT('00000000' || LXREF, 8);
      XREF2      = LNFISCAL;
      ALIQICM    = LALIQICM;
      CDFISC     = LCDFISC;
      ALIQIPI    = LALIQIPI;
      MATERIAL   = LMATERIAL;
      QUANT      = LQUANT;
      VL_UNIT    = LVL_UNIT;
      ICMSNORMAL = LICMSNORMAL;
      DESCONTO   = LDESCONTO;
      ALIQ_ST    = LALIQ_ST;
      VL_ST      = LVL_ST;
      VL_IPI     = LVL_IPI;
      TIPO       = LTIPO;
      BCALC_ST   = LBCALC_ST;
  
      if (ALIQICM = 0) then
      begin
        TRIBICM    = '2';
        RED_BSCALC = 0;
        if (CDFISC in ('1403', '1551', '1556', '1653','2551', '2556', '2653')) then
          TRIBICM = '9';
        if (CDFISC in ('1152', '2403', '2910', '1403', '1910', '5152', '5405', '5910', '6910')) then
          TRIBICM = '6';
      end
      else
      begin
        TRIBICM    = '1';
        RED_BSCALC = 100;
      end
      BC_ICMS = LBASE;
  
      if (ALIQIPI = 0) then
        BCALC_IPI = 0;
      else
        BCALC_IPI = LBASE;

      if (((LENTRADA || LNFISCAL || LCPFCGC || LSERIE) <> (LENTRADALOCAL || LNFISCALLOCAL || LCPFCGCLOCAL || LSERIELOCAL)) or ((LENTRADA || LNFISCAL || LCPFCGC || LSERIE) is null)) then
      begin
        ICMSCALCULADO  = LICMSCALCULADO;
        ICMSTOTAL      = LICMSTOTAL;
        LICMSCALCULADO = null;
        LICMSTOTAL     = null;
        ICMSNORMAL     = ICMSNORMAL + (ICMSTOTAL - ICMSCALCULADO);
      end
      else
      begin
        ICMSCALCULADO = null;
        ICMSTOTAL     = null;
      end

      DT_APROP = LENTRADALOCAL;

      if (coalesce(aliqipi,0) <> cast(coalesce(aliqipi,0) as integer)) then
      begin
         aliqipi = 0;
      end

      suspend;

      LBASELOCAL = LBASELOCAL - LDESCONTOLOCAL;
      if (((LENTRADA || LNFISCAL || LCPFCGC || LSERIE) <> (LENTRADALOCAL || LNFISCALLOCAL || LCPFCGCLOCAL || LSERIELOCAL)) or ((LENTRADA || LNFISCAL || LCPFCGC || LSERIE) is null)) then
      begin
        LXREF    = coalesce(LXREF, 0) + 1;
        LENTRADA = LENTRADALOCAL;
        LNFISCAL = LNFISCALLOCAL;
        LCPFCGC  = LCPFCGCLOCAL;
        LSERIE   = LSERIELOCAL;
      end
      LIDITEM        = LIDITEMLOCAL;
      LNFISCAL       = LNFISCALLOCAL;
      LALIQICM       = LALIQICMLOCAL;
      LCDFISC        = LCDFISCLOCAL;
      LALIQIPI       = LALIQIPILOCAL;
      LMATERIAL      = LMATERIALLOCAL;
      LQUANT         = LQUANTLOCAL;
      LVL_UNIT       = LVL_UNITLOCAL;
      LICMSNORMAL    = LICMSNORMALLOCAL;
      LDESCONTO      = LDESCONTOLOCAL;
      LALIQ_ST       = LALIQ_STLOCAL;
      LVL_ST         = LVL_STLOCAL;
      LVL_IPI        = LVL_IPILOCAL;
      LTIPO          = LTIPOLOCAL;
      LBCALC_ST      = LBCALC_STLOCAL;
      LICMSCALCULADO = coalesce(LICMSCALCULADO, 0) + LICMSNORMAL;
      LICMSTOTAL     = LICMSTOTALLOCAL;
      LBASE          = LBASELOCAL;
    end
    else
    begin
      LBASELOCAL = LBASELOCAL - LDESCONTOLOCAL;
      if (((LENTRADA || LNFISCAL || LCPFCGC || LSERIE) <> (LENTRADALOCAL || LNFISCALLOCAL || LCPFCGCLOCAL || LSERIELOCAL)) or ((LENTRADA || LNFISCAL || LCPFCGC || LSERIE) is null)) then
      begin
        LXREF    = coalesce(LXREF, 0) + 1;
        LENTRADA = LENTRADALOCAL;
        LNFISCAL = LNFISCALLOCAL;
        LCPFCGC  = LCPFCGCLOCAL;
        LSERIE   = LSERIELOCAL;
      end
      LIDITEM        = LIDITEMLOCAL;
      LNFISCAL       = LNFISCALLOCAL;
      LALIQICM       = LALIQICMLOCAL;
      LCDFISC        = LCDFISCLOCAL;
      LALIQIPI       = LALIQIPILOCAL;
      LMATERIAL      = LMATERIALLOCAL;
      LQUANT         = LQUANTLOCAL;
      LVL_UNIT       = LVL_UNITLOCAL;
      LICMSNORMAL    = LICMSNORMALLOCAL;
      LDESCONTO      = LDESCONTOLOCAL;
      LALIQ_ST       = LALIQ_STLOCAL;
      LVL_ST         = LVL_STLOCAL;
      LVL_IPI        = LVL_IPILOCAL;
      LTIPO          = LTIPOLOCAL;
      LBCALC_ST      = LBCALC_STLOCAL;
      LICMSCALCULADO = coalesce(LICMSCALCULADO, 0) + LICMSNORMAL;
      LICMSTOTAL     = LICMSTOTALLOCAL;
      LBASE          = LBASELOCAL;
    end
  end
  if (LNAOVAZIO is not null) then
  begin
    XREF       = RIGHT('00000000' || LXREF, 8);
    XREF2      = LNFISCAL;
    ALIQICM    = LALIQICM;
    CDFISC     = LCDFISC;
    ALIQIPI    = LALIQIPI;
    MATERIAL   = LMATERIAL;
    QUANT      = LQUANT;
    VL_UNIT    = LVL_UNIT;
    ICMSNORMAL = LICMSNORMAL;
    DESCONTO   = LDESCONTO;
    ALIQ_ST    = LALIQ_ST;
    VL_ST      = LVL_ST;
    VL_IPI     = LVL_IPI;
    TIPO       = LTIPO;
    BCALC_ST   = LBCALC_ST;

    if (ALIQICM = 0) then
    begin
      TRIBICM    = '2';
      RED_BSCALC = 0;
      if (CDFISC in ('1403', '1551', '1556', '1653','2551', '2556', '2653')) then
        TRIBICM = '9';
      if (CDFISC in ('1152', '2403', '2910', '1403', '1910', '5152', '5405', '5910', '6910')) then
        TRIBICM = '6';
    end
    else
    begin
      TRIBICM    = '1';
      RED_BSCALC = 100;
    end
    BC_ICMS = LBASE;

    if (ALIQIPI = 0) then
      BCALC_IPI = 0;
    else
      BCALC_IPI = LBASE;

    DT_APROP = LENTRADALOCAL;

    if (coalesce(aliqipi,0) <> cast(coalesce(aliqipi,0) as integer)) then
    begin
       aliqipi = 0;
    end

    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MGERANFVENDACOPIAFINANCEIRO(
    ECODNFVENDA INTEGER,
    ESERIENF VARCHAR(3),
    EDATAFINANCEIRO DATE,
    EPREV_TIPOPAG VARCHAR(20),
    EQTDPARCELA INTEGER,
    EDIASPRIMEIRA INTEGER,
    EDIASOUTROS INTEGER,
    ECODBANCO INTEGER)
AS
declare variable LVLTOTAL double precision;
declare variable LVLPARCELAPRIMEIRA numeric(15,2);
declare variable LVLPARCELAOUTRAS numeric(15,2);
declare variable LCODPESSOA integer;
declare variable LDT_VENCIM date;
declare variable LQTDPARCELA integer;
declare variable LVLPARCELA double precision;
declare variable LPARCELA varchar(5);
declare variable LUS_CADAST varchar(45);
declare variable LDIAS integer;
declare variable LCODCENTCUSTO integer;
declare variable LVALOR smallint;
declare variable LCODCONTA integer;
declare variable LCODPEDVEND integer;
declare variable SVALOR integer;
begin
  if ((nullif(EPREV_TIPOPAG, '') is not null) and (EQTDPARCELA > 0)) then
  begin
    select
      N.TOTALNOTA,
      N.CODPESSOA,
      N.US_CADAST,
      N.CODPEDVEND
    from
      NFVENDA N
    where
      N.CODNFVENDA = :ECODNFVENDA and
      N.SERIE      = :ESERIENF
    into
      LVLTOTAL,
      LCODPESSOA,
      LUS_CADAST,
      LCODPEDVEND;
      
    select
      VALOR
    from
      MLERPARAMETROINTEIRO('CENTRO DE CUSTO PADRÃO PARA NFVENDA', 0)
    into
      LCODCENTCUSTO;
      
    LVLPARCELAOUTRAS   = LVLTOTAL / EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLTOTAL - LVLPARCELAOUTRAS * EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLPARCELAPRIMEIRA + LVLPARCELAOUTRAS;
  
    while (coalesce(LQTDPARCELA, 1) <= EQTDPARCELA) do
    begin
      if (coalesce(LQTDPARCELA, 1) = 1) then
      begin
        LVLPARCELA = LVLPARCELAPRIMEIRA;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA;
      end
      else
      begin
        LVLPARCELA = LVLPARCELAOUTRAS;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA + (EDIASOUTROS * (LQTDPARCELA - 1));
      end
      LPARCELA = RIGHT('0' || coalesce(LQTDPARCELA, 1), 2) || '/' || RIGHT('0' || EQTDPARCELA, 2);
      
      LDIAS = LDT_VENCIM - cast('TODAY' as date);
  
      LCODCONTA = gen_id(GEN_CONTA, 1);

      insert into
        CONTA (
          CODCONTA,
          STATUS, 
          TIPO,
          DESCRICAO, 
          NRDOCUMENTO, 
          CODPESSOA, 
          DT_EMISSAO, 
          DT_VENCIM, 
          PARCELA, 
          PREV_TIPOPAG, 
          VLPARCELA,
          VLTOTAL, 
          US_CADAST, 
          DT_CADAST, 
          CODNFVENDA, 
          SERIENF, 
          DIAS,
          CODBANCO)
      values (
        :LCODCONTA,
        'ABERTO',
        'RECEBER',
        'COPIA DE NFVENDA',
        :ECODNFVENDA,
        :LCODPESSOA,
        'TODAY',
        :LDT_VENCIM,
        :LPARCELA,
        :EPREV_TIPOPAG,
        :LVLPARCELA,
        :LVLTOTAL,
        :LUS_CADAST,
        'NOW',
        :ECODNFVENDA,
        :ESERIENF,
        :LDIAS,
        :ECODBANCO);
  
      if (nullif(LCODCENTCUSTO, 0) is not null) then
      begin
        insert into
          CONTA_CENTCUSTO (
            CODCENTCUSTO,
            CODCONTA,
            VALOR)
        values (
          :LCODCENTCUSTO,
          :LCODCONTA,
          :LVLPARCELA);
      end
      LQTDPARCELA = coalesce(LQTDPARCELA, 1) + 1;
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MGERANFVENDAMULTIPLOSFINANCEIRO(
    ECODNFVENDA INTEGER,
    ESERIENF VARCHAR(3),
    EDATAFINANCEIRO DATE,
    EPREV_TIPOPAG VARCHAR(20),
    EQTDPARCELA INTEGER,
    EDIASPRIMEIRA INTEGER,
    EDIASOUTROS INTEGER,
    ECODBANCO INTEGER)
AS
declare variable LVLTOTAL double precision;
declare variable LVLPARCELAPRIMEIRA numeric(15,2);
declare variable LVLPARCELAOUTRAS numeric(15,2);
declare variable LCODPESSOA integer;
declare variable LDT_VENCIM date;
declare variable LQTDPARCELA integer;
declare variable LVLPARCELA double precision;
declare variable LPARCELA varchar(5);
declare variable LUS_CADAST varchar(45);
declare variable LDIAS integer;
declare variable LCODCENTCUSTO integer;
declare variable LVALOR smallint;
declare variable LCODCONTA integer;
declare variable LCODPEDVEND integer;
declare variable SVALOR integer;
begin
  if ((nullif(EPREV_TIPOPAG, '') is not null) and (EQTDPARCELA > 0)) then
  begin
    select
      N.TOTALNOTA,
      N.CODPESSOA,
      N.US_CADAST,
      N.CODPEDVEND
    from
      NFVENDA N
    where
      N.CODNFVENDA = :ECODNFVENDA and
      N.SERIE      = :ESERIENF
    into
      LVLTOTAL,
      LCODPESSOA,
      LUS_CADAST,
      LCODPEDVEND;
      
    select
      VALOR
    from
      MLERPARAMETROINTEIRO('CENTRO DE CUSTO PADRÃO PARA NFVENDA', 0)
    into
      LCODCENTCUSTO;
      
    LVLPARCELAOUTRAS   = LVLTOTAL / EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLTOTAL - LVLPARCELAOUTRAS * EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLPARCELAPRIMEIRA + LVLPARCELAOUTRAS;
  
    while (coalesce(LQTDPARCELA, 1) <= EQTDPARCELA) do
    begin
      if (coalesce(LQTDPARCELA, 1) = 1) then
      begin
        LVLPARCELA = LVLPARCELAPRIMEIRA;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA;
      end
      else
      begin
        LVLPARCELA = LVLPARCELAOUTRAS;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA + (EDIASOUTROS * (LQTDPARCELA - 1));
      end
      LPARCELA = RIGHT('0' || coalesce(LQTDPARCELA, 1), 2) || '/' || RIGHT('0' || EQTDPARCELA, 2);
      
      LDIAS = LDT_VENCIM - cast('TODAY' as date);
  
      LCODCONTA = gen_id(GEN_CONTA, 1);

      insert into
        CONTA (
          CODCONTA,
          STATUS, 
          TIPO,
          DESCRICAO, 
          NRDOCUMENTO, 
          CODPESSOA, 
          DT_EMISSAO, 
          DT_VENCIM, 
          PARCELA, 
          PREV_TIPOPAG, 
          VLPARCELA,
          VLTOTAL, 
          US_CADAST, 
          DT_CADAST, 
          CODNFVENDA, 
          SERIENF, 
          DIAS,
          CODBANCO)
      values (
        :LCODCONTA,
        'ABERTO',
        'RECEBER',
        'ACERTO DEBITO VARIOS PEDIDOS',
        :ECODNFVENDA,
        :LCODPESSOA,
        'TODAY',
        :LDT_VENCIM,
        :LPARCELA,
        :EPREV_TIPOPAG,
        :LVLPARCELA,
        :LVLTOTAL,
        :LUS_CADAST,
        'NOW',
        :ECODNFVENDA,
        :ESERIENF,
        :LDIAS,
        :ECODBANCO);
  
      if (nullif(LCODCENTCUSTO, 0) is not null) then
      begin
        insert into
          CONTA_CENTCUSTO (
            CODCENTCUSTO,
            CODCONTA,
            VALOR)
        values (
          :LCODCENTCUSTO,
          :LCODCONTA,
          :LVLPARCELA);
      end
      LQTDPARCELA = coalesce(LQTDPARCELA, 1) + 1;
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MGERAPEDVENDMULTIPLOSFINANCEIRO(
    ECODPEDVEND INTEGER,
    EDATAFINANCEIRO DATE,
    EPREV_TIPOPAG VARCHAR(20),
    EQTDPARCELA INTEGER,
    EDIASPRIMEIRA INTEGER,
    EDIASOUTROS INTEGER)
AS
declare variable LVLTOTAL double precision;
declare variable LVLPARCELAPRIMEIRA numeric(15,2);
declare variable LVLPARCELAOUTRAS numeric(15,2);
declare variable LCODPESSOA integer;
declare variable LDT_VENCIM date;
declare variable LQTDPARCELA integer;
declare variable LVLPARCELA double precision;
declare variable LPARCELA varchar(5);
declare variable LUS_CADAST varchar(45);
declare variable LDIAS integer;
declare variable LCODCENTCUSTO integer;
declare variable LVALOR smallint;
declare variable LCODCONTA integer;
declare variable LCODPEDVEND integer;
declare variable LSALDO double precision;
declare variable LCODVENDEDOR integer;
begin
  if ((nullif(EPREV_TIPOPAG, '') is not null) and (EQTDPARCELA > 0)) then
  begin
    select
      VALOR
    from
      MLERPARAMETROLOGICO('UTILIZAR SINCRONIZAÇÃO DE ID REMOTO', 0)
    into
      LVALOR;
  
    select
      P.valor_total,
      P.CODPESSOA,
      P.US_CADAST,
      P.CODVENDEDOR
    from
      PEDVEND P
    where
      P.codpedvend = :ecodpedvend
    into
      LVLTOTAL,
      LCODPESSOA,
      LUS_CADAST,
      LCODVENDEDOR;
      
    select
      VALOR
    from
      MLERPARAMETROINTEIRO('CENTRO DE CUSTO PADRÃO PARA NFVENDA', 0)
    into
      LCODCENTCUSTO;
      
    LVLPARCELAOUTRAS   = LVLTOTAL / EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLTOTAL - LVLPARCELAOUTRAS * EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLPARCELAPRIMEIRA + LVLPARCELAOUTRAS;
  
    while (coalesce(LQTDPARCELA, 1) <= EQTDPARCELA) do
    begin
      if (coalesce(LQTDPARCELA, 1) = 1) then
      begin
        LVLPARCELA = LVLPARCELAPRIMEIRA;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA;
      end
      else
      begin
        LVLPARCELA = LVLPARCELAOUTRAS;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA + (EDIASOUTROS * (LQTDPARCELA - 1));
      end
      LPARCELA = RIGHT('0' || coalesce(LQTDPARCELA, 1), 2) || '/' || RIGHT('0' || EQTDPARCELA, 2);
      
      LDIAS = LDT_VENCIM - cast('TODAY' as date);
  
      LCODCONTA = null;
      if (LVALOR = 0) then
        LCODCONTA = gen_id(GEN_CONTA, 1);
      else
      begin
        select
          IDENTIFICADOR
        from
          MVERIFICAFAIXA('GEN_CONTA', :LCODCONTA, 'N')
        into
          LCODCONTA;
      end
  
      insert into
        CONTA (
          CODCONTA,
          STATUS, 
          TIPO, 
          DESCRICAO, 
          NRDOCUMENTO, 
          CODPESSOA, 
          DT_EMISSAO, 
          DT_VENCIM, 
          PARCELA, 
          PREV_TIPOPAG, 
          VLPARCELA,
          VLTOTAL, 
          US_CADAST, 
          DT_CADAST, 
          CODPENDVEND,
          DIAS,
          CODVENDEDOR)
      values (
        :LCODCONTA,
        'ABERTO',
        'RECEBER',
        'ACERTO DEBITO VARIOS PEDIDOS',
        :ecodpedvend,
        :LCODPESSOA,
        'TODAY',
        :LDT_VENCIM,
        :LPARCELA,
        :EPREV_TIPOPAG,
        :LVLPARCELA,
        :LVLTOTAL,
        :LUS_CADAST,
        'NOW',
        :ecodpedvend,
        :LDIAS,
        :LCODVENDEDOR);
  
      if (nullif(LCODCENTCUSTO, 0) is not null) then
      begin
        insert into
          CONTA_CENTCUSTO (
            CODCENTCUSTO,
            CODCONTA,
            VALOR,
            CODEMPRESA)
        values (
          :LCODCENTCUSTO,
          :LCODCONTA,
          :LVLPARCELA,
          1);
      end
      LQTDPARCELA = coalesce(LQTDPARCELA, 1) + 1;
    end
  end

  select
    M.VALOR
  from
    MLERPARAMETROLOGICO('UTILIZAR SALDO', 0) M
  into
    LVALOR;


end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE PROLAC_RELCOMISSAO(
    EDTINI DATE,
    EDTFIM DATE)
RETURNS (
    CODVENDEDOR INTEGER,
    VENDEDOR VARCHAR(60),
    CODSTATUS INTEGER,
    STATUS VARCHAR(60),
    CODPESSOA INTEGER,
    PESSOA VARCHAR(60),
    CODPEDVEND INTEGER,
    DTFATURADO DATE,
    CODGRUPO INTEGER,
    GRUPO VARCHAR(60),
    CODSUBGRUPO INTEGER,
    SUBGRUPO VARCHAR(60),
    CODPRODFILHO INTEGER,
    PRODFILHO VARCHAR(60),
    UNIDADE VARCHAR(15),
    QTDENTREGUE DOUBLE PRECISION,
    CAIXA DOUBLE PRECISION,
    PRECOPROD DOUBLE PRECISION,
    DESCONTO_VALOR DOUBLE PRECISION,
    PESOBRUTO DOUBLE PRECISION,
    PESOLIQUIDO DOUBLE PRECISION,
    PERDA DOUBLE PRECISION,
    USUARIO VARCHAR(45),
    ACRESCIMOVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    CODEMPRESA INTEGER,
    CIDADE VARCHAR(45),
    ARE_CODIGO INTEGER,
    AREA VARCHAR(30),
    CURVA VARCHAR(1),
    VALORIPI DOUBLE PRECISION,
    CODFABRICANTE INTEGER,
    CODSUPERVISOR INTEGER,
    CUBAGEM DOUBLE PRECISION,
    CMV DOUBLE PRECISION,
    CODTIPOATV INTEGER,
    TIPOATIVIDADE VARCHAR(60),
    TOTAL DOUBLE PRECISION,
    BAIRRO VARCHAR(45),
    MES VARCHAR(20),
    ANO INTEGER,
    CODCOR INTEGER,
    COR VARCHAR(60),
    FABRICANTE VARCHAR(60),
    QTDEMBALAGEM DOUBLE PRECISION,
    SEMANA VARCHAR(60),
    NUMSEMANA INTEGER,
    SUPERVISOR VARCHAR(60),
    SIGLA CHAR(2),
    VALORCOMISSAO DOUBLE PRECISION,
    ALIQCOMISSAO DOUBLE PRECISION)
AS
declare variable LTOTDESCPEDVEND double precision;
declare variable LTOTACRESPEDVEND double precision;
declare variable LVALOR_BRUTO double precision;
declare variable LFRETE double precision;
declare variable LCODPRODUTO integer;
declare variable LCODUNIDADE integer;
declare variable LDTFATURADO date;
declare variable LDTSAIDA date;
declare variable LPERCACRESCIMO double precision;
declare variable LVALORACRESCIMO double precision;
declare variable LVALORDESCONTO double precision;
declare variable LPERCVALORDESCONTO double precision;
declare variable CODNFVENDA integer;
declare variable LDTINI timestamp;
declare variable LDTFIM timestamp;
declare variable LDIASEMANA integer;
declare variable LSEMANA integer;
begin
  LDTINI = cast(EDTINI||' 00:00:00' as timestamp);
  LDTFIM = cast(EDTFIM||' 23:59:59' as timestamp);

  for select
    P.CODVENDEDOR,
    P.CODPESSOA,
    P.CODPEDVEND,
    P.CODNFVENDA,
    cast(P.DTFATURADO as date),
    cast(P.DT_SAIDA as date),
    P.US_CADAST USUARIO,
    P.CODEMPRESA,
    P.DESC_VALOR,
    P.DESCPERC_VALOR,
    P.ACRESVALOR,
    P.ACRESCIMO,
    P.VALOR_BRUTO,
    P.FRETE
  from
    PEDVEND P
  where
    P.STATUSPED = 'FATURADO' and
    P.TIPOPED in ('VENDA', 'CADERNO') and
    P.DTFATURADO between :LDTINI and :LDTFIM
  into
    :CODVENDEDOR,
    :CODPESSOA,
    :CODPEDVEND,
    :CODNFVENDA,
    :LDTFATURADO,
    :LDTSAIDA,
    :USUARIO,
    :CODEMPRESA,
    :LVALORDESCONTO,
    :LPERCVALORDESCONTO,
    :LVALORACRESCIMO,
    :LPERCACRESCIMO,
    :LVALOR_BRUTO,
    :LFRETE
  do
  begin

    LFRETE = coalesce(LFRETE,0);
    DTFATURADO = coalesce(LDTFATURADO,LDTSAIDA);
    LVALOR_BRUTO = coalesce(nullif(LVALOR_BRUTO,0),1);
    LTOTACRESPEDVEND = coalesce(LVALORACRESCIMO,0) + (coalesce(LVALOR_BRUTO,0) * (coalesce(LPERCACRESCIMO,0)/100));
    LTOTDESCPEDVEND = coalesce(LVALORDESCONTO,0) + coalesce(LPERCVALORDESCONTO,0);

    select FU_RETORNOMEMES_INT.NOME from FU_RETORNOMEMES_INT(extract(month from :DTFATURADO)) into :MES;

    MES = upper(MES);

    ANO = extract(year from DTFATURADO);

    MES = '''' || MES || '''';

    select
       V.NOME VENDEDOR
    from
      VENDEDOR V
    where
      V.CODVENDEDOR = :CODVENDEDOR
    into 
      VENDEDOR;

    select
       U.SIGLA VENDEDOR
    from
      PESSOA P
      inner join TBL_ESTADO U
      on P.UF_1 = U.SIGLA
    where
      P.CODPESSOA = :CODPESSOA
    into 
      SIGLA;

    select 
      PE.CODSTATUS,
      PE.NOME,
      coalesce(PE.ARE_CODIGO,0),
      PE.CIDADE_1,
      coalesce(PE.CODTIPOATV,0),
      PE.BAIRRO_1
    from
      PESSOA PE
    where
      PE.CODPESSOA = :CODPESSOA
    into
      CODSTATUS,
      PESSOA,
      ARE_CODIGO,
      CIDADE,
      CODTIPOATV,
      BAIRRO;

    TIPOATIVIDADE = null;
    select 
      coalesce(DESCRICAO,'NÃO DEFINIDO')
    from
      TBL_RAMOATVTIPO
    where
      CODTIPO = :CODTIPOATV
    into
      TIPOATIVIDADE;

    TIPOATIVIDADE = coalesce(TIPOATIVIDADE,'NÃO DEFINIDO');

    select 
      DESCRICAO
    from
      STATUS ST
    where
       ST.CODSTATUS = :CODSTATUS
    into
      STATUS;

    AREA = null;
    select 
      coalesce(ARE_DESCRICAO,'NÃO DEFINIDO')
    from
      TBL_AREA TA
    where
      TA.ARE_CODIGO = :ARE_CODIGO
    into
      AREA;

    AREA = coalesce(AREA,'NÃO DEFINIDO');

    for select
      pi.CODPRODFILHO,
      PF.DESCRICAO PRODFILHO,
      pi.QTDENTREGUE,
      pi.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1) CAIXA,
      pi.PRECOPROD,
      ((:LTOTDESCPEDVEND * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO)) + coalesce(pi.DESCONTO_VALOR,0)) as DESCONTO_VALOR,
      PF.PESOBRUTO * pi.QTDENTREGUE PESOBRUTO,
      PF.PESOLIQUIDO * pi.QTDENTREGUE PESOLIQUIDO,
      pi.PERDA,
      ((:LTOTACRESPEDVEND * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO))) as ACRESCIMOVALOR,
      (:LFRETE * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO)) as FRETE,
      PF.CURVA,
      (coalesce(pi.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)) VALORIPI,
      (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(pi.QTDENTREGUE,0)) CUBAGEM,
      (coalesce(PF.CUSTOMEDIO,0) * coalesce(pi.QTDENTREGUE,0)) CMV,
      PF.CODPRODUTO,
      PF.CODUNIDADE,
      coalesce(PF.CODCOR,0),
      coalesce(PF.QTDEMBALAGEM,1),
      coalesce(pi.ALIQCOMISSAO,0)
    from
      PEDVENDITEM pi
      join PRODFILHO PF on pi.CODPRODFILHO = PF.CODPRODFILHO
    where
       pi.CODPEDVEND = :CODPEDVEND
    into
      :CODPRODFILHO,
      :PRODFILHO,
      :QTDENTREGUE,
      :CAIXA,
      :PRECOPROD,
      :DESCONTO_VALOR,
      :PESOBRUTO,
      :PESOLIQUIDO,
      :PERDA,
      :ACRESCIMOVALOR,
      :FRETE,
      :CURVA,
      :VALORIPI,
      :CUBAGEM,
      :CMV,
      :LCODPRODUTO,
      :LCODUNIDADE,
      :CODCOR,
      :QTDEMBALAGEM,
      :ALIQCOMISSAO
    do
    begin
      select 
        CODGRUPO, 
        CODSUBGRUPO,
        CODFABRICANTE
      from
        PRODUTO PR
      where
        PR.CODPRODUTO = :LCODPRODUTO
      into
        :CODGRUPO,
        :CODSUBGRUPO,
        :CODFABRICANTE;

      select 
        CODSUPERVISOR
      from
        PESSOA
      where
        CODPESSOA = :CODPESSOA
      into
        :CODSUPERVISOR;

      COR = null;

      select
        DESCRICAO
      from
        TBL_COR
      where
        CODCOR = :CODCOR
      into
        :COR;

      COR = coalesce(COR,'SEM COR');

      select 
        DESCRICAO
      from
        GRUPO
      where
        CODGRUPO = :CODGRUPO
      into
        GRUPO;

      select 
        DESCRICAO
      from
        SUBGRUPO
      where
        CODSUBGRUPO = :CODSUBGRUPO
      into
        SUBGRUPO;

      select 
        coalesce(:UNIDADE, U.SIGLA)
      from
        UNIDADE U
      where
        CODUNIDADE = :LCODUNIDADE
      into
        UNIDADE;

    TOTAL = (((PRECOPROD * QTDENTREGUE) + ACRESCIMOVALOR) - DESCONTO_VALOR);
    FABRICANTE = '';

    select
      PE.NOME
    from
      PESSOA PE
    where
      PE.CODPESSOA = :CODFABRICANTE
    into
      FABRICANTE;

    SUPERVISOR = '';

    select
      SU.NOME
    from
      SUPERVISOR SU
    where
      SU.CODSUPERVISOR = :CODSUPERVISOR
    into
      SUPERVISOR;

    -- { ALTERAÇÕES - BRUNO - 11/07/2012 } --
    -- CARREGA A SEMANA --
    select
    (extract(yearday from cast(:DTFATURADO as date)) - extract(weekday from cast(:DTFATURADO as date) -1)+7)/7 SEMANA
    from RDB$DATABASE into LSEMANA;
    -- CARREGA O PERÍODO DA SEMANA --
    select extract(weekday from :DTFATURADO) from RDB$DATABASE into LDIASEMANA;
    if (LDIASEMANA = 0) then
        LDIASEMANA = 7;

    SEMANA = 'DE ' ||
             RIGHT('00' || cast((extract(day from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
             '/' ||
             RIGHT('00' || cast((extract(month from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
             '/' ||
             extract(year from (:DTFATURADO - (LDIASEMANA - 1))) ||
             ' À ' ||
             RIGHT('00' || cast((extract(day from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
             '/' ||
             RIGHT('00' || cast((extract(month from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
             '/' ||
             extract(year from (:DTFATURADO + (7 - LDIASEMANA)));

    NUMSEMANA = LSEMANA;

    TOTAL = cast(TOTAL as numeric(18,2));
    VALORCOMISSAO = (TOTAL * ALIQCOMISSAO) / 100;
    VALORCOMISSAO = cast(VALORCOMISSAO as numeric(18,2));
    suspend;

    CODCOR = null;
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE R176VENDASPORVENDEDOR(
    EDTINI TIMESTAMP,
    EDTFIM TIMESTAMP,
    EFILTROFABRICANTE INTEGER)
RETURNS (
    CODPEDVEND INTEGER,
    CODPESSOA INTEGER,
    CODVENDEDOR INTEGER,
    DT_SAIDA TIMESTAMP,
    STATUSPED VARCHAR(20),
    VALOR_TOTAL DOUBLE PRECISION,
    NOME VARCHAR(80),
    LITROS DOUBLE PRECISION,
    CUSTO DOUBLE PRECISION,
    MARGEM DOUBLE PRECISION,
    PDV_TIPOFATURAMENTO DOUBLE PRECISION,
    NOME_VENDEDOR VARCHAR(80),
    CODGRUPO INTEGER,
    NOME_GRUPO VARCHAR(80),
    TIPOPED VARCHAR(20),
    CUSTOREPOSI2 DOUBLE PRECISION,
    MARGEM2 DOUBLE PRECISION,
    VALOR_TOTAL_EXIBICAO DOUBLE PRECISION)
AS
begin
  if (EFILTROFABRICANTE > 0) then
  begin
      for
      SELECT
         PD.CODGRUPO,
         GR.DESCRICAO,
         PEDVEND.CODPEDVEND,
         PEDVEND.CODPESSOA,
         PEDVEND.CODVENDEDOR,
         VENDEDOR.NOME,
         PEDVEND.DT_SAIDA,
         PEDVEND.STATUSPED,
         PEDVEND.PDV_TIPOFATURAMENTO,
         PEDVEND.TIPOPED,
         SUM(PI.PRECOVEND),
         (SUM(PI.QTDE* coalesce(PF.FATORCONVERSAO,0))) LITROS,
         SUM(PI.QTDE * coalesce(PI.CUSTOMEDIO,0)),
         SUM(PI.QTDE * coalesce(PI.CUSTOREPOSI2,0))
      FROM PEDVENDITEM PI
      INNER JOIN PEDVEND ON (PEDVEND.CODPEDVEND = PI.CODPEDVEND)
      INNER JOIN PRODFILHO PF ON (PI.CODPRODFILHO = PF.CODPRODFILHO)
      INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
      INNER JOIN GRUPO GR ON (PD.CODGRUPO = GR.CODGRUPO)
      INNER JOIN VENDEDOR ON (VENDEDOR.CODVENDEDOR = PEDVEND.CODVENDEDOR)
      WHERE STATUSPED <> 'CANCELADO' AND DT_SAIDA BETWEEN :EDTINI AND :EDTFIM
      AND PD.CODFABRICANTE = :EFILTROFABRICANTE
      GROUP BY
         PD.CODGRUPO,
         GR.DESCRICAO,
         PEDVEND.CODPEDVEND,
         PEDVEND.CODPESSOA,
         PEDVEND.CODVENDEDOR,
         VENDEDOR.NOME,
         PEDVEND.DT_SAIDA,
         PEDVEND.STATUSPED,
         PEDVEND.PDV_TIPOFATURAMENTO,
         PEDVEND.TIPOPED
      ORDER BY
         VENDEDOR.NOME,
         PEDVEND.STATUSPED,
         PEDVEND.DT_SAIDA
      into
         :CODGRUPO,
         :NOME_GRUPO,
         :CODPEDVEND,
         :CODPESSOA,
         :CODVENDEDOR,
         :NOME_VENDEDOR,
         :DT_SAIDA,
         :STATUSPED,
         :PDV_TIPOFATURAMENTO,
         :TIPOPED,
         :VALOR_TOTAL,
         :LITROS,
         :CUSTO,
         :CUSTOREPOSI2
      do
      begin
         SELECT NOME FROM PESSOA WHERE CODPESSOA = :CODPESSOA INTO :NOME;

         NOME = (RIGHT('00000000' || CAST(CODPESSOA AS VARCHAR(10)),6) || '   ' || NOME);

         if (coalesce(VALOR_TOTAL,0) = 0) then
            VALOR_TOTAL = 1;

         if (STATUSPED = 'FATURADO') then
         begin
             /*SELECT (SUM(NI.QTDE* NI.CUSTOMEDIO)) CUSTOMEDIO
             FROM NFVENDAITEM NI
             INNER JOIN NFVENDA NF ON (NF.CODNFVENDA = NI.CODNFVENDA AND NF.SERIE = NI.SERIE)
             INNER JOIN PRODFILHO PF ON (NI.CODPRODFILHO = PF.CODPRODFILHO)
             INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
             WHERE NI.CODPEDVEND = :CODPEDVEND AND PD.CODFABRICANTE = :EFILTROFABRICANTE AND NF.STATUS = 'F' AND PD.CODGRUPO = :CODGRUPO
             INTO
                 :CUSTO;*/

             MARGEM = (1 - (CUSTO / VALOR_TOTAL)) * 100;
             MARGEM2 = (1 - (CUSTOREPOSI2 / VALOR_TOTAL)) * 100;
         end else begin
             MARGEM = (1 - (CUSTO / VALOR_TOTAL)) * 100;
             MARGEM2 = (1 - (CUSTOREPOSI2 / VALOR_TOTAL)) * 100;
         end

         if (TIPOPED = 'BONIFICA') then
         begin
            VALOR_TOTAL = 0.0000001;
            SUSPEND;
         end
         else
         begin
             if (VALOR_TOTAL > 0) then
                SUSPEND;
         end
      end
  end
  else
  begin
      for
      SELECT
         PD.CODGRUPO,
         GR.DESCRICAO,
         PEDVEND.CODPEDVEND,
         PEDVEND.CODPESSOA,
         PEDVEND.CODVENDEDOR,
         VENDEDOR.NOME,
         PEDVEND.DT_SAIDA,
         PEDVEND.STATUSPED,
         PEDVEND.PDV_TIPOFATURAMENTO,
         PEDVEND.TIPOPED,
         SUM(PI.PRECOVEND),
         (SUM(PI.QTDE* coalesce(PF.FATORCONVERSAO,0))) LITROS,
         SUM(PI.QTDE * coalesce(PI.CUSTOMEDIO,0)),
         SUM(PI.QTDE * coalesce(PI.CUSTOREPOSI2,0))
      FROM PEDVENDITEM PI
      INNER JOIN PEDVEND ON (PEDVEND.CODPEDVEND = PI.CODPEDVEND)
      INNER JOIN PRODFILHO PF ON (PI.CODPRODFILHO = PF.CODPRODFILHO)
      INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
      INNER JOIN GRUPO GR ON (PD.CODGRUPO = GR.CODGRUPO)
      INNER JOIN VENDEDOR ON (VENDEDOR.CODVENDEDOR = PEDVEND.CODVENDEDOR)
      WHERE STATUSPED <> 'CANCELADO' AND DT_SAIDA BETWEEN :EDTINI AND :EDTFIM
      --where pedvenditem.codpedvend = 60813
      GROUP BY
         PD.CODGRUPO,
         GR.DESCRICAO,
         PEDVEND.CODPEDVEND,
         PEDVEND.CODPESSOA,
         PEDVEND.CODVENDEDOR,
         VENDEDOR.NOME,
         PEDVEND.DT_SAIDA,
         PEDVEND.STATUSPED,
         PEDVEND.PDV_TIPOFATURAMENTO,
         PEDVEND.TIPOPED
      ORDER BY
         VENDEDOR.NOME,
         PEDVEND.STATUSPED,
         PEDVEND.DT_SAIDA
      into
         :CODGRUPO,
         :NOME_GRUPO,
         :CODPEDVEND,
         :CODPESSOA,
         :CODVENDEDOR,
         :NOME_VENDEDOR,
         :DT_SAIDA,
         :STATUSPED,
         :PDV_TIPOFATURAMENTO,
         :TIPOPED,
         :VALOR_TOTAL,
         :LITROS,
         :CUSTO,
         :CUSTOREPOSI2
      do
      begin
         SELECT NOME FROM PESSOA WHERE CODPESSOA = :CODPESSOA INTO :NOME;

         NOME = (RIGHT('00000000' || CAST(CODPESSOA AS VARCHAR(10)),6) || '   ' || NOME);

         if (coalesce(VALOR_TOTAL,0) = 0) then
            VALOR_TOTAL = 1;

         if (STATUSPED = 'FATURADO') then
         begin
             /*SELECT (SUM(NI.QTDE* NI.CUSTOMEDIO)) CUSTOMEDIO
             FROM NFVENDAITEM NI
             INNER JOIN NFVENDA NF ON (NF.CODNFVENDA = NI.CODNFVENDA AND NF.SERIE = NI.SERIE)
             INNER JOIN PRODFILHO PF ON (NI.CODPRODFILHO = PF.CODPRODFILHO)
             INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
             WHERE NI.CODPEDVEND = :CODPEDVEND AND NF.STATUS = 'F' AND PD.CODGRUPO = :CODGRUPO
             INTO
                 :CUSTO;*/
             MARGEM = (1 - (CUSTO / VALOR_TOTAL)) * 100;
             MARGEM2 = (1 - (CUSTOREPOSI2 / VALOR_TOTAL)) * 100;
         end else begin
             MARGEM = (1 - (CUSTO / VALOR_TOTAL)) * 100;
             MARGEM2 = (1 - (CUSTOREPOSI2 / VALOR_TOTAL)) * 100;
         end

         VALOR_TOTAL_EXIBICAO = coalesce(VALOR_TOTAL,0);
         if (TIPOPED = 'BONIFICA') then
         begin
            VALOR_TOTAL = 0.0000001;
            SUSPEND;
         end
         else
         begin
             if (VALOR_TOTAL > 0) then
                SUSPEND;
         end
      end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE SEF2012_REGE080(
    DTINI DATE,
    DTFIM DATE)
RETURNS (
    CODCUPOMZ INTEGER,
    INDICADOR SMALLINT,
    MODELO VARCHAR(2),
    ECF VARCHAR(10),
    DATA DATE,
    DIA SMALLINT,
    COP VARCHAR(4),
    NUMCONTABIL VARCHAR(10),
    VENDABRUTA DOUBLE PRECISION,
    CANCELAMENTOS DOUBLE PRECISION,
    DESCONTOS DOUBLE PRECISION,
    ACRESCIMOS DOUBLE PRECISION,
    SERVICOS DOUBLE PRECISION,
    VENDALIQUIDA DOUBLE PRECISION,
    TRIBUTADOS DOUBLE PRECISION,
    ICMSVALOR DOUBLE PRECISION,
    ISENTAS DOUBLE PRECISION,
    SUBSTITUICAO DOUBLE PRECISION)
AS
declare variable LDTINI timestamp;
declare variable LDTFIM timestamp;
declare variable PARAM_CODEMPRESA integer;
declare variable NAOTRIBUTADOS double precision;
declare variable CANCELAMENTOSISS double precision;
declare variable DESCONTOSISS double precision;
declare variable ACRESCIMOSISS double precision;
begin
  LDTINI = cast(DTINI||' 00:00:00' as timestamp);
  LDTFIM = cast(DTFIM||' 23:59:59' as timestamp);

  select
    coalesce(PARAM_CODEMPRESA,1)
  from
    SEF2012
  where
    SEF2012.CODSEF2012 = 1
  into
    :PARAM_CODEMPRESA;

  INDICADOR   = 0;
  MODELO      = '2D';
  COP         = 'SP10';
  NUMCONTABIL = '';
  SERVICOS    = 0;

  for select
    CUPOMZ.CODCUPOMZ,
    cast(CUPOMZ.ECF as integer),
    CUPOMZ.DATAMOVIMENTO,
    CUPOMZ.VENDABRUTA,
    CUPOMZ.VENDALIQUIDA,
    CUPOMZ.ISENTAS,
    CUPOMZ.SUBSTITUICAO,
    CUPOMZ.NAOTRIBUTADOS,
    CUPOMZ.TRIBUTADOS,
    CUPOMZ.DESCONTOS,
    CUPOMZ.CANCELAMENTOS,
    CUPOMZ.ACRESCIMOS,
    CUPOMZ.ICMSTOTAL,
    CUPOMZ.TRIBUTADOSISS + CUPOMZ.ISENTASISS + CUPOMZ.NAOTRIBUTADOSISS + CUPOMZ.SUBSTITUICAOISS,
    CUPOMZ.CANCELAMENTOSISS,
    CUPOMZ.DESCONTOSISS,
    CUPOMZ.ACRESCIMOSISS
  from
    CUPOMZ
  where
    CUPOMZ.DATAMOVIMENTO between :LDTINI and :LDTFIM and
    coalesce(CUPOMZ.CODEMPRESA,1) =:PARAM_CODEMPRESA and
    coalesce(CUPOMZ.VENDALIQUIDA,0) > 0
  order by 2,3
  into
    :CODCUPOMZ,
    :ECF,
    :DATA,
    :VENDABRUTA,
    :VENDALIQUIDA,
    :ISENTAS,
    :SUBSTITUICAO,
    :NAOTRIBUTADOS,
    :TRIBUTADOS,
    :DESCONTOS,
    :CANCELAMENTOS,
    :ACRESCIMOS,
    :ICMSVALOR,
    :SERVICOS,
    :CANCELAMENTOSISS,
    :DESCONTOSISS,
    :ACRESCIMOSISS
  do
  begin
    ECF           = RIGHT('00' || ECF,3);
    ECF           = substring(ECF from 2 for 2);
    DIA           = extract(day from DATA);

    CANCELAMENTOSISS = cast(CANCELAMENTOSISS as numeric(18,3));
    DESCONTOSISS     = cast(DESCONTOSISS as numeric(18,3));
    ACRESCIMOSISS    = cast(ACRESCIMOSISS as numeric(18,3));

    CANCELAMENTOS    = cast(CANCELAMENTOS as numeric(18,3));
    DESCONTOS        = cast(DESCONTOS as numeric(18,3));
    ACRESCIMOS       = cast(ACRESCIMOS as numeric(18,3));

    ACRESCIMOS       = 0;
    ACRESCIMOSISS    = 0;

    CANCELAMENTOS    = CANCELAMENTOS + CANCELAMENTOSISS;
    DESCONTOS        = DESCONTOS + DESCONTOSISS;
    ACRESCIMOS       = ACRESCIMOS + ACRESCIMOSISS;



    TRIBUTADOS       = cast(TRIBUTADOS as numeric(18,3));
    ISENTAS          = cast(ISENTAS as numeric(18,3));
    NAOTRIBUTADOS    = cast(NAOTRIBUTADOS as numeric(18,3));
    SUBSTITUICAO     = cast(SUBSTITUICAO as numeric(18,3));
    ISENTAS          = ISENTAS + NAOTRIBUTADOS;
    SERVICOS         = cast(SERVICOS as numeric(18,3));

    VENDABRUTA       = cast(VENDABRUTA as numeric(18,3));
    VENDALIQUIDA     = cast(VENDALIQUIDA as numeric(18,3));
    VENDALIQUIDA     = VENDABRUTA - CANCELAMENTOS - DESCONTOS + ACRESCIMOS - SERVICOS;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE SPMAPABONIFICA(
    EDTINI DATE,
    EDTFIM DATE)
RETURNS (
    CODVENDEDOR INTEGER,
    VENDEDOR VARCHAR(60),
    CODSTATUS INTEGER,
    STATUS VARCHAR(60),
    CODPESSOA INTEGER,
    PESSOA VARCHAR(60),
    CODPEDVEND INTEGER,
    DTFATURADO DATE,
    CODGRUPO INTEGER,
    GRUPO VARCHAR(60),
    CODSUBGRUPO INTEGER,
    SUBGRUPO VARCHAR(60),
    CODPRODFILHO INTEGER,
    PRODFILHO VARCHAR(60),
    UNIDADE VARCHAR(15),
    QTDENTREGUE DOUBLE PRECISION,
    CAIXA DOUBLE PRECISION,
    PRECOPROD DOUBLE PRECISION,
    DESCONTO_VALOR DOUBLE PRECISION,
    PESOBRUTO DOUBLE PRECISION,
    PESOLIQUIDO DOUBLE PRECISION,
    PERDA DOUBLE PRECISION,
    USUARIO VARCHAR(45),
    ACRESCIMOVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    CODEMPRESA INTEGER,
    CIDADE VARCHAR(45),
    ARE_CODIGO INTEGER,
    AREA VARCHAR(30),
    CURVA VARCHAR(1),
    VALORIPI DOUBLE PRECISION,
    CODFABRICANTE INTEGER,
    CODSUPERVISOR INTEGER,
    CUBAGEM DOUBLE PRECISION,
    CMV DOUBLE PRECISION,
    CODTIPOATV INTEGER,
    TIPOATIVIDADE VARCHAR(60),
    TOTAL DOUBLE PRECISION,
    BAIRRO VARCHAR(45),
    MES VARCHAR(20),
    ANO INTEGER,
    CODCOR INTEGER,
    COR VARCHAR(60),
    FABRICANTE VARCHAR(60),
    QTDEMBALAGEM DOUBLE PRECISION,
    SEMANA VARCHAR(60),
    NUMSEMANA INTEGER,
    SUPERVISOR VARCHAR(60),
    SIGLA CHAR(2),
    CODSTATUS_CHECKOUT INTEGER,
    STATUS_CHECKOUT VARCHAR(60),
    CODVENDEDORSECUNDARIO INTEGER,
    VENDEDORSECUNDARIO VARCHAR(60))
AS
declare variable LTOTDESCPEDVEND double precision;
declare variable LTOTACRESPEDVEND double precision;
declare variable LVALOR_BRUTO double precision;
declare variable LCODPEDVEND integer;
declare variable LFRETE double precision;
declare variable LCODPRODUTO integer;
declare variable LCODUNIDADE integer;
declare variable LDTFATURADO date;
declare variable LDTSAIDA date;
declare variable LPERCACRESCIMO double precision;
declare variable LVALORACRESCIMO double precision;
declare variable LVALORDESCONTO double precision;
declare variable LPERCVALORDESCONTO double precision;
declare variable LEXIBIRAPENASONUMERODOPEDIDO smallint;
declare variable LCODFATURAMENTO integer;
declare variable LCODNFVENDA integer;
declare variable LSOMAFRETE varchar(1);
declare variable LNAOSOMARFRETENORELATORIO smallint;
declare variable LSOMARIPIAOTOTAL smallint;
declare variable LDTINI timestamp;
declare variable LDTFIM timestamp;
declare variable LDIASEMANA integer;
declare variable LSEMANA integer;
declare variable LEXIBIRNOMEFANTAZIA smallint;
declare variable PESSOA_FANTAZIA varchar(60);
begin
  LDTINI = cast(EDTINI||' 00:00:00' as timestamp);
  LDTFIM = cast(EDTFIM||' 23:59:59' as timestamp);

  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0)
  into
    LEXIBIRAPENASONUMERODOPEDIDO;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR NOME FANTAZIA',0)
  into
    LEXIBIRNOMEFANTAZIA;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('SOMAR IPI AO TOTAL',0)
  into
    LSOMARIPIAOTOTAL;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('NÃO SOMAR FRETE NO RELATORIO',0)
  into
    LNAOSOMARFRETENORELATORIO;

  select 
    SOMAFRETE
  from
    SYSPARAMS
  into
    LSOMAFRETE;

  for select
    P.CODVENDEDOR,
    P.CODPESSOA,
    P.CODPEDVEND,
    P.CODFATURAMENTO,
    P.CODNFVENDA,
    cast(P.DTFATURADO as date),
    cast(P.DT_SAIDA as date),
    P.US_CADAST USUARIO,
    P.CODEMPRESA,
    P.DESC_VALOR,
    P.DESCPERC_VALOR,
    P.ACRESVALOR,
    P.ACRESCIMO,
    P.VALOR_BRUTO,
    P.FRETE,
    P.CODVENDEDORSECUNDARIO
  from
    PEDVEND P
  where
    P.STATUSPED = 'FATURADO' and
    P.TIPOPED = 'BONIFICA' and
    P.DTFATURADO between :LDTINI and :LDTFIM
  into
    :CODVENDEDOR,
    :CODPESSOA,
    :LCODPEDVEND,
    :LCODFATURAMENTO,
    :LCODNFVENDA,
    :LDTFATURADO,
    :LDTSAIDA,
    :USUARIO,
    :CODEMPRESA,
    :LVALORDESCONTO,
    :LPERCVALORDESCONTO,
    :LVALORACRESCIMO,
    :LPERCACRESCIMO,
    :LVALOR_BRUTO,
    :LFRETE,
    :CODVENDEDORSECUNDARIO
  do
  begin

    if (LEXIBIRAPENASONUMERODOPEDIDO = 0) then
      CODPEDVEND = coalesce(LCODFATURAMENTO, LCODNFVENDA, LCODPEDVEND);
    else
      CODPEDVEND = LCODPEDVEND;

    LFRETE = coalesce(LFRETE,0);
    DTFATURADO = coalesce(LDTFATURADO,LDTSAIDA);
    LVALOR_BRUTO = coalesce(nullif(LVALOR_BRUTO,0),1);
    LTOTACRESPEDVEND = coalesce(LVALORACRESCIMO,0) + (coalesce(LVALOR_BRUTO,0) * (coalesce(LPERCACRESCIMO,0)/100));
    LTOTDESCPEDVEND = coalesce(LVALORDESCONTO,0) + coalesce(LPERCVALORDESCONTO,0);

    select FU_RETORNOMEMES_INT.NOME from FU_RETORNOMEMES_INT(extract(month from :DTFATURADO)) into :MES;

    MES = upper(MES);

    ANO = extract(year from DTFATURADO);

    MES = '''' || MES || '''';

    select
       V.NOME VENDEDOR
    from
      VENDEDOR V
    where
      V.CODVENDEDOR = :CODVENDEDOR
    into 
      VENDEDOR;

    select
       V.NOME VENDEDOR
    from
      VENDEDOR V
    where
      V.CODVENDEDOR = :CODVENDEDORSECUNDARIO
    into 
      VENDEDORSECUNDARIO;

    select
       u.SIGLA VENDEDOR
    from
      PESSOA p
      inner join TBL_ESTADO u
      on p.UF_1 = u.SIGLA
    where
      p.CODPESSOA = :CODPESSOA
    into 
      SIGLA;

    select 
      PE.CODSTATUS,
      PE.NOME,
      coalesce(PE.ARE_CODIGO,0),
      PE.CIDADE_1,
      coalesce(PE.CODTIPOATV,0),
      PE.BAIRRO_1,
      PE.CODSTATUS_CHECKOUT
    from
      PESSOA PE
    where
      PE.CODPESSOA = :CODPESSOA
    into
      CODSTATUS,
      PESSOA,
      ARE_CODIGO,
      CIDADE,
      CODTIPOATV,
      BAIRRO,
      CODSTATUS_CHECKOUT;

    TIPOATIVIDADE = null;
    select 
      coalesce(DESCRICAO,'NÃO DEFINIDO')
    from
      TBL_RAMOATVTIPO
    where
      CODTIPO = :CODTIPOATV
    into
      TIPOATIVIDADE;

    TIPOATIVIDADE = coalesce(TIPOATIVIDADE,'NÃO DEFINIDO');

    select 
      DESCRICAO
    from
      STATUS ST
    where
       ST.CODSTATUS = :CODSTATUS
    into
      STATUS;

    STATUS_CHECKOUT = '';

    select 
      DESCRICAO
    from
      STATUS ST
    where
       ST.CODSTATUS = :CODSTATUS_CHECKOUT
    into
      STATUS_CHECKOUT;

    AREA = null;
    select 
      coalesce(ARE_DESCRICAO,'NÃO DEFINIDO')
    from
      TBL_AREA TA
    where
      TA.ARE_CODIGO = :ARE_CODIGO
    into
      AREA;

    AREA = coalesce(AREA,'NÃO DEFINIDO');

    for select
      pi.CODPRODFILHO,
      PF.DESCRICAO PRODFILHO,
      pi.QTDENTREGUE,
      pi.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1) CAIXA,
      pi.PRECOPROD,
      ((:LTOTDESCPEDVEND * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO)) + coalesce(pi.DESCONTO_VALOR,0)) as DESCONTO_VALOR,
      PF.PESOBRUTO * pi.QTDENTREGUE PESOBRUTO,
      PF.PESOLIQUIDO * pi.QTDENTREGUE PESOLIQUIDO,
      pi.PERDA,
      ((:LTOTACRESPEDVEND * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO))) as ACRESCIMOVALOR,
      (:LFRETE * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO)) as FRETE,
      PF.CURVA,
      (coalesce(pi.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)) VALORIPI,
      (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(pi.QTDENTREGUE,0)) CUBAGEM,
      (coalesce(PF.CUSTOMEDIO,0) * coalesce(pi.QTDENTREGUE,0)) CMV,
      PF.CODPRODUTO,
      PF.CODUNIDADE,
      coalesce(PF.CODCOR,0),
      coalesce(PF.QTDEMBALAGEM,1)
    from
      PEDVENDITEM pi
      join PRODFILHO PF on pi.CODPRODFILHO = PF.CODPRODFILHO
    where
       pi.CODPEDVEND = :LCODPEDVEND
    into
      :CODPRODFILHO,
      :PRODFILHO,
      :QTDENTREGUE,
      :CAIXA,
      :PRECOPROD,
      :DESCONTO_VALOR,
      :PESOBRUTO,
      :PESOLIQUIDO,
      :PERDA,
      :ACRESCIMOVALOR,
      :FRETE,
      :CURVA,
      :VALORIPI,
      :CUBAGEM,
      :CMV,
      :LCODPRODUTO,
      :LCODUNIDADE,
      :CODCOR,
      :QTDEMBALAGEM
    do
    begin
      select 
        CODGRUPO, 
        CODSUBGRUPO,
        CODFABRICANTE
      from
        PRODUTO PR
      where
        PR.CODPRODUTO = :LCODPRODUTO
      into
        :CODGRUPO,
        :CODSUBGRUPO,
        :CODFABRICANTE;

      select 
        CODSUPERVISOR
      from
        PESSOA
      where
        CODPESSOA = :CODPESSOA
      into
        :CODSUPERVISOR;

      COR = null;

      select
        DESCRICAO
      from
        TBL_COR
      where
        CODCOR = :CODCOR
      into
        :COR;

      COR = coalesce(COR,'SEM COR');

      select 
        DESCRICAO
      from
        GRUPO
      where
        CODGRUPO = :CODGRUPO
      into
        GRUPO;


      select 
        DESCRICAO
      from
        SUBGRUPO
      where
        CODSUBGRUPO = :CODSUBGRUPO
      into
        SUBGRUPO;

      select 
        coalesce(:UNIDADE, U.SIGLA)
      from
        UNIDADE U
      where
        CODUNIDADE = :LCODUNIDADE
      into
        UNIDADE;


      if ((LSOMARIPIAOTOTAL <> 0) and (LNAOSOMARFRETENORELATORIO = 0) and (LSOMAFRETE = 'S')) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + FRETE + VALORIPI) - DESCONTO_VALOR));
      else if ((LNAOSOMARFRETENORELATORIO = 0) and (LSOMAFRETE = 'S')) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + FRETE)- DESCONTO_VALOR));
      else if (LSOMARIPIAOTOTAL <> 0) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + VALORIPI) - DESCONTO_VALOR));
      else
        TOTAL = (((PRECOPROD * QTDENTREGUE) + ACRESCIMOVALOR) - DESCONTO_VALOR);

    FABRICANTE = '';

    select
      PE.NOME
    from
      PESSOA PE
    where
      PE.CODPESSOA = :CODFABRICANTE
    into
      FABRICANTE;

    SUPERVISOR = '';

    select
      SU.NOME
    from
      SUPERVISOR SU
    where
      SU.CODSUPERVISOR = :CODSUPERVISOR
    into
      SUPERVISOR;

    -- { ALTERAÇÕES - BRUNO - 11/07/2012 } --
    -- CARREGA A SEMANA --
    select
    (extract(yearday from cast(:DTFATURADO as date)) - extract(weekday from cast(:DTFATURADO as date) -1)+7)/7 SEMANA
    from rdb$database into LSEMANA;
    -- CARREGA O PERÍODO DA SEMANA --
    select extract(weekday from :DTFATURADO) from rdb$database into LDIASEMANA;
    if (LDIASEMANA = 0) then
        LDIASEMANA = 7;

    SEMANA = 'De ' ||
             RIGHT('00' || cast((extract(day from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
             '/' ||
             RIGHT('00' || cast((extract(month from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
             '/' ||
             extract(year from (:DTFATURADO - (LDIASEMANA - 1))) ||
             ' à ' ||
             RIGHT('00' || cast((extract(day from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
             '/' ||
             RIGHT('00' || cast((extract(month from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
             '/' ||
             extract(year from (:DTFATURADO + (7 - LDIASEMANA)));

    NUMSEMANA = LSEMANA;
    -- { FIM ALTERAÇÕES - BRUNO - 11/07/2012 } --

    if (LEXIBIRNOMEFANTAZIA <> 0) then
    begin
       select PESSOA.nomefantazia from PESSOA where PESSOA.CODPESSOA = :CODPESSOA into :PESSOA_FANTAZIA;

       if (coalesce(PESSOA_FANTAZIA,'') <> '') then
       begin
          PESSOA = PESSOA_FANTAZIA;
       end

    end

    suspend;

    codcor = null;

    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE SPMAPAVENDAS(
    EDTINI DATE,
    EDTFIM DATE,
    TIPODATA VARCHAR(20) = 'DTFATURADO')
RETURNS (
    CODVENDEDOR INTEGER,
    VENDEDOR VARCHAR(60),
    CODSTATUS INTEGER,
    STATUS VARCHAR(60),
    CODPESSOA INTEGER,
    PESSOA VARCHAR(60),
    CODPEDVEND INTEGER,
    DTFATURADO DATE,
    CODGRUPO INTEGER,
    GRUPO VARCHAR(60),
    CODSUBGRUPO INTEGER,
    SUBGRUPO VARCHAR(60),
    CODPRODFILHO INTEGER,
    PRODFILHO VARCHAR(60),
    UNIDADE VARCHAR(15),
    QTDENTREGUE DOUBLE PRECISION,
    CAIXA DOUBLE PRECISION,
    PRECOPROD DOUBLE PRECISION,
    DESCONTO_VALOR DOUBLE PRECISION,
    PESOBRUTO DOUBLE PRECISION,
    PESOLIQUIDO DOUBLE PRECISION,
    PERDA DOUBLE PRECISION,
    USUARIO VARCHAR(45),
    ACRESCIMOVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    CODEMPRESA INTEGER,
    CIDADE VARCHAR(45),
    ARE_CODIGO INTEGER,
    AREA VARCHAR(30),
    CURVA VARCHAR(1),
    VALORIPI DOUBLE PRECISION,
    CODFABRICANTE INTEGER,
    CODSUPERVISOR INTEGER,
    CUBAGEM DOUBLE PRECISION,
    CMV DOUBLE PRECISION,
    CODTIPOATV INTEGER,
    TIPOATIVIDADE VARCHAR(60),
    TOTAL DOUBLE PRECISION,
    CUSTO DOUBLE PRECISION,
    BAIRRO VARCHAR(45),
    MES VARCHAR(20),
    ANO INTEGER,
    CODCOR INTEGER,
    COR VARCHAR(60),
    FABRICANTE VARCHAR(60),
    QTDEMBALAGEM DOUBLE PRECISION,
    SEMANA VARCHAR(60),
    NUMSEMANA INTEGER,
    SUPERVISOR VARCHAR(60),
    SIGLA CHAR(2),
    CODSTATUS_CHECKOUT INTEGER,
    STATUS_CHECKOUT VARCHAR(60),
    CODVENDEDORSECUNDARIO INTEGER,
    VENDEDORSECUNDARIO VARCHAR(60),
    EMPRESA VARCHAR(60),
    STATUSPED VARCHAR(30),
    TIPOPED VARCHAR(30),
    CARACTER BLOB SUB_TYPE TEXT SEGMENT SIZE 80,
    CODPROMOCAO INTEGER,
    CODEMBARQUE INTEGER,
    CANALVENDAS VARCHAR(10),
    CODPESSOAMATRIZ INTEGER,
    NOMEMATRIZ VARCHAR(60),
    CODSEGMENTO INTEGER)
AS
declare variable LTOTDESCPEDVEND double precision;
declare variable LTOTACRESPEDVEND double precision;
declare variable LVALOR_BRUTO double precision;
declare variable LCODPEDVEND integer;
declare variable LFRETE double precision;
declare variable LSQL varchar(1000);
declare variable LCODPRODUTO integer;
declare variable LCODUNIDADE integer;
declare variable LDTFATURADO date;
declare variable LDTSAIDA date;
declare variable LPERCACRESCIMO double precision;
declare variable LVALORACRESCIMO double precision;
declare variable LVALORDESCONTO double precision;
declare variable LPERCVALORDESCONTO double precision;
declare variable LEXIBIRAPENASONUMERODOPEDIDO smallint;
declare variable LCODFATURAMENTO integer;
declare variable LCODNFVENDA integer;
declare variable LSOMAFRETE varchar(1);
declare variable LNAOSOMARFRETENORELATORIO smallint;
declare variable LSOMARIPIAOTOTAL smallint;
declare variable LDTINI timestamp;
declare variable LDTFIM timestamp;
declare variable LDIASEMANA integer;
declare variable LSEMANA integer;
declare variable LEXIBIRNOMEFANTAZIA smallint;
declare variable PESSOA_FANTAZIA varchar(60);
declare variable LCUSTOREPOSI double precision;
declare variable LCUSTOMEDIO double precision;
declare variable LCODPROMOCAOITEM integer;
declare variable LCANALVENDAS integer;
begin
  LDTINI = cast(EDTINI||' 00:00:00' as timestamp);
  LDTFIM = cast(EDTFIM||' 23:59:59' as timestamp);

  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0)
  into
    LEXIBIRAPENASONUMERODOPEDIDO;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR NOME FANTAZIA',0)
  into
    LEXIBIRNOMEFANTAZIA;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('SOMAR IPI AO TOTAL',0)
  into
    LSOMARIPIAOTOTAL;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('NÃfO SOMAR FRETE NO RELATORIO',0)
  into
    LNAOSOMARFRETENORELATORIO;

  select 
    SOMAFRETE
  from
    SYSPARAMS
  into
    LSOMAFRETE;

  LSQL =
    'select
      P.CODVENDEDOR,
      P.CODPESSOA,
      P.CODPEDVEND,
      P.CODFATURAMENTO,
      P.CODNFVENDA,
      cast(P.DTFATURADO as date),
      cast(P.DT_SAIDA as date),
      P.US_CADAST USUARIO,
      P.CODEMPRESA,
      P.DESC_VALOR,
      P.DESCPERC_VALOR,
      P.ACRESVALOR,
      P.ACRESCIMO,
      P.VALOR_BRUTO,
      P.FRETE,
      P.CODVENDEDORSECUNDARIO,
      P.STATUSPED,
      P.TIPOPED,
      P.CANALVENDAS
    from
      PEDVEND P
    where
     '|| :TIPODATA || ' between ''' ||:LDTINI|| ''' and ''' || :LDTFIM ||'''';

  for execute statement
    LSQL
  into
    CODVENDEDOR,
    CODPESSOA,
    LCODPEDVEND,
    LCODFATURAMENTO,
    LCODNFVENDA,
    LDTFATURADO,
    LDTSAIDA,
    USUARIO,
    CODEMPRESA,
    LVALORDESCONTO,
    LPERCVALORDESCONTO,
    LVALORACRESCIMO,
    LPERCACRESCIMO,
    LVALOR_BRUTO,
    LFRETE,
    CODVENDEDORSECUNDARIO,
    STATUSPED,
    TIPOPED,
    LCANALVENDAS
  do
  begin
    LCANALVENDAS = coalesce(LCANALVENDAS,0);

    if (LCANALVENDAS = 0) then
      CANALVENDAS = 'VI';
    if (LCANALVENDAS = 1) then
      CANALVENDAS = 'FV';
    if (LCANALVENDAS = 0) then
      CANALVENDAS = 'B2B';
    if (LCANALVENDAS = 0) then
      CANALVENDAS = 'B2C';

    CODEMBARQUE = 0;
    SELECT
      FIRST 1
      CODEMBARQUE_FK
    FROM
      EMBARQUEITEM
    WHERE
      EMBARQUEITEM.CODPEDVEND_FK = :LCODPEDVEND
      AND COALESCE(EMBARQUEITEM.RETORNO,'N') = 'N'
    INTO
      CODEMBARQUE;

    if (LEXIBIRAPENASONUMERODOPEDIDO = 0) then
      CODPEDVEND = coalesce(LCODFATURAMENTO, LCODNFVENDA, LCODPEDVEND);
    else
      CODPEDVEND = LCODPEDVEND;
    LFRETE = coalesce(LFRETE,0);
    if (TIPODATA = 'DTFATURADO') then
    begin
      DTFATURADO = LDTFATURADO;
    end
    else
    begin
      DTFATURADO = LDTSAIDA;
    end
    LVALOR_BRUTO = coalesce(nullif(LVALOR_BRUTO,0),1);
    LTOTACRESPEDVEND = coalesce(LVALORACRESCIMO,0) + (coalesce(LVALOR_BRUTO,0) * (coalesce(LPERCACRESCIMO,0)/100));
    LTOTDESCPEDVEND = coalesce(LVALORDESCONTO,0) + coalesce(LPERCVALORDESCONTO,0);
    select
      FU_RETORNOMEMES_INT.NOME
    from
      FU_RETORNOMEMES_INT(extract(month from :DTFATURADO))
    into
      MES;

    MES = upper(MES);

    ANO = extract(year from DTFATURADO);

    MES = '''' || MES || '''';

    select
       V.NOME VENDEDOR
    from
      VENDEDOR V
    where
      V.CODVENDEDOR = :CODVENDEDOR
    into 
      VENDEDOR;

    select
       V.NOME VENDEDOR
    from
      VENDEDOR V
    where
      V.CODVENDEDOR = :CODVENDEDORSECUNDARIO
    into 
      VENDEDORSECUNDARIO;

    select
       U.SIGLA VENDEDOR
    from
      PESSOA P
      join TBL_ESTADO U
        on P.UF_1 = U.SIGLA
    where
      P.CODPESSOA = :CODPESSOA
    into 
      SIGLA;

    select 
      PE.CODSTATUS,
      PE.NOME,
      coalesce(PE.ARE_CODIGO,0),
      PE.CIDADE_1,
      coalesce(PE.CODTIPOATV,0),
      PE.BAIRRO_1,
      PE.CODSTATUS_CHECKOUT,
      PE.CODPESSOAMATRIZ,
      M.NOMEFANTAZIA,
      PE.CODSEGMENTO
    from
      PESSOA PE
      LEFT JOIN PESSOA M ON
        PE.CODPESSOAMATRIZ = M.CODPESSOA
    where
      PE.CODPESSOA = :CODPESSOA
    into
      CODSTATUS,
      PESSOA,
      ARE_CODIGO,
      CIDADE,
      CODTIPOATV,
      BAIRRO,
      CODSTATUS_CHECKOUT,
      CODPESSOAMATRIZ,
      NOMEMATRIZ,
      CODSEGMENTO;

    TIPOATIVIDADE = null;

    select 
      coalesce(DESCRICAO,'NÃfO DEFINIDO')
    from
      TBL_RAMOATVTIPO
    where
      CODTIPO = :CODTIPOATV
    into
      TIPOATIVIDADE;

    TIPOATIVIDADE = coalesce(TIPOATIVIDADE,'NÃfO DEFINIDO');

    select 
      DESCRICAO
    from
      STATUS ST
    where
       ST.CODSTATUS = :CODSTATUS
    into
      STATUS;

    STATUS_CHECKOUT = '';

    select 
      DESCRICAO
    from
      STATUS ST
    where
       ST.CODSTATUS = :CODSTATUS_CHECKOUT
    into
      STATUS_CHECKOUT;

    AREA = null;

    select 
      coalesce(ARE_DESCRICAO,'NÃfO DEFINIDO')
    from
      TBL_AREA TA
    where
      TA.ARE_CODIGO = :ARE_CODIGO
    into
      AREA;

    AREA = coalesce(AREA,'NÃfO DEFINIDO');

    select
      E.EMPRESA
    from
      EMPRESA E
    where
      E.CODEMPRESA = :CODEMPRESA
    into
      EMPRESA;

    for select
      PI.CODPRODFILHO,
      PF.DESCRICAO PRODFILHO,
      PI.QTDENTREGUE - coalesce(pi.qtddevolvida,0),
      (PI.QTDENTREGUE - coalesce(pi.qtddevolvida,0)) / coalesce(nullif(PF.QTDEMBALAGEM,0),1) CAIXA,
      PI.PRECOPROD,
      ((:LTOTDESCPEDVEND * (coalesce(PI.PRECOVEND,0) / :LVALOR_BRUTO)) + coalesce(PI.DESCONTO_VALOR,0)) DESCONTO_VALOR,
      PF.PESOBRUTO * PI.QTDENTREGUE PESOBRUTO,
      PF.PESOLIQUIDO * PI.QTDENTREGUE PESOLIQUIDO,
      PI.PERDA,
      ((:LTOTACRESPEDVEND * (coalesce(PI.PRECOVEND,0) / :LVALOR_BRUTO))) as ACRESCIMOVALOR,
      (:LFRETE * (coalesce(PI.PRECOVEND,0) / :LVALOR_BRUTO)) as FRETE,
      PF.CURVA,
      (coalesce(pi.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)) VALORIPI,
      (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(PI.QTDENTREGUE,0)) CUBAGEM,
      (coalesce(PF.CUSTOMEDIO,0) * coalesce(PI.QTDENTREGUE,0)) CMV,
      PF.CODPRODUTO,
      PF.CODUNIDADE,
      coalesce(PF.CODCOR,0),
      coalesce(PF.QTDEMBALAGEM,1) ,
      PI.CUSTOREPOSI * PI.QTDE,
      PI.CUSTOMEDIO * PI.QTDE,
      PI.CODPROMOCAOITEM
    from
      PEDVENDITEM PI
      join PRODFILHO PF on
        PI.CODPRODFILHO = PF.CODPRODFILHO
    where
       PI.CODPEDVEND = :LCODPEDVEND
    into
      CODPRODFILHO,
      PRODFILHO,
      QTDENTREGUE,
      CAIXA,
      PRECOPROD,
      DESCONTO_VALOR,
      PESOBRUTO,
      PESOLIQUIDO,
      PERDA,
      ACRESCIMOVALOR,
      FRETE,
      CURVA,
      VALORIPI,
      CUBAGEM,
      CMV,
      LCODPRODUTO,
      LCODUNIDADE,
      CODCOR,
      QTDEMBALAGEM,
      LCUSTOREPOSI,
      LCUSTOMEDIO,
      LCODPROMOCAOITEM
    do
    begin
      select 
        CODGRUPO, 
        CODSUBGRUPO,
        CODFABRICANTE
      from
        PRODUTO PR
      where
        PR.CODPRODUTO = :LCODPRODUTO
      into
        CODGRUPO,
        CODSUBGRUPO,
        CODFABRICANTE;

      select 
        CODSUPERVISOR
      from
        PESSOA
      where
        CODPESSOA = :CODPESSOA
      into
        CODSUPERVISOR;

      COR = null;

      select
        DESCRICAO
      from
        TBL_COR
      where
        CODCOR = :CODCOR
      into
        COR;

      COR = coalesce(COR,'SEM COR');

      select 
        DESCRICAO
      from
        GRUPO
      where
        CODGRUPO = :CODGRUPO
      into
        GRUPO;

      select 
        DESCRICAO
      from
        SUBGRUPO
      where
        CODSUBGRUPO = :CODSUBGRUPO
      into
        SUBGRUPO;

      select 
        U.SIGLA
      from
        UNIDADE U
      where
        CODUNIDADE = :LCODUNIDADE
      into
        UNIDADE;

      CARACTER = null;
      SELECT
        ';'||list(CARACTER.CODCARACTER,';')||';'
      from
        PRODCARACTER
        JOIN CARACTER ON
          PRODCARACTER.CODCARACTER = CARACTER.CODCARACTER
      where
        CODPRODUTO = :LCODPRODUTO
      into
        :CARACTER;

      SELECT
        CODPROMOCAO_FK
      FROM
        PROMOCAOITEM
      WHERE
        CODPROMOCAOITEM = :LCODPROMOCAOITEM
      INTO
        CODPROMOCAO;

      if ((LSOMARIPIAOTOTAL <> 0) and (LNAOSOMARFRETENORELATORIO = 0) and (LSOMAFRETE = 'S')) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + FRETE + VALORIPI) - DESCONTO_VALOR));
      else if ((LNAOSOMARFRETENORELATORIO = 0) and (LSOMAFRETE = 'S')) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + FRETE)- DESCONTO_VALOR));
      else if (LSOMARIPIAOTOTAL <> 0) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + VALORIPI) - DESCONTO_VALOR));
      else
        TOTAL = (((PRECOPROD * QTDENTREGUE) + ACRESCIMOVALOR) - DESCONTO_VALOR);

      CUSTO = LCUSTOREPOSI;

      FABRICANTE = '';
  
      select
        PE.NOME
      from
        PESSOA PE
      where
        PE.CODPESSOA = :CODFABRICANTE
      into
        FABRICANTE;
  
      SUPERVISOR = '';
  
      select
        SU.NOME
      from
        SUPERVISOR SU
      where
        SU.CODSUPERVISOR = :CODSUPERVISOR
      into
        SUPERVISOR;
  
      /* { ALTERAÃ?Ã.ES - BRUNO - 11/07/2012 } -- */
      /* CARREGA A SEMANA -- */
      select
        (extract(yearday from cast(:DTFATURADO as date)) -
        extract(weekday from cast(:DTFATURADO as date) -1)+7)/7 SEMANA
      from
        rdb$database
      into
        LSEMANA;
      /* CARREGA O PERÃODO DA SEMANA -- */
  
      select
        extract(weekday from :DTFATURADO)
      from
        rdb$database
      into
        LDIASEMANA;
  
      if (LDIASEMANA = 0) then
        LDIASEMANA = 7;
  
      SEMANA = 'De ' ||
               RIGHT('00' || cast((extract(day from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
               '/' ||
               RIGHT('00' || cast((extract(month from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
               '/' ||
               extract(year from (:DTFATURADO - (LDIASEMANA - 1))) ||
               ' Ã  ' ||
               RIGHT('00' || cast((extract(day from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
               '/' ||
               RIGHT('00' || cast((extract(month from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
               '/' ||
               extract(year from (:DTFATURADO + (7 - LDIASEMANA)));
  
      NUMSEMANA = LSEMANA;
      /* { FIM ALTERAÃ?Ã.ES - BRUNO - 11/07/2012 } -- */
  
      if (LEXIBIRNOMEFANTAZIA <> 0) then
      begin
        select
          PESSOA.NOMEFANTAZIA
        from
          PESSOA
        where
          PESSOA.CODPESSOA = :CODPESSOA
        into
          PESSOA_FANTAZIA;
  
         if (coalesce(PESSOA_FANTAZIA,'') <> '') then
         begin
            PESSOA = PESSOA_FANTAZIA;
         end
  
      end
  
      suspend;
  
      CODCOR = null;
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE SPMAPAVENDAS_VENDEDOR(
    EDTINI DATE,
    EDTFIM DATE,
    ECODVENDEDOR INTEGER)
RETURNS (
    CODVENDEDOR INTEGER,
    VENDEDOR VARCHAR(60),
    CODSTATUS INTEGER,
    STATUS VARCHAR(60),
    CODPESSOA INTEGER,
    PESSOA VARCHAR(60),
    CODPEDVEND INTEGER,
    DTFATURADO DATE,
    CODGRUPO INTEGER,
    GRUPO VARCHAR(60),
    CODSUBGRUPO INTEGER,
    SUBGRUPO VARCHAR(60),
    CODPRODFILHO INTEGER,
    PRODFILHO VARCHAR(60),
    UNIDADE VARCHAR(15),
    QTDENTREGUE DOUBLE PRECISION,
    CAIXA DOUBLE PRECISION,
    PRECOPROD DOUBLE PRECISION,
    DESCONTO_VALOR DOUBLE PRECISION,
    PESOBRUTO DOUBLE PRECISION,
    PESOLIQUIDO DOUBLE PRECISION,
    PERDA DOUBLE PRECISION,
    USUARIO VARCHAR(45),
    ACRESCIMOVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    CODEMPRESA INTEGER,
    CIDADE VARCHAR(45),
    ARE_CODIGO INTEGER,
    AREA VARCHAR(30),
    CURVA VARCHAR(1),
    VALORIPI DOUBLE PRECISION,
    CODFABRICANTE INTEGER,
    CODSUPERVISOR INTEGER,
    CUBAGEM DOUBLE PRECISION,
    CMV DOUBLE PRECISION,
    CODTIPOATV INTEGER,
    TIPOATIVIDADE VARCHAR(60),
    TOTAL DOUBLE PRECISION,
    BAIRRO VARCHAR(45),
    MES VARCHAR(20),
    ANO INTEGER,
    CODCOR INTEGER,
    COR VARCHAR(60),
    FABRICANTE VARCHAR(60),
    QTDEMBALAGEM DOUBLE PRECISION,
    SEMANA VARCHAR(60),
    NUMSEMANA INTEGER,
    SUPERVISOR VARCHAR(60),
    SIGLA CHAR(2),
    EMPRESA VARCHAR(60))
AS
declare variable LTOTDESCPEDVEND double precision;
declare variable LTOTACRESPEDVEND double precision;
declare variable LVALOR_BRUTO double precision;
declare variable LCODPEDVEND integer;
declare variable LFRETE double precision;
declare variable LCODPRODUTO integer;
declare variable LCODUNIDADE integer;
declare variable LDTFATURADO date;
declare variable LDTSAIDA date;
declare variable LPERCACRESCIMO double precision;
declare variable LVALORACRESCIMO double precision;
declare variable LVALORDESCONTO double precision;
declare variable LPERCVALORDESCONTO double precision;
declare variable LEXIBIRAPENASONUMERODOPEDIDO smallint;
declare variable LCODFATURAMENTO integer;
declare variable LCODNFVENDA integer;
declare variable LSOMAFRETE varchar(1);
declare variable LNAOSOMARFRETENORELATORIO smallint;
declare variable LSOMARIPIAOTOTAL smallint;
declare variable LDTINI timestamp;
declare variable LDTFIM timestamp;
declare variable LDIASEMANA integer;
declare variable LSEMANA integer;
begin
  LDTINI = cast(EDTINI||' 00:00:00' as timestamp);
  LDTFIM = cast(EDTFIM||' 23:59:59' as timestamp);

  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0)
  into
    LEXIBIRAPENASONUMERODOPEDIDO;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('SOMAR IPI AO TOTAL',0)
  into
    LSOMARIPIAOTOTAL;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('NÃO SOMAR FRETE NO RELATORIO',0)
  into
    LNAOSOMARFRETENORELATORIO;

  select 
    SOMAFRETE
  from
    SYSPARAMS
  into
    LSOMAFRETE;

  for select
    P.CODVENDEDOR,
    P.CODPESSOA,
    P.CODPEDVEND,
    P.CODFATURAMENTO,
    P.CODNFVENDA,
    cast(P.DTFATURADO as date),
    cast(P.DT_SAIDA as date),
    P.US_CADAST USUARIO,
    P.CODEMPRESA,
    P.DESC_VALOR,
    P.DESCPERC_VALOR,
    P.ACRESVALOR,
    P.ACRESCIMO,
    P.VALOR_BRUTO,
    P.FRETE
  from
    PEDVEND P
  where
    P.STATUSPED = 'FATURADO' and
    P.TIPOPED in ('VENDA', 'CADERNO') and
    P.DTFATURADO between :LDTINI and :LDTFIM
    and P.CODVENDEDOR = :ECODVENDEDOR
  into
    :CODVENDEDOR,
    :CODPESSOA,
    :LCODPEDVEND,
    :LCODFATURAMENTO,
    :LCODNFVENDA,
    :LDTFATURADO,
    :LDTSAIDA,
    :USUARIO,
    :CODEMPRESA,
    :LVALORDESCONTO,
    :LPERCVALORDESCONTO,
    :LVALORACRESCIMO,
    :LPERCACRESCIMO,
    :LVALOR_BRUTO,
    :LFRETE
  do
  begin

    if (LEXIBIRAPENASONUMERODOPEDIDO = 0) then
      CODPEDVEND = coalesce(LCODFATURAMENTO, LCODNFVENDA, LCODPEDVEND);
    else
      CODPEDVEND = LCODPEDVEND;

    LFRETE = coalesce(LFRETE,0);
    DTFATURADO = coalesce(LDTFATURADO,LDTSAIDA);
    LVALOR_BRUTO = coalesce(nullif(LVALOR_BRUTO,0),1);
    LTOTACRESPEDVEND = coalesce(LVALORACRESCIMO,0) + (coalesce(LVALOR_BRUTO,0) * (coalesce(LPERCACRESCIMO,0)/100));
    LTOTDESCPEDVEND = coalesce(LVALORDESCONTO,0) + coalesce(LPERCVALORDESCONTO,0);

    select FU_RETORNOMEMES_INT.NOME from FU_RETORNOMEMES_INT(extract(month from :DTFATURADO)) into :MES;

    MES = upper(MES);

    ANO = extract(year from DTFATURADO);

    MES = '''' || MES || '''';

    select
       V.NOME VENDEDOR
    from
      VENDEDOR V
    where
      V.CODVENDEDOR = :CODVENDEDOR
    into 
      VENDEDOR;

    select
       u.SIGLA VENDEDOR
    from
      PESSOA p
      inner join TBL_ESTADO u
      on p.UF_1 = u.SIGLA
    where
      p.CODPESSOA = :CODPESSOA
    into 
      SIGLA;

    select 
      PE.CODSTATUS,
      PE.NOME,
      coalesce(PE.ARE_CODIGO,0),
      PE.CIDADE_1,
      coalesce(PE.CODTIPOATV,0),
      PE.BAIRRO_1
    from
      PESSOA PE
    where
      PE.CODPESSOA = :CODPESSOA
    into
      CODSTATUS,
      PESSOA,
      ARE_CODIGO,
      CIDADE,
      CODTIPOATV,
      BAIRRO;

    TIPOATIVIDADE = null;
    select 
      coalesce(DESCRICAO,'NÃO DEFINIDO')
    from
      TBL_RAMOATVTIPO
    where
      CODTIPO = :CODTIPOATV
    into
      TIPOATIVIDADE;

    TIPOATIVIDADE = coalesce(TIPOATIVIDADE,'NÃO DEFINIDO');

    select 
      DESCRICAO
    from
      STATUS ST
    where
       ST.CODSTATUS = :CODSTATUS
    into
      STATUS;

    AREA = null;
    select 
      coalesce(ARE_DESCRICAO,'NÃO DEFINIDO')
    from
      TBL_AREA TA
    where
      TA.ARE_CODIGO = :ARE_CODIGO
    into
      AREA;

    AREA = coalesce(AREA,'NÃO DEFINIDO');

    select
      E.EMPRESA
    from
      EMPRESA E
    where
      E.CODEMPRESA = :CODEMPRESA
    into
      EMPRESA;

    for select
      pi.CODPRODFILHO,
      PF.DESCRICAO PRODFILHO,
      pi.QTDENTREGUE,
      pi.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1) CAIXA,
      pi.PRECOPROD,
      ((:LTOTDESCPEDVEND * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO)) + coalesce(pi.DESCONTO_VALOR,0)) as DESCONTO_VALOR,
      PF.PESOBRUTO * pi.QTDENTREGUE PESOBRUTO,
      PF.PESOLIQUIDO * pi.QTDENTREGUE PESOLIQUIDO,
      pi.PERDA,
      ((:LTOTACRESPEDVEND * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO))) as ACRESCIMOVALOR,
      (:LFRETE * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO)) as FRETE,
      PF.CURVA,
      (coalesce(pi.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)) VALORIPI,
      (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(pi.QTDENTREGUE,0)) CUBAGEM,
      (coalesce(PF.CUSTOMEDIO,0) * coalesce(pi.QTDENTREGUE,0)) CMV,
      PF.CODPRODUTO,
      PF.CODUNIDADE,
      coalesce(PF.CODCOR,0),
      coalesce(PF.QTDEMBALAGEM,1)
    from
      PEDVENDITEM pi
      join PRODFILHO PF on pi.CODPRODFILHO = PF.CODPRODFILHO
    where
       pi.CODPEDVEND = :LCODPEDVEND
    into
      :CODPRODFILHO,
      :PRODFILHO,
      :QTDENTREGUE,
      :CAIXA,
      :PRECOPROD,
      :DESCONTO_VALOR,
      :PESOBRUTO,
      :PESOLIQUIDO,
      :PERDA,
      :ACRESCIMOVALOR,
      :FRETE,
      :CURVA,
      :VALORIPI,
      :CUBAGEM,
      :CMV,
      :LCODPRODUTO,
      :LCODUNIDADE,
      :CODCOR,
      :QTDEMBALAGEM
    do
    begin
      select 
        CODGRUPO, 
        CODSUBGRUPO,
        CODFABRICANTE
      from
        PRODUTO PR
      where
        PR.CODPRODUTO = :LCODPRODUTO
      into
        :CODGRUPO,
        :CODSUBGRUPO,
        :CODFABRICANTE;

      select 
        CODSUPERVISOR
      from
        PESSOA
      where
        CODPESSOA = :CODPESSOA
      into
        :CODSUPERVISOR;

      COR = null;

      select
        DESCRICAO
      from
        TBL_COR
      where
        CODCOR = :CODCOR
      into
        :COR;

      COR = coalesce(COR,'SEM COR');

      select 
        DESCRICAO
      from
        GRUPO
      where
        CODGRUPO = :CODGRUPO
      into
        GRUPO;


      select 
        DESCRICAO
      from
        SUBGRUPO
      where
        CODSUBGRUPO = :CODSUBGRUPO
      into
        SUBGRUPO;

      select 
        coalesce(:UNIDADE, U.SIGLA)
      from
        UNIDADE U
      where
        CODUNIDADE = :LCODUNIDADE
      into
        UNIDADE;


      if ((LSOMARIPIAOTOTAL <> 0) and (LNAOSOMARFRETENORELATORIO = 0) and (LSOMAFRETE = 'S')) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + FRETE + VALORIPI) - DESCONTO_VALOR));
      else if ((LNAOSOMARFRETENORELATORIO = 0) and (LSOMAFRETE = 'S')) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + FRETE)- DESCONTO_VALOR));
      else if (LSOMARIPIAOTOTAL <> 0) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + VALORIPI) - DESCONTO_VALOR));
      else
        TOTAL = (((PRECOPROD * QTDENTREGUE) + ACRESCIMOVALOR) - DESCONTO_VALOR);

    FABRICANTE = '';

    select
      PE.NOME
    from
      PESSOA PE
    where
      PE.CODPESSOA = :CODFABRICANTE
    into
      FABRICANTE;

    SUPERVISOR = '';

    select
      SU.NOME
    from
      SUPERVISOR SU
    where
      SU.CODSUPERVISOR = :CODSUPERVISOR
    into
      SUPERVISOR;

    -- { ALTERAÇÕES - BRUNO - 11/07/2012 } --
    -- CARREGA A SEMANA --
    select
    (extract(yearday from cast(:DTFATURADO as date)) - extract(weekday from cast(:DTFATURADO as date) -1)+7)/7 SEMANA
    from rdb$database into LSEMANA;
    -- CARREGA O PERÍODO DA SEMANA --
    select extract(weekday from :DTFATURADO) from rdb$database into LDIASEMANA;
    if (LDIASEMANA = 0) then
        LDIASEMANA = 7;

    SEMANA = 'De ' ||
             RIGHT('00' || cast((extract(day from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
             '/' ||
             RIGHT('00' || cast((extract(month from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
             '/' ||
             extract(year from (:DTFATURADO - (LDIASEMANA - 1))) ||
             ' à ' ||
             RIGHT('00' || cast((extract(day from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
             '/' ||
             RIGHT('00' || cast((extract(month from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
             '/' ||
             extract(year from (:DTFATURADO + (7 - LDIASEMANA)));

    NUMSEMANA = LSEMANA;
    -- { FIM ALTERAÇÕES - BRUNO - 11/07/2012 } --
    suspend;

    codcor = null;

    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE SPMAPAVENDAS2(
    EDTINI DATE,
    EDTFIM DATE)
RETURNS (
    CODVENDEDOR INTEGER,
    VENDEDOR VARCHAR(60),
    CODSTATUS INTEGER,
    STATUS VARCHAR(60),
    CODPESSOA INTEGER,
    PESSOA VARCHAR(60),
    CODPEDVEND INTEGER,
    DTFATURADO DATE,
    CODGRUPO INTEGER,
    GRUPO VARCHAR(60),
    CODSUBGRUPO INTEGER,
    SUBGRUPO VARCHAR(60),
    CODPRODFILHO INTEGER,
    PRODFILHO VARCHAR(60),
    UNIDADE VARCHAR(15),
    QTDENTREGUE DOUBLE PRECISION,
    CAIXA DOUBLE PRECISION,
    PRECOPROD DOUBLE PRECISION,
    DESCONTO_VALOR DOUBLE PRECISION,
    PESOBRUTO DOUBLE PRECISION,
    PESOLIQUIDO DOUBLE PRECISION,
    PERDA DOUBLE PRECISION,
    USUARIO VARCHAR(45),
    ACRESCIMOVALOR DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    CODEMPRESA INTEGER,
    CIDADE VARCHAR(45),
    ARE_CODIGO INTEGER,
    AREA VARCHAR(30),
    CURVA VARCHAR(1),
    VALORIPI DOUBLE PRECISION,
    CODFABRICANTE INTEGER,
    CODSUPERVISOR INTEGER,
    CUBAGEM DOUBLE PRECISION,
    CMV DOUBLE PRECISION,
    CODTIPOATV INTEGER,
    TIPOATIVIDADE VARCHAR(60),
    TOTAL DOUBLE PRECISION,
    BAIRRO VARCHAR(45),
    MES VARCHAR(20),
    ANO INTEGER,
    CODCOR INTEGER,
    COR VARCHAR(60),
    FABRICANTE VARCHAR(60),
    QTDEMBALAGEM DOUBLE PRECISION,
    SEMANA VARCHAR(60),
    NUMSEMANA INTEGER,
    SUPERVISOR VARCHAR(60),
    SIGLA CHAR(2),
    CODSTATUS_CHECKOUT INTEGER,
    STATUS_CHECKOUT VARCHAR(60),
    EMPRESA VARCHAR(60),
    CARACTER VARCHAR(60))
AS
declare variable LTOTDESCPEDVEND double precision;
declare variable LTOTACRESPEDVEND double precision;
declare variable LVALOR_BRUTO double precision;
declare variable LCODPEDVEND integer;
declare variable LFRETE double precision;
declare variable LCODPRODUTO integer;
declare variable LCODUNIDADE integer;
declare variable LDTFATURADO date;
declare variable LDTSAIDA date;
declare variable LPERCACRESCIMO double precision;
declare variable LVALORACRESCIMO double precision;
declare variable LVALORDESCONTO double precision;
declare variable LPERCVALORDESCONTO double precision;
declare variable LEXIBIRAPENASONUMERODOPEDIDO smallint;
declare variable LCODFATURAMENTO integer;
declare variable LCODNFVENDA integer;
declare variable LSOMAFRETE varchar(1);
declare variable LNAOSOMARFRETENORELATORIO smallint;
declare variable LSOMARIPIAOTOTAL smallint;
declare variable LDTINI timestamp;
declare variable LDTFIM timestamp;
declare variable LDIASEMANA integer;
declare variable LSEMANA integer;
begin
  LDTINI = cast(EDTINI||' 00:00:00' as timestamp);
  LDTFIM = cast(EDTFIM||' 23:59:59' as timestamp);

  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0)
  into
    LEXIBIRAPENASONUMERODOPEDIDO;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('SOMAR IPI AO TOTAL',0)
  into
    LSOMARIPIAOTOTAL;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('NÃfO SOMAR FRETE NO RELATORIO',0)
  into
    LNAOSOMARFRETENORELATORIO;

  select 
    SOMAFRETE
  from
    SYSPARAMS
  into
    LSOMAFRETE;

  for select
    P.CODVENDEDOR,
    P.CODPESSOA,
    P.CODPEDVEND,
    P.CODFATURAMENTO,
    P.CODNFVENDA,
    cast(P.DTFATURADO as date),
    cast(P.DT_SAIDA as date),
    P.US_CADAST USUARIO,
    P.CODEMPRESA,
    P.DESC_VALOR,
    P.DESCPERC_VALOR,
    P.ACRESVALOR,
    P.ACRESCIMO,
    P.VALOR_BRUTO,
    P.FRETE
  from
    PEDVEND P
  where
    P.STATUSPED = 'FATURADO' and
    P.TIPOPED in ('VENDA', 'CADERNO') and
    P.DT_SAIDA between :LDTINI and :LDTFIM
  into
    :CODVENDEDOR,
    :CODPESSOA,
    :LCODPEDVEND,
    :LCODFATURAMENTO,
    :LCODNFVENDA,
    :LDTFATURADO,
    :LDTSAIDA,
    :USUARIO,
    :CODEMPRESA,
    :LVALORDESCONTO,
    :LPERCVALORDESCONTO,
    :LVALORACRESCIMO,
    :LPERCACRESCIMO,
    :LVALOR_BRUTO,
    :LFRETE
  do
  begin

    if (LEXIBIRAPENASONUMERODOPEDIDO = 0) then
      CODPEDVEND = coalesce(LCODFATURAMENTO, LCODNFVENDA, LCODPEDVEND);
    else
      CODPEDVEND = LCODPEDVEND;

    LFRETE = coalesce(LFRETE,0);
    DTFATURADO = coalesce(LDTFATURADO,LDTSAIDA);
    LVALOR_BRUTO = coalesce(nullif(LVALOR_BRUTO,0),1);
    LTOTACRESPEDVEND = coalesce(LVALORACRESCIMO,0) + (coalesce(LVALOR_BRUTO,0) * (coalesce(LPERCACRESCIMO,0)/100));
    LTOTDESCPEDVEND = coalesce(LVALORDESCONTO,0) + coalesce(LPERCVALORDESCONTO,0);

    select FU_RETORNOMEMES_INT.NOME from FU_RETORNOMEMES_INT(extract(month from :DTFATURADO)) into :MES;

    MES = upper(MES);

    ANO = extract(year from DTFATURADO);

    MES = '''' || MES || '''';

    select
       V.NOME VENDEDOR
    from
      VENDEDOR V
    where
      V.CODVENDEDOR = :CODVENDEDOR
    into 
      VENDEDOR;

    select
       u.SIGLA VENDEDOR
    from
      PESSOA p
      inner join TBL_ESTADO u
      on p.UF_1 = u.SIGLA
    where
      p.CODPESSOA = :CODPESSOA
    into 
      SIGLA;

    select 
      PE.CODSTATUS,
      PE.NOME,
      coalesce(PE.ARE_CODIGO,0),
      PE.CIDADE_1,
      coalesce(PE.CODTIPOATV,0),
      PE.BAIRRO_1
    from
      PESSOA PE
    where
      PE.CODPESSOA = :CODPESSOA
    into
      CODSTATUS,
      PESSOA,
      ARE_CODIGO,
      CIDADE,
      CODTIPOATV,
      BAIRRO;

    TIPOATIVIDADE = null;
    select 
      coalesce(DESCRICAO,'NÃfO DEFINIDO')
    from
      TBL_RAMOATVTIPO
    where
      CODTIPO = :CODTIPOATV
    into
      TIPOATIVIDADE;

    TIPOATIVIDADE = coalesce(TIPOATIVIDADE,'NÃfO DEFINIDO');

    select 
      DESCRICAO
    from
      STATUS ST
    where
       ST.CODSTATUS = :CODSTATUS
    into
      STATUS;

    select 
      CODSTATUS,
      DESCRICAO
    from
      STATUS ST
    where
       ST.CODSTATUS = :CODSTATUS
    into
      CODSTATUS_CHECKOUT,
      STATUS_CHECKOUT;

    AREA = null;
    select 
      coalesce(ARE_DESCRICAO,'NÃfO DEFINIDO')
    from
      TBL_AREA TA
    where
      TA.ARE_CODIGO = :ARE_CODIGO
    into
      AREA;

    AREA = coalesce(AREA,'NÃfO DEFINIDO');

    select
      E.EMPRESA
    from
      EMPRESA E
    where
      E.CODEMPRESA = :CODEMPRESA
    into
      EMPRESA;

    for select
      pi.CODPRODFILHO,
      PF.DESCRICAO PRODFILHO,
      pi.QTDENTREGUE,
      pi.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1) CAIXA,
      pi.PRECOPROD,
      ((:LTOTDESCPEDVEND * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO)) + coalesce(pi.DESCONTO_VALOR,0)) as DESCONTO_VALOR,
      PF.PESOBRUTO * pi.QTDENTREGUE PESOBRUTO,
      PF.PESOLIQUIDO * pi.QTDENTREGUE PESOLIQUIDO,
      pi.PERDA,
      ((:LTOTACRESPEDVEND * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO))) as ACRESCIMOVALOR,
      (:LFRETE * (coalesce(pi.PRECOVEND,0) / :LVALOR_BRUTO)) as FRETE,
      PF.CURVA,
      (coalesce(pi.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)) VALORIPI,
      (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(pi.QTDENTREGUE,0)) CUBAGEM,
      (coalesce(PF.CUSTOMEDIO,0) * coalesce(pi.QTDENTREGUE,0)) CMV,
      PF.CODPRODUTO,
      PF.CODUNIDADE,
      coalesce(PF.CODCOR,0),
      coalesce(PF.QTDEMBALAGEM,1)
    from
      PEDVENDITEM pi
      join PRODFILHO PF on pi.CODPRODFILHO = PF.CODPRODFILHO
    where
       pi.CODPEDVEND = :LCODPEDVEND
    into
      :CODPRODFILHO,
      :PRODFILHO,
      :QTDENTREGUE,
      :CAIXA,
      :PRECOPROD,
      :DESCONTO_VALOR,
      :PESOBRUTO,
      :PESOLIQUIDO,
      :PERDA,
      :ACRESCIMOVALOR,
      :FRETE,
      :CURVA,
      :VALORIPI,
      :CUBAGEM,
      :CMV,
      :LCODPRODUTO,
      :LCODUNIDADE,
      :CODCOR,
      :QTDEMBALAGEM
    do
    begin
      select 
        CODGRUPO, 
        CODSUBGRUPO,
        CODFABRICANTE
      from
        PRODUTO PR
      where
        PR.CODPRODUTO = :LCODPRODUTO
      into
        :CODGRUPO,
        :CODSUBGRUPO,
        :CODFABRICANTE;

      select 
        CODSUPERVISOR
      from
        PESSOA
      where
        CODPESSOA = :CODPESSOA
      into
        :CODSUPERVISOR;

      COR = null;

      select
        DESCRICAO
      from
        TBL_COR
      where
        CODCOR = :CODCOR
      into
        :COR;

      COR = coalesce(COR,'SEM COR');

      select 
        DESCRICAO
      from
        GRUPO
      where
        CODGRUPO = :CODGRUPO
      into
        GRUPO;


      select 
        DESCRICAO
      from
        SUBGRUPO
      where
        CODSUBGRUPO = :CODSUBGRUPO
      into
        SUBGRUPO;

      select 
        coalesce(:UNIDADE, U.SIGLA)
      from
        UNIDADE U
      where
        CODUNIDADE = :LCODUNIDADE
      into
        UNIDADE;
         CARACTER = null;
        SELECT
          CARACTER.DESCRICAO DESC_CARACTER
        from
         PRODCARACTER JOIN CARACTER ON
        PRODCARACTER.CODCARACTER = CARACTER.CODCARACTER
        where
          CODPRODUTO = :LCODPRODUTO
         into
         :CARACTER;

      if ((LSOMARIPIAOTOTAL <> 0) and (LNAOSOMARFRETENORELATORIO = 0) and (LSOMAFRETE = 'S')) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + FRETE + VALORIPI) - DESCONTO_VALOR));
      else if ((LNAOSOMARFRETENORELATORIO = 0) and (LSOMAFRETE = 'S')) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + FRETE)- DESCONTO_VALOR));
      else if (LSOMARIPIAOTOTAL <> 0) then
        TOTAL = ((PRECOPROD * QTDENTREGUE) + ((ACRESCIMOVALOR + VALORIPI) - DESCONTO_VALOR));
      else
        TOTAL = (((PRECOPROD * QTDENTREGUE) + ACRESCIMOVALOR) - DESCONTO_VALOR);

    FABRICANTE = '';

    select
      PE.NOME
    from
      PESSOA PE
    where
      PE.CODPESSOA = :CODFABRICANTE
    into
      FABRICANTE;

    SUPERVISOR = '';

    select
      SU.NOME
    from
      SUPERVISOR SU
    where
      SU.CODSUPERVISOR = :CODSUPERVISOR
    into
      SUPERVISOR;

    /* { ALTERAÃfâ?¡Ãfâ?¢ES - BRUNO - 11/07/2012 } -- */
    /* CARREGA A SEMANA -- */
    select
    (extract(yearday from cast(:DTFATURADO as date)) - extract(weekday from cast(:DTFATURADO as date) -1)+7)/7 SEMANA
    from rdb$database into LSEMANA;
    /* CARREGA O PERÃfÂODO DA SEMANA -- */
    select extract(weekday from :DTFATURADO) from rdb$database into LDIASEMANA;
    if (LDIASEMANA = 0) then
        LDIASEMANA = 7;

    SEMANA = 'De ' ||
             RIGHT('00' || cast((extract(day from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
             '/' ||
             RIGHT('00' || cast((extract(month from (:DTFATURADO - (LDIASEMANA - 1)))) as varchar(2)), 2) ||
             '/' ||
             extract(year from (:DTFATURADO - (LDIASEMANA - 1))) ||
             ' ÃfÂ  ' ||
             RIGHT('00' || cast((extract(day from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
             '/' ||
             RIGHT('00' || cast((extract(month from (:DTFATURADO + (7 - LDIASEMANA)))) as varchar(2)), 2) ||
             '/' ||
             extract(year from (:DTFATURADO + (7 - LDIASEMANA)));

    NUMSEMANA = LSEMANA;
    /* { FIM ALTERAÃfâ?¡Ãfâ?¢ES - BRUNO - 11/07/2012 } -- */
    suspend;

    codcor = null;

    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE STP_GERAFIANCEIRO_CHEQUE(
    ECODCHEQUE INTEGER)
AS
declare variable LVLTOTAL double precision;
declare variable LVLPARCELAPRIMEIRA numeric(15,2);
declare variable LVLPARCELAOUTRAS numeric(15,2);
declare variable LCODPESSOA integer;
declare variable LDT_VENCIM date;
declare variable LQTDPARCELA integer;
declare variable LVLPARCELA double precision;
declare variable LPARCELA varchar(5);
declare variable LUS_CADAST varchar(45);
declare variable LDIAS integer;
declare variable LCODCENTCUSTO integer;
declare variable LVALOR smallint;
declare variable LCODCONTA integer;
declare variable LCODCONDPAGCPR integer;
declare variable SVALOR integer;
declare variable LPREV_TIPOPAG varchar(45);
declare variable EQTDPARCELA integer;
declare variable EDIASPRIMEIRA integer;
declare variable EDIASOUTROS integer;
declare variable EDATAFINANCEIRO date;
declare variable LNRDOCUMENTO varchar(30);
begin

  delete FROM
  CONTA C
  WHERE
  C.CODCHAVULSO =:ECODCHEQUE;

  SELECT CODCCUSTCOMPRA FROM SYSPARAMS INTO LCODCENTCUSTO;


    select
      C.VALOR,
      C.CODPESSOA,
      current_timestamp,
      C.NRCHEQUE
    from
      CHEQUE_AVULSO C
    where
      C.CODCHEQUE =:ECODCHEQUE
    into
      LVLTOTAL,
      LCODPESSOA,
      EDATAFINANCEIRO,
      LNRDOCUMENTO;


      SELECT first 1
      C.NRPRESTACAO,
      C.NRDIASPRIMEIRA,
      C.NRDIAS,
      C.DESCRICAO
      FROM
      CONDPAGCPR C
      WHERE
     C.CODCONDPAGCPR = 13
      INTO
      EQTDPARCELA,
      EDIASPRIMEIRA,
      EDIASOUTROS,
      LPREV_TIPOPAG;

      
    LVLPARCELAOUTRAS   = LVLTOTAL / EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLTOTAL - LVLPARCELAOUTRAS * EQTDPARCELA;
    LVLPARCELAPRIMEIRA = LVLPARCELAPRIMEIRA + LVLPARCELAOUTRAS;
  
    while (coalesce(LQTDPARCELA, 1) <= EQTDPARCELA) do
    begin
      if (coalesce(LQTDPARCELA, 1) = 1) then
      begin
        LVLPARCELA = LVLPARCELAPRIMEIRA;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA;
      end
      else
      begin
        LVLPARCELA = LVLPARCELAOUTRAS;
        LDT_VENCIM = EDATAFINANCEIRO + EDIASPRIMEIRA + (EDIASOUTROS * (LQTDPARCELA - 1));
      end
      LPARCELA = RIGHT('0' || coalesce(LQTDPARCELA, 1), 2) || '/' || RIGHT('0' || EQTDPARCELA, 2);
      
      LDIAS = LDT_VENCIM - cast('TODAY' as date);
  
      LCODCONTA = gen_id(GEN_CONTA, 1);

      insert into
        CONTA (
          CODCONTA,
          STATUS, 
          TIPO,
          DESCRICAO, 
          NRDOCUMENTO, 
          CODPESSOA, 
          DT_EMISSAO, 
          DT_VENCIM, 
          PARCELA, 
          PREV_TIPOPAG, 
          VLPARCELA,
          VLTOTAL, 
          DT_CADAST, 
          CODCHAVULSO,
          DIAS,
          CODCENTCUSTO)
      values (
        :LCODCONTA,
        'ABERTO',
        'PAGAR',
        'CHEQUE AVULSO',
        :LNRDOCUMENTO,
        :LCODPESSOA,
        'TODAY',
        :LDT_VENCIM,
        :LPARCELA,
        :LPREV_TIPOPAG,
        :LVLPARCELA,
        :LVLTOTAL,
        'NOW',
        :ECODCHEQUE,
        :LDIAS,
        :LCODCENTCUSTO);
  
      if (nullif(LCODCENTCUSTO, 0) is not null) then
      begin
        insert into
          CONTA_CENTCUSTO (
            CODCENTCUSTO,
            CODCONTA,
            VALOR)
        values (
          :LCODCENTCUSTO,
          :LCODCONTA,
          :LVLPARCELA);
      end
      LQTDPARCELA = coalesce(LQTDPARCELA, 1) + 1;
    end

end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE STP_GERAFINANCEIRO_ORCMAR_COMP(
    ECODORCMARMORE INTEGER,
    EUSUARIO VARCHAR(45),
    ECODTIPOPAG INTEGER)
AS
declare variable LDT_SAIDA date;
declare variable LDT_ULTIMOVENC date;
declare variable LCONT integer;
declare variable LDT_VENCIM date;
declare variable LVLPARCELA double precision;
declare variable LCODTIPOPAG integer;
declare variable LTIPOPAG varchar(20);
declare variable LNRPRESTACAO integer;
declare variable LNRDIASPRIMEIRA integer;
declare variable LNRDIAS integer;
declare variable LVLRESTA double precision;
declare variable LCODCONTA integer;
declare variable LSTATUS varchar(10);
declare variable LPARCELA varchar(5);
declare variable LNRDOCUMENTO varchar(30);
declare variable QDIVIDPACE integer;
declare variable LCODPESSOA integer;
declare variable LCODVENDEDOR integer;
declare variable LCODEMPRESA integer;
declare variable LCODCENTCUSTO integer;
declare variable LCODTIPOPAGPADRAO integer;
declare variable LTOTAL_VENDA double precision;
declare variable LTOTAL_FINANCEIRO double precision;
declare variable LDIFERENCA double precision;
declare variable LDESCRICAO varchar(60);
begin
  select
    CODPESSOA,
    CODVENDEDOR,
    CODEMPRESA,
    DATA_SAIDA,
    VALOR_TOTAL_LIQ,
    NRCONTRATO
  from
    ORC_MARMORE
  where
    CODORC_MARMORE = :ECODORCMARMORE
  into
    LCODPESSOA,
    LCODVENDEDOR,
    LCODEMPRESA,
    LDT_SAIDA,
    LTOTAL_VENDA,
    LNRDOCUMENTO;

  select
    max(CONTA.DT_VENCIM),
    sum(CONTA.VLPARCELA)
  from
    CONTA
  where
    CODORCMARMORE = :ECODORCMARMORE
  into
    LDT_ULTIMOVENC,
    LTOTAL_FINANCEIRO;

  LDIFERENCA = LTOTAL_VENDA - LTOTAL_FINANCEIRO;

  if (LDIFERENCA > 0) then
  begin

    if (:ECODTIPOPAG is null) then
    begin
      select
        VALOR
      from
        MLERPARAMETROINTEIRO('CODIGO DO TIPO DE PAGAMENTO COMPLEMENTO', null)
      into
        LCODTIPOPAGPADRAO;
    
      if (LCODTIPOPAGPADRAO is null) then
        exception EXCECAO('parâmetro dinâ¢mico "CODIGO DO TIPO DE PAGAMENTO COMPLEMENTO" não configurado para executar essa operação!');
    end
    else
      LCODTIPOPAGPADRAO = :ECODTIPOPAG;

    select
      TIPOPAG.CODTIPOPAG,
      TIPOPAG.TIP_TIPO,
      TIPOPAG.NRPRESTACAO,
      TIPOPAG.NRDIASPRIMEIRA,
      TIPOPAG.NRDIAS,
      nullif(TIPOPAG.CODCENTCUSTO,0)
    from
      TIPOPAG
    where
      CODTIPOPAG = :LCODTIPOPAGPADRAO
    into
      LCODTIPOPAG,
      LTIPOPAG,
      LNRPRESTACAO,
      LNRDIASPRIMEIRA,
      LNRDIAS,
      LCODCENTCUSTO;

    if (LCODCENTCUSTO is null) then
      exception EXCECAO('Centro de custo não configurado para a forma de pagamento de código '||LCODCENTCUSTO||' ! ');

    insert into ORCPRAZOS_MARMORE(
      CODORC_MARMORE,
      CODTIPOPAG,
      TIPOPAG,
      VALOR)
    values(
      :ECODORCMARMORE,
      :LCODTIPOPAG,
      :LTIPOPAG,
      :LDIFERENCA);

    LVLRESTA = LDIFERENCA;
    LCONT = 1;
    while (LCONT <= LNRPRESTACAO) do
    begin
      QDIVIDPACE = 1 + (LNRPRESTACAO - LCONT);
      LVLPARCELA =  cast((LVLRESTA / QDIVIDPACE) as numeric(18,2));

      LCODCONTA    = gen_id(GEN_CONTA, 1);
      LSTATUS      = 'ABERTO';
  
      LPARCELA     = RIGHT('00'||LCONT,2)||'/'||RIGHT('00'||LNRPRESTACAO,2);
      LDESCRICAO   = 'FECHAMENTO DE CONTRATO - COMPLEMENTO';

      if (LCONT = 1) then
        LDT_VENCIM = LDT_ULTIMOVENC + LNRDIASPRIMEIRA;
      else
        LDT_VENCIM = LDT_VENCIM + LNRDIAS;

      insert into CONTA(
        CODCONTA,
        STATUS,
        TIPO,
        DESCRICAO,
        NRDOCUMENTO,
        CODPESSOA,
        DT_EMISSAO,
        DT_VENCIM,
        DIAS,
        PARCELA,
        PREV_TIPOPAG,
        VLPARCELA,
        VLTOTAL,
        CODCENTCUSTO,
        US_CADAST,
        DT_CADAST,
        TOTDESCONTO,
        TOTJUROS,
        TOTPAGO,
        CODORCMARMORE,
        CODNFVENDA,
        CODCARTAO,
        CODVENDEDOR,
        VLRNEGOCIA,
        COMISTIPOPAG,
        PERCJUROS,
        CART_PERC,
        CART_VALOR,
        CODBANCO,
        SERIENF,
        DESC_FINANCEIRO,
        CODCONTABANCO,
        CODEMPRESA,
        COMISCARTAO,
        NRBANCO,
        CODTIPOPAG)
      values(
        :LCODCONTA,
        :LSTATUS,
        'RECEBER',
        :LDESCRICAO,
        :LNRDOCUMENTO,
        :LCODPESSOA,
        :LDT_SAIDA,
        :LDT_VENCIM,
        (:LDT_VENCIM - :LDT_SAIDA),
        :LPARCELA,
        :LTIPOPAG,
        :LVLPARCELA,
        :LTOTAL_VENDA,
        :LCODCENTCUSTO,
        :EUSUARIO,
        current_timestamp,
        0,
        0,
        0,
        :ECODORCMARMORE,
        null,
        null,
        :LCODVENDEDOR,
        0,
        0,
        0,
        0,
        0,
        null,
        null,
        0,
        null,
        :LCODEMPRESA,
        null,
        null,
        :LCODTIPOPAG);
  
      if (LCODCENTCUSTO > 0) then
      begin
        insert into CONTA_CENTCUSTO(
          CODCENTCUSTO,
          CODCONTA,
          VALOR,
          CODEMPRESA)
        values(
          :LCODCENTCUSTO,
          :LCODCONTA,
          :LVLPARCELA,
          :LCODEMPRESA);
      end

      LVLRESTA = LVLRESTA - LVLPARCELA;
      LCONT    = LCONT + 1;
    end
  end
  else if (LDIFERENCA < 0) then
  begin
    LDIFERENCA = LDIFERENCA * -1;
    insert into PESSOA_SALDO (
      CODPESSOA,
      DATA,
      STATUS,
      VALOR,
      VALORUSADO,
      US_CADAST,
      DT_CADAST,
      OBSERVACAO)
    values (
      :LCODPESSOA,
      current_date,
      'ABERTO',
      :LDIFERENCA,
      0,
      :EUSUARIO,
      current_timestamp,
      'CREDITO GERADO PELA CONFERENCIA DE MEDIDAS');

    insert into MOVSALDO(
      MOVSALDO.CODPESSOA,
      MOVSALDO.VALOR,
      MOVSALDO.CODMOVIMENTACAO,
      MOVSALDO.CAMPOREFERENCIADO,
      MOVSALDO.LOCALORIGEM,
      MOVSALDO.TIPOMOV,
      MOVSALDO.DATAMOVIMENTACAO,
      MOVSALDO.OBSERVACAO)
    values(
      :LCODPESSOA,
      :LDIFERENCA,
      :ECODORCMARMORE,
      'CODORC_MARMORE',
      'ORC_MARMORE',
      'E',
      current_timestamp,
      'CREDITO GERADO PELA CONFERENCIA DE MEDIDAS');
  end
  when any do
  begin
    exception;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE STP_GERAFINANCEIRO_ORCMARMORE(
    ECODORCMARMORE INTEGER,
    ECODEMPRESA INTEGER,
    ECODVENDEDOR INTEGER,
    ECODPESSOA INTEGER,
    EVALORTOTAL DOUBLE PRECISION,
    EDATAEMISSAO DATE,
    EUSUARIO VARCHAR(45),
    ECODORCMARMOREORIGEM INTEGER)
AS
declare variable LCONT integer;
declare variable LDT_VENCIM date;
declare variable LVLPARCELA double precision;
declare variable LCODTIPOPAG integer;
declare variable LTIPOPAG varchar(20);
declare variable LNRPRESTACAO integer;
declare variable LNRDIASPRIMEIRA integer;
declare variable LNRDIAS integer;
declare variable LCODCARTAOCRED integer;
declare variable LCODBANCO integer;
declare variable LNRBANCO integer;
declare variable LVLPAGAMENTO double precision;
declare variable LVLRESTA double precision;
declare variable LCOMISPAGA double precision;
declare variable LCODCONTA integer;
declare variable LSTATUS varchar(10);
declare variable LPARCELA varchar(5);
declare variable LNRDOCUMENTO varchar(30);
declare variable QDIVIDPACE integer;
declare variable LBANCOPADRAO integer;
declare variable LCALCCARTAO varchar(3);
declare variable LCODCENTCUSTO integer;
declare variable LCODAMBIENTE integer;
declare variable LCOMISCARTAO double precision;
declare variable LDESCRICAO varchar(60);
declare variable LAMBIENTE varchar(100);
begin
  select
    VALOR
  from
    MLERPARAMETROINTEIRO('BANCO PADRÃO', null)
  into
    LBANCOPADRAO;

  LNRBANCO = null;
  if (LBANCOPADRAO is null) then
  begin
    select
      VALOR
    from
      MLERPARAMETROINTEIRO('BANCO PADRÃOII', null)
    into
      LBANCOPADRAO;
  end

  select
    CALCCARTAO
  from
    SYSPARAMS
  into
    :LCALCCARTAO;

  LCONT = 1;
  for select
    TIPOPAG.CODTIPOPAG,
    P.TIPOPAG,
    TIPOPAG.NRPRESTACAO,
    TIPOPAG.NRDIASPRIMEIRA,
    TIPOPAG.NRDIAS,
    P.VALOR,
    coalesce(P.CODBANCO_FK,:LBANCOPADRAO),
    P.CODCARTAOCRED_FK,
    TIPOPAG.CODCENTCUSTO,
    ORC_MARMORE.NRCONTRATO,
    ORC_MARMORE.CODAMBIENTE,
    ambiente.DESCRICAO
  from
    ORC_MARMORE
    JOIN ORCPRAZOS_MARMORE P ON
      ORC_MARMORE.CODORC_MARMORE = P.CODORC_MARMORE
    join TIPOPAG on
      P.CODTIPOPAG = TIPOPAG.CODTIPOPAG
    left join ambiente on
      ORC_MARMORE.CODAMBIENTE = ambiente.CODAMBIENTE

  where
    P.CODORC_MARMORE = :ECODORCMARMORE
  order by
    1
  into
    LCODTIPOPAG,
    LTIPOPAG,
    LNRPRESTACAO,
    LNRDIASPRIMEIRA,
    LNRDIAS,
    LVLPAGAMENTO,
    LCODBANCO,
    LCODCARTAOCRED,
    LCODCENTCUSTO,
    LNRDOCUMENTO,
    LCODAMBIENTE,
    LAMBIENTE
  do
  begin
    select
      coalesce(COMISPAGA, 0) as COMISPAGA
    from
      CARTAOCRED
    where
      CODCARTAOCRED = :LCODCARTAOCRED
    into
      LCOMISPAGA;

    select
      cast(NRBANCO as integer)
    from
      BANCO
    where
      CODBANCO = :LCODBANCO
    into
      LNRBANCO;

    LVLRESTA = LVLPAGAMENTO;
    LCONT = 1;
    while (LCONT <= LNRPRESTACAO) do
    begin
      QDIVIDPACE = 1 + (LNRPRESTACAO - LCONT);
      LVLPARCELA =  cast((LVLRESTA / QDIVIDPACE) as numeric(18,2));

      LCODCONTA    = gen_id(GEN_CONTA, 1);
      LSTATUS      = 'ABERTO';

      LCOMISCARTAO = 0;
      if (LCALCCARTAO = 'SIM') then
      begin
        LCOMISCARTAO = LVLPARCELA * (coalesce(LCOMISPAGA,0) / 100);
        LVLPARCELA   = LVLPARCELA - coalesce(LCOMISCARTAO,0);
      end
      LPARCELA     = RIGHT('00'||LCONT,2)||'/'||RIGHT('00'||LNRPRESTACAO,2);  
      if (coalesce(LCODAMBIENTE,0) > 0) then
        LDESCRICAO   = 'AJUSTE DE CONTRATO RELATIVO AO AMB. '||LAMBIENTE;
      else
        LDESCRICAO   = 'FECHAMENTO DE CONTRATO';

      if (LCONT = 1) then
        LDT_VENCIM = EDATAEMISSAO + LNRDIASPRIMEIRA;
      else
        LDT_VENCIM = LDT_VENCIM + LNRDIAS;

      insert into CONTA(
        CODCONTA,
        STATUS,
        TIPO,
        DESCRICAO,
        NRDOCUMENTO,
        CODPESSOA,
        DT_EMISSAO,
        DT_VENCIM,
        DIAS,
        PARCELA,
        PREV_TIPOPAG,
        VLPARCELA,
        VLTOTAL,
        CODCENTCUSTO,
        US_CADAST,
        DT_CADAST,
        TOTDESCONTO,
        TOTJUROS,
        TOTPAGO,
        CODORCMARMORE,
        CODNFVENDA,
        CODCARTAO,
        CODVENDEDOR,
        VLRNEGOCIA,
        COMISTIPOPAG,
        PERCJUROS,
        CART_PERC,
        CART_VALOR,
        CODBANCO,
        SERIENF,
        DESC_FINANCEIRO,
        CODCONTABANCO,
        CODEMPRESA,
        COMISCARTAO,
        NRBANCO,
        CODTIPOPAG,
        CODAMBIENTE)
      values(
        :LCODCONTA,
        :LSTATUS,
        'RECEBER',
        :LDESCRICAO,
        :LNRDOCUMENTO,
        :ECODPESSOA,
        :EDATAEMISSAO,
        :LDT_VENCIM,
        (:LDT_VENCIM - :EDATAEMISSAO),
        :LPARCELA,
        :LTIPOPAG,
        :LVLPARCELA,
        :EVALORTOTAL,
        :LCODCENTCUSTO,
        :EUSUARIO,
        current_timestamp,
        0,
        0,
        0,
        coalesce(nullif(:ECODORCMARMOREORIGEM,0), :ECODORCMARMORE),
        null,
        :LCODCARTAOCRED,
        :ECODVENDEDOR,
        0,
        0,
        0,
        0,
        0,
        :LCODBANCO,
        null,
        0,
        null,
        :ECODEMPRESA,
        :LCOMISCARTAO,
        :LNRBANCO,
        :LCODTIPOPAG,
        nullif(:LCODAMBIENTE,0));
  
      if (LCODCENTCUSTO > 0) then
      begin
        insert into CONTA_CENTCUSTO(
          CODCENTCUSTO,
          CODCONTA,
          VALOR,
          CODEMPRESA)
        values(
          :LCODCENTCUSTO,
          :LCODCONTA,
          :LVLPARCELA,
          :ECODEMPRESA);
      end

      LVLRESTA = LVLRESTA - LVLPARCELA;
      LCONT    = LCONT + 1;
    end
  end
  when any do
  begin
    exception;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE STP_GERAFINANCEIRO_PEDIDO(
    ECODPEDVEND INTEGER,
    ECODEMPRESA INTEGER,
    ECODVENDEDOR INTEGER,
    ECODPESSOA INTEGER,
    ECODTIPOPAG INTEGER,
    ETIPOPAG VARCHAR(20),
    ECODCARTAOCRED INTEGER,
    EVALORTOTAL DOUBLE PRECISION,
    EDATAEMISSAO DATE,
    EUSUARIO VARCHAR(45))
AS
declare variable LTIP_BAIXAAUTOMATICA integer;
declare variable LDT_VENCIM date;
declare variable LPARCELA varchar(5);
declare variable LVLPARCELA double precision;
declare variable LTOTPAGO double precision;
declare variable LNRDIASPRIMEIRA integer;
declare variable LNRDIAS integer;
declare variable LACRESCIMO double precision;
declare variable LTAXA double precision;
declare variable LCOMISSVEND double precision;
declare variable LCONT smallint;
declare variable LCODCONTA integer;
declare variable LSTATUS varchar(10);
declare variable PAR_GERAR_VENCIMENTOS_PARCELAS smallint;
declare variable PAR_GERAR_MOVCONTABANC_FORMA smallint;
declare variable LNRDOCUMENTO varchar(30);
declare variable ENRDOCUMENTO varchar(30);
declare variable LDESCFINANC varchar(60);
declare variable LCODCENTCUSTO integer;
declare variable LVLRESTA double precision;
declare variable PAR_ALIMENTAR_LETRA_PARCELA smallint;
declare variable LPARC integer;
declare variable LLETRA char(1);
declare variable PAR_PREFIXO_PARA_GERAR_DOC smallint;
declare variable LCODCENTCUSTOTIPOPAG smallint;
declare variable QDIVIDPACE integer;
declare variable LCOMISCARTAO double precision;
declare variable LNRPRESTACAO integer;
declare variable LCODCENTCUSTOCARTAO integer;
declare variable LCODCENTCUSTOTAXA integer;
declare variable LCODCARTAOCRED integer;
declare variable LCODCONTABANCOTIPOPAG integer;
declare variable LCODCONTABX integer;
declare variable LCOMISCARTAOPARC double precision;
declare variable LVLRESTACOMISSCARTAO double precision;
begin
  select VALOR from MLERPARAMETROLOGICO('UTILIZAR PREFIXO PARA GERAR DOCUMENTO', 0) into PAR_PREFIXO_PARA_GERAR_DOC;
  select VALOR from MLERPARAMETROLOGICO('GERAR NÚMEROS DOS VENCIMENTOS COM AS PARCELAS', 0) into PAR_GERAR_VENCIMENTOS_PARCELAS;
  select VALOR from MLERPARAMETROLOGICO('ALIMENTAR COM LETRAS AS PARCELAS POR FORA', 0) into PAR_ALIMENTAR_LETRA_PARCELA;
  select VALOR from MLERPARAMETROLOGICO('GERAR MOV.CONTA BANCÁRIA PELA FORMA DE PAGTO', 0) into PAR_GERAR_MOVCONTABANC_FORMA;
  select first 1 coalesce(CODCENTCUSTO,0) from SYSPARAMS into :LCODCENTCUSTO;

  ENRDOCUMENTO = ECODPEDVEND;

  if (not exists(select 1 from TIPOPAG where CODTIPOPAG = :ECODTIPOPAG)) then
    exception EXCECAO('FORMA DE PAGAMENTO NÃO EXISTE NA TABELA DE TIPOPAG');

  /* LOCALIZO OS DADOS DO TIPO DE PAGAMENTO */
  select
    coalesce(NRPRESTACAO, 0) as NRPRESTACAO,
    coalesce(NRDIASPRIMEIRA, 0) as NRDIASPRIMEIRA,
    coalesce(NRDIAS, 0) as NRDIAS,
    coalesce(ACRESCIMO, 0) as ACRESCIMO,
    coalesce(TAXA, 0) as TAXA,
    coalesce(COMISSVEND, 0) as COMISSVEND,
    coalesce(TIP_BAIXAAUTOMATICA,-1),
    CODCENTCUSTO,
    CODCONTABANCO,
    coalesce(CODCARTAOCRED, :ECODCARTAOCRED)
  from
    TIPOPAG
  where
    CODTIPOPAG = :ECODTIPOPAG
  into
    :LNRPRESTACAO,
    :LNRDIASPRIMEIRA,
    :LNRDIAS,
    :LACRESCIMO,
    :LTAXA,
    :LCOMISSVEND,
    :LTIP_BAIXAAUTOMATICA,
    :LCODCENTCUSTOTIPOPAG,
    :LCODCONTABANCOTIPOPAG,
    :LCODCARTAOCRED;


  if (LCODCARTAOCRED > 0) then
  begin
    select coalesce(CODCENTCUSTO,0), coalesce(CODCENTCUSTOTAXA,0)
    from CARTAOCRED
    where CODCARTAOCRED = :LCODCARTAOCRED
    into LCODCENTCUSTOCARTAO, LCODCENTCUSTOTAXA;
  end

  LCODCENTCUSTO = coalesce(nullif(LCODCENTCUSTOCARTAO,0), nullif(LCODCENTCUSTOTIPOPAG,0), LCODCENTCUSTO);

  if (LCODCENTCUSTO = 0) then
    exception EXCECAO('CENTRO DE CUSTO NÃO CONFIGURADO PARA O CARTÃO DE CREDITO, TIPO DE PAGAMENTO OU PARÂMETRO');

  if (LNRPRESTACAO = 0) then
    exception EXCECAO('NÚMERO DE PRESTAÇÕES NÃO INFORMADO PARA O TIPO DE PAGAMENTO '||ECODTIPOPAG);

  if (LTIP_BAIXAAUTOMATICA = -1) then
    exception EXCECAO('TIPO DE PAGAMENTO CODIGO '||:ECODTIPOPAG||' SEM CONFIGURAÇÃO DE BAIXA AUTOMATICA DE PARCELA');

  LCOMISCARTAO = 0;

  if (LNRPRESTACAO > 0) then
  begin
    /* CASO O TIPO DO PAGAMENTO DO PEDIDO SEJA POR CARTAO PEGO O PERCENTUAL DA TABELA DE CARTOES */
    LCONT = 1;
    LPARC = 0;

    LVLRESTA = coalesce(EVALORTOTAL,0) - LCOMISCARTAO;
    LVLRESTACOMISSCARTAO = LCOMISCARTAO;
    while (LCONT <= LNRPRESTACAO) do
    begin
      LCODCONTA = gen_id(GEN_CONTA, 1);
      LSTATUS    = 'ABERTO';
      QDIVIDPACE = 1 + (LNRPRESTACAO - LCONT);
      LVLPARCELA =  cast((LVLRESTA / QDIVIDPACE) as numeric(18,2));
      LVLRESTA = LVLRESTA - LVLPARCELA;
      --CALCULANDO A COMISSÃO DO CARTÃO POR PARCELA
      LCOMISCARTAOPARC =  cast((LVLRESTACOMISSCARTAO / QDIVIDPACE) as numeric(18,2));
      LVLRESTACOMISSCARTAO = LVLRESTACOMISSCARTAO - LCOMISCARTAOPARC;


      /* GERANDO O VALOR DAS PARCELAS */
      LPARC = LPARC + 1;
      if (LPARC > 23) then
        LPARC = 1;

      select
        LETRA
      from
        MRETORNALETRA(:LPARC)
      into
        :LLETRA;

      /* GERANDO OS VENCIMENTOS */
      LTOTPAGO = 0;
      if (LCONT = 1) then
        LDT_VENCIM   = EDATAEMISSAO + LNRDIASPRIMEIRA;
      else
        LDT_VENCIM = EDATAEMISSAO + LNRDIASPRIMEIRA + (LNRDIAS * (LCONT - 1));
  
      /* GERANDO AS PARCELAS */
      LPARCELA = RIGHT('00'||LCONT,2) || '/' || cast(LNRPRESTACAO as varchar(2));
      if (PAR_PREFIXO_PARA_GERAR_DOC <> 0) then
      begin
        if (PAR_ALIMENTAR_LETRA_PARCELA = 0) then
          LNRDOCUMENTO =  ENRDOCUMENTO || '-' || LCONT || '/' || LNRPRESTACAO;
         else
          LNRDOCUMENTO =  ENRDOCUMENTO || '-' || LCONT || '/' || LNRPRESTACAO||LLETRA;
      end
      else if (PAR_GERAR_VENCIMENTOS_PARCELAS <> 0) then
      begin
        if (PAR_ALIMENTAR_LETRA_PARCELA = 0) then
          LNRDOCUMENTO = ENRDOCUMENTO || '-' || LCONT || '/' || LNRPRESTACAO;
        else
          LNRDOCUMENTO = ENRDOCUMENTO || '-' || LCONT || '/' || LNRPRESTACAO||LLETRA;
      end
      else
        LNRDOCUMENTO = ENRDOCUMENTO;

      -- 0 - NORMAL | 1 - 1º PARCELA | 2 - TODOS | 3 - NENHUM AND (LTIP_BAIXAAUTOMATICA IN (0,2)
      if ( (LTIP_BAIXAAUTOMATICA = 2)
           or ((LCONT = 1) and (LTIP_BAIXAAUTOMATICA = 1))
           or ((LNRPRESTACAO = 1) and (LTIP_BAIXAAUTOMATICA = 0)) )   then
      begin
        LTOTPAGO = LVLPARCELA;
      end

      LDESCFINANC = 'PEDIDO DE VENDA DE NUMERO '||ECODPEDVEND;
      insert into CONTA(
        CODCONTA,
        STATUS,
        TIPO,
        DESCRICAO,
        NRDOCUMENTO,
        CODPESSOA,
        DT_EMISSAO,
        DT_VENCIM,
        DIAS,
        PARCELA,
        PREV_TIPOPAG,
        VLPARCELA,
        VLTOTAL,
        CODCENTCUSTO,
        US_CADAST,
        DT_CADAST,
        TOTDESCONTO,
        TOTJUROS,
        TOTPAGO,
        CODPENDVEND,
        CODCARTAO,
        CODVENDEDOR,
        COMISCARTAO,
        VLRNEGOCIA,
        COMISTIPOPAG,
        PERCJUROS,
        CODEMPRESA,
        CONTABILIDADE_EXPORTA,
        OBS1)
      values(
        :LCODCONTA,
        :LSTATUS,                           
        'RECEBER',
        :LDESCFINANC,
        :LNRDOCUMENTO,
        :ECODPESSOA,
        :EDATAEMISSAO,
        :LDT_VENCIM,
        cast(:LDT_VENCIM - :EDATAEMISSAO as integer),
        :LPARCELA,
        :ETIPOPAG,
        :LVLPARCELA,
        (:EVALORTOTAL - :LCOMISCARTAO),
        :LCODCENTCUSTO,
        :EUSUARIO,
        current_timestamp,
        0,
        0,
        :LTOTPAGO,
        :ECODPEDVEND,
        :LCODCARTAOCRED,
        :ECODVENDEDOR,
        :LCOMISCARTAOPARC,
        0,
        :LCOMISSVEND,
        0,
        :ECODEMPRESA,
        1,
        :LDESCFINANC);

       if (LCODCENTCUSTO > 0) then
       begin
         insert into CONTA_CENTCUSTO (
           CODCENTCUSTO,
           CODCONTA,
           VALOR,
           CODEMPRESA)
         values (
           :LCODCENTCUSTO,
           :LCODCONTA,
           :LVLPARCELA,
           :ECODEMPRESA);
       end

      /* CASO O TIPO DE PAGAMENTO TENHA ALGUMA ENTRADA AVISTA */
      if ((ETIPOPAG <> 'CHEQUE') and ( (LTIP_BAIXAAUTOMATICA = 2)
           or ((LCONT = 1) and (LTIP_BAIXAAUTOMATICA = 1))
           or ((LNRPRESTACAO = 1) and (LTIP_BAIXAAUTOMATICA = 0)) ))   then
      begin
        insert into CONTABX (
          CODCONTA,
          DESCONTO,
          JUROS,
          VLPAGO,
          DT_PAGAMEN,
          TIPOPAG,
          US_CADAST,
          DT_CADAST,
          DT_BAIXA,
          CODCARTAOCRED,
          MOVCAIXA,
          DIASATRASO,
          CODCONTABANCO)
        values(
          :LCODCONTA,
          0,
          0,
          :LTOTPAGO,
          :LDT_VENCIM,
          :ETIPOPAG,
          :EUSUARIO,
          current_timestamp,
          :EDATAEMISSAO,
          :LCODCARTAOCRED,
          'N',
          0,
          :LCODCONTABANCOTIPOPAG)
          returning (CODCONTABX)
          into :LCODCONTABX;

        if ((PAR_GERAR_MOVCONTABANC_FORMA <> 0) and (coalesce(LCODCONTABANCOTIPOPAG,0) > 0)) then
        begin
          insert into CONTBANCMOV(
            TIPO,
            VALOR,
            DT_MOV,
            HISTORICO,
            CODCONTABANCO,
            US_CADAST,
            DT_CADAST,
            CODCONTABX,
            CODCONTA,
            PREV_TIPOPAG,
            CODEMPRESA)
          values(
            'ENTRADA',
            :LTOTPAGO,
            :LDT_VENCIM,
            'BAIXADO PELO PEDIDO DE VENDA',
            :LCODCONTABANCOTIPOPAG,
            :EUSUARIO,
            current_timestamp,
            :LCODCONTABX,
            :LCODCONTA,
            :ETIPOPAG,
            :ECODEMPRESA);
        end
      end
      LCONT = LCONT + 1;
    end
  end
  when any do
  begin
    exception;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE WS003_LISTAGEMPRODUTO(
    ECODVENDEDOR INTEGER)
RETURNS (
    CODPRODFILHO INTEGER,
    DESCRICAO VARCHAR(60),
    REFERENCIA VARCHAR(30),
    GTIN VARCHAR(30),
    APRESENTACAO VARCHAR(15),
    CONTROLALOTE VARCHAR(1),
    CONTROLAVALIDADE CHAR(1),
    CODUNIDADE INTEGER,
    UNIDADE VARCHAR(5),
    TRAVA_FRACIONADO VARCHAR(1),
    PRECOVENDA NUMERIC(15,2),
    PRECOVENDA1 NUMERIC(15,2),
    PRECOVENDA2 NUMERIC(15,2),
    PRECOVENDA3 NUMERIC(15,2),
    PRECOVENDA4 NUMERIC(15,2),
    PRECOVENDA5 NUMERIC(15,2),
    PRECOVENDA6 NUMERIC(15,2),
    ESTQATUAL NUMERIC(15,3),
    CODFABRICANTE INTEGER,
    FABRICANTE VARCHAR(60),
    CODGRUPO INTEGER,
    DESCGRUPO VARCHAR(60),
    CODSUBGRUPO INTEGER,
    DESCSUBGRUPO VARCHAR(60),
    DESCONTFLAG SMALLINT,
    DESCONTDESEJ NUMERIC(15,4),
    FLAG_SOLICITARVALORDOLAR SMALLINT,
    VALIDADES VARCHAR(500),
    APLICACAO VARCHAR(500),
    DESC_AUXILIAR_1 VARCHAR(60),
    DESC_AUXILIAR_2 VARCHAR(60),
    FLAG_PROMOCAO VARCHAR(1),
    DESCONTOPRAZO1 NUMERIC(15,2),
    DESCONTOPRAZO2 NUMERIC(15,2),
    DESCONTOPRAZO3 NUMERIC(15,2),
    DESCONTOPRAZO4 NUMERIC(15,2),
    DESCONTOPRAZO5 NUMERIC(15,2),
    DESCONTOPRAZO6 NUMERIC(15,2),
    DESCONTOPRAZO7 NUMERIC(15,2),
    DESCONTOPRAZO8 NUMERIC(15,2),
    DESCONTOPRAZO9 NUMERIC(15,2),
    DESCONTOPRAZO10 NUMERIC(15,2),
    CUSTO NUMERIC(15,2),
    ATIVO SMALLINT,
    PRECOMINIMO NUMERIC(15,2),
    QTDMULTIPLA DOUBLE PRECISION,
    QTDEMBALAGEM DOUBLE PRECISION,
    CODCOR INTEGER,
    COR VARCHAR(60),
    METACOR DOUBLE PRECISION,
    TRATESP SMALLINT,
    FATORCONVERSAO DOUBLE PRECISION,
    FLAG_CAIXAFECHADA VARCHAR(1),
    FLAG_PESOVARIAVEL VARCHAR(1),
    PESO_PECA DOUBLE PRECISION)
AS
declare variable B_EXISTE smallint;
declare variable B_EXIBIR smallint;
declare variable LEXIBIR_APENAS_WEB smallint;
declare variable LVISUALIZARNAWEB varchar(1);
declare variable PAR_REQ_VLDLR_FAB varchar(100);
declare variable LVALIDADE varchar(10);
declare variable LULTIMASINC timestamp;
declare variable PARTABELA_DE_PRECO_MINIMO integer;
declare variable LCALCOESTQPRODCOMBINADO integer;
declare variable LPRODCOMBINADO integer;
declare variable LESTQATUAL double precision;
declare variable LRESERVAMINIMA double precision;
declare variable LSQL blob sub_type 1 segment size 80;
begin
  if (exists(select 1 from CONSULTA_CUSTOMIZADA where CONSULTA_CUSTOMIZADA.CONSULTA = 'WS003_LISTAGEMPRODUTO')) then
  begin
    select SQL from CONSULTA_CUSTOMIZADA where CONSULTA_CUSTOMIZADA.CONSULTA = 'WS003_LISTAGEMPRODUTO' into LSQL;
    for execute statement (LSQL)
    (
      ECODVENDEDOR     := :ECODVENDEDOR
    )
    into
      CODPRODFILHO, 
      DESCRICAO, 
      REFERENCIA, 
      GTIN, 
      APRESENTACAO, 
      CONTROLALOTE, 
      CONTROLAVALIDADE, 
      CODUNIDADE, 
      UNIDADE, 
      TRAVA_FRACIONADO, 
      PRECOVENDA, 
      PRECOVENDA1, 
      PRECOVENDA2, 
      PRECOVENDA3, 
      PRECOVENDA4, 
      PRECOVENDA5, 
      PRECOVENDA6, 
      ESTQATUAL, 
      CODFABRICANTE, 
      FABRICANTE, 
      CODGRUPO, 
      DESCGRUPO, 
      CODSUBGRUPO, 
      DESCSUBGRUPO, 
      DESCONTFLAG, 
      DESCONTDESEJ, 
      FLAG_SOLICITARVALORDOLAR, 
      VALIDADES, 
      APLICACAO, 
      DESC_AUXILIAR_1, 
      DESC_AUXILIAR_2, 
      FLAG_PROMOCAO, 
      DESCONTOPRAZO1, 
      DESCONTOPRAZO2, 
      DESCONTOPRAZO3, 
      DESCONTOPRAZO4, 
      DESCONTOPRAZO5, 
      DESCONTOPRAZO6, 
      DESCONTOPRAZO7, 
      DESCONTOPRAZO8, 
      DESCONTOPRAZO9, 
      DESCONTOPRAZO10, 
      CUSTO, 
      ATIVO, 
      PRECOMINIMO, 
      QTDMULTIPLA,
      QTDEMBALAGEM, 
      CODCOR, 
      COR, 
      METACOR,
      TRATESP,
      FATORCONVERSAO,
      FLAG_CAIXAFECHADA,
      FLAG_PESOVARIAVEL,
      PESO_PECA
    do
    begin
      suspend;
    end
    exit;
  end

  B_EXISTE = 0;
  if (exists(select 1 from VENDEDOR_COMISSAO_GRUPO
             where VENDEDOR_COMISSAO_GRUPO.CODVENDEDOR = :ECODVENDEDOR)) then
  begin
    B_EXISTE = 1;
  end

  select ULTIMASINC from MOBILE_SINC where CODSMNTIPOSINC = 2 and CODVENDEDOR = :ECODVENDEDOR into LULTIMASINC;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('EXIBIR PRODUTOS MARCADOS COMO VISUALIZAR NA WEB',0)
  into
    LEXIBIR_APENAS_WEB;

  select
    VALOR
  from
    MLERPARAMETROINTEIRO('TABELA DE PRECO MINIMO',6)
  into
    PARTABELA_DE_PRECO_MINIMO;

  select
    VALOR
  from
    MLERPARAMETROTEXTO('REQUISITAR VALOR DOLAR (FABRICANTES)','')
  into
    PAR_REQ_VLDLR_FAB;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('CALCULAR O ESTOQUE DO PRODUTO COMBINADO', 0)
  into
    LCALCOESTQPRODCOMBINADO;

  for select
    PRODFILHO.CODPRODFILHO,
    PRODFILHO.DESCRICAO,
    coalesce(PRODFILHO.CODPESQ1,'') REFERENCIA,
    coalesce(PRODFILHO.CODPESQ2,'') GTIN,
    coalesce(PRODFILHO.UNIDADE, UNIDADE.SIGLA) APRESENTACAO,
    coalesce(PRODFILHO.ESTOQUELOTE,'N') CONTROLALOTE,
    (case when coalesce(PRODFILHO.VALIDADE,0) > 0 then 'S' else 'N' end) CONTROLAVALIDADE,
    PRODFILHO.CODUNIDADE,
    UNIDADE.SIGLA UNIDADE,
    coalesce(UNIDADE.TRAVA_FRACIONADO,'N'),
    cast(coalesce(PRODFILHO.PRECOPRATICADO1,0) as numeric(15,2)) PRECOVENDA1,
    cast(coalesce(PRODFILHO.PRECOPRATICADO2,0) as numeric(15,2)) PRECOVENDA2,
    cast(coalesce(PRODFILHO.PRECOPRATICADO3,0) as numeric(15,2)) PRECOVENDA3,
    cast(coalesce(PRODFILHO.PRECOPRATICADO4,0) as numeric(15,2)) PRECOVENDA4,
    cast(coalesce(PRODFILHO.PRECOPRATICADO5,0) as numeric(15,2)) PRECOVENDA5,
    cast(coalesce(PRODFILHO.PRECOPRATICADO6,0) as numeric(15,2)) PRECOVENDA6,
    cast(coalesce(PRODFILHO.ESTQATUAL,0) as numeric(15,3)),
    coalesce(PRODUTO.CODFABRICANTE,0),
    coalesce((select coalesce(NOME,'') from PESSOA where PESSOA.CODPESSOA = PRODUTO.CODFABRICANTE),'') FABRICANTE,
    PRODUTO.CODGRUPO,
    GRUPO.DESCRICAO DESCGRUPO,
    PRODUTO.CODSUBGRUPO,
    SUBGRUPO.DESCRICAO DESCSUBGRUPO,
    coalesce(PRODFILHO.DESCONTFLAG,1) DESCONTFLAG,
    coalesce(PRODFILHO.DESCONTDESEJ,0) DESCONTDESEJ,
    coalesce(PRODUTO.VISUALIZARNAWEB,'N'),
    substring(coalesce(PRODUTO.OBS,'') from 1 for 500),
    coalesce(PRODFILHO.DESC_AUXILIAR_1,''),
    coalesce(PRODFILHO.DESC_AUXILIAR_2,''),
    coalesce(PRODFILHO.PROMOCAO,'N'),
    PRODUTO.ATIVO,
    coalesce(PRODFILHO.QTDMULTPLA,0),
    coalesce(PRODFILHO.CODCOR,0),
    coalesce(TBL_COR.DESCRICAO,''),
    coalesce(PRODFILHO.PRODCOMBINADO,1),
    coalesce(PRODFILHO.QTDEMBALAGEM,1),
    coalesce(PRODUTO.TRATESP,1),
    coalesce(nullif(PRODFILHO.FATORCONVERSAO,0),1),
    coalesce(PRODFILHO.QTD_MULTIPLA,'N'),
    coalesce(PRODFILHO.FLAG_PESOVARIAVEL,'N'),
    coalesce(PRODFILHO.PESO_PECA,0)
  from
    PRODUTO
    join PRODFILHO on
      PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
    join UNIDADE on
      PRODFILHO.CODUNIDADE = UNIDADE.CODUNIDADE
    join GRUPO on
      PRODUTO.CODGRUPO = GRUPO.CODGRUPO
    join SUBGRUPO on
      PRODUTO.CODSUBGRUPO = SUBGRUPO.CODSUBGRUPO
    left join TBL_COR on
      PRODFILHO.CODCOR = TBL_COR.CODCOR
  where
     ((:LULTIMASINC is null) or (coalesce(PRODFILHO.DT_MODIFI, PRODFILHO.DT_CADAST) >= :LULTIMASINC))
  order by
    PRODFILHO.DESCRICAO
  into
    CODPRODFILHO,
    DESCRICAO,
    REFERENCIA,
    GTIN,
    APRESENTACAO,
    CONTROLALOTE,
    CONTROLAVALIDADE,
    CODUNIDADE,
    UNIDADE,
    TRAVA_FRACIONADO,
    PRECOVENDA1,
    PRECOVENDA2,
    PRECOVENDA3,
    PRECOVENDA4,
    PRECOVENDA5,
    PRECOVENDA6,
    ESTQATUAL,
    CODFABRICANTE,
    FABRICANTE,
    CODGRUPO,
    DESCGRUPO,
    CODSUBGRUPO,
    DESCSUBGRUPO,
    DESCONTFLAG,
    DESCONTDESEJ,
    LVISUALIZARNAWEB,
    APLICACAO,
    DESC_AUXILIAR_1,
    DESC_AUXILIAR_2,
    FLAG_PROMOCAO,
    ATIVO,
    QTDMULTIPLA,
    CODCOR,
    COR,
    LPRODCOMBINADO,
    QTDEMBALAGEM,
    TRATESP,
    FATORCONVERSAO,
    FLAG_CAIXAFECHADA,
    FLAG_PESOVARIAVEL,
    PESO_PECA
  do
  begin
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 1' into DESCONTOPRAZO1;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 2' into DESCONTOPRAZO2;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 3' into DESCONTOPRAZO3;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 4' into DESCONTOPRAZO4;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 5' into DESCONTOPRAZO5;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 6' into DESCONTOPRAZO6;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 7' into DESCONTOPRAZO7;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 8' into DESCONTOPRAZO8;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 9' into DESCONTOPRAZO9;
    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'DESCONTO PRAZO 10' into DESCONTOPRAZO10;

    select coalesce(nullif(trim(PP.VALOR),''),'0') from PARAMETRO_PRODUTO PP where PP.CODPRODFILHO = :CODPRODFILHO and PP.NOME = 'FORÃ?A DE VENDAS - RESERVA MINIMA' into LRESERVAMINIMA;

    select CUSTO from WS003_CALCULACUSTO(:CODPRODFILHO) into CUSTO;
    CUSTO = coalesce(CUSTO,0);

    DESCONTOPRAZO1  = coalesce(DESCONTOPRAZO1, 0);
    DESCONTOPRAZO2  = coalesce(DESCONTOPRAZO2, 0);
    DESCONTOPRAZO3  = coalesce(DESCONTOPRAZO3, 0);
    DESCONTOPRAZO4  = coalesce(DESCONTOPRAZO4, 0);
    DESCONTOPRAZO5  = coalesce(DESCONTOPRAZO5, 0);
    DESCONTOPRAZO6  = coalesce(DESCONTOPRAZO6, 0);
    DESCONTOPRAZO7  = coalesce(DESCONTOPRAZO7, 0);
    DESCONTOPRAZO8  = coalesce(DESCONTOPRAZO8, 0);
    DESCONTOPRAZO9  = coalesce(DESCONTOPRAZO9, 0);
    DESCONTOPRAZO10 = coalesce(DESCONTOPRAZO10, 0);
    LRESERVAMINIMA  = coalesce(LRESERVAMINIMA,0);


    if ((LPRODCOMBINADO = 2) and (LCALCOESTQPRODCOMBINADO <> 0)) then
    begin
      ESTQATUAL = null;
      for select
        cast(coalesce(PF.ESTQATUAL, 0) / coalesce(nullif(PC.QTD, 0), 1) - 0.5 as integer)
      from
        PRODCOMBINADOS PC
        join PRODFILHO PF on
          PC.CODPRO = PF.CODPRODFILHO
      where
        PC.CODNV = :CODPRODFILHO
      into
        LESTQATUAL
      do
      begin
        if (LESTQATUAL < 0) then
          LESTQATUAL = 0;

        if ((ESTQATUAL is null) or (LESTQATUAL < ESTQATUAL)) then
          ESTQATUAL = LESTQATUAL;
      end
    end

    ESTQATUAL = ESTQATUAL - LRESERVAMINIMA;
    if (coalesce(ESTQATUAL,0) <= 0) then
        ESTQATUAL = 0;

    select QTD from VENDEDORMETAS where CODVENDEDOR = :ECODVENDEDOR and CODCOR = :CODCOR into METACOR;
    METACOR = coalesce(METACOR,0);

    select
      case :PARTABELA_DE_PRECO_MINIMO
        when 1 then
          :PRECOVENDA1
        when 2 then
          :PRECOVENDA2
        when 3 then
          :PRECOVENDA3
        when 4 then
          :PRECOVENDA4
        when 5 then
          :PRECOVENDA5
        when 6 then
          :PRECOVENDA6
      end
    from
      RDB$DATABASE
    into
      PRECOMINIMO;

    PRECOMINIMO = coalesce(PRECOMINIMO,0);

    PRECOVENDA = PRECOVENDA1;
    VALIDADES = '';

    if ((CONTROLALOTE = 'S') and (CONTROLAVALIDADE = 'S')) then
    begin
      for select
        first 3
        RIGHT('00'||extract(day from PRODFILHOLOTES.DATAVAL),2)
        ||'/'||RIGHT('00'||extract(month from PRODFILHOLOTES.DATAVAL),2)
        ||'/'||extract(year from PRODFILHOLOTES.DATAVAL)
      from
        PRODFILHOLOTES
      where
        PRODFILHOLOTES.QTDMOV > 0
        and PRODFILHOLOTES.CODPRODFILHO = :CODPRODFILHO
      order by
        PRODFILHOLOTES.DATAVAL asc
      into
        LVALIDADE
      do
      begin
        if (VALIDADES = '') then
          VALIDADES = VALIDADES || LVALIDADE;
        else
          VALIDADES = VALIDADES ||' | '||LVALIDADE;
      end
    end

    VALIDADES = coalesce(VALIDADES,'');
    APLICACAO = coalesce(APLICACAO,'');

    FLAG_SOLICITARVALORDOLAR = 0;
    if ((CODFABRICANTE > 0) and (PAR_REQ_VLDLR_FAB containing CODFABRICANTE)) then
    begin
      FLAG_SOLICITARVALORDOLAR = 1;
    end

    B_EXIBIR = 1;
    if (B_EXISTE = 1) then
    begin
      B_EXIBIR = 0;
      if (exists(select 1 from VENDEDOR_COMISSAO_GRUPO
               where VENDEDOR_COMISSAO_GRUPO.CODVENDEDOR = :ECODVENDEDOR
               and VENDEDOR_COMISSAO_GRUPO.CODGRUPO = :CODGRUPO)) then
      begin
        B_EXIBIR = 1;
      end
    end

    if ((LEXIBIR_APENAS_WEB = 1) and (LVISUALIZARNAWEB = 'N')) then
      ATIVO = 0;

    if (B_EXIBIR = 1) then
      suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE WS023_VERIFICAVENDAEXISTE(
    CODPEDIDO INTEGER,
    CODVENDEDOR INTEGER)
RETURNS (
    CODPEDVEND INTEGER)
AS
begin
  select first 1 CODPEDVEND
  from PEDVEND
  where CODVENDEDOR = :CODVENDEDOR
        and PEDVEND.STATUSPED <> 'CANCELADO'
        and CODPEDPALM = RIGHT('0000000000'||:CODPEDIDO, 10)
  into CODPEDVEND;
  CODPEDVEND = coalesce(CODPEDVEND,0);
  suspend;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE WS027_VERIFICACHECKINEXISTE(
    CODIGO INTEGER,
    CODVENDEDOR INTEGER)
RETURNS (
    CODVENDEDORCHECKIN INTEGER)
AS
begin
  select first 1 CODVENDEDORCHECKIN
  from VENDEDOR_CHECKIN VC
  where CODVENDEDOR = :CODVENDEDOR
        and VC.CODCHECKINPALM = RIGHT('0000000000'||:CODIGO, 10)
  into CODVENDEDORCHECKIN;
  CODVENDEDORCHECKIN = coalesce(CODVENDEDORCHECKIN,0);
  suspend;
end^

SET TERM ; ^

/******************************************************************************/
/****                                Views                                 ****/
/******************************************************************************/


/* View: APARGERAL */
CREATE OR ALTER VIEW APARGERAL(
    NRDOCUMENTO,
    VALOR_PARC,
    DT_VENCIMENTO,
    PARCELA,
    CODCONTA,
    NOME,
    DESCRICAO,
    CODSTATUS,
    TOTPAGO)
AS
select conta.nrdocumento,conta.VLPARCELA,conta.DT_VENCIM,conta.PARCELA,conta.codconta,pessoa.nome, conta.descricao,pessoa.codstatus, conta.TOTPAGO from conta,pessoa
where conta.status = 'ABERTO' and conta.tipo = 'PAGAR'  and conta.codpessoa = pessoa.codpessoa
;



/* View: BAIRROS */
CREATE OR ALTER VIEW BAIRROS(
    BAIRRO,
    CIDADE,
    UF)
AS
select distinct '''' || BAIRRO_1 || '''', CIDADE_1, UF_1 from PESSOA where TIPOPESSOA = 'Cliente'
;



/* View: CENTCUSTOCONTA */
CREATE OR ALTER VIEW CENTCUSTOCONTA(
    CODCENTCUSTO,
    DESCRICAO,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    TIPO,
    CODLIVRE,
    CODCENTCUSTOPRI,
    CODLIVRESEMMASK)
AS
select
   CODCENTCUSTO,
   DESCRICAO,
   US_CADAST,
   DT_CADAST,
   US_MODIFI,
   DT_MODIFI,
   TIPO,
   CODLIVRE,
   CODCENTCUSTOPRI,
   CODLIVRESEMMASK
from CENTCUSTO
;



/* View: CIDADES */
CREATE OR ALTER VIEW CIDADES(
    CIDADE)
AS
select '''' || CIDADE_1 || '''' from PESSOA where TIPOPESSOA = 'Cliente' group by CIDADE_1
;



/* View: CIVN_CLIENTE */
CREATE OR ALTER VIEW CIVN_CLIENTE(
    CODIGO,
    NOME,
    COD_TIPO_CLIENTE,
    COD_TIPO_PRECO,
    COD_FUNCIONARIO,
    FANTASIA,
    CGC_CPF,
    INSC,
    ENDERECO,
    NUMERO,
    COMPLEMENTO,
    BAIRRO,
    CIDADE,
    ESTADO,
    CEP,
    FONE_1,
    FONE_2,
    CELULAR,
    FAX,
    EMAIL,
    ICMS,
    PESSOA,
    CREDITO,
    DEBITO,
    COD_FRM_PAGAMENTO,
    OBS,
    DATACADASTRO)
AS
SELECT
    CODPESSOA       ,
    NOME            ,
    CODSTATUS       ,
    CASE PRECOUSADO
        WHEN 'Preço1' THEN 1
        WHEN 'Preço2' THEN 2
        WHEN 'Preço3' THEN 3
        WHEN 'Preço4' THEN 4
        WHEN 'Preço5' THEN 5
        WHEN 'Preço6' THEN 6
        ELSE 0
    END             ,
    CODVENDEDOR     ,
    CASE
      WHEN NOMEFANTAZIA IS NULL THEN NOME
      WHEN NOMEFANTAZIA = '' THEN NOME
      ELSE NOMEFANTAZIA
    END             ,
    CPFCGC          ,
    IE              ,
    LOGRADOURO_1    ,
    ''              ,
    COMPLEMENTO_1   ,
    BAIRRO_1        ,
    CIDADE_1        ,
    UF_1            ,
    CEP_1           ,
    FONES           ,
    ''              ,
    CELULAR         ,
    FAX             ,
    EMAIL           ,
    ICMS            ,
    (PESSOA - 1)    ,
    LIMITECRED      ,
    (SELECT SUM(VLPARCELA) FROM CONTA WHERE CONTA.CODPESSOA = PESSOA.CODPESSOA AND TIPO = 'RECEBER' AND STATUS <> 'QUITADO') AS DEBITO,
    CODTIPOPAG1     ,
    OBS             ,
    DT_CADAST
FROM PESSOA
WHERE TIPOPESSOA = 'Cliente'
;



/* View: CIVN_CONDICAO_PAGAMENTO */
CREATE OR ALTER VIEW CIVN_CONDICAO_PAGAMENTO(
    CODIGO,
    NOME,
    DESCRICAO,
    COD_FRM_PAGAMENTO)
AS
SELECT
    CODTIPOPAG  ,
    DESCRICAO   ,
    DESCRICAO   ,
    CASE TIP_TIPO
        WHEN 'DINHEIRO'         THEN 1
        WHEN 'CHEQUE'           THEN 2
        WHEN 'BOLETO BANCÁRIO'  THEN 3
        ELSE 0
    END
FROM TIPOPAG
;



/* View: CIVN_DEBITO */
CREATE OR ALTER VIEW CIVN_DEBITO(
    CODIGO,
    COD_CLIENTE,
    DATAEMISSAO,
    DATAVENCIMENTO,
    DATAPAGAMENTO,
    NUMPEDIDO,
    NUMNOTA,
    VALOR,
    PAGO,
    PARCELA,
    INFO)
AS
SELECT
    CODCONTA        ,
    CODPESSOA       ,
    DT_EMISSAO      ,
    DT_VENCIM       ,
    (SELECT MAX(DT_PAGAMEN)FROM CONTABX CB WHERE CB.CODCONTA = C.CODCONTA) AS DT_PAGAMEN,
    CODPENDVEND     ,
    CODNFVENDA      ,
    VLPARCELA       ,
    CASE STATUS
        WHEN 'ABERTO' THEN 'F'
        ELSE 'T'
    END AS PAGO,
    PARCELA,
    OBS1
FROM CONTA C
WHERE TIPO = 'RECEBER'
  AND STATUS <> 'QUITADO'
;



/* View: CIVN_ESTOQUE */
CREATE OR ALTER VIEW CIVN_ESTOQUE(
    COD_PRODUTO,
    QTATUAL,
    COD_TIPO_ESTOQUE)
AS
SELECT
    FLH.CODPRODFILHO    ,
    FLH.ESTQATUAL       ,
    1
FROM PRODFILHO FLH
INNER JOIN PRODUTO PRD
    ON PRD.CODPRODUTO = FLH.CODPRODUTO
WHERE PRD.ATIVO = 2
;



/* View: CIVN_FORMA_PAGAMENTO */
CREATE OR ALTER VIEW CIVN_FORMA_PAGAMENTO(
    CODIGO,
    NOME)
AS
SELECT 1, CAST('DINHEIRO' AS VARCHAR(50))           FROM RDB$DATABASE
UNION
     SELECT 2, CAST('CHEQUE' AS VARCHAR(50))             FROM RDB$DATABASE
UNION
     SELECT 3, CAST('BOLETO BANCÁRIO' AS VARCHAR(50))    FROM RDB$DATABASE
;



/* View: CIVN_FORNECEDOR */
CREATE OR ALTER VIEW CIVN_FORNECEDOR(
    CODIGO,
    NOME,
    DESCRICAO)
AS
SELECT
    CODPESSOA       ,
    NOMEFANTAZIA    ,
    NOMEFANTAZIA
FROM PESSOA
WHERE TIPOPESSOA = 'Fornecedor'
;



/* View: CIVN_FUNCIONARIO */
CREATE OR ALTER VIEW CIVN_FUNCIONARIO(
    CODIGO,
    COD_ORIGINAL,
    NOME,
    LOGIN,
    OBSERVACAO,
    SENHA,
    SUPERVISOR,
    TELEFONE)
AS
SELECT
    CODVENDEDOR          ,
    CODVENDEDOR          ,
    NOME NOMEVENDEDOR    ,
    CODVENDEDOR          ,
    CAST('' AS VARCHAR(200)),
    CODVENDEDOR          ,
    CAST(1000 + CODSUPERVISOR AS INTEGER),
    CAST((FONES || ' / ' || CELULAR) AS VARCHAR(60))
FROM VENDEDOR
UNION SELECT
    CAST(1000 + CODSUPERVISOR AS INTEGER),
    CODSUPERVISOR           ,
    NOME                    ,
    CAST(1000 + CODSUPERVISOR AS INTEGER),
    CAST('' AS VARCHAR(200)),
    CAST(1000 + CODSUPERVISOR AS INTEGER),
    0                       ,
    CAST((FONES || ' / ' || CELULAR) AS VARCHAR(60))
FROM SUPERVISOR
;



/* View: CIVN_PRECO */
CREATE OR ALTER VIEW CIVN_PRECO(
    COD_TIPO_PRECO,
    COD_PRODUTO,
    VALOR)
AS
SELECT
        1,
        FLH.CODPRODFILHO,
        FLH.PRECOPRATICADO1
    FROM PRODFILHO FLH
    INNER JOIN PRODUTO PRD
        ON PRD.CODPRODUTO = FLH.CODPRODUTO
    WHERE PRD.ATIVO = 2
        AND FLH.PRECOPRATICADO1 IS NOT NULL
        AND FLH.PRECOPRATICADO1 > 0
UNION
SELECT
        2,
        FLH.CODPRODFILHO,
        FLH.PRECOPRATICADO2
    FROM PRODFILHO FLH
    INNER JOIN PRODUTO PRD
        ON PRD.CODPRODUTO = FLH.CODPRODUTO
    WHERE PRD.ATIVO = 2
        AND FLH.PRECOPRATICADO2 IS NOT NULL
        AND FLH.PRECOPRATICADO2 > 0
UNION
SELECT
        3,
        FLH.CODPRODFILHO,
        FLH.PRECOPRATICADO3
    FROM PRODFILHO FLH
    INNER JOIN PRODUTO PRD
        ON PRD.CODPRODUTO = FLH.CODPRODUTO
    WHERE PRD.ATIVO = 2
        AND FLH.PRECOPRATICADO3 IS NOT NULL
        AND FLH.PRECOPRATICADO3 > 0
UNION
SELECT
        4,
        FLH.CODPRODFILHO,
        FLH.PRECOPRATICADO4
    FROM PRODFILHO FLH
    INNER JOIN PRODUTO PRD
        ON PRD.CODPRODUTO = FLH.CODPRODUTO
    WHERE PRD.ATIVO = 2
        AND FLH.PRECOPRATICADO4 IS NOT NULL
        AND FLH.PRECOPRATICADO4 > 0
UNION
SELECT
        5,
        FLH.CODPRODFILHO,
        FLH.PRECOPRATICADO5
    FROM PRODFILHO FLH
    INNER JOIN PRODUTO PRD
        ON PRD.CODPRODUTO = FLH.CODPRODUTO
    WHERE PRD.ATIVO = 2
        AND FLH.PRECOPRATICADO5 IS NOT NULL
        AND FLH.PRECOPRATICADO5 > 0
UNION
SELECT
        6,
        FLH.CODPRODFILHO,
        FLH.PRECOPRATICADO6
    FROM PRODFILHO FLH
    INNER JOIN PRODUTO PRD
        ON PRD.CODPRODUTO = FLH.CODPRODUTO
    WHERE PRD.ATIVO = 2
        AND FLH.PRECOPRATICADO6 IS NOT NULL
        AND FLH.PRECOPRATICADO6 > 0
;



/* View: CIVN_PRODUTO */
CREATE OR ALTER VIEW CIVN_PRODUTO(
    CODIGO,
    COD_TIPO_PRODUTO,
    COD_FORNECEDOR,
    COD_UNIDADE,
    NOME,
    NOTA,
    COD_EMBALAGEM,
    QTDE_EMBALAGEM,
    FORMATO,
    ORDEM,
    ACEITA_DEVOLUCAO,
    DESCRICAO,
    PESO_EMBALAGEM)
AS
SELECT
    FLH.CODPRODFILHO    ,
    PRD.CODGRUPO        ,
    (SELECT FIRST 1 CODPESSOA
        FROM PRODPESSOA
        WHERE CODPRODUTO = FLH.CODPRODFILHO
    )       AS CODFORNEC,
    FLH.CODUNIDADE      ,
    FLH.DESCRICAO       ,
    ''                  ,
    0                   ,
    -- FLH.QTDEMBALAGEM    ,
    1                   ,
    0                   ,
    0                   ,
    coalesce(FLH.ACEITARPERDA, 'N') AS ACEITARPERDA,
    PRD.OBS             ,
    FLH.PESO_PECA
FROM PRODFILHO FLH
INNER JOIN PRODUTO PRD
    ON PRD.CODPRODUTO = FLH.CODPRODUTO
WHERE PRD.ATIVO = 2
;



/* View: CIVN_TIPO_CLIENTE */
CREATE OR ALTER VIEW CIVN_TIPO_CLIENTE(
    CODIGO,
    NOME,
    DESCRICAO)
AS
SELECT
    CODSTATUS   ,
    DESCRICAO   ,
    DESCRICAO
FROM STATUS
;



/* View: CIVN_TIPO_ESTOQUE */
CREATE OR ALTER VIEW CIVN_TIPO_ESTOQUE(
    CODIGO,
    NOME,
    DESCRICAO,
    QTMINIMA,
    ESTOQUESEGURO,
    VENDEDOR)
AS
SELECT
    1           ,
    EMPRESA     ,
    RAZAOSOCIAL ,
    0           ,
    'F'         ,
    NULL
FROM SYSPARAMS
;



/* View: CIVN_TIPO_PRECO */
CREATE OR ALTER VIEW CIVN_TIPO_PRECO(
    CODIGO,
    NOME)
AS
SELECT 1, CAST('Preço 1' AS VARCHAR(50)) FROM RDB$DATABASE
UNION
     SELECT 2, CAST('Preço 2' AS VARCHAR(50)) FROM RDB$DATABASE
UNION
     SELECT 3, CAST('Preço 3' AS VARCHAR(50)) FROM RDB$DATABASE
UNION
     SELECT 4, CAST('Preço 4' AS VARCHAR(50)) FROM RDB$DATABASE
UNION
     SELECT 5, CAST('Preço 5' AS VARCHAR(50)) FROM RDB$DATABASE
UNION
     SELECT 6, CAST('Preço 6' AS VARCHAR(50)) FROM RDB$DATABASE
;



/* View: CIVN_TIPO_PRODUTO */
CREATE OR ALTER VIEW CIVN_TIPO_PRODUTO(
    CODIGO,
    NOME,
    DESCRICAO)
AS
SELECT
    CODGRUPO    ,
    DESCRICAO   ,
    DESCRICAO
FROM GRUPO
;



/* View: CIVN_UNIDADE */
CREATE OR ALTER VIEW CIVN_UNIDADE(
    CODIGO,
    NOME,
    DESCRICAO,
    NUM_DECIM)
AS
SELECT
    CODUNIDADE  ,
    SIGLA       ,
    DESCRICAO   ,
    CASE
        WHEN TRAVA_FRACIONADO IS NULL THEN 3
        WHEN TRAVA_FRACIONADO = 'F' THEN 3
        ELSE 0
    END
FROM UNIDADE
;



/* View: CLIENTE */
CREATE OR ALTER VIEW CLIENTE(
    CODPESSOA,
    NOME,
    CODSTATUS,
    PRECOUSADO,
    CODVENDEDOR,
    NOMEFANTAZIA,
    CPFCGC,
    IE,
    LOGRADOURO_1,
    COMPLEMENTO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    CELULAR,
    FAX,
    EMAIL,
    ICMS,
    DT_CADAST,
    TIP_TIPO,
    CODTIPOPAG,
    OBS)
AS
select
      CODPESSOA, NOME, CODSTATUS, PRECOUSADO, CODVENDEDOR, NOMEFANTAZIA, CPFCGC, IE,
      LOGRADOURO_1, COMPLEMENTO_1, BAIRRO_1, CIDADE_1, UF_1, CEP_1, FONES, CELULAR,
      FAX, EMAIL, ICMS, PESSOA.DT_CADAST, TIPOPAG.TIP_TIPO TIP_TIPO, TIPOPAG.CODTIPOPAG CODTIPOPAG, OBS
      from PESSOA
      left join tipopag on (PESSOA.CODTIPOPAG1 = TIPOPAG.CODTIPOPAG)
      where TIPOPESSOA = 'Cliente'
;



/* View: CNNT_SALDOVENDEDOR */
CREATE OR ALTER VIEW CNNT_SALDOVENDEDOR(
    CODIGO,
    NOME,
    SALDO)
AS
SELECT
 VENDEDOR.CODVENDEDOR,
 VENDEDOR.NOME,
 (select
        coalesce((sum(coalesce(CV.VALORDIN,0)) + sum(coalesce(CV.VALORCHE,0))),0)
    from
       CAIXAVEND CV
    where
       ((CV.TIPO = 'SD.INICIAL') or (CV.TIPO = 'ENTRADA'))and
       (CV.CODVENDEDOR = VENDEDOR.CODVENDEDOR) and
       (extract(month from CV.DATA) = extract(month from current_timestamp) )and
       (extract(year from CV.DATA)  = extract(year from current_timestamp))) -
       (select
       coalesce((sum(coalesce(CV.VALORDIN,0)) + sum(coalesce(CV.VALORCHE,0))),0)
    from
       CAIXAVEND CV
    where
       (CV.TIPO = 'SAÍDA') and
       (CV.CODVENDEDOR = VENDEDOR.CODVENDEDOR) and
       (extract(month from CV.DATA) = extract(month from current_timestamp)  )and
       (extract(year from CV.DATA)  = extract(year from current_timestamp) )) AS SALDO
FROM
VENDEDOR
WHERE
VENDEDOR.ATIVO <> 1
;



/* View: COLETORES */
CREATE OR ALTER VIEW COLETORES(
    CODCOLETOR,
    COLETOR)
AS
select COLETOR.CODCOLETOR,
COLETOR.DESCRICAO || ' - ' ||
coalesce((
 select LOCACAO.DESCRICAO from LOCACAO where LOCACAO.CODLOCACAO = CONTRATO_COLETOR.CODLOCADO
),'') || ' - ' ||
coalesce(
 (select SUBLOCACAO.DESCRICAO from SUBLOCACAO where SUBLOCACAO.CODSUBLOCACAO = CONTRATO_COLETOR.CODSUBLOCADO
 and SUBLOCACAO.CODLOCACAO = CONTRATO_COLETOR.CODLOCADO)
,'') COLETOR
from COLETOR
inner join CONTRATO_COLETOR on CONTRATO_COLETOR.CODCOLETOR = COLETOR.CODCOLETOR
;



/* View: CONDICAO */
CREATE OR ALTER VIEW CONDICAO(
    CODTIPOPAG,
    DESCRICAO,
    TIP_TIPO)
AS
select CODTIPOPAG, DESCRICAO, TIP_TIPO from TIPOPAG
;



/* View: CONECTO_PRODUTO */
CREATE OR ALTER VIEW CONECTO_PRODUTO(
    STATUS,
    RECORD,
    ID,
    BASE_PLU_KEY,
    LINK_PLU_KEY,
    PLU_TYPES,
    MAKE_KEY,
    SHORT_DESCRIPTION,
    LONG_DESCRIPTION,
    COMMERCIAL_DESCRIPTION,
    IMAGE_FILE,
    POS_ID,
    COST_DECIMALS,
    UNIT_KEY,
    PRICE_DECIMALS,
    ADDER,
    DEPARTAMENT_KEY,
    SUGGESTED_PROMPT,
    DATA_ENTRY_KEY,
    TARE_KEY,
    IS_COMPLETION,
    HAS_DEPOSIT,
    HAS_PLU_LINK,
    PRICE_REQUERED,
    QUANTITY_DISALLOWED,
    QUANTITY_REQUERED,
    DECIMAL_DISALLOWED,
    DECIMAL_REQUIRED,
    ID_REQUIRED,
    REPEAT_DISALLOWED,
    SCALE,
    TRACKING_TOTAL,
    DEPOSIT,
    NON_MERCHANDISE,
    RETURN_DISALLOWED,
    REFUND_DISALLOWED,
    MARKDOWN_DISALLOWED,
    REBATE,
    NOT_FOR_SALE,
    NEGATIVE,
    CLERK_REQUIRED,
    KIT,
    FOR_SCALE,
    DELIVERY,
    AUTHRIZER_REQUIRED,
    QTY_FROM_AMOUNT,
    PRINT_ETQ,
    COMPLETION,
    IS_PLU_BASE,
    STORE_ADM_PRICE,
    REVERSE_KIT,
    VERIFY_STOCK,
    VALID_DAYS,
    NCM_SH,
    PIS_COFINS,
    QUANTITY,
    QUANTITY_MIN,
    QUANTITY_MAX,
    CLASS,
    MERCHANDISE_ORIGIN,
    MERCHANDISE_GROUP,
    PACKAGE,
    WHOLESALE_QUANTITY,
    DELIVERY_TYPE,
    MESSAGE_SUBTOTAL,
    STANDARD_UNIT,
    QUANTITY_STANDARD,
    IS_PRODUCED,
    IS_INPUT,
    IS_SCANNED,
    GLOSS_WEIGHT,
    NET_WEIGTH,
    TOTAL_TAX,
    SEFAZ_ID,
    ANP_CODE,
    PIS_POS_ID,
    COFINS_POS_ID)
AS
select
  0,
  10,
  PR.CODPRODFILHO,
  0,
  0,
  0,
  P.CODFABRICANTE,
  PR.DESCRICAO,
  PR.DESCRICAO,
  PR.DESCRICAO,
  ' ',
  (select SIGLA from CONECTO_TRIBUTACAO(PR.TRIBUTADO,PR.ALIQUOTAICMS)) SIGLA,
  (select CASADECIMAL from SYSPARAMS),
  ' ',
  (select CASADECIMAL from SYSPARAMS),
  0,
  P.CODGRUPO,
  ' ',
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  0,
  0,
  0,
  0,
  case PR.ATIVABALANCA
    when 'S' then 1
    else 0
  end ATIVABALANCA,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  case P.ATIVO
    when 2 then 1
    else 0
  end ATIVO,
  0,
  0,
  case PR.PRODCOMBINADO
    when 0 then 1
    else 0
  end PRODCOMBINADO,
  case PR.ATIVABALANCA
    when 'S' then 1
    else 0
  end ATIVABALANCA,
  0,
  0,
  0,
  case PR.ATIVABALANCA
    when 'S' then '1'
    else 0
  end ATIVABALANCA,
  0,
  0,
  ' ',
  ' ',
  0,
  0,
  ' ',
  PR.CLASSFISCAL,
  ' ',
  PR.QTDEMBALAGEM,
  1,
  ' ',
  ' ',
  ' ',
  ' ',
  PR.QTDEMBALAGEM,
  ' ',
  ' ',
  ' ',
  PR.CODUNIDADE,
  PR.QTDEMBALAGEM,
  0,
  0,
  ' ',
  PR.PESOBRUTO,
  PR.PESOLIQUIDO,
  ' ',
  PR.CODANP,
  PR.CODANP,
  ' ',
  ' '
from
  PRODFILHO PR
  inner join PRODUTO P on
    PR.CODPRODUTO = P.CODPRODUTO
;



/* View: CONECTO_PRODUTO_FILIAL */
CREATE OR ALTER VIEW CONECTO_PRODUTO_FILIAL(
    STATUS,
    RECORD,
    STORE_KEY,
    ID,
    DESIRED_MARGIN_PERC,
    QUANTITY_IN_STOCK,
    OUT_OF_STOCK_DAY,
    LAST_ENTERED_DAY,
    LAST_SALE_DAY,
    COST,
    START_COST)
AS
select
  0,
  11,
  1,
  PRODFILHO.CODPRODFILHO,
  PRODFILHO.MARKUP1,
  PRODFILHO.ESTQATUAL,
  '',
  '',
  '',
  PRODFILHO.CUSTOREPOSI,
  null
from
  PRODFILHO
;



/* View: CONECTO_PRODUTO_FILIAL_PLU */
CREATE OR ALTER VIEW CONECTO_PRODUTO_FILIAL_PLU(
    STATUS,
    RECORD,
    STORE_KEY,
    ID,
    PRICE,
    START_PRICE,
    TIME_PRICE,
    TYPE_PRICE,
    PROMOTION,
    CODE_PROMOTION,
    POINTS,
    QUANTITY,
    RATE,
    "SEQUENCE")
AS
select
  0,
  12,
  PLU.CODEMPRESA,
  PLUITEM.CODPRODFILHO,
  PLUITEM.PRECONOVO,
  extract(day from PLUITEM.DT_CADAST) ||substring(PLUITEM.DT_CADAST from 6 for 2) ||extract(year from PLUITEM.DT_CADAST),
  '235959',
  PLU.TIPOPRECO,
  case PLU.TIPO
    when 'ATUALIZACAO' then 0
    else 1
  end TIPO,
  PLU.CODPLU,
  0,
  PRODFILHO.ESTQATUAL,
  0,
  0
from
  PLUITEM
  join PLU on
    PLU.CODPLU = PLUITEM.CODPLU
  join PRODFILHO on
    PRODFILHO.CODPRODFILHO = PLUITEM.CODPRODFILHO
;



/* View: CONECTO_PRODUTO_FILIAL_PLU_QTDE */
CREATE OR ALTER VIEW CONECTO_PRODUTO_FILIAL_PLU_QTDE(
    STATUS,
    RECORD,
    STORE_KEY,
    ID,
    TYPE_PRICE,
    STEP_NUMBER,
    PRICE,
    START_PRICE,
    TIME_PRICE,
    TIMES,
    NEXT_STEP,
    ACTION_TYPE)
AS
select
  0,
  15,
  PLU.CODEMPRESA,
  PLUITEM.CODPRODFILHO,
  PLU.TIPOPRECO,
  0,
  PLUITEM.PRECONOVO,
  cast(PLUITEM.DT_CADAST as date),
  cast(PLUITEM.DT_CADAST as time),
  PLU.TIPOPRECO,
  0,
  0
from
  PLUITEM
  join PLU on
    PLU.CODPLU = PLUITEM.CODPLU
  join PRODFILHO on
    PRODFILHO.CODPRODFILHO = PLUITEM.CODPRODFILHO
;



/* View: CONECTO_SKU */
CREATE OR ALTER VIEW CONECTO_SKU(
    STATUS,
    RECORD,
    SKU_ID,
    PLU_ID)
AS
select
  0,
  '01',
  CODPESQ2,
  CODPRODFILHO
from
  PRODFILHO
;



/* View: CONSULTA_MATERIA_PRIMA */
CREATE OR ALTER VIEW CONSULTA_MATERIA_PRIMA(
    CODPRODFILHO,
    DESCRICAO,
    PRECO_MERCADO)
AS
SELECT
  CODPRODFILHO,
  DESCRICAO,
  PRECO_MERCADO
  FROM PRODFILHO
WHERE
  PRDF_MATERIAPRIMA = 'S'
;



/* View: CONTA_ULTIMAREMESSA */
CREATE OR ALTER VIEW CONTA_ULTIMAREMESSA(
    CODCONTA,
    CODULTIMA_REMESSA)
AS
select
  CONTA_REMESSA.CODCONTA,
  max(CONTA_REMESSA.CODCONTA_REMESSA) CODULTIMA_REMESSA
from
  CONTA_REMESSA
group by 1
;



/* View: DEBITO */
CREATE OR ALTER VIEW DEBITO(
    CODPESSOA,
    DT_EMISSAO,
    DT_VENCIM,
    CODPENDVEND,
    CODNFVENDA,
    VLPARCELA,
    STATUS,
    DT_PAGAMEN)
AS
SELECT
  CODPESSOA, DT_EMISSAO, DT_VENCIM, CODPENDVEND, CODNFVENDA, VLPARCELA, STATUS,
  (SELECT MAX(DT_PAGAMEN)FROM CONTABX CB WHERE CB.CODCONTA = C.CODCONTA) DT_PAGAMEN
FROM CONTA C
WHERE TIPO = 'RECEBER'
  AND STATUS <> 'QUITADO'
;



/* View: DSLCADPRO */
CREATE OR ALTER VIEW DSLCADPRO(
    CODPRO,
    DTCADPRO,
    DESCPRO,
    CODGRU,
    CODSUB,
    REF_FABR,
    PROMOCAO,
    PROATIINA,
    ULTREAVDA,
    PREVENDA,
    PREVENDA2,
    PREVENDA3,
    PREVENDA6,
    PRECOANT,
    SALDESTOQ,
    CODFABRICANTE,
    CUSTOMEDIO,
    CUSTOREPOS,
    FATORCONVERSAO)
AS
SELECT PF.CODPESQ1,
       CAST(PF.DT_CADAST AS DATE),
       PF.DESCRICAO,
       PD.CODGRUPO,
       PD.CODSUBGRUPO,
       UN.SIGLA,
       PF.PROMOCAO,
       CASE PD.ATIVO
       WHEN 1 THEN 'I'
       WHEN 2 THEN 'A' END AS ATIVO,
       CAST('01.01.2006' AS DATE),
       PF.PRECOPRATICADO1,
       PF.PRECOPRATICADO2,
       PF.PRECOPRATICADO3,
       PF.PRECOPRATICADO6,
       1,
       PF.ESTQATUAL,
       PD.CODFABRICANTE,
       COALESCE(PF.CUSTOMEDIO,1) AS CUSTOMEDIO,
       COALESCE(PF.CUSTOREPOSI2,1) AS CUSTOREPOSI2,
       COALESCE(PF.FATORCONVERSAO,1) AS FATORCONVERSAO
       FROM PRODFILHO PF
       INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
       INNER JOIN UNIDADE UN ON (PF.CODUNIDADE = UN.CODUNIDADE)
;



/* View: DSLCADSET_TOTAIS */
CREATE OR ALTER VIEW DSLCADSET_TOTAIS(
    CODSET,
    CODGRUPO,
    VENDAS,
    PEDIDOS,
    ATENDIDOS,
    ULTVENDA,
    FLEX,
    FLEXPERC,
    VENDAUNID)
AS
select
   P.CODVENDEDOR,
   PD.CODGRUPO,
   coalesce(sum(PI.PRECOVEND),0) as VENDAS,
   coalesce(count(distinct P.CODPEDVEND),0) as PEDIDOS,
   coalesce(count(distinct P.CODPESSOA),0) as ATENDIDOS,
   max(DT_SAIDA) ,
   coalesce(sum(PI.QTDE*PI.CUSTOREPOSI2),0) as CUSTO,
   coalesce((1-(sum(PI.QTDE*PI.CUSTOREPOSI2) / sum(PI.PRECOVEND)))*100,0) as MARGEM,
   coalesce(sum(PI.QTDE*PF.FATORCONVERSAO),0) as LITROS
   from PEDVEND P
   inner join PEDVENDITEM PI on (P.CODPEDVEND = PI.CODPEDVEND)
   inner join PRODFILHO PF on (PI.CODPRODFILHO = PF.CODPRODFILHO)
   inner join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
   where P.STATUSPED <> 'CANCELADO' and P.TIPOPED = 'VENDA'
   and extract(month from P.DT_SAIDA) = extract(month from (select first 1 DATAPALM from DATAPALM))
   and extract(year from P.DT_SAIDA) = extract(year from (select first 1 DATAPALM from DATAPALM))
   group by 1,2
;



/* View: DSLCADSET */
CREATE OR ALTER VIEW DSLCADSET(
    CODSET,
    NOMSET,
    CODGRUPO,
    COTASET,
    VENDAS,
    PEDIDOS,
    QUANTCLI,
    ATENDIDOS,
    ULTVENDA,
    FLEX,
    FLEXPERC,
    COTAUNID,
    VENDAUNID,
    TABELA1,
    TABELA2,
    TABELA3,
    TABELA4,
    TABELA5,
    TABELA6)
AS
select
   RIGHT('00000000' || cast(V.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR,
   NOME,
   VM.CODGRUPO,
   coalesce(VM.VALOR,0) as TOT_VALOR,
   coalesce(VENDAS,0) as VENDAS,
   coalesce(PEDIDOS,0) as PEDIDOS,
   coalesce(VM.POTENCIAL,0) as TOT_POTENCIAL,
   coalesce(ATENDIDOS,0) as ATENDIDOS,
   ULTVENDA,
   coalesce(FLEX,0) as CUSTO,
   coalesce(FLEXPERC,0) as MARGEM,
   coalesce(VM.QTD,0) as TOT_QTD,
   coalesce(VENDAUNID,0) as LITROS,
   PRECO1,
   PRECO2,
   PRECO3,
   PRECO4,
   PRECO5,
   PRECO6
   from VENDEDOR V
   inner join VENDEDORMETAS VM on (V.CODVENDEDOR = VM.CODVENDEDOR and
   extract(month from (select first 1 DATAPALM from datapalm)) >= extract(month from VM.INICIO) and
   extract(month from (select first 1 DATAPALM from datapalm)) <= extract(month from VM.FINAL) and
   (extract(year from (select first 1 DATAPALM from datapalm)) = extract(year from VM.FINAL) or
   extract(year from (select first 1 DATAPALM from datapalm)) = extract(year from VM.INICIO)))
   left join DSLCADSET_TOTAIS DT on (DT.CODSET = V.CODVENDEDOR and DT.CODGRUPO = VM.CODGRUPO)
;



/* View: DSLCADSET_RAPIDO */
CREATE OR ALTER VIEW DSLCADSET_RAPIDO(
    CODSET,
    NOMSET,
    TABELA1,
    TABELA2,
    TABELA3)
AS
SELECT
   RIGHT('00000000' || CAST(V.CODVENDEDOR AS VARCHAR(6)) ,4) AS CODVENDEDOR,
   NOME,
   PRECO1,
   PRECO2,
   PRECO3
   FROM VENDEDOR V
;



/* View: EMBARQUEITEMVIEW */
CREATE OR ALTER VIEW EMBARQUEITEMVIEW(
    CODEMBARQUEITEM,
    CODEMBARQUE_FK,
    CODPEDVEND_FK,
    DT_CADAST,
    US_CADAST,
    DT_MODIFI,
    US_MODIFI,
    RETORNO,
    DT_ENTREGAPREV,
    CODPESSOA,
    NOME,
    LOGRADOURO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    STATUSPED,
    CODNFVENDA,
    VALOR_TOTAL,
    TIPOPAG,
    DTFATURADO,
    PDV_CRITICA,
    PESOBRUTO,
    CODPEDVENDITEM)
AS
select
  CODEMBARQUEITEM,
  coalesce(CODEMBARQUE_FK, 0),
  CODPEDVEND_FK,
  E.DT_CADAST,
  E.US_CADAST,
  E.DT_MODIFI,
  E.US_MODIFI,
  E.RETORNO,
  DT_ENTREGAPREV,
  C.CODPESSOA,
  C.NOME,
  LOGRADOURO_1,
  BAIRRO_1,
  CIDADE_1,
  UF_1,
  CEP_1,
  STATUSPED,
  coalesce(P.CODNFVENDA, P.CODFATURAMENTO) CODNFVENDA,
  P.VALOR_TOTAL,
  P.TIPOPAG,
  P.DTFATURADO,
  P.PDV_CRITICA,
  (select
     sum(PF.PESOBRUTO * PI.QTDENTREGUE)
   from
     PEDVENDITEM PI
     join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
   where
     PI.CODPEDVEND = E.CODPEDVEND_FK) PESOBRUTO,
  (select
     count(PI.CODPEDVENDITEM)
   from
     PEDVENDITEM PI
   where
     PI.CODPEDVEND = E.CODPEDVEND_FK) CODPEDVENDITEM
from
  EMBARQUEITEM E
  join PEDVEND P on CODPEDVEND_FK = CODPEDVEND
  join PESSOA C on P.CODPESSOA = C.CODPESSOA
;



/* View: EMP_EMPRESA */
CREATE OR ALTER VIEW EMP_EMPRESA(
    EMAIL,
    PESSOA_CONTATO,
    UF_1,
    BAIRRO_1,
    CIDADE_1,
    UF_11,
    LOGRADOURO_1,
    COMPLEMENTO_1,
    CEP_1,
    FONES,
    CELULAR,
    CPFCGC,
    NOME,
    NOMEFANTAZIA,
    EMP_TIPO_EMPRESA,
    CODPESSOA,
    CODTIPOATV,
    EMP_CD_FORNECEDOR_IMPORT)
AS
SELECT
  PESSOA.EMAIL AS EMP_EMAIL,
  PESSOA.PESSOA_CONTATO AS EMP_CONTATO,
  PESSOA.UF_1 AS EMP_UF_ATUACAO,
  PESSOA.BAIRRO_1 AS EMP_BAIRRO,
  PESSOA.CIDADE_1 AS EMP_CIDADE,
  PESSOA.UF_1 AS EMP_ESTADO,
  PESSOA.LOGRADOURO_1 AS EMP_LOGRADOURO,
  PESSOA.COMPLEMENTO_1 AS EMP_COMPLEMENTO,
  PESSOA.CEP_1 AS EMP_CEP,
  PESSOA.FONES AS EMP_FONE_FIXO,
  PESSOA.CELULAR AS EMP_FONE_CELULAR,
  PESSOA.CPFCGC AS EMP_CNPJ_CPF,
  PESSOA.NOME AS EMP_RAZAO_SOCIAL,
  PESSOA.NOMEFANTAZIA AS EMP_NOME_FANTASIA,
  'PDV' AS EMP_TIPO_EMPRESA,
  PESSOA.CODPESSOA AS EMP_CD_EMPRESA_IMPORT,
  PESSOA.CODTIPOATV AS EMP_CD_SEGMENTACAO_IMPORT,
  'NULO' AS EMP_CD_FORNECEDOR_IMPORT
FROM
 PESSOA
WHERE PESSOA.CODSTATUS = 1
UNION
SELECT
  PESSOA.EMAIL AS EMP_EMAIL,
  PESSOA.PESSOA_CONTATO AS EMP_CONTATO,
  PESSOA.UF_1 AS EMP_UF_ATUACAO,
  PESSOA.BAIRRO_1 AS EMP_BAIRRO,
  PESSOA.CIDADE_1 AS EMP_CIDADE,
  PESSOA.UF_1 AS EMP_ESTADO,
  PESSOA.LOGRADOURO_1 AS EMP_LOGRADOURO,
  PESSOA.COMPLEMENTO_1 AS EMP_COMPLEMENTO,
  PESSOA.CEP_1 AS EMP_CEP,
  PESSOA.FONES AS EMP_FONE_FIXO,
  PESSOA.CELULAR AS EMP_FONE_CELULAR,
  PESSOA.CPFCGC AS EMP_CNPJ_CPF,
  PESSOA.NOME AS EMP_RAZAO_SOCIAL,
  PESSOA.NOMEFANTAZIA AS EMP_NOME_FANTASIA,
  'DIS' AS EMP_TIPO_EMPRESA,
  PESSOA.CODPESSOA AS EMP_CD_EMPRESA_IMPORT,
  PESSOA.CODTIPOATV AS EMP_CD_SEGMENTACAO_IMPORT,
  'NULO' AS EMP_CD_FORNECEDOR_IMPORT
FROM
 PESSOA
WHERE PESSOA.CODSTATUS = 2
UNION
SELECT
  PESSOA.EMAIL AS EMP_EMAIL,
  PESSOA.PESSOA_CONTATO AS EMP_CONTATO,
  PESSOA.UF_1 AS EMP_UF_ATUACAO,
  PESSOA.BAIRRO_1 AS EMP_BAIRRO,
  PESSOA.CIDADE_1 AS EMP_CIDADE,
  PESSOA.UF_1 AS EMP_ESTADO,
  PESSOA.LOGRADOURO_1 AS EMP_LOGRADOURO,
  PESSOA.COMPLEMENTO_1 AS EMP_COMPLEMENTO,
  PESSOA.CEP_1 AS EMP_CEP,
  PESSOA.FONES AS EMP_FONE_FIXO,
  PESSOA.CELULAR AS EMP_FONE_CELULAR,
  PESSOA.CPFCGC AS EMP_CNPJ_CPF,
  PESSOA.NOME AS EMP_RAZAO_SOCIAL,
  PESSOA.NOMEFANTAZIA AS EMP_NOME_FANTASIA,
  'TIM' AS EMP_TIPO_EMPRESA,
  PESSOA.CODPESSOA AS EMP_CD_EMPRESA_IMPORT,
  PESSOA.CODTIPOATV AS EMP_CD_SEGMENTACAO_IMPORT,
  'NULO' AS EMP_CD_FORNECEDOR_IMPORT
FROM
 PESSOA
WHERE PESSOA.CODSTATUS = 3
;



/* View: EST_ESTOQUE */
CREATE OR ALTER VIEW EST_ESTOQUE(
    ESTQATUAL,
    EST_CD_EMPRESA_IMPORT,
    CODPRODFILHO,
    EST_CD_ESTOQUE_IMPORT)
AS
SELECT
  PRODFILHO.ESTQATUAL AS EST_QUANTIDADE,
  (SELECT CODPESSOA FROM PESSOA WHERE CODSTATUS = 2) AS EST_CD_EMPRESA_IMPORT,
  PRODFILHO.CODPRODFILHO AS EST_CD_PROD_DIS,
  'NULO' AS EST_CD_ESTOQUE_IMPORT
FROM
 PRODUTO
 INNER JOIN PRODFILHO ON (PRODUTO.CODPRODUTO=PRODFILHO.CODPRODUTO)
WHERE
  (PRODUTO.CODGRUPO = 3)
;



/* View: ESTADOS */
CREATE OR ALTER VIEW ESTADOS(
    CODESTADO,
    SIGLA,
    ESTADO)
AS
select codestado, 
       '''' || sigla || '''',
       estado
from tbl_estado
;



/* View: FORNECEDOR */
CREATE OR ALTER VIEW FORNECEDOR(
    CODPESSOA,
    NOMEFANTAZIA)
AS
select
  CODPESSOA, NOMEFANTAZIA
from
  PESSOA WHERE TIPOPESSOA = 'Fornecedor'
;



/* View: FRM_PAG */
CREATE OR ALTER VIEW FRM_PAG(
    CODTIPOPAG,
    DESCRICAO,
    TIP_TIPO)
AS
select CODTIPOPAG, DESCRICAO, TIP_TIPO from TIPOPAG
;



/* View: FUNC */
CREATE OR ALTER VIEW FUNC(
    CODVENDEDOR,
    NOMEVENDEDOR,
    NOMESUPERVISOR,
    FONES,
    CELULAR)
AS
select
  v.CODVENDEDOR,
  v.NOME NOMEVENDEDOR,
  coalesce(s.NOME, 'NENHUM') NOMESUPERVISOR,
  v.FONES,
  v.CELULAR
from
  VENDEDOR v
    left join SUPERVISOR s on v.CODSUPERVISOR = s.CODSUPERVISOR
;



/* View: ITN_ITEM_NOTA */
CREATE OR ALTER VIEW ITN_ITEM_NOTA(
    ITN_QUANTIDADE,
    ITN_CD_NOTA_FISCAL_IMPORT,
    ITN_CD_VENDEDOR_IMPORT,
    ITN_CD_PROD_DIS,
    ITN_CD_ITEM_NOTA_IMPORT)
AS
SELECT
  PEDVENDITEM.QTDE AS ITN_QUANTIDADE,
  CAST('S' || PEDVENDITEM.CODPEDVEND AS VARCHAR(17)) AS ITN_CD_NOTA_FISCAL_IMPORT,
  PEDVEND.CODVENDEDOR AS ITN_CD_VENDEDOR_IMPORT,
  PEDVENDITEM.CODPRODFILHO AS ITN_CD_PROD_DIS,
  '00' AS ITN_CD_ITEM_NOTA_IMPORT
FROM
 PEDVENDITEM
 INNER JOIN PEDVEND ON (PEDVENDITEM.CODPEDVEND=PEDVEND.CODPEDVEND)
UNION
SELECT
  AJUSTESTOQITEM.QTDE AS ITN_QUANTIDADE,
  CAST('E' || AJUSTESTOQITEM.CODAJUSTESTOQ AS VARCHAR(17)) AS ITN_CD_NOTA_FISCAL_IMPORT,
  1 AS ITN_CD_VENDEDOR_IMPORT,
  AJUSTESTOQITEM.CODPRODFILHO AS ITN_CD_PROD_DIS,
  '00' AS ITN_CD_ITEM_NOTA_IMPORT
FROM
 AJUSTESTOQITEM
 INNER JOIN AJUSTESTOQ ON (AJUSTESTOQITEM.CODAJUSTESTOQ=AJUSTESTOQ.CODAJUSTESTOQ)
;



/* View: MAPAVENDAS */
CREATE OR ALTER VIEW MAPAVENDAS(
    CODVENDEDOR,
    VENDEDOR,
    CODSTATUS,
    STATUS,
    CODPESSOA,
    PESSOA,
    CODPEDVEND,
    DTFATURADO,
    CODGRUPO,
    GRUPO,
    CODSUBGRUPO,
    SUBGRUPO,
    CODPRODFILHO,
    PRODFILHO,
    UNIDADE,
    QTDENTREGUE,
    CAIXA,
    PRECOPROD,
    DESCONTO_VALOR,
    PESOBRUTO,
    PESOLIQUIDO,
    PERDA,
    USUARIO,
    ACRESCIMOVALOR,
    FRETE,
    CODEMPRESA,
    CIDADE,
    ARE_CODIGO,
    AREA,
    CURVA,
    VALORIPI,
    CODFABRICANTE,
    CUBAGEM,
    CMV,
    CODPESQ1,
    PRECOFORNEC,
    CUSTOREPOSI,
    PRECOPRATICADO1,
    ESTQATUAL,
    BAIRRO,
    UF)
AS
select
  V.CODVENDEDOR,
  V.NOME,
  ST.CODSTATUS,
  ST.DESCRICAO,
  PE.CODPESSOA,
  PE.NOME,
  case (select VALOR from MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0))
  when 0 then
    coalesce(P.CODFATURAMENTO, P.CODNFVENDA, P.CODPEDVEND)
  else
    P.CODPEDVEND
  end,
  cast(coalesce(P.DTFATURADO,P.DT_SAIDA) as date),
  G.CODGRUPO,
  G.DESCRICAO,
  S.CODSUBGRUPO,
  S.DESCRICAO,
  PI.CODPRODFILHO,
  PF.DESCRICAO,
  coalesce(PF.UNIDADE, U.SIGLA),
  PI.QTDENTREGUE,
  PI.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1),
  PI.PRECOPROD,
  (((coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0)) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) + coalesce(PI.DESCONTO_VALOR,0)) as TOTDESCONTO,
  PF.PESOBRUTO * PI.QTDENTREGUE,
  PF.PESOLIQUIDO * PI.QTDENTREGUE,
  PI.PERDA,
  P.US_CADAST,
  (((coalesce(P.ACRESVALOR,0) + (coalesce(P.VALOR_BRUTO,0) * (coalesce(P.ACRESCIMO,0)/100))) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1)))) as TOTDESCONTO,
  (coalesce(P.FRETE,0) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) as FRETE,
  P.CODEMPRESA,
  PE.CIDADE_1,
  PE.ARE_CODIGO,
  COALESCE(TA.ARE_DESCRICAO,'AREA NÃO ASSOCIADA'),
  PF.CURVA,
  (coalesce(PI.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)),
  PR.CODFABRICANTE,
  (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(PI.QTDENTREGUE,0)),
  (coalesce(PF.CUSTOMEDIO,0) * coalesce(PI.QTDENTREGUE,0)),
  PF.CODPESQ1,
  PF.PRECOFORNEC,
  PF.CUSTOREPOSI,
  PF.PRECOPRATICADO1,
  PF.ESTQATUAL,
  PE.BAIRRO_1,
  PE.UF_1
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join STATUS ST on PE.CODSTATUS = ST.CODSTATUS
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join GRUPO G on PR.CODGRUPO = G.CODGRUPO
  join SUBGRUPO S on PR.CODSUBGRUPO = S.CODSUBGRUPO
  join UNIDADE U on PF.CODUNIDADE = U.CODUNIDADE
  left join TBL_AREA TA on TA.ARE_CODIGO = PE.ARE_CODIGO
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA', 'CADERNO')
;



/* View: MAPAVENDAS_BI2 */
CREATE OR ALTER VIEW MAPAVENDAS_BI2(
    CODVENDEDOR,
    VENDEDOR,
    CODSTATUS,
    STATUS,
    CODPESSOA,
    PESSOA,
    CODPEDVEND,
    DTFATURADO,
    CODGRUPO,
    GRUPO,
    CODSUBGRUPO,
    SUBGRUPO,
    CODPRODFILHO,
    PRODFILHO,
    UNIDADE,
    QTDENTREGUE,
    QTDFATOR,
    CAIXA,
    PRECOPROD,
    DESCONTO_VALOR,
    PESOBRUTO,
    PESOLIQUIDO,
    PERDA,
    USUARIO,
    ACRESCIMOVALOR,
    FRETE,
    CODEMPRESA,
    CIDADE,
    ARE_CODIGO,
    AREA,
    CURVA,
    VALORIPI,
    CODFABRICANTE,
    CUBAGEM,
    CMV,
    CODPESQ1,
    PRECOFORNEC,
    CUSTOREPOSI,
    PRECOPRATICADO1,
    ESTQATUAL,
    BAIRRO,
    UF,
    SUPERVISOR,
    FABRICANTE,
    LATITUDE,
    LONGITUDE,
    CUSTO_ITEM_REPOSICAO,
    RAMO,
    ATIVIDADE,
    TIPO_ATIVIDADE)
AS
select
  V.CODVENDEDOR,
  V.NOME,
  ST.CODSTATUS,
  ST.DESCRICAO,
  PE.CODPESSOA,
  PE.NOME,
  P.CODPEDVEND,
  cast(coalesce(P.DT_ENTREGAPREV,P.DT_SAIDA) as date),
  G.CODGRUPO,
  G.DESCRICAO,
  S.CODSUBGRUPO,
  S.DESCRICAO,
  PI.CODPRODFILHO,
  PF.DESCRICAO,
  coalesce(PF.UNIDADE, U.SIGLA),
  PI.QTDENTREGUE,
  PI.QTDENTREGUE * coalesce(PF.fatorconversao, 1),
  PI.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1),
  PI.precovend / PI.qtdentregue,
  (((coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0)) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) + coalesce(PI.DESCONTO_VALOR,0)) as TOTDESCONTO,
  PF.PESOBRUTO * PI.QTDENTREGUE,
  PF.PESOLIQUIDO * PI.QTDENTREGUE,
  PI.PERDA,
  P.US_CADAST,
  (((coalesce(P.ACRESVALOR,0) + (coalesce(P.VALOR_BRUTO,0) * (coalesce(P.ACRESCIMO,0)/100))) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1)))) as TOTDESCONTO,
  (coalesce(P.FRETE,0) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) as FRETE,
  P.CODEMPRESA,
  PE.CIDADE_1,
  PE.ARE_CODIGO,
  COALESCE(TA.ARE_DESCRICAO,'AREA NÃO ASSOCIADA'),
  PF.CURVA,
  (coalesce(PI.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)),
  PR.CODFABRICANTE,
  (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(PI.QTDENTREGUE,0)),
  (coalesce(PF.CUSTOMEDIO,0) * coalesce(PI.QTDENTREGUE,0)),
  PF.CODPESQ1,
  PF.PRECOFORNEC,
  PI.CUSTOREPOSI2,
  PF.PRECOPRATICADO1,
  PF.ESTQATUAL,
  PE.BAIRRO_1,
  PE.UF_1,
  SU.NOME SUPERVISOR,
  PE2.NOME FABRICANTE,
  PE.LATITUDE,
  PE.LONGITUDE,
  coalesce((1 - ((PI.QTDE * PI.CUSTOREPOSI2) / PRECOVEND)) * 100,0) CUSTO_ITEM_REPOSICAO,
  TBL_RAMO.DESCRICAO RAMO,
  TBL_RAMOATV.DESCRICAO ATIVIDADE,
  TBL_RAMOATVTIPO.DESCRICAO TIPO_ATIVIDADE
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  LEFT join SUPERVISOR SU on SU.CODSUPERVISOR = V.CODSUPERVISOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join STATUS ST on PE.CODSTATUS = ST.CODSTATUS
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  LEFT join PESSOA PE2 on PR.CODFABRICANTE = PE2.CODPESSOA
  join GRUPO G on PR.CODGRUPO = G.CODGRUPO
  join SUBGRUPO S on PR.CODSUBGRUPO = S.CODSUBGRUPO
  join UNIDADE U on PF.CODUNIDADE = U.CODUNIDADE
  left join TBL_AREA TA on TA.ARE_CODIGO = PE.ARE_CODIGO
  inner join TBL_RAMOATVTIPO on TBL_RAMOATVTIPO.CODTIPO = PE.CODTIPOATV
  inner join TBL_RAMOATV on TBL_RAMOATV.CODATIVIDADE = TBL_RAMOATVTIPO.CODATIVIDADE
  inner join TBL_RAMO on TBL_RAMO.CODRAMO = TBL_RAMOATV.CODRAMO
where
  P.STATUSPED <> 'CANCELADO' and
  P.TIPOPED in ('VENDA', 'CADERNO')
;



/* View: MAPAVENDAS_INDUSTRIA */
CREATE OR ALTER VIEW MAPAVENDAS_INDUSTRIA(
    CODVENDEDOR,
    VENDEDOR,
    CODSTATUS,
    STATUS,
    CODPESSOA,
    PESSOA,
    CODPEDVEND,
    DTFATURADO,
    CODGRUPO,
    GRUPO,
    CODSUBGRUPO,
    SUBGRUPO,
    CODPRODFILHO,
    PRODFILHO,
    UNIDADE,
    QTDENTREGUE,
    CAIXA,
    PRECOPROD,
    DESCONTO_VALOR,
    PESOBRUTO,
    PESOLIQUIDO,
    PERDA,
    USUARIO,
    ACRESCIMOVALOR,
    FRETE,
    CODEMPRESA,
    CIDADE,
    ARE_CODIGO,
    AREA,
    CURVA,
    VALORIPI,
    CODFABRICANTE,
    CUBAGEM,
    CMV,
    CODPESQ1,
    PRECOFORNEC,
    CUSTOREPOSI,
    PRECOPRATICADO1,
    ESTQATUAL,
    BAIRRO,
    UF)
AS
select
  V.CODVENDEDOR,
  V.NOME,
  ST.CODSTATUS,
  ST.DESCRICAO,
  PE.CODPESSOA,
  PE.NOME,
  case (select VALOR from MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0))
  when 0 then
    coalesce(P.CODFATURAMENTO, P.CODNFVENDA, P.CODPEDVEND)
  else
    P.CODPEDVEND
  end,
  cast(coalesce(P.DTFATURADO,P.DT_SAIDA) as date),
  G.CODGRUPO,
  G.DESCRICAO,
  S.CODSUBGRUPO,
  S.DESCRICAO,
  PI.CODPRODFILHO,
  PF.DESCRICAO,
  coalesce(PF.UNIDADE, U.SIGLA),
  PI.QTDENTREGUE,
  PI.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1),
  PI.PRECOPROD,
  (((coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0)) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) + coalesce(PI.DESCONTO_VALOR,0)) as TOTDESCONTO,
  PF.PESOBRUTO * PI.QTDENTREGUE,
  PF.PESOLIQUIDO * PI.QTDENTREGUE,
  PI.PERDA,
  P.US_CADAST,
  (((coalesce(P.ACRESVALOR,0) + (coalesce(P.VALOR_BRUTO,0) * (coalesce(P.ACRESCIMO,0)/100))) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1)))) as TOTDESCONTO,
  (coalesce(P.FRETE,0) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) as FRETE,
  P.CODEMPRESA,
  PE.CIDADE_1,
  PE.ARE_CODIGO,
  COALESCE(TA.ARE_DESCRICAO,'AREA NÃO ASSOCIADA'),
  PF.CURVA,
  case coalesce(PE.PES_ISENTOIPI,0)
    when 0 then
      (coalesce(PI.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100))
  else
    0
  end,
  PR.CODFABRICANTE,
  (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(PI.QTDENTREGUE,0)),
  (coalesce(PF.CUSTOMEDIO,0) * coalesce(PI.QTDENTREGUE,0)),
  PF.CODPESQ1,
  PF.PRECOFORNEC,
  PF.CUSTOREPOSI,
  PF.PRECOPRATICADO1,
  PF.ESTQATUAL,
  PE.BAIRRO_1,
  PE.UF_1
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join STATUS ST on PE.CODSTATUS = ST.CODSTATUS
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join GRUPO G on PR.CODGRUPO = G.CODGRUPO
  join SUBGRUPO S on PR.CODSUBGRUPO = S.CODSUBGRUPO
  join UNIDADE U on PF.CODUNIDADE = U.CODUNIDADE
  left join TBL_AREA TA on TA.ARE_CODIGO = PE.ARE_CODIGO
where
  P.STATUSPED = 'FATURADO' and
  (P.TIPOPED in (select TIPOPED from TIPOVENDA where GERAFAT = 1) or (p.tipoped in ('VENDA', 'CADERNO')))
;



/* View: MAPAVENDAS_PEDIDOS */
CREATE OR ALTER VIEW MAPAVENDAS_PEDIDOS(
    CODVENDEDOR,
    VENDEDOR,
    CODSTATUS,
    STATUS,
    CODPESSOA,
    PESSOA,
    CODPEDVEND,
    DTFATURADO,
    CODGRUPO,
    GRUPO,
    CODSUBGRUPO,
    SUBGRUPO,
    CODPRODFILHO,
    PRODFILHO,
    UNIDADE,
    QTDENTREGUE,
    CAIXA,
    PRECOPROD,
    DESCONTO_VALOR,
    PESOBRUTO,
    PESOLIQUIDO,
    PERDA,
    USUARIO,
    ACRESCIMOVALOR,
    FRETE,
    CODEMPRESA,
    CIDADE,
    ARE_CODIGO,
    AREA,
    CURVA,
    VALORIPI,
    CODFABRICANTE,
    CUBAGEM,
    CMV,
    CODPESQ1,
    PRECOFORNEC,
    CUSTOREPOSI,
    PRECOPRATICADO1,
    ESTQATUAL,
    BAIRRO,
    UF)
AS
select
  V.CODVENDEDOR,
  V.NOME,
  ST.CODSTATUS,
  ST.DESCRICAO,
  PE.CODPESSOA,
  PE.NOME,
  case (select VALOR from MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0))
  when 0 then
    coalesce(P.CODFATURAMENTO, P.CODNFVENDA, P.CODPEDVEND)
  else
    P.CODPEDVEND
  end,
  cast(coalesce(P.DTFATURADO,P.DT_SAIDA) as date),
  G.CODGRUPO,
  G.DESCRICAO,
  S.CODSUBGRUPO,
  S.DESCRICAO,
  PI.CODPRODFILHO,
  PF.DESCRICAO,
  coalesce(PF.UNIDADE, U.SIGLA),
  PI.QTDENTREGUE,
  PI.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1),
  PI.PRECOPROD,
  (((coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0)) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) + coalesce(PI.DESCONTO_VALOR,0)) as TOTDESCONTO,
  PF.PESOBRUTO * PI.QTDENTREGUE,
  PF.PESOLIQUIDO * PI.QTDENTREGUE,
  PI.PERDA,
  P.US_CADAST,
  (((coalesce(P.ACRESVALOR,0) + (coalesce(P.VALOR_BRUTO,0) * (coalesce(P.ACRESCIMO,0)/100))) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1)))) as TOTDESCONTO,
  (coalesce(P.FRETE,0) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) as FRETE,
  P.CODEMPRESA,
  PE.CIDADE_1,
  PE.ARE_CODIGO,
  COALESCE(TA.ARE_DESCRICAO,'AREA NÃO ASSOCIADA'),
  PF.CURVA,
  (coalesce(PI.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)),
  PR.CODFABRICANTE,
  (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(PI.QTDENTREGUE,0)),
  (coalesce(PF.CUSTOMEDIO,0) * coalesce(PI.QTDENTREGUE,0)),
  PF.CODPESQ1,
  PF.PRECOFORNEC,
  PF.CUSTOREPOSI,
  PF.PRECOPRATICADO1,
  PF.ESTQATUAL,
  PE.BAIRRO_1,
  PE.UF_1
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join STATUS ST on PE.CODSTATUS = ST.CODSTATUS
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join GRUPO G on PR.CODGRUPO = G.CODGRUPO
  join SUBGRUPO S on PR.CODSUBGRUPO = S.CODSUBGRUPO
  join UNIDADE U on PF.CODUNIDADE = U.CODUNIDADE
  left join TBL_AREA TA on TA.ARE_CODIGO = PE.ARE_CODIGO
where
  P.STATUSPED <> 'CANCELADO'
;



/* View: MAPAVENDAS_PEDIDOS_NORMAIS */
CREATE OR ALTER VIEW MAPAVENDAS_PEDIDOS_NORMAIS(
    CODVENDEDOR,
    VENDEDOR,
    CODSTATUS,
    STATUS,
    CODPESSOA,
    PESSOA,
    CODPEDVEND,
    DTFATURADO,
    CODGRUPO,
    GRUPO,
    CODSUBGRUPO,
    SUBGRUPO,
    CODPRODFILHO,
    PRODFILHO,
    UNIDADE,
    QTDENTREGUE,
    CAIXA,
    PRECOPROD,
    DESCONTO_VALOR,
    PESOBRUTO,
    PESOLIQUIDO,
    PERDA,
    USUARIO,
    ACRESCIMOVALOR,
    FRETE,
    CODEMPRESA,
    CIDADE,
    ARE_CODIGO,
    AREA,
    CURVA,
    VALORIPI,
    CODFABRICANTE,
    CUBAGEM,
    CMV,
    CODPESQ1,
    PRECOFORNEC,
    CUSTOREPOSI,
    PRECOPRATICADO1,
    ESTQATUAL,
    BAIRRO,
    UF)
AS
select
  V.CODVENDEDOR,
  V.NOME,
  ST.CODSTATUS,
  ST.DESCRICAO,
  PE.CODPESSOA,
  PE.NOME,
  case (select VALOR from MLERPARAMETROLOGICO('EXIBIR APENAS O NUMERO DO PEDIDO',0))
  when 0 then
    coalesce(P.CODFATURAMENTO, P.CODNFVENDA, P.CODPEDVEND)
  else
    P.CODPEDVEND
  end,
  cast(coalesce(P.DTFATURADO,P.DT_SAIDA) as date),
  G.CODGRUPO,
  G.DESCRICAO,
  S.CODSUBGRUPO,
  S.DESCRICAO,
  PI.CODPRODFILHO,
  PF.DESCRICAO,
  coalesce(PF.UNIDADE, U.SIGLA),
  PI.QTDENTREGUE,
  PI.QTDENTREGUE / coalesce(nullif(PF.QTDEMBALAGEM,0),1),
  PI.PRECOPROD,
  (((coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0)) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) + coalesce(PI.DESCONTO_VALOR,0)) as TOTDESCONTO,
  PF.PESOBRUTO * PI.QTDENTREGUE,
  PF.PESOLIQUIDO * PI.QTDENTREGUE,
  PI.PERDA,
  P.US_CADAST,
  (((coalesce(P.ACRESVALOR,0) + (coalesce(P.VALOR_BRUTO,0) * (coalesce(P.ACRESCIMO,0)/100))) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1)))) as TOTDESCONTO,
  (coalesce(P.FRETE,0) * (coalesce(PI.PRECOVEND,0) / coalesce(nullif(P.VALOR_BRUTO,0),1))) as FRETE,
  P.CODEMPRESA,
  PE.CIDADE_1,
  PE.ARE_CODIGO,
  COALESCE(TA.ARE_DESCRICAO,'AREA NÃO ASSOCIADA'),
  PF.CURVA,
  (coalesce(PI.PRECOVEND,0) * (coalesce(PF.ALIQUOTAIPI,0)/100)),
  PR.CODFABRICANTE,
  (coalesce(PF.PRDF_CUBAGEM,0) * coalesce(PI.QTDENTREGUE,0)),
  (coalesce(PF.CUSTOMEDIO,0) * coalesce(PI.QTDENTREGUE,0)),
  PF.CODPESQ1,
  PF.PRECOFORNEC,
  PF.CUSTOREPOSI,
  PF.PRECOPRATICADO1,
  PF.ESTQATUAL,
  PE.BAIRRO_1,
  PE.UF_2
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join STATUS ST on PE.CODSTATUS = ST.CODSTATUS
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join GRUPO G on PR.CODGRUPO = G.CODGRUPO
  join SUBGRUPO S on PR.CODSUBGRUPO = S.CODSUBGRUPO
  join UNIDADE U on PF.CODUNIDADE = U.CODUNIDADE
  left join TBL_AREA TA on TA.ARE_CODIGO = PE.ARE_CODIGO
where
  P.STATUSPED = 'NORMAL' and
  P.TIPOPED in ('VENDA', 'CADERNO')
;



/* View: MARFIM_SLCADSET_TOTAIS */
CREATE OR ALTER VIEW MARFIM_SLCADSET_TOTAIS(
    CODSET,
    VENDAS,
    PEDIDOS,
    ATENDIDOS,
    ULTVENDA,
    FLEX,
    FLEXPERC,
    VENDAUNID)
AS
select
  RIGHT('00000000' || cast(P.CODVENDEDOR as varchar(6)), 4),
  coalesce(sum(PI.PRECOVEND),0),
  coalesce(count(distinct P.CODPEDVEND),0),
  coalesce(count(distinct P.CODPESSOA),0),
  max(cast(DTFATURADO as date)) ,
  (coalesce(sum(PI.QTDE*PI.PRECOPROD),0)) - (coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)),
--  ((coalesce(sum(PI.QTDE*PI.PRECOPROD),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  (((coalesce(sum(PI.PRECOVEND),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  coalesce(sum(PI.QTDE),0) as LITROS
from
  PEDVEND P
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA','CADERNO') and
  cast(P.DTFATURADO as date) between '26.12.2012' and '25.01.2013'
group by
  1
;



/* View: MET_META */
CREATE OR ALTER VIEW MET_META(
    MET_META_MENSAL,
    MET_ANO,
    MET_MES,
    MET_CD_VENDEDOR_IMPORT,
    MET_CD_PROD_DIS,
    MET_CD_META_IMPORT)
AS
SELECT 
  VENDEDORMETAS.QTD AS MET_META_MENSAL,
  extract(year from VENDEDORMETAS.INICIO) AS MET_ANO,
  extract(month from VENDEDORMETAS.INICIO) AS MET_MES,
  VENDEDORMETAS.CODVENDEDOR AS MET_CD_VENDEDOR_IMPORT,
  VENDEDORMETAS.CODPRODFILHO AS MET_CD_PROD_DIS,
  VENDEDORMETAS.CODIGO AS MET_CD_META_IMPORT
FROM
 VENDEDORMETAS
;



/* View: MOV_MOVIMENTACAO */
CREATE OR ALTER VIEW MOV_MOVIMENTACAO(
    MOV_CD_MOVIMENTACAO_IMPORT,
    MOV_DESCRICAO)
AS
SELECT
  SUBSTRING(AJUSTESTOQ.TIPO FROM 1 FOR 1) AS MOV_CD_MOVIMENTACAO_IMPORT,
  AJUSTESTOQ.TIPO AS MOV_DESCRICAO
FROM
 AJUSTESTOQ
WHERE TIPO <> 'INVENTÁRIO'
GROUP BY TIPO
;



/* View: MSLCADPRO */
CREATE OR ALTER VIEW MSLCADPRO(
    CODPRO,
    DTCADPRO,
    DESCPRO,
    CODGRU,
    REF_FABR,
    PROMOCAO,
    PROATIINA,
    ULTREAVDA,
    PREVENDA,
    PRECOANT,
    SALDESTOQ,
    PRECO_UNIT,
    QTDEMBALAGEM,
    FATORCONVERSAO,
    CODFAB,
    DESCONTDESEJ,
    PRECO_PROMOCAO,
    FATOR,
    TRAVA_FRACIONADO,
    QTDEMB)
AS
select
RIGHT('00000' || cast(PF.CODPRODFILHO as varchar(6)) ,6) as CODPRODFILHO,
cast(coalesce(PF.DT_CADAST,'01.01.2007') as timestamp),
PF.DESCRICAO,
RIGHT('00000' || cast(PD.CODGRUPO as varchar(6)) ,6) as CODGRUPO,
coalesce(PF.UNIDADE, UN.SIGLA),
PF.PROMOCAO,
case PD.ATIVO
when 1 then 'I'
when 2 then 'A'
end as ATIVO,
coalesce((select max(cast(DT_ATUALIZACAO as date)) from MODIFIPRECO WHERE CODPRODFILHO = PF.CODPRODFILHO),cast('01.01.06' as date)),
PF.PRECOPRATICADO1,
coalesce((select FIRST 1 ULTIMOPRECO from MODIFIPRECO WHERE CODPRODFILHO = PF.CODPRODFILHO order by DT_ATUALIZACAO DESC),1),
(PF.ESTQATUAL - coalesce(PF.ESTOQANALISE,0)),
(PF.PRECOPRATICADO1 / coalesce(nullif(PF.QTDEMBALAGEM,0),1)),
coalesce(nullif(PF.QTDEMBALAGEM,0),1),
coalesce(nullif(PF.FATORCONVERSAO,0),1),
right('00000' || cast(pd.codfabricante as varchar(6)) ,6) as CODFABRICANTE,
PF.descontdesej,
coalesce((
select first 1 PROMOCAOITEM.PRECOPRATICADO1
   from PROMOCAOITEM
   inner join PROMOCAO on PROMOCAO.CODPROMOCAO = PROMOCAOITEM.CODPROMOCAO_FK
   where PROMOCAOITEM.CODPRODFILHO_FK = PF.CODPRODFILHO
   order by PROMOCAOITEM.CODPROMOCAOITEM desc

),0),
coalesce((
select first 1 PROMOCAOITEM.FATOR1
   from PROMOCAOITEM
   inner join PROMOCAO on PROMOCAO.CODPROMOCAO = PROMOCAOITEM.CODPROMOCAO_FK
   where PROMOCAOITEM.CODPRODFILHO_FK = PF.CODPRODFILHO
   order by PROMOCAOITEM.CODPROMOCAOITEM desc

),0),
coalesce(pf.QTD_MULTIPLA,'N'),
coalesce(nullif(PF.QTDEMBALAGEM,0),1)
from
PRODFILHO PF
join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
join UNIDADE UN on (PF.CODUNIDADE = UN.CODUNIDADE)
where pd.ativo = 2
;



/* View: MSLCADPRO_OLD */
CREATE OR ALTER VIEW MSLCADPRO_OLD(
    CODPRO,
    DTCADPRO,
    DESCPRO,
    CODGRU,
    REF_FABR,
    PROMOCAO,
    PROATIINA,
    ULTREAVDA,
    PREVENDA,
    PRECOANT,
    SALDESTOQ,
    CODFABRICANTE)
AS
SELECT RIGHT('00000000' || CAST(PF.CODPESQ1 AS VARCHAR(6)) ,6) AS CODPRODFILHO,
       CAST(PF.DT_CADAST AS DATE),
       PF.DESCRICAO,
       RIGHT('00000000' || CAST(PD.CODGRUPO AS VARCHAR(6)) ,3) AS CODGRUPO,
       UN.SIGLA,
       PF.PROMOCAO,
       CASE PD.ATIVO
       WHEN 1 THEN 'I'
       WHEN 2 THEN 'A' END AS ATIVO,
       CAST('01.01.2006' AS DATE),
       PF.PRECOPRATICADO1,
       1,
       PF.ESTQATUAL,
       PD.CODFABRICANTE
       FROM PRODFILHO PF
       INNER JOIN PRODUTO PD ON (PD.CODPRODUTO = PF.CODPRODUTO)
       INNER JOIN UNIDADE UN ON (PF.CODUNIDADE = UN.CODUNIDADE)
;



/* View: MSTATUSPED */
CREATE OR ALTER VIEW MSTATUSPED(
    STATUSPED)
AS
select distinct
 ''''||STATUSPED||''''
from
PEDVEND
;



/* View: MTIPOSPESSOA */
CREATE OR ALTER VIEW MTIPOSPESSOA(
    TIPOPESSOA)
AS
select distinct
 '''' || PESSOA.TIPOPESSOA || ''''
from  
  PESSOA
;



/* View: NOF_NOTA_FISCAL */
CREATE OR ALTER VIEW NOF_NOTA_FISCAL(
    NOF_DESCRICAO,
    NOF_DT_NOTA,
    NOF_CD_NOTA_IMPORT,
    NOF_CD_MOVIMENTACAO_IMPORT,
    NOF_CD_EMP_DEST_IMPORT,
    NOF_CD_EMP_EMIS_IMPORT)
AS
SELECT
  'ARQUIVOS DE SAIDA   ' AS NOF_DESCRICAO,
  PEDVEND.DT_SAIDA AS NOF_DT_NOTA,
  CAST('S' || PEDVEND.CODPEDVEND AS VARCHAR(17)) AS NOF_CD_NOTA_IMPORT,
  'S' AS NOF_CD_MOVIMENTACAO_IMPORT,
  PEDVEND.CODPESSOA AS NOF_CD_EMP_DEST_IMPORT,
  (SELECT CODPESSOA FROM PESSOA WHERE CODSTATUS = 2)  AS NOF_CD_EMP_EMIS_IMPORT
FROM
 PEDVEND
UNION
SELECT
  'ARQUIVOS DE ENTRADA ' AS NOF_DESCRICAO,
  AJUSTESTOQ.DT_AJUST AS NOF_DT_NOTA,
  CAST('E' || AJUSTESTOQ.CODAJUSTESTOQ AS VARCHAR(17)) AS NOF_CD_NOTA_IMPORT,
  'E' AS NOF_CD_MOVIMENTACAO_IMPORT,
  AJUSTESTOQ.CODPESSOA AS NOF_CD_EMP_DEST_IMPORT,
 (SELECT CODPESSOA FROM PESSOA WHERE CODSTATUS = 2)  AS NOF_CD_EMP_EMIS_IMPORT
FROM
 AJUSTESTOQ
WHERE AJUSTESTOQ.TIPO = 'ENTRADA'
;



/* View: PAGARACUMULADO */
CREATE OR ALTER VIEW PAGARACUMULADO(
    DT_VENCIMENTO,
    VALOR_LIQ,
    CODSTATUS,
    TOTPAGO,
    CODCONTA)
AS
SELECT Conta.DT_VENCIM, Conta.VLPARCELA, PESSOA.CODSTATUS, Conta.TOTPAGO, Conta.CODCONTA
   FROM CONTA
   INNER JOIN PESSOA ON (CONTA.CODPESSOA = PESSOA.CODPESSOA)
   WHERE (Conta.TIPO = 'PAGAR')
   AND  (Conta.STATUS = 'ABERTO')
;



/* View: PEDIDOS_CANCELADOS */
CREATE OR ALTER VIEW PEDIDOS_CANCELADOS(
    NRFORMULARIO,
    MOTIVO1,
    MOTIVO2,
    CLIENTE,
    CODSET,
    CODCLI,
    DTCANCELA,
    VALOR_TOTAL,
    NUMERO_PEDIDO,
    TIPO)
AS
select
  PEDVEND.NRFORMULARIO,
  COALESCE(NFVENDA.OBSCANC1, PEDVEND.OBS1) AS OBS1,
  COALESCE(NFVENDA.OBSCANC2, PEDVEND.OBS2) AS OBS2,
  PESSOA.NOME,
  RIGHT('00000000' || cast(PEDVEND.CODVENDEDOR as varchar(6)), 4) AS CODVENDEDOR,
  RIGHT('00000000' || cast(PESSOA.CODPESSOA as varchar(6)), 6) AS CODPESSOA,
  PEDVEND.DTCANCELA,
  PEDVEND.VALOR_TOTAL,
  COALESCE(PEDVEND.CODNFVENDA, PEDVEND.CODPEDVEND) NRDOC,
  CASE COALESCE(PEDVEND.CODNFVENDA, 'P')
    WHEN 'P' THEN 'P'
    ELSE 'N' END AS TIPO
from
  PEDVEND
  join PESSOA on (PEDVEND.CODPESSOA = PESSOA.CODPESSOA)
  LEFT JOIN NFVENDA ON (PEDVEND.CODPEDVEND = NFVENDA.CODPEDVEND)
where
  STATUSPED = 'CANCELADO'
  and pedvend.dt_saida >= current_date - 30
;



/* View: PEDIDOS_FATURADOS_COM_CORTE */
CREATE OR ALTER VIEW PEDIDOS_FATURADOS_COM_CORTE(
    CODPEDVEND,
    NRFORMULARIO,
    CLIENTE,
    CODSET,
    CODCLI,
    CODPRODFILHO,
    DESCRICAO,
    QTDE,
    VALOR_TOTAL,
    NUMERO_PEDIDO,
    TIPO)
AS
select
  PEDVEND.CODPEDVEND,
  PEDVEND.NRFORMULARIO,
  PESSOA.NOME,
  RIGHT('00000000' || cast(PEDVEND.CODVENDEDOR as varchar(6)), 4) as CODVENDEDOR,
  RIGHT('00000000' || cast(PESSOA.CODPESSOA as varchar(6)), 6) as CODPESSOA,
  PRODFILHO.CODPRODFILHO,
  PRODFILHO.DESCRICAO,
  PEDVENDITEM_CORTADOS.QTDE,
  PEDVEND.VALOR_TOTAL,
  coalesce(PEDVEND.CODNFVENDA, PEDVEND.CODPEDVEND) NRDOC,
  case coalesce(PEDVEND.CODNFVENDA, 'P')
    when 'P' then 'P'
  else 'N' end as TIPO
from
  PEDVEND
  join PEDVENDITEM_CORTADOS on (PEDVEND.CODPEDVEND = PEDVENDITEM_CORTADOS.CODPEDVEND)
  join PRODFILHO on (PRODFILHO.CODPRODFILHO=PEDVENDITEM_CORTADOS.CODPRODFILHO)
  join PESSOA on (PEDVEND.CODPESSOA = PESSOA.CODPESSOA)
where
  STATUSPED = 'FATURADO'
  and PEDVEND.DT_SAIDA between current_date - 5 and current_date
;



/* View: PEDVENDVIEW */
CREATE OR ALTER VIEW PEDVENDVIEW(
    CODPEDVEND,
    CODNFVENDA,
    STATUSPED,
    TIPOPED,
    CODPESSOA,
    NOME,
    CODVENDEDOR,
    VENDEDOR,
    DT_SAIDA,
    VALOR_BRUTO,
    VALOR_TOTAL,
    NRFORMULARIO,
    CODEMBARQUE,
    PDV_NUMEROPEDCLI,
    FINANC,
    ACRESCIMO,
    ACRESVALOR,
    DESCONTO,
    DESC_VALOR,
    FRETE,
    MONTAGEM,
    PERC_FRETE,
    CODEMPRESA)
AS
select
  P.CODPEDVEND,
  coalesce(P.CODFATURAMENTO, P.CODNFVENDA) CODNFVENDA,
  case P.STATUSPED
    when 'NORMAL' then
      case P.PDV_CRITICA
        when 'C' then 'BLOQUEADO'
        when 'B' then 'NORMAL'
      else
        'LIBERADO'
      end
  else
    P.STATUSPED
  end STATUSPED,
  P.TIPOPED,
  P.CODPESSOA,
  PE.NOME,
  V.CODVENDEDOR,
  V.NOME,
  P.DT_SAIDA,
  P.valor_bruto ,
  P.VALOR_TOTAL,
  NRFORMULARIO,
  E.CODEMBARQUE_FK,
  P.PDV_NUMEROPEDCLI,
  coalesce(P.FINANC, 'N'),
  coalesce(P.ACRESCIMO, 0),
  coalesce(P.ACRESVALOR, 0),
  coalesce(P.DESCONTO, 0),
  coalesce(P.DESC_VALOR, 0),
  P.FRETE,
  P.MONTAGEM, 
  P.PERC_FRETE,
  P.CODEMPRESA
from
  PEDVEND P
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  left join EMBARQUEITEM E on P.CODPEDVEND = E.CODPEDVEND_FK
;



/* View: PESQ_CARACTER */
CREATE OR ALTER VIEW PESQ_CARACTER(
    DESCRICAO,
    CODCARACTER)
AS
select distinct '''' || DESCRICAO || '''',CODCARACTER from caracter
;



/* View: PESQ_CONTAS */
CREATE OR ALTER VIEW PESQ_CONTAS(
    CODNFVENDA,
    TIPO,
    NRDOCUMENTO,
    DT_EMISSAO,
    DT_VENCIM,
    VLPARCELA,
    CODPESSOA,
    NOME,
    NRFORMULARIO,
    CPFCGC,
    NUMERO,
    STATUS,
    CODPENDVEND,
    CODCONTA,
    NRDOCUMENTO_BOLETO,
    NRDOCUMENTO_DV)
AS
select
  coalesce(CONTA.CODNFVENDA,0) CODNFVENDA,
  CONTA.TIPO,
  CONTA.NRDOCUMENTO,
  CONTA.DT_EMISSAO,
  CONTA.DT_VENCIM,
  CONTA.VLPARCELA,
  CONTA.CODPESSOA,
  PESSOA.NOME,
  CONTA.NRFORMULARIO,
  PESSOA.CPFCGC,
  CONTA.NUMERO,
  CONTA.STATUS,
  CONTA.CODPENDVEND,
  CONTA.CODCONTA,
  CONTA.NRDOCUMENTO_BOLETO,
  CONTA.NRDOCUMENTO_DV
from
  CONTA
  inner join PESSOA on (CONTA.CODPESSOA = PESSOA.CODPESSOA)
;



/* View: PESQ_EMPRESTIMO */
CREATE OR ALTER VIEW PESQ_EMPRESTIMO(
    CODEMPRES,
    STATUS,
    TIPO,
    MOTIVO,
    PESSOA,
    DT_EMP,
    DT_DEV,
    NRDOCUMENTO,
    OBS1,
    OBS2,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    CODVENDEDOR,
    NOMEVENDEDOR,
    CODPESSOA,
    RAZAOSOCIAL,
    NOMEFANTAZIA,
    CODVEICULO,
    NOME_MOTORISTA,
    DESPESAS_VIAGEM,
    VLR_FRETE,
    OBS_1,
    OBS_2,
    CODPEDVEND)
AS
SELECT
   EMPRES.CODEMPRES,
   EMPRES.STATUS,
   EMPRES.TIPO,
   EMPRES.MOTIVO,
   EMPRES.PESSOA,
   EMPRES.DT_EMP,
   EMPRES.DT_DEV,
   EMPRES.NRDOCUMENTO,
   EMPRES.OBS1,
   EMPRES.OBS2,
   EMPRES.US_CADAST,
   EMPRES.DT_CADAST,
   EMPRES.US_MODIFI,
   EMPRES.DT_MODIFI,
   EMPRES.CODVENDEDOR,
   VENDEDOR.NOME NOMEVENDEDOR,
   EMPRES.CODPESSOA,
   PESSOA.NOME RAZAOSOCIAL,
   PESSOA.NOMEFANTAZIA,
   EMPRES.CODVEICULO,
   EMPRES.NOME_MOTORISTA,
   EMPRES.DESPESAS_VIAGEM,
   EMPRES.VLR_FRETE,
   EMPRES.OBS_1,
   EMPRES.OBS_2,
   EMPRES.CODPEDVEND
FROM
   EMPRES
   INNER JOIN PESSOA ON (EMPRES.CODPESSOA = PESSOA.CODPESSOA)
   INNER JOIN VENDEDOR ON (EMPRES.CODVENDEDOR = VENDEDOR.CODVENDEDOR)
;



/* View: PESQ_FUNCAO */
CREATE OR ALTER VIEW PESQ_FUNCAO(
    CODFUNCAO,
    NOME)
AS
select
  CODFUNCAO,
  NOME
from
  TBL_FUNCAO
;



/* View: PESQ_SETOR */
CREATE OR ALTER VIEW PESQ_SETOR(
    COD_SETOR,
    DESCRICAO,
    COD_GRUPO,
    GRUPO,
    QTD_FUNCIONARIO,
    OBS,
    SETOR_ENCERRAMENTO)
AS
select
  TBL_SETOR.COD_SETOR,
  TBL_SETOR.DESCRICAO,
  TBL_SETOR.COD_GRUPO,
  GRUPO.DESCRICAO GRUPO,
  TBL_SETOR.QTD_FUNCIONARIO,
  TBL_SETOR.OBS,
  TBL_SETOR.SETOR_ENCERRAMENTO
from
  TBL_SETOR
  join GRUPO on TBL_SETOR.COD_GRUPO = GRUPO.CODGRUPO
;



/* View: PESQ_FUNCIONARIO */
CREATE OR ALTER VIEW PESQ_FUNCIONARIO(
    FUNC_COD,
    NOME,
    COD_SETOR,
    SETOR,
    COD_GRUPO,
    GRUPO,
    CODFUNCAO,
    FUNCAO,
    ENDERECO,
    BAIRRO,
    CIDADE,
    UF,
    CEP,
    FONE,
    EMAIL,
    DATA_NASC)
AS
select
  FUNCIONARIO.FUNC_COD,
  FUNCIONARIO.NOME,
  FUNCIONARIO.COD_SETOR,
  PESQ_SETOR.DESCRICAO SETOR,
  PESQ_SETOR.COD_GRUPO,
  PESQ_SETOR.GRUPO,
  FUNCIONARIO.CODFUNCAO,
  TBL_FUNCAO.NOME FUNCAO,
  FUNCIONARIO.ENDERECO,
  FUNCIONARIO.BAIRRO,
  FUNCIONARIO.CIDADE,
  FUNCIONARIO.UF,
  FUNCIONARIO.CEP,
  FUNCIONARIO.FONE,
  FUNCIONARIO.EMAIL,
  FUNCIONARIO.DATA_NASC
from
  FUNCIONARIO
  join PESQ_SETOR on FUNCIONARIO.COD_SETOR = PESQ_SETOR.COD_SETOR
  join TBL_FUNCAO on  FUNCIONARIO.CODFUNCAO = TBL_FUNCAO.CODFUNCAO
;



/* View: PESQ_GRUPO */
CREATE OR ALTER VIEW PESQ_GRUPO(
    CODGRUPO,
    DESCRICAO)
AS
select
  G.CODGRUPO,
  G.DESCRICAO
from
  GRUPO G
;



/* View: PESQ_PEDCPR */
CREATE OR ALTER VIEW PESQ_PEDCPR(
    CODPEDCPR,
    STATUS,
    DT_EMISSAO,
    CODPESSOA,
    NOME,
    VALORITEM)
AS
SELECT
  PEDCPR.CODPEDCPR,
  PEDCPR.STATUS,
  PEDCPR.DT_EMISSAO,
  PEDCPR.CODPESSOA,
  PESSOA.NOME,
  SUM(PEDCPRITENS.VALORITEM) VALORITEM
FROM
  PEDCPR
  INNER JOIN PESSOA ON PESSOA.CODPESSOA = PEDCPR.CODPESSOA
  INNER JOIN PEDCPRITENS ON (PEDCPRITENS.CODPEDCPR = PEDCPR.CODPEDCPR)
WHERE
  PEDCPR.STATUS = 'NORMAL'
GROUP BY
  1,2,3,4,5
;



/* View: PESQ_PEDVEND */
CREATE OR ALTER VIEW PESQ_PEDVEND(
    CODPEDVEND,
    STATUSPED,
    TIPOPED,
    CODPESSOA,
    PESSOA,
    CODVENDEDOR,
    VENDEDOR,
    DT_SAIDA,
    VALOR_BRUTO,
    VALOR_TOTAL)
AS
select
  PEDVEND.CODPEDVEND,
  PEDVEND.STATUSPED,
  PEDVEND.TIPOPED,
  PEDVEND.CODPESSOA,
  PESSOA.NOME PESSOA,
  VENDEDOR.CODVENDEDOR,
  VENDEDOR.NOME VENDEDOR,
  PEDVEND.DT_SAIDA,
  PEDVEND.VALOR_BRUTO,
  PEDVEND.VALOR_TOTAL
from
  PEDVEND
  INNER JOIN PESSOA on(PEDVEND.CODPESSOA = PESSOA.CODPESSOA)
  INNER JOIN VENDEDOR on(PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR)
;



/* View: PESQ_SETORVINCULADO */
CREATE OR ALTER VIEW PESQ_SETORVINCULADO(
    COD_SETOR,
    SETOR,
    COD_VINCULADO,
    VINCULADO,
    QTD_FUNCIONARIO)
AS
select
  TSV.COD_SETOR,
  TSVS.DESCRICAO,
  TS.COD_SETOR,
  TS.DESCRICAO,
  TS.QTD_FUNCIONARIO
from
  TBL_SETOR TS
  join TBL_SETOR_VINCULO TSV on TS.COD_SETOR = TSV.COD_SETOR_VINCULO
  join TBL_SETOR TSVS on TSV.COD_SETOR = TSVS.COD_SETOR
;



/* View: PESQ_SUBSETOR */
CREATE OR ALTER VIEW PESQ_SUBSETOR(
    COD_SUB_SETOR,
    DESCRICAO,
    QTD_FUNCIONARIO,
    OBS)
AS
select
  TBL_SUB_SETOR.COD_SUB_SETOR,
  TBL_SUB_SETOR.DESCRICAO,
  TBL_SUB_SETOR.QTD_FUNCIONARIO,
  TBL_SUB_SETOR.OBS
from
  TBL_SUB_SETOR
;



/* View: PESQ_TIPOMAQUINA */
CREATE OR ALTER VIEW PESQ_TIPOMAQUINA(
    CODMAQUINA,
    DESCRICAO,
    EFICIENCIA,
    REFERENCIA)
AS
select
  CODMAQUINA,
  DESCRICAO,
  EFICIENCIA,
  REFERENCIA
from
  TBL_TIPOMAQUINA
;



/* View: PESQ_UNIDADE */
CREATE OR ALTER VIEW PESQ_UNIDADE(
    CODUNIDADE,
    SIGLA,
    DESCRICAO)
AS
select
  CODUNIDADE,
  SIGLA,
  DESCRICAO
from
  UNIDADE
;



/* View: PESQCUPOM */
CREATE OR ALTER VIEW PESQCUPOM(
    CODCUPOM,
    CUPOM,
    EMISSAO,
    ACRESVALOR,
    DESC_VALOR,
    VALOR_TOTAL,
    VALOR_LIQUIDO)
AS
select
  CODCUPOM,
  (cast(coalesce(nullif(ECF,''),0) as integer)||'-'||cast(coalesce(nullif(COO,''),0) as integer)) CUPOM,
  EMISSAO,
  coalesce(ACRESVALOR,0),
  coalesce(DESC_VALOR,0),
  VALOR_TOTAL,
  (VALOR_TOTAL + coalesce(ACRESVALOR,0) - coalesce(DESC_VALOR,0))
from
  CUPOM
where
  CODNFVENDA is null and STATUSCUPOM = 0 and
  CODEMPRESA = (select
                  E.CODEMPRESA
                from
                  EMPRESA E
                  join SYSPARAMS S on E.CGC = S.CGC)
;



/* View: PESSOA_ARQUITETO */
CREATE OR ALTER VIEW PESSOA_ARQUITETO(
    CODPESSOA,
    PESSOA,
    CPFCGC,
    CODSTATUS,
    NOME,
    COMISVENDEDOR,
    RG,
    DT_NASC,
    SEXO,
    FONES,
    CELULAR,
    EMAIL,
    HOMEPAGE,
    PAI,
    MAE,
    LOGRADOURO_1,
    COMPLEMENTO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    LOGRADOURO_2,
    COMPLEMENTO_2,
    BAIRRO_2,
    CIDADE_2,
    UF_2,
    CEP_2,
    US_CADAST,
    US_MODIFI,
    DT_CADAST,
    DT_MODIFI,
    TIPOPESSOA,
    ATIVO,
    ROTEIROENTREGA,
    CODTIPOPAG,
    BANCO,
    AGENCIA,
    CONTA,
    TIPOCONTA,
    TIP_TIPO)
AS
select
  CODPESSOA,
  PESSOA,
  CPFCGC,
  CODSTATUS,
  NOME,
  COMISVENDEDOR,
  RG,
  DT_NASC,
  SEXO,
  FONES,
  CELULAR,
  EMAIL,
  HOMEPAGE,
  PAI,
  MAE,
  LOGRADOURO_1,
  COMPLEMENTO_1,
  BAIRRO_1,
  CIDADE_1,
  UF_1,
  CEP_1,
  LOGRADOURO_2,
  COMPLEMENTO_2,
  BAIRRO_2,
  CIDADE_2,
  UF_2,
  CEP_2,
  US_CADAST,
  US_MODIFI,
  DT_CADAST,
  DT_MODIFI,
  TIPOPESSOA,
  ATIVO,
  ROTEIROENTREGA,
  CODTIPOPAG,
  BANCO,
  AGENCIA,
  CONTA,
  TIPOCONTA,
  TIP_TIPO
from
  PESSOA
where
  TIPOPESSOA = 'Arquiteto'
;



/* View: PESSOA_STATUS */
CREATE OR ALTER VIEW PESSOA_STATUS(
    CODSTATUS,
    DESCRICAO)
AS
select distinct pessoa.CODSTATUS, STATUS.DESCRICAO from PESSOA
inner join STATUS on (PESSOA.CODSTATUS = STATUS.CODSTATUS)
;



/* View: PESSOA_VENDEDORAGENDAPALM */
CREATE OR ALTER VIEW PESSOA_VENDEDORAGENDAPALM(
    CODPESSOA,
    CODVENDEDOR,
    DTPREVISTO)
AS
select
  P.CODPESSOA,
  V.CODVENDEDOR,
  PVA.DTPREVISTO
from
  PESSOA_VENDEDORAGENDA PVA
  join PESSOA_VENDEDOR PV on PVA.CODPESSOA_VENDEDOR = PV.CODPESSOA_VENDEDOR
  join VENDEDOR V on V.CODVENDEDOR = PV.CODVENDEDOR
  join PESSOA P on PV.CODPESSOA = P.CODPESSOA
where
  PVA.STATUS = 'A VISITAR'
;



/* View: PESSOAVIEW */
CREATE OR ALTER VIEW PESSOAVIEW(
    CODPESSOA,
    NOME,
    CPFCGC,
    UF_1)
AS
SELECT Pessoa.codpessoa, pessoa.nome, PESSOA.CPFCGC,PESSOA.UF_1
FROM PESSOA
;



/* View: PRECO */
CREATE OR ALTER VIEW PRECO(
    CODPRODFILHO,
    PRECOPRATICADO1,
    PRECOPRATICADO2,
    PRECOPRATICADO3,
    PRECOPRATICADO4,
    PRECOPRATICADO5,
    PRECOPRATICADO6)
AS
select
  CODPRODFILHO, PRECOPRATICADO1, PRECOPRATICADO2, PRECOPRATICADO3, PRECOPRATICADO4, PRECOPRATICADO5, PRECOPRATICADO6
from
  PRODFILHO
    INNER JOIN PRODUTO ON (PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO)
where PRODUTO.ATIVO = 2
;



/* View: PRO_PRODUTO */
CREATE OR ALTER VIEW PRO_PRODUTO(
    DESCRICAO,
    FATORCONVERSAO,
    PRECOPRATICADO1,
    CODPESQ1,
    CODPRODFILHO)
AS
SELECT
  PRODFILHO.DESCRICAO AS PRO_DESCRICAO,
  PRODFILHO.FATORCONVERSAO AS PRO_VALOR_FACE,
  PRODFILHO.PRECOPRATICADO1 AS PRO_VALOR_VENDA,
  PRODFILHO.CODPESQ1 AS PRO_CD_PROD_TIM,
  PRODFILHO.CODPRODFILHO AS PRO_CD_PROD_DIS
FROM
 PRODUTO
 INNER JOIN PRODFILHO ON (PRODUTO.CODPRODUTO=PRODFILHO.CODPRODUTO)
WHERE
  (PRODUTO.CODGRUPO = 3)
;



/* View: PRODFILHOVIEW */
CREATE OR ALTER VIEW PRODFILHOVIEW(
    CODPRODFILHO,
    DESCRICAO,
    ESTQATUAL,
    PRECOPRATICADO1)
AS
SELECT PRODFILHO.CODPRODFILHO, PRODFILHO.DESCRICAO, PRODFILHO.ESTQATUAL, PRODFILHO.PRECOPRATICADO1
FROM PRODFILHO
;



/* View: PRODFILHOVIEW_GRADE */
CREATE OR ALTER VIEW PRODFILHOVIEW_GRADE(
    CODPRODFILHO,
    CODPESQ2,
    CODPESQ3,
    DESCRICAO)
AS
SELECT
   PRODFILHO.CODPRODFILHO,PRODFILHO.CODPESQ2,PRODFILHO.CODPESQ3,PRODFILHO.DESCRICAO
FROM PRODFILHO
;



/* View: PRODUTOS_CODPESQ1 */
CREATE OR ALTER VIEW PRODUTOS_CODPESQ1(
    CODPESQ1,
    DESCRICAO)
AS
select '''' || CODPESQ1 || '''', DESCRICAO from PRODFILHO
;



/* View: RECEBEABERTO */
CREATE OR ALTER VIEW RECEBEABERTO(
    DT_EMISSAO,
    NRDOCUMENTO,
    PARCELA,
    DT_VENCIMENTO,
    VALOR_PARC,
    NOME,
    TIPOPAG,
    CARTAOCRED,
    DESCRICAO,
    CODSTATUS,
    TOTPAGO,
    NUMERO,
    CODPESSOA,
    CODCONTA,
    CART_VALOR,
    FONES,
    CONT_CUSTAS,
    CODNFVENDA,
    OBSERVACOES,
    NOMEFANTAZIA,
    CODVENDEDOR,
    UF,
    TOTJUROS,
    TOTDESCONTO,
    STATUS)
AS
select
  CONTA.DT_EMISSAO,
  CONTA.NRDOCUMENTO,
  CONTA.PARCELA,
  CONTA.DT_VENCIM,
  CONTA.VLPARCELA,
  PESSOA.NOME,
  CONTA.PREV_TIPOPAG as TIPOPAG,
  CARTAOCRED.DESCRICAO as CARTAOCRED,
  CONTA.DESCRICAO,
  PESSOA.CODSTATUS,
  coalesce(CONTA.TOTPAGO,0),
  CONTA.NUMERO,
  CONTA.CODPESSOA,
  CONTA.CODCONTA,
  CONTA.CART_VALOR,
  PESSOA.FONES,
  CONTA.CONT_CUSTAS,
  CONTA.CODNFVENDA,
  coalesce(coalesce(Conta.OBS1,'') || ' ' || coalesce(Conta.OBS2,''), '') as OBSERVACOES,
  PESSOA.NOMEFANTAZIA,
  CONTA.CODVENDEDOR,
  PESSOA.UF_1,
  coalesce(CONTA.TOTJUROS,0),
  coalesce(CONTA.TOTDESCONTO,0),
  CONTA.STATUS
from
  CONTA
  left join PESSOA on
    CONTA.CODPESSOA = PESSOA.CODPESSOA
  left join CARTAOCRED on
    CARTAOCRED.CODCARTAOCRED = CONTA.CODCARTAO
where
   CONTA.TIPO   = 'RECEBER' and
   CONTA.STATUS = 'ABERTO'
;



/* View: RECEBIQUITADO */
CREATE OR ALTER VIEW RECEBIQUITADO(
    DT_EMISSAO,
    NRDOCUMENTO,
    PARCELA,
    DT_VENCIMENTO,
    VALOR_PARC,
    NOME,
    TIPOPAG,
    CARTAOCRED,
    DESCRICAO,
    CODSTATUS,
    TOTPAGO,
    NUMERO,
    CODPESSOA,
    CODCONTA,
    CART_VALOR,
    FONES,
    CONT_CUSTAS,
    CODNFVENDA,
    OBSERVACOES,
    NOMEFANTAZIA,
    CODVENDEDOR,
    UF,
    TOTJUROS,
    TOTDESCONTO,
    STATUS)
AS
select
  CONTA.DT_EMISSAO,
  CONTA.NRDOCUMENTO,
  CONTA.PARCELA,
  CONTA.DT_VENCIM,
  CONTA.VLPARCELA,
  PESSOA.NOME,
  CONTA.PREV_TIPOPAG as TIPOPAG,
  CARTAOCRED.DESCRICAO as CARTAOCRED,
  CONTA.DESCRICAO,
  PESSOA.CODSTATUS,
  CONTA.TOTPAGO,
  CONTA.NUMERO,
  CONTA.CODPESSOA,
  CONTA.CODCONTA,
  CONTA.CART_VALOR,
  PESSOA.FONES,
  CONTA.CONT_CUSTAS,
  CONTA.CODNFVENDA,
  coalesce(coalesce(Conta.OBS1,'') || ' ' || coalesce(Conta.OBS2,''), '') as OBSERVACOES,
  PESSOA.NOMEFANTAZIA,
  CONTA.CODVENDEDOR,
  PESSOA.UF_1,
  coalesce(CONTA.TOTJUROS,0),
  coalesce(CONTA.TOTDESCONTO,0),
  CONTA.STATUS
from
  CONTA
  left join PESSOA on
    CONTA.CODPESSOA = PESSOA.CODPESSOA
  left join CARTAOCRED on
    CARTAOCRED.CODCARTAOCRED = CONTA.CODCARTAO
where
  CONTA.TIPO   = 'PAGAR' and
  CONTA.STATUS = 'ABERTO'
;



/* View: SEP_SEGMENTACAO_PDV */
CREATE OR ALTER VIEW SEP_SEGMENTACAO_PDV(
    SEP_CD_SEGMENTACAO_PDV,
    SEP_CD_SEGMENTACAO_TIM,
    SEP_DESCRICAO)
AS
SELECT 
  TBL_RAMOATVTIPO.CODTIPO AS SEP_CD_SEGMENTACAO_PDV,
  TBL_RAMOATVTIPO.REFERENCIA AS SEP_CD_SEGMENTACAO_TIM,
  TBL_RAMOATVTIPO.DESCRICAO AS SEP_DESCRICAO
FROM
 TBL_RAMOATVTIPO
 INNER JOIN TBL_RAMOATV ON (TBL_RAMOATVTIPO.CODATIVIDADE=TBL_RAMOATV.CODATIVIDADE)
 INNER JOIN TBL_RAMO ON (TBL_RAMOATV.CODRAMO=TBL_RAMO.CODRAMO)
;



/* View: SERIES */
CREATE OR ALTER VIEW SERIES(
    SERIE)
AS
select
  '''' || SERIE || ''''
from
  SERIE
order by
  SERIE
;



/* View: SFRCAIXA */
CREATE OR ALTER VIEW SFRCAIXA(
    CODUSERCAD,
    IDLOGIN)
AS
select distinct
  U.CODUSERCAD,
  U.IDLOGIN
from
  CUPOM C
  join USERCAD U on
    C.US_CADAST = U.IDLOGIN
;



/* View: SFRCARTACREDITO */
CREATE OR ALTER VIEW SFRCARTACREDITO(
    CODCARTAOCRED,
    DESCRICAO)
AS
select
  C.CODCARTAOCRED,
  C.DESCRICAO
from
  CARTAOCRED C
;



/* View: SFRFILIAL */
CREATE OR ALTER VIEW SFRFILIAL(
    CODEMPRESA,
    RAZAOSOCIAL)
AS
select
  E.CODEMPRESA,
  substring(E.RAZAOSOCIAL from 1 for 50) RAZAOSOCIAL
from
  EMPRESA E
;



/* View: SFRFORMAPAGAMENTO */
CREATE OR ALTER VIEW SFRFORMAPAGAMENTO(
    CODTIPOPAG,
    DESCRICAO)
AS
select
  T.CODTIPOPAG,
  T.DESCRICAO
from
  TIPOPAG T
;



/* View: SFRGRUPO */
CREATE OR ALTER VIEW SFRGRUPO(
    CODGRUPO,
    DESCRICAO)
AS
select distinct
  G.CODGRUPO,
  substring(G.DESCRICAO from 1 for 50)
from
  GRUPO G
  join PRODUTO P on G.CODGRUPO = P.CODGRUPO
;



/* View: SFRVENDA */
CREATE OR ALTER VIEW SFRVENDA(
    CODCUPOM,
    CPFCGC,
    CODGRUPO,
    QTDE,
    PRECOVEND,
    EMISSAO,
    CODEMPRESA,
    CODUSERCAD)
AS
select
  C.CODCUPOM,
  C.CPFCGC,
  PR.CODGRUPO,
  CI.QTDE,
  CI.PRECOVEND,
  cast(C.EMISSAO as date),
  C.CODEMPRESA,
  (select first 1 U.CODUSERCAD from USERCAD U where U.IDLOGIN = C.US_CADAST)
from
  CUPOM C
  join CUPOMITEM CI on
    C.CODCUPOM = CI.CODCUPOM
  join PRODFILHO P on
    CI.CODPRODFILHO = P.CODPRODFILHO
  join PRODUTO PR on
    P.CODPRODUTO = PR.CODPRODUTO
where
  (C.CPFCGC is not null or C.CARTAO is not null) and
  C.STATUSCUPOM = 0
;



/* View: SFRVENDAFP */
CREATE OR ALTER VIEW SFRVENDAFP(
    CODCUPOM,
    CODTIPOPAG,
    CODCARTAOCRED,
    VALOR)
AS
select
  C.CODCUPOM,
  CI.CODTIPOPAG,
  CC.CODCARTAOCRED,
  CI.VALOR
from
  CUPOM C
  join CUPOMPAG CI on
    C.CODCUPOM = CI.CODCUPOM
  left join CARTAOCRED CC on
    CI.CODCARTAOCRED = CC.CODCARTAOCRED
where
  (C.CPFCGC is not null or C.CARTAO is not null) and
  C.STATUSCUPOM = 0
;



/* View: SISPED_PLU */
CREATE OR ALTER VIEW SISPED_PLU(
    CODPLU,
    STATUS,
    TIPO,
    DATAVALIDADE,
    ATUALIZADOPOR,
    ATUALIZADOEM,
    DT_CADAST,
    US_CADAST,
    DT_MODIFI,
    US_MODIFI,
    TIPOPRECO,
    CODEMPRESA,
    STATUSENVIO)
AS
select CODPLU, 
       STATUS, 
       TIPO, 
       DATAVALIDADE, 
       ATUALIZADOPOR, 
       ATUALIZADOEM, 
       DT_CADAST, 
       US_CADAST, 
       DT_MODIFI, 
       US_MODIFI, 
       TIPOPRECO, 
       CODEMPRESA, 
       STATUSENVIO
from PLU
where
  PLU.DT_CADAST >= current_date -1
;



/* View: SISPED_PLUITEM */
CREATE OR ALTER VIEW SISPED_PLUITEM(
    CODPLUITEM,
    CODPLU,
    CODPRODFILHO,
    CODPESQUISA,
    PRECOATUAL1,
    PRECOATUAL2,
    PRECOATUAL3,
    PRECOATUAL4,
    PRECOATUAL5,
    PRECOATUAL6,
    DT_CADAST,
    US_CADAST,
    DT_MODIFI,
    US_MODIFI,
    DATACOMPRA,
    PRECONOVO,
    DTATUALIZACAO,
    ATUALIZADOEM,
    CODEMPRESA)
AS
select
       PLUITEM.CODPLUITEM,
       PLUITEM.CODPLU,
       PLUITEM.CODPRODFILHO,
       PLUITEM.CODPESQUISA,
       PLUITEM.PRECOATUAL1,
       PLUITEM.PRECOATUAL2,
       PLUITEM.PRECOATUAL3,
       PLUITEM.PRECOATUAL4,
       PLUITEM.PRECOATUAL5,
       PLUITEM.PRECOATUAL6,
       PLUITEM.DT_CADAST,
       PLUITEM.US_CADAST,
       PLUITEM.DT_MODIFI,
       PLUITEM.US_MODIFI,
       PLUITEM.DATACOMPRA,
       PLUITEM.PRECONOVO,
       PLUITEM.DTATUALIZACAO,
       PLU.ATUALIZADOEM,
       PLU.CODEMPRESA
 from PLUITEM inner join PLU ON(PLUITEM.CODPLU = PLU.CODPLU ) and PLU.DT_CADAST >= current_date -1
;



/* View: SISPED_PRODUTO_PLU */
CREATE OR ALTER VIEW SISPED_PRODUTO_PLU(
    CODPRODFILHO,
    DESCRICAO,
    LOCALIZACAO,
    TRIBUTADO,
    ALIQUOTAICMS,
    PRECOPRATICADO1,
    PRECOPRATICADO2,
    PRECOPRATICADO3,
    PRECOPRATICADO4,
    PRECOPRATICADO5,
    PRECOPRATICADO6,
    PRECOPROMOCAO,
    CODPESQ1,
    CODPESQ2,
    CODPESQ3,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    DATAPROMOCAO,
    CODPLU,
    ATUALIZADOEM,
    CODUNIDADE,
    ATIVAQTDEMAXIMA,
    QTDEMAXIMA,
    ATIVABALANCA,
    ESTOQUE,
    DATAESTOQUE,
    IMP_CODIGO,
    FABRICANTE,
    GRUPO,
    DESCONTFLAG,
    DESCONTDESEJ,
    NCM_CODIGO,
    PRDF_CST_ORIGEM_MERCADORIA,
    PRDF_CST_TRIBICMS,
    PERC_COFINS,
    PERC_PIS,
    CSTPIS,
    CODCFOPVENDADENTRO)
AS
select
  PR.CODPRODFILHO,
  PR.DESCRICAO,
  PR.LOCALIZACAO,
  PR.TRIBUTADO,
  PR.ALIQUOTAICMS,
  coalesce(PR.PRECOPRATICADO1,0) PRECOPRATICADO1,
  coalesce(PR.PRECOPRATICADO2,0) PRECOPRATICADO2,
  coalesce(PR.PRECOPRATICADO3,0) PRECOPRATICADO3,
  coalesce(PR.PRECOPRATICADO4,0) PRECOPRATICADO4,
  coalesce(PR.PRECOPRATICADO5,0) PRECOPRATICADO5,
  coalesce(PR.PRECOPRATICADO6,0) PRECOPRATICADO6,
  0 PRECOPROMOCAO,
  PR.CODPESQ1,
  PR.CODPESQ2,
  PR.CODPESQ3,
  PR.US_CADAST,
  PR.DT_CADAST,
  PR.US_MODIFI,
  PR.DT_MODIFI,
  PR.DATAPROMOCAO,
  pi.CODPLU,
  PL.ATUALIZADOEM,
  PR.CODUNIDADE,
  coalesce(ATIVAQTDEMAXIMA,'F') ATIVAQTDEMAXIMA,
  coalesce(QTDEMAXIMA,0) QTDEMAXIMA,
  coalesce(ATIVABALANCA,'N') ATIVABALANCA,
  coalesce(PR.ESTQATUAL,0) ESTQATUAL,
  PR.DATAESTOQ DATAESTOQUE,
  -1 IMP_CODIGO,
  coalesce((
   select pessoa.nome from PESSOA where PESSOA.codpessoa = PD.codfabricante
  ),'') FABRICANTE,
  coalesce((
   select GRUPO.descricao from GRUPO where GRUPO.codgrupo = PD.codgrupo
  ),'') GRUPO,
  PR.DESCONTFLAG,
  PR.DESCONTDESEJ,
  PR.CLASSFISCAL,
  PRDF_CST_ORIGEM_MERCADORIA,
  PRDF_CST_TRIBICMS,
  PERC_COFINS,
  PERC_PIS,
  CSTPIS,
  CODCFOPVENDADENTRO
from
  PRODFILHO PR
  inner join PLUITEM pi on (pi.CODPRODFILHO = PR.CODPRODFILHO)
  inner join PLU PL on (PL.CODPLU = pi.CODPLU)
  inner join PRODUTO PD on (PD.CODPRODUTO = PR.CODPRODUTO)
where
  PL.STATUS = 'ATUALIZADO'
;



/* View: SISPED_PRODUTOCODBARRA_PLU */
CREATE OR ALTER VIEW SISPED_PRODUTOCODBARRA_PLU(
    CODPRODFILHOCODBARRA,
    CODPRODFILHO,
    CODBARRA,
    DT_CADAST,
    US_CADAST,
    DT_MODIFI,
    US_MODIFI,
    ATUALIZADOEM,
    CODUNIDADE,
    QTDEMBALAGEM,
    PRECOPRATICADO)
AS
select
  PC.CODPRODFILHOCODBARRA,
  PC.CODPRODFILHO,
  PC.CODBARRA,
  PC.DT_CADAST,
  PC.US_CADAST,
  PC.DT_MODIFI,
  PC.US_MODIFI,
  PL.ATUALIZADOEM,
  PC.CODUNIDADE,
  PC.QTDEMBALAGEM,
  PC.PRECOPRATICADO1
from
  PRODFILHOCODBARRA PC
  inner join PRODFILHO PR on (PR.CODPRODFILHO = PC.CODPRODFILHO)
  inner join PLUITEM PI on (PI.CODPRODFILHO = PR.CODPRODFILHO)
  inner join PLU PL on (PL.CODPLU = PI.CODPLU)
where
  PL.STATUS = 'ATUALIZADO'
;



/* View: SISPED_PRODUTOCOMBINADO_PLU */
CREATE OR ALTER VIEW SISPED_PRODUTOCOMBINADO_PLU(
    CODNV,
    CODPRO,
    QTD,
    VLRUN,
    CODPRODCOMBINADO,
    CODPESQUISA,
    ATUALIZADOEM)
AS
select
  PC.CODNV,
  PC.CODPRO,
  PC.QTD,
  PC.VLRUN,
  PC.CODPRODCOMBINADO,
  PC.CODPESQUISA,
  P.ATUALIZADOEM
from
  PRODCOMBINADOS PC
  join PRODFILHO PF on
    PC.CODNV = PF.CODPRODFILHO
  join PLUITEM PI on
    PI.CODPRODFILHO = PF.CODPRODFILHO
  join PLU P on
    PI.CODPLU = P.CODPLU
where
  P.STATUS = 'ATUALIZADO'
;



/* View: SISPED_SEF */
CREATE OR ALTER VIEW SISPED_SEF(
    CODIGO,
    CONT_NOME,
    CONT_CPF,
    CONT_CRC,
    CONT_FONE1,
    CONT_FONE2,
    CONT_FAX,
    CONT_CXPOSTAL,
    CONT_EMAIL,
    CONT_CODIBGE)
AS
select
  CODIGO,
  CONT_NOME,
  CONT_CPF, 
  CONT_CRC, 
  CONT_FONE1, 
  CONT_FONE2, 
  CONT_FAX, 
  CONT_CXPOSTAL, 
  CONT_EMAIL, 
  CONT_CODIBGE
from
  SEF
;



/* View: SISPED_TIPOPAG */
CREATE OR ALTER VIEW SISPED_TIPOPAG(
    CODTIPOPAG,
    DESCRICAO,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    EXIBEECF,
    DESCRICAOECF,
    TEF,
    TIP_TIPO,
    ATUALIZADOEM,
    NRPRESTACAO,
    NRDIASPRIMEIRA,
    NRDIAS)
AS
select
  CODTIPOPAG,
  DESCRICAO,
  US_CADAST,
  DT_CADAST,
  US_MODIFI,
  DT_MODIFI,
  EXIBEECF,
  DESCRICAOECF,
  TEF,
  TIP_TIPO,
  coalesce(DT_MODIFI,DT_CADAST) ATUALIZADOEM,
  NRPRESTACAO,
  NRDIASPRIMEIRA,
  NRDIAS
from
  TIPOPAG
;



/* View: SISPED_UNIDADE */
CREATE OR ALTER VIEW SISPED_UNIDADE(
    CODUNIDADE,
    SIGLA,
    DESCRICAO,
    TRAVA_FRACIONADO,
    DT_CADAST,
    DT_MODIFI,
    ATUALIZAR,
    ATUALIZADOEM)
AS
select
  CODUNIDADE,
  SIGLA,
  DESCRICAO,
  TRAVA_FRACIONADO,
  DT_CADAST,
  DT_MODIFI,
  ATUALIZAR,
  coalesce(DT_MODIFI,DT_CADAST) ATUALIZADOEM
from
  UNIDADE
;



/* View: SISPED_VENDACASADA */
CREATE OR ALTER VIEW SISPED_VENDACASADA(
    CODVENDACASADAITEM,
    CODVENDACASADA,
    VALIDADE,
    CODPRODFILHO,
    QTD,
    VALOR)
AS
select
  I.CODVENDACASADAITEM,
  V.CODVENDACASADA,
  V.VALIDADE,
  I.CODPRODFILHO,
  I.QTD,
  I.VALOR
from
  VENDACASADA V
  join VENDACASADAITEM I on
    V.CODVENDACASADA = I.CODVENDACASADA
;



/* View: SLCADAGENDAMENTO */
CREATE OR ALTER VIEW SLCADAGENDAMENTO(
    CODPESSOA_VENDEDORAGENDA,
    CODPESSOA_VENDEDOR,
    CODPEDVEND,
    DTPREVISTO,
    DTREALIZADO,
    OBS,
    STATUS,
    DT_CADAST,
    US_CADAST,
    DT_MODIFI,
    US_MODIFI,
    ORDEMVISITA,
    CODPESSOA,
    CODVENDEDOR)
AS
select  PVA.CODPESSOA_VENDEDORAGENDA,
        PVA.CODPESSOA_VENDEDOR,
        PVA.CODPEDVEND,
        PVA.DTPREVISTO,
        PVA.DTREALIZADO,
        PVA.OBS,
        PVA.STATUS,
        PVA.DT_CADAST,
        PVA.US_CADAST,
        PVA.DT_MODIFI,
        PVA.US_MODIFI,
        ORDEMVISITA,
        RIGHT('00000000' || cast(PE.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
        RIGHT('00000000' || cast(VE.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR
from PESSOA_VENDEDORAGENDA PVA
inner join PESSOA_VENDEDOR PV on (PVA.CODPESSOA_VENDEDOR = PV.CODPESSOA_VENDEDOR)
inner join PESSOA PE on (PE.CODPESSOA = PV.CODPESSOA)
inner join VENDEDOR VE on (VE.CODVENDEDOR = PV.CODVENDEDOR)
where PVA.DTPREVISTO >= cast('NOW' as date)
;



/* View: SLCADCLI */
CREATE OR ALTER VIEW SLCADCLI(
    CODCLI,
    TIPOCLI,
    DTCADCLI,
    RAZSOCCLI,
    ENDCLI,
    CIDCLI,
    BAIRCLI,
    CEPCLI,
    ESTCLI,
    FAXCLI,
    TELCLI,
    CGCCLI,
    INSCESCLI,
    CODSET,
    CODSE1,
    CODSE2,
    BLOQCRED,
    SALDEVCLI,
    ULTCOMPRA,
    CODPRAZO,
    PRAZO,
    FORMAPAGTO,
    ATIVO,
    TIPOPED)
AS
select
  RIGHT('00000000' || cast(P.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
  '',
  P.DT_CADAST,
  P.NOME,
  P.LOGRADOURO_1,
  P.CIDADE_1,
  P.BAIRRO_1,
  P.CEP_1,
  P.UF_1,
  P.FAX,
  P.FONES,
  P.CPFCGC,
  P.IE,
  RIGHT('00000000' || cast((select first 1 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 1 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 2 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  'L',
  CAST((SELECT SUM(COALESCE(VLPARCELA,0) - COALESCE(TOTPAGO,0)) FROM CONTA WHERE (CONTA.TIPO = 'RECEBER') and (CONTA.STATUS = 'ABERTO') AND (CONTA.CODPESSOA = P.CODPESSOA)) AS double precision),
  (select first 1 DT_EMISSAO from NFVENDA where NFVENDA.CODPESSOA = P.CODPESSOA order by DT_EMISSAO desc),
  CODTIPOPAG1,
  TP.DESCRICAO,
  SP.CODIGO,
  case P.ATIVO
  when 1 then 'I'
  when 2 then 'A'
  END,
  COALESCE(P.tipoped,'VENDA')
from
  PESSOA P
  left join TIPOPAG TP on P.CODTIPOPAG1 = TP.CODTIPOPAG
  left join SLPAGTO SP on P.TIP_TIPO = SP.TIPOPAG
;



/* View: SLCADCLI_1 */
CREATE OR ALTER VIEW SLCADCLI_1(
    CODCLI,
    TIPOCLI,
    DTCADCLI,
    RAZSOCCLI,
    ENDCLI,
    CIDCLI,
    BAIRCLI,
    CEPCLI,
    ESTCLI,
    FAXCLI,
    TELCLI,
    CGCCLI,
    INSCESCLI,
    CODSET,
    CODSE1,
    CODSE2,
    CODSE3,
    CODSE4,
    CODSE5,
    BLOQCRED,
    SALDEVCLI,
    ULTCOMPRA,
    CODPRAZO,
    PRAZO,
    FORMAPAGTO,
    ATIVO,
    TIPOPED)
AS
select
  RIGHT('00000000' || cast(P.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
  '',
  P.DT_CADAST,
  P.NOME,
  P.LOGRADOURO_1,
  P.CIDADE_1,
  P.BAIRRO_1,
  P.CEP_1,
  P.UF_1,
  P.FAX,
  P.FONES,
  P.CPFCGC,
  P.IE,
  RIGHT('00000000' || cast((select first 1 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 1 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 2 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 3 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 4 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 5 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  'L',
  0.00,
  --CAST((SELECT SUM(COALESCE(VLPARCELA,0) - COALESCE(TOTPAGO,0)) FROM CONTA WHERE (CONTA.TIPO = 'RECEBER') and (CONTA.STATUS = 'ABERTO') AND (CONTA.CODPESSOA = P.CODPESSOA)) AS double precision),
  (select first 1 DT_EMISSAO from NFVENDA where NFVENDA.CODPESSOA = P.CODPESSOA order by DT_EMISSAO desc),
  CODTIPOPAG1,
  TP.DESCRICAO,
  SP.CODIGO,
  case P.ATIVO
  when 1 then 'I'
  when 2 then 'A'
  END,
  COALESCE(P.tipoped,'VENDA')
from
  PESSOA P
  left join TIPOPAG TP on P.CODTIPOPAG1 = TP.CODTIPOPAG
  left join SLPAGTO SP on P.TIP_TIPO = SP.TIPOPAG
;



/* View: SLCADCLI_2 */
CREATE OR ALTER VIEW SLCADCLI_2(
    CODCLI,
    TIPOCLI,
    DTCADCLI,
    RAZSOCCLI,
    ENDCLI,
    CIDCLI,
    BAIRCLI,
    CEPCLI,
    ESTCLI,
    FAXCLI,
    TELCLI,
    CGCCLI,
    INSCESCLI,
    CODSET,
    CODSE1,
    CODSE2,
    CODSE3,
    CODSE4,
    BLOQCRED,
    SALDEVCLI,
    ULTCOMPRA,
    CODPRAZO,
    PRAZO,
    FORMAPAGTO,
    ATIVO,
    TIPOPED)
AS
select
  RIGHT('00000000' || cast(P.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
  '',
  P.DT_CADAST,
  P.NOME,
  P.LOGRADOURO_1,
  P.CIDADE_1,
  P.BAIRRO_1,
  P.CEP_1,
  P.UF_1,
  P.FAX,
  P.FONES,
  P.CPFCGC,
  P.IE,
  RIGHT('00000000' || cast((select first 1 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 1 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 2 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 3 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  RIGHT('00000000' || cast((select first 1 skip 4 CODVENDEDOR  from PESSOA_VENDEDOR where CODPESSOA = P.CODPESSOA) as varchar(6)) ,4),
  'L',
  0.00,
  --CAST((SELECT SUM(COALESCE(VLPARCELA,0) - COALESCE(TOTPAGO,0)) FROM CONTA WHERE (CONTA.TIPO = 'RECEBER') and (CONTA.STATUS = 'ABERTO') AND (CONTA.CODPESSOA = P.CODPESSOA)) AS double precision),
  (select first 1 DT_EMISSAO from NFVENDA where NFVENDA.CODPESSOA = P.CODPESSOA order by DT_EMISSAO desc),
  CODTIPOPAG1,
  TP.DESCRICAO,
  SP.CODIGO,
  case P.ATIVO
  when 1 then 'I'
  when 2 then 'A'
  END,
  COALESCE(P.tipoped,'VENDA')
from
  PESSOA P
  left join TIPOPAG TP on P.CODTIPOPAG1 = TP.CODTIPOPAG
  left join SLPAGTO SP on P.TIP_TIPO = SP.TIPOPAG
;



/* View: SLCADCLI_ADICIONAIS */
CREATE OR ALTER VIEW SLCADCLI_ADICIONAIS(
    CODCLI,
    FANTASIA,
    SEGMENTO,
    RAMO,
    LIMITE,
    CODSTATUS,
    STATUS,
    DEP1,
    DEP1_NASC,
    DEP2,
    DEP2_NASC,
    DEP3,
    DEP3_NASC)
AS
select
  RIGHT('00000000' || cast(P.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
  P.NOMEFANTAZIA,
  ATV.DESCRICAO,
  RAM.DESCRICAO,
  P.LIMITECRED,
  P.CODSTATUS,
  STATUS.DESCRICAO,
  (select first 1 NOME  from PESSOA_DEPENDENTE PD where PD.CODPESSOA = P.CODPESSOA),
  (select first 1 DTNASCIMENTO  from PESSOA_DEPENDENTE PD where PD.CODPESSOA = P.CODPESSOA),
  (select first 1 skip 1 NOME  from PESSOA_DEPENDENTE PD where PD.CODPESSOA = P.CODPESSOA),
  (select first 1 skip 1 DTNASCIMENTO  from PESSOA_DEPENDENTE PD where PD.CODPESSOA = P.CODPESSOA),
  (select first 1 skip 2 NOME  from PESSOA_DEPENDENTE PD where PD.CODPESSOA = P.CODPESSOA),
  (select first 1 skip 2 DTNASCIMENTO  from PESSOA_DEPENDENTE PD where PD.CODPESSOA = P.CODPESSOA)
from
  PESSOA P
  left join TBL_RAMOATVTIPO ATV on ATV.CODTIPO = P.CODTIPOATV
  LEFT JOIN TBL_RAMOATV ON (ATV.CODATIVIDADE=TBL_RAMOATV.CODATIVIDADE)
  LEFT JOIN TBL_RAMO RAM ON (RAM.CODRAMO=TBL_RAMOATV.CODRAMO)
  LEFT JOIN STATUS ON (P.CODSTATUS = STATUS.CODSTATUS)
;



/* View: SLCADCLI_METAS */
CREATE OR ALTER VIEW SLCADCLI_METAS(
    CODPESSOA,
    QTD,
    CODGRUPO)
AS
select RIGHT('00000000' || cast(PESSOA_META.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
       PESSOA_META.QTD,
       RIGHT('00000000' || CAST(PESSOA_META.CODGRUPO AS VARCHAR(6)) ,6) AS CODGRUPO
from PESSOA_META
;



/* View: SLCADCLI_RAPIDO */
CREATE OR ALTER VIEW SLCADCLI_RAPIDO(
    CODCLI,
    RAZSOCCLI,
    CIDCLI,
    BAIRCLI)
AS
select RIGHT('00000000' || cast(PESSOA.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
       PESSOA.NOME,
       PESSOA.CIDADE_1,
       PESSOA.BAIRRO_1
from PESSOA
;



/* View: SLCADCLI_STATUS */
CREATE OR ALTER VIEW SLCADCLI_STATUS(
    CODCLI,
    STATUS_CLI,
    OBS_BLOQUEIO,
    OBS_BLOQUEIO1)
AS
select
  RIGHT('00000000' || cast(P.CODPESSOA as varchar(6)) ,6) as CODPESSOA,
  S.DESCRICAO,
  P.OBSBLOQUEIO,
  P.OBSBLOQUEIO1
from
  PESSOA P
  inner join STATUS S on S.CODSTATUS = P.CODSTATUS
;



/* View: SLCADCOR_META */
CREATE OR ALTER VIEW SLCADCOR_META(
    CODIGO,
    CODVENDEDOR,
    CODCOR,
    DESCRICAO,
    CAIXA)
AS
SELECT
   VENDEDORMETAS.CODIGO,
   VENDEDORMETAS.CODVENDEDOR,
   VENDEDORMETAS.CODCOR,
   TBL_COR.DESCRICAO,
   VENDEDORMETAS.CAIXA
FROM
   VENDEDORMETAS
   INNER JOIN TBL_COR ON (VENDEDORMETAS.CODCOR = TBL_COR.CODCOR)
WHERE
   VENDEDORMETAS.CODCOR IS NOT NULL
;



/* View: SLCADDIVISAO */
CREATE OR ALTER VIEW SLCADDIVISAO(
    CODPRODFILHO,
    DIVISAO)
AS
select
  RIGHT('000000' || cast(PF.CODPRODFILHO as varchar(7)) ,6) as CODPRODFILHO,
  RIGHT('000000' || cast(PRODC.CODCARACTER as varchar(7)) ,6) as CODPRODCARACTER
from
 PRODFILHO PF
  join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
  join prodcaracter PRODC on (PD.CODPRODUTO = PRODC.CODPRODUTO)
  join CARACTER ON(CARACTER.CODCARACTER = PRODC.CODCARACTER)
 where char_length(pf.codprodfilho) <= 6
;



/* View: SLCADGRU */
CREATE OR ALTER VIEW SLCADGRU(
    CODGRU,
    DESCGRU)
AS
SELECT
   RIGHT('00000' ||CODGRUPO ,6) AS CODGRUPO,
   DESCRICAO
   FROM GRUPO
;



/* View: SLCADPRECOS */
CREATE OR ALTER VIEW SLCADPRECOS(
    CODPRODFILHO,
    PRECOPRATICADO1,
    PRECOPRATICADO2,
    PRECOPRATICADO3,
    PRECOPRATICADO4,
    PRECOPRATICADO5,
    PRECOPRATICADO6)
AS
select
  RIGHT('00000000' || cast(PF.CODPRODFILHO as varchar(6)) ,6) as CODPRODFILHO,
  PF.PRECOPRATICADO1,
  PF.PRECOPRATICADO2,
  PF.PRECOPRATICADO3,
  PF.PRECOPRATICADO4,
  PF.PRECOPRATICADO5,
  PF.PRECOPRATICADO6
from
  PRODFILHO PF
  join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
  where pd.ativo = 2
;



/* View: SLCADPRO */
CREATE OR ALTER VIEW SLCADPRO(
    CODPRO,
    DTCADPRO,
    DESCPRO,
    CODGRU,
    REF_FABR,
    PROMOCAO,
    PROATIINA,
    ULTREAVDA,
    PREVENDA,
    PRECOANT,
    SALDESTOQ,
    PRECO_UNIT,
    QTDEMBALAGEM,
    FATORCONVERSAO,
    PESO_BRUTO)
AS
select
  RIGHT('00000000' || cast(PF.CODPRODFILHO as varchar(7)) ,7) as CODPRODFILHO,
  cast(coalesce(PF.DT_CADAST,'01.01.2007') as timestamp),
  PF.DESCRICAO,
  RIGHT('00000000' || cast(PD.CODGRUPO as varchar(6)) ,6) as CODGRUPO,
  coalesce(PF.UNIDADE, UN.SIGLA),
  PF.PROMOCAO,
  case PD.ATIVO
    when 1 then 'I'
    when 2 then 'A'
  end as ATIVO,
  coalesce((select max(cast(DT_ATUALIZACAO as date)) from MODIFIPRECO WHERE CODPRODFILHO = PF.CODPRODFILHO),cast('01.01.06' as date)),
  PF.PRECOPRATICADO1,
  coalesce((select FIRST 1 ULTIMOPRECO from MODIFIPRECO WHERE CODPRODFILHO = PF.CODPRODFILHO order by DT_ATUALIZACAO DESC),1),
  (PF.ESTQATUAL - coalesce(PF.ESTOQANALISE,0)),
  (PF.PRECOPRATICADO1 / coalesce(nullif(PF.QTDEMBALAGEM,0),1)),
  coalesce(PF.QTDEMBALAGEM,1),
  coalesce(PF.FATORCONVERSAO,1),
  coalesce(PF.PESOBRUTO,1)
from
  PRODFILHO PF
  join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
  join UNIDADE UN on (PF.CODUNIDADE = UN.CODUNIDADE)
;



/* View: SLCADPRODCARACTER */
CREATE OR ALTER VIEW SLCADPRODCARACTER(
    CODPRO,
    CODPRODCARACTER,
    DESCPRODCARACTER)
AS
select
  RIGHT('00000000' || cast(PF.CODPRODFILHO as varchar(7)) ,7) as CODPRODFILHO,
  RIGHT('00000000' || cast(PRODC.CODCARACTER as varchar(7)) ,7) as CODPRODCARACTER,
  CARACTER.DESCRICAO
from
 PRODFILHO PF
  join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
  join prodcaracter PRODC on (PD.CODPRODUTO = PRODC.CODPRODUTO)
  join CARACTER ON(CARACTER.CODCARACTER = PRODC.CODCARACTER)
where
  PD.ativo = 2
;



/* View: SLCADSET */
CREATE OR ALTER VIEW SLCADSET(
    CODSET,
    NOMSET,
    CODGRUPO,
    COTASET,
    QUANTCLI,
    COTAUNID,
    TABELA1,
    TABELA2,
    TABELA3,
    TABELA4,
    TABELA5,
    TABELA6,
    CODDIVISAO)
AS
select
  RIGHT('00000000' || cast(V.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR,
  NOME,
  VM.CODGRUPO,
  coalesce(nullif(VM.VALOR,0),nullif(V.MARGEM,0),0) as TOT_VALOR,
  coalesce((select count(distinct CODPESSOA) from PESSOA_VENDEDOR where CODVENDEDOR = V.CODVENDEDOR),0) as TOT_POTENCIAL,
  coalesce(VM.QTD,0) as TOT_QTD,
  PRECO1,
  PRECO2,
  PRECO3,
  PRECO4,
  PRECO5,
  PRECO6,
  V.CODCOBRADOR
from
  VENDEDOR V
  left join VENDEDORMETAS VM on (V.CODVENDEDOR = VM.CODVENDEDOR and
                                 extract(month from (select cast('NOW' as date) from RDB$DATABASE)) >= extract(month from VM.INICIO) and extract(month from (select cast('NOW' as date) from RDB$DATABASE)) <= extract(month from VM.FINAL))
;



/* View: SLCADSET_META */
CREATE OR ALTER VIEW SLCADSET_META(
    CODVENDEDOR,
    CODGRUPO,
    CODPRODFILHO,
    PRODUTO,
    META,
    METAPOSITIVACAO,
    REALIZADO,
    REALIZADOPOSITIVACAO)
AS
select
  RIGHT('00000000' || cast(V.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR,
  RIGHT('00000000' || cast(PR.CODGRUPO as varchar(6)) ,6) as CODGRUPO,
  RIGHT('00000000' || cast(PI.CODPRODFILHO as varchar(6)) ,6) as CODPRODFILHO,
  PF.DESCRICAO PRODUTO,
  VM.QTD META,
  VM.POSITIVACAO METAPOSITIVACAO,
  sum(PI.QTDENTREGUE) REALIZADO,
  count(distinct P.CODPESSOA) REALIZADOPOSITIVACAO
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join VENDEDORMETAS VM on V.CODVENDEDOR = VM.CODVENDEDOR and PR.codsubgrupo = VM.codsubgrupo
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA', 'CADERNO') and
  extract(month from current_date) = extract(month from cast(P.DTFATURADO as date)) and
  extract(year from current_date) = extract(year from cast(P.DTFATURADO as date))
GROUP BY 1,2,3,4,5,6
;



/* View: SLCADSET_META_ATACAMAX */
CREATE OR ALTER VIEW SLCADSET_META_ATACAMAX(
    CODVENDEDOR,
    CODGRUPO,
    CODSUBGRUPO,
    META,
    METAPOSITIVACAO,
    GRUPO,
    SUBGRUPO,
    EXTRA,
    REALIZADO,
    REALIZADOPOSITIVACAO)
AS
select
  RIGHT('00000000' || cast(V.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR,
  RIGHT('00000000' || cast(PR.CODGRUPO as varchar(6)) ,6) as CODGRUPO,
  RIGHT('00000000' || cast(PR.CODSUBGRUPO as varchar(6)) ,6) as CODSUBGRUPO,
  VM.VALOR META,
  VM.POSITIVACAO METAPOSITIVACAO,
  GRUPO.DESCRICAO GRUPO,
  SUBGRUPO.DESCRICAO SUBGRUPO,
  coalesce(VM.EXTRA,'N') EXTRA,
  sum(pi.precovend) REALIZADO,
  count(distinct P.CODPESSOA) REALIZADOPOSITIVACAO
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join PEDVENDITEM pi on P.CODPEDVEND = pi.CODPEDVEND
  join PRODFILHO PF on pi.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join VENDEDORMETAS VM on V.CODVENDEDOR = VM.CODVENDEDOR and PR.codSUBgrupo = VM.codSUBgrupo
  join GRUPO on GRUPO.codgrupo = PR.CODGRUPO
  join SUBGRUPO on SUBGRUPO.codsubgrupo = PR.codsubgrupo
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA', 'CADERNO') and
  extract(month from current_date) = extract(month from cast(P.DTFATURADO as date)) and
  extract(year from current_date) = extract(year from cast(P.DTFATURADO as date))
group by 1,2,3,4,5,6,7,8
;



/* View: SLCADSET_META_GRUPO */
CREATE OR ALTER VIEW SLCADSET_META_GRUPO(
    CODVENDEDOR,
    CODGRUPO,
    DESCGRUPO,
    CODSUBGRUPO,
    DESCSUBGRUPO,
    CODPRODFILHO,
    PRODUTO,
    QTDPORCAIXA,
    COTADIARIACAIXAS,
    COTADIARIAPOSITIVACAO)
AS
select
  RIGHT('00000000' || cast(V.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR,
  RIGHT('00000000' || cast(PR.CODGRUPO as varchar(6)) ,6) as CODGRUPO,
  grupo.DESCRICAO as DESCGRUPO,
  RIGHT('00000000' || cast(pr.CODSUBGRUPO as varchar(6)) ,6) as CODSUBGRUPO,
  subgrupo.DESCRICAO as DESCSUBGRUPO,
  RIGHT('00000000' || cast(PI.CODPRODFILHO as varchar(6)) ,6) as CODPRODFILHO,
  PF.DESCRICAO PRODUTO,
  PF.QTDEMBALAGEM as QTDPORCAIXA,
  vm.CAIXADIA as COTADIARIACAIXAS,
  vm.POSITDIA as Cotadiariapositivacao
from
  PEDVEND P
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
  join PRODFILHO PF on PI.CODPRODFILHO = PF.CODPRODFILHO
  join PRODUTO PR on PF.CODPRODUTO = PR.CODPRODUTO
  join VENDEDORMETAS VM on V.CODVENDEDOR = VM.CODVENDEDOR and PR.codsubgrupo = VM.codsubgrupo
  join grupo on (PR.codgrupo = grupo.CODGRUPO)
  join subgrupo on(PR.CODSUBGRUPO = subgrupo.CODSUBGRUPO)
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA', 'CADERNO') and
  extract(month from current_date) = extract(month from cast(P.DTFATURADO as date)) and
  extract(year from current_date) = extract(year from cast(P.DTFATURADO as date))
;



/* View: SLCADSET_RAPIDO */
CREATE OR ALTER VIEW SLCADSET_RAPIDO(
    CODSET,
    NOMSET,
    CODGRUPO,
    COTASET,
    QUANTCLI,
    COTAUNID,
    TABELA1,
    TABELA2,
    TABELA3,
    TABELA4,
    TABELA5,
    TABELA6,
    CODDIVISAO)
AS
select
  RIGHT('00000000' || cast(V.CODVENDEDOR as varchar(6)) ,4) as CODVENDEDOR,
  NOME,
  VM.CODGRUPO,
  coalesce(nullif(VM.VALOR,0),nullif(V.MARGEM,0),0) as TOT_VALOR,
  coalesce((select count(distinct CODPESSOA) from PESSOA_VENDEDOR where CODVENDEDOR = V.CODVENDEDOR),0) as TOT_POTENCIAL,
  coalesce(VM.QTD,0) as TOT_QTD,
  PRECO1,
  PRECO2,
  PRECO3,
  PRECO4,
  PRECO5,
  PRECO6,
  V.CODCOBRADOR
from
  VENDEDOR V
  left join VENDEDORMETAS VM on (V.CODVENDEDOR = VM.CODVENDEDOR and
                                 extract(month from (select cast('NOW' as date) from RDB$DATABASE)) >= extract(month from VM.INICIO) and extract(month from (select cast('NOW' as date) from RDB$DATABASE)) <= extract(month from VM.FINAL))
;



/* View: SLCADSET_TOTAIS */
CREATE OR ALTER VIEW SLCADSET_TOTAIS(
    CODSET,
    VENDAS,
    PEDIDOS,
    ATENDIDOS,
    ULTVENDA,
    FLEX,
    FLEXPERC,
    VENDAUNID)
AS
select
  RIGHT('00000000' || cast(P.CODVENDEDOR as varchar(6)), 4),
  coalesce(sum(PI.PRECOVEND),0),
  coalesce(count(distinct P.CODPEDVEND),0),
  coalesce(count(distinct P.CODPESSOA),0),
  max(cast(DTFATURADO as date)) ,
  (coalesce(sum(PI.QTDE*PI.PRECOPROD),0)) - (coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)),
--  ((coalesce(sum(PI.QTDE*PI.PRECOPROD),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  (((coalesce(sum(PI.PRECOVEND),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  coalesce(sum(PI.QTDE),0) as LITROS
from
  PEDVEND P
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA','CADERNO') and
  extract(month from cast(P.DTFATURADO as date)) = extract(month from current_date) and
  extract(year from cast(P.DTFATURADO as date)) = extract(year from current_date)
group by
  1
;



/* View: SLCADSET_TOTAIS_ATACAMAX */
CREATE OR ALTER VIEW SLCADSET_TOTAIS_ATACAMAX(
    CODSET,
    VENDAS,
    PEDIDOS,
    ATENDIDOS,
    ULTVENDA,
    FLEX,
    FLEXPERC,
    VENDAUNID)
AS
select
  RIGHT('00000000' || cast(P.CODVENDEDOR as varchar(6)), 4),
  coalesce(sum(PI.PRECOVEND),0),
  coalesce(count(distinct P.CODPEDVEND),0),
  coalesce(count(distinct P.CODPESSOA),0),
  max(cast(DTFATURADO as date)) ,
  ((coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0) - coalesce(sum(PI.PRECOVEND),0))),
  (((coalesce(sum(PI.PRECOVEND),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  coalesce(sum(PI.QTDE),0) as LITROS
from
  PEDVEND P
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA','CADERNO') and
  extract(month from cast(P.DTFATURADO as date)) = extract(month from current_date) and
  extract(year from cast(P.DTFATURADO as date)) = extract(year from current_date)
group by
  1
;



/* View: SLCADSET_TOTAIS_MARFIM */
CREATE OR ALTER VIEW SLCADSET_TOTAIS_MARFIM(
    CODSET,
    VENDAS,
    PEDIDOS,
    ATENDIDOS,
    ULTVENDA,
    FLEX,
    FLEXPERC,
    VENDAUNID)
AS
select
  RIGHT('00000000' || cast(P.CODVENDEDOR as varchar(6)), 4),
  coalesce(sum(PI.PRECOVEND),0),
  coalesce(count(distinct P.CODPEDVEND),0),
  coalesce(count(distinct P.CODPESSOA),0),
  max(cast(DTFATURADO as date)) ,
  (coalesce(sum(PI.QTDE*PI.PRECOPROD),0)) - (coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)),
--  ((coalesce(sum(PI.QTDE*PI.PRECOPROD),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  (((coalesce(sum(PI.PRECOVEND),0) -  coalesce(sum(PI.QTDE*PI.PRECOPRODTABELA),0)) * 100) /  coalesce(nullif(sum(PI.QTDE*PI.PRECOPRODTABELA),0),1)),
  coalesce(sum(PI.QTDE),0) as LITROS
from
  PEDVEND P
  join PEDVENDITEM PI on P.CODPEDVEND = PI.CODPEDVEND
where
  P.STATUSPED = 'FATURADO' and
  P.TIPOPED in ('VENDA','CADERNO') and
  cast(P.DTFATURADO as date) between (SELECT RETORNA_MES_MARFIM.DATA_INICIAL FROM RETORNA_MES_MARFIM)
   and (SELECT RETORNA_MES_MARFIM.DATA_FINAL FROM RETORNA_MES_MARFIM)
group by
  1
;



/* View: SLCADTIT_V1 */
CREATE OR ALTER VIEW SLCADTIT_V1(
    NUMMOV,
    TIPODOC,
    DTEMISS,
    CODCLI,
    CODSET,
    CODPOR,
    NMTITULO,
    SITTIT,
    DTVENCLIM,
    VALBRUTO,
    DTPAGTO,
    VALPAGO,
    VALACUJUR,
    PEDIDO,
    ANOTACAO)
AS
SELECT
   RIGHT('00000000' || CAST(CODCONTA AS VARCHAR(7)) ,8) AS NUMMOV,
   CASE PREV_TIPOPAG
   WHEN 'BOLETO BANCÁRIO' THEN 'BO'
   WHEN 'CHEQUE' THEN 'CH'
   WHEN 'DUPLICATA' THEN 'DU'
   WHEN 'DINHEIRO' THEN 'ES' END AS PREV_TIPOPAG,
   DT_EMISSAO,
   RIGHT('00000000' || CAST(CODPESSOA AS VARCHAR(6)) ,6) AS CODPESSOA,
   RIGHT('00000000' || CAST(CODVENDEDOR AS VARCHAR(6)) ,4) AS CODSET,
   RIGHT('00000000' || CAST(CODBANCO AS VARCHAR(6)) ,3) AS CODPORT,
   NRDOCUMENTO,
   'AB',
   DT_VENCIM,
   (VLPARCELA),
   (SELECT FIRST 1 DT_PAGAMEN FROM CONTABX WHERE CODCONTA = CONTA.CODCONTA) AS DT_PAGAMENTO,
   TOTPAGO,
   0,
   CODPENDVEND,
   CONTA.OBS1||' '||CONTA.OBS2
   FROM CONTA
   WHERE STATUS = 'ABERTO' AND TOTPAGO = 0 AND CODPENDVEND > 0
;



/* View: SLCADTIT_V2 */
CREATE OR ALTER VIEW SLCADTIT_V2(
    NUMMOV,
    TIPODOC,
    DTEMISS,
    CODCLI,
    CODSET,
    CODPOR,
    NMTITULO,
    SITTIT,
    DTVENCLIM,
    VALBRUTO,
    DTPAGTO,
    VALPAGO,
    VALACUJUR,
    PEDIDO,
    ANOTACAO)
AS
SELECT
   RIGHT('00000000' || CAST(CODCONTA AS VARCHAR(7)) ,8) AS NUMMOV,
   CASE PREV_TIPOPAG
   WHEN 'BOLETO BANCÁRIO' THEN 'BO'
   WHEN 'CHEQUE' THEN 'CH'
   WHEN 'DUPLICATA' THEN 'DU'
   WHEN 'DINHEIRO' THEN 'ES' END AS PREV_TIPOPAG,
   DT_EMISSAO,
   RIGHT('00000000' || CAST(CODPESSOA AS VARCHAR(6)) ,6) AS CODPESSOA,
   RIGHT('00000000' || CAST(CODVENDEDOR AS VARCHAR(6)) ,4) AS CODSET,
   RIGHT('00000000' || CAST(CODBANCO AS VARCHAR(6)) ,3) AS CODPORT,
   NRDOCUMENTO,
   'PC',
   DT_VENCIM,
   (VLPARCELA),
   (SELECT FIRST 1 DT_PAGAMEN FROM CONTABX WHERE CODCONTA = CONTA.CODCONTA) AS DT_PAGAMENTO,
   TOTPAGO,
   0,
   CODPENDVEND,
   CONTA.OBS1||' '||CONTA.OBS2
   FROM CONTA
   WHERE STATUS = 'ABERTO' AND TOTPAGO > 0 AND CODPENDVEND > 0
;



/* View: SLCADTIT_V3 */
CREATE OR ALTER VIEW SLCADTIT_V3(
    NUMMOV,
    TIPODOC,
    DTEMISS,
    CODCLI,
    CODSET,
    CODPOR,
    NMTITULO,
    SITTIT,
    DTVENCLIM,
    VALBRUTO,
    DTPAGTO,
    VALPAGO,
    VALACUJUR,
    PEDIDO,
    ANOTACAO)
AS
SELECT
   RIGHT('00000000' || CAST(CODCONTA AS VARCHAR(7)) ,8) AS NUMMOV,
   CASE PREV_TIPOPAG
   WHEN 'BOLETO BANCÁRIO' THEN 'BO'
   WHEN 'CHEQUE' THEN 'CH'
   WHEN 'DUPLICATA' THEN 'DU'
   WHEN 'DINHEIRO' THEN 'ES' END AS PREV_TIPOPAG,
   DT_EMISSAO,
   RIGHT('00000000' || CAST(CODPESSOA AS VARCHAR(6)) ,6) AS CODPESSOA,
   RIGHT('00000000' || CAST(CODVENDEDOR AS VARCHAR(6)) ,4) AS CODSET,
   RIGHT('00000000' || CAST(CODBANCO AS VARCHAR(6)) ,3) AS CODPORT,
   NRDOCUMENTO,
   'AB',
   DT_VENCIM,
   (VLPARCELA),
   (SELECT FIRST 1 DT_PAGAMEN FROM CONTABX WHERE CODCONTA = CONTA.CODCONTA) AS DT_PAGAMENTO,
   TOTPAGO,
   0,
   CODPENDVEND,
   CONTA.OBS1||' '||CONTA.OBS2
   FROM CONTA
   WHERE STATUS = 'ABERTO' AND coalesce(CODPENDVEND,0) = 0 and TIPO = 'RECEBER'
;



/* View: SLCADTIT */
CREATE OR ALTER VIEW SLCADTIT(
    NUMMOV,
    TIPODOC,
    DTEMISS,
    CODCLI,
    CODSET,
    CODPOR,
    NMTITULO,
    SITTIT,
    DTVENCLIM,
    VALBRUTO,
    DTPAGTO,
    VALPAGO,
    VALACUJUR,
    PEDIDO,
    ANOTACAO)
AS
SELECT NUMMOV,TIPODOC,DTEMISS,CODCLI,CODSET,CODPOR,NMTITULO,SITTIT,DTVENCLIM,VALBRUTO,DTPAGTO,VALPAGO,VALACUJUR,PEDIDO,ANOTACAO FROM SLCADTIT_V1
UNION
SELECT NUMMOV,TIPODOC,DTEMISS,CODCLI,CODSET,CODPOR,NMTITULO,SITTIT,DTVENCLIM,VALBRUTO,DTPAGTO,VALPAGO,VALACUJUR,PEDIDO,ANOTACAO FROM SLCADTIT_V2
UNION
SELECT NUMMOV,TIPODOC,DTEMISS,CODCLI,CODSET,CODPOR,NMTITULO,SITTIT,DTVENCLIM,VALBRUTO,DTPAGTO,VALPAGO,VALACUJUR,PEDIDO,ANOTACAO FROM SLCADTIT_V3
;



/* View: SLPROMOCAO */
CREATE OR ALTER VIEW SLPROMOCAO(
    CODPRODFILHO,
    "CAST",
    DESCRICAO,
    CODGRUPO,
    "COALESCE",
    PROMOCAO,
    ATIVO,
    COALESCE1,
    PRECOPRATICADO1,
    COALESCE2,
    F_1,
    F_2,
    COALESCE3,
    COALESCE4)
AS
select
  RIGHT('00000000' || cast(PF.CODPRODFILHO as varchar(6)) ,6) as CODPRODFILHO,
  cast(coalesce(PF.DT_CADAST,'01.01.2007') as timestamp),
  PF.DESCRICAO,
  RIGHT('00000000' || cast(PD.CODGRUPO as varchar(6)) ,6) as CODGRUPO,
  coalesce(PF.UNIDADE, UN.SIGLA),
  PF.PROMOCAO,
  case PD.ATIVO
    when 1 then 'I'
    when 2 then 'A'
  end as ATIVO,
  coalesce((select max(cast(DT_ATUALIZACAO as date)) from MODIFIPRECO where CODPRODFILHO = PF.CODPRODFILHO),cast('01.01.06' as date)),
  PF.PRECOPRATICADO1,
  coalesce((select first 1 ULTIMOPRECO from MODIFIPRECO where CODPRODFILHO = PF.CODPRODFILHO order by DT_ATUALIZACAO desc),1),
  (PF.ESTQATUAL - coalesce(PF.ESTOQANALISE,0)),
  (PF.PRECOPRATICADO1 / coalesce(PF.QTDEMBALAGEM,1)),
  coalesce(PF.QTDEMBALAGEM,1),
  coalesce(PF.FATORCONVERSAO,1)
from
  PRODFILHO PF
  join PRODUTO PD on (PD.CODPRODUTO = PF.CODPRODUTO)
  join UNIDADE UN on (PF.CODUNIDADE = UN.CODUNIDADE)
  join PROMOCAOITEM PRI on (PRI.CODPRODFILHO_FK = PF.CODPRODFILHO)
  join promocao pr on (pr.CODPROMOCAO = pri.CODPROMOCAO_FK)
where
  pr.DATAFIM >= CURRENT_DATE and pr.STATUS = 'LIBERADO'
;



/* View: SLULTIMAS_ENTRADA */
CREATE OR ALTER VIEW SLULTIMAS_ENTRADA(
    CODPRODFILHO,
    DESCRICAO,
    ESTOQUE_ATUAL,
    DATA_ENTRADA)
AS
select
  DISTINCT RIGHT('00000000' || cast(PRODFILHO.CODPRODFILHO as varchar(6)) ,6) as CODPRODFILHO,
  PRODFILHO.DESCRICAO,
  (PRODFILHO.ESTQATUAL - coalesce(PRODFILHO.ESTOQANALISE,0)) ESTOQUE_ATUAL,
  MAX(cast(nfentrada.dtentrada as date)) DATA_ENTRADA
from
  PRODFILHO
  inner join nfentradaitens on (PRODFILHO.codprodfilho = nfentradaitens.codprodfilho)
  inner join nfentrada on (nfentrada.codnfentrada = nfentradaitens.codnfentrada)
where
  cast(nfentrada.dtentrada as date) >= current_date - 7
  AND nfentrada.statusconferencia = 'ENTRADA LIBERADA'
  AND nfentrada.status <> 'C'
GROUP BY 1,2,3
;



/* View: SOFTSITE_CLI_ROTA */
CREATE OR ALTER VIEW SOFTSITE_CLI_ROTA(
    CD_VENDEDOR,
    CD_CLIENTE,
    CD_ROTA,
    NR_SEQ_ATEND)
AS
select PESSOA_VENDEDOR.CODVENDEDOR CD_VENDEDOR,
       PESSOA_VENDEDOR.CODPESSOA CD_CLIENTE,
       PESSOA_VENDEDOR.CODROTA_FK CD_ROTA,
       PESSOA.SEQ_ROTA NR_SEQ_ATEND
from PESSOA_VENDEDOR
inner join PESSOA on PESSOA.CODPESSOA = PESSOA_VENDEDOR.CODPESSOA
;



/* View: SOFTSITE_CLIENTES */
CREATE OR ALTER VIEW SOFTSITE_CLIENTES(
    CD_CLIENTE,
    NM_CLIENTE,
    NM_FANTASIA,
    DS_ENDERECO,
    NM_BAIRRO,
    NM_CIDADE,
    NM_ESTADO,
    CD_ROTA,
    NR_SEQ_ATEND,
    VR_SALDO_LIMITE,
    DS_SITUACAO,
    NR_TELEFONE,
    VR_LIMITE,
    NR_CEP,
    NR_CNPJ_CPF,
    NR_CGF,
    PC_SALDO_LIMITE_EXCEDENTE)
AS
select
  PESSOA.CODPESSOA CD_CLIENTE,
  PESSOA.NOME,
  PESSOA.NOMEFANTAZIA,
  PESSOA.LOGRADOURO_1,
  PESSOA.BAIRRO_1,
  PESSOA.CIDADE_1,
  PESSOA.UF_1,
  '' CD_ROTA,
  PESSOA.SEQ_ROTA NR_SEQ_ATEND,
  (select LIMITE_CREDITO.TOTALDISPONIVEL from LIMITE_CREDITO(PESSOA.CODPESSOA)) VR_SALDO_LIMITE,
  '' DS_SITUACAO,
  PESSOA.FONES NR_TELEFONE,
  PESSOA.LIMITECRED VR_LIMITE,
  PESSOA.CEP_1 NR_CEP,
  (select FU_GETTIRAMASCARA.STRRESULT from FU_GETTIRAMASCARA(PESSOA.CPFCGC)) NR_CNPJ_CPF,
  '' NR_CGF,
  0 PC_SALDO_LIMITE_EXCEDENTE
from PESSOA
where PESSOA.TIPOPESSOA = 'Cliente'
;



/* View: SOFTSITE_COND_PAGAMENTO */
CREATE OR ALTER VIEW SOFTSITE_COND_PAGAMENTO(
    CD_COND_PGTO,
    DS_COND_PGTO,
    QT_DIAS_TOTAL,
    PR_DESCONTO,
    DS_DIAS_PARCELAS,
    DS_PR_PARCELAS,
    NR_PRECO)
AS
select TIPOPAG.CODTIPOPAG CD_COND_PGTO,
TIPOPAG.DESCRICAO DS_COND_PGTO,
TIPOPAG.NRPRESTACAO * TIPOPAG.NRDIAS QT_DIAS_TOTAL,
0 PR_DESCONTO,
TIPOPAG.DESCRICAO DS_DIAS_PARCELAS,
'' DS_PR_PARCELAS,
0 NR_PRECO
from TIPOPAG
;



/* View: SOFTSITE_FAIXA_PRECO_PRODUTO */
CREATE OR ALTER VIEW SOFTSITE_FAIXA_PRECO_PRODUTO(
    CD_SEQUENCIAL,
    QT_MIN_FAIXA,
    VR_PRECO_MINIMO,
    VR_PRECO_SUGERIDO,
    VR_PRECO_MAXIMO)
AS
select '1'|| cast('1' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL,
1 QT_MIN_FAIXA,
PRODFILHO.PRECOPRATICADO1 VR_PRECO_MINIMO,
PRODFILHO.PRECOPRATICADO2 VR_PRECO_SUGERIDO,
PRODFILHO.PRECOPRATICADO3 VR_PRECO_MAXIMO
from PRODFILHO
;



/* View: SOFTSITE_FAMILIA */
CREATE OR ALTER VIEW SOFTSITE_FAMILIA(
    CD_FAMILIA,
    NM_FAMILIA,
    CD_FAMILIA_PAI)
AS
select GRUPO.CODGRUPO CD_FAMILIA,
GRUPO.DESCRICAO NM_FAMILIA,
'' CD_FAMILIA_PAI
from GRUPO
;



/* View: SOFTSITE_FORNECEDORES */
CREATE OR ALTER VIEW SOFTSITE_FORNECEDORES(
    CD_FORNECEDOR,
    DS_FORNECEDOR,
    ID_BLOQUEADO)
AS
select
  PESSOA.CODPESSOA CD_FORNECEDOR,
  PESSOA.NOME DS_FORNECEDOR,
  'S' ID_BLOQUEADO
from PESSOA
where PESSOA.TIPOPESSOA = 'Fornecedor'
;



/* View: SOFTSITE_GRUPO_MPGTO */
CREATE OR ALTER VIEW SOFTSITE_GRUPO_MPGTO(
    CD_GRUPO_MPGTO,
    DS_GRUPO)
AS
select 01 CD_GRUPO_MPGTO,
       'PAGAMENTO GERAL' DS_GRUPO
from RDB$DATABASE
;



/* View: SOFTSITE_MEIOS_PAGTO */
CREATE OR ALTER VIEW SOFTSITE_MEIOS_PAGTO(
    CD_MEIO_PGTO,
    DS_MEIO_PGTO,
    TP_MEIO_PGTO)
AS
select 1 CD_MEIO_PGTO, cast('CARTÃO' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 2 CD_MEIO_PGTO, cast('CHEQUE' as VARCHAR(30)) DS_MEIO_PGTO,
'C' TP_MEIO_PGTO
from RDB$DATABASE
union
select 3 CD_MEIO_PGTO, cast('DINHEIRO' as VARCHAR(30)) DS_MEIO_PGTO,
'D' TP_MEIO_PGTO
from RDB$DATABASE
union
select 4 CD_MEIO_PGTO, cast('VALE' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 5 CD_MEIO_PGTO, cast('DUPLICATA' as VARCHAR(30)) DS_MEIO_PGTO,
'U' TP_MEIO_PGTO
from RDB$DATABASE
union
select 6 CD_MEIO_PGTO, cast('BOLETO BANCÁRIO' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 7 CD_MEIO_PGTO, cast('PROMISSÓRIA' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 8 CD_MEIO_PGTO, cast('BONIFICAÇÃO' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 9 CD_MEIO_PGTO, cast('TROCA' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 10 CD_MEIO_PGTO, cast('FRETE' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
union
select 11 CD_MEIO_PGTO, cast('TRANSFERÊNCIA' as VARCHAR(30)) DS_MEIO_PGTO,
'O' TP_MEIO_PGTO
from RDB$DATABASE
;



/* View: SOFTSITE_ITEM_GRUPO_MPGTO */
CREATE OR ALTER VIEW SOFTSITE_ITEM_GRUPO_MPGTO(
    CD_GRUPO_MPGTO,
    CD_MEIO_PGTO,
    CD_COND_PGTO)
AS
select  1 CD_GRUPO_MPGTO,
        (
         select first 1 SOFTSITE_MEIOS_PAGTO.cd_meio_pgto
         from SOFTSITE_MEIOS_PAGTO
         where SOFTSITE_MEIOS_PAGTO.ds_meio_pgto = tipopag.tip_tipo
        ) CD_MEIO_PGTO,
        TIPOPAG.CODTIPOPAG CD_COND_PGTO
from TIPOPAG
;



/* View: SOFTSITE_LISTAPRODUTO */
CREATE OR ALTER VIEW SOFTSITE_LISTAPRODUTO(
    CD_ORG_VENDA,
    CD_TAB_PRECO,
    CD_PRODUTO,
    CD_SEQUENCIAL)
AS
select 1 CD_ORG_VENDA,
1 CD_TAB_PRECO,
PRODFILHO.CODPRODFILHO CD_PRODUTO,
'11' || PRODFILHO.CODPRODFILHO CD_SEQUENCIAL
from PRODFILHO
join produto on (produto.codproduto = prodfilho.codproduto)
where produto.ativo = 2
;
;



/* View: SOFTSITE_ORGVENDA */
CREATE OR ALTER VIEW SOFTSITE_ORGVENDA(
    CD_ORG_VENDA,
    NM_ORGANIZACAO,
    END_ORGANIZACAO,
    BAIRRO_ORGANIZACAO,
    CIDADE_ORGANIZACAO,
    UF_ORGANIZACAO,
    CNPJ_ORGANIZACAO,
    CD_ESTOQUE)
AS
select SYSPARAMS.CODSYSPARAMS CD_ORG_VENDA,
       SYSPARAMS.EMPRESA NM_ORGANIZACAO,
       SYSPARAMS.LOGRADOURO END_ORGANIZACAO,
       SYSPARAMS.BAIRRO BAIRRO_ORGANIZACAO,
       SYSPARAMS.CIDADE CIDADE_ORGANIZACAO,
       SYSPARAMS.UF UF_ORGANIZACAO,
       (select fu_gettiramascara.strresult from fu_gettiramascara(sysparams.CGC)) CNPJ_ORGANIZACAO,
       null CD_ESTOQUE
from SYSPARAMS
;



/* View: SOFTSITE_ORGVENDA_CLIENTE */
CREATE OR ALTER VIEW SOFTSITE_ORGVENDA_CLIENTE(
    CD_ORG_VENDA,
    CD_CLIENTE,
    CD_VENDEDOR,
    CD_TAB_PRECO,
    CD_GRUPO_MPGTO)
AS
SELECT 1 CD_ORG_VENDA,
PESSOA.CODPESSOA CD_CLIENTE,
PESSOA.CODVENDEDOR CD_VENDEDOR,
1 CD_TAB_PRECO,
1 CD_GRUPO_MPGTO --PESSOA.codtipopag1 CD_GRUPO_MPGTO
FROM PESSOA
WHERE PESSOA.TIPOPESSOA = 'Cliente'
and coalesce(PESSOA.CODTIPOPAG1,0) > 0
and coalesce(PESSOA.CODVENDEDOR,0) > 0
;



/* View: SOFTSITE_PRODUTO */
CREATE OR ALTER VIEW SOFTSITE_PRODUTO(
    CD_PRODUTO,
    NM_PRODUTO,
    DS_UNIDADE_BASE,
    QT_BASE,
    CD_FAMILIA,
    QT_ESTOQUE,
    DS_OBS_PRODUTO,
    QT_UNIDADE,
    CD_REFERENCIA,
    PS_PRODUTO_KG,
    VR_MAX_PC_DESCONTO,
    VR_MAX_PC_ACRESCIMO,
    CD_FORNECEDOR,
    ID_MONITORADO)
AS
select PRODFILHO.CODPRODFILHO CD_PRODUTO,
PRODFILHO.DESCRICAO NM_PRODUTO,
SUBSTRING(UNIDADE.SIGLA FROM 1 for 3) DS_UNIDADE_BASE,
'1' QT_BASE, --PRODFILHO.QTDEMBALAGEM QT_BASE,
PRODUTO.CODGRUPO CD_FAMILIA,
PRODFILHO.ESTQATUAL QT_ESTOQUE,
PRODFILHO.DADOS1 DS_OBS_PRODUTO,
PRODFILHO.QTDEMBALAGEM QT_UNIDADE,
PRODFILHO.CODPESQ1 CD_REFERENCIA,
PRODFILHO.PESOLIQUIDO PS_PRODUTO_KG,
PRODFILHO.DESCONTDESEJ VR_MAX_PC_DESCONTO,
0 VR_MAX_PC_ACRESCIMO,
PRODPESSOA.CODPESSOA CD_FORNECEDOR,
'' ID_MONITORADO
from PRODFILHO
inner join UNIDADE on UNIDADE.CODUNIDADE = PRODFILHO.CODUNIDADE
inner join PRODUTO on PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
left join PRODPESSOA on PRODPESSOA.CODPRODUTO = PRODFILHO.CODPRODFILHO
where PRODUTO.ATIVO = 2
;



/* View: SOFTSITE_ROTA */
CREATE OR ALTER VIEW SOFTSITE_ROTA(
    CD_ROTA,
    DS_ROTA)
AS
select ROTA.CODROTA CD_ROTA,
       ROTA.DESCRICAO DS_ROTA
from ROTA
;



/* View: SOFTSITE_SEQUENCIAL */
CREATE OR ALTER VIEW SOFTSITE_SEQUENCIAL(
    CD_SEQUENCIAL)
AS
select '1'|| cast('1' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL
from PRODFILHO
union
select '1'|| cast('2' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL
from PRODFILHO
union
select '1'|| cast('3' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL
from PRODFILHO
union
select '1'|| cast('4' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL
from PRODFILHO
union
select '1'|| cast('5' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL
from PRODFILHO
union
select '1'|| cast('6' || PRODFILHO.CODPRODFILHO as varchar(10)) CD_SEQUENCIAL
from PRODFILHO
;



/* View: SOFTSITE_SUPERVISOR */
CREATE OR ALTER VIEW SOFTSITE_SUPERVISOR(
    CD_SUPERVISOR,
    NM_SUPERVISOR,
    CD_USUARIO,
    CD_SUPERVISOR_PAI,
    DS_TELEFONE)
AS
select SUPERVISOR.CODSUPERVISOR CD_SUPERVISOR,
SUPERVISOR.NOME NM_SUPERVISOR,
0 CD_USUARIO,
0 CD_SUPERVISOR_PAI,
SUPERVISOR.FONES DS_TELEFONE
from SUPERVISOR
;



/* View: SOFTSITE_TAB_PRECO */
CREATE OR ALTER VIEW SOFTSITE_TAB_PRECO(
    CD_TAB_PRECO,
    DS_TAB_PRECO)
AS
select 01 CD_TAB_PRECO,
       'TABELA 01' DS_TAB_PRECO
from RDB$DATABASE
;



/* View: SOFTSITE_TITULOS */
CREATE OR ALTER VIEW SOFTSITE_TITULOS(
    CD_TITULO,
    CD_CLIENTE,
    DT_LANCAMENTO,
    VR_TITULO,
    DT_VENCIMENTO,
    CD_MEIO_PGTO)
AS
select CONTA.CODCONTA CD_TITULO,
CONTA.CODPESSOA CD_CLIENTE,
CONTA.DT_EMISSAO DT_LANCAMENTO,
CONTA.VLPARCELA VR_TITULO,
CONTA.DT_VENCIM DT_VENCIMENTO,
coalesce((select softsite_meios_pagto.cd_meio_pgto
from softsite_meios_pagto where
softsite_meios_pagto.ds_meio_pgto = CONTA.prev_tipopag),6) CD_MEIO_PGTO
from CONTA
inner join PESSOA on PESSOA.CODPESSOA = CONTA.CODPESSOA
where PESSOA.TIPOPESSOA = 'Cliente'
      AND CONTA.tipo = 'RECEBER'
      AND CONTA.status = 'ABERTO'
;



/* View: SOFTSITE_TRANSPORTADORA */
CREATE OR ALTER VIEW SOFTSITE_TRANSPORTADORA(
    CD_TRANSPORTADORA,
    NM_TRANSPORTADORA,
    NM_ESTADO,
    NM_CIDADE)
AS
select TRANSPORT.CODTRANSPORT CD_TRANSPORTADORA,
TRANSPORT.NOME NM_TRANSPORTADORA,
TRANSPORT.UF NM_ESTADO,
TRANSPORT.CIDADE NM_CIDADE
from TRANSPORT
;



/* View: SOFTSITE_TRANSPORTADORA_CLIENTE */
CREATE OR ALTER VIEW SOFTSITE_TRANSPORTADORA_CLIENTE(
    CD_CLIENTE,
    CD_TRANSPORTADORA)
AS
select PESSOA.CODPESSOA CD_CLIENTE,
PESSOA.CODTRANSPORT CD_TRANSPORTADORA
from PESSOA
where
coalesce(PESSOA.CODTRANSPORT,0) <> 0
and PESSOA.TIPOPESSOA = 'Cliente'
;



/* View: SOFTSITE_VENDEDOR */
CREATE OR ALTER VIEW SOFTSITE_VENDEDOR(
    CD_VENDEDOR,
    NM_VENDEDOR)
AS
select VENDEDOR.CODVENDEDOR CD_VENDEDOR,
       VENDEDOR.NOME NM_VENDEDOR
from VENDEDOR
;



/* View: TP_CLI */
CREATE OR ALTER VIEW TP_CLI(
    CODSTATUS,
    DESCRICAO)
AS
select
  CODSTATUS,
  DESCRICAO
from
  STATUS
;



/* View: TP_ESTOQ */
CREATE OR ALTER VIEW TP_ESTOQ(
    CODIGO,
    NOME,
    DESCRICAO,
    QTMINIMA,
    ESTOQUESEGURO,
    VENDEDOR)
AS
SELECT 1  , RAZAOSOCIAL  , '' , '', '', ''  FROM SYSPARAMS
;



/* View: TP_PRODUTO */
CREATE OR ALTER VIEW TP_PRODUTO(
    CODGRUPO,
    DESCRICAO)
AS
select
  CODGRUPO, DESCRICAO
from
  GRUPO
;



/* View: VABASTECIMENTOPICKING */
CREATE OR ALTER VIEW VABASTECIMENTOPICKING(
    DOCUMENTO,
    DATA,
    USUARIO)
AS
select distinct
  cast(M.DOCUMENTO as integer),
  M.DATA,
  M.USUARIO
from
  MOVESTOQUE M
where
  M.TIPODOC = 'AP' and
  M.TIPOMOV = 'S'
;



/* View: VCFOP */
CREATE OR ALTER VIEW VCFOP(
    CODCFOP,
    CFOP)
AS
select
  CFOP.CODCFOP,
  CFOP||' - '||NATUREZA CFOP
from
  CFOP
;



/* View: VCHEQUES */
CREATE OR ALTER VIEW VCHEQUES(
    TIPOCHEQUE,
    ID,
    CODCONTABANCO,
    CH_BANCO,
    CH_AGENCIA,
    CH_CONTA,
    CH_NRCHEQUE,
    CH_BOMPARA,
    CH_STATUS,
    CH_DTCOMPENSADO,
    VLPAGO)
AS
select
  1 TIPOCHEQUE,
  CB.CH_BANCO || CB.CH_AGENCIA || CB.CH_CONTA || CB.CH_NRCHEQUE,
  CB.CODCONTABANCO,
  CB.CH_BANCO,
  CB.CH_AGENCIA,
  CB.CH_CONTA,
  CB.CH_NRCHEQUE,
  CB.CH_BOMPARA,
  CB.CH_STATUS,
  CB.CH_DTCOMPENSADO,
  sum(CB.VLPAGO)
from
  CONTABX CB
  join CONTA C on
    CB.CODCONTA = C.CODCONTA
where
  CB.TIPOPAG in ('CHEQUE','CHEQUE-PRE') and
  C.TIPO              = 'RECEBER'
group by
  1,2,
  CB.CH_BANCO,
  CB.CH_AGENCIA,
  CB.CH_CONTA,
  CB.CH_NRCHEQUE,
  CB.CH_BOMPARA,
  CB.CH_STATUS,
  CB.CH_DTCOMPENSADO,
  CB.CODCONTABANCO

   union
   select
    2 TIPOCHEQUE,
    C.BANCO || C.AGENCIA || C.CONTA || C.NRCHEQUE,
    c.CODCONTABANCO,
    C.BANCO CH_BANCO,
    C.AGENCIA CH_AGENCIA,
    C.CONTA CH_CONTA,
    C.NRCHEQUE CH_NRCHEQUE,
    C.BOMPARA CH_BOMPARA,
    c.status CH_STATUS,
    c.DTCOMPENSADO CH_DTCOMPENSADO,
    sum(C.VALOR) VALOR
  from
    CHEQUE_AVULSO C
  group by
    1,2,3,4,5,6,7,8,9,10
;



/* View: VEN_VENDEDOR */
CREATE OR ALTER VIEW VEN_VENDEDOR(
    NOME,
    CPFCGC,
    CODVENDEDOR,
    CODSUPERVISOR,
    CODGERENTE,
    QTD,
    VEN_TIPO_META,
    VEN_CD_EMPREGADORA_IMPORT)
AS
SELECT 
  VENDEDOR.NOME AS VEN_NOME,
  VENDEDOR.CPFCGC AS VEN_CPF,
  VENDEDOR.CODVENDEDOR AS VEN_CD_VENDEDOR_IMPORT,
  VENDEDOR.CODSUPERVISOR AS VEN_CD_SUPERVISOR_IMPORT,
  '01' as VEN_CD_GERENTE_IMPORT,
  VENDEDORMETAS.QTD AS VEN_META,
  'QTD' AS VEN_TIPO_META,
  'NULO' AS VEN_CD_EMPREGADORA_IMPORT
FROM
 VENDEDOR
 INNER JOIN VENDEDORMETAS ON (VENDEDOR.CODVENDEDOR=VENDEDORMETAS.CODVENDEDOR)
;



/* View: VENDASPERIODO */
CREATE OR ALTER VIEW VENDASPERIODO(
    CODPRODFILHO,
    PRECOPROD,
    PRECOVEND,
    QTDE,
    DESCRICAO,
    DT_SAIDA)
AS
SELECT PEDVENDITEM.CODPRODFILHO, PEDVENDITEM.PRECOPROD, PEDVENDITEM.PRECOVEND, PEDVENDITEM.QTDE, PRODFILHO.DESCRICAO, Pedvend.DT_SAIDA
FROM PEDVENDITEM,PRODFILHO,Pedvend
where
(PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO) and
(PEDVENDITEM.CODPEDVEND = Pedvend.CODPEDVEND) and
(Pedvend.statusped <> 'CANCELADO')
;



/* View: VEXPORTAPED */
CREATE OR ALTER VIEW VEXPORTAPED(
    NUMPED,
    DATAPED,
    CODCLI,
    CODVEN,
    TIPO,
    PRAZO,
    PAGTO,
    TOTITENS,
    VALTOT,
    ASSINATURA,
    TABELA,
    DESCCOM,
    FRETE)
AS
select
  RIGHT('00000000' || cast(CODPEDVEND as varchar(8)) ,8) as NUMPED,
  cast(DT_SAIDA as date) DATAPED,
  RIGHT('0000000' || cast(CODPESSOA as varchar(7)) ,7) as CODCLI,
  RIGHT('00000' || cast(CODVENDEDOR as varchar(5)) ,5) as CODVEN,
  case TIPOPED
    when 'CADERNO' then 'OR'
  else
    'VD'
  end TIPO,
  RIGHT('000' || cast(coalesce(CODTIPOPAG,1) as varchar(5)) ,3) as PRAZO,
  coalesce((select CODIGO from SLPAGTO where TIPOPAG = PEDVEND.TIPOPAG),'E') PAGTO,
  cast(NRITENS as numeric(6,0)) TOTITENS,
  cast(VALOR_TOTAL as numeric(18,5)) VALTOT,
--  (coalesce(OBSPED1,'')||coalesce(OBSPED2,'')||coalesce(OBSPED3,'')) ASSINATURA,
  '',
  substring(PRECOUSADO from 6 for 1) TABELA,
  cast(DESC_VALOR as numeric(4,0)) DESCCOM,
  case TIPOFRETE
    when 1 then 0
    when 2 then 1
    when 3 then 2
  else
    0
  end FRETE
from
  PEDVEND
;



/* View: VEXPORTAPEDITEM */
CREATE OR ALTER VIEW VEXPORTAPEDITEM(
    NUMPED,
    CODPRO,
    CODAPR,
    PRECO,
    QUANT,
    DESCONTO,
    DATAPED)
AS
SELECT
  RIGHT('00000000' || CAST(pedvend.CODPEDVEND AS VARCHAR(8)) ,8) AS NUMPED,
  RIGHT('00000000' || CAST(CODPRODFILHO AS VARCHAR(7)) ,7) AS CODPRO,
  RIGHT('0000' || '999',4) AS CODAPR,
  CAST(PRECOPROD AS NUMERIC(18,5)) PRECO,
  CAST(QTDENTREGUE AS NUMERIC(6,0)) QUANT,
  CAST(PEDVENDITEM.DESCONTO AS NUMERIC(18,5)),
  cast(DT_SAIDA as date) DATAPED
FROM
  PEDVEND
  INNER JOIN PEDVENDITEM ON PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
;



/* View: VFINANCFORNEC */
CREATE OR ALTER VIEW VFINANCFORNEC(
    DOCUMENTO,
    CODPESSOA,
    PESSOA,
    EMISSAO,
    VENCIMENTO,
    CODPRODUTO,
    CODPESQUISA,
    DESCPRODUTO,
    QTD,
    VALORUNIT,
    VALORTOT,
    DATAVENDA,
    TIPO,
    VALORTOTAL,
    TOTALPAGO)
AS
select
  PEDCPR.CODPEDCPR,
  CONTA.CODPESSOA,
  PESSOA.NOME,
  CONTA.DT_EMISSAO,
  CONTA.DT_VENCIM,
  PEDCPRITENS.CODPRODFILHO,
  PEDCPRITENS.CODPESQUISA,
  PRODFILHO.DESCRICAO,
  PEDCPRITENS.QTDEPEDIDA,
  PEDCPRITENS.VALOR_UNIT,
  PEDCPRITENS.VALORITEM,
  PEDCPR.DT_EMISSAO EMISSAO,
  CONTA.TIPO,
  SUM(coalesce(CONTA.VLPARCELA,0)) VALORTOTAL,
  SUM(coalesce(CONTABX.VLPAGO,0)) TOTPAGO
from
  CONTA
  inner join PEDCPR on PEDCPR.CODPEDCPR = CONTA.CODPEDCOMPRA
  inner join PEDCPRITENS on PEDCPRITENS.CODPEDCPR = PEDCPR.CODPEDCPR
  inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDCPRITENS.CODPRODFILHO
  inner join PESSOA on PESSOA.CODPESSOA = CONTA.CODPESSOA
  left join CONTABX on CONTABX.CODCONTA = CONTA.CODCONTA
where
  CONTA.STATUS = 'ABERTO' and
  CONTA.TIPO = 'PAGAR'
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
union
select
  PEDVEND.CODPEDVEND,
  CONTA.CODPESSOA,
  PESSOA.NOME,
  CONTA.DT_EMISSAO,
  CONTA.DT_VENCIM,
  PEDVENDITEM.CODPRODFILHO,
  PEDVENDITEM.CODPESQUISA,
  PRODFILHO.DESCRICAO,
  PEDVENDITEM.QTDE,
  PEDVENDITEM.PRECOPROD,
  PEDVENDITEM.PRECOVEND,
  PEDVEND.DT_SAIDA DATA,
  CONTA.TIPO,
  SUM(coalesce(CONTA.VLPARCELA,0)) VALORTOTAL,
  SUM(coalesce(CONTABX.VLPAGO,0)) TOTPAGO
from
  CONTA
  inner join PEDVEND on PEDVEND.CODPEDVEND = CONTA.CODPENDVEND
  inner join PEDVENDITEM on PEDVENDITEM.CODPEDVENDITEM = PEDVEND.CODPEDVEND
  inner join PRODFILHO on PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO
  inner join PESSOA on PESSOA.CODPESSOA = CONTA.CODPESSOA
  left join CONTABX on CONTABX.CODCONTA = CONTA.CODCONTA
where
  CONTA.STATUS = 'ABERTO' and
  CONTA.TIPO = 'RECEBER'
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
;



/* View: VIEW_CFOP */
CREATE OR ALTER VIEW VIEW_CFOP(
    CFOP,
    NATUREZA)
AS
SELECT DISTINCT CFOP, NATUREZA FROM CFOP
;



/* View: VIEW_ESTOQUE */
CREATE OR ALTER VIEW VIEW_ESTOQUE(
    CODPRODFILHO,
    ESTQATUAL)
AS
select
  CODPRODFILHO, CAST(ESTQATUAL AS NUMERIC(10,2)) AS ESTQATUAL
from
  PRODFILHO
    INNER JOIN PRODUTO ON (PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO)
where PRODUTO.ATIVO = 2
;



/* View: VIEW_PEDVENDVIEWCAIXAOP */
CREATE OR ALTER VIEW VIEW_PEDVENDVIEWCAIXAOP(
    CODPEDVEND,
    CODNFVENDA,
    STATUSPED,
    TIPOPED,
    CODPESSOA,
    NOME,
    CODVENDEDOR,
    VENDEDOR,
    DT_SAIDA,
    VALOR_BRUTO,
    VALOR_TOTAL,
    NRFORMULARIO,
    CODEMBARQUE,
    PDV_NUMEROPEDCLI,
    FINANC,
    ACRESCIMO,
    ACRESVALOR,
    DESCONTO,
    DESC_VALOR,
    FRETE,
    MONTAGEM,
    PERC_FRETE,
    CODEMPRESA)
AS
select
  P.CODPEDVEND,
  coalesce(P.CODFATURAMENTO, P.CODNFVENDA) CODNFVENDA,
  case P.STATUSPED
    when 'NORMAL' then
      case P.PDV_CRITICA
        when 'C' then 'BLOQUEADO'
        when 'B' then 'NORMAL'
      else
        'LIBERADO'
      end
  else
    P.STATUSPED
  end STATUSPED,
  P.TIPOPED,
  P.CODPESSOA,
  PE.NOME,
  V.CODVENDEDOR,
  V.NOME,
  P.DT_SAIDA,
  P.VALOR_BRUTO ,
  P.VALOR_TOTAL,
  NRFORMULARIO,
  E.CODEMBARQUE_FK,
  P.PDV_NUMEROPEDCLI,
  coalesce(P.FINANC, 'N'),
  coalesce(P.ACRESCIMO, 0),
  coalesce(P.ACRESVALOR, 0),
  coalesce(P.DESCONTO, 0),
  coalesce(P.DESC_VALOR, 0),
  P.FRETE,
  P.MONTAGEM, 
  P.PERC_FRETE,
  P.CODEMPRESA
from
  PEDVEND P
  join PESSOA PE on P.CODPESSOA = PE.CODPESSOA
  join VENDEDOR V on P.CODVENDEDOR = V.CODVENDEDOR
  left join EMBARQUEITEM E on P.CODPEDVEND = E.CODPEDVEND_FK
  join TIPOVENDA on
    P.TIPOPED = TIPOVENDA.TIPOPED
    and coalesce(TIPOVENDA.EXIBIRCAIXAOP,'S') = 'S'
;



/* View: VIEW_PESQUISA_PRODUTOS */
CREATE OR ALTER VIEW VIEW_PESQUISA_PRODUTOS(
    CODPRODFILHO,
    CODPRODUTO,
    CODPESQ1,
    ATIVO,
    DESCRICAO,
    CUSTO,
    PRECOPRATICADO1,
    PRECOPRATICADO2,
    PRECOPRATICADO3,
    PRECOPRATICADO4,
    PRECOPRATICADO5,
    PRECOPRATICADO6,
    ESTQATUAL,
    CONFERENCIA,
    CLASSFISCAL,
    CODIGOCEST,
    CFOP,
    PRDF_CST_TRIBICMS,
    TRIBUTACAO)
AS
SELECT
    prodfilho.codprodfilho,
    produto.codproduto,
    prodfilho.codpesq1,
    CASE produto.ativo
        WHEN 1 THEN 'N'
        ELSE 'S'
    END AS "ATIVO",
    prodfilho.descricao,
    prodfilho.precofornec AS CUSTO,
    prodfilho.precopraticado1,
    prodfilho.precopraticado2,
    prodfilho.precopraticado3,
    prodfilho.precopraticado4,
    prodfilho.precopraticado5,
    prodfilho.precopraticado6,
    prodfilho.estqatual,
    (SELECT SALDO FROM stp_retorna_fiscais(prodfilho.codprodfilho,(SELECT CODEMPRESA FROM empresa))) AS CONFERENCIA,
    prodfilho.classfiscal,
    cest.codigocest,
    cfop.cfop,
    prodfilho.prdf_cst_tribicms,
    distintivos_cfop.descricao AS TRIBUTACAO
FROM
    prodfilho
INNER JOIN
    produto ON(prodfilho.codproduto = produto.codproduto)
LEFT JOIN
    CFOP ON (prodfilho.codcfopvendadentro = cfop.codcfop)
LEFT JOIN
    CEST ON (prodfilho.codcest = CEST.codcest)
LEFT JOIN
    distintivos_cfop ON (distintivos_cfop.coddistintivos_cfop = prodfilho.prdf_distintivo)
WHERE
    produto.ativopesq = 1
;



/* View: VIEW_PRODUTO */
CREATE OR ALTER VIEW VIEW_PRODUTO(
    CODPRODFILHO,
    CODFORNEC,
    CODGRUPO,
    CODUNIDADE,
    DESCRICAO,
    OBS,
    QTDEMBALAGEM,
    ACEITARPERDA,
    PESO_PECA)
AS
select
        CODPRODFILHO, (SELECT FIRST 1 CODPESSOA FROM PRODPESSOA WHERE CODPRODUTO = PRODFILHO.CODPRODFILHO) CODFORNEC,
       CODGRUPO, CODUNIDADE, PRODFILHO.DESCRICAO, OBS, QTDEMBALAGEM, coalesce(ACEITARPERDA, 'N') ACEITARPERDA, PRODFILHO.PESO_PECA
      from
        PRODFILHO
        INNER JOIN PRODUTO ON (PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO)
      where PRODUTO.ATIVO = 2
;



/* View: VIEW_UNIDADE */
CREATE OR ALTER VIEW VIEW_UNIDADE(
    CODUNIDADE,
    SIGLA,
    TRAVA_FRACIONADO)
AS
select
   codunidade,
   sigla,
   trava_fracionado
from
  UNIDADE
;



/* View: VIEWREL12 */
CREATE OR ALTER VIEW VIEWREL12(
    CODVEND,
    TIP_PEDIDO,
    CODGRUPO,
    CODSUBGRUPO,
    VLR_BRUTO,
    VLR_TOTAL,
    SAIDA,
    FATORDESCONTO,
    PEDIDO,
    DESC_VALOR,
    DESCPERC_VALOR,
    ITENSVENDIDOS,
    CODFABRICANTE,
    FORNECEDOR,
    CLIENTE)
AS
select
  PEDVEND.CODVENDEDOR,
  PEDVEND.TIPOPED,
  PRODUTO.CODGRUPO,
  PRODUTO.CODSUBGRUPO,
  (PEDVENDITEM.PRECOPROD * PEDVENDITEM.QTDE),
  PEDVENDITEM.PRECOVEND,
  PEDVEND.DT_SAIDA,
  (PEDVENDITEM.PRECOVEND / coalesce(nullif(PEDVEND.VALOR_BRUTO,0),1)),
  PEDVEND.CODPEDVEND,
  coalesce(PEDVEND.DESC_VALOR,0),
  coalesce(PEDVEND.DESCPERC_VALOR,0),
  PEDVENDITEM.CODPEDVENDITEM,
  PRODUTO.CODFABRICANTE,
  PRODPESSOA.CODPESSOA,
  PEDVEND.CODPESSOA
from
  PEDVEND
  join PEDVENDITEM on
    PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
  join PRODFILHO on
    PEDVENDITEM.CODPRODFILHO = PRODFILHO.CODPRODFILHO
  join PRODPESSOA on
    PRODFILHO.CODPRODUTO = PRODPESSOA.CODPRODUTO
  join PRODUTO on
    PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO
;



/* View: VISAOGRUPO */
CREATE OR ALTER VIEW VISAOGRUPO(
    CODGRUPO,
    DESCRICAO)
AS
SELECT GRUPO.CODGRUPO, GRUPO.DESCRICAO FROM GRUPO
;



/* View: VISAOPRODUTO */
CREATE OR ALTER VIEW VISAOPRODUTO(
    CODPRODFILHO,
    DESCRICAO,
    CODGRUPO,
    CODSUBGRUPO,
    OBS)
AS
SELECT A.CODPRODFILHO as CODIGO, B.DESCRICAO as DESCRICAO,B.CODGRUPO as GRUPO,
  B.CODSUBGRUPO as SUBGRUPO, B.OBS as OBSERVACAO
  FROM PRODFILHO A, PRODUTO B  where a.CODPRODUTO = B.CODPRODUTO
;



/* View: VISAORANCKINGVENDAS */
CREATE OR ALTER VIEW VISAORANCKINGVENDAS(
    TOTAL_QTD,
    TOTAL_VALOR,
    DESCRICAO,
    CODGRUPO,
    DESC_GRUPO,
    CODSUBGRUPO,
    DESC_SUBGRUPO)
AS
select sum(qtde) TOTAL_QTD, SUM(PRECOVEND) TOTAL_VALOR,  PRODFILHO.DESCRICAO,
PRODUTO.CODGRUPO,  GRUPO.DESCRICAO DESC_GRUPO, PRODUTO.CODSUBGRUPO, SUBGRUPO.DESCRICAO DESC_SUBGRUPO
 from pedvenditem
inner join PRODFILHO on (PRODFILHO.CODPRODFILHO = PEDVENDITEM.CODPRODFILHO)
inner join PRODUTO on (PRODUTO.CODPRODUTO = PRODFILHO.CODPRODUTO)
inner join GRUPO on (GRUPO.CODGRUPO = PRODUTO.CODGRUPO)
inner join SUBGRUPO on (SUBGRUPO.CODSUBGRUPO = PRODUTO.CODSUBGRUPO)
group by 3,4,5,6,7
;



/* View: VISAOSUBGRUPO */
CREATE OR ALTER VIEW VISAOSUBGRUPO(
    CODSUBGRUPO,
    DESCRICAO,
    CODGRUPO)
AS
SELECT SUBGRUPO.CODSUBGRUPO, SUBGRUPO.DESCRICAO, SUBGRUPO.CODGRUPO FROM SUBGRUPO
;



/* View: VNFENTRADAITENS */
CREATE OR ALTER VIEW VNFENTRADAITENS(
    CODNFENTRADAITENS,
    CODNFENTRADA,
    CODPRODFILHO,
    CODPESQUISA,
    IPIPERC,
    QTD,
    PRODVLR,
    DIFICMS,
    DESPESASRATEADAS,
    FRETERATEADO,
    SEGURORATEADO,
    DESCONTORATEADO,
    PRECOSUGERIDO,
    ATUALIZAPRECO,
    PRECOCOMPRAANTERIOR,
    CODUNIDADE,
    CODPEDCPR,
    CODPEDCPRITENS,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    MARKUP1,
    MARKUP2,
    MARKUP3,
    MARKUP4,
    MARKUP5,
    MARKUP6,
    VALORTOTAL,
    ATZMARK,
    ATZPREC,
    VL_IPIPERC,
    VL_DIFICMS,
    FRETEPERCLTDA,
    FRETEVLRLTDA,
    IPISOBREFRETE,
    ICMSSOBREFRETE,
    FRETEAVULSO,
    CUSTOREPOSI,
    CODCFOP,
    CFOP_CFOP,
    QTDEM3,
    ALIQ_SUBS,
    PERC_VA,
    VA_VALOR,
    BASE_SUBS,
    VALOR_SUBS,
    PESO,
    GNRE_TOTAL,
    TOTAL_NOTA,
    CUSTO_UNIT_IPI_GNRE,
    TOTAL_FRETE_PESO,
    TOTAL_FRETE_VALOR,
    CUSTO_TOTAL,
    CUSTO_UNITARIO,
    TOTALCOMIPI,
    CUSTOUNITCOMIPI,
    QTD_CAIXA,
    VALOR_CAIXA,
    QTDPECAS,
    COD_PROD_MARGEM,
    DESCTO_ITEM,
    DESCTO_ABC,
    NFEI_DESCAUX,
    QTD_VIACEGA,
    QTD_PEDIDO,
    DT_FABRICACAO,
    DT_VALIDADE,
    SITUACAO_VALIDADE,
    FATORCONVERSAO,
    DESCTO_ITEM_PERC,
    PERC_REDUCAO,
    AUX_PESOEMB,
    DESC_PRODFILHO_AUX,
    PRECOSUGERIDO1,
    PRECOSUGERIDO2,
    PRECOSUGERIDO3,
    PRECOSUGERIDO4,
    PRECOSUGERIDO5,
    PRECOSUGERIDO6,
    CODPRODUTO,
    DESC_PRECOPRATICADO1,
    AUX_FATORPROD,
    QTDPRODEMB,
    AUX_COD3,
    VALORTOT_CALC,
    TOTPROD,
    FRETEVLRCALC,
    IPI_VALOR,
    ICMS_VALOR,
    FRETAVULSOCALC,
    VAL_VA,
    VAL_BASESUBS,
    VAL_SUBS,
    UNIDADE,
    CODPESQ1,
    CODPESQ2,
    PISPERC,
    PISVALOR,
    COFINSPERC,
    COFINSVALOR,
    FRETESOBREIPI,
    BASE_IPI,
    STATUS,
    DESC_UNIDADE,
    DESC_CFOP_CFOP)
AS
select
  NI.CODNFENTRADAITENS,
  NI.CODNFENTRADA,
  NI.CODPRODFILHO,
  NI.CODPESQUISA,
  NI.IPIPERC,
  NI.QTD,
  NI.PRODVLR,
  NI.DIFICMS,
  NI.DESPESASRATEADAS,
  NI.FRETERATEADO,
  NI.SEGURORATEADO,
  NI.DESCONTORATEADO,
  NI.PRECOSUGERIDO,
  NI.ATUALIZAPRECO,
  NI.PRECOCOMPRAANTERIOR,
  NI.CODUNIDADE,
  NI.CODPEDCPR,
  NI.CODPEDCPRITENS,
  NI.US_CADAST,
  NI.DT_CADAST,
  NI.US_MODIFI,
  NI.DT_MODIFI,
  NI.MARKUP1,
  NI.MARKUP2,
  NI.MARKUP3,
  NI.MARKUP4,
  NI.MARKUP5,
  NI.MARKUP6,
  NI.VALORTOTAL,
  NI.ATZMARK,
  NI.ATZPREC,
  NI.VL_IPIPERC,
  NI.VL_DIFICMS,
  NI.FRETEPERCLTDA,
  NI.FRETEVLRLTDA,
  NI.IPISOBREFRETE,
  NI.ICMSSOBREFRETE,
  NI.FRETEAVULSO,
  NI.CUSTOREPOSI,
  NI.CODCFOP,
  NI.CFOP_CFOP,
  NI.QTDEM3,
  NI.ALIQ_SUBS,
  NI.PERC_VA,
  NI.VA_VALOR,
  NI.BASE_SUBS,
  NI.VALOR_SUBS,
  NI.PESO,
  NI.GNRE_TOTAL,
  NI.TOTAL_NOTA,
  NI.CUSTO_UNIT_IPI_GNRE,
  NI.TOTAL_FRETE_PESO,
  NI.TOTAL_FRETE_VALOR,
  NI.CUSTO_TOTAL,
  NI.CUSTO_UNITARIO,
  NI.TOTALCOMIPI,
  NI.CUSTOUNITCOMIPI,
  NI.QTD_CAIXA,
  NI.VALOR_CAIXA,
  NI.QTDPECAS,
  NI.COD_PROD_MARGEM,
  NI.DESCTO_ITEM,
  NI.DESCTO_ABC,
  NI.NFEI_DESCAUX,
  NI.QTD_VIACEGA,
  NI.QTD_PEDIDO,
  NI.DT_FABRICACAO,
  NI.DT_VALIDADE,
  NI.SITUACAO_VALIDADE,
  NI.FATORCONVERSAO,
  NI.DESCTO_ITEM_PERC,
  NI.PERC_REDUCAO,
  coalesce(PF.PRDF_PESOEMBALAGEM,1)  AUX_PESOEMB,
  PF.DESCRICAO  DESC_PRODFILHO_AUX,
  coalesce(PF.PRECOSUGERIDO1,0) PRECOSUGERIDO1,
  coalesce(PF.PRECOSUGERIDO2,0) PRECOSUGERIDO2,
  coalesce(PF.PRECOSUGERIDO3,0) PRECOSUGERIDO3,
  coalesce(PF.PRECOSUGERIDO4,0) PRECOSUGERIDO4,
  coalesce(PF.PRECOSUGERIDO5,0) PRECOSUGERIDO5,
  coalesce(PF.PRECOSUGERIDO6,0) PRECOSUGERIDO6,
  PF.CODPRODUTO CODPRODUTO,
  coalesce(PF.PRECOPRATICADO1,0) DESC_PRECOPRATICADO1,
  coalesce(PF.FATORCONVERSAO,0) AUX_FATORPROD,
  coalesce(NI.QTDPRODEMB, PF.QTDEMBALAGEM,1) QTDPRODEMB,
  coalesce(PF.CODPESQ3,'') AUX_COD3,
  coalesce((NI.QTD * NI.PRODVLR - NI.DESCTO_ITEM),0) VALORTOT_CALC,
  coalesce(((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0)) + coalesce(NI.FRETEVLRLTDA,0) + ((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) * (coalesce(NI.FRETEPERCLTDA,0) / 100)) - coalesce(NI.DESCTO_ITEM,0)),0) TOTPROD,
  coalesce(((NI.PRODVLR * NI.QTD) * (NI.FRETEPERCLTDA / 100)),0) FRETEVLRCALC,
  case (select TIPOEMPRESA from SYSPARAMS)
    when 1 then
      case coalesce(NI.IPISOBREFRETE,'N')
        when 'S' then
        coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
      else
        coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.IPIPERC,0) / 100))),0)
      end
  else
    case coalesce(NI.IPISOBREFRETE,'N')
      when 'S' then
      coalesce((((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) - coalesce(NI.DESCTO_ITEM,0) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
    else
      coalesce((((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
    end
  end IPI_VALOR,
  case (select TIPOEMPRESA from SYSPARAMS)
    when 1 then
    case coalesce(NI.ICMSSOBREFRETE,'N')
      when 'S' then
      coalesce(((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.DIFICMS,0) / 100),0)
    else
      case (select SYS_OPTANTESIMPLES from SYSPARAMS)
        when 'S' then
        (((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) +
        (case (select TIPOEMPRESA from SYSPARAMS)
          when 1 then
          case NI.IPISOBREFRETE
            when 'S' then
            coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
          else
            coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.IPIPERC,0) / 100))),0)
          end
        else
          case NI.IPISOBREFRETE
            when 'S' then
            coalesce(((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) - ((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.PERC_REDUCAO,0) / 100))) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
          else
            coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) - ((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.PERC_REDUCAO,0) / 100))) * (coalesce(NI.IPIPERC,0) / 100)),0)
          end
        end)) * (coalesce(NI.DIFICMS,0) / 100))
      else
        (((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) - ((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.PERC_REDUCAO,0) / 100)))  * (coalesce(NI.DIFICMS,0) / 100))
      end
    end
  else
    case coalesce(NI.ICMSSOBREFRETE,'N')
      when 'S' then
      coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) - ((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.PERC_REDUCAO,0) / 100))) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.DIFICMS,0) / 100),0)
    else
      coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) - ((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.PERC_REDUCAO,0) / 100))) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.DIFICMS,0) / 100),0)
    end
  end ICMS_VALOR,
  coalesce(((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) +
  (case (select TIPOEMPRESA from SYSPARAMS)
    when 1 then
    case coalesce(NI.IPISOBREFRETE,'N')
      when 'S' then
      coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
    else
      coalesce((((coalesce(NI.QTD,0) * coalesce(NI.PRODVLR,0) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.IPIPERC,0) / 100))),0)
    end
  else
    case coalesce(NI.IPISOBREFRETE,'N')
      when 'S' then
      coalesce((((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) + coalesce(NI.FRETEVLRLTDA,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
    else
      coalesce((((coalesce(NI.PRODVLR,0) * coalesce(NI.QTD,0)) - coalesce(NI.DESCTO_ITEM,0)) * (coalesce(NI.IPIPERC,0) / 100)),0)
    end
  end) * (coalesce(NI.FRETEAVULSO,0) / 100)),0) FRETAVULSOCALC,
  coalesce((coalesce((((NI.QTD * NI.PRODVLR) + coalesce(NI.FRETEVLRLTDA,0)) + ((NI.PRODVLR * NI.QTD) * (coalesce(NI.FRETEPERCLTDA,0) / 100)) - coalesce(NI.DESCTO_ITEM,0)),0) * (coalesce(NI.PERC_VA,0) / 100)),0) VAL_VA,
  ((coalesce((coalesce((((NI.QTD * NI.PRODVLR) + coalesce(NI.FRETEVLRLTDA,0)) + ((NI.PRODVLR * NI.QTD) * (coalesce(NI.FRETEPERCLTDA,0) / 100)) - coalesce(NI.DESCTO_ITEM,0)),0) * (coalesce(NI.PERC_VA,0) / 100)),0))+(coalesce(((NI.QTD * NI.PRODVLR) + coalesce(NI.FRETEVLRLTDA,0) + ((NI.PRODVLR * NI.QTD) * (coalesce(NI.FRETEPERCLTDA,0) / 100)) - coalesce(NI.DESCTO_ITEM,0)),0))) VAL_BASESUBS,
  ((coalesce((coalesce((((NI.QTD * NI.PRODVLR) + coalesce(NI.FRETEVLRLTDA,0)) + ((NI.PRODVLR * NI.QTD) * (coalesce(NI.FRETEPERCLTDA,0) / 100)) - coalesce(NI.DESCTO_ITEM,0)),0) * (coalesce(NI.PERC_VA,0) / 100)),0))+(coalesce(((NI.QTD * NI.PRODVLR) + coalesce(NI.FRETEVLRLTDA,0) + ((NI.PRODVLR * NI.QTD) * (coalesce(NI.FRETEPERCLTDA,0) / 100)) - coalesce(NI.DESCTO_ITEM,0)),0))) * (NI.ALIQ_SUBS / 100) VAL_SUBS,
  PF.UNIDADE,
  PF.CODPESQ1,
  PF.CODPESQ2,
  NI.PISPERC,
  NI.PISVALOR,
  NI.COFINSPERC,
  NI.COFINSVALOR,
  NI.FRETESOBREIPI,
  NI.BASE_IPI,
  NI.STATUS,
  '',
  ''
from
  NFENTRADAITENS NI
  join NFENTRADA N on N.CODNFENTRADA = NI.CODNFENTRADA
  join PRODFILHO PF on PF.CODPRODFILHO = NI.CODPRODFILHO
;



/* View: VNFVENDAITEM */
CREATE OR ALTER VIEW VNFVENDAITEM(
    CODNFVENDAITEM,
    CODNFVENDA,
    CODPRODFILHO,
    QTDE,
    PRECOTAB,
    PRECOVEND,
    DESCVLR,
    IPIPERC,
    TOTALVLR,
    BAIXARESTOQ,
    DESCPERC,
    CODUNIDADE,
    US_CADAST,
    DT_CADAST,
    US_MODIFI,
    DT_MODIFI,
    CODPESQUISA,
    IPIVALOR,
    ICMSPERC,
    ICMSVALOR,
    CODPEDVENDITEM,
    CODPEDVEND,
    CUSTOMEDIO,
    CUSTOREPOSI,
    QTDEEMBALAGEM,
    PRECOUSADO,
    TRATESP,
    NFV_TIPO,
    CODCFOP,
    CFOP_CFOP,
    NATUREZA,
    SERIE,
    DESC_TOTAL,
    TOTAL,
    EMBCALC,
    VAL_IPI,
    VAL_ICMS,
    DESC_CALC,
    LKDESCRICAO2,
    QTDPRODEMB,
    AUX_DADOS1,
    AUX_DADOS2,
    AUX_DADOS3,
    AUX_DADOS4,
    AUX_DADOS5,
    AUX_DADOS6,
    AUX_DADOS7,
    DESC_PRODFILHO_AUX,
    DESCCSTB,
    DESCCSTA,
    DESC_LETRA,
    DESC_CLASSIFICAL,
    DESC_UNIDADE,
    CFOP_REDUZIDO,
    CFOP_NORMAL,
    CFOP_NATUREZA,
    CFOP_CFOPN)
AS
select
   NFVENDAITEM.CODNFVENDAITEM,
   NFVENDAITEM.CODNFVENDA,
   NFVENDAITEM.CODPRODFILHO,
   NFVENDAITEM.QTDE,
   NFVENDAITEM.PRECOTAB,
   NFVENDAITEM.PRECOVEND,
   NFVENDAITEM.DESCVLR,
   NFVENDAITEM.IPIPERC,
   NFVENDAITEM.TOTALVLR,
   NFVENDAITEM.BAIXARESTOQ,
   NFVENDAITEM.DESCPERC,
   NFVENDAITEM.CODUNIDADE,
   NFVENDAITEM.US_CADAST,
   NFVENDAITEM.DT_CADAST,
   NFVENDAITEM.US_MODIFI,
   NFVENDAITEM.DT_MODIFI,
   NFVENDAITEM.CODPESQUISA,
   NFVENDAITEM.IPIVALOR,
   NFVENDAITEM.ICMSPERC,
   NFVENDAITEM.ICMSVALOR,
   NFVENDAITEM.CODPEDVENDITEM,
   NFVENDAITEM.CODPEDVEND,
   NFVENDAITEM.CUSTOMEDIO,
   NFVENDAITEM.CUSTOREPOSI,
   NFVENDAITEM.QTDEEMBALAGEM,
   NFVENDAITEM.PRECOUSADO,
   NFVENDAITEM.TRATESP,
   NFVENDAITEM.NFV_TIPO,
   NFVENDAITEM.CODCFOP,
   NFVENDAITEM.CFOP_CFOP,
   NFVENDAITEM.NATUREZA,
   NFVENDAITEM.SERIE,
  (NFVENDAITEM.DESCVLR + ((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) * (NFVendaItem.DESCPERC / 100))) desc_total,
  ((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) - ((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) * (NFVendaItem.DESCPERC / 100))) total,
  (NFVendaItem.QTDE * coalesce(nullif(PRODFILHO.QTDEMBALAGEM,0),1)) embcalc,
  (((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) - ((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) * (NFVendaItem.DESCPERC / 100))) * (NFVendaItem.IPIPERC / 100)) val_ipi,
  (((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) - ((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) * (NFVendaItem.DESCPERC / 100))) * (NFVendaItem.ICMSPERC / 100)) val_icms,
  ((NFVendaItem.QTDE * NFVendaItem.PRECOVEND) * (NFVendaItem.DESCPERC / 100)) desc_calc,
  PRODFILHO.DADOS1 lkdescricao2,
  PRODFILHO.QTDEMBALAGEM qtdprodemb,
  PRODFILHO.DADOS1 aux_dados1,
  PRODFILHO.DADOS2 aux_dados2,
  PRODFILHO.DADOS3 aux_dados3,
  PRODFILHO.DADOS4 aux_dados4,
  PRODFILHO.DADOS5 aux_dados5,
  PRODFILHO.DADOS6 aux_dados6,
  PRODFILHO.DADOS7 aux_dados7,
  PRODFILHO.DESCRICAO desc_prodfilho_aux,
  PRODFILHO.PRDF_CST_TRIBICMS descCSTB,
  PRODFILHO.PRDF_CST_ORIGEM_MERCADORIA descCSTA,
  PRODFILHO.PRDF_LETRA desc_Letra,
  PRODFILHO.CLASSFISCAL desc_classifical,
  UNIDADE.SIGLA desc_unidade,
  CFOP.IRED cfop_reduzido,
  CFOP.ICMS cfop_normal,
  CFOP.NATUREZA cfop_natureza,
  CFOP.CFOP cfop_cfopn
from
  NFVENDAITEM
  join PRODFILHO on PRODFILHO.CODPRODFILHO = NFVENDAITEM.CODPRODFILHO
  join UNIDADE on UNIDADE.CODUNIDADE = PRODFILHO.CODUNIDADE
  left join CFOP on CFOP.CODCFOP = NFVENDAITEM.CODCFOP
;



/* View: VPESQ_SUBGRUPO */
CREATE OR ALTER VIEW VPESQ_SUBGRUPO(
    CODSUBGRUPOEV,
    GRUPO,
    SUBGRUPO,
    CODMODELO_CARDAPIO)
AS
select distinct
  SBA.CODSUBGRUPOEVAUX,
  GB.DESCRICAO,
  SB.DESCRICAO,
  MC.CODMODELO_CARDAPIO
from
  MODELO_CARDAPIO MC
  left join SUBGRUPO_EVENTOS_AUX SBA on SBA.CODMODELO_CARDAPIO=MC.CODMODELO_CARDAPIO
  left join SUBGRUPO_EVENTOS SB on SB.CODSUBGRUPOEV=SBA.CODSUBGRUPOEV
  left join GRUPO_EVENTOS GB on GB.CODGRUPOEV=SBA.CODGRUPOEV
;



/* View: VPESQUISAVENDA */
CREATE OR ALTER VIEW VPESQUISAVENDA(
    CODPEDVEND,
    CODNFVENDA,
    STATUSPED,
    TIPOPED,
    CODPESSOA,
    PESSOA,
    CODVENDEDOR,
    VENDEDOR,
    DT_SAIDA,
    VALOR_BRUTO,
    VALOR_TOTAL,
    NRFORMULARIO)
AS
select
  PEDVEND.CODPEDVEND,
  coalesce(CODFATURAMENTO, CODNFVENDA) CODNFVENDA,
  PEDVEND.STATUSPED,
  PEDVEND.TIPOPED,
  PEDVEND.CODPESSOA,
  PESSOA.NOME PESSOA,
  PEDVEND.CODVENDEDOR,
  VENDEDOR.NOME VENDEDOR,
  PEDVEND.DT_SAIDA,
  PEDVEND.VALOR_BRUTO,
  PEDVEND.VALOR_TOTAL,
  PEDVEND.NRFORMULARIO
from
  PEDVEND
  join PESSOA ON PEDVEND.CODPESSOA = PESSOA.CODPESSOA
  join VENDEDOR on PEDVEND.CODVENDEDOR = VENDEDOR.CODVENDEDOR
;



/* View: VPRODUTIVIDADE */
CREATE OR ALTER VIEW VPRODUTIVIDADE(
    CODPRODUTIVIDADE,
    DATA,
    CODOPERACAO,
    DESCRICAO,
    PECAS,
    TEMPO,
    PADRAO,
    CODFUNCIONARIO,
    NOME,
    COD_MAQUINA)
AS
SELECT
  TPO.CODPRODUTIVIDADE,
  TPO.DATA,
  TPO.CODOPERACAO,
  TBO.DESCRICAO,
  TPO.PECAS,
  TPO.TEMPO,
  TPO.PADRAO,
  TPO.CODFUNCIONARIO,
  F.NOME,
  TPO.COD_MAQUINA
FROM
  TBL_PRODUTIVIDADE_OPERACAO TPO
INNER JOIN TBL_OPERACAO TBO ON TBO.COD_OPERACAO=TPO.CODOPERACAO
INNER JOIN FUNCIONARIO F ON F.FUNC_COD=TPO.CODFUNCIONARIO
;



/* View: VTRANSFEREPRODFILHOLOTES */
CREATE OR ALTER VIEW VTRANSFEREPRODFILHOLOTES(
    CODPRODFILHO,
    CODPESQ1,
    DESCRICAO,
    LOCALIZACAO,
    ESTQATUAL,
    QTDPICKING,
    QTDMOV,
    ABASTECER)
AS
select
  P.CODPRODFILHO,
  P.CODPESQ1,
  P.DESCRICAO,
  P.LOCALIZACAO,
  P.ESTQATUAL,
  coalesce(P.QTDPICKING, 0),
  coalesce(sum(PL.QTDMOV), 0),
  coalesce(P.QTDPICKING, 0) - coalesce(sum(PL.QTDMOV), 0)
from
  PRODFILHO P
  left join PRODFILHOLOTES PL on
    P.CODPRODFILHO = PL.CODPRODFILHO and
    P.LOCALIZACAO  = PL.LOTE
where
  coalesce(P.ESTQATUAL, 0) > 0 and
  coalesce((select
             sum(PFL.QTDMOV)
           from
             PRODFILHO PF
             join PRODFILHOLOTES PFL on
               PF.CODPRODFILHO = PFL.CODPRODFILHO
           where
             PF.CODPRODFILHO = P.CODPRODFILHO and
             PF.LOCALIZACAO <> PFL.LOTE), 0) > 0
group by
  P.CODPRODFILHO,
  P.CODPESQ1,
  P.DESCRICAO,
  P.LOCALIZACAO,
  P.ESTQATUAL,
  P.QTDPICKING
having
  (coalesce(P.QTDPICKING, 0) - coalesce(sum(PL.QTDMOV), 0) <> 0)
;



/* View: VVENDEDOR */
CREATE OR ALTER VIEW VVENDEDOR(
    CODVENDEDOR,
    NOME)
AS
select
  CODVENDEDOR,
  NOME
from
  VENDEDOR
;



/* View: VW_MESES */
CREATE OR ALTER VIEW VW_MESES(
    MES,
    NOME)
AS
SELECT
  LISTA.MES,
  CASE LISTA.MES
    WHEN 1 THEN 'JAN'
    WHEN 2 THEN 'FEV'
    WHEN 3 THEN 'MAR'
    WHEN 4 THEN 'ABR'
    WHEN 5 THEN 'MAI'
    WHEN 6 THEN 'JUN'
    WHEN 7 THEN 'JUL'
    WHEN 8 THEN 'AGO'
    WHEN 9 THEN 'SET'
    WHEN 10 THEN 'OUT'
    WHEN 11 THEN 'NOV'
    WHEN 12 THEN 'DEZ'
  END NOME
FROM
(
    WITH RECURSIVE R AS (
    SELECT 1 MES FROM RDB$DATABASE
    UNION ALL
    SELECT
      R.MES + 1
    FROM R
    WHERE
      R.MES < 12
  )
  SELECT * FROM R
) LISTA
;



/* View: VW_SEGMENTOS */
CREATE OR ALTER VIEW VW_SEGMENTOS(
    CODSEGMENTO,
    SEGMENTO)
AS
WITH RECURSIVE R AS (
  SELECT
    SEGMENTOS.CODSEGMENTO,
    SEGMENTOS.SEGMENTO,
    SEGMENTOS.CODSEGMENTOPAI
  FROM
    SEGMENTOS
  WHERE
    SEGMENTOS.CODSEGMENTOPAI IS NULL
  UNION ALL
  SELECT
    SEGMENTOS.CODSEGMENTO,
    R.SEGMENTO || ' >> ' || SEGMENTOS.SEGMENTO,
    SEGMENTOS.CODSEGMENTOPAI
  FROM R
    JOIN SEGMENTOS ON
      SEGMENTOS.CODSEGMENTOPAI = R.CODSEGMENTO
)
SELECT
  CODSEGMENTO,
  SEGMENTO
FROM
  R
WHERE
  NOT EXISTS(SELECT * FROM SEGMENTOS SEG WHERE SEG.CODSEGMENTOPAI = R.CODSEGMENTO)
order by
  r.CODSEGMENTOPAI, SEGMENTO
;



/* View: VWFERIADOS */
CREATE OR ALTER VIEW VWFERIADOS(
    CODFERIADOS,
    DESCRICAO,
    INICIAL,
    FINAL)
AS
select
  CODFERIADOS,
  DESCRICAO,
  DIAINI||'/'||MESINI INICIAL,
  DIAFIM||'/'||MESFIM FINAL
from
  TBL_FERIADOS
;




/******************************************************************************/
/****                             Descriptions                             ****/
/******************************************************************************/

-- STRLEN

SET TERM ^ ;

ALTER TRIGGER CUPOMZITEM_BIU
as
declare variable TOT varchar(2);
declare variable ALIQ double precision;
declare variable TIPO varchar(1);
begin
  new.TRIBUTADO = null;
  if (CHAR_LENGTH(new.ALIQUOTA) <= 5) then
  begin
    new.SEQUENCIA  = null;
    new.PADRAO     = new.ALIQUOTA;
    new.ICMS       = 0;
    new.PERCENTUAL = 0;
  end
  else
  begin
    new.SEQUENCIA = substring(new.ALIQUOTA from 1 for 2);
    TIPO          = substring(new.ALIQUOTA from 3 for 1);

    if (TIPO = 'T') then
    begin
      new.PADRAO    = 'XxTnnnn';
      new.TRIBUTADO = '1';
      TOT = substring(new.ALIQUOTA from 4 for 1);

      if ((coalesce(new.ICMS, 0) <= 0) or (old.ALIQUOTA <> new.ALIQUOTA) or (old.VALOR <> new.VALOR)) then
      begin
        if (cast(TOT as integer) > 0) then
          ALIQ = substring(new.ALIQUOTA from 4 for 2);
        else
        begin
          ALIQ = substring(new.ALIQUOTA from 5 for 2);
          ALIQ = ALIQ / 10;
          new.TRIBUTADO = '2';
        end

        new.PERCENTUAL = ALIQ;
        new.ICMS       = (new.VALOR * ALIQ) / 100;
      end
    end else
    if (TIPO = 'S') then
    begin
      new.PADRAO     = 'XxSnnnn';
      new.PERCENTUAL = 0;
      new.ICMS       = 0;
      new.TRIBUTADO  = '5';
    end
  end

  if (new.PADRAO = 'Fn') then
    new.TRIBUTADO = '3';
  else
  if (new.PADRAO = 'In') then
    new.TRIBUTADO = '0';
  else
  if (new.PADRAO = 'Nn') then
    new.TRIBUTADO = '4';
  else
  if (new.PADRAO = 'FSn') then
    new.TRIBUTADO = '8';
  else
  if (new.PADRAO = 'ISn') then
    new.TRIBUTADO = '6';
  else
  if (new.PADRAO = 'NSn') then
    new.TRIBUTADO = '7';
end^

SET TERM ; ^

SET TERM ^ ;

ALTER TRIGGER PRODFILHO_BU
as
declare variable LNFE_CASAS integer;
declare variable LCUSTO double precision;
declare variable LCODEMPRESA integer;
declare variable LPRECOBASEATUALIZACAO integer;
declare variable LPERCENTUAL1 double precision;
declare variable LPERCENTUAL2 double precision;
declare variable LPERCENTUAL3 double precision;
declare variable LPERCENTUAL4 double precision;
declare variable LPERCENTUAL5 double precision;
declare variable LNCM varchar(8);
begin
  select
    DATANET,
    ATUALIZADATANET,
    CODEMPRESA,
    ATUALIZACODEMPRESANET
  from
    MATUALIZADATANET(new.DATANET, new.ATUALIZADATANET, new.CODEMPRESANET, new.ATUALIZACODEMPRESANET)
  into
    new.DATANET,
    new.ATUALIZADATANET,
    new.CODEMPRESANET,
    new.ATUALIZACODEMPRESANET;

    select
      M.CODEMPRESA
    from
      MRETORNACODEMPRESA(null, 'S') M
    into
      LCODEMPRESA;
  
  if (((new.CODEMPRESA is null) or (new.CODEMPRESA = LCODEMPRESA))) then
  begin
    select
      VALOR
    from
      MLERPARAMETROINTEIRO('CASAS DECIMAS PARA EXIBIÇÃO DO PREÇO',2)
    into
      LNFE_CASAS;

    if (LNFE_CASAS = 0) then
    begin
       LNFE_CASAS = 2;
    end
  
    select
      M.VALOR
    from
      MLERPARAMETROINTEIRO('PREÇO BASE PARA ATUALIZAÇÃO DE PREÇOS', 0) M
    into
      LPRECOBASEATUALIZACAO;
  
    if (LPRECOBASEATUALIZACAO > 0) then
    begin
      select
        M.VALOR
      from
        MLERPARAMETRONUMERO('PERCENTUAL 1', 0) M
      into
        LPERCENTUAL1;
  
      select
        M.VALOR
      from
        MLERPARAMETRONUMERO('PERCENTUAL 2', 0) M
      into
        LPERCENTUAL2;
  
      select
        M.VALOR
      from
        MLERPARAMETRONUMERO('PERCENTUAL 3', 0) M
      into
        LPERCENTUAL3;
  
      select
        M.VALOR
      from
        MLERPARAMETRONUMERO('PERCENTUAL 4', 0) M
      into
        LPERCENTUAL4;
  
      select
        M.VALOR
      from
        MLERPARAMETRONUMERO('PERCENTUAL 5', 0) M
      into
        LPERCENTUAL5;
  
      if (LPRECOBASEATUALIZACAO = 1) then
      begin
        new.PRECOPRATICADO2 = new.PRECOPRATICADO1 * ((LPERCENTUAL1 / 100) + 1);
        new.PRECOPRATICADO3 = new.PRECOPRATICADO1 * ((LPERCENTUAL2 / 100) + 1);
        new.PRECOPRATICADO4 = new.PRECOPRATICADO1 * ((LPERCENTUAL3 / 100) + 1);
        new.PRECOPRATICADO5 = new.PRECOPRATICADO1 * ((LPERCENTUAL4 / 100) + 1);
        new.PRECOPRATICADO6 = new.PRECOPRATICADO1 * ((LPERCENTUAL5 / 100) + 1);
      end
      else if (LPRECOBASEATUALIZACAO = 2) then
      begin
        new.PRECOPRATICADO1 = new.PRECOPRATICADO2 * ((LPERCENTUAL1 / 100) + 1);
        new.PRECOPRATICADO3 = new.PRECOPRATICADO2 * ((LPERCENTUAL2 / 100) + 1);
        new.PRECOPRATICADO4 = new.PRECOPRATICADO2 * ((LPERCENTUAL3 / 100) + 1);
        new.PRECOPRATICADO5 = new.PRECOPRATICADO2 * ((LPERCENTUAL4 / 100) + 1);
        new.PRECOPRATICADO6 = new.PRECOPRATICADO2 * ((LPERCENTUAL5 / 100) + 1);
      end
      else if (LPRECOBASEATUALIZACAO = 3) then
      begin
        new.PRECOPRATICADO1 = new.PRECOPRATICADO3 * ((LPERCENTUAL1 / 100) + 1);
        new.PRECOPRATICADO2 = new.PRECOPRATICADO3 * ((LPERCENTUAL2 / 100) + 1);
        new.PRECOPRATICADO4 = new.PRECOPRATICADO3 * ((LPERCENTUAL3 / 100) + 1);
        new.PRECOPRATICADO5 = new.PRECOPRATICADO3 * ((LPERCENTUAL4 / 100) + 1);
        new.PRECOPRATICADO6 = new.PRECOPRATICADO3 * ((LPERCENTUAL5 / 100) + 1);
      end
      else if (LPRECOBASEATUALIZACAO = 4) then
      begin
        new.PRECOPRATICADO1 = new.PRECOPRATICADO4 * ((LPERCENTUAL1 / 100) + 1);
        new.PRECOPRATICADO2 = new.PRECOPRATICADO4 * ((LPERCENTUAL2 / 100) + 1);
        new.PRECOPRATICADO3 = new.PRECOPRATICADO4 * ((LPERCENTUAL3 / 100) + 1);
        new.PRECOPRATICADO5 = new.PRECOPRATICADO4 * ((LPERCENTUAL4 / 100) + 1);
        new.PRECOPRATICADO6 = new.PRECOPRATICADO4 * ((LPERCENTUAL5 / 100) + 1);
      end
      else if (LPRECOBASEATUALIZACAO = 5) then
      begin
        new.PRECOPRATICADO1 = new.PRECOPRATICADO5 * ((LPERCENTUAL1 / 100) + 1);
        new.PRECOPRATICADO2 = new.PRECOPRATICADO5 * ((LPERCENTUAL2 / 100) + 1);
        new.PRECOPRATICADO3 = new.PRECOPRATICADO5 * ((LPERCENTUAL3 / 100) + 1);
        new.PRECOPRATICADO4 = new.PRECOPRATICADO5 * ((LPERCENTUAL4 / 100) + 1);
        new.PRECOPRATICADO6 = new.PRECOPRATICADO5 * ((LPERCENTUAL5 / 100) + 1);
      end
      else if (LPRECOBASEATUALIZACAO = 6) then
      begin
        new.PRECOPRATICADO1 = new.PRECOPRATICADO6 * ((LPERCENTUAL1 / 100) + 1);
        new.PRECOPRATICADO2 = new.PRECOPRATICADO6 * ((LPERCENTUAL2 / 100) + 1);
        new.PRECOPRATICADO3 = new.PRECOPRATICADO6 * ((LPERCENTUAL3 / 100) + 1);
        new.PRECOPRATICADO4 = new.PRECOPRATICADO6 * ((LPERCENTUAL4 / 100) + 1);
        new.PRECOPRATICADO5 = new.PRECOPRATICADO6 * ((LPERCENTUAL5 / 100) + 1);
      end
    end

    if (old.PRECOPRATICADO1 <> new.PRECOPRATICADO1) then
    begin
      if (LNFE_CASAS = 0) then
        new.PRECOPRATICADO1 = cast(new.PRECOPRATICADO1 as numeric(18, 0));
      else if (LNFE_CASAS = 2) then
        new.PRECOPRATICADO1 = cast(new.PRECOPRATICADO1 as numeric(18, 2));
      else if (LNFE_CASAS = 3) then
        new.PRECOPRATICADO1 = cast(new.PRECOPRATICADO1 as numeric(18, 3));
      else if (LNFE_CASAS = 4) then
        new.PRECOPRATICADO1 = cast(new.PRECOPRATICADO1 as numeric(18, 4));
      else if (LNFE_CASAS = 5) then
        new.PRECOPRATICADO1 = cast(new.PRECOPRATICADO1 as numeric(18, 5));
      else if (LNFE_CASAS = 6) then
        new.PRECOPRATICADO1 = cast(new.PRECOPRATICADO1 as numeric(18, 6));
    end
  
    if (old.PRECOPRATICADO2 <> new.PRECOPRATICADO2) then
    begin
      if (LNFE_CASAS = 0) then
        new.PRECOPRATICADO2 = cast(new.PRECOPRATICADO2 as numeric(18, 0));
      else if (LNFE_CASAS = 2) then
        new.PRECOPRATICADO2 = cast(new.PRECOPRATICADO2 as numeric(18, 2));
      else if (LNFE_CASAS = 3) then
        new.PRECOPRATICADO2 = cast(new.PRECOPRATICADO2 as numeric(18, 3));
      else if (LNFE_CASAS = 4) then
        new.PRECOPRATICADO2 = cast(new.PRECOPRATICADO2 as numeric(18, 4));
      else if (LNFE_CASAS = 5) then
        new.PRECOPRATICADO2 = cast(new.PRECOPRATICADO2 as numeric(18, 5));
      else if (LNFE_CASAS = 6) then
        new.PRECOPRATICADO2 = cast(new.PRECOPRATICADO2 as numeric(18, 6));
    end
  
    if (old.PRECOPRATICADO3 <> new.PRECOPRATICADO3) then
    begin
      if (LNFE_CASAS = 0) then
        new.PRECOPRATICADO3 = cast(new.PRECOPRATICADO3 as numeric(18, 0));
      else if (LNFE_CASAS = 2) then
        new.PRECOPRATICADO3 = cast(new.PRECOPRATICADO3 as numeric(18, 2));
      else if (LNFE_CASAS = 3) then
        new.PRECOPRATICADO3 = cast(new.PRECOPRATICADO3 as numeric(18, 3));
      else if (LNFE_CASAS = 4) then
        new.PRECOPRATICADO3 = cast(new.PRECOPRATICADO3 as numeric(18, 4));
      else if (LNFE_CASAS = 5) then
        new.PRECOPRATICADO3 = cast(new.PRECOPRATICADO3 as numeric(18, 5));
      else if (LNFE_CASAS = 6) then
        new.PRECOPRATICADO3 = cast(new.PRECOPRATICADO3 as numeric(18, 6));
    end
  
    if (old.PRECOPRATICADO4 <> new.PRECOPRATICADO4) then
    begin
      if (LNFE_CASAS = 0) then
        new.PRECOPRATICADO4 = cast(new.PRECOPRATICADO4 as numeric(18, 0));
      else if (LNFE_CASAS = 2) then
        new.PRECOPRATICADO4 = cast(new.PRECOPRATICADO4 as numeric(18, 2));
      else if (LNFE_CASAS = 3) then
        new.PRECOPRATICADO4 = cast(new.PRECOPRATICADO4 as numeric(18, 3));
      else if (LNFE_CASAS = 4) then
        new.PRECOPRATICADO4 = cast(new.PRECOPRATICADO4 as numeric(18, 4));
      else if (LNFE_CASAS = 5) then
        new.PRECOPRATICADO4 = cast(new.PRECOPRATICADO4 as numeric(18, 5));
      else if (LNFE_CASAS = 6) then
        new.PRECOPRATICADO4 = cast(new.PRECOPRATICADO4 as numeric(18, 6));
    end
  
    if (old.PRECOPRATICADO5 <> new.PRECOPRATICADO5) then
    begin
      if (LNFE_CASAS = 0) then
        new.PRECOPRATICADO5 = cast(new.PRECOPRATICADO5 as numeric(18, 0));
      else if (LNFE_CASAS = 2) then
        new.PRECOPRATICADO5 = cast(new.PRECOPRATICADO5 as numeric(18, 2));
      else if (LNFE_CASAS = 3) then
        new.PRECOPRATICADO5 = cast(new.PRECOPRATICADO5 as numeric(18, 3));
      else if (LNFE_CASAS = 4) then
        new.PRECOPRATICADO5 = cast(new.PRECOPRATICADO5 as numeric(18, 4));
      else if (LNFE_CASAS = 5) then
        new.PRECOPRATICADO5 = cast(new.PRECOPRATICADO5 as numeric(18, 5));
      else if (LNFE_CASAS = 6) then
        new.PRECOPRATICADO5 = cast(new.PRECOPRATICADO5 as numeric(18, 6));
    end
  
    if (old.PRECOPRATICADO6 <> new.PRECOPRATICADO6) then
    begin
      if (LNFE_CASAS = 0) then
        new.PRECOPRATICADO6 = cast(new.PRECOPRATICADO6 as numeric(18, 0));
      else if (LNFE_CASAS = 2) then
        new.PRECOPRATICADO6 = cast(new.PRECOPRATICADO6 as numeric(18, 2));
      else if (LNFE_CASAS = 3) then
        new.PRECOPRATICADO6 = cast(new.PRECOPRATICADO6 as numeric(18, 3));
      else if (LNFE_CASAS = 4) then
        new.PRECOPRATICADO6 = cast(new.PRECOPRATICADO6 as numeric(18, 4));
      else if (LNFE_CASAS = 5) then
        new.PRECOPRATICADO6 = cast(new.PRECOPRATICADO6 as numeric(18, 5));
      else if (LNFE_CASAS = 6) then
        new.PRECOPRATICADO6 = cast(new.PRECOPRATICADO6 as numeric(18, 6));
    end
  
    select
      C.CUSTO
    from
      MCALCULACUSTO(new.CODPRODFILHO) C
    into
      LCUSTO;
  
    -- ATUALIZANDO O PREÇO SUGERIDO
    if ((coalesce(new.PRECOSUGERIDO1, 0) <= 0) and (coalesce(new.MARKUP1, 0) > 0)) then
    begin
      new.PRECOSUGERIDO1 = LCUSTO / ((100 - coalesce(nullif(new.MARKUP1, 100), 0)) / 100);
      new.PRECOSUGERIDO1 = new.PRECOSUGERIDO1 / ((100 - (coalesce(new.PERC_PIS, 0) + coalesce(new.PERC_COFINS, 0) + coalesce(new.PERC_CSLL, 0) + coalesce(new.PERCMVOUTROS, 0))) / 100);
    end
  
    if ((coalesce(new.PRECOSUGERIDO2, 0) <= 0) and (coalesce(new.MARKUP2, 0) > 0)) then
    begin
      new.PRECOSUGERIDO2 = LCUSTO / ((100 - coalesce(nullif(new.MARKUP2, 100), 0)) / 100);
      new.PRECOSUGERIDO2 = new.PRECOSUGERIDO2 / ((100 - (coalesce(new.PERC_PIS, 0) + coalesce(new.PERC_COFINS, 0) + coalesce(new.PERC_CSLL, 0) + coalesce(new.PERCMVOUTROS, 0))) / 100);
    end
  
    if ((coalesce(new.PRECOSUGERIDO3, 0) <= 0) and (coalesce(new.MARKUP3, 0) > 0)) then
    begin
      new.PRECOSUGERIDO3 = LCUSTO / ((100 - coalesce(nullif(new.MARKUP3, 100), 0)) / 100);
      new.PRECOSUGERIDO3 = new.PRECOSUGERIDO3 / ((100 - (coalesce(new.PERC_PIS, 0) + coalesce(new.PERC_COFINS, 0) + coalesce(new.PERC_CSLL, 0) + coalesce(new.PERCMVOUTROS, 0))) / 100);
    end

    if ((coalesce(new.PRECOSUGERIDO4, 0) <= 0) and (coalesce(new.MARKUP4, 0) > 0)) then
    begin
      new.PRECOSUGERIDO4 = LCUSTO / ((100 - coalesce(nullif(new.MARKUP4, 100), 0)) / 100);
      new.PRECOSUGERIDO4 = new.PRECOSUGERIDO4 / ((100 - (coalesce(new.PERC_PIS, 0) + coalesce(new.PERC_COFINS, 0) + coalesce(new.PERC_CSLL, 0) + coalesce(new.PERCMVOUTROS, 0))) / 100);
    end

    if ((coalesce(new.PRECOSUGERIDO5, 0) <= 0) and (coalesce(new.MARKUP5, 0) > 0)) then
    begin
      new.PRECOSUGERIDO5 = LCUSTO / ((100 - coalesce(nullif(new.MARKUP5, 100), 0)) / 100);
      new.PRECOSUGERIDO5 = new.PRECOSUGERIDO5 / ((100 - (coalesce(new.PERC_PIS, 0) + coalesce(new.PERC_COFINS, 0) + coalesce(new.PERC_CSLL, 0) + coalesce(new.PERCMVOUTROS, 0))) / 100);
    end

    if ((coalesce(new.PRECOSUGERIDO6, 0) <= 0) and (coalesce(new.MARKUP6, 0) > 0)) then
    begin
      new.PRECOSUGERIDO6 = LCUSTO / ((100 - coalesce(nullif(new.MARKUP6, 100), 0)) / 100);
      new.PRECOSUGERIDO6 = new.PRECOSUGERIDO6 / ((100 - (coalesce(new.PERC_PIS, 0) + coalesce(new.PERC_COFINS, 0) + coalesce(new.PERC_CSLL, 0) + coalesce(new.PERCMVOUTROS, 0))) / 100);
    end

    if (LNFE_CASAS = 0) then
    begin
      new.PRECOSUGERIDO1 = cast(new.PRECOSUGERIDO1 as numeric(18, 0));
      new.PRECOSUGERIDO2 = cast(new.PRECOSUGERIDO2 as numeric(18, 0));
      new.PRECOSUGERIDO3 = cast(new.PRECOSUGERIDO3 as numeric(18, 0));
      new.PRECOSUGERIDO4 = cast(new.PRECOSUGERIDO4 as numeric(18, 0));
      new.PRECOSUGERIDO5 = cast(new.PRECOSUGERIDO5 as numeric(18, 0));
      new.PRECOSUGERIDO6 = cast(new.PRECOSUGERIDO6 as numeric(18, 0));
    end 
    else if (LNFE_CASAS = 2) then
    begin
      new.PRECOSUGERIDO1 = cast(new.PRECOSUGERIDO1 as numeric(18, 2));
      new.PRECOSUGERIDO2 = cast(new.PRECOSUGERIDO2 as numeric(18, 2));
      new.PRECOSUGERIDO3 = cast(new.PRECOSUGERIDO3 as numeric(18, 2));
      new.PRECOSUGERIDO4 = cast(new.PRECOSUGERIDO4 as numeric(18, 2));
      new.PRECOSUGERIDO5 = cast(new.PRECOSUGERIDO5 as numeric(18, 2));
      new.PRECOSUGERIDO6 = cast(new.PRECOSUGERIDO6 as numeric(18, 2));
    end 
    else if (LNFE_CASAS = 3) then
    begin
      new.PRECOSUGERIDO1 = cast(new.PRECOSUGERIDO1 as numeric(18, 3));
      new.PRECOSUGERIDO2 = cast(new.PRECOSUGERIDO2 as numeric(18, 3));
      new.PRECOSUGERIDO3 = cast(new.PRECOSUGERIDO3 as numeric(18, 3));
      new.PRECOSUGERIDO4 = cast(new.PRECOSUGERIDO4 as numeric(18, 3));
      new.PRECOSUGERIDO5 = cast(new.PRECOSUGERIDO5 as numeric(18, 3));
      new.PRECOSUGERIDO6 = cast(new.PRECOSUGERIDO6 as numeric(18, 3));
    end 
    else if (LNFE_CASAS = 4) then
    begin
      new.PRECOSUGERIDO1 = cast(new.PRECOSUGERIDO1 as numeric(18, 4));
      new.PRECOSUGERIDO2 = cast(new.PRECOSUGERIDO2 as numeric(18, 4));
      new.PRECOSUGERIDO3 = cast(new.PRECOSUGERIDO3 as numeric(18, 4));
      new.PRECOSUGERIDO4 = cast(new.PRECOSUGERIDO4 as numeric(18, 4));
      new.PRECOSUGERIDO5 = cast(new.PRECOSUGERIDO5 as numeric(18, 4));
      new.PRECOSUGERIDO6 = cast(new.PRECOSUGERIDO6 as numeric(18, 4));
    end 
    else if (LNFE_CASAS = 5) then
    begin
      new.PRECOSUGERIDO1 = cast(new.PRECOSUGERIDO1 as numeric(18, 5));
      new.PRECOSUGERIDO2 = cast(new.PRECOSUGERIDO2 as numeric(18, 5));
      new.PRECOSUGERIDO3 = cast(new.PRECOSUGERIDO3 as numeric(18, 5));
      new.PRECOSUGERIDO4 = cast(new.PRECOSUGERIDO4 as numeric(18, 5));
      new.PRECOSUGERIDO5 = cast(new.PRECOSUGERIDO5 as numeric(18, 5));
      new.PRECOSUGERIDO6 = cast(new.PRECOSUGERIDO6 as numeric(18, 5));
    end 
    else if (LNFE_CASAS = 6) then
    begin
      new.PRECOSUGERIDO1 = cast(new.PRECOSUGERIDO1 as numeric(18, 6));
      new.PRECOSUGERIDO2 = cast(new.PRECOSUGERIDO2 as numeric(18, 6));
      new.PRECOSUGERIDO3 = cast(new.PRECOSUGERIDO3 as numeric(18, 6));
      new.PRECOSUGERIDO4 = cast(new.PRECOSUGERIDO4 as numeric(18, 6));
      new.PRECOSUGERIDO5 = cast(new.PRECOSUGERIDO5 as numeric(18, 6));
      new.PRECOSUGERIDO6 = cast(new.PRECOSUGERIDO6 as numeric(18, 6));
    end 
  
    if (not exists(select CODNV from PRODCOMBINADOS where PRODCOMBINADOS.CODNV = new.CODPRODFILHO)) then
      new.PRODCOMBINADO = 1;
    else
      new.PRODCOMBINADO = 2;
  end

  if (coalesce(new.CODNCM, 0) <> 0) then
  begin
    select
      NCM.NCM_CODIGO
    from
      NCM
    where
      NCM.CODNCM = new.CODNCM
    into
      LNCM;

    if (CHAR_LENGTH(LNCM) = 8) then
      new.CLASSFISCAL = :LNCM;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER TRIGGER TRG_APCUPOMZITEM_BIU
as
declare variable ALIQ double precision;
declare variable TIPO varchar(1);
declare variable VIRG integer;
begin
  new.TRIBUTADO = null;
  if (CHAR_LENGTH(new.ALIQUOTA) <= 5) then
  begin
    new.SEQUENCIA  = null;
    new.PADRAO     = new.ALIQUOTA;
    new.ICMS       = 0;
    new.PERCENTUAL = 0;
  end
  else
  begin
    new.SEQUENCIA = substring(new.ALIQUOTA from 1 for 2);
    TIPO          = substring(new.ALIQUOTA from 3 for 1);
    VIRG          = 0;

    if (TIPO = 'T') then
    begin
      new.PADRAO    = 'XxTnnnn';
      if ((coalesce(new.ICMS, 0) <= 0) or (old.ALIQUOTA <> new.ALIQUOTA) or (old.VALOR <> new.VALOR)) then
      begin
        VIRG = substring(new.ALIQUOTA from 6 for 1);
        ALIQ = substring(new.ALIQUOTA from 4 for 4);
        ALIQ = ALIQ / 100;
        new.PERCENTUAL = ALIQ;
        new.ICMS       = (new.VALOR * ALIQ) / 100;

        if (VIRG = 0) then
          new.TRIBUTADO = '1';
        else
          new.TRIBUTADO = '2';
      end
    end else
    if (TIPO = 'S') then
    begin
      new.PADRAO     = 'XxSnnnn';
      new.PERCENTUAL = 0;
      new.ICMS       = 0;
      new.TRIBUTADO  = '5';
    end
  end

  if (new.PADRAO = 'Fn') then
    new.TRIBUTADO = '3';
  else
  if (new.PADRAO = 'In') then
    new.TRIBUTADO = '0';
  else
  if (new.PADRAO = 'Nn') then
    new.TRIBUTADO = '4';
  else
  if (new.PADRAO = 'FSn') then
    new.TRIBUTADO = '8';
  else
  if (new.PADRAO = 'ISn') then
    new.TRIBUTADO = '6';
  else
  if (new.PADRAO = 'NSn') then
    new.TRIBUTADO = '7';
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE AGILIS_IMPORTAVENDA(
    ECODPEDVEND INTEGER,
    ECODEMPRESA INTEGER = 0)
RETURNS (
    CODPEDVEND INTEGER,
    EMISSAO DATE,
    CODPESSOA INTEGER,
    NOMEPESSOA VARCHAR(60),
    CPFCGCPESSOA VARCHAR(18),
    BAIRRO_1 VARCHAR(45),
    CEP_1 VARCHAR(9),
    CIDADE_1 VARCHAR(45),
    CODIBGE INTEGER,
    COMPLEMENTO_1 VARCHAR(60),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    UF_1 CHAR(2),
    CODVENDEDOR INTEGER,
    NOMEVENDEDOR VARCHAR(60),
    NUMNFCE INTEGER,
    SERIENFCE VARCHAR(10),
    VALOR_TOTAL DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESC_VALOR NUMERIC(15,2),
    ACRESCIMO DOUBLE PRECISION,
    ACRES_VALOR NUMERIC(15,2),
    VALOR_PAGO DOUBLE PRECISION,
    NRITENS INTEGER,
    CODPEDVENDITEM INTEGER,
    CODPRODFILHO INTEGER,
    CODPESQUISA VARCHAR(30),
    PRECOPROD DOUBLE PRECISION,
    QTDE DOUBLE PRECISION,
    PRECOVEND NUMERIC(15,2),
    CONTITEM INTEGER,
    DESCR_PRODUTO VARCHAR(60),
    ALIQUOTAICMS DOUBLE PRECISION,
    UNIDADEMED VARCHAR(5),
    TRIBUTADO VARCHAR(1),
    NCM_CODIGO VARCHAR(8),
    CODIGOCEST VARCHAR(7),
    PRECOUSADO VARCHAR(10),
    PRDF_CST_ORIGEM_MERCADORIA SMALLINT,
    PRDF_CST_TRIBICMS CHAR(3),
    PERC_COFINS DOUBLE PRECISION,
    PERC_PIS DOUBLE PRECISION,
    CSTPIS CHAR(2),
    CFOP VARCHAR(4),
    CODCLASSIFICACAOSERVICO VARCHAR(5),
    ALIQUOTAISS DOUBLE PRECISION,
    PRECOPRODTABELA DOUBLE PRECISION,
    CODDAV INTEGER)
AS
declare variable LAJUSTE numeric(15,2);
declare variable LCODPESSOAVENDA integer;
declare variable LCEP varchar(9);
declare variable LCODIBGE integer;
declare variable LCODEMPRESA integer;
begin
  CODDAV = 0;
  if (ECODEMPRESA = 0) then
  begin
    select
      first 1
      E.CODEMPRESA
    from
      EMPRESA E
      join SYSPARAMS S on
        E.CGC = S.CGC
    into
      LCODEMPRESA;
  end
  else
    LCODEMPRESA = ECODEMPRESA;

  ALIQUOTAISS             = 0;
  CODCLASSIFICACAOSERVICO = null;
  CODPEDVEND              = ECODPEDVEND;
  select
    M.VALOR
  from
    MLERPARAMETROINTEIRO('CLIENTE PADRÃO DO PDV', 0) M
  into
    LCODPESSOAVENDA;

  select
    (select
      FU_GETTIRAMASCARA.STRRESULT
    from
      FU_GETTIRAMASCARA(S.CEP)),
    coalesce(nullif(S.CODIBGE, '0'), '0000000')
  from
    SYSPARAMS S
  into
    LCEP,
    LCODIBGE;

  select
    P.CODPESSOA,
    S.NOME,
    S.CPFCGC,
    S.CEP_1,
    S.LOGRADOURO_1,
    S.BAIRRO_1,
    S.CIDADE_1,
    S.UF_1,
    S.CODIBGE,
    S.NUMERO_1,
    S.COMPLEMENTO_1,
    V.CODVENDEDOR,
    V.NOME,
    cast(coalesce(nullif(P.COO,''), null) as integer),
    P.ECF,
    cast((coalesce(P.VALOR_ACRESCIMO, 0) + coalesce(P.ACRESVALOR, 0)) - (coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0)) as numeric(15,2)),
    cast(P.DT_SAIDA as date),
    P.VALOR_BRUTO,
    P.VALOR_TOTAL,
    P.NRITENS
  from
    PEDVEND P
    join PESSOA S on
      P.CODPESSOA = S.CODPESSOA
    join VENDEDOR V on
      P.CODVENDEDOR = V.CODVENDEDOR
  where
    P.CODPEDVEND = :ECODPEDVEND
    and P.CODEMPRESA = :LCODEMPRESA
    and p.statusped = 'NORMAL'
  into
    CODPESSOA,
    NOMEPESSOA,
    CPFCGCPESSOA,
    CEP_1,
    LOGRADOURO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CODIBGE,
    NUMERO_1,
    COMPLEMENTO_1,
    CODVENDEDOR,
    NOMEVENDEDOR,
    NUMNFCE,
    SERIENFCE,
    LAJUSTE,
    EMISSAO,
    VALOR_TOTAL,
    VALOR_PAGO,
    NRITENS;

  if (CODPESSOA = LCODPESSOAVENDA) then
  begin
    CODPESSOA    = null;
    NOMEPESSOA   = null;
    CPFCGCPESSOA = null;
  end
  else
  begin
    select
      F.STRRESULT
    from
      FU_GETTIRAMASCARA(:CPFCGCPESSOA) F
    into
      CPFCGCPESSOA;
  end

  select
    FU_GETTIRAMASCARA.STRRESULT
  from
    FU_GETTIRAMASCARA(:CEP_1)
  into
    CEP_1;

  CEP_1 = coalesce(nullif(CEP_1, ''), LCEP);

  if (CHAR_LENGTH(CODIBGE) <> 7) then
    CODIBGE = LCODIBGE;

  ACRES_VALOR = 0;
  DESC_VALOR  = 0;

  if (LAJUSTE > 0) then
    ACRES_VALOR = LAJUSTE;
  else if (LAJUSTE < 0) then
    DESC_VALOR = LAJUSTE * -1;

  DESCONTO  = (DESC_VALOR * 100) / VALOR_TOTAL;
  ACRESCIMO = (ACRES_VALOR * 100) / VALOR_TOTAL;

  for select
    I.CODDAVITEM,
    I.CODPRODFILHO,
    I.CODPESQUISA,
    I.QTDE,
    I.PRECOVEND,
    F.DESCRICAO,
    F.ALIQUOTAICMS,
    U.SIGLA,
    F.TRIBUTADO,
    F.CLASSFISCAL,
    I.PRECOUSADO,
    F.PRDF_CST_ORIGEM_MERCADORIA,
    F.PRDF_CST_TRIBICMS,
    F.PERC_COFINS,
    F.PERC_PIS,
    F.CSTPIS,
    F.CODCEST,
    I.PRECOPRODTABELA
  from
    PEDVEND P
    join PEDVENDITEM I on
      P.CODPEDVEND = I.CODPEDVEND
    join PRODFILHO F on
      I.CODPRODFILHO = F.CODPRODFILHO
    join UNIDADE U on
      F.CODUNIDADE = U.CODUNIDADE
  where
    P.CODPEDVEND = :ECODPEDVEND
    and coalesce(P.COO,'') = ''
    and coalesce(P.NUMNFCE,'') = ''
    and p.statusped = 'NORMAL'
  into
    CODPEDVENDITEM,
    CODPRODFILHO,
    CODPESQUISA,
    QTDE,
    PRECOVEND,
    DESCR_PRODUTO,
    ALIQUOTAICMS,
    UNIDADEMED,
    TRIBUTADO,
    NCM_CODIGO,
    PRECOUSADO,
    PRDF_CST_ORIGEM_MERCADORIA,
    PRDF_CST_TRIBICMS,
    PERC_COFINS,
    PERC_PIS,
    CSTPIS,
    CODIGOCEST,
    PRECOPRODTABELA
  do
  begin
--  0 / I - ISENTO
--  4 / N - NAO TRIBUTADO
--  3 / F - SUBSTITUICAO TRIBUTARIA
--  1 / T - TRIBUTADO PELO ICMS

    CFOP = '5102';
    if (TRIBUTADO = '3') then
      CFOP = '5405';

    PRECOPROD = PRECOVEND / QTDE;
    CONTITEM = coalesce(CONTITEM, 0) + 1;
    suspend;
  end 
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE AGILIS_IMPORTAVENDA_NFCE(
    ECODPEDVEND INTEGER,
    ECODEMPRESA INTEGER = 0)
RETURNS (
    CODPEDVEND INTEGER,
    EMISSAO DATE,
    CODPESSOA INTEGER,
    NOMEPESSOA VARCHAR(60),
    CPFCGCPESSOA VARCHAR(18),
    BAIRRO_1 VARCHAR(45),
    CEP_1 VARCHAR(9),
    CIDADE_1 VARCHAR(45),
    CODIBGE INTEGER,
    COMPLEMENTO_1 VARCHAR(60),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    UF_1 CHAR(2),
    CODVENDEDOR INTEGER,
    NOMEVENDEDOR VARCHAR(60),
    NUMNFCE INTEGER,
    SERIENFCE VARCHAR(10),
    VALOR_BRUTO DOUBLE PRECISION,
    LVALOR_BRUTO DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESC_VALOR NUMERIC(15,2),
    ACRESCIMO DOUBLE PRECISION,
    ACRES_VALOR NUMERIC(15,2),
    VALOR_PAGO DOUBLE PRECISION,
    NRITENS INTEGER,
    CODPEDVENDITEM INTEGER,
    CODPRODFILHO INTEGER,
    CODPESQUISA VARCHAR(30),
    PRECOPROD DOUBLE PRECISION,
    QTDE DOUBLE PRECISION,
    DESC_VALORITEM DOUBLE PRECISION,
    PRECOVEND NUMERIC(15,2),
    CONTITEM INTEGER,
    DESCR_PRODUTO VARCHAR(60),
    ALIQUOTAICMS DOUBLE PRECISION,
    UNIDADEMED VARCHAR(5),
    TRIBUTADO VARCHAR(1),
    NCM_CODIGO VARCHAR(8),
    CODIGOCEST VARCHAR(7),
    PRECOUSADO VARCHAR(10),
    PRDF_CST_ORIGEM_MERCADORIA SMALLINT,
    PRDF_CST_TRIBICMS CHAR(3),
    PERC_COFINS DOUBLE PRECISION,
    PERC_PIS DOUBLE PRECISION,
    CSTPIS CHAR(2),
    CFOP VARCHAR(4),
    CODCLASSIFICACAOSERVICO VARCHAR(5),
    ALIQUOTAISS DOUBLE PRECISION,
    PRECOPRODTABELA DOUBLE PRECISION,
    CODDAV INTEGER,
    PERC_REDUCAO_ICMS DOUBLE PRECISION,
    OBSERVACOES BLOB SUB_TYPE TEXT SEGMENT SIZE 80,
    CODANP VARCHAR(30),
    DESCANP VARCHAR(95),
    LOTE VARCHAR(200),
    DATAVAL VARCHAR(10),
    DATAFAB VARCHAR(10),
    QTDLOTE DOUBLE PRECISION)
AS
declare variable LCODPESSOAVENDA integer;
declare variable LCEP varchar(9);
declare variable LCODIBGE integer;
declare variable LCODEMPRESA integer;
declare variable LCODCEST integer;
declare variable LVALORDESCONTO double precision;
declare variable LFATOR double precision;
declare variable PAR_APENAS_NAO_ESPECIAIS integer;
declare variable PAR_APENAS_PEDIDO_VENDA integer;
declare variable LSQL blob sub_type 1 segment size 80;
declare variable PAR_FILTRO_IMPORTACAO_NFCE blob sub_type 1 segment size 80;
declare variable PAR_APENAS_VALOR_LIQUIDO integer;
declare variable LVALORACRESCIMO double precision;
BEGIN
  IF (EXISTS(SELECT 1 FROM CONSULTA_CUSTOMIZADA WHERE CONSULTA_CUSTOMIZADA.CONSULTA = 'AGILIS_IMPORTAVENDA_NFCE')) THEN
  BEGIN
    SELECT SQL FROM CONSULTA_CUSTOMIZADA WHERE CONSULTA_CUSTOMIZADA.CONSULTA = 'AGILIS_IMPORTAVENDA_NFCE' INTO LSQL;
    FOR EXECUTE STATEMENT (LSQL)
    (
      ECODPEDVEND := :ECODPEDVEND,
      ECODEMPRESA := :ECODEMPRESA
    )
    INTO
      CODPEDVEND, 
      EMISSAO, 
      CODPESSOA, 
      NOMEPESSOA, 
      CPFCGCPESSOA, 
      BAIRRO_1, 
      CEP_1, 
      CIDADE_1, 
      CODIBGE, 
      COMPLEMENTO_1, 
      LOGRADOURO_1, 
      NUMERO_1, 
      UF_1, 
      CODVENDEDOR, 
      NOMEVENDEDOR, 
      NUMNFCE, 
      SERIENFCE, 
      VALOR_BRUTO, 
      LVALOR_BRUTO, 
      VALOR_TOTAL, 
      DESCONTO, 
      DESC_VALOR, 
      ACRESCIMO, 
      ACRES_VALOR, 
      VALOR_PAGO, 
      NRITENS, 
      CODPEDVENDITEM, 
      CODPRODFILHO, 
      CODPESQUISA, 
      PRECOPROD, 
      QTDE, 
      DESC_VALORITEM, 
      PRECOVEND, 
      CONTITEM, 
      DESCR_PRODUTO, 
      ALIQUOTAICMS, 
      UNIDADEMED, 
      TRIBUTADO, 
      NCM_CODIGO, 
      CODIGOCEST, 
      PRECOUSADO, 
      PRDF_CST_ORIGEM_MERCADORIA, 
      PRDF_CST_TRIBICMS, 
      PERC_COFINS, 
      PERC_PIS, 
      CSTPIS, 
      CFOP, 
      CODCLASSIFICACAOSERVICO, 
      ALIQUOTAISS, 
      PRECOPRODTABELA, 
      CODDAV, 
      PERC_REDUCAO_ICMS, 
      OBSERVACOES, 
      CODANP, 
      DESCANP
    DO
    BEGIN
      SUSPEND;
    END
    EXIT;
  END

  CODANP  = null;
  DESCANP = null;
  select
    VALOR
  from
    MLERPARAMETROLOGICO('IMPORTAR APENAS PEDIDO "VENDA"', 0)
  into
    PAR_APENAS_PEDIDO_VENDA;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('IMPORTAR VALOR LIQUIDO DO PEDIDO', 0)
  into
    PAR_APENAS_VALOR_LIQUIDO;

  CODDAV = 0;
  if (ECODEMPRESA = 0) then
  begin
    select
      first 1
      E.CODEMPRESA
    from
      EMPRESA E
      join SYSPARAMS S on
        E.CGC = S.CGC
    into
      LCODEMPRESA;
  end
  else
    LCODEMPRESA = ECODEMPRESA;

  ALIQUOTAISS             = 0;
  CODCLASSIFICACAOSERVICO = null;
  CODPEDVEND              = ECODPEDVEND;
  select
    M.VALOR
  from
    MLERPARAMETROINTEIRO('CLIENTE PADRÃO DO PDV', 0) M
  into
    LCODPESSOAVENDA;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('IMPORTAR APENAS ITENS NÃO ESPECIAIS', 0)
  into
    PAR_APENAS_NAO_ESPECIAIS;

  select
    VALOR
  from
    MLERPARAMETROMEMO('FILTRO DE IMPORTACAO NFC-E', null)
  into
    PAR_FILTRO_IMPORTACAO_NFCE;

  select
    (select
      FU_GETTIRAMASCARA.STRRESULT
    from
      FU_GETTIRAMASCARA(S.CEP)),
    coalesce(nullif(S.CODIBGE, '0'), '0000000')
  from
    SYSPARAMS S
  into
    LCEP,
    LCODIBGE;

  LSQL = '';
  LSQL = LSQL || '  select';
  LSQL = LSQL || '    P.CODPESSOA,';
  LSQL = LSQL || '    S.NOME,';
  LSQL = LSQL || '    S.CPFCGC,';
  LSQL = LSQL || '    S.CEP_1,';
  LSQL = LSQL || '    S.LOGRADOURO_1,';
  LSQL = LSQL || '    S.BAIRRO_1,';
  LSQL = LSQL || '    S.CIDADE_1,';
  LSQL = LSQL || '    S.UF_1,';
  LSQL = LSQL || '    S.CODIBGE,';
  LSQL = LSQL || '    S.NUMERO_1,';
  LSQL = LSQL || '    S.COMPLEMENTO_1,';
  LSQL = LSQL || '    V.CODVENDEDOR,';
  LSQL = LSQL || '    V.NOME,';
  LSQL = LSQL || '    cast(coalesce(nullif(P.COO,''''), null) as integer),';
  LSQL = LSQL || '    P.ECF,';
  if (PAR_APENAS_VALOR_LIQUIDO <> 0) then /* LEVAR APENAS O VALOR LIQUIDO SEM DESCONTO OU ACRESCIMO PARA O CUPOM. */
  begin
    LSQL = LSQL || '    0, ';
    LSQL = LSQL || '    0, ';
    LSQL = LSQL || '    cast(P.DT_SAIDA as date),';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.NRITENS,';
  end
  else
  begin
    LSQL = LSQL || '    coalesce(P.VALOR_ACRESCIMO, 0) + coalesce(P.ACRESVALOR,0) + coalesce(P.FRETE,0) + coalesce(P.MONTAGEM,0),';
    LSQL = LSQL || '    coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0),';
    LSQL = LSQL || '    cast(P.DT_SAIDA as date),';
    LSQL = LSQL || '    P.VALOR_BRUTO,';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.NRITENS,';
  end
  LSQL = LSQL || '    coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0),';
  LSQL = LSQL || '    coalesce(P.VALOR_ACRESCIMO, 0) + coalesce(P.ACRESVALOR,0) + coalesce(P.FRETE,0) + coalesce(P.MONTAGEM,0),';
  LSQL = LSQL || '    P.VALOR_BRUTO';
  LSQL = LSQL || '  from';
  LSQL = LSQL || '    PEDVEND P';
  LSQL = LSQL || '    join PESSOA S on';
  LSQL = LSQL || '      P.CODPESSOA = S.CODPESSOA';
  LSQL = LSQL || '    join VENDEDOR V on';
  LSQL = LSQL || '      P.CODVENDEDOR = V.CODVENDEDOR';
  LSQL = LSQL || '  where';
  LSQL = LSQL || '    P.CODPEDVEND = ' || ECODPEDVEND || ' and';
  LSQL = LSQL || '    P.CODEMPRESA = ' || LCODEMPRESA || ' and';
  LSQL = LSQL || '    P.NUMNFCE    is null and ';
  LSQL = LSQL || '    P.CODNFVENDA is null and ';
  LSQL = LSQL || '    P.CODCUPOM   is null and ';
  LSQL = LSQL || '    P.STATUSPED <> ''CANCELADO'' and ';
  LSQL = LSQL || '    (('||:PAR_APENAS_PEDIDO_VENDA||' = 0) ';
  LSQL = LSQL || '    or ((P.TIPOPED = ''VENDA'') and ('||:PAR_APENAS_PEDIDO_VENDA||' <> 0))) ';
  if (PAR_FILTRO_IMPORTACAO_NFCE is not null) then
    LSQL = LSQL || '     ' || PAR_FILTRO_IMPORTACAO_NFCE;

  execute statement
    LSQL
  into
    CODPESSOA,
    NOMEPESSOA,
    CPFCGCPESSOA,
    CEP_1,
    LOGRADOURO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CODIBGE,
    NUMERO_1,
    COMPLEMENTO_1,
    CODVENDEDOR,
    NOMEVENDEDOR,
    NUMNFCE,
    SERIENFCE,
    ACRES_VALOR,
    DESC_VALOR,
    EMISSAO,
    VALOR_BRUTO,
    VALOR_TOTAL,
    VALOR_PAGO,
    NRITENS,
    LVALORDESCONTO,
    LVALORACRESCIMO,
    LVALOR_BRUTO;

  if (VALOR_TOTAL is not null) then
  begin
    if (CODPESSOA = LCODPESSOAVENDA) then
    begin
      CODPESSOA    = null;
      NOMEPESSOA   = null;
      CPFCGCPESSOA = null;
    end
    else
    begin
      select
        F.STRRESULT
      from
        FU_GETTIRAMASCARA(:CPFCGCPESSOA) F
      into
        CPFCGCPESSOA;
    end
  
    select
      FU_GETTIRAMASCARA.STRRESULT
    from
      FU_GETTIRAMASCARA(:CEP_1)
    into
      CEP_1;
  
    CEP_1 = coalesce(nullif(CEP_1, ''), LCEP);
  
    if (CHAR_LENGTH(CODIBGE) <> 7) then
      CODIBGE = LCODIBGE;
  
    DESCONTO  = (DESC_VALOR * 100) / VALOR_BRUTO;
    ACRESCIMO = (ACRES_VALOR * 100) / VALOR_BRUTO;
  
    for select
      I.CODDAVITEM,
      I.CODPRODFILHO,
      I.CODPESQUISA,
      I.PRECOPROD,
      COALESCE(PL.QTD, I.QTDE),
      I.PRECOVEND,
      F.DESCRICAO,
      F.ALIQUOTAICMS,
      U.SIGLA,
      F.TRIBUTADO,
      F.CLASSFISCAL,
      I.PRECOUSADO,
      F.PRDF_CST_ORIGEM_MERCADORIA,
      F.PRDF_CST_TRIBICMS,
      F.PERC_COFINS,
      F.PERC_PIS,
      F.CSTPIS,
      F.CODCEST,
      I.PRECOPRODTABELA,
      I.DESCONTO_VALOR,
      F.PERC_REDUCAO_ICMS,
      I.OBSERVACOES,
      pl.lote,
      DATETOSTRING(cast(pl.datafab as date),0),
      DATETOSTRING(cast(pl.dataval as date),0)
    from
      PEDVEND P
      join PEDVENDITEM I on
        P.CODPEDVEND = I.CODPEDVEND
      join PRODFILHO F on
        I.CODPRODFILHO = F.CODPRODFILHO
      join PRODUTO PR on
        F.CODPRODUTO = PR.CODPRODUTO
      join UNIDADE U on
        coalesce(I.CODUNIDADE, F.CODUNIDADE) = U.CODUNIDADE
      left join PEDVENDITEMLOTE PL on
        I.CODPEDVENDITEM = PL.CODPEDVENDITEM
        and not exists(select * from LOTE)
    where
      P.NUMNFCE    is null and
      P.CODNFVENDA is null and
      P.CODCUPOM   is null and
      P.STATUSPED <> 'CANCELADO' and
      ((:PAR_APENAS_PEDIDO_VENDA = 0) or ((P.TIPOPED = 'VENDA') and (:PAR_APENAS_PEDIDO_VENDA <> 0))) and
      P.CODPEDVEND = :ECODPEDVEND and
      ((:PAR_APENAS_NAO_ESPECIAIS = 0) or ((:PAR_APENAS_NAO_ESPECIAIS <> 0) and (coalesce(PR.TRATESP,1) = 1)))
    into
      CODPEDVENDITEM,
      CODPRODFILHO,
      CODPESQUISA,
      PRECOPROD,
      QTDE,
      PRECOVEND,
      DESCR_PRODUTO,
      ALIQUOTAICMS,
      UNIDADEMED,
      TRIBUTADO,
      NCM_CODIGO,
      PRECOUSADO,
      PRDF_CST_ORIGEM_MERCADORIA,
      PRDF_CST_TRIBICMS,
      PERC_COFINS,
      PERC_PIS,
      CSTPIS,
      LCODCEST,
      PRECOPRODTABELA,
      DESC_VALORITEM,
      PERC_REDUCAO_ICMS,
      OBSERVACOES,
      LOTE,
      DATAFAB,
      DATAVAL
    do
    begin
  /*  0 / I - ISENTO */
  /*  4 / N - NAO TRIBUTADO */
  /*  3 / F - SUBSTITUICAO TRIBUTARIA */
  /*  1 / T - TRIBUTADO PELO ICMS */

      if (PAR_APENAS_VALOR_LIQUIDO <> 0) then
      begin
        LFATOR = PRECOVEND / LVALOR_BRUTO;
        PRECOVEND = PRECOVEND + (LVALORACRESCIMO * LFATOR);
        PRECOVEND = PRECOVEND - (LVALORDESCONTO * LFATOR);
        PRECOPROD = PRECOVEND / QTDE;
        DESC_VALORITEM = 0;
      end
    
      CFOP = '5102';
      if (TRIBUTADO = '3') then
        CFOP = '5405';
  
      CONTITEM = coalesce(CONTITEM, 0) + 1;
  
      select
        C.CODIGOCEST
      from
        CEST C
      where
        C.CODCEST = :LCODCEST
      into
        CODIGOCEST;
      suspend;
    end 
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE AGILIS_IMPORTAVENDA_NFCE_CUSTOM(
    ECODPEDVEND INTEGER,
    ECODEMPRESA INTEGER = 0)
RETURNS (
    CODPEDVEND INTEGER,
    EMISSAO DATE,
    CODPESSOA INTEGER,
    NOMEPESSOA VARCHAR(60),
    CPFCGCPESSOA VARCHAR(18),
    BAIRRO_1 VARCHAR(45),
    CEP_1 VARCHAR(9),
    CIDADE_1 VARCHAR(45),
    CODIBGE INTEGER,
    COMPLEMENTO_1 VARCHAR(60),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    UF_1 CHAR(2),
    CODVENDEDOR INTEGER,
    NOMEVENDEDOR VARCHAR(60),
    NUMNFCE INTEGER,
    SERIENFCE VARCHAR(10),
    VALOR_BRUTO DOUBLE PRECISION,
    LVALOR_BRUTO DOUBLE PRECISION,
    VALOR_TOTAL DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    DESC_VALOR NUMERIC(15,2),
    ACRESCIMO DOUBLE PRECISION,
    ACRES_VALOR NUMERIC(15,2),
    VALOR_PAGO DOUBLE PRECISION,
    NRITENS INTEGER,
    CODPEDVENDITEM INTEGER,
    CODPRODFILHO INTEGER,
    CODPESQUISA VARCHAR(30),
    PRECOPROD DOUBLE PRECISION,
    QTDE DOUBLE PRECISION,
    DESC_VALORITEM DOUBLE PRECISION,
    PRECOVEND NUMERIC(15,2),
    CONTITEM INTEGER,
    DESCR_PRODUTO VARCHAR(60),
    ALIQUOTAICMS DOUBLE PRECISION,
    UNIDADEMED VARCHAR(5),
    TRIBUTADO VARCHAR(1),
    NCM_CODIGO VARCHAR(8),
    CODIGOCEST VARCHAR(7),
    PRECOUSADO VARCHAR(10),
    PRDF_CST_ORIGEM_MERCADORIA SMALLINT,
    PRDF_CST_TRIBICMS CHAR(3),
    PERC_COFINS DOUBLE PRECISION,
    PERC_PIS DOUBLE PRECISION,
    CSTPIS CHAR(2),
    CFOP VARCHAR(4),
    CODCLASSIFICACAOSERVICO VARCHAR(5),
    ALIQUOTAISS DOUBLE PRECISION,
    PRECOPRODTABELA DOUBLE PRECISION,
    CODDAV INTEGER,
    PERC_REDUCAO_ICMS DOUBLE PRECISION,
    OBSERVACOES BLOB SUB_TYPE TEXT SEGMENT SIZE 80,
    CODANP VARCHAR(30),
    DESCANP VARCHAR(95),
    LOTE VARCHAR(200),
    DATAVAL VARCHAR(10),
    DATAFAB VARCHAR(10),
    QTDLOTE DOUBLE PRECISION)
AS
declare variable LCODPESSOAVENDA integer;
declare variable LCEP varchar(9);
declare variable LCODIBGE integer;
declare variable LCODEMPRESA integer;
declare variable LCODCEST integer;
declare variable LVALORDESCONTO double precision;
declare variable LFATOR double precision;
declare variable PAR_APENAS_NAO_ESPECIAIS integer;
declare variable PAR_APENAS_PEDIDO_VENDA integer;
declare variable LSQL blob sub_type 1 segment size 80;
declare variable PAR_FILTRO_IMPORTACAO_NFCE blob sub_type 1 segment size 80;
declare variable PAR_APENAS_VALOR_LIQUIDO integer;
declare variable LVALORACRESCIMO double precision;
BEGIN
  CODANP  = null;
  DESCANP = null;
  select
    VALOR
  from
    MLERPARAMETROLOGICO('IMPORTAR APENAS PEDIDO "VENDA"', 0)
  into
    PAR_APENAS_PEDIDO_VENDA;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('IMPORTAR VALOR LIQUIDO DO PEDIDO', 0)
  into
    PAR_APENAS_VALOR_LIQUIDO;

  CODDAV = 0;
  if (ECODEMPRESA = 0) then
  begin
    select
      first 1
      E.CODEMPRESA
    from
      EMPRESA E
      join SYSPARAMS S on
        E.CGC = S.CGC
    into
      LCODEMPRESA;
  end
  else
    LCODEMPRESA = ECODEMPRESA;

  ALIQUOTAISS             = 0;
  CODCLASSIFICACAOSERVICO = null;
  CODPEDVEND              = ECODPEDVEND;
  select
    M.VALOR
  from
    MLERPARAMETROINTEIRO('CLIENTE PADRÃO DO PDV', 0) M
  into
    LCODPESSOAVENDA;

  select
    VALOR
  from
    MLERPARAMETROLOGICO('IMPORTAR APENAS ITENS NÃO ESPECIAIS', 0)
  into
    PAR_APENAS_NAO_ESPECIAIS;

  select
    VALOR
  from
    MLERPARAMETROMEMO('FILTRO DE IMPORTACAO NFC-E', null)
  into
    PAR_FILTRO_IMPORTACAO_NFCE;

  select
    (select
      FU_GETTIRAMASCARA.STRRESULT
    from
      FU_GETTIRAMASCARA(S.CEP)),
    coalesce(nullif(S.CODIBGE, '0'), '0000000')
  from
    SYSPARAMS S
  into
    LCEP,
    LCODIBGE;

  LSQL = '';
  LSQL = LSQL || '  select';
  LSQL = LSQL || '    P.CODPESSOA,';
  LSQL = LSQL || '    S.NOME,';
  LSQL = LSQL || '    S.CPFCGC,';
  LSQL = LSQL || '    S.CEP_1,';
  LSQL = LSQL || '    S.LOGRADOURO_1,';
  LSQL = LSQL || '    S.BAIRRO_1,';
  LSQL = LSQL || '    S.CIDADE_1,';
  LSQL = LSQL || '    S.UF_1,';
  LSQL = LSQL || '    S.CODIBGE,';
  LSQL = LSQL || '    S.NUMERO_1,';
  LSQL = LSQL || '    S.COMPLEMENTO_1,';
  LSQL = LSQL || '    V.CODVENDEDOR,';
  LSQL = LSQL || '    V.NOME,';
  LSQL = LSQL || '    cast(coalesce(nullif(P.COO,''''), null) as integer),';
  LSQL = LSQL || '    P.ECF,';
  if (PAR_APENAS_VALOR_LIQUIDO <> 0) then /* LEVAR APENAS O VALOR LIQUIDO SEM DESCONTO OU ACRESCIMO PARA O CUPOM. */
  begin
    LSQL = LSQL || '    0, ';
    LSQL = LSQL || '    0, ';
    LSQL = LSQL || '    cast(P.DT_SAIDA as date),';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.NRITENS,';
  end
  else
  begin
    LSQL = LSQL || '    coalesce(P.VALOR_ACRESCIMO, 0) + coalesce(P.ACRESVALOR,0) + coalesce(P.FRETE,0) + coalesce(P.MONTAGEM,0),';
    LSQL = LSQL || '    coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0),';
    LSQL = LSQL || '    cast(P.DT_SAIDA as date),';
    LSQL = LSQL || '    P.VALOR_BRUTO,';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.VALOR_TOTAL,';
    LSQL = LSQL || '    P.NRITENS,';
  end
  LSQL = LSQL || '    coalesce(P.DESC_VALOR,0) + coalesce(P.DESCPERC_VALOR,0),';
  LSQL = LSQL || '    coalesce(P.VALOR_ACRESCIMO, 0) + coalesce(P.ACRESVALOR,0) + coalesce(P.FRETE,0) + coalesce(P.MONTAGEM,0),';
  LSQL = LSQL || '    P.VALOR_BRUTO';
  LSQL = LSQL || '  from';
  LSQL = LSQL || '    PEDVEND P';
  LSQL = LSQL || '    join PESSOA S on';
  LSQL = LSQL || '      P.CODPESSOA = S.CODPESSOA';
  LSQL = LSQL || '    join VENDEDOR V on';
  LSQL = LSQL || '      P.CODVENDEDOR = V.CODVENDEDOR';
  LSQL = LSQL || '  where';
  LSQL = LSQL || '    P.CODPEDVEND = ' || ECODPEDVEND || ' and';
  LSQL = LSQL || '    P.CODEMPRESA = ' || LCODEMPRESA || ' and';
  LSQL = LSQL || '    P.NUMNFCE    is null and ';
  LSQL = LSQL || '    P.CODNFVENDA is null and ';
  LSQL = LSQL || '    P.CODCUPOM   is null and ';
  LSQL = LSQL || '    P.STATUSPED <> ''CANCELADO'' and ';
  LSQL = LSQL || '    (('||:PAR_APENAS_PEDIDO_VENDA||' = 0) ';
  LSQL = LSQL || '    or ((P.TIPOPED = ''VENDA'') and ('||:PAR_APENAS_PEDIDO_VENDA||' <> 0))) ';
  if (PAR_FILTRO_IMPORTACAO_NFCE is not null) then
    LSQL = LSQL || '     ' || PAR_FILTRO_IMPORTACAO_NFCE;

  execute statement
    LSQL
  into
    CODPESSOA,
    NOMEPESSOA,
    CPFCGCPESSOA,
    CEP_1,
    LOGRADOURO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CODIBGE,
    NUMERO_1,
    COMPLEMENTO_1,
    CODVENDEDOR,
    NOMEVENDEDOR,
    NUMNFCE,
    SERIENFCE,
    ACRES_VALOR,
    DESC_VALOR,
    EMISSAO,
    VALOR_BRUTO,
    VALOR_TOTAL,
    VALOR_PAGO,
    NRITENS,
    LVALORDESCONTO,
    LVALORACRESCIMO,
    LVALOR_BRUTO;

  if (VALOR_TOTAL is not null) then
  begin
    if (CODPESSOA = LCODPESSOAVENDA) then
    begin
      CODPESSOA    = null;
      NOMEPESSOA   = null;
      CPFCGCPESSOA = null;
    end
    else
    begin
      select
        F.STRRESULT
      from
        FU_GETTIRAMASCARA(:CPFCGCPESSOA) F
      into
        CPFCGCPESSOA;
    end
  
    select
      FU_GETTIRAMASCARA.STRRESULT
    from
      FU_GETTIRAMASCARA(:CEP_1)
    into
      CEP_1;
  
    CEP_1 = coalesce(nullif(CEP_1, ''), LCEP);
  
    if (CHAR_LENGTH(CODIBGE) <> 7) then
      CODIBGE = LCODIBGE;
  
    DESCONTO  = (DESC_VALOR * 100) / VALOR_BRUTO;
    ACRESCIMO = (ACRES_VALOR * 100) / VALOR_BRUTO;
  
    for select
      I.CODDAVITEM,
      I.CODPRODFILHO,
      I.CODPESQUISA,
      I.PRECOPROD,
      COALESCE(PL.QTD, I.QTDE),
      I.PRECOVEND,
      F.DESCRICAO,
      F.ALIQUOTAICMS,
      U.SIGLA,
      F.TRIBUTADO,
      F.CLASSFISCAL,
      I.PRECOUSADO,
      F.PRDF_CST_ORIGEM_MERCADORIA,
      F.PRDF_CST_TRIBICMS,
      F.PERC_COFINS,
      F.PERC_PIS,
      F.CSTPIS,
      F.CODCEST,
      I.PRECOPRODTABELA,
      I.DESCONTO_VALOR,
      F.PERC_REDUCAO_ICMS,
      I.OBSERVACOES,
      pl.lote,
      right('00'||EXTRACT(DAY FROM cast(pl.datafab as date)),2)||'/'||right('00'||EXTRACT(MONTH FROM cast(pl.datafab as date)),2)||'/'||EXTRACT(YEAR FROM cast(pl.datafab as date)),
      right('00'||EXTRACT(DAY FROM cast(pl.dataval as date)),2)||'/'||right('00'||EXTRACT(MONTH FROM cast(pl.dataval as date)),2)||'/'||EXTRACT(YEAR FROM cast(pl.dataval as date))
    from
      PEDVEND P
      join PEDVENDITEM I on
        P.CODPEDVEND = I.CODPEDVEND
      join PRODFILHO F on
        I.CODPRODFILHO = F.CODPRODFILHO
      join PRODUTO PR on
        F.CODPRODUTO = PR.CODPRODUTO
      join UNIDADE U on
        coalesce(I.CODUNIDADE, F.CODUNIDADE) = U.CODUNIDADE
      left join PEDVENDITEMLOTE PL on
        I.CODPEDVENDITEM = PL.CODPEDVENDITEM
        and not exists(select * from LOTE)
    where
      P.NUMNFCE    is null and
      P.CODNFVENDA is null and
      P.CODCUPOM   is null and
      P.STATUSPED <> 'CANCELADO' and
      ((:PAR_APENAS_PEDIDO_VENDA = 0) or ((P.TIPOPED = 'VENDA') and (:PAR_APENAS_PEDIDO_VENDA <> 0))) and
      P.CODPEDVEND = :ECODPEDVEND and
      ((:PAR_APENAS_NAO_ESPECIAIS = 0) or ((:PAR_APENAS_NAO_ESPECIAIS <> 0) and (coalesce(PR.TRATESP,1) = 1)))
    into
      CODPEDVENDITEM,
      CODPRODFILHO,
      CODPESQUISA,
      PRECOPROD,
      QTDE,
      PRECOVEND,
      DESCR_PRODUTO,
      ALIQUOTAICMS,
      UNIDADEMED,
      TRIBUTADO,
      NCM_CODIGO,
      PRECOUSADO,
      PRDF_CST_ORIGEM_MERCADORIA,
      PRDF_CST_TRIBICMS,
      PERC_COFINS,
      PERC_PIS,
      CSTPIS,
      LCODCEST,
      PRECOPRODTABELA,
      DESC_VALORITEM,
      PERC_REDUCAO_ICMS,
      OBSERVACOES,
      LOTE,
      DATAFAB,
      DATAVAL
    do
    begin
  /*  0 / I - ISENTO */
  /*  4 / N - NAO TRIBUTADO */
  /*  3 / F - SUBSTITUICAO TRIBUTARIA */
  /*  1 / T - TRIBUTADO PELO ICMS */

      if (PAR_APENAS_VALOR_LIQUIDO <> 0) then
      begin
        LFATOR = PRECOVEND / LVALOR_BRUTO;
        PRECOVEND = PRECOVEND + (LVALORACRESCIMO * LFATOR);
        PRECOVEND = PRECOVEND - (LVALORDESCONTO * LFATOR);
        PRECOPROD = PRECOVEND / QTDE;
        DESC_VALORITEM = 0;
      end
    
      CFOP = '5102';
      if (TRIBUTADO = '3') then
        CFOP = '5405';
  
      CONTITEM = coalesce(CONTITEM, 0) + 1;
  
      select
        C.CODIGOCEST
      from
        CEST C
      where
        C.CODCEST = :LCODCEST
      into
        CODIGOCEST;
      suspend;
    end 
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APC170(
    CODEMPRESA INTEGER,
    CODIGO INTEGER,
    SERIE VARCHAR(3),
    ARQ INTEGER,
    RETTUDO INTEGER = 0)
RETURNS (
    CODPRODFILHO INTEGER,
    CODPESQ1 VARCHAR(30),
    CODPESQ2 VARCHAR(30),
    CODPESQ3 VARCHAR(30),
    DESCRICAO VARCHAR(60),
    QTD DOUBLE PRECISION,
    UNID VARCHAR(5),
    PRODVLR DOUBLE PRECISION,
    VALORTOTAL DOUBLE PRECISION,
    VALORBRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    DESPESAS DOUBLE PRECISION,
    MOVFISICA INTEGER,
    CSTICMS VARCHAR(3),
    CODCFOP INTEGER,
    CFOP VARCHAR(4),
    ICMSBASE DOUBLE PRECISION,
    ICMSPERC DOUBLE PRECISION,
    ICMS DOUBLE PRECISION,
    REDUCAO DOUBLE PRECISION,
    ISENTAS DOUBLE PRECISION,
    OUTRAS DOUBLE PRECISION,
    ICMSSTBASE DOUBLE PRECISION,
    ICMSSTPERC DOUBLE PRECISION,
    ICMSST DOUBLE PRECISION,
    APURACAOIPI INTEGER,
    CSTIPI VARCHAR(2),
    IPIBASE DOUBLE PRECISION,
    IPIPERC DOUBLE PRECISION,
    IPI DOUBLE PRECISION,
    BASE DOUBLE PRECISION,
    ORIGEMDADOS VARCHAR(10),
    CSTPIS VARCHAR(2),
    PIS DOUBLE PRECISION,
    VALORPIS DOUBLE PRECISION,
    CSTCOFINS VARCHAR(2),
    COFINS DOUBLE PRECISION,
    VALORCOFINS DOUBLE PRECISION,
    C176_MODELO VARCHAR(2),
    C176_DOCUMENTO VARCHAR(15),
    C176_SERIE VARCHAR(3),
    C176_DTEMISSAO TIMESTAMP,
    C176_CODPESSOA INTEGER,
    C176_QTD DOUBLE PRECISION,
    C176_PRODVLR DOUBLE PRECISION,
    C176_BASE_SUBS DOUBLE PRECISION,
    C176_CHAVE_NFE_ULT_E VARCHAR(44),
    C176_NUM_ITEM_ULT_E VARCHAR(3),
    C176_VL_UNIT_BC_ICMS_ULT_E DOUBLE PRECISION,
    C176_ALIQ_ICMS_ULT_E DOUBLE PRECISION,
    C176_VL_LIMITE_BC_ICMS_ULT_E DOUBLE PRECISION,
    C176_VL_UNIT_ICMS_ULT_E DOUBLE PRECISION,
    C176_ALIQ_ST_ULT_E DOUBLE PRECISION,
    C176_VL_UNIT_RES DOUBLE PRECISION,
    C176_COD_RESP VARCHAR(1),
    C176_COD_MOT_RES VARCHAR(1),
    C176_CHAVE_NFE_RET VARCHAR(44),
    C176_COD_PART_NFE_RET VARCHAR(60),
    C176_SER_NFE_RET VARCHAR(3),
    C176_NUM_NFE_RET VARCHAR(9),
    C176_ITEM_NFE_RET VARCHAR(3),
    C176_COD_DA VARCHAR(1),
    C176_NUM_DA VARCHAR(10),
    RECEITAEFD VARCHAR(3),
    VALORPISST DOUBLE PRECISION,
    VALORCOFINSST DOUBLE PRECISION,
    ICMSDEST DOUBLE PRECISION,
    ICMSINTER DOUBLE PRECISION,
    VALORFCP DOUBLE PRECISION)
AS
declare variable CODARQUIVO integer;
declare variable PARAM_ESP varchar(1);
declare variable CODAPFISCAL_CFOP integer;
declare variable APFISCAL_ICMS varchar(3);
declare variable APFISCAL_CST varchar(4);
declare variable APFISCAL_ST varchar(3);
declare variable APFISCAL_IPI varchar(3);
declare variable TIPONOTA varchar(1);
declare variable LCST varchar(4);
declare variable LCODUNIDADE integer;
declare variable LBASE double precision;
declare variable LDATA date;
declare variable NF_CST_PIS varchar(2);
declare variable NF_PIS_BASE double precision;
declare variable NF_PIS_PERC double precision;
declare variable NF_PIS_VALOR double precision;
declare variable NF_CST_COFINS varchar(2);
declare variable NF_COFINS_BASE double precision;
declare variable NF_COFINS_PERC double precision;
declare variable NF_COFINS_VALOR double precision;
declare variable CFOP_CSTPIS varchar(2);
declare variable CFOP_PIS double precision;
declare variable CFOP_CSTCOFINS varchar(2);
declare variable CFOP_COFINS double precision;
declare variable CFOP_CSTPISENTRADA varchar(2);
declare variable CFOP_PISENTRADA double precision;
declare variable CFOP_CSTCOFINSENTRADA varchar(2);
declare variable CFOP_COFINSENTRADA double precision;
declare variable PROD_CST_PIS_S varchar(2);
declare variable PROD_CST_COFINS_S varchar(2);
declare variable PROD_PIS_S double precision;
declare variable PROD_COFINS_S double precision;
declare variable PROD_CST_PIS_E varchar(2);
declare variable PROD_CST_COFINS_E varchar(2);
declare variable PROD_PIS_E double precision;
declare variable PROD_COFINS_E double precision;
declare variable PROD_CST_IPI_S varchar(2);
declare variable PROD_CST_IPI_E varchar(2);
declare variable PARAM_ENVIARST varchar(1);
declare variable PARAM_ENVIARIPI varchar(1);
declare variable PARAM_BASE varchar(1);
declare variable ESP_IPI varchar(1);
declare variable ESP_ST varchar(1);
declare variable ESP_FRETE varchar(1);
declare variable ESP_DESCONTO varchar(1);
declare variable ESP_DESPESAS varchar(1);
declare variable SQL varchar(1000);
declare variable PERFIL varchar(1);
declare variable PARAM_SIMPLESPB varchar(1);
declare variable PERC_REDUCAO double precision;
declare variable PARAM_GERAC170 varchar(1);
begin
  SQL = 'SELECT
    COALESCE(PARAM_ENVIARST, ''N''),
    COALESCE(PARAM_ENVIARIPI, ''N''),
    COALESCE(PARAM_BASE, ''N''),
    COALESCE(ESP_IPI, ''N''),
    COALESCE(ESP_ST, ''N''),
    COALESCE(ESP_FRETE, ''N''),
    COALESCE(ESP_DESCONTO, ''N''),
    COALESCE(PERFIL, ''N''),
    COALESCE(ESP_DESPESAS, ''N''),
    COALESCE(PARAM_SIMPLESPB, ''N''),
    COALESCE(PARAM_GERAC170, ''N'')
  FROM
    APFISCAL A
  WHERE
    A.ARQ =' || :ARQ || 'AND ' || 'A.CODEMPRESA = ' || :CODEMPRESA;

  execute statement
    SQL
  into
    PARAM_ENVIARST,
    PARAM_ENVIARIPI,
    PARAM_BASE,
    ESP_IPI,
    ESP_ST,
    ESP_FRETE,
    ESP_DESCONTO,
    PERFIL,
    ESP_DESPESAS,
    PARAM_SIMPLESPB,
    PARAM_GERAC170;

  select
    APFISCAL.CODIGO,
    APFISCAL.PARAM_ESP
  from
    APFISCAL
  where
    APFISCAL.ARQ =:ARQ and
    APFISCAL.CODEMPRESA =:CODEMPRESA
  into
    :CODARQUIVO,
    :PARAM_ESP;

  PARAM_ESP   = coalesce(PARAM_ESP,'N');

  if (SERIE = 'C') then
  begin
    for select
      coalesce(cI.PRDF_CST_ORIGEM_MERCADORIA, '') || coalesce(CI.PRDF_CST_TRIBICMS,''),
      CI.CFOP,
      CI.CSTPIS,
      coalesce(CI.BASEICMS, 0),
      coalesce(CI.ALIQUOTAICMS, 0),
      coalesce(CI.VALORICMS, 0),
      coalesce(CI.BASEST, 0),
      coalesce(CI.VALORST, 0),
      coalesce(CI.BASEPIS, 0),
      coalesce(CI.PERC_PIS, 0),
      coalesce(CI.VALORPIS, 0),
      coalesce(CI.PERC_COFINS, 0),
      coalesce(CI.VALORCOFINS, 0),
      coalesce(CI.PRECOVEND, 0),
      coalesce(CI.DESC_VALOR, 0),
      coalesce(CI.PRECOLIQ, 0),
      coalesce(CI.RECEITAEFD, F.RECEITAEFD)
    from
      CUPOMITEM CI
      join PRODFILHO F on
        CI.CODPRODFILHO = F.CODPRODFILHO
    where
      CI.CODCUPOM = :CODIGO and
      CI.STATUSCUPOMITEM = 0
    into
      LCST, 
      CFOP,
      CSTPIS,
      ICMSBASE,
      ICMSPERC,
      ICMS,
      ICMSSTBASE,
      ICMSST,
      BASE,
      PIS,
      NF_PIS_VALOR,
      COFINS,
      NF_COFINS_VALOR,
      VALORBRUTO,
      DESCONTO,
      VALORTOTAL,
      RECEITAEFD
    do
    begin
      VALORPIS    = 0;
      VALORCOFINS = 0;
      OUTRAS      = 0;
      IPI         = 0;
      REDUCAO     = 0;
      VALORPIS    = NF_PIS_VALOR;
      VALORCOFINS = NF_COFINS_VALOR;
      LCST        = trim(LCST);
      VALORPISST    = 0;
      VALORCOFINSST = 0;

      if (CHAR_LENGTH(LCST) > 3) then
      begin
        LCST      = substring(LCST from 2 for 3);
        LCST      = trim(LCST);
      end
      CSTICMS     = trim(LCST);

      if ((CSTPIS <> '06') and (CSTPIS <> '07') and (CSTPIS <> '08') and (CSTPIS <> '09')) then
      begin
        BASE          = cast(BASE as numeric(18,2));
        PIS           = cast(PIS as numeric(18,2));
        VALORPIS      = cast(VALORPIS as numeric(18,2));
        COFINS        = cast(COFINS as numeric(18,2));
        VALORCOFINS   = cast(VALORCOFINS as numeric(18,2));

        if (CSTPIS = '05') then
        begin
          VALORPISST    = VALORPIS;
          VALORCOFINSST = VALORCOFINS;
        end

      end else
      begin
        BASE          = 0;
        PIS           = 0;
        VALORPIS      = 0;
        COFINS        = 0;
        VALORCOFINS   = 0;
        VALORPISST    = 0;
        VALORCOFINSST = 0;
      end

      if (PARAM_SIMPLESPB = 'N') then
      begin
        ICMSBASE    = cast(ICMSBASE as numeric(18,2));
        ICMSPERC    = cast(ICMSPERC as numeric(18,2));
        ICMS        = cast(ICMS as numeric(18,2));
        ICMSSTBASE  = cast(ICMSSTBASE as numeric(18,2));
        ICMSST      = cast(ICMSST as numeric(18,2));
        IPI         = cast(IPI as numeric(18,2));
        VALORBRUTO  = cast(VALORTOTAL as numeric(18,2));
        DESCONTO    = cast(DESCONTO as numeric(18,2));
        VALORTOTAL  = cast(VALORTOTAL as numeric(18,2));
        ISENTAS     = (VALORBRUTO - ICMSBASE);
      end
      else
      begin
        ICMSBASE    = 0;
        ICMSPERC    = 0;
        ICMS        = 0;
        ICMSSTBASE  = 0;
        ICMSST      = 0;
        IPI         = cast(IPI as numeric(18,2));
        VALORBRUTO  = cast(VALORTOTAL as numeric(18,2));
        DESCONTO    = cast(DESCONTO as numeric(18,2));
        VALORTOTAL  = cast(VALORTOTAL as numeric(18,2));
        ISENTAS     = (VALORBRUTO - ICMSBASE);
      end

      if (ISENTAS < 0) then
        ISENTAS = 0;

      suspend;
    end
  end
/*  else */
  if (SERIE <> '.') then
  begin
    select
      N.TIPONOTA,
      N.DT_EMISSAO
    from
      NFVENDA N
    where
      N.CODNFVENDA = :CODIGO and
      N.SERIE      = :SERIE
    into
      TIPONOTA,
      LDATA;

    for select
      I.CODCFOP,
      F.CODUNIDADE,
      I.CODPRODFILHO,
      I.PRECOVEND,
      I.QTDE,
      coalesce(I.TOTALVLRNOTA, I.TOTALVLR),
      coalesce(I.TOTALVLR, I.TOTALVLRNOTA),
      coalesce(I.DESCVLR, 0),
      coalesce(I.FRETE_VLR, 0),
      coalesce(I.ODESP_VALOR, 0),
      coalesce(trim(I.CST),''),
      coalesce(I.ICMSBASE, 0),
      coalesce(I.ICMSPERC, 0),
      coalesce(I.ICMSVALOR, 0),
      coalesce(I.BASE_SUBS, 0),
      coalesce(I.ALIQ_SUBS, 0),
      coalesce(I.VALOR_SUBS, 0),
      coalesce(I.IPIBASE, 0),
      coalesce(I.IPIPERC, 0),
      coalesce(I.IPIVALOR, 0),
      coalesce(I.VALOR_REDUCAO, 0),
      coalesce(I.ODESP_VALOR, 0),
      coalesce(I.PISCST,''),
      coalesce(I.BASE_PIS, 0),
      coalesce(I.PISPERC, 0),
      coalesce(I.PISVALOR, 0),
      coalesce(I.COFINSCST,''),
      coalesce(I.BASE_COFINS, 0),
      coalesce(I.COFINSPERC, 0),
      coalesce(I.COFINSVALOR, 0),
      coalesce(I.RECEITAEFD, F.RECEITAEFD),
      coalesce(I.PERC_REDUCAO, 0),
      coalesce(I.VALORICMSDEST,0),
      coalesce(I.VALORICMSINTER,0),
      coalesce(I.VALORFCP,0)
    from
      NFVENDAITEM I
      join PRODFILHO F on
        I.CODPRODFILHO = F.CODPRODFILHO
    where
      I.CODNFVENDA = :CODIGO and
      I.SERIE      = :SERIE
    into
      CODCFOP,
      LCODUNIDADE,
      CODPRODFILHO,
      PRODVLR,
      QTD,
      VALORTOTAL,
      VALORBRUTO,
      DESCONTO,
      FRETE,
      DESPESAS,
      LCST,
      ICMSBASE,
      ICMSPERC,
      ICMS,
      ICMSSTBASE,
      ICMSSTPERC,
      ICMSST,
      IPIBASE,
      IPIPERC,
      IPI,
      REDUCAO,
      OUTRAS,
      NF_CST_PIS,
      NF_PIS_BASE,
      NF_PIS_PERC,
      NF_PIS_VALOR,
      NF_CST_COFINS,
      NF_COFINS_BASE,
      NF_COFINS_PERC,
      NF_COFINS_VALOR,
      RECEITAEFD,
      PERC_REDUCAO,
      ICMSDEST,
      ICMSINTER,
      VALORFCP
    do
    begin
      MOVFISICA   = 0;
      ORIGEMDADOS = '';
      CSTPIS      = '';
      PIS         = 0;
      VALORPIS    = 0;
      CSTCOFINS   = '';
      COFINS      = 0;
      VALORCOFINS = 0;
      LBASE       = 0;
      LBASE       = VALORBRUTO;
      APURACAOIPI = 0;
      ISENTAS     = 0;
      OUTRAS      = 0;
      VALORPISST  = 0;
      VALORCOFINSST = 0;
      if (CHAR_LENGTH(LCST) > 3) then
      begin
        LCST      = substring(LCST from 2 for 3);
        LCST      = trim(LCST);
      end
      CSTICMS     = LCST;

      select
        P.PROD_DESCR,
        P.PROD_COD1,
        P.PROD_COD2,
        P.PROD_COD3,
        P.PROD_UND,
        P.PROD_CST_PIS_S,
        P.PROD_CST_COFINS_S,
        P.PROD_PIS_S,
        P.PROD_COFINS_S,
        P.PROD_CST_PIS_E,
        P.PROD_CST_COFINS_E,
        P.PROD_PIS_E,
        P.PROD_COFINS_E,
        P.PROD_CST_IPI_S,
        P.PROD_CST_IPI_E
      from
        APPROD(:CODPRODFILHO,0) P
      into
        DESCRICAO,
        CODPESQ1,
        CODPESQ2,
        CODPESQ3,
        UNID,
        PROD_CST_PIS_S,
        PROD_CST_COFINS_S,
        PROD_PIS_S,
        PROD_COFINS_S,
        PROD_CST_PIS_E,
        PROD_CST_COFINS_E,
        PROD_PIS_E,
        PROD_COFINS_E,
        PROD_CST_IPI_S,
        PROD_CST_IPI_E;
  
      if (LCODUNIDADE <= 0) then
        UNID = UNID;
      else
      begin
        select
          U.SIGLA
        from
          UNIDADE U
        where
          U.CODUNIDADE = :LCODUNIDADE
        into
          UNID;
      end

      select
        C.CFOP,
        coalesce(C.CSTPIS,''),
        coalesce(C.CSTCOFINS,''),
        coalesce(C.PERC_PIS,0),
        coalesce(C.PERC_COFINS,0),
        coalesce(C.CSTPISENTRADA,''),
        coalesce(C.CSTCOFINSENTRADA,''),
        coalesce(C.PERCPISCOMPRA,0),
        coalesce(C.PERCCONFINSCOMPRA,0)
      from
        CFOP C
      where
        C.CODCFOP = :CODCFOP
      into
        CFOP,
        CFOP_CSTPIS,
        CFOP_CSTCOFINS,
        CFOP_PIS,
        CFOP_COFINS,
        CFOP_CSTPISENTRADA,
        CFOP_CSTCOFINSENTRADA,
        CFOP_PISENTRADA,
        CFOP_COFINSENTRADA;

      if (PARAM_BASE = 'S') then
      begin
        LBASE = VALORBRUTO;

        if (ESP_IPI  = 'S') then
          LBASE = LBASE + IPI;
    
        if (ESP_ST  = 'S') then
          LBASE = LBASE + ICMSST;
    
        if (ESP_FRETE = 'S') then
          LBASE = LBASE + FRETE;
    
        if (ESP_DESCONTO = 'S') then
          LBASE = LBASE - DESCONTO;
  
        if (ESP_DESPESAS = 'S') then
          LBASE = LBASE + DESPESAS;
      end

      if (TIPONOTA = 'S') then
      begin
        if (PROD_CST_IPI_S = '') then
          CSTIPI = '99';
        else
          CSTIPI = PROD_CST_IPI_S;
        if ((CSTIPI = '51') or (CSTIPI = '52')) then
        begin
          IPI     = 0;
          IPIBASE = 0;
          IPIPERC = 0;
        end

        if (NF_CST_PIS <> '') then
        begin
          BASE        = NF_PIS_BASE;
          CSTPIS      = NF_CST_PIS;
          PIS         = NF_PIS_PERC;
          VALORPIS    = NF_PIS_VALOR;
          CSTCOFINS   = NF_CST_COFINS;
          COFINS      = NF_COFINS_PERC;
          VALORCOFINS = NF_COFINS_VALOR;
          ORIGEMDADOS = 'NF';
        end else
        if (CFOP_CSTPIS <> '') then
        begin
          BASE        = LBASE;
          CSTPIS      = CFOP_CSTPIS;
          PIS         = CFOP_PIS;
          VALORPIS    = (BASE * CFOP_PIS) / 100;
          CSTCOFINS   = CFOP_CSTCOFINS;
          COFINS      = CFOP_COFINS;
          VALORCOFINS = (BASE * CFOP_COFINS) / 100;
          ORIGEMDADOS = 'CFOP';
        end else
        if (PROD_CST_PIS_S <> '') then
        begin
          BASE        = LBASE;
          CSTPIS      = PROD_CST_PIS_S;
          PIS         = PROD_PIS_S;
          VALORPIS    = (BASE * PROD_PIS_S) / 100;
          CSTCOFINS   = PROD_CST_COFINS_S;
          COFINS      = PROD_COFINS_S;
          VALORCOFINS = (BASE * PROD_COFINS_S) / 100;
          ORIGEMDADOS = 'PRODUTO';
        end

        if ((CSTPIS <> '06') and (CSTPIS <> '07') and (CSTPIS <> '08') and (CSTPIS <> '09')) then
        begin
          BASE          = cast(BASE as numeric(18,2));
          PIS           = cast(PIS as numeric(18,2));
          VALORPIS      = cast(VALORPIS as numeric(18,2));
          COFINS        = cast(COFINS as numeric(18,2));
          VALORCOFINS   = cast(VALORCOFINS as numeric(18,2));
          if (CSTPIS = '05') then
          begin
            VALORPISST    = VALORPIS;
            VALORCOFINSST = VALORCOFINS;
          end
        end else
        begin
          BASE          = 0;
          PIS           = 0;
          VALORPIS      = 0;
          COFINS        = 0;
          VALORCOFINS   = 0;
          VALORPISST    = 0;
          VALORCOFINSST = 0;
        end

      end
      else
      if (TIPONOTA = 'E') then
      begin
        if (PROD_CST_IPI_E = '') then
          CSTIPI = '49';
        else
          CSTIPI = PROD_CST_IPI_E;
        if ((CSTIPI = '01') or (CSTIPI = '02')) then
        begin
          IPI     = 0;
          IPIBASE = 0;
          IPIPERC = 0;
        end
        
        if (NF_CST_PIS <> '') then
        begin
          BASE        = NF_PIS_BASE;
          CSTPIS      = NF_CST_PIS;
          PIS         = NF_PIS_PERC;
          VALORPIS    = NF_PIS_VALOR;
          CSTCOFINS   = NF_CST_COFINS;
          COFINS      = NF_COFINS_PERC;
          VALORCOFINS = NF_COFINS_VALOR;
          ORIGEMDADOS = 'NF';
        end else
        if (CFOP_CSTPISENTRADA <> '') then
        begin
          BASE        = LBASE;
          CSTPIS      = CFOP_CSTPISENTRADA;
          PIS         = CFOP_PISENTRADA;
          VALORPIS    = (BASE * CFOP_PISENTRADA) / 100;
          CSTCOFINS   = CFOP_CSTCOFINSENTRADA;
          COFINS      = CFOP_COFINSENTRADA;
          VALORCOFINS = (BASE * CFOP_COFINSENTRADA) / 100;
          ORIGEMDADOS = 'CFOP';
        end else
        if (PROD_CST_PIS_E <> '') then
        begin
          BASE        = LBASE;
          CSTPIS      = PROD_CST_PIS_E;
          PIS         = PROD_PIS_E;
          VALORPIS    = (BASE * PROD_PIS_E) / 100;
          CSTCOFINS   = PROD_CST_COFINS_E;
          COFINS      = PROD_COFINS_E;
          VALORCOFINS = (BASE * PROD_COFINS_E) / 100;
          ORIGEMDADOS = 'PRODUTO';
        end

        if ((CSTPIS <> '70') and (CSTPIS <> '71') and (CSTPIS <> '72') and (CSTPIS <> '73') and
            (CSTPIS <> '74') and (CSTPIS <> '98') and (CSTPIS <> '99')) then
        begin
          BASE          = cast(BASE as numeric(18,2));
          PIS           = cast(PIS as numeric(18,2));
          VALORPIS      = cast(VALORPIS as numeric(18,2));
          COFINS        = cast(COFINS as numeric(18,2));
          VALORCOFINS   = cast(VALORCOFINS as numeric(18,2));
          if (CSTPIS = '75') then
          begin
            VALORPISST    = VALORPIS;
            VALORCOFINSST = VALORCOFINS;
          end
        end else
        begin
          BASE          = 0;
          PIS           = 0;
          VALORPIS      = 0;
          COFINS        = 0;
          VALORCOFINS   = 0;
          VALORPISST    = 0;
          VALORCOFINSST = 0;
        end
      end

      if (PERC_REDUCAO > 0) then
      begin
        REDUCAO = VALORTOTAL - ICMSBASE;
      end

      if ((IPIPERC > 0) and (IPIBASE <= 0)) then
        IPIBASE = VALORBRUTO;
  
      if ((IPIPERC <= 0) and (IPIBASE > 0)) then
      begin
        IPIBASE = 0;
        IPIPERC = 0;
        IPI     = 0;
      end

      if (PARAM_ENVIARIPI = 'N') then
      begin
        IPIBASE = 0;
        IPIPERC = 0;
        IPI     = 0;
      end
  
      if  (PARAM_ENVIARST = 'N') then
      begin
        ICMSST     = 0;
        ICMSSTBASE = 0;
        ICMSSTPERC = 0;
      end

      PRODVLR     = cast(PRODVLR as numeric(18,2));
      VALORTOTAL  = cast(VALORTOTAL as numeric(18,2));
      DESCONTO    = cast(DESCONTO as numeric(18,2));
      FRETE       = cast(FRETE as numeric(18,2));
      DESPESAS    = cast(DESPESAS as numeric(18,2));
      ICMSBASE    = cast(ICMSBASE as numeric(18,2));
      ICMSPERC    = cast(ICMSPERC as numeric(18,2));
      ICMS        = cast(ICMS as numeric(18,2));
      ICMSSTBASE  = cast(ICMSSTBASE as numeric(18,2));
      ICMSSTPERC  = cast(ICMSSTPERC as numeric(18,2));
      ICMSST      = cast(ICMSST as numeric(18,2));
      IPIBASE     = cast(IPIBASE as numeric(18,2));
      IPIPERC     = cast(IPIPERC as numeric(18,2));
      IPI         = cast(IPI as numeric(18,2));
      ISENTAS     = (VALORBRUTO - ICMSBASE);

      if (ISENTAS < 0) then
        ISENTAS = 0;

      if ((ARQ = 2) and (PARAM_SIMPLESPB = 'N')) then
      begin
        C176_BASE_SUBS  = 0;
        C176_VL_UNIT_BC_ICMS_ULT_E = 0;
        C176_ALIQ_ICMS_ULT_E = 0;
        C176_VL_LIMITE_BC_ICMS_ULT_E = 0;
        C176_VL_UNIT_ICMS_ULT_E = 0;

        select
          MODELO, 
          DOCUMENTO, 
          SERIE, 
          DTEMISSAO, 
          CODPESSOA, 
          QTD, 
          PRODVLR, 
          BASE_SUBS,
          CHAVENFE,
          BASE_ICMS,
          ALIQ_ICMS,
          VLRRETENCAO,
          VLR_ICMS
        from
          APSTRE(:CODEMPRESA, :CODPRODFILHO, :LDATA)
        into
          C176_MODELO,
          C176_DOCUMENTO,
          C176_SERIE,
          C176_DTEMISSAO,
          C176_CODPESSOA,
          C176_QTD,
          C176_PRODVLR,
          C176_BASE_SUBS,
          C176_CHAVE_NFE_ULT_E,
          C176_VL_UNIT_BC_ICMS_ULT_E,
          C176_ALIQ_ICMS_ULT_E,
          C176_VL_LIMITE_BC_ICMS_ULT_E,
          C176_VL_UNIT_ICMS_ULT_E;

          C176_BASE_SUBS  = cast(C176_BASE_SUBS as numeric(18,2));
          C176_VL_UNIT_BC_ICMS_ULT_E = cast(C176_VL_UNIT_BC_ICMS_ULT_E as numeric(18,2));
          C176_ALIQ_ICMS_ULT_E = cast(C176_ALIQ_ICMS_ULT_E as numeric(18,2));
          C176_VL_LIMITE_BC_ICMS_ULT_E = cast(C176_VL_LIMITE_BC_ICMS_ULT_E as numeric(18,2));
          C176_VL_UNIT_ICMS_ULT_E = cast(C176_VL_UNIT_ICMS_ULT_E as numeric(18,2));
      end

      if (PARAM_SIMPLESPB = 'S') then
      begin
        ICMSBASE    = 0;
        ICMSPERC    = 0;
        ICMS        = 0;
        ICMSSTBASE  = 0;
        ICMSSTPERC  = 0;
        ICMSST      = 0;
        ISENTAS     = 0;
      end

      if (RETTUDO = 0) then
      begin
        if ((ARQ = 2) and (PARAM_SIMPLESPB = 'N') and PARAM_GERAC170<>'S') then
        begin
          if (C176_ALIQ_ICMS_ULT_E >0 ) then
            suspend;
        end
        else
          suspend;
      end
      else
        suspend;
    end

  end else
/*  if (SERIE = '') then */
  begin
    TIPONOTA = 'E';
    for select
      I.CODCFOP,
      F.CODUNIDADE,
      I.CODPRODFILHO,
      I.PRODVLR,
      I.QTD,
      coalesce(coalesce(I.TOTAL_NOTA, I.VALORTOTAL), I.TOTALPROD),
      coalesce(I.TOTALPROD, (I.QTD * I.PRODVLR)),
      coalesce(I.DESCTO_ITEM, 0),
      coalesce(I.FRETEVLRLTDA, 0),
      coalesce(I.DESP_VALOR, 0),
      coalesce(I.PRDF_CST_ORIGEM_MERCADORIA, '') || coalesce(I.PRDF_CST_TRIBICMS,''),
      coalesce(I.BASE_ICMS, 0),
      coalesce(I.DIFICMS, 0),
      coalesce(I.VL_DIFICMS, 0),
      coalesce(I.BASE_SUBS, 0),
      coalesce(I.ALIQ_SUBS, 0),
      coalesce(I.VALOR_SUBS, 0),
      coalesce(I.BASE_IPI, 0),
      coalesce(I.IPIPERC, 0),
      coalesce(I.VL_IPIPERC, 0),
      coalesce(I.REDUCAO_VALOR, 0),
      coalesce(I.PISCST,''),
      coalesce(I.BASE_PIS, 0),
      coalesce(I.PISPERC, 0),
      coalesce(I.PISVALOR, 0),
      coalesce(I.COFINSCST,''),
      coalesce(I.BASE_COFINS, 0),
      coalesce(I.COFINSPERC, 0),
      coalesce(I.COFINSVALOR, 0)
    from
      NFENTRADAITENS I
      join PRODFILHO F on
        I.CODPRODFILHO = F.CODPRODFILHO
    where
      I.CODNFENTRADA = :CODIGO
    into
      CODCFOP,
      LCODUNIDADE,
      CODPRODFILHO,
      PRODVLR,
      QTD,
      VALORTOTAL,
      VALORBRUTO,
      DESCONTO,
      FRETE,
      DESPESAS,
      LCST,
      ICMSBASE,
      ICMSPERC,
      ICMS,
      ICMSSTBASE,
      ICMSSTPERC,
      ICMSST,
      IPIBASE,
      IPIPERC,
      IPI,
      REDUCAO,
      NF_CST_PIS,
      NF_PIS_BASE,
      NF_PIS_PERC,
      NF_PIS_VALOR,
      NF_CST_COFINS,
      NF_COFINS_BASE,
      NF_COFINS_PERC,
      NF_COFINS_VALOR
    do
    begin
      MOVFISICA   = 0;
      ORIGEMDADOS = '';
      CSTPIS      = '';
      PIS         = 0;
      VALORPIS    = 0;
      CSTCOFINS   = '';
      COFINS      = 0;
      VALORCOFINS = 0;
      LBASE       = 0;
      LBASE       = VALORBRUTO;
      APURACAOIPI = 0;
      if (CHAR_LENGTH(LCST) > 3) then
      begin
        LCST      = substring(LCST from 2 for 3);
        LCST      = trim(LCST);
      end
      CSTICMS     = LCST;
      ISENTAS     = 0;
      OUTRAS      = 0;

      select
        C.CFOP,
        coalesce(C.CSTPISENTRADA,''),
        coalesce(C.CSTCOFINSENTRADA,''),
        coalesce(C.PERCPISCOMPRA,0),
        coalesce(C.PERCCONFINSCOMPRA,0)
      from
        CFOP C
      where
        C.CODCFOP = :CODCFOP
      into
        CFOP,
        CFOP_CSTPISENTRADA,
        CFOP_CSTCOFINSENTRADA,
        CFOP_PISENTRADA,
        CFOP_COFINSENTRADA;

      CODAPFISCAL_CFOP = Null;
      APFISCAL_ICMS    = Null;
      APFISCAL_IPI     = Null;
      APFISCAL_ST      = Null;
      APFISCAL_CST     = Null;

      if (PARAM_ESP = 'S') then
      begin
        select
          APFISCAL_CFOP.CODIGO,
          APFISCAL_CFOP.APFISCAL_ICMS,
          APFISCAL_CFOP.APFISCAL_IPI,
          APFISCAL_CFOP.APFISCAL_ST,
          APFISCAL_CFOP.APFISCAL_CST
        from
          APFISCAL_CFOP
        where
          APFISCAL_CFOP.CODIGOAP =:CODARQUIVO and
          APFISCAL_CFOP.CODCFOP =:CODCFOP
        into
          :CODAPFISCAL_CFOP,
          :APFISCAL_ICMS,
          :APFISCAL_IPI,
          :APFISCAL_ST,
          :APFISCAL_CST;
    
        APFISCAL_ICMS = coalesce(APFISCAL_ICMS,'NÃO');
        APFISCAL_IPI  = coalesce(APFISCAL_IPI,'NÃO');
        APFISCAL_ST   = coalesce(APFISCAL_ST,'NÃO');
  
        if (CODAPFISCAL_CFOP >= 1) then
        begin
          if (APFISCAL_CST is not null) then
          begin
            if (CHAR_LENGTH(APFISCAL_CST) > 3) then
            begin
              APFISCAL_CST  = substring(APFISCAL_CST from 2 for 3);
              APFISCAL_CST  = trim(APFISCAL_CST);
            end
            CSTICMS     = APFISCAL_CST;
          end

          if (APFISCAL_ICMS = 'SIM')then
          begin
            ICMSBASE     = ICMSBASE;
            ICMSPERC     = ICMSPERC;
            ICMS         = ICMS;
          end
          else
          begin
            ICMSBASE     = 0;
            ICMS         = 0;
            ICMSPERC     = 0;
            REDUCAO      = 0;
          end
  
          if (APFISCAL_IPI = 'SIM')then
          begin
            IPIBASE     = IPIBASE;
            IPIPERC     = IPIPERC;
            IPI         = IPI;
          end
          else
          begin
            IPIBASE     = 0;
            IPIPERC     = 0;
            IPI         = 0;
          end
  
          if (APFISCAL_ST = 'SIM')then
          begin
            ICMSSTBASE = ICMSSTBASE;
            ICMSSTPERC = ICMSSTPERC;
            ICMSST     = ICMSST;
          end
          else
          begin
            ICMSSTBASE = 0;
            ICMSSTPERC = 0;
            ICMSST     = 0;
          end
        end
      end

      select
        P.PROD_DESCR,
        P.PROD_COD1,
        P.PROD_COD2,
        P.PROD_COD3,
        P.PROD_UND,
        P.PROD_CST_PIS_E,
        P.PROD_CST_COFINS_E,
        P.PROD_PIS_E,
        P.PROD_COFINS_E,
        P.PROD_CST_IPI_S,
        P.PROD_CST_IPI_E
      from
        APPROD(:CODPRODFILHO,0) P
      into
        DESCRICAO,
        CODPESQ1,
        CODPESQ2,
        CODPESQ3,
        UNID,
        PROD_CST_PIS_E,
        PROD_CST_COFINS_E,
        PROD_PIS_E,
        PROD_COFINS_E,
        PROD_CST_IPI_S,
        PROD_CST_IPI_E;
  
      if (LCODUNIDADE <= 0) then
        UNID = UNID;
      else
      begin
        select
          U.SIGLA
        from
          UNIDADE U
        where
          U.CODUNIDADE = :LCODUNIDADE
        into
          UNID;
      end

      if (PARAM_BASE = 'S') then
      begin
        LBASE = VALORBRUTO;

        if (ESP_IPI  = 'S') then
          LBASE = LBASE + IPI;
    
        if (ESP_ST  = 'S') then
          LBASE = LBASE + ICMSST;
    
        if (ESP_FRETE = 'S') then
          LBASE = LBASE + FRETE;
    
        if (ESP_DESCONTO = 'S') then
          LBASE = LBASE - DESCONTO;
  
        if (ESP_DESPESAS = 'S') then
          LBASE = LBASE + DESPESAS;
      end

      if (TIPONOTA = 'E') then
      begin
        if (PROD_CST_IPI_E = '') then
          CSTIPI = '49';
        else
          CSTIPI = PROD_CST_IPI_E;
        if ((CSTIPI = '01') or (CSTIPI = '02')) then
        begin
          IPI     = 0;
          IPIBASE = 0;
          IPIPERC = 0;
        end
        
        if (NF_CST_PIS <> '') then
        begin
          BASE        = NF_PIS_BASE;
          CSTPIS      = NF_CST_PIS;
          PIS         = NF_PIS_PERC;
          VALORPIS    = NF_PIS_VALOR;
          CSTCOFINS   = NF_CST_COFINS;
          COFINS      = NF_COFINS_PERC;
          VALORCOFINS = NF_COFINS_VALOR;
          ORIGEMDADOS = 'NF';
        end else
        if (CFOP_CSTPISENTRADA <> '') then
        begin
          BASE        = LBASE;
          CSTPIS      = CFOP_CSTPISENTRADA;
          PIS         = CFOP_PISENTRADA;
          VALORPIS    = (BASE * CFOP_PISENTRADA) / 100;
          CSTCOFINS   = CFOP_CSTCOFINSENTRADA;
          COFINS      = CFOP_COFINSENTRADA;
          VALORCOFINS = (BASE * CFOP_COFINSENTRADA) / 100;
          ORIGEMDADOS = 'CFOP';
        end else
        if (PROD_CST_PIS_E <> '') then
        begin
          BASE        = LBASE;
          CSTPIS      = PROD_CST_PIS_E;
          PIS         = PROD_PIS_E;
          VALORPIS    = (BASE * PROD_PIS_E) / 100;
          CSTCOFINS   = PROD_CST_COFINS_E;
          COFINS      = PROD_COFINS_E;
          VALORCOFINS = (BASE * PROD_COFINS_E) / 100;
          ORIGEMDADOS = 'PRODUTO';
        end

        if (CFOP_CSTPISENTRADA <> '') then
        begin
          PIS         = CFOP_PISENTRADA;
          COFINS      = CFOP_COFINSENTRADA;
          CSTPIS      = CFOP_CSTPISENTRADA;
          CSTCOFINS   = CFOP_CSTCOFINSENTRADA;
          if (PIS > 0) then
          begin
            BASE        = LBASE;
            VALORPIS    = (BASE * CFOP_PISENTRADA) / 100;
            VALORCOFINS = (BASE * CFOP_COFINSENTRADA) / 100;
          end else
          begin
            BASE        = 0;
            VALORPIS    = 0;
            VALORCOFINS = 0;
          end
          ORIGEMDADOS = 'CFOP';
        end

        if ((CSTPIS <> '70') and (CSTPIS <> '71') and (CSTPIS <> '72') and (CSTPIS <> '73') and
            (CSTPIS <> '74')) then
        begin
          BASE        = cast(BASE as numeric(18,2));
          PIS         = cast(PIS as numeric(18,2));
          VALORPIS    = cast(VALORPIS as numeric(18,2));
          COFINS      = cast(COFINS as numeric(18,2));
          VALORCOFINS = cast(VALORCOFINS as numeric(18,2));
          if (CSTPIS = '75') then
          begin
            VALORPISST    = VALORPIS;
            VALORCOFINSST = VALORCOFINS;
          end
        end else
        begin
          BASE        = 0;
          PIS         = 0;
          VALORPIS    = 0;
          COFINS      = 0;
          VALORCOFINS = 0;
        end
      end

      if ((IPIPERC > 0) and (IPIBASE <= 0)) then
        IPIBASE = VALORBRUTO;
  
      if ((IPIPERC <= 0) and (IPIBASE > 0)) then
      begin
        IPIBASE = 0;
        IPIPERC = 0;
        IPI     = 0;
      end

      if (PARAM_ENVIARIPI = 'N') then
      begin
        IPIBASE = 0;
        IPIPERC = 0;
        IPI     = 0;
      end
  
      if  (PARAM_ENVIARST = 'N') then
      begin
        ICMSST     = 0;
        ICMSSTBASE = 0;
        ICMSSTPERC = 0;
      end

      PRODVLR     = cast(PRODVLR as numeric(18,2));
      VALORTOTAL  = cast(VALORTOTAL as numeric(18,2));
      DESCONTO    = cast(DESCONTO as numeric(18,2));
      FRETE       = cast(FRETE as numeric(18,2));
      DESPESAS    = cast(DESPESAS as numeric(18,2));
      ICMSBASE    = cast(ICMSBASE as numeric(18,2));
      ICMSPERC    = cast(ICMSPERC as numeric(18,2));
      ICMS        = cast(ICMS as numeric(18,2));
      ICMSSTBASE  = cast(ICMSSTBASE as numeric(18,2));
      ICMSSTPERC  = cast(ICMSSTPERC as numeric(18,2));
      ICMSST      = cast(ICMSST as numeric(18,2));
      IPIBASE     = cast(IPIBASE as numeric(18,2));
      IPIPERC     = cast(IPIPERC as numeric(18,2));
      IPI         = cast(IPI as numeric(18,2));
      ISENTAS     = (VALORBRUTO - ICMSBASE);

      if (ISENTAS < 0) then
        ISENTAS = 0;

      if (PARAM_SIMPLESPB = 'S') then
      begin
        ICMSBASE    = 0;
        ICMSPERC    = 0;
        ICMS        = 0;
        ICMSSTBASE  = 0;
        ICMSSTPERC  = 0;
        ICMSST      = 0;
        ISENTAS     = 0;
      end

      suspend;
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APC300CE(
    CODIGO INTEGER,
    SERIE VARCHAR(3),
    CODEMPRESA INTEGER)
RETURNS (
    CODPRODFILHO INTEGER,
    PRODVLR DOUBLE PRECISION,
    QTD DOUBLE PRECISION,
    UNID VARCHAR(5),
    DESCONTO DOUBLE PRECISION,
    VALOR DOUBLE PRECISION,
    CST VARCHAR(3),
    CFOP VARCHAR(4),
    NCM VARCHAR(10),
    BASEICMS DOUBLE PRECISION,
    ICMSPERC DOUBLE PRECISION,
    ICMSVALOR DOUBLE PRECISION,
    BASEICMSST DOUBLE PRECISION,
    ICMSSTPERC DOUBLE PRECISION,
    ICMSSTVALOR DOUBLE PRECISION,
    BASEIPI DOUBLE PRECISION,
    IPIPERC DOUBLE PRECISION,
    IPIVALOR DOUBLE PRECISION)
AS
declare variable CODARQUIVO integer;
declare variable PARAM_ESP varchar(1);
declare variable CODAPFISCAL_CFOP integer;
declare variable CODCFOP integer;
declare variable APFISCAL_ICMS varchar(3);
declare variable APFISCAL_ST varchar(3);
declare variable APFISCAL_IPI varchar(3);
declare variable PARAM_RECLASSCST varchar(1);
declare variable PARAM_TIPOEMPRESA varchar(1);
declare variable REDUCAO double precision;
declare variable LCST varchar(4);
begin
  select
    APFISCAL.CODIGO,
    APFISCAL.PARAM_ESP
  from
    APFISCAL
  where
    APFISCAL.ARQ = '0' and
    APFISCAL.CODEMPRESA =:CODEMPRESA
  into
    :CODARQUIVO,
    :PARAM_ESP;

  PARAM_ESP   = coalesce(PARAM_ESP,'N');

  for select
    I.CODPRODFILHO,
    I.PRECOVEND,
    I.QTDE,
    coalesce(I.DESC_VALOR, 0),
    (I.QTDE * I.PRECOVEND) - coalesce(I.DESC_VALOR, 0),
    coalesce(I.PRDF_CST_ORIGEM_MERCADORIA,'0') || coalesce(I.PRDF_CST_TRIBICMS, ''),
    null CODCFOP,
    iif(I.CFOP <= 0, 5102, I.CFOP),
    I.BASEICMS,
    cast(I.ALIQUOTAICMS as double precision),
    I.VALORICMS,
    I.BASEST,
    I.ALIQUOTAST,
    I.VALORST,
    0.00 as IPIBASE,
    0.00 as IPIPERC,
    0.00 as IPIVALOR,
    coalesce(I.REDUCAOICMS, 0)
  from
    CUPOMITEM I
  where
    I.CODCUPOM        = :CODIGO and
    I.STATUSCUPOMITEM = 0
  order by
    I.CODCUPOMITEM
  into
    CODPRODFILHO,
    PRODVLR,
    QTD,
    DESCONTO,
    VALOR,
    LCST,
    CODCFOP,
    CFOP,
    BASEICMS,
    ICMSPERC,
    ICMSVALOR,
    BASEICMSST,
    ICMSSTPERC,
    ICMSSTVALOR,
    BASEIPI,
    IPIPERC,
    IPIVALOR,
    REDUCAO
  do
  begin
    select
      A.PROD_NCM,
      A.PROD_UND
    from
      APPROD(:CODPRODFILHO,0) A
    into
      NCM,
      UNID;

    select first 1
      CFOP.CODCFOP
    from
      CFOP
    where
      CFOP.CFOP =:CFOP
    into
      CODCFOP;

    LCST      = trim(LCST);
    if (CHAR_LENGTH(LCST) > 3) then
    begin
      LCST      = substring(LCST from 2 for 3);
      LCST      = trim(LCST);
    end
    CST         = LCST;
  
    if (PARAM_ESP = 'S') then
    begin
      select
        APFISCAL_CFOP.CODIGO,
        APFISCAL_CFOP.APFISCAL_ICMS,
        APFISCAL_CFOP.APFISCAL_IPI,
        APFISCAL_CFOP.APFISCAL_ST
      from
        APFISCAL_CFOP
      where
        APFISCAL_CFOP.CODIGOAP =:CODARQUIVO and
        APFISCAL_CFOP.CODCFOP =:CODCFOP
      into
        :CODAPFISCAL_CFOP,
        :APFISCAL_ICMS,
        :APFISCAL_IPI,
        :APFISCAL_ST;
  
      APFISCAL_ICMS = coalesce(APFISCAL_ICMS,'NÃO');
      APFISCAL_IPI  = coalesce(APFISCAL_IPI,'NÃO');
      APFISCAL_ST   = coalesce(APFISCAL_ST,'NÃO');
  
  
      if (CODAPFISCAL_CFOP >= 1) then
      begin
        if (APFISCAL_ICMS = 'SIM')then
        begin
          BASEICMS       = BASEICMS;
          ICMSVALOR      = ICMSVALOR;
        end
        else
        begin
          BASEICMS       = 0;
          ICMSVALOR      = 0;
          ICMSPERC       = 0;
        end
  
        if (APFISCAL_IPI = 'SIM')then
        begin
          BASEIPI        = BASEIPI;
          IPIVALOR       = IPIVALOR;
        end
        else
        begin
          BASEIPI        = 0;
          IPIVALOR       = 0;
          IPIPERC        = 0;
        end
  
        if (APFISCAL_ST = 'SIM')then
        begin
          BASEICMSST     = BASEICMSST;
          ICMSSTVALOR    = ICMSSTVALOR;
        end
        else
        begin
          BASEICMSST      = 0;
          ICMSSTVALOR     = 0;
          ICMSSTPERC      = 0;
        end
      end
    end
    
    BASEICMS    = cast(coalesce(BASEICMS,0) as numeric(18,3));
    ICMSPERC    = cast(coalesce(ICMSPERC,0) as numeric(18,3));
    ICMSVALOR   = cast(coalesce(ICMSVALOR,0) as numeric(18,3));
    BASEICMSST  = cast(coalesce(BASEICMSST,0) as numeric(18,3));
    ICMSSTPERC  = cast(coalesce(ICMSSTPERC,0) as numeric(18,3));
    ICMSSTVALOR = cast(coalesce(ICMSSTVALOR,0) as numeric(18,3));
    BASEIPI     = cast(coalesce(BASEIPI,0) as numeric(18,3));
    IPIPERC     = cast(coalesce(IPIPERC,0) as numeric(18,3));
    IPIVALOR    = cast(coalesce(IPIVALOR,0) as numeric(18,3));
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APC460(
    CODEMPRESA INTEGER,
    CODIGO INTEGER)
RETURNS (
    CODCUPOM INTEGER,
    SITUACAO VARCHAR(2),
    COO VARCHAR(10),
    EMISSAO DATE,
    VALOR DOUBLE PRECISION,
    VALORPIS DOUBLE PRECISION,
    VALORCOFINS DOUBLE PRECISION,
    CPFCNPJ VARCHAR(20),
    NOME VARCHAR(60))
AS
declare variable STATUSCUPOM smallint;
begin
  for select
    C.CODCUPOM,
    coalesce(C.STATUSCUPOM, 1) STATUSCUPOM,
    C.COO,
    C.EMISSAO,
    C.VALORPAGO,
    C.CPFCGC,
    C.NOME
  from
    APCUPOM C
  where
    C.CODCUPOMZ   =:CODIGO --and
   -- C.STATUSCUPOM = 0
  order by
    1
  into
    CODCUPOM,
    STATUSCUPOM,
    COO,
    EMISSAO,
    VALOR,
    CPFCNPJ,
    NOME
  do
  begin
    VALORPIS    = 0;
    VALORCOFINS = 0;
    SITUACAO    = '00';
  
    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:CPFCNPJ)
    into
      CPFCNPJ;

    select
      R_TRIM
    from
      FU_TRIM(:CPFCNPJ)
    into
      CPFCNPJ;

    select
      R_TRIM
    from
      FU_TRIM(:NOME)
    into
      NOME;
  
    if (CHAR_LENGTH(CPFCNPJ) < 11) then
    begin
      CPFCNPJ = '';
      NOME    = '';
    end
  
    if ((CPFCNPJ = '00000000000') or (CPFCNPJ = '00000000000000')) then
    begin
      CPFCNPJ = '';
      NOME    = '';
    end

    if (STATUSCUPOM = 1) then
    begin
      SITUACAO    = '02';
      VALOR       = 0;
      VALORPIS    = 0;
      VALORCOFINS = 0;
      CPFCNPJ     = '';
      NOME        = '';
    end
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APD100(
    CODEMPRESA INTEGER,
    DTINI DATE,
    DTFIM DATE,
    TIPO VARCHAR(1))
RETURNS (
    CODCTRC INTEGER,
    OPERACAO INTEGER,
    EMITENTE INTEGER,
    CODPART INTEGER,
    MODELO VARCHAR(2),
    SITUACAO VARCHAR(2),
    SERIE VARCHAR(1),
    DOCUMENTO VARCHAR(10),
    DTEMISSAO DATE,
    DTENTRADA DATE,
    CODCFOP INTEGER,
    CFOP VARCHAR(4),
    TOTALNOTA DOUBLE PRECISION,
    TIPOFRETE VARCHAR(1),
    FRETEVALOR DOUBLE PRECISION,
    ICMSBASE DOUBLE PRECISION,
    ICMSPERC DOUBLE PRECISION,
    ICMS DOUBLE PRECISION,
    CST VARCHAR(4),
    CHAVE VARCHAR(60),
    CODREMETENTE INTEGER,
    CODIBGER VARCHAR(10),
    CODDESTINATARIO INTEGER,
    CODIBGED VARCHAR(10),
    CODTRANSPORT INTEGER,
    PLACA VARCHAR(10),
    UF VARCHAR(2),
    CSTPC VARCHAR(2),
    BASEPC DOUBLE PRECISION,
    PIS DOUBLE PRECISION,
    VALORPIS DOUBLE PRECISION,
    COFINS DOUBLE PRECISION,
    VALORCOFINS DOUBLE PRECISION)
AS
declare variable LDTINI timestamp;
declare variable LDTFIM timestamp;
declare variable LTIPOFRETE char(1);
declare variable LCODPESSOA integer;
begin
  LDTINI = cast(DTINI||' 00:00:00' as timestamp);
  LDTFIM = cast(DTFIM||' 23:59:59' as timestamp);
  CODEMPRESA = coalesce(CODEMPRESA, 1);

  if (TIPO = 'S') then
  begin
  for select
    S.COD_CTRC,
    coalesce(S.CODSERIE, 0) SERIE,
    1 OPERACAO,
    0 EMITENTE,
    S.CODDESTINATARIO CODPART,
    '08' MODELO,
    S.NRDOCUMENTO,
    S.DT_EMISSAO,
    S.DT_ENTRADA,
    S.CFOP_CFOP,
    S.VLPARCELA,
    S.FRETEVALOR,
    S.TIPOFRETE,
    S.BASEDECALCULO,
    S.ICMSPERC,
    S.VALOR_ICMS,
    coalesce(S.CHAVECTE,''),
    S.CODREMETENTE,
    S.CODDESTINATARIO,
    S.CODTRANSPORT,
    S.CODCFOP
  from
    CTRC_NFVENDA S
  where
    S.DT_EMISSAO       between :LDTINI and :LDTFIM and
    coalesce(S.CODEMPRESA,1) = :CODEMPRESA
  into
    CODCTRC,
    SERIE,
    OPERACAO,
    EMITENTE,
    CODPART,
    MODELO,
    DOCUMENTO,
    DTEMISSAO,
    DTENTRADA,
    CFOP,
    TOTALNOTA,
    FRETEVALOR,
    LTIPOFRETE,
    ICMSBASE,
    ICMSPERC,
    ICMS,
    CHAVE,
    CODREMETENTE,
    CODDESTINATARIO,
    CODTRANSPORT,
    CODCFOP
  do
  begin
    SITUACAO = '00';

    select
      R_ONLYDIGIT
    from
      FU_ONLYDIGIT(:CHAVE)
    into
      CHAVE;

    if (CHAVE <> '') then
      MODELO = '57';

    FRETEVALOR = coalesce(FRETEVALOR, 0);
    if (LTIPOFRETE = 'F') then
    begin
      if (DTINI >= '01.07.2012') then
        TIPOFRETE = '1';
      else
        TIPOFRETE = '2';
    end else
    begin
      if (DTINI >= '01.07.2012') then
        TIPOFRETE = '0';
      else
        TIPOFRETE = '1';
    end

    if (FRETEVALOR <= 0) then
      TIPOFRETE = '9';

    if (OPERACAO = 1) then
      DTENTRADA = DTEMISSAO;

    if (ICMSPERC > 0) then
      CST = '000';
    else
      CST = '040';

    CODIBGER = null;
    CODIBGED = null;
    PLACA    = null;
    UF       = null;
    if (OPERACAO = 1) then
    begin
      select
        C.CODIBGE
      from
        APIBGE(:CODREMETENTE) C
      into
        CODIBGER;
  
      select
        C.CODIBGE
      from
        APIBGE(:CODDESTINATARIO) C
      into
        CODIBGED;
  
      select
        T.PLACA,
        T.CODPESSOA
      from
        TRANSPORT T
      where
        T.CODTRANSPORT = :CODTRANSPORT
      into
        PLACA,
        LCODPESSOA;
  
      select
        F.STRRESULT
      from
        FU_GETTIRAMASCARA(:PLACA) F
      into
        PLACA;

      select
        F.R_TRIM
      from
        FU_TRIM(:PLACA) F
      into
        PLACA;
  
      if (CHAR_LENGTH(PLACA) < 7) then
        PLACA = '';
  
      select
        P.UF_1
      from
        PESSOA P
      where
        P.CODPESSOA =:LCODPESSOA
      into
        UF;
    end

      if (CODCFOP > 0) then
      begin
        BASEPC      = 0;
        PIS         = 0;
        VALORPIS    = 0;
        COFINS      = 0;
        VALORCOFINS = 0;
  
        if (substring(CFOP from 1 for 1) in ('5','6')) then
        begin
          CSTPC       = '07';
          select
            coalesce(CFOP.CSTPIS, '07'),
            coalesce(CFOP.PERC_PIS, 0),
            coalesce(CFOP.PERC_COFINS, 0)
          from
            CFOP
          where
            CFOP.CODCFOP = :CODCFOP
          into
            CSTPC,
            PIS,
            COFINS;
  
          if ((CSTPC <> '06') and (CSTPC <> '07') and (CSTPC <> '08') and (CSTPC <> '09')) then
          begin
            BASEPC      = TOTALNOTA;
            VALORPIS    = (BASEPC * PIS) / 100;
            VALORCOFINS = (BASEPC * COFINS) / 100;
            VALORPIS    = cast(VALORPIS as numeric(18,2));
            VALORCOFINS = cast(VALORCOFINS as numeric(18,2));
          end
        end
      end

      PIS         = cast(coalesce(PIS,0) as numeric(18,2));
      COFINS      = cast(coalesce(COFINS,0) as numeric(18,2));
      VALORPIS    = coalesce(VALORPIS,0);
      VALORCOFINS = coalesce(VALORCOFINS,0);
      TOTALNOTA   = coalesce(TOTALNOTA,0);
      FRETEVALOR  = coalesce(FRETEVALOR,0);
      ICMSBASE    = coalesce(ICMSBASE,0);
      ICMSPERC    = coalesce(ICMSPERC,0);
      ICMS        = coalesce(ICMS,0);
      BASEPC      = coalesce(BASEPC,0);
      suspend;
    end
  end
  if (TIPO = 'E') then
  begin
  for select
    E.COD_CTRC,
    coalesce(E.CODSERIE, 0) SERIE,
    0 OPERACAO,
    1 EMITENTE,
    T.CODPESSOA CODPART,
    '08' MODELO,
    E.NRDOCUMENTO,
    E.DT_EMISSAO,
    E.DT_ENTRADA,
    E.CFOP_CFOP,
    E.VLPARCELA,
    E.FRETEVALOR,
    E.TIPOFRETE,
    E.BASEDECALCULO,
    E.ICMSPERC,
    E.VALOR_ICMS,
    coalesce(E.CHAVECTE,''),
    E.CODREMETENTE,
    E.CODDESTINATARIO,
    null CODTRANSPORT,
    E.CODCFOP
  from
    CTRC E
    join TRANSPORT T on
      T.CODTRANSPORT = E.CODTRANSPORT
  where
    E.DT_ENTRADA        between :LDTINI and :LDTFIM and
    coalesce(E.CODEMPRESA, 1) = :CODEMPRESA
  into
    CODCTRC,
    SERIE,
    OPERACAO,
    EMITENTE,
    CODPART,
    MODELO,
    DOCUMENTO,
    DTEMISSAO,
    DTENTRADA,
    CFOP,
    TOTALNOTA,
    FRETEVALOR,
    LTIPOFRETE,
    ICMSBASE,
    ICMSPERC,
    ICMS,
    CHAVE,
    CODREMETENTE,
    CODDESTINATARIO,
    CODTRANSPORT,
    CODCFOP
  do
  begin
    SITUACAO = '00';
    select
      R_ONLYDIGIT
    from
      FU_ONLYDIGIT(:CHAVE)
    into
      CHAVE;

    if (CHAVE <> '') then
      MODELO = '57';

    FRETEVALOR = coalesce(FRETEVALOR, 0);
    if (LTIPOFRETE = 'F') then
    begin
      if (DTINI >= '01.07.2012') then
        TIPOFRETE = '1';
      else
        TIPOFRETE = '2';
    end else
    begin
      if (DTINI >= '01.07.2012') then
        TIPOFRETE = '0';
      else
        TIPOFRETE = '1';
    end

    if (FRETEVALOR <= 0) then
      TIPOFRETE = '9';

    if (OPERACAO = 1) then
      DTENTRADA = DTEMISSAO;

    if (ICMSPERC > 0) then
      CST = '000';
    else
      CST = '040';

    CODIBGER = null;
    CODIBGED = null;
    PLACA    = null;
    UF       = null;

    select
      C.CODIBGE
    from
      APIBGE(:CODREMETENTE) C
    into
      CODIBGER;

    select
      C.CODIBGE
    from
      APIBGE(:CODDESTINATARIO) C
    into
      CODIBGED;

      if (CODCFOP > 0) then
      begin
        BASEPC      = 0;
        PIS         = 0;
        VALORPIS    = 0;
        COFINS      = 0;
        VALORCOFINS = 0;
        if (substring(CFOP from 1 for 1) in ('1','2')) then
        begin
          CSTPC       = '70';
          select
            coalesce(CFOP.CSTPISENTRADA, '70'),
            coalesce(CFOP.PERCPISCOMPRA, 0),
            coalesce(CFOP.PERCCONFINSCOMPRA, 0)
          from
            CFOP
          where
            CFOP.CODCFOP = :CODCFOP
          into
            CSTPC,
            PIS,
            COFINS;
  
          if ((CSTPC <> '70') and (CSTPC <> '71') and (CSTPC <> '72') and (CSTPC <> '73') and (CST <> '74') and (CST <> '98') and (CST <> '99')) then
          begin
            BASEPC      = TOTALNOTA;
            VALORPIS    = (BASEPC * PIS) / 100;
            VALORCOFINS = (BASEPC * COFINS) / 100;
            VALORPIS    = cast(VALORPIS as numeric(18,2));
            VALORCOFINS = cast(VALORCOFINS as numeric(18,2));
          end
        end
      end

      PIS         = cast(coalesce(PIS,0) as numeric(18,2));
      COFINS      = cast(coalesce(COFINS,0) as numeric(18,2));
      VALORPIS    = coalesce(VALORPIS,0);
      VALORCOFINS = coalesce(VALORCOFINS,0);
      TOTALNOTA   = coalesce(TOTALNOTA,0);
      FRETEVALOR  = coalesce(FRETEVALOR,0);
      ICMSBASE    = coalesce(ICMSBASE,0);
      ICMSPERC    = coalesce(ICMSPERC,0);
      ICMS        = coalesce(ICMS,0);
      BASEPC      = coalesce(BASEPC,0);
      suspend;
    end
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APPART(
    PART_COD INTEGER)
RETURNS (
    PART_NOME VARCHAR(60),
    PART_CODPAIS VARCHAR(5),
    PART_CNPJ VARCHAR(14),
    PART_CPF VARCHAR(11),
    PART_IE VARCHAR(30),
    PART_IESUBS VARCHAR(15),
    PART_IM VARCHAR(30),
    PART_SUFRAMA VARCHAR(1),
    PART_END VARCHAR(60),
    PART_COMP VARCHAR(60),
    PART_NUM VARCHAR(30),
    PART_BAIRRO VARCHAR(60),
    PART_CIDADE VARCHAR(60),
    PART_UF VARCHAR(2),
    PART_CODMUN VARCHAR(7))
AS
declare variable PESSOA smallint;
declare variable LCPFCGC varchar(20);
declare variable LPART_IE varchar(30);
begin
  PESSOA       = 0;
  PART_NOME    = null;
  PART_IE      = null;
  PART_IM      = null;
  PART_UF      = null;
  PART_IESUBS  = null;
  PART_SUFRAMA = null;
  LCPFCGC      = null;
  PART_END     = null;

  select
    P.NOME,
    P.IE,
    P.IM,
    P.PESSOA,
    P.CPFCGC,
    P.CODPAIS,
    P.LOGRADOURO_1,
    P.COMPLEMENTO_1,
    P.NUMERO_1,
    P.CODIBGE,
    P.BAIRRO_1,
    P.CIDADE_1,
    P.UF_1
  from
    PESSOA P
  where
    P.CODPESSOA = :PART_COD
  into
    PART_NOME,
    LPART_IE,
    PART_IM,
    PESSOA,
    LCPFCGC,
    PART_CODPAIS,
    PART_END,
    PART_COMP,
    PART_NUM,
    PART_CODMUN,
    PART_BAIRRO,
    PART_CIDADE,
    PART_UF;

  select STRRESULT from FU_GETTIRAMASCARA(:LPART_IE) into :LPART_IE;
  select R_TRIM    from FU_TRIM(:LPART_IE)           into :LPART_IE;
  LPART_IE = substring(LPART_IE from 1 for 20);

  select STRRESULT from FU_GETTIRAMASCARA(:PART_IM) into :PART_IM;
  select R_TRIM    from FU_TRIM(:PART_IM)           into :PART_IM;
  PART_IM = substring(PART_IM from 1 for 10);

  select STRRESULT from FU_GETTIRAMASCARA(:PART_CODPAIS) into :PART_CODPAIS;
  select R_TRIM    from FU_TRIM(:PART_CODPAIS)           into :PART_CODPAIS;
  PART_CODPAIS = substring(PART_CODPAIS from 1 for 5);

  if (coalesce(PART_CODPAIS,'') = '') then
    PART_CODPAIS = '01058';

  if (char_length(PART_CODPAIS)=4) then
    PART_CODPAIS = 0 || PART_CODPAIS;

  select STRRESULT from FU_GETTIRAMASCARA(:LCPFCGC) into :LCPFCGC;
  select R_TRIM    from FU_TRIM(:LCPFCGC)           into :LCPFCGC;
  
  if (PESSOA = 2) then
  begin
    PART_CNPJ = LCPFCGC;
    PART_CPF = '';
    PART_IE  = LPART_IE;
  end else
  begin
    PART_CNPJ = '';
    PART_CPF = LCPFCGC;
    PART_IE  = '';
  end
  
  if (PART_IE = 'ISENTO') then
    PART_IE = '';

  if (substring(PART_IE from 1 for 2) = 'NC') then
    PART_IE = substring(PART_IE from 3 for 20);


  if (PART_CODMUN is null) then
  begin
    select
      MR.CODIBGE,
      MR.BAIRRO,
      MR.CIDADE,
      MR.UF
    from
      APIBGE(:PART_COD) MR
    into
      PART_CODMUN,
      PART_BAIRRO,
      PART_CIDADE,
      PART_UF;
  
    if (PART_UF = 'EX') then
    begin
      PART_CNPJ   = '';
      PART_IE     = '';
      PART_IESUBS = '';
      PART_IM     = '';
      PART_CODMUN = '9999999';
    end
  end
  suspend;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APRETORNAPESSOA(
    EBAIRRO_1 VARCHAR(45),
    ECEP_1 VARCHAR(9),
    ECIDADE_1 VARCHAR(45),
    ECODIBGE INTEGER,
    ECPFCGC VARCHAR(18),
    EFONES VARCHAR(120),
    EIE VARCHAR(30),
    ELOGRADOURO_1 VARCHAR(60),
    ENOME VARCHAR(60),
    ENUMERO_1 VARCHAR(30),
    ETIPOPESSOA VARCHAR(14),
    EUF_1 CHAR(2),
    EUS_CADAST VARCHAR(45))
RETURNS (
    CODPESSOA INTEGER)
AS
declare variable LPESSOA smallint;
begin
  select
    P.CODPESSOA
  from
    PESSOA P
  where
    P.CPFCGC = :ECPFCGC
  into
    CODPESSOA;

  if (CODPESSOA is null) then
  begin
    if (CHAR_LENGTH(ECPFCGC) = 14) then
      LPESSOA = 1;
    else
      LPESSOA = 2;

    insert into PESSOA (
      BAIRRO_1, 
      CEP_1, 
      CIDADE_1, 
      CODIBGE, 
      CPFCGC, 
      FONES, 
      IE, 
      LOGRADOURO_1, 
      NOME, 
      NUMERO_1, 
      PESSOA, 
      TIPOPESSOA, 
      UF_1, 
      US_CADAST, 
      US_MODIFI)
    values (
      :EBAIRRO_1, 
      :ECEP_1, 
      :ECIDADE_1, 
      :ECODIBGE, 
      :ECPFCGC, 
      :EFONES, 
      :EIE, 
      :ELOGRADOURO_1, 
      :ENOME, 
      :ENUMERO_1, 
      :LPESSOA,
      :ETIPOPESSOA,
      :EUF_1, 
      :EUS_CADAST, 
      current_timestamp)
    returning
      CODPESSOA
    into
      CODPESSOA;
  end 

  suspend;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE APRETORNATRANSPORT(
    ECIDADE VARCHAR(45),
    ECGC VARCHAR(18),
    EIE VARCHAR(30),
    ELOGRADOURO VARCHAR(60),
    ENOME VARCHAR(60),
    EUF CHAR(2),
    EUS_CADAST VARCHAR(45))
RETURNS (
    CODTRANSPORT INTEGER)
AS
declare variable LPESSOA smallint;
begin
  select
    P.CODTRANSPORT
  from
    TRANSPORT P
  where
    P.CGC = :ECGC
  into
    CODTRANSPORT;

  if (CODTRANSPORT is null) then
  begin
    if (CHAR_LENGTH(ECGC) = 14) then
      LPESSOA = 1;
    else
      LPESSOA = 2;

    insert into TRANSPORT (
      CIDADE,
      CGC,
      IE, 
      LOGRADOURO,
      NOME, 
      PESSOA, 
      UF,
      US_CADAST, 
      US_MODIFI)
    values (
      :ECIDADE, 
      :ECGC, 
      :EIE, 
      :ELOGRADOURO, 
      :ENOME, 
      :LPESSOA,
      :EUF, 
      :EUS_CADAST, 
      current_timestamp)
    returning
      CODTRANSPORT
    into
      CODTRANSPORT;
  end 

  suspend;
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE AR02_DOCEBALAS(
    EDATAINI DATE,
    EDATAFIM DATE)
RETURNS (
    CODNFVENDA INTEGER,
    SERIE VARCHAR(3),
    CODPESSOA INTEGER,
    NOME VARCHAR(60),
    TOTALNOTA DOUBLE PRECISION)
AS
declare variable LTIPONOTA char(1);
begin
  for select distinct
    NI.CODNFVENDA,
    NI.SERIE,
    NI.NFV_TIPO
  from
    NFVENDA N
    join PESSOA PE on
      N.CODPESSOA = PE.CODPESSOA
    join NFVENDAITEM NI on
      N.CODNFVENDA = NI.CODNFVENDA
    join PRODFILHO PF on
      NI.CODPRODFILHO = PF.CODPRODFILHO
  where
    cast(N.DT_EMISSAO as date)  between :EDATAINI and :EDATAFIM and
    coalesce(PF.LEIDOSALIMENTOS, 'N') = 'S'  and
    N.STATUS                          <> 'C' and
    CHAR_LENGTH(PE.CPFCGC)                 <= 14
  order by
    1
  into
    CODNFVENDA,
    SERIE,
    LTIPONOTA
  do
  begin
    select 
      PE.CODPESSOA,
      PE.NOME,
      N.TOTALNOTA
    from
      NFVENDA N
      join PESSOA PE on
        N.CODPESSOA = PE.CODPESSOA
    where 
      N.CODNFVENDA = :CODNFVENDA and
      N.SERIE      = :SERIE
   into
     CODPESSOA,
     NOME,
     TOTALNOTA;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE ATUALIZASERVICOITEM(
    CODNFSERVICOITEM INTEGER)
AS
declare variable LCODSERVICO varchar(9);
declare variable LCODPRODFILHO varchar(9);
begin
  for select
    NSI.CODSERVICO
  from
    NFSERVICOITEM NSI
  where
    NSI.CODNFSERVICOITEM =:CODNFSERVICOITEM
  into
    LCODSERVICO
  do
  begin
    if (CHAR_LENGTH(:LCODSERVICO) = 1) then
    begin
      LCODSERVICO = '00' || LCODSERVICO;
    end
    else
    begin
     if (CHAR_LENGTH(:LCODSERVICO) = 2) then
     begin
       LCODSERVICO = '0' || LCODSERVICO;
     end
     else
     begin
      if (CHAR_LENGTH(:LCODSERVICO) = 3) then
      begin
        LCODSERVICO = LCODSERVICO;
      end
     end
    end

    LCODSERVICO = substring(LCODSERVICO from 1 for 3);
    LCODPRODFILHO = '999999' || LCODSERVICO;

    update
      NFSERVICOITEM NSI
    set
      NSI.CODPRODFILHO = cast(:LCODPRODFILHO as integer)
    where
      NSI.CODNFSERVICOITEM = :CODNFSERVICOITEM;

    --SUSPEND;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE CLIENTES_GCI
RETURNS (
    CODPESSOA CHAR(1),
    NOMEFANTAZIA VARCHAR(60),
    NOME VARCHAR(60),
    LOGRADOURO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 CHAR(2),
    CEP_1 VARCHAR(9),
    FONES VARCHAR(120),
    FONE2 VARCHAR(60),
    TELEX INTEGER,
    CNPJ VARCHAR(18),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    FAX VARCHAR(14),
    CONTA_CONTABIL INTEGER,
    CGC_PAGAMENTO VARCHAR(10),
    IE_PAGAMENTO VARCHAR(10),
    ENDERECO_PAGAMENTO VARCHAR(10),
    BAIRRO_PAGAMENTO VARCHAR(10),
    CIDADE_PAGAMENTO VARCHAR(10),
    UF_PAGAMENTO VARCHAR(10),
    CEP_PAGAMENTO VARCHAR(10),
    FONE_PAGAMENTO VARCHAR(10),
    DATA_CADASTRO DATE,
    CPFCGC1 VARCHAR(18),
    SIMPLES VARCHAR(10),
    NUMERO_ENDERECO INTEGER,
    COMPLEMENTO_1 VARCHAR(60),
    PAIS VARCHAR(10),
    CPF VARCHAR(18))
AS
begin
  for select
    ' ' CODPESSOA,
    P.NOME NOMEFANTAZIA,
    P.NOME,
    P.LOGRADOURO_1,
    P.BAIRRO_1,
    P.CIDADE_1,
    P.UF_1,
    P.CEP_1,
    P.FONES,
    P.FONE2,
    0 TELEX,
    P.CPFCGC,
    P.IE,
    P.PESSOA_CONTATO,
    P.FAX,
    0 CONTA_CONTABIL,
    '' CGC_PAGAMENTO,
    '' IE_PAGAMENTO,
    '' ENDERECO_PAGAMENTO,
    '' BAIRRO_PAGAMENTO,
    '' CIDADE_PAGAMENTO,
    '' UF_PAGAMENTO,
    '' CEP_PAGAMENTO,
    '' FONE_PAGAMENTO,
    cast(P.DT_CADAST as date) DATA_CADASTRO,
    P.CPFCGC,
    '' SIMPLES,
    0 NUMERO_ENDERECO,
    P.COMPLEMENTO_1,
    '' PAIS
  from
    PESSOA P
  where
    P.TIPOPESSOA = 'CLIENTE'
  into
    CODPESSOA,
    NOMEFANTAZIA,
    NOME,
    LOGRADOURO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    FONE2,
    TELEX,
    CNPJ,
    IE,
    PESSOA_CONTATO,
    FAX,
    CONTA_CONTABIL,
    CGC_PAGAMENTO,
    IE_PAGAMENTO,
    ENDERECO_PAGAMENTO,
    BAIRRO_PAGAMENTO,
    CIDADE_PAGAMENTO,
    UF_PAGAMENTO,
    CEP_PAGAMENTO,
    FONE_PAGAMENTO,
    DATA_CADASTRO,
    CPFCGC1,
    SIMPLES,
    NUMERO_ENDERECO,
    COMPLEMENTO_1,
    PAIS
  do
  begin
    if (CHAR_LENGTH(CNPJ) < 15) then
    begin
      CPF = CNPJ;
      CNPJ = '';
    end
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_ACOMPANHAMENTO_CLIENTE(
    ECODVENDEDOR INTEGER,
    EDATAINI DATE,
    EDATAFIM DATE,
    EATIVO INTEGER,
    ECODPESSOA INTEGER,
    ECODSTATUS INTEGER,
    EBAIRRO VARCHAR(60),
    ECIDADE VARCHAR(60),
    EDATAINICADASTRO DATE,
    EDATAFIMCADASTRO DATE)
RETURNS (
    ATIVO INTEGER,
    CODPESSOA INTEGER,
    NOME VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    PESSOA INTEGER,
    CPFCGC VARCHAR(18),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(10),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    FONES VARCHAR(15),
    CODVENDEDOR INTEGER,
    CODIBGE INTEGER,
    IE VARCHAR(30),
    LIMITECRED DOUBLE PRECISION,
    EMAIL VARCHAR(100),
    TOTALCREDITO DOUBLE PRECISION,
    DT_CADAST TIMESTAMP,
    CODPESSOAMATRIZ INTEGER,
    NOMEPESSOAMATRIZ VARCHAR(60),
    OBSBLOQUEIO VARCHAR(200),
    STATUSDESC VARCHAR(60))
AS
DECLARE VARIABLE CODBAIRRO INTEGER;
DECLARE VARIABLE CODESTADO INTEGER;
DECLARE VARIABLE CODCIDADE INTEGER;
DECLARE VARIABLE LVALOR_TOTAL DOUBLE PRECISION;

DECLARE FUNCTION VALOR_TOTAL(ECODPESSOA INTEGER)
RETURNS DOUBLE PRECISION
AS
DECLARE VARIABLE LVALOR_TOTAL DOUBLE PRECISION;
BEGIN
    SELECT
    SUM(PEDVEND.VALOR_TOTAL) VALOR_TOTAL
  FROM
    PEDVEND
  WHERE
    PEDVEND.CODPESSOA = :ECODPESSOA
    AND PEDVEND.STATUSPED = 'FATURADO'
    AND PEDVEND.TIPOPED IN ('VENDA', 'CADERNO')
  INTO
    LVALOR_TOTAL;
  RETURN LVALOR_TOTAL;
END

DECLARE FUNCTION CLIENTEPOSSUIVENDA(
ECODPESSOA INTEGER,
EDTINI TIMESTAMP,
EDTFIM TIMESTAMP)
RETURNS BOOLEAN
AS
DECLARE VARIABLE LQTD INTEGER;
BEGIN
    SELECT
      COUNT(PEDVEND.CODPEDVEND)
    FROM
      PEDVEND
    WHERE
      PEDVEND.CODPESSOA = :ECODPESSOA
      AND PEDVEND.DTFATURADO BETWEEN :EDTINI AND :EDTFIM
      AND PEDVEND.STATUSPED <> 'CANCELADO'
      AND PEDVEND.TIPOPED IN ('VENDA', 'CADERNO')
    INTO
      LQTD;
    
    RETURN LQTD > 0;
END

BEGIN     
  
FOR SELECT
  PESSOA.ATIVO,
  PESSOA.CODPESSOA,
  SUBSTRING(PESSOA.NOME FROM 1 FOR 60) AS NOME,
  SUBSTRING(COALESCE(NULLIF(TRIM(PESSOA.NOMEFANTAZIA), ''), PESSOA.NOME) FROM 1 FOR 60) AS NOMEFANTAZIA,
  PESSOA.PESSOA,
  SUBSTRING(PESSOA.CPFCGC FROM 1 FOR 18) AS CPFCGC,
  SUBSTRING(PESSOA.LOGRADOURO_1 FROM 1 FOR 60) AS LOGRADOURO,
  SUBSTRING(PESSOA.NUMERO_1 FROM 1 FOR 10) AS NUMERO_1,
  SUBSTRING(PESSOA.COMPLEMENTO_1 FROM 1 FOR 60) AS COMPLEMENTO_1,
  PESSOA.CODBAIRRO1,
  SUBSTRING(PESSOA.BAIRRO_1 FROM 1 FOR 45) AS BAIRRO_1,
  SUBSTRING(PESSOA.CIDADE_1 FROM 1 FOR 45) AS CIDADE_1,
  SUBSTRING(PESSOA.UF_1 FROM 1 FOR 2) AS UF_1,
  SUBSTRING(PESSOA.CEP_1 FROM 1 FOR 9) AS CEP_1,
  SUBSTRING(PESSOA.FONES FROM 1 FOR 15) AS FONES,
  PESSOA.CODVENDEDOR,
  PESSOA.CODIBGE,
  PESSOA.IE,
  PESSOA.LIMITECRED,
  SUBSTRING(PESSOA.EMAIL FROM 1 FOR 100) AS EMAIL,
  PESSOA.DT_CADAST,
  COALESCE(PESSOA.CODPESSOAMATRIZ,0),
  COALESCE(PESSOA.OBSBLOQUEIO,'')|| COALESCE(PESSOA.OBSBLOQUEIO1, ''),
  STATUS.DESCRICAO,
  VALOR_TOTAL(PESSOA.CODPESSOA)
FROM
  PESSOA
JOIN STATUS ON
  PESSOA.CODSTATUS = STATUS.CODSTATUS
WHERE
  UPPER(TIPOPESSOA) = 'CLIENTE' AND 
  PESSOA.ATIVO = :EATIVO AND  
  ((:EDATAINI IS NULL AND :EDATAFIM IS NULL) OR (NOT CLIENTEPOSSUIVENDA(PESSOA.CODPESSOA, :EDATAINI, :EDATAFIM))) AND 
  (:ECODPESSOA IS NULL OR PESSOA.CODPESSOAMATRIZ = :ECODPESSOA) AND
  (:EBAIRRO IS NULL OR PESSOA.BAIRRO_1 = :EBAIRRO) AND
  (:ECIDADE IS NULL OR PESSOA.CIDADE_1 = :ECIDADE) AND
  ((:EDATAINICADASTRO IS NULL AND :EDATAFIMCADASTRO IS NULL) OR (PESSOA.DT_CADAST BETWEEN :EDATAINICADASTRO AND :EDATAFIMCADASTRO)) AND
  (:ECODSTATUS IS NULL OR PESSOA.CODSTATUS = :ECODSTATUS)
ORDER BY
  25 DESC
  INTO
  ATIVO,
  CODPESSOA,
  NOME,
  NOMEFANTAZIA,
  PESSOA,
  CPFCGC,
  LOGRADOURO_1,
  NUMERO_1,
  COMPLEMENTO_1,
  CODBAIRRO,
  BAIRRO_1,
  CIDADE_1,
  UF_1,
  CEP_1,
  FONES,
  CODVENDEDOR,
  CODIBGE,
  IE,
  LIMITECRED,
  EMAIL,
  DT_CADAST,
  CODPESSOAMATRIZ,
  OBSBLOQUEIO,
  STATUSDESC,
  LVALOR_TOTAL
  DO
  BEGIN
    
  CEP_1 = REPLACE(CEP_1, '-', '');
  CPFCGC = REPLACE(CPFCGC, '-', '');
  CPFCGC = REPLACE(CPFCGC, '.', '');
  CPFCGC = REPLACE(CPFCGC, '/', '');
  CPFCGC = REPLACE(CPFCGC, ' ', '');

SELECT
  SALDO
FROM
  GET_PESSOASALDO(:CODPESSOA)
INTO
  TOTALCREDITO;

IF (CODPESSOAMATRIZ > 0) THEN
 BEGIN
   SELECT
    NOME
  FROM
    PESSOA
  WHERE
    PESSOA.CODPESSOA = :CODPESSOAMATRIZ
  INTO
    NOMEPESSOAMATRIZ;
  END

IF (CHAR_LENGTH(CPFCGC) <= 11) THEN
    PESSOA = 1;
ELSE
    PESSOA = 2;

IF (COALESCE(CODBAIRRO, 0) > 0) THEN
  BEGIN
    SELECT
      SUBSTRING(TBL_BAIRRO.DESCBAIRRO FROM 1 FOR 45), TBL_BAIRRO.CODCIDADE
    FROM
      TBL_BAIRRO
    WHERE
      TBL_BAIRRO.CODBAIRRO =:CODBAIRRO
      INTO
  BAIRRO_1,
  CODCIDADE;

SELECT
  SUBSTRING(TBL_CIDADES.NOMECIDADE FROM 1 FOR 45) AS NOMECIDADE,
  TBL_CIDADES.CODESTADO,
  COALESCE(NULLIF(:CODIBGE,
  0),
  TBL_CIDADES.CODIBGE)
FROM
  TBL_CIDADES
WHERE
  TBL_CIDADES.CODCIDADE =:CODCIDADE
      INTO
  CIDADE_1,
  CODESTADO,
  CODIBGE;

SELECT
  SUBSTRING(TBL_ESTADO.SIGLA FROM 1 FOR 2) AS SIGLA
FROM
  TBL_ESTADO
WHERE
  TBL_ESTADO.CODESTADO =:CODESTADO
      INTO
  UF_1;
END
    
    SUSPEND;
END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_CLIENTE(
    EEMAIL VARCHAR(100),
    EFILTROCLIENTE VARCHAR(100))
RETURNS (
    ATIVO INTEGER,
    CODPESSOA INTEGER,
    NOME VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    PESSOA_CONTATO VARCHAR(30),
    NUMERO_CONTATO VARCHAR(15),
    CELULAR VARCHAR(15),
    PESSOA INTEGER,
    CPFCGC VARCHAR(18),
    CODPESSOAEN INTEGER,
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(10),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    FONES VARCHAR(15),
    CODVENDEDOR INTEGER,
    CODIBGE INTEGER,
    IE VARCHAR(30),
    LIMITECRED DOUBLE PRECISION,
    LIMITECREDITODISPONIVEL DOUBLE PRECISION,
    EMAIL VARCHAR(100),
    TOTALCREDITO DOUBLE PRECISION,
    DT_CADAST TIMESTAMP,
    CODPESSOAMATRIZ INTEGER,
    NOMEPESSOAMATRIZ VARCHAR(60),
    FLAG_BLOQUEADO SMALLINT,
    OBSBLOQUEIO VARCHAR(200),
    STATUSDESC VARCHAR(60),
    CODSTATUS INTEGER,
    PRECO VARCHAR(10),
    ULTIMOPEDIDO INTEGER,
    ULTIMODTFATURADO DATE,
    ULTIMOTIPOPAG VARCHAR(20),
    ULTIMOFORMAPAG VARCHAR(45),
    CODTIPOATV INTEGER,
    DESCRICAO_TIPOATV VARCHAR(60),
    OBSERVACOES BLOB SUB_TYPE TEXT SEGMENT SIZE 80,
    CODTIPOPAG1 INTEGER,
    DESCRICAO_TIPOPAG VARCHAR(45),
    VENDEDORESSECUNDARIOS BLOB SUB_TYPE TEXT SEGMENT SIZE 80,
    CODSMNPERIODOATENDIMENTO INTEGER,
    CODSEGMENTO INTEGER,
    ATENDSEGUNDA VARCHAR(1),
    ATENDTERCA VARCHAR(1),
    ATENDQUARTA VARCHAR(1),
    ATENDQUINTA VARCHAR(1),
    ATENDSEXTA VARCHAR(1),
    ATENDSABADO VARCHAR(1),
    ATENDDOMINGO VARCHAR(1),
    EMAIL_NFE VARCHAR(100),
    TIPOTRANSPORT VARCHAR(1),
    OBSERVACAO VARCHAR(100))
AS
declare variable CODBAIRRO integer;
declare variable CODESTADO integer;
declare variable CODCIDADE integer;
declare variable LCODVENDEDOR integer;
declare variable LCODEMPRESA integer;
declare variable LCODSTATUSBLOQUEADO integer;
declare variable FILTRARCODIGO boolean;
declare variable LCODIGOFILTRO integer;
declare variable LSQL blob sub_type 1 segment size 80;
declare variable LCODVENDEDORSECUNDARIO integer;
declare variable LNOMEVENDEDORSECUNDARIO varchar(100);
declare variable LCODPESSOAVENDEDOR varchar(100);
declare variable LPRIMEIRAINTERACAO integer = 0;
declare variable LCODPESSOAVENDA integer;
declare CURDADOSULTIMAVENDA cursor for (
    select PEDVEND.DTFATURADO, PEDVEND.TIPOPAG, TIPOPAG.DESCRICAO FORMAPAGAMENTO
    from PEDVEND
    join TIPOPAG on PEDVEND.CODTIPOPAG = TIPOPAG.CODTIPOPAG
    where PEDVEND.STATUSPED = 'FATURADO' and
          PEDVEND.TIPOPED in ('VENDA', 'CADERNO') and
          PEDVEND.CODPEDVEND = :ULTIMOPEDIDO);
declare CURULTIMAVENDA cursor for (
    select max(PEDVEND.CODPEDVEND) ULTIMOPEDIDO
    from PEDVEND
    where PEDVEND.STATUSPED = 'FATURADO' and
          PEDVEND.TIPOPED in ('VENDA', 'CADERNO') and
          PEDVEND.CODPESSOA = :CODPESSOA);
BEGIN
  IF (EXISTS(
      SELECT 1
      FROM DFL_CONSULTA
      WHERE DFL_CONSULTA.CONSULTA = 'DFL_CLIENTE'
    )
  ) THEN
  BEGIN
    SELECT SQL
    FROM DFL_CONSULTA
    WHERE DFL_CONSULTA.CONSULTA = 'DFL_CLIENTE' INTO LSQL;
    FOR EXECUTE STATEMENT (LSQL) (
      EEMAIL := :EEMAIL,
      EFILTROCLIENTE := :EFILTROCLIENTE
  ) INTO
    ATIVO, 
    CODPESSOA, 
    NOME, 
    NOMEFANTAZIA, 
    PESSOA_CONTATO, 
    NUMERO_CONTATO, 
    CELULAR, 
    PESSOA, 
    CPFCGC, 
    CODPESSOAEN, 
    LOGRADOURO_1, 
    NUMERO_1, 
    COMPLEMENTO_1, 
    BAIRRO_1, 
    CIDADE_1, 
    UF_1, 
    CEP_1, 
    FONES, 
    CODVENDEDOR, 
    CODIBGE, 
    IE, 
    LIMITECRED, 
    LIMITECREDITODISPONIVEL, 
    EMAIL, 
    TOTALCREDITO, 
    DT_CADAST, 
    CODPESSOAMATRIZ, 
    NOMEPESSOAMATRIZ, 
    FLAG_BLOQUEADO, 
    OBSBLOQUEIO, 
    STATUSDESC, 
    CODSTATUS, 
    PRECO, 
    ULTIMOPEDIDO, 
    ULTIMODTFATURADO, 
    ULTIMOTIPOPAG, 
    ULTIMOFORMAPAG, 
    CODTIPOATV, 
    DESCRICAO_TIPOATV, 
    OBSERVACOES, 
    CODTIPOPAG1, 
    DESCRICAO_TIPOPAG, 
    VENDEDORESSECUNDARIOS, 
    CODSMNPERIODOATENDIMENTO, 
    CODSEGMENTO, 
    ATENDSEGUNDA, 
    ATENDTERCA, 
    ATENDQUARTA, 
    ATENDQUINTA, 
    ATENDSEXTA, 
    ATENDSABADO, 
    ATENDDOMINGO, 
    EMAIL_NFE, 
    TIPOTRANSPORT,
    OBSERVACAO
    DO
    BEGIN
      SUSPEND;
    END EXIT;
  END

  SELECT CODEMPRESA,COALESCE(CODVENDEDOR, 0) FROM USERCAD WHERE EMAIL = :EEMAIL INTO LCODEMPRESA,LCODVENDEDOR;
  SELECT SYSPARAMS.CODSTATUS, SYSPARAMS.CODPESSOAVENDA FROM SYSPARAMS INTO LCODSTATUSBLOQUEADO, LCODPESSOAVENDA;

  FOR
  SELECT
    PESSOA.ATIVO,
    PESSOA.CODPESSOA,
    SUBSTRING(PESSOA.NOME FROM 1 FOR 60) AS NOME,
    SUBSTRING(COALESCE(NULLIF(TRIM(PESSOA.NOMEFANTAZIA), ''), PESSOA.NOME) FROM 1 FOR 60 ) AS NOMEFANTAZIA,
    PESSOA_CONTATO,
    SUBSTRING(PESSOA.FONECONTATO FROM 1 FOR 15),
    SUBSTRING(PESSOA.CELULAR FROM 1 FOR 15),
    PESSOA.PESSOA,
    SUBSTRING(PESSOA.CPFCGC FROM 1 FOR 18) AS CPFCGC,
    SUBSTRING(PESSOA.LOGRADOURO_1 FROM 1 FOR 60) AS LOGRADOURO,
    SUBSTRING(PESSOA.NUMERO_1 FROM 1 FOR 10 ) AS NUMERO_1,
    SUBSTRING(PESSOA.COMPLEMENTO_1 FROM 1 FOR 60 ) AS COMPLEMENTO_1,
    PESSOA.CODBAIRRO1,
    SUBSTRING(PESSOA.BAIRRO_1 FROM 1 FOR 45) AS BAIRRO_1,
    SUBSTRING(PESSOA.CIDADE_1 FROM 1 FOR 45) AS CIDADE_1,
    SUBSTRING(PESSOA.UF_1 FROM 1 FOR 2) AS UF_1,
    SUBSTRING(PESSOA.CEP_1 FROM 1 FOR 9) AS CEP_1,
    SUBSTRING(PESSOA.FONES FROM 1 FOR 15) AS FONES,
    PESSOA.CODVENDEDOR,
    PESSOA.CODIBGE,
    PESSOA.IE,
    PESSOA.LIMITECRED,
    SUBSTRING(PESSOA.EMAIL FROM 1 FOR 100) AS EMAIL,
    PESSOA.DT_CADAST,
    COALESCE(PESSOA.CODPESSOAMATRIZ, 0),
    IIF(PESSOA.CODSTATUS = :LCODSTATUSBLOQUEADO, 1, 0),
    COALESCE(PESSOA.OBSBLOQUEIO, '') || COALESCE(PESSOA.OBSBLOQUEIO1, ''),
    STATUS.DESCRICAO,
    PESSOA.CODSTATUS,
    PESSOA.PRECOUSADO,
    PESSOA.CODTIPOATV,
    ATIV.DESCRICAO,
    PESSOA.OBSERVACOES,
    PESSOA.CODTIPOPAG1,
    TIPOPAG.DESCRICAO,
    PESSOA.CODSMNPERIODOATENDIMENTO,
    PESSOA.CODSEGMENTO,
    COALESCE(PESSOA.ATENDSEGUNDA, 'N'),
    COALESCE(PESSOA.ATENDTERCA, 'N'),
    COALESCE(PESSOA.ATENDQUARTA, 'N'),
    COALESCE(PESSOA.ATENDQUINTA, 'N'),
    COALESCE(PESSOA.ATENDSEXTA, 'N'),
    COALESCE(PESSOA.ATENDSABADO, 'N'),
    COALESCE(PESSOA.ATENDDOMINGO, 'N'),
    PESSOA.EMAIL_NFE,
    COALESCE(PESSOA.TIPOTRANSPORT, '1'),
    PESSOA.OBS
  FROM PESSOA
    JOIN STATUS ON PESSOA.CODSTATUS = STATUS.CODSTATUS
    LEFT JOIN TBL_RAMOATVTIPO ATIV ON PESSOA.CODTIPOATV = ATIV.CODATIVIDADE
    LEFT JOIN TIPOPAG ON PESSOA.CODTIPOPAG1 = TIPOPAG.CODTIPOPAG
  WHERE (
      :EFILTROCLIENTE = ''
      OR (
        (UPPER(PESSOA.NOME) CONTAINING :EFILTROCLIENTE)
        OR (
          UPPER(PESSOA.NOMEFANTAZIA) CONTAINING :EFILTROCLIENTE
        )
        OR (
          TIRARMASCARA(PESSOA.CPFCGC) CONTAINING :EFILTROCLIENTE
        )
        OR (
          'C' || CAST(PESSOA.CODPESSOA AS VARCHAR(100)) = :EFILTROCLIENTE
        )
      )
    ) INTO ATIVO,
    CODPESSOA,
    NOME,
    NOMEFANTAZIA,
    PESSOA_CONTATO,
    NUMERO_CONTATO,
    CELULAR,
    PESSOA,
    CPFCGC,
    LOGRADOURO_1,
    NUMERO_1,
    COMPLEMENTO_1,
    CODBAIRRO,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    CODVENDEDOR,
    CODIBGE,
    IE,
    LIMITECRED,
    EMAIL,
    DT_CADAST,
    CODPESSOAMATRIZ,
    FLAG_BLOQUEADO,
    OBSBLOQUEIO,
    STATUSDESC,
    CODSTATUS,
    PRECO,
    CODTIPOATV,
    DESCRICAO_TIPOATV,
    OBSERVACOES,
    CODTIPOPAG1,
    DESCRICAO_TIPOPAG,
   CODSMNPERIODOATENDIMENTO,
   CODSEGMENTO,
   ATENDSEGUNDA,
   ATENDTERCA,
   ATENDQUARTA,
   ATENDQUINTA,
   ATENDSEXTA,
   ATENDSABADO,
   ATENDDOMINGO,
   EMAIL_NFE,
   TIPOTRANSPORT,
   OBSERVACAO
   DO 
   BEGIN
      OPEN CURULTIMAVENDA;
      WHILE (1 = 1) DO BEGIN FETCH CURULTIMAVENDA INTO ULTIMOPEDIDO;
      IF (ROW_COUNT = 0) THEN LEAVE;
      END CLOSE CURULTIMAVENDA;


      LIMITECREDITODISPONIVEL = 0;
      ULTIMODTFATURADO = NULL;
      ULTIMOTIPOPAG = NULL;
      ULTIMOFORMAPAG = NULL;
      if (LCODPESSOAVENDA <> CODPESSOA) then
      begin
        SELECT SUM(
            CASE
              WHEN (STATUS = 'ABERTO') THEN DFL_FINANCEIRO_PESSOA.VLPARCELA
              ELSE 0
            END
          ) TOTAL_TITULOS_ABERTO
        FROM DFL_FINANCEIRO_PESSOA(:CODPESSOA)
        INTO
        :LIMITECREDITODISPONIVEL;


        OPEN CURDADOSULTIMAVENDA;
        WHILE (1 = 1) DO BEGIN FETCH CURDADOSULTIMAVENDA INTO ULTIMODTFATURADO,
        ULTIMOTIPOPAG,
        ULTIMOFORMAPAG;
        IF (ROW_COUNT = 0) THEN LEAVE;
        END CLOSE CURDADOSULTIMAVENDA;
      end
    
      CEP_1 = TIRARMASCARA(CEP_1);
      CPFCGC = TIRARMASCARA(CPFCGC);

      SELECT FIRST 1 CODPESSOAEN
      FROM PESSOA_ENDERECO
      WHERE PESSOA_ENDERECO.CODPESSOA = :CODPESSOA
        AND PESSOA_ENDERECO.LOGRADOURO = :LOGRADOURO_1
        AND PESSOA_ENDERECO.CEP = :CEP_1 INTO CODPESSOAEN;
      CODPESSOAEN = COALESCE(CODPESSOAEN, 0);

      SELECT SALDO
      FROM GET_PESSOASALDO(:CODPESSOA) INTO TOTALCREDITO;

      IF (CODPESSOAMATRIZ > 0) THEN
      BEGIN
        SELECT
          NOME,
          LIMITECRED
        FROM PESSOA
        WHERE PESSOA.CODPESSOA = :CODPESSOAMATRIZ
        INTO
          NOMEPESSOAMATRIZ,
          LIMITECRED;
      END

      IF (CHAR_LENGTH(CPFCGC) <= 11) THEN
        PESSOA = 1;
      ELSE
        PESSOA = 2;

      IF (COALESCE(CODBAIRRO, 0) > 0) THEN
      BEGIN
        SELECT
          SUBSTRING(TBL_BAIRRO.DESCBAIRRO FROM 1 FOR 45),
          TBL_BAIRRO.CODCIDADE
        FROM TBL_BAIRRO
        WHERE TBL_BAIRRO.CODBAIRRO = :CODBAIRRO
        INTO
          BAIRRO_1,
          CODCIDADE;
      END

      IF (COALESCE(CODCIDADE, 0) > 0) THEN
      BEGIN
        SELECT
          SUBSTRING(TBL_CIDADES.NOMECIDADE FROM 1 FOR 45) AS NOMECIDADE,
          TBL_CIDADES.CODESTADO,
          COALESCE(NULLIF(:CODIBGE, 0), TBL_CIDADES.CODIBGE)
        FROM TBL_CIDADES
        WHERE TBL_CIDADES.CODCIDADE = :CODCIDADE
        INTO
          CIDADE_1,
          CODESTADO,
          CODIBGE;
      END

      IF (COALESCE(CODESTADO, 0) > 0) THEN
      BEGIN
        SELECT SUBSTRING(TBL_ESTADO.SIGLA FROM 1 FOR 2) AS SIGLA
        FROM TBL_ESTADO
        WHERE TBL_ESTADO.CODESTADO = :CODESTADO
        INTO UF_1;
      END

      SELECT
        list(PV.CODVENDEDOR,',')
      FROM PESSOA_VENDEDOR PV
      INNER JOIN VENDEDOR V ON PV.CODVENDEDOR = V.CODVENDEDOR 
      WHERE
        PV.CODPESSOA = :CODPESSOA
        INTO
          VENDEDORESSECUNDARIOS;
      SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_FABRICANTE(
    EEMAIL VARCHAR(100),
    EFILTRO VARCHAR(100))
RETURNS (
    ATIVO INTEGER,
    CODPESSOA INTEGER,
    NOME VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    PESSOA_CONTATO VARCHAR(30),
    PESSOA INTEGER,
    CPFCGC VARCHAR(18),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(10),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    FONES VARCHAR(15),
    CODVENDEDOR INTEGER,
    CODIBGE INTEGER,
    IE VARCHAR(30),
    EMAIL VARCHAR(100),
    DT_CADAST TIMESTAMP,
    FLAG_BLOQUEADO SMALLINT,
    OBSBLOQUEIO VARCHAR(200),
    STATUSDESC VARCHAR(60))
AS
DECLARE VARIABLE CODBAIRRO INTEGER;
DECLARE VARIABLE CODESTADO INTEGER;
DECLARE VARIABLE CODCIDADE INTEGER;
DECLARE VARIABLE LCODVENDEDOR INTEGER;
DECLARE VARIABLE LCODEMPRESA INTEGER;
DECLARE VARIABLE LCODSTATUSBLOQUEADO INTEGER;
DECLARE VARIABLE FILTRARCODIGO BOOLEAN;
DECLARE VARIABLE LCODIGOFILTRO INTEGER;
DECLARE VARIABLE LSQL BLOB SUB_TYPE 1 SEGMENT SIZE 80;
BEGIN
  IF (EXISTS(SELECT 1 FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_FABRICANTE')) THEN
  BEGIN
    SELECT SQL FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_FABRICANTE' INTO LSQL;
    FOR EXECUTE STATEMENT (LSQL)
    (
        EEMAIL := :EEMAIL,
        EFILTRO := :EFILTRO
    )
    INTO
      ATIVO, 
      CODPESSOA, 
      NOME, 
      NOMEFANTAZIA, 
      PESSOA_CONTATO, 
      PESSOA, 
      CPFCGC, 
      LOGRADOURO_1, 
      NUMERO_1, 
      COMPLEMENTO_1, 
      BAIRRO_1, 
      CIDADE_1, 
      UF_1, 
      CEP_1, 
      FONES, 
      CODVENDEDOR, 
      CODIBGE, 
      IE, 
      EMAIL, 
      DT_CADAST, 
      FLAG_BLOQUEADO, 
      OBSBLOQUEIO, 
      STATUSDESC
    DO
    BEGIN
      SUSPEND;
    END
    EXIT;
  END

  SELECT CODEMPRESA, COALESCE(CODVENDEDOR,0) FROM USERCAD WHERE EMAIL = :EEMAIL INTO LCODEMPRESA, LCODVENDEDOR;
  SELECT SYSPARAMS.CODSTATUS FROM SYSPARAMS INTO LCODSTATUSBLOQUEADO;

  FOR SELECT
    PESSOA.ATIVO,
    PESSOA.CODPESSOA, 
    SUBSTRING(PESSOA.NOME FROM 1 FOR 60) AS NOME,   
    SUBSTRING(COALESCE(NULLIF(TRIM(PESSOA.NOMEFANTAZIA),''),PESSOA.NOME) FROM 1 FOR 60) AS NOMEFANTAZIA,
    PESSOA_CONTATO,
    PESSOA.PESSOA, 
    SUBSTRING(PESSOA.CPFCGC FROM 1 FOR 18) AS CPFCGC, 
    SUBSTRING(PESSOA.LOGRADOURO_1 FROM 1 FOR 60) AS LOGRADOURO,
    SUBSTRING(PESSOA.NUMERO_1 FROM 1 FOR 10) AS NUMERO_1, 
    SUBSTRING(PESSOA.COMPLEMENTO_1 FROM 1 FOR 60) AS COMPLEMENTO_1,  
    PESSOA.CODBAIRRO1,
    SUBSTRING(PESSOA.BAIRRO_1 FROM 1 FOR 45) AS BAIRRO_1, 
    SUBSTRING(PESSOA.CIDADE_1 FROM 1 FOR 45) AS CIDADE_1,   
    SUBSTRING(PESSOA.UF_1 FROM 1 FOR 2) AS UF_1,  
    SUBSTRING(PESSOA.CEP_1 FROM 1 FOR 9) AS CEP_1, 
    SUBSTRING(PESSOA.FONES FROM 1 FOR 15) AS FONES, 
    PESSOA.CODVENDEDOR, 
    PESSOA.CODIBGE,
    PESSOA.IE,
    SUBSTRING(PESSOA.EMAIL FROM 1 FOR 100) AS EMAIL,
    PESSOA.DT_CADAST,
    IIF(PESSOA.CODSTATUS = :LCODSTATUSBLOQUEADO, 1, 0),
    COALESCE(PESSOA.OBSBLOQUEIO,'')||COALESCE(PESSOA.OBSBLOQUEIO1,''),
    STATUS.DESCRICAO
  FROM
    PESSOA
    JOIN STATUS ON
      PESSOA.CODSTATUS = STATUS.CODSTATUS
    WHERE (
      :EFILTRO = '' OR 
      (
      (UPPER(PESSOA.NOME) CONTAINING :EFILTRO) OR
      (UPPER(PESSOA.NOMEFANTAZIA) CONTAINING :EFILTRO) OR
      (TIRARMASCARA(PESSOA.CPFCGC) CONTAINING :EFILTRO) OR
      ('C'||CAST(PESSOA.CODPESSOA AS VARCHAR(100)) = :EFILTRO)
      )  
    ) AND UPPER(PESSOA.TIPOPESSOA)  ='FABRICANTE'
  INTO
    ATIVO,
    CODPESSOA,
    NOME,
    NOMEFANTAZIA,
    PESSOA_CONTATO,
    PESSOA,
    CPFCGC,
    LOGRADOURO_1,
    NUMERO_1,
    COMPLEMENTO_1,
    CODBAIRRO,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    CODVENDEDOR,
    CODIBGE,
    IE,
    EMAIL,
    DT_CADAST,
    FLAG_BLOQUEADO,
    OBSBLOQUEIO,
    STATUSDESC
  DO
  BEGIN
    CEP_1  = TIRARMASCARA(CEP_1);
    CPFCGC = TIRARMASCARA(CPFCGC);
   
    IF (CHAR_LENGTH(CPFCGC) <= 11) THEN
      PESSOA = 1;
    ELSE
      PESSOA = 2;

    IF (COALESCE(CODBAIRRO,0) > 0) THEN
    BEGIN
      SELECT
        SUBSTRING(TBL_BAIRRO.DESCBAIRRO FROM 1 FOR 45),
        TBL_BAIRRO.CODCIDADE
      FROM
        TBL_BAIRRO
      WHERE
        TBL_BAIRRO.CODBAIRRO =:CODBAIRRO
      INTO
        BAIRRO_1,
        CODCIDADE;

      SELECT
        SUBSTRING(TBL_CIDADES.NOMECIDADE FROM 1 FOR 45) AS NOMECIDADE,
        TBL_CIDADES.CODESTADO,
        COALESCE(NULLIF(:CODIBGE,0),TBL_CIDADES.CODIBGE)
      FROM
        TBL_CIDADES
      WHERE
        TBL_CIDADES.CODCIDADE =:CODCIDADE
      INTO
        CIDADE_1,
        CODESTADO,
        CODIBGE;

      SELECT
        SUBSTRING(TBL_ESTADO.SIGLA FROM 1 FOR 2) AS SIGLA
      FROM
        TBL_ESTADO
      WHERE
        TBL_ESTADO.CODESTADO =:CODESTADO
      INTO
        UF_1;
    END       
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_LISTAR_FORNECEDOR(
    EEMAIL VARCHAR(100),
    EFILTRO VARCHAR(100))
RETURNS (
    ATIVO INTEGER,
    CODPESSOA INTEGER,
    NOME VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    PESSOA_CONTATO VARCHAR(30),
    PESSOA INTEGER,
    CPFCGC VARCHAR(18),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(10),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    FONES VARCHAR(15),
    CODVENDEDOR INTEGER,
    CODIBGE INTEGER,
    IE VARCHAR(30),
    EMAIL VARCHAR(100),
    DT_CADAST TIMESTAMP,
    FLAG_BLOQUEADO SMALLINT,
    OBSBLOQUEIO VARCHAR(200),
    STATUSDESC VARCHAR(60))
AS
DECLARE VARIABLE CODBAIRRO INTEGER;
DECLARE VARIABLE CODESTADO INTEGER;
DECLARE VARIABLE CODCIDADE INTEGER;
DECLARE VARIABLE LCODVENDEDOR INTEGER;
DECLARE VARIABLE LCODEMPRESA INTEGER;
DECLARE VARIABLE LCODSTATUSBLOQUEADO INTEGER;
DECLARE VARIABLE FILTRARCODIGO BOOLEAN;
DECLARE VARIABLE LCODIGOFILTRO INTEGER;
DECLARE VARIABLE LSQL BLOB SUB_TYPE 1 SEGMENT SIZE 80;
BEGIN
  IF (EXISTS(SELECT 1 FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_FORNECEDOR')) THEN
  BEGIN
    SELECT SQL FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_FORNECEDOR' INTO LSQL;
    FOR EXECUTE STATEMENT (LSQL)
    (
        EEMAIL := :EEMAIL,
        EFILTRO := :EFILTRO
    )
    INTO
      ATIVO, 
      CODPESSOA, 
      NOME, 
      NOMEFANTAZIA, 
      PESSOA_CONTATO, 
      PESSOA, 
      CPFCGC, 
      LOGRADOURO_1, 
      NUMERO_1, 
      COMPLEMENTO_1, 
      BAIRRO_1, 
      CIDADE_1, 
      UF_1, 
      CEP_1, 
      FONES, 
      CODVENDEDOR, 
      CODIBGE, 
      IE, 
      EMAIL, 
      DT_CADAST, 
      FLAG_BLOQUEADO, 
      OBSBLOQUEIO, 
      STATUSDESC
    DO
    BEGIN
      SUSPEND;
    END
    EXIT;
  END

  SELECT CODEMPRESA, COALESCE(CODVENDEDOR,0) FROM USERCAD WHERE EMAIL = :EEMAIL INTO LCODEMPRESA, LCODVENDEDOR;
  SELECT SYSPARAMS.CODSTATUS FROM SYSPARAMS INTO LCODSTATUSBLOQUEADO;

  FOR SELECT
    PESSOA.ATIVO,
    PESSOA.CODPESSOA, 
    SUBSTRING(PESSOA.NOME FROM 1 FOR 60) AS NOME,   
    SUBSTRING(COALESCE(NULLIF(TRIM(PESSOA.NOMEFANTAZIA),''),PESSOA.NOME) FROM 1 FOR 60) AS NOMEFANTAZIA,
    PESSOA_CONTATO,
    PESSOA.PESSOA, 
    SUBSTRING(PESSOA.CPFCGC FROM 1 FOR 18) AS CPFCGC, 
    SUBSTRING(PESSOA.LOGRADOURO_1 FROM 1 FOR 60) AS LOGRADOURO,
    SUBSTRING(PESSOA.NUMERO_1 FROM 1 FOR 10) AS NUMERO_1, 
    SUBSTRING(PESSOA.COMPLEMENTO_1 FROM 1 FOR 60) AS COMPLEMENTO_1,  
    PESSOA.CODBAIRRO1,
    SUBSTRING(PESSOA.BAIRRO_1 FROM 1 FOR 45) AS BAIRRO_1, 
    SUBSTRING(PESSOA.CIDADE_1 FROM 1 FOR 45) AS CIDADE_1,   
    SUBSTRING(PESSOA.UF_1 FROM 1 FOR 2) AS UF_1,  
    SUBSTRING(PESSOA.CEP_1 FROM 1 FOR 9) AS CEP_1, 
    SUBSTRING(PESSOA.FONES FROM 1 FOR 15) AS FONES, 
    PESSOA.CODVENDEDOR, 
    PESSOA.CODIBGE,
    PESSOA.IE,
    SUBSTRING(PESSOA.EMAIL FROM 1 FOR 100) AS EMAIL,
    PESSOA.DT_CADAST,
    IIF(PESSOA.CODSTATUS = :LCODSTATUSBLOQUEADO, 1, 0),
    COALESCE(PESSOA.OBSBLOQUEIO,'')||COALESCE(PESSOA.OBSBLOQUEIO1,''),
    STATUS.DESCRICAO
  FROM
    PESSOA
    JOIN STATUS ON
      PESSOA.CODSTATUS = STATUS.CODSTATUS
    WHERE (
      :EFILTRO = '' OR 
      (
      (UPPER(PESSOA.NOME) CONTAINING :EFILTRO) OR
      (UPPER(PESSOA.NOMEFANTAZIA) CONTAINING :EFILTRO) OR
      (TIRARMASCARA(PESSOA.CPFCGC) CONTAINING :EFILTRO) OR
      ('C'||CAST(PESSOA.CODPESSOA AS VARCHAR(100)) = :EFILTRO)
      )  
    ) AND PESSOA.TIPOPESSOA  ='FORNECEDOR'
  INTO
    ATIVO,
    CODPESSOA,
    NOME,
    NOMEFANTAZIA,
    PESSOA_CONTATO,
    PESSOA,
    CPFCGC,
    LOGRADOURO_1,
    NUMERO_1,
    COMPLEMENTO_1,
    CODBAIRRO,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    CODVENDEDOR,
    CODIBGE,
    IE,
    EMAIL,
    DT_CADAST,
    FLAG_BLOQUEADO,
    OBSBLOQUEIO,
    STATUSDESC
  DO
  BEGIN
    CEP_1  = TIRARMASCARA(CEP_1);
    CPFCGC = TIRARMASCARA(CPFCGC);
   
    IF (CHAR_LENGTH(CPFCGC) <= 11) THEN
      PESSOA = 1;
    ELSE
      PESSOA = 2;

    IF (COALESCE(CODBAIRRO,0) > 0) THEN
    BEGIN
      SELECT
        SUBSTRING(TBL_BAIRRO.DESCBAIRRO FROM 1 FOR 45),
        TBL_BAIRRO.CODCIDADE
      FROM
        TBL_BAIRRO
      WHERE
        TBL_BAIRRO.CODBAIRRO =:CODBAIRRO
      INTO
        BAIRRO_1,
        CODCIDADE;

      SELECT
        SUBSTRING(TBL_CIDADES.NOMECIDADE FROM 1 FOR 45) AS NOMECIDADE,
        TBL_CIDADES.CODESTADO,
        COALESCE(NULLIF(:CODIBGE,0),TBL_CIDADES.CODIBGE)
      FROM
        TBL_CIDADES
      WHERE
        TBL_CIDADES.CODCIDADE =:CODCIDADE
      INTO
        CIDADE_1,
        CODESTADO,
        CODIBGE;

      SELECT
        SUBSTRING(TBL_ESTADO.SIGLA FROM 1 FOR 2) AS SIGLA
      FROM
        TBL_ESTADO
      WHERE
        TBL_ESTADO.CODESTADO =:CODESTADO
      INTO
        UF_1;
    END       
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_MVARQUITETOS(
    EEMAIL VARCHAR(100))
RETURNS (
    ATIVO INTEGER,
    CODPESSOA INTEGER,
    NOME VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    PESSOA_CONTATO VARCHAR(30),
    PESSOA INTEGER,
    CPFCGC VARCHAR(18),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(10),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    FONES VARCHAR(15),
    CODVENDEDOR INTEGER,
    CODIBGE INTEGER,
    IE VARCHAR(30),
    LIMITECRED DOUBLE PRECISION,
    EMAIL VARCHAR(100),
    TOTALCREDITO DOUBLE PRECISION,
    DT_CADAST TIMESTAMP,
    CODPESSOAMATRIZ INTEGER,
    NOMEPESSOAMATRIZ VARCHAR(60),
    OBSBLOQUEIO VARCHAR(200),
    STATUSDESC VARCHAR(60))
AS
DECLARE VARIABLE CODBAIRRO INTEGER;
DECLARE VARIABLE CODESTADO INTEGER;
DECLARE VARIABLE CODCIDADE INTEGER;
DECLARE VARIABLE LCODVENDEDOR INTEGER;
DECLARE VARIABLE LCODEMPRESA INTEGER;
BEGIN     
  SELECT CODEMPRESA, COALESCE(CODVENDEDOR,0) FROM USERCAD WHERE NULLIF(EMAIL,'') = :EEMAIL INTO LCODEMPRESA, LCODVENDEDOR;

  FOR SELECT
    PESSOA.ATIVO,
    PESSOA.CODPESSOA, 
    SUBSTRING(PESSOA.NOME FROM 1 FOR 60) AS NOME,   
    SUBSTRING(COALESCE(NULLIF(TRIM(PESSOA.NOMEFANTAZIA),''),PESSOA.NOME) FROM 1 FOR 60) AS NOMEFANTAZIA,
    PESSOA_CONTATO,
    PESSOA.PESSOA, 
    SUBSTRING(PESSOA.CPFCGC FROM 1 FOR 18) AS CPFCGC, 
    SUBSTRING(PESSOA.LOGRADOURO_1 FROM 1 FOR 60) AS LOGRADOURO,
    SUBSTRING(PESSOA.NUMERO_1 FROM 1 FOR 10) AS NUMERO_1, 
    SUBSTRING(PESSOA.COMPLEMENTO_1 FROM 1 FOR 60) AS COMPLEMENTO_1,  
    PESSOA.CODBAIRRO1,
    SUBSTRING(PESSOA.BAIRRO_1 FROM 1 FOR 45) AS BAIRRO_1, 
    SUBSTRING(PESSOA.CIDADE_1 FROM 1 FOR 45) AS CIDADE_1,   
    SUBSTRING(PESSOA.UF_1 FROM 1 FOR 2) AS UF_1,  
    SUBSTRING(PESSOA.CEP_1 FROM 1 FOR 9) AS CEP_1, 
    SUBSTRING(PESSOA.FONES FROM 1 FOR 15) AS FONES, 
    PESSOA.CODVENDEDOR, 
    PESSOA.CODIBGE,
    PESSOA.IE,
    PESSOA.LIMITECRED,
    SUBSTRING(PESSOA.EMAIL FROM 1 FOR 100) AS EMAIL,
    PESSOA.DT_CADAST,
    COALESCE(PESSOA.CODPESSOAMATRIZ,0),
    COALESCE(PESSOA.OBSBLOQUEIO,'')||COALESCE(PESSOA.OBSBLOQUEIO1,''),
    STATUS.DESCRICAO
  FROM
    PESSOA
    LEFT JOIN STATUS ON
      PESSOA.CODSTATUS = STATUS.CODSTATUS
  WHERE
    UPPER(TIPOPESSOA) = 'ARQUITETO'
  INTO
    ATIVO,
    CODPESSOA,
    NOME,
    NOMEFANTAZIA,
    PESSOA_CONTATO,
    PESSOA,
    CPFCGC,
    LOGRADOURO_1,
    NUMERO_1,
    COMPLEMENTO_1,
    CODBAIRRO,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    CODVENDEDOR,
    CODIBGE,
    IE,
    LIMITECRED,
    EMAIL,
    DT_CADAST,
    CODPESSOAMATRIZ,
    OBSBLOQUEIO,
    STATUSDESC
  DO
  BEGIN
    CEP_1  = REPLACE(CEP_1,'-','');
    CPFCGC = REPLACE(CPFCGC,'-','');
    CPFCGC = REPLACE(CPFCGC,'.','');
    CPFCGC = REPLACE(CPFCGC,'/','');
    CPFCGC = REPLACE(CPFCGC,' ','');

    SELECT SALDO FROM GET_PESSOASALDO(:CODPESSOA) INTO TOTALCREDITO;

    IF (CODPESSOAMATRIZ > 0) THEN
    BEGIN
      SELECT NOME FROM PESSOA WHERE PESSOA.CODPESSOA = :CODPESSOAMATRIZ INTO NOMEPESSOAMATRIZ;
    END

    IF (CHAR_LENGTH(CPFCGC) <= 11) THEN
      PESSOA = 1;
    ELSE
      PESSOA = 2;

    IF (COALESCE(CODBAIRRO,0) > 0) THEN
    BEGIN
      SELECT
        SUBSTRING(TBL_BAIRRO.DESCBAIRRO FROM 1 FOR 45),
        TBL_BAIRRO.CODCIDADE
      FROM
        TBL_BAIRRO
      WHERE
        TBL_BAIRRO.CODBAIRRO =:CODBAIRRO
      INTO
        BAIRRO_1,
        CODCIDADE;

      SELECT
        SUBSTRING(TBL_CIDADES.NOMECIDADE FROM 1 FOR 45) AS NOMECIDADE,
        TBL_CIDADES.CODESTADO,
        COALESCE(NULLIF(:CODIBGE,0),TBL_CIDADES.CODIBGE)
      FROM
        TBL_CIDADES
      WHERE
        TBL_CIDADES.CODCIDADE =:CODCIDADE
      INTO
        CIDADE_1,
        CODESTADO,
        CODIBGE;

      SELECT
        SUBSTRING(TBL_ESTADO.SIGLA FROM 1 FOR 2) AS SIGLA
      FROM
        TBL_ESTADO
      WHERE
        TBL_ESTADO.CODESTADO =:CODESTADO
      INTO
        UF_1;
    END       
    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DFL_ST_BUSCARCLIENTE(
    EEMAIL VARCHAR(100),
    EFILTROCODIGO INTEGER,
    EFILTROCLIENTE VARCHAR(100),
    EFILTROAVANCADO SMALLINT,
    EGRUPO_CLIENTE INTEGER,
    ESKIP SMALLINT,
    ETAKE SMALLINT,
    EORDENACAO VARCHAR(50),
    EDECRESCEMTE SMALLINT)
RETURNS (
    ATIVO INTEGER,
    CODPESSOA INTEGER,
    NOME VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    PESSOA_CONTATO VARCHAR(30),
    PESSOA INTEGER,
    CPFCGC VARCHAR(18),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(10),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    FONES VARCHAR(15),
    CODVENDEDOR INTEGER,
    CODIBGE INTEGER,
    IE VARCHAR(30),
    LIMITECRED DOUBLE PRECISION,
    EMAIL VARCHAR(100),
    TOTALCREDITO DOUBLE PRECISION,
    DT_CADAST TIMESTAMP,
    CODPESSOAMATRIZ INTEGER,
    NOMEPESSOAMATRIZ VARCHAR(60),
    FLAG_BLOQUEADO SMALLINT,
    OBSBLOQUEIO VARCHAR(200),
    STATUSDESC VARCHAR(60),
    TOTALREG INTEGER,
    AGENDA_VENDEDOR SMALLINT,
    CODVENDEDORAGENDA INTEGER,
    AGENDADO_PARA DATE,
    AGENDADO_PARA_HORA TIME,
    PGT_DESCRICAO VARCHAR(65),
    PRAZO_MEDIO VARCHAR(10),
    DATA_ULTIMACOMPRA TIMESTAMP,
    CLIENTE_POSITIVADO SMALLINT,
    SITUACAO_CHECK_IN INTEGER)
AS
declare variable LCODVENDEDOR integer;
declare variable LCODSUPERVISOR integer;
declare variable LCODEMPRESA integer;
declare variable LCODSTATUSBLOQUEADO integer;
declare variable LSQL blob sub_type 1 segment size 80;
declare variable LSQLCONSULTA blob sub_type 1 segment size 80;
declare variable LTIPOVENDEDOR varchar(1);
declare variable LPRIMEIRODIAMES timestamp;
declare variable LULTIMODIAMES timestamp;
BEGIN
  IF (EXISTS(SELECT 1 FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_ST_BUSCARCLIENTE')) THEN
  BEGIN
    SELECT SQL FROM DFL_CONSULTA WHERE DFL_CONSULTA.CONSULTA = 'DFL_ST_BUSCARCLIENTE' INTO LSQL;
    for EXECUTE STATEMENT (LSQL)
    (
        EEMAIL := :EEMAIL,
        EFILTROCODIGO := :EFILTROCODIGO,
        EFILTROCLIENTE := :EFILTROCLIENTE,
        EFILTROAVANCADO := :EFILTROAVANCADO,
        EGRUPO_CLIENTE := :EGRUPO_CLIENTE,
        ESKIP := :ESKIP,
        ETAKE := :ETAKE,
        EORDENACAO := :EORDENACAO,
        EDECRESCEMTE := :EDECRESCEMTE
    )
    into
      ATIVO, 
      CODPESSOA, 
      NOME, 
      NOMEFANTAZIA, 
      PESSOA_CONTATO, 
      PESSOA, 
      CPFCGC, 
      LOGRADOURO_1, 
      NUMERO_1, 
      COMPLEMENTO_1, 
      BAIRRO_1, 
      CIDADE_1, 
      UF_1, 
      CEP_1, 
      FONES, 
      CODVENDEDOR, 
      CODIBGE, 
      IE, 
      LIMITECRED, 
      EMAIL, 
      TOTALCREDITO, 
      DT_CADAST, 
      CODPESSOAMATRIZ, 
      NOMEPESSOAMATRIZ, 
      FLAG_BLOQUEADO, 
      OBSBLOQUEIO, 
      STATUSDESC, 
      TOTALREG,
      AGENDA_VENDEDOR,
      CODVENDEDORAGENDA,
      AGENDADO_PARA,
      AGENDADO_PARA_HORA,
      PGT_DESCRICAO,
      PRAZO_MEDIO,
      DATA_ULTIMACOMPRA,
      CLIENTE_POSITIVADO,
      SITUACAO_CHECK_IN
    do
    begin
      suspend;
    end
    EXIT;
  END


  /*
    0  Nenhum
  1  Minha Carteira
  2  Sem Compra 7 Dias
  3  Sem Compra 15 Dias
  4  Sem Compra 30 Dias
  5  Sem Compra 60 Dias
  6  Sem Compra 90 Dias
  7  Cliente do Dia  
  8  Cliente sem vendedor
  */

  LPRIMEIRODIAMES = cast(primeirodiames(current_date)||' 00:00:00' as timestamp);
  LULTIMODIAMES   = cast(ultimodiames(current_date)||' 23:59:59' as timestamp);
  SELECT CODEMPRESA, COALESCE(CODVENDEDOR,0), coalesce(CODSUPERVISOR,0) FROM USERCAD WHERE EMAIL = :EEMAIL INTO LCODEMPRESA, LCODVENDEDOR, LCODSUPERVISOR;
  SELECT SYSPARAMS.CODSTATUS FROM SYSPARAMS INTO LCODSTATUSBLOQUEADO; 
  SELECT TIPOVENDEDOR FROM VENDEDOR WHERE VENDEDOR.CODVENDEDOR = :LCODVENDEDOR INTO LTIPOVENDEDOR;


  LSQL = '';
  LSQL = LSQL || ' SELECT ';
  LSQL = LSQL || '   PESSOA.ATIVO, ';
  LSQL = LSQL || '   PESSOA.CODPESSOA,  ';
  LSQL = LSQL || '   SUBSTRING(PESSOA.NOME FROM 1 FOR 60) AS NOME, ';
  LSQL = LSQL || '   SUBSTRING(COALESCE(NULLIF(TRIM(PESSOA.NOMEFANTAZIA),''''),PESSOA.NOME) FROM 1 FOR 60) AS NOMEFANTAZIA, ';
  LSQL = LSQL || '   PESSOA_CONTATO, ';
  LSQL = LSQL || '   PESSOA.PESSOA,  ';
  LSQL = LSQL || '   TIRARMASCARA(SUBSTRING(PESSOA.CPFCGC FROM 1 FOR 18)) AS CPFCGC, ';
  LSQL = LSQL || '   SUBSTRING(PESSOA.LOGRADOURO_1 FROM 1 FOR 60) AS LOGRADOURO, ';
  LSQL = LSQL || '   SUBSTRING(PESSOA.NUMERO_1 FROM 1 FOR 10) AS NUMERO_1,  ';
  LSQL = LSQL || '   SUBSTRING(PESSOA.COMPLEMENTO_1 FROM 1 FOR 60) AS COMPLEMENTO_1,   ';
  LSQL = LSQL || '   SUBSTRING(PESSOA.BAIRRO_1 FROM 1 FOR 45) AS BAIRRO_1, ';
  LSQL = LSQL || '   SUBSTRING(PESSOA.CIDADE_1 FROM 1 FOR 45) AS CIDADE_1,    ';
  LSQL = LSQL || '   SUBSTRING(PESSOA.UF_1 FROM 1 FOR 2) AS UF_1,   ';
  LSQL = LSQL || '   TIRARMASCARA(SUBSTRING(PESSOA.CEP_1 FROM 1 FOR 9)) AS CEP_1, ';
  LSQL = LSQL || '   SUBSTRING(PESSOA.FONES FROM 1 FOR 15) AS FONES,  ';
  LSQL = LSQL || '   PESSOA.CODVENDEDOR,  ';
  LSQL = LSQL || '   PESSOA.CODIBGE, ';
  LSQL = LSQL || '   PESSOA.IE, ';
  LSQL = LSQL || '   PESSOA.LIMITECRED, ';
  LSQL = LSQL || '   SUBSTRING(PESSOA.EMAIL FROM 1 FOR 100) AS EMAIL, ';
  LSQL = LSQL || '   PESSOA.DT_CADAST, ';
  LSQL = LSQL || '   COALESCE(PESSOA.CODPESSOAMATRIZ,0) CODPESSOAMATRIZ, ';
  LSQL = LSQL || '   IIF(PESSOA.CODSTATUS = '||:LCODSTATUSBLOQUEADO||', 1, 0) FLAG_BLOQUEADO, ';
  LSQL = LSQL || '   COALESCE(PESSOA.OBSBLOQUEIO,'''')||COALESCE(PESSOA.OBSBLOQUEIO1,'''') OBSBLOQUEIO, ';
  LSQL = LSQL || '   STATUS.DESCRICAO, ';
  LSQL = LSQL || '   IIF(COALESCE(TIPOPAG.TIP_TIPO,'''') = '''' ,TIPOPAG.DESCRICAO, TIPOPAG.TIP_TIPO || '' - '' || TIPOPAG.DESCRICAO) AS PGT_DESCRICAO, ';
  LSQL = LSQL || '   COALESCE(TIPOPAG.PRAZOMEDIO, 0) AS PRAZO_MEDIO ';
  LSQL = LSQL || ' FROM ';
  LSQL = LSQL || '   PESSOA ';
  LSQL = LSQL || '   JOIN STATUS ON ';
  LSQL = LSQL || '     PESSOA.CODSTATUS = STATUS.CODSTATUS ';
  LSQL = LSQL || '   LEFT JOIN TIPOPAG ON ';
  LSQL = LSQL || '     PESSOA.CODTIPOPAG1 = TIPOPAG.CODTIPOPAG ';
  LSQL = LSQL || '   WHERE ';
  LSQL = LSQL || '     (UPPER(PESSOA.TIPOPESSOA) = ''CLIENTE'') ';
  LSQL = LSQL || '     AND ( ';
  LSQL = LSQL || '       '||:EFILTROCODIGO||' = 0 ';
  LSQL = LSQL || '       OR ( ';
  LSQL = LSQL || '         PESSOA.CODPESSOA = '||:EFILTROCODIGO;
  LSQL = LSQL || '       ) ';
  LSQL = LSQL || '     ) ';
   LSQL = LSQL || '     AND ('|| :EGRUPO_CLIENTE || ' = 0 OR PESSOA.CODPESSOAMATRIZ = ' || :EGRUPO_CLIENTE || ')';  
  LSQL = LSQL || '     AND ( ';
  LSQL = LSQL || '       '''||:EFILTROCLIENTE ||''' = '''' ';
  LSQL = LSQL || '       OR ( ';
  LSQL = LSQL || '         (PESSOA.NOME CONTAINING '''||:EFILTROCLIENTE||''') ';
  LSQL = LSQL || '         OR (PESSOA.NOMEFANTAZIA CONTAINING ''' || :EFILTROCLIENTE || ''') ';
  LSQL = LSQL || '         OR (TIRARMASCARA(PESSOA.CPFCGC) CONTAINING ''' || :EFILTROCLIENTE || ''') ';
  LSQL = LSQL || '       ) ';
  LSQL = LSQL || '     ) ';
  LSQL = LSQL || '     and PESSOA.ATIVO = 2 ';

  if (LCODVENDEDOR > 0) then
    LSQL = LSQL || '     and PESSOA.TIPOPESSOA <> ''Funcionário'' ';

  IF (EFILTROAVANCADO = 0) THEN
  BEGIN
    IF (LTIPOVENDEDOR = 'E') THEN
    begin
      if (LCODSUPERVISOR > 0) then
      begin
        LSQL = LSQL || '     AND ( ';
        LSQL = LSQL || '        EXISTS(SELECT * FROM PESSOA_VENDEDOR PV join VENDEDOR V on PV.CODVENDEDOR = V.CODVENDEDOR  WHERE (PV.CODPESSOA = PESSOA.CODPESSOA) AND (V.CODSUPERVISOR = '||:LCODSUPERVISOR||')) ';
        LSQL = LSQL || '     ) ';
      end
      ELSE
      BEGIN
        LSQL = LSQL || '     AND ( ';
        LSQL = LSQL || '       ('||:LCODVENDEDOR||' = 0) ';
        LSQL = LSQL || '       OR ( ';
        LSQL = LSQL || '         EXISTS(SELECT * FROM PESSOA_VENDEDOR PV WHERE (PV.CODPESSOA = PESSOA.CODPESSOA) AND (PV.CODVENDEDOR = '||:LCODVENDEDOR||')) ';
        LSQL = LSQL || '       ) ';
        LSQL = LSQL || '     ) ';
      END
    end
  end
  else IF (EFILTROAVANCADO = 1) THEN
  BEGIN
    LSQL = LSQL || '     AND ( ';
    LSQL = LSQL || '       ('||:LCODVENDEDOR||' = 0) ';
    LSQL = LSQL || '       OR ( ';
    LSQL = LSQL || '         EXISTS(SELECT * FROM PESSOA_VENDEDOR PV WHERE (PV.CODPESSOA = PESSOA.CODPESSOA) AND (PV.CODVENDEDOR = '||:LCODVENDEDOR||')) ';
    LSQL = LSQL || '       ) ';
    LSQL = LSQL || '     ) ';
  END
  ELSE IF (EFILTROAVANCADO IN (2,3,4,5,6)) THEN
  BEGIN

    LSQL = LSQL || '     AND ( ';
    LSQL = LSQL || '       1 = 1 ';
    LSQL = LSQL || '     AND ( ';
    LSQL = LSQL || '       ('||:LCODVENDEDOR||' = 0) ';
    LSQL = LSQL || '       OR ( ';
    LSQL = LSQL || '         EXISTS(SELECT * FROM PESSOA_VENDEDOR PV WHERE (PV.CODPESSOA = PESSOA.CODPESSOA) AND (PV.CODVENDEDOR = '||:LCODVENDEDOR||')) ';
    LSQL = LSQL || '       ) ';
    LSQL = LSQL || '     ) ';

    LSQL = LSQL || '        AND NOT EXISTS(SELECT * FROM PEDVEND ';
    LSQL = LSQL || '                       WHERE ';
    LSQL = LSQL || '                       PEDVEND.STATUSPED = ''FATURADO'' ';
    LSQL = LSQL || '                       AND PEDVEND.TIPOPED IN (''VENDA'', ''CADERNO'') ';
    LSQL = LSQL || '                       AND (PEDVEND.DTFATURADO >= CURRENT_DATE - (CASE ';
    LSQL = LSQL || '                                                               WHEN '||:EFILTROAVANCADO||' = 2 THEN 7 ';
    LSQL = LSQL || '                                                               WHEN '||:EFILTROAVANCADO||' = 3 THEN 15 ';
    LSQL = LSQL || '                                                               WHEN '||:EFILTROAVANCADO||' = 4 THEN 30 ';
    LSQL = LSQL || '                                                               WHEN '||:EFILTROAVANCADO||' = 5 THEN 60 ';
    LSQL = LSQL || '                                                               WHEN '||:EFILTROAVANCADO||' = 6 THEN 90 ';
    LSQL = LSQL || '                                                             ELSE ';
    LSQL = LSQL || '                                                               7 ';
    LSQL = LSQL || '                                                             END)) ';
    LSQL = LSQL || '                       AND PEDVEND.CODPESSOA = PESSOA.CODPESSOA) ';
    LSQL = LSQL || '     ) ';
  END
  ELSE IF (EFILTROAVANCADO = 7) THEN
  BEGIN
    LSQL = LSQL || '     AND ( ';
    LSQL = LSQL || '       ('||:LCODVENDEDOR||' = 0) ';
    LSQL = LSQL || '       OR ( ';
    LSQL = LSQL || '         EXISTS(SELECT * FROM PESSOA_VENDEDOR PV WHERE (PV.CODPESSOA = PESSOA.CODPESSOA) AND (PV.CODVENDEDOR = '||:LCODVENDEDOR||')) ';
    LSQL = LSQL || '       ) ';
    LSQL = LSQL || '     ) ';

    LSQL = LSQL || '     AND (CASE
                WHEN EXTRACT(WEEKDAY FROM CURRENT_DATE) = 0 AND PESSOA.ATENDDOMINGO = ''S'' THEN 1
                WHEN EXTRACT(WEEKDAY FROM CURRENT_DATE) = 1 AND PESSOA.ATENDSEGUNDA = ''S'' THEN 1
                WHEN EXTRACT(WEEKDAY FROM CURRENT_DATE) = 2 AND PESSOA.ATENDTERCA = ''S'' THEN 1
                WHEN EXTRACT(WEEKDAY FROM CURRENT_DATE) = 3 AND PESSOA.ATENDQUARTA = ''S'' THEN 1
                WHEN EXTRACT(WEEKDAY FROM CURRENT_DATE) = 4 AND PESSOA.ATENDQUINTA = ''S'' THEN 1
                WHEN EXTRACT(WEEKDAY FROM CURRENT_DATE) = 5 AND PESSOA.ATENDSEXTA = ''S'' THEN 1
                WHEN EXTRACT(WEEKDAY FROM CURRENT_DATE) = 6 AND PESSOA.ATENDSABADO = ''S'' THEN 1
              END) = 1';
  END
  ELSE IF (EFILTROAVANCADO = 8) THEN
  BEGIN
    LSQL = LSQL || '     AND NOT EXISTS(SELECT
                                        *
                                      FROM
                                        PESSOA_VENDEDOR PV
                                      WHERE
                                        (PV.CODPESSOA = PESSOA.CODPESSOA)  ) ';
  END
  ELSE IF (EFILTROAVANCADO = 9) THEN
  BEGIN
    LSQL = LSQL || '     AND ( ';
    LSQL = LSQL || '       1 = 1 ';
    LSQL = LSQL || '     AND ( ';
    LSQL = LSQL || '       ('||:LCODVENDEDOR||' = 0) ';
    LSQL = LSQL || '       OR ( ';
    LSQL = LSQL || '         EXISTS(SELECT * FROM PESSOA_VENDEDOR PV WHERE (PV.CODPESSOA = PESSOA.CODPESSOA) AND (PV.CODVENDEDOR = '||:LCODVENDEDOR||')) ';
    LSQL = LSQL || '       ) ';
    LSQL = LSQL || '     ) ';

    LSQL = LSQL || '        AND NOT EXISTS(SELECT * FROM PEDVEND ';
    LSQL = LSQL || '                       WHERE ';
    LSQL = LSQL || '                       PEDVEND.STATUSPED = ''FATURADO'' ';
    LSQL = LSQL || '                       AND PEDVEND.TIPOPED IN (''VENDA'', ''CADERNO'') ';
    LSQL = LSQL || '                       AND (PEDVEND.DTFATURADO between ''' || datetostring(:lprimeirodiames) ||''' and '''|| datetostring(:lultimodiames)||''')';
    LSQL = LSQL || '                       AND PEDVEND.CODPESSOA = PESSOA.CODPESSOA) ';
    LSQL = LSQL || '     ) ';
  END
  else if (EFILTROAVANCADO = 10) then
  begin
    LSQL = LSQL || '        and( exists( SELECT ';
    LSQL = LSQL || '                         * ';
    LSQL = LSQL || '                        FROM ';
    LSQL = LSQL || '                         VENDEDOR_CHECKIN VC ';
    LSQL = LSQL || '                         join vendedor on ';
    LSQL = LSQL || '                           vc.codvendedor = vendedor.codvendedor ';
    LSQL = LSQL || '                       where ';
    LSQL = LSQL || '                         VC.CODPESSOA = PESSOA.CODPESSOA ';
    LSQL = LSQL || '                         and (('||:LCODVENDEDOR||' = 0) or (VENDEDOR.CODVENDEDOR = '||:LCODVENDEDOR||')) ';
    LSQL = LSQL || '                         and VC.DATA_CADASTRO = CURRENT_DATE ';
    LSQL = LSQL || '                         and VC.LONGITUDE IS NOT NULL ';
    LSQL = LSQL || '                         AND VC.LONGITUDE_OUT IS NULL ';
    LSQL = LSQL || '                         and ORIGEM <> ''CARRINHO'') ';
    LSQL = LSQL || '          ) ';
  end

  LSQLCONSULTA = ' SELECT COUNT(*) TOTALREG FROM ( ' ||  LSQL || ' ) ';

  EXECUTE STATEMENT LSQLCONSULTA INTO TOTALREG;

  LSQLCONSULTA = 'SELECT FIRST '||ETAKE||' SKIP '||ESKIP||' * FROM ( ' ||  LSQL || ' ) ';

  IF (EORDENACAO <> '') THEN
  BEGIN
    LSQLCONSULTA = LSQLCONSULTA || ' ORDER BY ';
    LSQLCONSULTA = LSQLCONSULTA || '    '||EORDENACAO||' '||IIF(EDECRESCEMTE = 0, 'DESC', 'ASC');
  END

  FOR EXECUTE STATEMENT
    LSQLCONSULTA
  INTO
    ATIVO,
    CODPESSOA,
    NOME,
    NOMEFANTAZIA,
    PESSOA_CONTATO,
    PESSOA,
    CPFCGC,
    LOGRADOURO_1,
    NUMERO_1,
    COMPLEMENTO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    CODVENDEDOR,
    CODIBGE,
    IE,
    LIMITECRED,
    EMAIL,
    DT_CADAST,
    CODPESSOAMATRIZ,
    FLAG_BLOQUEADO,
    OBSBLOQUEIO,
    STATUSDESC,
    PGT_DESCRICAO,
    PRAZO_MEDIO
  DO
  BEGIN
    CEP_1  = TIRARMASCARA(CEP_1);
    CPFCGC = TIRARMASCARA(CPFCGC);
    SITUACAO_CHECK_IN = 0;
   
    if ((:LCODVENDEDOR <> 0) and exists( SELECT
                                           1
                                         FROM
                                           VENDEDOR_CHECKIN VC
                                         where
                                           VC.CODPESSOA = :CODPESSOA AND 
                                           VC.CODVENDEDOR = :LCODVENDEDOR and
                                           VC.DATA_CADASTRO = CURRENT_DATE AND
                                           VC.LONGITUDE IS NOT NULL AND VC.LONGITUDE_OUT IS NULL AND
                                           ORIGEM <> 'CARRINHO'
                                         order by
                                           VC.CODVENDEDORCHECKIN desc)) THEN
    BEGIN
      SITUACAO_CHECK_IN = 1;
    END
     
    DATA_ULTIMACOMPRA = null;
    SELECT 
      FIRST 1
      cast(p.DTFATURADO as date)
    FROM 
       PEDVEND p 
       JOIN TIPOVENDA ON
         P.tipoped = TIPOVENDA.tipoped
         AND COALESCE(tipovenda.gerafat,0) = 1
     WHERE 
       p.CODPESSOA  = :CODPESSOA
       and p.statusped = 'FATURADO'
     ORDER BY DTFATURADO DESC
     INTO 
       :DATA_ULTIMACOMPRA;
     
     CLIENTE_POSITIVADO = 0;   
     IF(DATA_ULTIMACOMPRA is not null and EXTRACT(MONTH FROM :DATA_ULTIMACOMPRA) = EXTRACT(MONTH FROM CURRENT_DATE) AND EXTRACT(YEAR FROM :DATA_ULTIMACOMPRA) = EXTRACT(YEAR FROM CURRENT_DATE) ) THEN
     BEGIN
       CLIENTE_POSITIVADO = 1;
     END

    SELECT SALDO FROM GET_PESSOASALDO(:CODPESSOA) INTO TOTALCREDITO;

    IF (CODPESSOAMATRIZ > 0) THEN
    BEGIN
      SELECT NOME, LIMITECRED FROM PESSOA WHERE PESSOA.CODPESSOA = :CODPESSOAMATRIZ INTO NOMEPESSOAMATRIZ, LIMITECRED;
    END

    IF (CHAR_LENGTH(CPFCGC) <= 11) THEN
      PESSOA = 1;
    ELSE
      PESSOA = 2;
     
     AGENDA_VENDEDOR = 0;
     CODVENDEDORAGENDA = 0;
     AGENDADO_PARA = NULL;
     AGENDADO_PARA_HORA = NULL;

    SELECT FIRST 1 IIF(v.CODVENDEDORAGENDA IS NOT NULL, 1, 0), v.CODVENDEDORAGENDA, v.AGENDADO_PARA, v.AGENDADO_PARA_HORA
    FROM VENDEDORAGENDA v 
    WHERE v.CODPESSOA = :CODPESSOA AND v.AGENDADO_PARA >= CURRENT_DATE
    INTO
    AGENDA_VENDEDOR,
    CODVENDEDORAGENDA,
     AGENDADO_PARA,
     AGENDADO_PARA_HORA;

    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE DIACCERA_VENDAS(
    EDATAINI DATE,
    EDATAFIM DATE,
    ECOD INTEGER)
RETURNS (
    DUN VARCHAR(30),
    CNPJCLIENTE VARCHAR(18),
    CLIENTE VARCHAR(60),
    CODSEGMENTO INTEGER,
    CNPJDISTRIBUIDOR VARCHAR(18),
    CODVENDEDOR INTEGER,
    DATAVENDA VARCHAR(20),
    TIPOPED VARCHAR(10),
    TIPOPESSOA VARCHAR(1),
    PDV_EMPRESA VARCHAR(60),
    PDV_CEP VARCHAR(9),
    NOME_VENDEDOR VARCHAR(60),
    CODNFVENDA VARCHAR(14),
    VLRVENDIDO VARCHAR(30),
    QTDVENDIDA VARCHAR(30),
    QTDEMBALAGEM INTEGER,
    TIPOCODIGO VARCHAR(10),
    CODGRUPO INTEGER,
    CODPESSOA INTEGER,
    CODSTATUS_CHECKOUT INTEGER,
    ATIVIDADE VARCHAR(60),
    CODPRODFILHO INTEGER,
    QTD NUMERIC(15,2),
    VALOR NUMERIC(15,2),
    CODSUPERVISOR INTEGER,
    CNPJFABRICANTE VARCHAR(20))
AS
DECLARE VARIABLE DTINI DATE;
DECLARE VARIABLE LFABRICANTES VARCHAR(100);
DECLARE VARIABLE LGRUPOS VARCHAR(500);
BEGIN
  SELECT COALESCE(CODFABRICANTE,''), COALESCE(CODGRUPOS,'') FROM INTEGRACAOARQ WHERE IDINTEGRACAOARQ = :ECOD INTO LFABRICANTES, LGRUPOS;
  LFABRICANTES = TRIM(REPLACE(LFABRICANTES,' ',''));
  LGRUPOS = TRIM(REPLACE(LGRUPOS,' ',''));

  SELECT
    TIRARMASCARA(EMPRESA.CGC),
    TIRARMASCARA(EMPRESA.CEP)
  FROM
    EMPRESA
    JOIN INTEGRACAOARQ ON
      EMPRESA.CODEMPRESA = INTEGRACAOARQ.CODEMPRESA
  WHERE
    IDINTEGRACAOARQ = :ECOD
  INTO
    CNPJDISTRIBUIDOR,
    PDV_CEP;

  FOR SELECT
   CASE COALESCE(PRODFILHO.CODPESQ2 ,'')
      WHEN '' THEN
        PRODFILHO.CODPRODFILHO
      ELSE
        PRODFILHO.CODPESQ2
    END DUN,
    TIRARMASCARA(PESSOA.CPFCGC) CNPJCLIENTE,
    PESSOA.NOME CLIENTE,
    PESSOA.NOME,
    TIRARMASCARA(PESSOA.CEP_1),
    CASE COALESCE(TBL_RAMOATVTIPO.REFERENCIA,'')
      WHEN '' THEN 0
      ELSE TBL_RAMOATVTIPO.REFERENCIA
      END CODSEGMENTOPEPSICO,
    PEDVEND.CODVENDEDOR,
    (EXTRACT(YEAR FROM PEDVEND.DTFATURADO) || RIGHT('00'||EXTRACT(MONTH FROM PEDVEND.DTFATURADO),2) || RIGHT('00'||EXTRACT(DAY FROM PEDVEND.DTFATURADO),2)) AS DATAVENDA,
    CASE
      WHEN ((PEDVEND.TIPOPED = 'VENDA') OR (PEDVEND.TIPOPED = 'CADERNO'))  THEN 'V'
      WHEN PEDVEND.TIPOPED = 'BONIFICA' THEN 'B'
      WHEN ((PEDVEND.TIPOPED = 'DEVOLUÇÃO') OR (PEDVEND.TIPOPED = 'DEVOLUCAO'))  THEN 'DV'
      WHEN PEDVEND.TIPOPED = 'CANCELAMENTO' THEN 'C'
      WHEN ((PEDVEND.TIPOPED = 'TRANSFERENCIA') OR (PEDVEND.TIPOPED = 'REMESSA F.'))  THEN 'T'
    END AS TIPOPED,
    COALESCE(PEDVEND.CODNFVENDA,PEDVEND.CODPEDVEND),
    PESSOA.PESSOA,
    COALESCE(NULLIF(PRODFILHO.QTDEMBALAGEM,1),1),
    CAST(CAST(SUM(((COALESCE(PEDVENDITEM.PRECOPROD,0) * COALESCE(PEDVENDITEM.QTDENTREGUE,1))
    + (((COALESCE(PEDVEND.ACRESVALOR,0) + (COALESCE(PEDVEND.VALOR_BRUTO,0) * (COALESCE(PEDVEND.ACRESCIMO,0)/100))) * (COALESCE(PEDVENDITEM.PRECOVEND,0) / COALESCE(NULLIF(PEDVEND.VALOR_BRUTO,1),1))))
    ) - (((COALESCE(PEDVEND.DESC_VALOR,0) + COALESCE(PEDVEND.DESCPERC_VALOR,0)) * (COALESCE(PEDVENDITEM.PRECOVEND,0) / COALESCE(NULLIF(PEDVEND.VALOR_BRUTO,1),1))) + COALESCE(PEDVENDITEM.DESCONTO_VALOR,0))) AS NUMERIC(18,2)) AS VARCHAR(30)) AS VLRVENDIDO,
    CAST(SUM(COALESCE(PEDVENDITEM.QTDE,0)) AS NUMERIC(18,5)) AS QTDVENDIDA,
    PRODUTO.CODGRUPO,
    PEDVEND.CODPESSOA,
    PESSOA.CODSTATUS_CHECKOUT,
    PRODFILHO.CODPRODFILHO
  FROM
    PEDVEND
    JOIN PESSOA ON (PESSOA.CODPESSOA = PEDVEND.CODPESSOA)
    JOIN TBL_RAMOATVTIPO ON (PESSOA.CODTIPOATV = TBL_RAMOATVTIPO.CODTIPO)
    JOIN PEDVENDITEM ON PEDVEND.CODPEDVEND = PEDVENDITEM.CODPEDVEND
    JOIN PRODFILHO ON PEDVENDITEM.CODPRODFILHO =  PRODFILHO.CODPRODFILHO
    JOIN PRODUTO ON PRODFILHO.CODPRODUTO = PRODUTO.CODPRODUTO
  WHERE
    PEDVEND.STATUSPED = 'FATURADO' AND
    PEDVEND.TIPOPED IN ('VENDA','CADERNO','BONIFICA','DEVOLUÇÃO') AND
    PEDVEND.DTFATURADO BETWEEN :EDATAINI AND :EDATAFIM
    AND (
      :LFABRICANTES = '' OR
      ','||:LFABRICANTES||',' CONTAINING ','||PRODUTO.CODFABRICANTE||','
    )
    AND (
      :LGRUPOS = '' OR
      ','||:LGRUPOS||',' CONTAINING ','||PRODUTO.CODGRUPO||','
    )
  GROUP BY
    1,2,3,4,5,6,7,8,9,10,11,12,15,16,17,18
  INTO
    :DUN,
    :CNPJCLIENTE,
    :CLIENTE,
    :PDV_EMPRESA,
    :PDV_CEP,
    :CODSEGMENTO,
    :CODVENDEDOR,
    :DATAVENDA,
    :TIPOPED,
    :CODNFVENDA,
    :TIPOPESSOA,
    :QTDEMBALAGEM,
    :VLRVENDIDO,
    :QTDVENDIDA,
    :CODGRUPO,
    :CODPESSOA,
    :CODSTATUS_CHECKOUT,
    :CODPRODFILHO
  DO
  BEGIN
    QTD = 0;
    VALOR= 0;

    QTD = CAST(COALESCE(QTDVENDIDA,0) AS DOUBLE PRECISION);
    VALOR = CAST(COALESCE(VLRVENDIDO,0) AS DOUBLE PRECISION);

    IF (CHAR_LENGTH(DUN) > 13) THEN
    BEGIN
       QTDVENDIDA = CAST(((CAST(QTDVENDIDA AS DOUBLE PRECISION) / QTDEMBALAGEM) * 1000) AS INTEGER);
       TIPOCODIGO = 'DUN';
    END
    ELSE
    BEGIN
       QTDVENDIDA = CAST((CAST(QTDVENDIDA AS DOUBLE PRECISION) * 1000) AS INTEGER);
       TIPOCODIGO = 'EAN';
    END

    VLRVENDIDO = CAST((CAST(VLRVENDIDO AS DOUBLE PRECISION) * 100) AS INTEGER);

    CODSUPERVISOR = 0;

    SELECT
      VENDEDOR.CODVENDEDOR || ' - ' || VENDEDOR.NOME,
      VENDEDOR.CODSUPERVISOR
    FROM
      VENDEDOR
    WHERE
      VENDEDOR.CODVENDEDOR = :CODVENDEDOR
    INTO
      :NOME_VENDEDOR,
      :CODSUPERVISOR;

    ATIVIDADE = '';

    SELECT STATUS.DESCRICAO FROM STATUS WHERE STATUS.CODSTATUS = :CODSTATUS_CHECKOUT INTO :ATIVIDADE;

    IF (ATIVIDADE = 'S.M. 05 A 09') THEN
    BEGIN
      ATIVIDADE = '5 A 9 CKS';
    END
    ELSE
    BEGIN
      ATIVIDADE = 'TRADICIONAL';
    END
    
    IF (COALESCE(CNPJCLIENTE,'') = '') THEN
    BEGIN
      CNPJCLIENTE = '11111111111111';
    END

    CNPJFABRICANTE = '50955707000472';

    SUSPEND;
  END
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE EDOC_REG0175(
    PART_COD INTEGER)
RETURNS (
    PART_CEP VARCHAR(9),
    PART_ENDE VARCHAR(60),
    PART_NUM VARCHAR(5),
    PART_COMPL VARCHAR(60),
    PART_BAIRRO VARCHAR(60),
    PART_CODCXP VARCHAR(1),
    PART_CXP VARCHAR(1),
    PART_FONE VARCHAR(15),
    PART_FAX VARCHAR(15))
AS
declare variable LCEP varchar(10);
declare variable LNUMERO varchar(100);
declare variable LFONE varchar(120);
declare variable LFAX varchar(120);
declare variable LNUMERO2 varchar(100);
begin
  for select
    P.CEP_1,
    P.LOGRADOURO_1,
    P.NUMERO_1,
    P.COMPLEMENTO_1,
    P.BAIRRO_1,
    P.FONES,
    P.FAX
  from
    PESSOA P
  where
    P.CODPESSOA=:PART_COD
  into
    LCEP,
    PART_ENDE,
    LNUMERO,
    PART_COMPL,
    PART_BAIRRO,
    LFONE,
    LFAX
  do
  begin
    PART_CODCXP = '';
    PART_CXP    = '';

    PART_COMPL  = substring(PART_BAIRRO from 1 for 50);
    PART_BAIRRO = substring(PART_BAIRRO from 1 for 20);

    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:LCEP) into :LCEP;

    select
      R_TRIM
    from
      FU_TRIM(:LCEP)
    into
      LCEP;
      PART_CEP = substring(LCEP from 1 for 8);

    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:LNUMERO)
    into
      LNUMERO;

    select
      R_TRIM
    from
      FU_TRIM(:LNUMERO)
    into
      LNUMERO;
    PART_NUM = substring(LNUMERO from 1 for 5);

    -------
    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:LFONE)
    into
      LFONE;

    select
      R_TRIM
    from
      FU_TRIM(:LFONE)
    into
      LFONE;

    select
      R_ONLYDIGIT
    from
      FU_ONLYDIGIT(:LFONE)
    into
      LFONE;
    PART_FONE = substring(LFONE from 1 for 9);

    if (PART_FONE = '') then
      PART_FONE = '99999999';

    if (CHAR_LENGTH(PART_FONE) < 8) then
      PART_FONE = '99999999';

    -------
    select
      STRRESULT
    from
      FU_GETTIRAMASCARA(:LFAX)
    into
      LFAX;

    select
      R_TRIM
    from
      FU_TRIM(:LFAX)
    into LFAX;

    select
      R_ONLYDIGIT
    from
      FU_ONLYDIGIT(:LFAX)
    into LFAX;
    PART_FAX = substring(LFAX from 1 for 9);

    if (PART_FAX = '') then
      PART_FAX = '99999999';

    if (CHAR_LENGTH(PART_FAX) < 8) then
      PART_FAX = '99999999';

    select
      R_TRIM
    from
      FU_TRIM(:PART_ENDE)
    into
      PART_ENDE;

    select
      R_ONLYDIGIT
    from
      FU_ONLYDIGIT(:PART_ENDE)
    into
      LNUMERO2;

    select
      R_TRIM
    from
      FU_TRIM(:LNUMERO2)
    into
      LNUMERO2;

    LNUMERO2 = substring(LNUMERO2 from 1 for 5);
    LNUMERO2 = cast(LNUMERO2 as varchar(5));

    if ((PART_NUM = '') and (LNUMERO2 <> '')) then
      PART_NUM = LNUMERO2;

    if ((PART_NUM = '') and (LNUMERO2 = '')) then
      PART_NUM = '123';
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE FORNECEDORES_GCI
RETURNS (
    CODPESSOA INTEGER,
    NOMEFANTAZIA VARCHAR(60),
    NOME VARCHAR(60),
    LOGRADOURO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 CHAR(2),
    CEP_1 VARCHAR(9),
    FONES VARCHAR(120),
    FONE2 VARCHAR(60),
    TELEX INTEGER,
    CPFCGC VARCHAR(18),
    IE VARCHAR(30),
    PESSOA_CONTATO VARCHAR(30),
    FAX VARCHAR(14),
    CONTA_CONTABIL INTEGER,
    CGC_PAGAMENTO VARCHAR(10),
    IE_PAGAMENTO VARCHAR(10),
    ENDERECO_PAGAMENTO VARCHAR(10),
    BAIRRO_PAGAMENTO VARCHAR(10),
    CIDADE_PAGAMENTO VARCHAR(10),
    UF_PAGAMENTO VARCHAR(10),
    CEP_PAGAMENTO VARCHAR(10),
    FONE_PAGAMENTO VARCHAR(10),
    DATA_CADASTRO DATE,
    CPFCGC1 VARCHAR(18),
    REGIAO INTEGER,
    NUMERO_ENDERECO INTEGER,
    COMPLEMENTO_1 VARCHAR(60),
    PAIS VARCHAR(10),
    CPF VARCHAR(18))
AS
begin
  for select
    P.CODPESSOA,
    P.NOME NOMEFANTAZIA,
    P.NOME,
    P.LOGRADOURO_1,
    P.BAIRRO_1,
    P.CIDADE_1,
    P.UF_1,
    P.CEP_1,
    P.FONES,
    P.FONE2,
    0 TELEX,
    P.CPFCGC,
    P.IE,
    P.PESSOA_CONTATO,
    P.FAX,
    0 CONTA_CONTABIL,
    '' CGC_PAGAMENTO,
    '' IE_PAGAMENTO,
    '' ENDERECO_PAGAMENTO,
    '' BAIRRO_PAGAMENTO,
    '' CIDADE_PAGAMENTO,
    '' UF_PAGAMENTO,
    '' CEP_PAGAMENTO,
    '' FONE_PAGAMENTO,
    cast(P.DT_CADAST as date),
    P.CPFCGC,
    case P.UF_1
      when 'AC' then 1
      when 'AM' then 1
      when 'AP' then 1
      when 'MA' then 1
      when 'PA' then 1
      when 'RO' then 1
      when 'RR' then 1
      when 'AL' then 2
      when 'BA' then 2
      when 'CE' then 2
      when 'PB' then 2
      when 'PE' then 2
      when 'PI' then 2
      when 'RN' then 2
      when 'SE' then 2
      when 'MS' then 3
      when 'MT' then 3
      when 'TO' then 3
      when 'GO' then 3
      when 'DF' then 3
      when 'ES' then 4
      when 'MG' then 4
      when 'RJ' then 4
      when 'SP' then 4
      when 'RS' then 5
      when 'PR' then 5
      when 'SC' then 5
    end REGIAO,
    0 NUMERO_ENDERECO,
    P.COMPLEMENTO_1,
    '' PAIS
  from
    PESSOA P
  where
    P.TIPOPESSOA = 'Fornecedor'
  into
    CODPESSOA,
    NOMEFANTAZIA,
    NOME,
    LOGRADOURO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    FONE2,
    TELEX,
    CPFCGC,
    IE,
    PESSOA_CONTATO,
    FAX,
    CONTA_CONTABIL,
    CGC_PAGAMENTO,
    IE_PAGAMENTO,
    ENDERECO_PAGAMENTO,
    BAIRRO_PAGAMENTO,
    CIDADE_PAGAMENTO,
    UF_PAGAMENTO,
    CEP_PAGAMENTO,
    FONE_PAGAMENTO,
    DATA_CADASTRO,
    CPFCGC1,
    REGIAO,
    NUMERO_ENDERECO,
    COMPLEMENTO_1,
    PAIS
  do
  begin
    if (CHAR_LENGTH(CPFCGC) < 15) then
    begin
      CPF    = CPFCGC;
      CPFCGC = '';
    end
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE FU_ARREDONDA(
    EVALOR DOUBLE PRECISION,
    EDECIMAIS SMALLINT)
RETURNS (
    VALOR DOUBLE PRECISION)
AS
declare variable LVALOR blob sub_type 1 segment size 80;
declare variable LTAMANHO integer;
declare variable LCONTADOR integer;
declare variable LFATORARREDONDA double precision;
declare variable LCONSTANTE double precision;
begin
  select
    F.RESULTADO
  from
    FU_POTENCIA(10, :EDECIMAIS) F
  into
    LCONSTANTE;

  LVALOR     = EVALOR;
  LTAMANHO   = CHAR_LENGTH(LVALOR);
  while (coalesce(LCONTADOR, 1) <= LTAMANHO) do
  begin
    if (substring(LVALOR from LCONTADOR for 1) in (',', '.')) then
    begin
      LFATORARREDONDA = cast(substring(LVALOR from LCONTADOR + EDECIMAIS - 1 for 2) as smallint);
      LFATORARREDONDA = LFATORARREDONDA / LCONSTANTE;
      if (cast(coalesce(nullif(substring(LVALOR from LCONTADOR + EDECIMAIS + 1 for 1), ''), '0') as smallint) > 4) then
      begin

        select
          F.RESULTADO
        from
          FU_POTENCIA(10, :EDECIMAIS * -1) F
        into
          LCONSTANTE;

        LFATORARREDONDA = LFATORARREDONDA + LCONSTANTE;
      end

      VALOR = cast(substring(LVALOR from 1 for LCONTADOR - 1) as double precision) + LFATORARREDONDA;
      suspend;
      break;
    end

    LCONTADOR = coalesce(LCONTADOR, 1) + 1;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MCTRCITEM(
    CODCTRC INTEGER)
RETURNS (
    CODREMETENTE INTEGER,
    CODIBGER VARCHAR(10),
    CODDESTINATARIO INTEGER,
    CODIBGED VARCHAR(10),
    CODTRANSPORT INTEGER,
    PLACA VARCHAR(10),
    UF VARCHAR(2),
    FRETEVALOR DOUBLE PRECISION)
AS
declare variable LCODPESSOA integer;
begin
  for select
    CTRC_NFVENDA.CODREMETENTE,
    CTRC_NFVENDA.CODDESTINATARIO,
    CTRC_NFVENDA.CODTRANSPORT,
    CTRC_NFVENDA.FRETEVALOR
  from
    CTRC_NFVENDA
  where
    CTRC_NFVENDA.COD_CTRC =:CODCTRC
  into :CODREMETENTE,
       :CODDESTINATARIO,
       :CODTRANSPORT,
       :FRETEVALOR
  do
  begin
    select
      CODIBGE
    from
      MRETORNACODIBGE(:CODREMETENTE)
    into
      :CODIBGER;

    select
      CODIBGE
    from
      MRETORNACODIBGE(:CODDESTINATARIO)
    into
      :CODIBGED;

    select
      TRANSPORT.PLACA,
      TRANSPORT.CODPESSOA
    from
      TRANSPORT
    where
      TRANSPORT.CODTRANSPORT=:CODTRANSPORT
    into
      :PLACA,
      :LCODPESSOA;

    select STRRESULT from FU_GETTIRAMASCARA(:PLACA) into :PLACA;
    select R_TRIM from FU_TRIM(:PLACA) into :PLACA;

    if (CHAR_LENGTH(PLACA) < 7) then
      PLACA = '';

    select
      PESSOA.UF_1
    from
      PESSOA
    where
      PESSOA.CODPESSOA =:LCODPESSOA
    into
      :UF;

    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MCUPOM(
    CODIGO INTEGER)
RETURNS (
    CODCUPOM INTEGER,
    MODELO VARCHAR(2),
    SITUACAO VARCHAR(2),
    COO VARCHAR(10),
    EMISSAO DATE,
    VALOR DOUBLE PRECISION,
    VALORPIS DOUBLE PRECISION,
    VALORCOFINS DOUBLE PRECISION,
    CPFCNPJ VARCHAR(20),
    NOME VARCHAR(60))
AS
declare variable STATUSCUPOM smallint;
begin
  for select
   CUPOM.CODCUPOM,
   coalesce(CUPOM.STATUSCUPOM,1) STATUSCUPOM,
   CUPOM.COO,
   CUPOM.EMISSAO,
   --CUPOM.VALOR_TOTAL,
   CUPOM.VALORPAGO,
   CUPOM.CPFCGC,
   CUPOM.NOME
  from
   CUPOM
  where
   CUPOM.CODCUPOMZ =:CODIGO
  order by 1
  into
   :CODCUPOM,
   :STATUSCUPOM,
   :COO,
   :EMISSAO,
   :VALOR,
   :CPFCNPJ,
   :NOME
  do
  begin
    MODELO = '2D';
  
    if (STATUSCUPOM = 0) then
      SITUACAO = '00';
    else
      SITUACAO = '02';
  
    VALORPIS    = 0;
    VALORCOFINS = 0;
  
    select
      sum(PIS),
      sum(COFINS)
    from
      MECFPISCOFINS2(:CODCUPOM)     
    into
      :VALORPIS,
      :VALORCOFINS;
  
    select STRRESULT from FU_GETTIRAMASCARA(:CPFCNPJ) into :CPFCNPJ;
    select R_TRIM    from FU_TRIM(:CPFCNPJ)           into :CPFCNPJ;
    select R_TRIM    from FU_TRIM(:NOME)              into :NOME;
  
    if (CHAR_LENGTH(CPFCNPJ) < 11) then
    begin
      CPFCNPJ = '';
      NOME    = '';
    end
  
    if ((CPFCNPJ = '00000000000') or (CPFCNPJ = '00000000000000')) then
    begin
      CPFCNPJ = '';
      NOME    = '';
    end
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MNFENTRADAITEM(
    CODNFENTRADA INTEGER,
    TIPOARQ SMALLINT)
RETURNS (
    CODNFENTRADAITENS INTEGER,
    CODCFOP INTEGER,
    CODPRODFILHO INTEGER,
    CODPESQ1 VARCHAR(30),
    CODPESQ2 VARCHAR(30),
    CODPESQ3 VARCHAR(30),
    DESCRICAO VARCHAR(60),
    QTD DOUBLE PRECISION,
    UNID VARCHAR(5),
    PRODVLR DOUBLE PRECISION,
    VALORTOTAL DOUBLE PRECISION,
    VALORBRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    DESPESAS DOUBLE PRECISION,
    MOVFISICA INTEGER,
    CSTICMS VARCHAR(4),
    CFOP VARCHAR(4),
    ICMSBASE DOUBLE PRECISION,
    ICMSPERC DOUBLE PRECISION,
    ICMS DOUBLE PRECISION,
    REDUCAO DOUBLE PRECISION,
    ISENTAS DOUBLE PRECISION,
    OUTRAS DOUBLE PRECISION,
    ICMSSTBASE DOUBLE PRECISION,
    ICMSSTPERC DOUBLE PRECISION,
    ICMSST DOUBLE PRECISION,
    APURACAOIPI INTEGER,
    CSTIPI VARCHAR(2),
    IPIBASE DOUBLE PRECISION,
    IPIPERC DOUBLE PRECISION,
    IPI DOUBLE PRECISION,
    BASE DOUBLE PRECISION,
    ORIGEMDADOS VARCHAR(10),
    CSTPIS VARCHAR(2),
    PIS DOUBLE PRECISION,
    VALORPIS DOUBLE PRECISION,
    CSTCOFINS VARCHAR(2),
    COFINS DOUBLE PRECISION,
    VALORCOFINS DOUBLE PRECISION)
AS
declare variable PARAM_BASEBRUTA varchar(1);
declare variable PARAM_BASEENT varchar(1);
declare variable PARAM_IPI varchar(1);
declare variable PARAM_ST varchar(1);
declare variable PARAM_FRETE varchar(1);
declare variable PARAM_DESCONTO varchar(1);
declare variable PARAM_DESPESAS varchar(1);
declare variable PARAM_ENVIARIPIENT varchar(1);
declare variable PARAM_ENVIARSTENT varchar(1);
declare variable PARAM_RECLASSCSTICMSENT varchar(1);
declare variable ESP_ZERARICMSCST060 varchar(1);
declare variable LPISCST varchar(2);
declare variable LPISPERC double precision;
declare variable LPISVALOR double precision;
declare variable LCOFINSCST varchar(2);
declare variable LCOFINSPERC double precision;
declare variable LCOFINSVALOR double precision;
declare variable CFOP_CSTPIS varchar(2);
declare variable CFOP_PIS double precision;
declare variable CFOP_CSTCOFINS varchar(2);
declare variable CFOP_COFINS double precision;
declare variable PROD_CSTPIS varchar(2);
declare variable PROD_PIS double precision;
declare variable PROD_CSTCOFINS varchar(2);
declare variable PROD_COFINS double precision;
declare variable PROD_CSTIPI varchar(2);
declare variable CODUNIDADE integer;
declare variable LCODUNIDADE integer;
declare variable LCODUNIDADEPROD integer;
declare variable LORIGEM smallint;
declare variable LCST varchar(3);
declare variable LCSTIPI varchar(2);
declare variable LCSTIPIPROD varchar(2);
declare variable LBASEPISCOFINS double precision;
begin
  for select
    NFENTRADAITENS.CODNFENTRADAITENS,
    NFENTRADAITENS.CODCFOP,
    NFENTRADAITENS.CODUNIDADE,
    NFENTRADAITENS.CODPRODFILHO,
    NFENTRADAITENS.PRODVLR,
    NFENTRADAITENS.QTD,
    coalesce(NFENTRADAITENS.TOTAL_NOTA, NFENTRADAITENS.VALORTOTAL),
    coalesce(NFENTRADAITENS.DESCTO_ITEM,0) DESCONTO,
    coalesce(NFENTRADAITENS.FRETEVLRLTDA,0) FRETE,
    coalesce(NFENTRADAITENS.DESP_VALOR,0) DESPESAS,
    coalesce(nullif(NFENTRADAITENS.PRDF_CST_ORIGEM_MERCADORIA,0),0) LORIGEM,
    NFENTRADAITENS.PRDF_CST_TRIBICMS LCST,
    coalesce(NFENTRADAITENS.BASE_ICMS,0) ICMSBASE,
    coalesce(NFENTRADAITENS.DIFICMS,0) ICMSPERC,
    coalesce(NFENTRADAITENS.VL_DIFICMS,0) ICMS,
    coalesce(NFENTRADAITENS.BASE_SUBS,0) ICMSSTBASE,
    coalesce(NFENTRADAITENS.ALIQ_SUBS,0) ICMSSTPERC,
    coalesce(NFENTRADAITENS.VALOR_SUBS,0) ICMSST,
    NFENTRADAITENS.PRDF_CST_IPIENTRADA LCSTIPI,
    coalesce(NFENTRADAITENS.BASE_IPI,0) IPIBASE,
    coalesce(NFENTRADAITENS.IPIPERC,0) IPIPERC,
    coalesce(NFENTRADAITENS.VL_IPIPERC,0) IPI,
    coalesce(nullif(NFENTRADAITENS.PISCST,''),'') LPISCST,
    coalesce(nullif(NFENTRADAITENS.PISPERC,0),0) LPISPERC,
    coalesce(nullif(NFENTRADAITENS.PISVALOR,0),0) LPISVALOR,
    coalesce(nullif(NFENTRADAITENS.COFINSCST,''),'') LCOFINSCST,
    coalesce(nullif(NFENTRADAITENS.COFINSPERC,0),0) LCOFINSPERC,
    coalesce(nullif(NFENTRADAITENS.COFINSVALOR,0),0) LCOFINSVALOR,
    coalesce(nullif(NFENTRADAITENS.BASE_PIS,0),0) LBASEPISCOFINS,
    coalesce(NFENTRADAITENS.REDUCAO_VALOR,0),
    coalesce(NFENTRADAITENS.DESP_VALOR,0)
  from
    NFENTRADAITENS
  where
    NFENTRADAITENS.CODNFENTRADA =:CODNFENTRADA
  into
    :CODNFENTRADAITENS,
    :CODCFOP,
    :LCODUNIDADE,
    :CODPRODFILHO,
    :PRODVLR,
    :QTD,
    :VALORTOTAL,
    :DESCONTO,
    :FRETE,
    :DESPESAS,
    :LORIGEM,
    :LCST,
    :ICMSBASE,
    :ICMSPERC,
    :ICMS,
    :ICMSSTBASE,
    :ICMSSTPERC,
    :ICMSST,
    :LCSTIPI,
    :IPIBASE,
    :IPIPERC,
    :IPI,
    :LPISCST,
    :LPISPERC,
    :LPISVALOR,
    :LCOFINSCST,
    :LCOFINSPERC,
    :LCOFINSVALOR,
    :LBASEPISCOFINS,
    :REDUCAO,
    :OUTRAS
  do
  begin
    MOVFISICA   = 0;
    ORIGEMDADOS = '';
    BASE        = 0;
    CSTPIS      = '';
    PIS         = 0;
    VALORPIS    = 0;
    CSTCOFINS   = '';
    COFINS      = 0;
    VALORCOFINS = 0;
    VALORBRUTO  = PRODVLR * QTD;
    BASE        = VALORBRUTO;
    APURACAOIPI = 0;
    CSTICMS     = LORIGEM || LCST;
    ISENTAS     = 0;

    select
      CFOP.CFOP
    from
      CFOP
    where
      CFOP.CODCFOP=:CODCFOP
    into
      :CFOP;

    select
      coalesce(nullif(CFOP.CSTPISENTRADA,''),''),
      coalesce(nullif(CFOP.CSTCOFINSENTRADA,''),''),
      coalesce(nullif(CFOP.PERCPISCOMPRA,0),0),
      coalesce(nullif(CFOP.PERCCONFINSCOMPRA,0),0)
    from
      CFOP
    where
      CFOP.CODCFOP =:CODCFOP
    into
      :CFOP_CSTPIS,
      :CFOP_CSTCOFINS,
      :CFOP_PIS,
      :CFOP_COFINS;

    select R_TRIM from FU_TRIM(:CFOP_CSTPIS) into :CFOP_CSTPIS;

    select
      DESCRICAO,
      CODPESQ1,
      CODPESQ2,
      CODPESQ3,
      CSTPISENTRADA,
      CSTCOFINSENTRADA,
      PISENTRADA,
      COFINSENTRADA,
      CSTIPIENTRADA
    from
      MPRODUTOSAUX(:CODPRODFILHO)
    into
      :DESCRICAO,
      :CODPESQ1,
      :CODPESQ2,
      :CODPESQ3,
      :PROD_CSTPIS,
      :PROD_CSTCOFINS,
      :PROD_PIS,
      :PROD_COFINS,
      :PROD_CSTIPI;

    select R_TRIM from FU_TRIM(:PROD_CSTPIS) into :PROD_CSTPIS;
    
    LCODUNIDADEPROD = coalesce(LCODUNIDADEPROD,0);
    LCODUNIDADE     = coalesce(LCODUNIDADE,0);
    if (LCODUNIDADE > 0) then
      CODUNIDADE = LCODUNIDADE;
    else
      CODUNIDADE = LCODUNIDADEPROD;

    select
      UNIDADE.SIGLA
    from
      UNIDADE
    where
      UNIDADE.CODUNIDADE =:CODUNIDADE
    into
      UNID;

    -- Reclassificar do CST de IPI.
    CSTIPI = coalesce(nullif(LCSTIPI,LCSTIPIPROD),LCSTIPIPROD);
    CSTIPI = coalesce(nullif(CSTIPI,''),'');
    if (CSTIPI = '') then
    begin
     if (IPI > 0) then
      CSTIPI = '00';
     else
      CSTIPI = '02';
    end

    select
      PARAM_BASEBRUTA,
      PARAM_IPI,
      PARAM_ST,
      PARAM_FRETE,
      PARAM_DESCONTO,
      PARAM_DESPESAS,
      PARAM_ENVIARIPIENT,
      PARAM_ENVIARSTENT,
      PARAM_RECLASSCSTICMSENT,
      ESP_ZERARICMSCST060,
      PARAM_BASEENT
    from
      MPARAMETROS(:TIPOARQ)
    into
      :PARAM_BASEBRUTA,
      :PARAM_IPI,
      :PARAM_ST,
      :PARAM_FRETE,
      :PARAM_DESCONTO,
      :PARAM_DESPESAS,
      :PARAM_ENVIARIPIENT,
      :PARAM_ENVIARSTENT,
      :PARAM_RECLASSCSTICMSENT,
      :ESP_ZERARICMSCST060,
      :PARAM_BASEENT;

    if ((PARAM_BASEENT = 'S') and (PARAM_BASEBRUTA = 'S')) then
    begin
      BASE = VALORBRUTO;
      if (PARAM_IPI  = 'S') then
        BASE = BASE + IPI;
  
      if (PARAM_ST  = 'S') then
        BASE = BASE + ICMSST;
  
      if (PARAM_FRETE = 'S') then
        BASE = BASE + FRETE;
  
      if (PARAM_DESCONTO = 'S') then
        BASE = BASE - DESCONTO;

      if (PARAM_DESPESAS = 'S') then
        BASE = BASE + DESPESAS;
    end

    if (LPISCST <> '') then -- Dados da Nota
    begin
      CSTPIS      = LPISCST;
      PIS         = LPISPERC;
      VALORPIS    = LPISVALOR;
      CSTCOFINS   = LCOFINSCST;
      COFINS      = LCOFINSPERC;
      VALORCOFINS = LCOFINSVALOR;
      ORIGEMDADOS = 'NF';
      BASE        = LBASEPISCOFINS;
    end else
    if (CFOP_CSTPIS <> '') then -- Dados do CFOP
    begin
      CSTPIS      = CFOP_CSTPIS;
      PIS         = CFOP_PIS;
      VALORPIS    = (BASE * CFOP_PIS) / 100;
      CSTCOFINS   = CFOP_CSTCOFINS;
      COFINS      = CFOP_COFINS;
      VALORCOFINS = (BASE * CFOP_COFINS) / 100;
      ORIGEMDADOS = 'CFOP';
    end else
    if (PROD_CSTPIS <> '') then -- Dados do CFOP
    begin
      CSTPIS      = PROD_CSTPIS;
      PIS         = PROD_PIS;
      VALORPIS    = (BASE * PROD_PIS) / 100;
      CSTCOFINS   = PROD_CSTCOFINS;
      COFINS      = PROD_COFINS;
      VALORCOFINS = (BASE * PROD_COFINS) / 100;
      ORIGEMDADOS = 'PRODUTO';
    end

    if ((CSTPIS <> '70') and (CSTPIS <> '71') and (CSTPIS <> '72') and (CSTPIS <> '73') and
        (CSTPIS <> '74') and (CSTPIS <> '98') and (CSTPIS <> '99')) then
    begin
      BASE        = cast(BASE as numeric(18,2));
      PIS         = cast(PIS as numeric(18,2));
      VALORPIS    = cast(VALORPIS as numeric(18,2));
      COFINS      = cast(COFINS as numeric(18,2));
      VALORCOFINS = cast(VALORCOFINS as numeric(18,2));
    end else
    begin
      BASE        = 0;
      PIS         = 0;
      VALORPIS    = 0;
      COFINS      = 0;
      VALORCOFINS = 0;
    end

    -- Verificando os Parâmetros para envio do IPI.
    if (PARAM_ENVIARIPIENT = 'N') then
    begin
      IPIBASE = 0;
      IPIPERC = 0;
      IPI     = 0;
    end

    -- Verificando os Parâmetros para envio da ST.
    if (PARAM_ENVIARSTENT = 'N') then
    begin
      ICMSST     = 0;
      ICMSSTBASE = 0;
      ICMSSTPERC = 0;
    end


    -- Reclassificando o CST de ICMS.
    if (CHAR_LENGTH(CSTICMS) <= 2) then
    begin
      if (ICMS = 0) then
        CSTICMS = '040';

      if ((ICMS > 0) and (ICMSST > 0)) then
        CSTICMS = '010';

      if ((ICMS > 0) and (ICMSST = 0)) then
        CSTICMS = '000';

      if ((ICMS = 0) and (ICMSST > 0)) then
        CSTICMS = '060';
    end

    if (PARAM_RECLASSCSTICMSENT = 'S') then
    begin
      if (ICMS = 0) then
        CSTICMS = '040';

      if ((ICMS > 0) and (ICMSST > 0)) then
        CSTICMS = '010';

      if ((ICMS > 0) and (ICMSST = 0)) then
        CSTICMS = '000';

      if ((ICMS = 0) and (ICMSST > 0)) then
        CSTICMS = '060';
    end

    -- Parãmetro especifico para zerar o ICMS Normal.
    if ((ESP_ZERARICMSCST060 = 'S') and (CSTICMS = '060') and
       (CFOP in ('1403','2403','1652','2652')) and (ICMSSTPERC > 0) and (ICMSST > 0)) then
    begin
      ICMSBASE = 0;
      ICMSPERC = 0;
      ICMS     = 0;
    end

    PRODVLR     = cast(PRODVLR as numeric(18,2));
    VALORTOTAL  = cast(VALORTOTAL as numeric(18,2));
    DESCONTO    = cast(DESCONTO as numeric(18,2));
    FRETE       = cast(FRETE as numeric(18,2));
    DESPESAS    = cast(DESPESAS as numeric(18,2));
    ICMSBASE    = cast(ICMSBASE as numeric(18,2));
    ICMSPERC    = cast(ICMSPERC as numeric(18,2));
    ICMS        = cast(ICMS as numeric(18,2));
    ICMSSTBASE  = cast(ICMSSTBASE as numeric(18,2));
    ICMSSTPERC  = cast(ICMSSTPERC as numeric(18,2));
    ICMSST      = cast(ICMSST as numeric(18,2));
    IPIBASE     = cast(IPIBASE as numeric(18,2));
    IPIPERC     = cast(IPIPERC as numeric(18,2));
    IPI         = cast(IPI as numeric(18,2));

    ISENTAS     = (VALORBRUTO - ICMSBASE);
    if (ISENTAS < 0) then
      ISENTAS     = 0;
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MNFVENDAITEM(
    CODNFVENDA INTEGER,
    SERIE VARCHAR(3),
    TIPONOTA VARCHAR(1),
    TIPOARQ SMALLINT)
RETURNS (
    CODNFVENDAITEM INTEGER,
    CODCFOP INTEGER,
    CODPRODFILHO INTEGER,
    CODPESQ1 VARCHAR(30),
    CODPESQ2 VARCHAR(30),
    CODPESQ3 VARCHAR(30),
    DESCRICAO VARCHAR(60),
    QTD DOUBLE PRECISION,
    UNID VARCHAR(5),
    PRODVLR DOUBLE PRECISION,
    VALORTOTAL DOUBLE PRECISION,
    VALORBRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    FRETE DOUBLE PRECISION,
    DESPESAS DOUBLE PRECISION,
    MOVFISICA INTEGER,
    CSTICMS VARCHAR(4),
    CFOP VARCHAR(4),
    ICMSBASE DOUBLE PRECISION,
    ICMSPERC DOUBLE PRECISION,
    ICMS DOUBLE PRECISION,
    REDUCAO DOUBLE PRECISION,
    ISENTAS DOUBLE PRECISION,
    OUTRAS DOUBLE PRECISION,
    ICMSSTBASE DOUBLE PRECISION,
    ICMSSTPERC DOUBLE PRECISION,
    ICMSST DOUBLE PRECISION,
    APURACAOIPI INTEGER,
    CSTIPI VARCHAR(2),
    IPIBASE DOUBLE PRECISION,
    IPIPERC DOUBLE PRECISION,
    IPI DOUBLE PRECISION,
    BASE DOUBLE PRECISION,
    ORIGEMDADOS VARCHAR(10),
    CSTPIS VARCHAR(2),
    PIS DOUBLE PRECISION,
    VALORPIS DOUBLE PRECISION,
    CSTCOFINS VARCHAR(2),
    COFINS DOUBLE PRECISION,
    VALORCOFINS DOUBLE PRECISION,
    C176_MODELO VARCHAR(2),
    C176_DOCUMENTO VARCHAR(15),
    C176_SERIE VARCHAR(3),
    C176_DTEMISSAO TIMESTAMP,
    C176_CODPESSOA INTEGER,
    C176_QTD DOUBLE PRECISION,
    C176_PRODVLR DOUBLE PRECISION,
    C176_BASE_SUBS DOUBLE PRECISION)
AS
declare variable PARAM_BASEBRUTA varchar(1);
declare variable PARAM_BASE varchar(1);
declare variable PARAM_IPI varchar(1);
declare variable PARAM_ST varchar(1);
declare variable PARAM_FRETE varchar(1);
declare variable PARAM_DESCONTO varchar(1);
declare variable PARAM_DESPESAS varchar(1);
declare variable PARAM_ENVIARIPI varchar(1);
declare variable PARAM_ENVIARIPIENT varchar(1);
declare variable PARAM_ENVIARST varchar(1);
declare variable PARAM_ENVIARSTENT varchar(1);
declare variable PARAM_RECLASSCSTICMS varchar(1);
declare variable PARAM_RECLASSCSTICMSENT varchar(1);
declare variable LPISCST varchar(2);
declare variable LPISPERC double precision;
declare variable LPISVALOR double precision;
declare variable LCOFINSCST varchar(2);
declare variable LCOFINSPERC double precision;
declare variable LCOFINSVALOR double precision;
declare variable CFOP_CSTPIS varchar(2);
declare variable CFOP_PIS double precision;
declare variable CFOP_CSTCOFINS varchar(2);
declare variable CFOP_COFINS double precision;
declare variable CFOP_CSTPISENTRADA varchar(2);
declare variable CFOP_PISENTRADA double precision;
declare variable CFOP_CSTCOFINSENTRADA varchar(2);
declare variable CFOP_COFINSENTRADA double precision;
declare variable PROD_CODUNIDADE integer;
declare variable PROD_UNID varchar(5);
declare variable PROD_CSTPIS varchar(2);
declare variable PROD_PIS double precision;
declare variable PROD_CSTCOFINS varchar(2);
declare variable PROD_COFINS double precision;
declare variable PROD_CSTPISENTRADA varchar(2);
declare variable PROD_PISENTRADA double precision;
declare variable PROD_CSTCOFINSENTRADA varchar(2);
declare variable PROD_COFINSENTRADA double precision;
declare variable PROD_CSTIPI varchar(2);
declare variable PROD_CSTIPIENTRADA varchar(2);
declare variable LCODUNIDADE integer;
declare variable LCST varchar(3);
declare variable DT_EMISSAO timestamp;
declare variable ESP_C176 varchar(1);
declare variable LBASEPISCOFINS double precision;
begin
  for select
    NFVENDAITEM.CODNFVENDAITEM,
    NFVENDAITEM.CODCFOP,
    NFVENDAITEM.CODUNIDADE,
    NFVENDAITEM.CODPRODFILHO,
    NFVENDAITEM.PRECOVEND,
    NFVENDAITEM.QTDE,
    coalesce(NFVENDAITEM.TOTALVLRNOTA, NFVENDAITEM.TOTALVLR),
    coalesce(NFVENDAITEM.DESCVLR,0) DESCONTO,
    coalesce(NFVENDAITEM.FRETE_VLR,0) FRETE,
    coalesce(NFVENDAITEM.ODESP_VALOR,0) DESPESAS,
    coalesce(nullif(NFVENDAITEM.CST,''),'') LCST,
    coalesce(NFVENDAITEM.ICMSBASE,0) ICMSBASE,
    coalesce(NFVENDAITEM.ICMSPERC,0) ICMSPERC,
    coalesce(NFVENDAITEM.ICMSVALOR,0) ICMS,
    coalesce(NFVENDAITEM.BASE_SUBS,0) ICMSSTBASE,
    coalesce(NFVENDAITEM.ALIQ_SUBS,0) ICMSSTPERC,
    coalesce(NFVENDAITEM.VA_VALOR,0) ICMSST,
    coalesce(NFVENDAITEM.IPIBASE,0) IPIBASE,
    coalesce(NFVENDAITEM.IPIPERC,0) IPIPERC,
    coalesce(NFVENDAITEM.IPIVALOR,0) IPI,
    coalesce(nullif(NFVENDAITEM.PISCST,''),'') LPISCST,
    coalesce(nullif(NFVENDAITEM.PISPERC,0),0) LPISPERC,
    coalesce(nullif(NFVENDAITEM.PISVALOR,0),0) LPISVALOR,
    coalesce(nullif(NFVENDAITEM.COFINSCST,''),'') LCOFINSCST,
    coalesce(nullif(NFVENDAITEM.COFINSPERC,0),0) LCOFINSPERC,
    coalesce(nullif(NFVENDAITEM.COFINSVALOR,0),0) LCOFINSVALOR,
    coalesce(nullif(NFVENDAITEM.BASE_PIS,0),0) LBASEPISCOFINS,
    coalesce(NFVENDAITEM.VALOR_REDUCAO,0),
    coalesce(NFVENDAITEM.ODESP_VALOR,0)
  from
    NFVENDAITEM
  where
    NFVENDAITEM.CODNFVENDA =:CODNFVENDA and
    NFVENDAITEM.SERIE =:SERIE
  into
    :CODNFVENDAITEM,
    :CODCFOP,
    :LCODUNIDADE,
    :CODPRODFILHO,
    :PRODVLR,
    :QTD,
    :VALORTOTAL,
    :DESCONTO,
    :FRETE,
    :DESPESAS,
    :LCST,
    :ICMSBASE,
    :ICMSPERC,
    :ICMS,
    :ICMSSTBASE,
    :ICMSSTPERC,
    :ICMSST,
    :IPIBASE,
    :IPIPERC,
    :IPI,
    :LPISCST,
    :LPISPERC,
    :LPISVALOR,
    :LCOFINSCST,
    :LCOFINSPERC,
    :LCOFINSVALOR,
    :LBASEPISCOFINS,
    :REDUCAO,
    :OUTRAS
  do
  begin
    MOVFISICA   = 0;
    ORIGEMDADOS = '';
    BASE        = 0;
    CSTPIS      = '';
    PIS         = 0;
    VALORPIS    = 0;
    CSTCOFINS   = '';
    COFINS      = 0;
    VALORCOFINS = 0;
    VALORBRUTO  = PRODVLR * QTD;
    BASE        = VALORTOTAL;
    APURACAOIPI = 0;
    CSTICMS     = LCST;
    LCODUNIDADE = coalesce(LCODUNIDADE,0);
    ISENTAS     = 0;

    select
      CFOP.CFOP,
      coalesce(nullif(CFOP.CSTPIS,''),''),
      coalesce(nullif(CFOP.CSTCOFINS,''),''),
      coalesce(nullif(CFOP.PERC_PIS,0),0),
      coalesce(nullif(CFOP.PERC_COFINS,0),0),
      coalesce(nullif(CFOP.CSTPISENTRADA,''),''),
      coalesce(nullif(CFOP.CSTCOFINSENTRADA,''),''),
      coalesce(nullif(CFOP.PERCPISCOMPRA,0),0),
      coalesce(nullif(CFOP.PERCCONFINSCOMPRA,0),0)
    from
      CFOP
    where
      CFOP.CODCFOP=:CODCFOP
    into
      :CFOP,
      :CFOP_CSTPIS,
      :CFOP_CSTCOFINS,
      :CFOP_PIS,
      :CFOP_COFINS,
      :CFOP_CSTPISENTRADA,
      :CFOP_CSTCOFINSENTRADA,
      :CFOP_PISENTRADA,
      :CFOP_COFINSENTRADA;

    select
      DESCRICAO,
      CODPESQ1,
      CODPESQ2,
      CODPESQ3,
      CODUNIDADE,
      UNID,
      CSTPIS,
      CSTCOFINS,
      PIS,
      COFINS,
      CSTPISENTRADA,
      CSTCOFINSENTRADA,
      PISENTRADA,
      COFINSENTRADA,
      CSTIPI,
      CSTIPIENTRADA
    from
      MPRODUTOSAUX(:CODPRODFILHO)
    into
      :DESCRICAO,
      :CODPESQ1,
      :CODPESQ2,
      :CODPESQ3,
      :PROD_CODUNIDADE,
      :PROD_UNID,
      :PROD_CSTPIS,
      :PROD_CSTCOFINS,
      :PROD_PIS,
      :PROD_COFINS,
      :PROD_CSTPISENTRADA,
      :PROD_CSTCOFINSENTRADA,
      :PROD_PISENTRADA,
      :PROD_COFINSENTRADA,
      :PROD_CSTIPI,
      :PROD_CSTIPIENTRADA;

    if ((LCODUNIDADE <= 0) or (LCODUNIDADE = PROD_CODUNIDADE)) then
      UNID = PROD_UNID;
    else
    if ((LCODUNIDADE > 0) and (LCODUNIDADE <> PROD_CODUNIDADE)) then
      select UNIDADE.SIGLA from UNIDADE where UNIDADE.CODUNIDADE=:LCODUNIDADE into :UNID;

    -- Reclassificar do CST de IPI.
    if (TIPONOTA = 'S') then
    begin
      if (PROD_CSTIPI = '') then
        CSTIPI = '99';
      else
        CSTIPI = PROD_CSTIPI;

      if ((CSTIPI = '51') or (CSTIPI = '52')) then
      begin
        IPI     = 0;
        IPIBASE = 0;
        IPIPERC = 0;
      end
    end
    if (TIPONOTA = 'E') then
    begin
      if (PROD_CSTIPIENTRADA = '') then
        CSTIPI = '49';
      else
        CSTIPI = PROD_CSTIPIENTRADA;

      if ((CSTIPI = '01') or (CSTIPI = '02')) then
      begin
        IPI     = 0;
        IPIBASE = 0;
        IPIPERC = 0;
      end
    end

    if ((IPIPERC > 0) and (IPIBASE <= 0)) then
      IPIBASE = VALORBRUTO;

    if ((IPIPERC <= 0) and (IPIBASE > 0)) then
    begin
      IPIBASE = 0;
      IPIPERC = 0;
      IPI     = 0;
    end

    -- Cálculando a Base de Pis/Cofins.
    select
      PARAM_BASEBRUTA,
      PARAM_IPI,
      PARAM_ST,
      PARAM_FRETE,
      PARAM_DESCONTO,
      PARAM_DESPESAS,
      PARAM_ENVIARIPI,
      PARAM_ENVIARIPIENT,
      PARAM_ENVIARST,
      PARAM_ENVIARSTENT,
      PARAM_RECLASSCSTICMS,
      PARAM_RECLASSCSTICMSENT,
      PARAM_BASE,
      ESP_C176
    from
      MPARAMETROS(:TIPOARQ)
    into
      :PARAM_BASEBRUTA,
      :PARAM_IPI,
      :PARAM_ST,
      :PARAM_FRETE,
      :PARAM_DESCONTO,
      :PARAM_DESPESAS,
      :PARAM_ENVIARIPI,
      :PARAM_ENVIARIPIENT,
      :PARAM_ENVIARST,
      :PARAM_ENVIARSTENT,
      :PARAM_RECLASSCSTICMS,
      :PARAM_RECLASSCSTICMSENT,
      :PARAM_BASE,
      :ESP_C176;

    if ((PARAM_BASE = 'S') and (PARAM_BASEBRUTA = 'S')) then
    begin
      BASE = VALORBRUTO;
      if (PARAM_IPI  = 'S') then
        BASE = BASE + IPI;
  
      if (PARAM_ST  = 'S') then
        BASE = BASE + ICMSST;
  
      if (PARAM_FRETE = 'S') then
        BASE = BASE + FRETE;
  
      if (PARAM_DESCONTO = 'S') then
        BASE = BASE - DESCONTO;

      if (PARAM_DESPESAS = 'S') then
        BASE = BASE + DESPESAS;
    end

    if (TIPONOTA = 'S') then
    begin
      if (LPISCST <> '') then -- Dados da Nota
      begin
        CSTPIS      = LPISCST;
        PIS         = LPISPERC;
        VALORPIS    = LPISVALOR;
        CSTCOFINS   = LCOFINSCST;
        COFINS      = LCOFINSPERC;
        VALORCOFINS = LCOFINSVALOR;
        ORIGEMDADOS = 'NF';
        BASE        = LBASEPISCOFINS;
      end else
      if (CFOP_CSTPIS <> '') then -- Dados do Produto
      begin
        CSTPIS      = CFOP_CSTPIS;
        PIS         = CFOP_PIS;
        VALORPIS    = (BASE * CFOP_PIS) / 100;
        CSTCOFINS   = CFOP_CSTCOFINS;
        COFINS      = CFOP_COFINS;
        VALORCOFINS = (BASE * CFOP_COFINS) / 100;
        ORIGEMDADOS = 'CFOP';
      end else
      if (PROD_CSTPIS <> '') then -- Dados do Produto
      begin
        CSTPIS      = PROD_CSTPIS;
        PIS         = PROD_PIS;
        VALORPIS    = (BASE * PROD_PIS) / 100;
        CSTCOFINS   = PROD_CSTCOFINS;
        COFINS      = PROD_COFINS;
        VALORCOFINS = (BASE * PROD_COFINS) / 100;
        ORIGEMDADOS = 'PRODUTO';
      end

      if ((CSTPIS <> '06') and (CSTPIS <> '07') and (CSTPIS <> '08') and (CSTPIS <> '09')) then
      begin
        BASE        = cast(BASE as numeric(18,2));
        PIS         = cast(PIS as numeric(18,2));
        VALORPIS    = cast(VALORPIS as numeric(18,2));
        COFINS      = cast(COFINS as numeric(18,2));
        VALORCOFINS = cast(VALORCOFINS as numeric(18,2));
      end else
      begin
        BASE        = 0;
        PIS         = 0;
        VALORPIS    = 0;
        COFINS      = 0;
        VALORCOFINS = 0;
      end

      -- Verificando os Parâmetros para envio do IPI.
      if (PARAM_ENVIARIPI = 'N') then
      begin
        IPIBASE = 0;
        IPIPERC = 0;
        IPI     = 0;
      end
  
      -- Verificando os Parâmetros para envio da ST.
      if  (PARAM_ENVIARST = 'N') then
      begin
        ICMSST     = 0;
        ICMSSTBASE = 0;
        ICMSSTPERC = 0;
      end

      -- Reclassificando o CST de ICMS.
      if ((CHAR_LENGTH(CSTICMS) <= 2) or (PARAM_RECLASSCSTICMS = 'S')) then
      begin
        if (ICMS = 0) then
          CSTICMS = '040';
  
        if ((ICMS > 0) and (ICMSST > 0)) then
          CSTICMS = '010';
  
        if ((ICMS > 0) and (ICMSST = 0)) then
          CSTICMS = '000';
  
        if ((ICMS = 0) and (ICMSST > 0)) then
          CSTICMS = '060';
      end
    end else
    if (TIPONOTA = 'E') then
    begin
      if (LPISCST <> '') then -- Dados da Nota
      begin
        CSTPIS      = LPISCST;
        PIS         = LPISPERC;
        VALORPIS    = LPISVALOR;
        CSTCOFINS   = LCOFINSCST;
        COFINS      = LCOFINSPERC;
        VALORCOFINS = LCOFINSVALOR;
        ORIGEMDADOS = 'NF';
        BASE        = LBASEPISCOFINS;
      end else
      if (CFOP_CSTPISENTRADA <> '') then -- Dados do CFOP
      begin
        CSTPIS      = CFOP_CSTPISENTRADA;
        PIS         = CFOP_PISENTRADA;
        VALORPIS    = (BASE * CFOP_PISENTRADA) / 100;
        CSTCOFINS   = CFOP_CSTCOFINSENTRADA;
        COFINS      = CFOP_COFINSENTRADA;
        VALORCOFINS = (BASE * CFOP_COFINSENTRADA) / 100;
        ORIGEMDADOS = 'CFOP';
      end else
      if (PROD_CSTPISENTRADA <> '') then -- Dados do CFOP
      begin
        CSTPIS      = PROD_CSTPISENTRADA;
        PIS         = PROD_PISENTRADA;
        VALORPIS    = (BASE * PROD_PISENTRADA) / 100;
        CSTCOFINS   = PROD_CSTCOFINSENTRADA;
        COFINS      = PROD_COFINSENTRADA;
        VALORCOFINS = (BASE * PROD_COFINSENTRADA) / 100;
        ORIGEMDADOS = 'PRODUTO';
      end

      if ((CSTPIS <> '70') and (CSTPIS <> '71') and (CSTPIS <> '72') and (CSTPIS <> '73') and
          (CSTPIS <> '74') and (CSTPIS <> '98') and (CSTPIS <> '99')) then
      begin
        BASE        = cast(BASE as numeric(18,2));
        PIS         = cast(PIS as numeric(18,2));
        VALORPIS    = cast(VALORPIS as numeric(18,2));
        COFINS      = cast(COFINS as numeric(18,2));
        VALORCOFINS = cast(VALORCOFINS as numeric(18,2));
      end else
      begin
        BASE        = 0;
        PIS         = 0;
        VALORPIS    = 0;
        COFINS      = 0;
        VALORCOFINS = 0;
      end

      -- Verificando os Parâmetros para envio do IPI.
      if (PARAM_ENVIARIPIENT = 'N') then
      begin
        IPIBASE = 0;
        IPIPERC = 0;
        IPI     = 0;
      end
  
      -- Verificando os Parâmetros para envio da ST.
      if  (PARAM_ENVIARSTENT = 'N') then
      begin
        ICMSST     = 0;
        ICMSSTBASE = 0;
        ICMSSTPERC = 0;
      end

      -- Reclassificando o CST de ICMS.
      if ((CHAR_LENGTH(CSTICMS) <= 2) or (PARAM_RECLASSCSTICMSENT = 'S')) then
      begin
        if (ICMS = 0) then
          CSTICMS = '040';
  
        if ((ICMS > 0) and (ICMSST > 0)) then
          CSTICMS = '010';
  
        if ((ICMS > 0) and (ICMSST = 0)) then
          CSTICMS = '000';
  
        if ((ICMS = 0) and (ICMSST > 0)) then
          CSTICMS = '060';
      end
    end

    PRODVLR     = cast(PRODVLR as numeric(18,2));
    VALORTOTAL  = cast(VALORTOTAL as numeric(18,2));
    DESCONTO    = cast(DESCONTO as numeric(18,2));
    FRETE       = cast(FRETE as numeric(18,2));
    DESPESAS    = cast(DESPESAS as numeric(18,2));
    ICMSBASE    = cast(ICMSBASE as numeric(18,2));
    ICMSPERC    = cast(ICMSPERC as numeric(18,2));
    ICMS        = cast(ICMS as numeric(18,2));
    ICMSSTBASE  = cast(ICMSSTBASE as numeric(18,2));
    ICMSSTPERC  = cast(ICMSSTPERC as numeric(18,2));
    ICMSST      = cast(ICMSST as numeric(18,2));
    IPIBASE     = cast(IPIBASE as numeric(18,2));
    IPIPERC     = cast(IPIPERC as numeric(18,2));
    IPI         = cast(IPI as numeric(18,2));

    ISENTAS     = (VALORBRUTO - ICMSBASE);
    if (ISENTAS < 0) then
      ISENTAS     = 0;

    if (ESP_C176 = 'S') then
    begin
      select
        NFVENDA.DT_EMISSAO
      from
        NFVENDA
      where
        NFVENDA.CODNFVENDA =:CODNFVENDA and
        NFVENDA.SERIE =:SERIE
      into
        :DT_EMISSAO;

      C176_MODELO    = '55';
      C176_DOCUMENTO = '999';
      C176_SERIE     = '1';
      C176_DTEMISSAO = '01.01.1900';
      C176_CODPESSOA = 0;
      C176_QTD       = 0;
      C176_PRODVLR   = 0;
      C176_BASE_SUBS = 0;

      select
        MODELO, 
        DOCUMENTO, 
        SERIE, 
        DTEMISSAO, 
        CODPESSOA, 
        QTD, 
        PRODVLR, 
        BASE_SUBS
      from
        MRESSARCIMENTOST(:CODPRODFILHO,:DT_EMISSAO)
      into
        :C176_MODELO,
        :C176_DOCUMENTO,
        :C176_SERIE,
        :C176_DTEMISSAO,
        :C176_CODPESSOA,
        :C176_QTD,
        :C176_PRODVLR,
        :C176_BASE_SUBS;
    end
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE MVALIDANFEIBGE(
    ECODPEDVEND INTEGER,
    ECODANALISECRITERIO INTEGER)
RETURNS (
    APROVADO VARCHAR(1))
AS
declare variable LMENSAGEM varchar(200);
declare variable LCAMPOS varchar(130);
declare variable LCODIBGE integer;
declare variable LTIPOPED varchar(10);
declare variable LCODBAIRRO1 integer;
declare variable LCODIBGECIDADE varchar(7);
BEGIN
  /* ROTINA QUE VERIFICA OS CAMPOS OBRIGATORIOS DA PESSOA FORAM PREENCHIDOS */
  APROVADO = 'S';
  LCAMPOS = '';
  IF (NOT EXISTS(SELECT CODIGO FROM PEDVEND_VALIDADOSNFE WHERE CODPEDVEND = :ECODPEDVEND AND

  TIPO_CRITICA = :ECODANALISECRITERIO AND USUARIO_LIBEROU IS NOT NULL)) THEN
  BEGIN
    DELETE FROM
      PEDVEND_VALIDADOSNFE
    WHERE
      CODPEDVEND = :ECODPEDVEND AND
      TIPO_CRITICA = :ECODANALISECRITERIO;

    SELECT
      coalesce(PS.CODIBGE,0),
      p.tipoped,
      PS.CODBAIRRO1
    FROM
      PEDVEND P JOIN PESSOA PS ON P.CODPESSOA = PS.CODPESSOA
    WHERE
      CODPEDVEND = :ECODPEDVEND and P.TIPOPED <> 'CADERNO'
    into
      :LCODIBGE,
      :LTIPOPED,
      :LCODBAIRRO1;

    select TBL_CIDADES.CODIBGE from TBL_BAIRRO
    inner join TBL_CIDADES on TBL_CIDADES.CODCIDADE = TBL_BAIRRO.CODCIDADE
    inner join TBL_ESTADO on TBL_CIDADES.CODESTADO = TBL_ESTADO.CODESTADO
    where TBL_BAIRRO.CODBAIRRO = :LCODBAIRRO1
    into :LCODIBGECIDADE;

    if (CHAR_LENGTH(LCODIBGECIDADE) = 7) then
    begin
       LCODIBGE = LCODIBGECIDADE;
    end

    if ((coalesce(LCODIBGE,0) = 0) and (LTIPOPED <> 'CADERNO')) then
    begin
      APROVADO = 'N';
      LMENSAGEM = 'O CLIENTE SEM O CÓDIGO IBGE';
      EXECUTE PROCEDURE MINSERECRITICANFE(:ECODPEDVEND, :ECODANALISECRITERIO, :LMENSAGEM);
    END
  END
  SUSPEND;
END^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE SEF2012_REG0175(
    PART_COD INTEGER)
RETURNS (
    PART_CEP VARCHAR(9),
    PART_ENDE VARCHAR(60),
    PART_NUM VARCHAR(5),
    PART_COMPL VARCHAR(60),
    PART_BAIRRO VARCHAR(60),
    PART_CODCXP VARCHAR(1),
    PART_CXP VARCHAR(1),
    PART_FONE VARCHAR(15),
    PART_FAX VARCHAR(15))
AS
declare variable LCEP varchar(10);
declare variable LNUMERO varchar(100);
declare variable LFONE varchar(120);
declare variable LFAX varchar(120);
declare variable LNUMERO2 varchar(100);
begin
  for select
    PESSOA.CEP_1,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.COMPLEMENTO_1,
    PESSOA.BAIRRO_1,
    PESSOA.FONES,
    PESSOA.FAX
  from
    PESSOA
  where
    PESSOA.CODPESSOA=:PART_COD
  into
    :LCEP,
    :PART_ENDE,
    :LNUMERO,
    :PART_COMPL,
    :PART_BAIRRO,
    :LFONE,
    :LFAX
  do
  begin
    PART_CODCXP = '';
    PART_CXP    = '';

    PART_COMPL  = substring(PART_BAIRRO from 1 for 50);
    PART_BAIRRO = substring(PART_BAIRRO from 1 for 20);

    select STRRESULT from FU_GETTIRAMASCARA(:LCEP) into :LCEP;
    select R_TRIM    from FU_TRIM(:LCEP)           into :LCEP;
    PART_CEP = substring(LCEP from 1 for 8);

    select STRRESULT   from FU_GETTIRAMASCARA(:LNUMERO) into :LNUMERO;
    select R_TRIM      from FU_TRIM(:LNUMERO)           into :LNUMERO;
    PART_NUM = substring(LNUMERO from 1 for 5);

    -------
    select STRRESULT   from FU_GETTIRAMASCARA(:LFONE) into :LFONE;
    select R_TRIM      from FU_TRIM(:LFONE)           into :LFONE;
    select R_ONLYDIGIT from FU_ONLYDIGIT(:LFONE)      into :LFONE;
    PART_FONE = substring(LFONE from 1 for 9);

    if (PART_FONE = '') then
     PART_FONE = '99999999';

    if (CHAR_LENGTH(PART_FONE) < 8) then
     PART_FONE = '99999999';

    -------
    select STRRESULT   from FU_GETTIRAMASCARA(:LFAX) into :LFAX;
    select R_TRIM      from FU_TRIM(:LFAX)           into :LFAX;
    select R_ONLYDIGIT from FU_ONLYDIGIT(:LFAX)      into :LFAX;
    PART_FAX = substring(LFAX from 1 for 9);

    if (PART_FAX = '') then
     PART_FAX = '99999999';

    if (CHAR_LENGTH(PART_FAX) < 8) then
     PART_FAX = '99999999';

    select R_TRIM from FU_TRIM(:PART_ENDE)           into :PART_ENDE;

    select R_ONLYDIGIT from FU_ONLYDIGIT(:PART_ENDE) into :LNUMERO2;
    select R_TRIM from FU_TRIM(:LNUMERO2)            into :LNUMERO2;

    LNUMERO2 = substring(LNUMERO2 from 1 for 5);
    LNUMERO2 = cast(LNUMERO2 as varchar(5));

    if ((PART_NUM = '') and (LNUMERO2 <> '')) then
     PART_NUM = LNUMERO2;

    if ((PART_NUM = '') and (LNUMERO2 = '')) then
     PART_NUM = '123';
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE SISPED_PESSOA(
    ECODEMPRESA INTEGER = 0)
RETURNS (
    ATIVO INTEGER,
    CODPESSOA INTEGER,
    NOME VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    PESSOA INTEGER,
    CPFCGC VARCHAR(18),
    RG VARCHAR(30),
    LIMITECRED NUMERIC(18,2),
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(10),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 VARCHAR(2),
    CEP_1 VARCHAR(9),
    FONES VARCHAR(15),
    CODVENDEDOR INTEGER,
    US_CADAST VARCHAR(45),
    DT_CADAST TIMESTAMP,
    DT_MODIFI TIMESTAMP,
    TIPOPESSOA VARCHAR(14),
    ATUALIZADOEM TIMESTAMP,
    CODIBGE INTEGER,
    EMAIL VARCHAR(100),
    NASCIMENTO DATE,
    SEXO VARCHAR(1))
AS
declare variable CODBAIRRO integer;
declare variable CODESTADO integer;
declare variable CODCIDADE integer;
declare variable PAR_FILTRO_PESSOA_NFCE blob sub_type 1 segment size 80;
declare variable LSQL blob sub_type 1 segment size 80;
begin
  select
    VALOR
  from
    MLERPARAMETROMEMO('FILTRO PESSOA NFC-E', null)
  into
    PAR_FILTRO_PESSOA_NFCE;

  if (PAR_FILTRO_PESSOA_NFCE = '') then
    PAR_FILTRO_PESSOA_NFCE = null;

  LSQL = '';
  LSQL = LSQL || ' select ';
  LSQL = LSQL || '   PESSOA.ATIVO, ';
  LSQL = LSQL || '   PESSOA.CODPESSOA, ';
  LSQL = LSQL || '   substring(PESSOA.NOME from 1 for 60) as NOME,   ';
  LSQL = LSQL || '   substring(PESSOA.NOMEFANTAZIA from 1 for 60) as NOMEFANTAZIA, ';
  LSQL = LSQL || '   PESSOA.PESSOA, ';
  LSQL = LSQL || '   substring(PESSOA.CPFCGC from 1 for 18) as CPFCGC, ';
  LSQL = LSQL || '   substring(PESSOA.RG from 1 for 30) as RG,  ';
  LSQL = LSQL || '   PESSOA.LIMITECRED, ';
  LSQL = LSQL || '   substring(PESSOA.LOGRADOURO_1 from 1 for 60) as LOGRADOURO, ';
  LSQL = LSQL || '   substring(PESSOA.NUMERO_1 from 1 for 10) as NUMERO_1, ';
  LSQL = LSQL || '   substring(PESSOA.COMPLEMENTO_1 from 1 for 60) as complemento_1,  ';
  LSQL = LSQL || '   PESSOA.CODBAIRRO1, ';
  LSQL = LSQL || '   substring(PESSOA.BAIRRO_1 from 1 for 45) as BAIRRO_1, ';
  LSQL = LSQL || '   substring(PESSOA.CIDADE_1 from 1 for 45) as CIDADE_1,   ';
  LSQL = LSQL || '   substring(PESSOA.UF_1 from 1 for 2) as UF_1,  ';
  LSQL = LSQL || '   substring(PESSOA.CEP_1 from 1 for 9) as CEP_1, ';
  LSQL = LSQL || '   substring(PESSOA.FONES from 1 for 15) as FONES, ';
  LSQL = LSQL || '   PESSOA.CODVENDEDOR, ';
  LSQL = LSQL || '   substring(PESSOA.US_CADAST from 1 for 45) as US_CADAST,  ';
  LSQL = LSQL || '   PESSOA.DT_CADAST, ';
  LSQL = LSQL || '   PESSOA.DT_MODIFI, ';
  LSQL = LSQL || '   substring(PESSOA.TIPOPESSOA from 1 for 14) as TIPOPESSOA,  ';
  LSQL = LSQL || '   coalesce(DT_MODIFI, DT_CADAST) ATUALIZADOEM, ';
  LSQL = LSQL || '   PESSOA.CODIBGE, ';
  LSQL = LSQL || '   substring(PESSOA.EMAIL from 1 for 100) as EMAIL,  ';
  LSQL = LSQL || '   PESSOA.DT_NASC, ';
  LSQL = LSQL || '   substring(PESSOA.SEXO from 1 for 1) as SEXO ';
  LSQL = LSQL || ' from ';
  LSQL = LSQL || '   PESSOA ';
  LSQL = LSQL || iif(PAR_FILTRO_PESSOA_NFCE is not null,' where '||PAR_FILTRO_PESSOA_NFCE, '');

  for execute statement
    LSQL
  into
    ATIVO,
    CODPESSOA,
    NOME,
    NOMEFANTAZIA,
    PESSOA,
    CPFCGC,
    RG,
    LIMITECRED,
    LOGRADOURO_1,
    NUMERO_1,
    COMPLEMENTO_1,
    CODBAIRRO,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    CODVENDEDOR,
    US_CADAST,
    DT_CADAST,
    DT_MODIFI,
    TIPOPESSOA,
    ATUALIZADOEM,
    CODIBGE,
    EMAIL,
    NASCIMENTO,
    SEXO
  do
  begin
    CEP_1  = replace(CEP_1,'-','');
    CPFCGC = replace(CPFCGC,'-','');
    CPFCGC = replace(CPFCGC,'.','');
    CPFCGC = replace(CPFCGC,'/','');
    CPFCGC = replace(CPFCGC,' ','');

    if (CHAR_LENGTH(CPFCGC) <= 11) then
      PESSOA = 1;
    else
      PESSOA = 2;

    if (coalesce(CODBAIRRO,0) > 0) then
    begin
      select
        substring(TBL_BAIRRO.DESCBAIRRO from 1 for 45),
        TBL_BAIRRO.CODCIDADE
      from
        TBL_BAIRRO
      where
        TBL_BAIRRO.CODBAIRRO =:CODBAIRRO
      into
        BAIRRO_1,
        CODCIDADE;

      select
        substring(TBL_CIDADES.NOMECIDADE from 1 for 45) as NOMECIDADE,
        TBL_CIDADES.CODESTADO,
        TBL_CIDADES.CODIBGE
      from
        TBL_CIDADES
      where
        TBL_CIDADES.CODCIDADE =:CODCIDADE
      into
        CIDADE_1,
        CODESTADO,
        CODIBGE;

      select
        substring(TBL_ESTADO.SIGLA from 1 for 2) as SIGLA
      from
        TBL_ESTADO
      where
        TBL_ESTADO.CODESTADO =:CODESTADO
      into
        UF_1;
    end
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE SNFENTRADAITEM(
    CODNFENTRADA INTEGER)
RETURNS (
    CNPJCPF VARCHAR(18),
    MODELO VARCHAR(2),
    SERIE VARCHAR(3),
    DOCUMENTO VARCHAR(15),
    CFOP VARCHAR(4),
    CST VARCHAR(4),
    SEQ INTEGER,
    CODPRODFILHO INTEGER,
    DESCRICAO VARCHAR(60),
    CODPESQ1 VARCHAR(30),
    CODPESQ2 VARCHAR(30),
    CODPESQ3 VARCHAR(30),
    QTD DOUBLE PRECISION,
    VALORBRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    ICMSBASE DOUBLE PRECISION,
    STBASE DOUBLE PRECISION,
    IPIVALOR DOUBLE PRECISION,
    ICMS DOUBLE PRECISION,
    IE VARCHAR(30),
    DATA DATE,
    UF VARCHAR(2))
AS
declare variable PARAM_ENVIARIPIENT varchar(1);
declare variable PARAM_ENVIARSTENT varchar(1);
declare variable PARAM_RECLASSCSTICMSENT varchar(1);
declare variable ICMSST double precision;
begin
  SEQ = 0;
  select
    CNPJCPF, 
    MODELO,
    SERIE,
    DOCUMENTO,
    IE,
    DTENTRADA,
    UF
  from
    SNFENTRADAAUX(:CODNFENTRADA)
  into
    :CNPJCPF,
    :MODELO,
    :SERIE,
    :DOCUMENTO,
    :IE,
    :DATA,
    :UF;

  select
    PARAM_ENVIARIPIENT,
    PARAM_ENVIARSTENT,
    PARAM_RECLASSCSTICMSENT
  from
    MPARAMETROS(0)
  into
    :PARAM_ENVIARIPIENT,
    :PARAM_ENVIARSTENT,
    :PARAM_RECLASSCSTICMSENT;

  for select
    NFENTRADAITENS.CFOP_CFOP CFOP,
    NFENTRADAITENS.PRDF_CST_ORIGEM_MERCADORIA || NFENTRADAITENS.PRDF_CST_TRIBICMS CST,
    NFENTRADAITENS.CODPRODFILHO,
    NFENTRADAITENS.QTD,
    coalesce(NFENTRADAITENS.DESCTO_ITEM,0) DESCONTO,
    (NFENTRADAITENS.QTD * NFENTRADAITENS.PRODVLR) VALORBRUTO,
    coalesce(NFENTRADAITENS.BASE_ICMS,0) ICMSBASE,
    coalesce(NFENTRADAITENS.BASE_SUBS,0) STBASE,
    coalesce(NFENTRADAITENS.VL_IPIPERC,0) IPIVALOR,
    coalesce(NFENTRADAITENS.DIFICMS,0) ICMS,
    coalesce(NFENTRADAITENS.ALIQ_SUBS,0) ICMSST
  from
    NFENTRADAITENS
  where
    NFENTRADAITENS.CODNFENTRADA =:CODNFENTRADA
  order by NFENTRADAITENS.CODNFENTRADAITENS
  into
    :CFOP,
    :CST,
    :CODPRODFILHO,
    :QTD,
    :DESCONTO,
    :VALORBRUTO,
    :ICMSBASE,
    :STBASE, 
    :IPIVALOR,
    :ICMS,
    :ICMSST
  do
  begin
    SEQ = SEQ + 1;

    select
      DESCRICAO,
      CODPESQ1,
      CODPESQ2,
      CODPESQ3
    from
      MPRODUTOSAUX(:CODPRODFILHO)
    into
      :DESCRICAO,
      :CODPESQ1,
      :CODPESQ2,
      :CODPESQ3;

    -- Reclassificando o CST de ICMS.
    if (CHAR_LENGTH(CST) <= 2) then
    begin
      if (ICMS = 0) then
        CST = '040';

      if ((ICMS > 0) and (ICMSST > 0)) then
        CST = '010';

      if ((ICMS > 0) and (ICMSST = 0)) then
        CST = '000';

      if ((ICMS = 0) and (ICMSST > 0)) then
        CST = '060';
    end

    if (PARAM_RECLASSCSTICMSENT = 'S') then
    begin
      if (ICMS = 0) then
        CST = '040';

      if ((ICMS > 0) and (ICMSST > 0)) then
        CST = '010';

      if ((ICMS > 0) and (ICMSST = 0)) then
        CST = '000';

      if ((ICMS = 0) and (ICMSST > 0)) then
        CST = '060';
    end

    select R_TRIM from FU_TRIM(:CST) into :CST;
    CST        = CST;
    QTD        = cast(QTD as numeric(18,2));
    DESCONTO   = cast(DESCONTO as numeric(18,2));
    VALORBRUTO = cast(VALORBRUTO as numeric(18,2));
    ICMSBASE   = cast(ICMSBASE as numeric(18,2));
    STBASE     = cast(STBASE as numeric(18,2));
    IPIVALOR   = cast(IPIVALOR as numeric(18,2));
    ICMS       = cast(ICMS as numeric(18,2));
    ICMSST     = cast(ICMSST as numeric(18,2));
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE SNFVENDAITEM(
    CODNFVENDA INTEGER,
    ESERIE VARCHAR(3),
    NFV_TIPO VARCHAR(1))
RETURNS (
    CNPJCPF VARCHAR(18),
    MODELO VARCHAR(2),
    SERIE VARCHAR(3),
    DOCUMENTO VARCHAR(15),
    CFOP VARCHAR(4),
    CST VARCHAR(4),
    SEQ INTEGER,
    CODPRODFILHO INTEGER,
    DESCRICAO VARCHAR(60),
    CODPESQ1 VARCHAR(30),
    CODPESQ2 VARCHAR(30),
    CODPESQ3 VARCHAR(30),
    QTD DOUBLE PRECISION,
    VALORBRUTO DOUBLE PRECISION,
    DESCONTO DOUBLE PRECISION,
    ICMSBASE DOUBLE PRECISION,
    STBASE DOUBLE PRECISION,
    IPIVALOR DOUBLE PRECISION,
    ICMS DOUBLE PRECISION,
    IE VARCHAR(30),
    DATA DATE,
    UF VARCHAR(2))
AS
declare variable PARAM_ENVIARIPI varchar(1);
declare variable PARAM_ENVIARST varchar(1);
declare variable PARAM_RECLASSCSTICMS varchar(1);
declare variable ICMSST double precision;
begin
  SEQ = 0;
  select
    CNPJCPF, 
    MODELO,
    SERIE,
    DOCUMENTO,
    IE,
    DTENTRADA,
    UF
  from
    SNFVENDAAUX(:CODNFVENDA, :ESERIE, :NFV_TIPO)
  into
    :CNPJCPF,
    :MODELO,
    :SERIE,
    :DOCUMENTO,
    :IE,
    :DATA,
    :UF;

  select
    PARAM_ENVIARIPI,
    PARAM_ENVIARST,
    PARAM_RECLASSCSTICMS
  from
    MPARAMETROS(0)
  into
    :PARAM_ENVIARIPI,
    :PARAM_ENVIARST,
    :PARAM_RECLASSCSTICMS;

  for select
    NFVENDAITEM.CFOP_CFOP CFOP,
    NFVENDAITEM.CST,
    NFVENDAITEM.CODPRODFILHO,
    NFVENDAITEM.QTDE,
    coalesce(NFVENDAITEM.DESCVLR,0) DESCONTO,
    (NFVENDAITEM.QTDE * NFVENDAITEM.PRECOVEND) VALORBRUTO,
    coalesce(NFVENDAITEM.ICMSBASE,0) ICMSBASE,
    coalesce(NFVENDAITEM.BASE_SUBS,0) STBASE,
    coalesce(NFVENDAITEM.IPIVALOR,0) IPIVALOR,
    coalesce(NFVENDAITEM.ICMSPERC,0) ICMS,
    coalesce(NFVENDAITEM.ALIQ_SUBS,0) ICMSST
  from
    NFVENDAITEM
  where
    NFVENDAITEM.CODNFVENDA =:CODNFVENDA and
    NFVENDAITEM.SERIE =:ESERIE and
    NFVENDAITEM.NFV_TIPO =:NFV_TIPO
  order by NFVENDAITEM.CODNFVENDAITEM
  into
    :CFOP,
    :CST,
    :CODPRODFILHO,
    :QTD,
    :DESCONTO,
    :VALORBRUTO,
    :ICMSBASE,
    :STBASE, 
    :IPIVALOR,
    :ICMS,
    :ICMSST
  do
  begin
    SEQ = SEQ + 1;

    select
      DESCRICAO,
      CODPESQ1,
      CODPESQ2,
      CODPESQ3
    from
      MPRODUTOSAUX(:CODPRODFILHO)
    into
      :DESCRICAO,
      :CODPESQ1,
      :CODPESQ2,
      :CODPESQ3;

    -- Reclassificando o CST de ICMS.
    if (CHAR_LENGTH(CST) <= 2) then
    begin
      if (ICMS = 0) then
        CST = '040';

      if ((ICMS > 0) and (ICMSST > 0)) then
        CST = '010';

      if ((ICMS > 0) and (ICMSST = 0)) then
        CST = '000';

      if ((ICMS = 0) and (ICMSST > 0)) then
        CST = '060';

    end

    if (PARAM_RECLASSCSTICMS = 'S') then
    begin
      if (ICMS = 0) then
        CST = '040';

      if ((ICMS > 0) and (ICMSST > 0)) then
        CST = '010';

      if ((ICMS > 0) and (ICMSST = 0)) then
        CST = '000';

      if ((ICMS = 0) and (ICMSST > 0)) then
        CST = '060';
    end

    select R_TRIM from FU_TRIM(:CST) into :CST;
    CST        = CST;
    QTD        = cast(QTD as numeric(18,2));
    DESCONTO   = cast(DESCONTO as numeric(18,2));
    VALORBRUTO = cast(VALORBRUTO as numeric(18,2));
    ICMSBASE   = cast(ICMSBASE as numeric(18,2));
    STBASE     = cast(STBASE as numeric(18,2));
    IPIVALOR   = cast(IPIVALOR as numeric(18,2));
    ICMS       = cast(ICMS as numeric(18,2));
    ICMSST     = cast(ICMSST as numeric(18,2));
    suspend;
  end
end^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE STP_SISPED_PESSOA
RETURNS (
    ATIVO SMALLINT,
    CODPESSOA INTEGER,
    NOME VARCHAR(60),
    NOMEFANTAZIA VARCHAR(60),
    PESSOA SMALLINT,
    CPFCGC VARCHAR(18),
    RG VARCHAR(30),
    LIMITECRED DOUBLE PRECISION,
    LOGRADOURO_1 VARCHAR(60),
    NUMERO_1 VARCHAR(30),
    COMPLEMENTO_1 VARCHAR(60),
    BAIRRO_1 VARCHAR(45),
    CIDADE_1 VARCHAR(45),
    UF_1 CHAR(2),
    CEP_1 VARCHAR(100),
    FONES VARCHAR(120),
    CODVENDEDOR INTEGER,
    DT_CADAST TIMESTAMP,
    DT_MODIFI TIMESTAMP,
    TIPOPESSOA VARCHAR(14),
    ATUALIZADOEM TIMESTAMP,
    CODIBGE INTEGER,
    EMAIL VARCHAR(100))
AS
declare variable LCODBAIRRO integer;
declare variable LCEP varchar(9);
declare variable LCODIBGE integer;
begin
  select
    (select
      FU_GETTIRAMASCARA.STRRESULT
    from
      FU_GETTIRAMASCARA(E.CEP)),
    coalesce(nullif(E.CODIBGE, '0'), '0000000')
  from
    EMPRESA E
    join SYSPARAMS S on
      S.CGC = E.CGC
  into
    LCEP,
    LCODIBGE;

  for select
    PESSOA.ATIVO,
    PESSOA.CODPESSOA,
    PESSOA.NOME,
    PESSOA.NOMEFANTAZIA,
    PESSOA.PESSOA,
    PESSOA.CPFCGC,
    PESSOA.RG,
    PESSOA.LIMITECRED,
    PESSOA.LOGRADOURO_1,
    PESSOA.NUMERO_1,
    PESSOA.COMPLEMENTO_1,
    PESSOA.BAIRRO_1,
    PESSOA.CIDADE_1,
    PESSOA.UF_1,
    PESSOA.CEP_1,
    PESSOA.FONES,
    PESSOA.CODVENDEDOR,
    PESSOA.DT_CADAST,
    PESSOA.DT_MODIFI,
    PESSOA.TIPOPESSOA,
    coalesce(DT_MODIFI,DT_CADAST) ATUALIZADOEM,
    coalesce(PESSOA.CODIBGE, '0'),
    PESSOA.CODBAIRRO1,
    lower(iif(coalesce(PESSOA.EMAIL_NFE, PESSOA.EMAIL) similar to '[[:ALNUM:]-.]*@[[:ALNUM:]-.]*', coalesce(PESSOA.EMAIL_NFE, PESSOA.EMAIL), null))
   from
     PESSOA
   where
    PESSOA.ATIVO = 2
  into
    ATIVO,
    CODPESSOA,
    NOME,
    NOMEFANTAZIA,
    PESSOA,
    CPFCGC,
    RG,
    LIMITECRED,
    LOGRADOURO_1,
    NUMERO_1,
    COMPLEMENTO_1,
    BAIRRO_1,
    CIDADE_1,
    UF_1,
    CEP_1,
    FONES,
    CODVENDEDOR,
    DT_CADAST,
    DT_MODIFI,
    TIPOPESSOA,
    ATUALIZADOEM,
    CODIBGE,
    LCODBAIRRO,
    EMAIL
  do
  begin
    select
      FU_GETTIRAMASCARA.STRRESULT
    from
      FU_GETTIRAMASCARA(:CEP_1)
    into
      CEP_1;

    CEP_1 = coalesce(nullif(CEP_1, ''), LCEP);

    if ((CHAR_LENGTH(CODIBGE) <> 7) and (LCODBAIRRO is not null)) then
    begin
      select
        C.CODIBGE
      from
        TBL_BAIRRO B
        join TBL_CIDADES C on
          B.CODCIDADE = C.CODCIDADE
      where
        B.CODBAIRRO = :LCODBAIRRO
      into
        CODIBGE;
    end

    if (CHAR_LENGTH(CODIBGE) <> 7) then
      CODIBGE = LCODIBGE;
    suspend;
  end
end^

SET TERM ; ^


